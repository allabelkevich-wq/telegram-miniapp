<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#08071a">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>YupSoul</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Принудительный редирект от старых кешированных URL (v=22) на свежий timestamp -->
  <script>
    // Быстрый выбор стиля песни (чипсы под полем)
    document.addEventListener('click', function(e) {
      var btn = e.target.closest('.style-quick');
      if (!btn) return;
      var input = document.getElementById('requestPreferredStyle');
      if (!input) return;
      var val = (btn.getAttribute('data-style') || btn.textContent || '').trim();
      if (!val) return;
      var current = (input.value || '').trim();
      if (!current) {
        input.value = val;
      } else if (!current.toLowerCase().includes(val.toLowerCase())) {
        input.value = current + ', ' + val;
      }
      input.dispatchEvent(new Event('input', { bubbles: true }));
    });
    (function(){
      try {
        var APP_VERSION = '1.2.77';
        var CACHE_KEY = 'yupsoul_app_version';
        var cached = localStorage.getItem(CACHE_KEY);
        
        // Если версия изменилась — навигируем на новый URL с timestamp
        // (window.location.reload(true) не сбрасывает кэш в Telegram iOS WebView)
        if (cached && cached !== APP_VERSION) {
          localStorage.setItem(CACHE_KEY, APP_VERSION);
          var base = window.location.href.split('?')[0];
          window.location.replace(base + '?v=' + Date.now());
          return;
        }
        localStorage.setItem(CACHE_KEY, APP_VERSION);
        
        var qs = window.location.search;
        var m = qs.match(/[?&]v=(\d+)/);
        if (m && m[1] && m[1].length <= 6) {
          // Старый короткий v= (напр. v=22) — перезагрузиться с timestamp чтобы сбить кеш
          var fresh = window.location.href.replace(/([?&])v=\d+/, '$1v=' + Date.now());
          window.location.replace(fresh);
        }
      } catch(e) {}
    })();
  </script>
  <!-- API: на Render используем тот же origin, иначе хардкод. -->
  <script>
    (function(){
      var origin = (typeof window !== 'undefined' && window.location && window.location.origin) ? window.location.origin : '';
      var isRender = /\.onrender\.com$/i.test(origin);
      window.HEROES_API_BASE = isRender ? origin : 'https://telegram-miniapp-ar09.onrender.com';
      window.BACKEND_URL = window.HEROES_API_BASE;
    })();
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
    /* АДАПТИВНЫЕ СТИЛИ С ПОДДЕРЖКОЙ ТЕМЫ ТЕЛЕГРАМ */
    /* Палитра: настоящее золото + тёплый янтарь (без розового) */
    :root {
      --primary-color: #B8860B;
      --primary-light: #D4A017;
      --secondary-color: #B45309;
      --primary-rgb: 184, 134, 11;
      --secondary-rgb: 180, 83, 9;
      --success-color: #10b981;
      --subtitle-readable: rgba(255,255,255,0.92);
      /* YupSoul Premium Design System */
      --space-1: 4px; --space-2: 8px; --space-3: 12px; --space-4: 16px; --space-5: 20px; --space-6: 24px; --space-7: 28px; --space-8: 32px; --space-9: 40px; --space-10: 48px; --space-11: 56px; --space-12: 64px;
      --gold-primary: #D4AF37; --gold-light: #E5C156; --gold-dark: #B8860B; --gold-muted: rgba(212, 175, 55, 0.15);
      --bg-primary: #0A0A1A; --bg-secondary: rgba(255, 255, 255, 0.03); --bg-tertiary: rgba(255, 255, 255, 0.05);
      --text-primary: rgba(255, 255, 255, 0.95); --text-secondary: rgba(255, 255, 255, 0.75); --text-tertiary: rgba(255, 255, 255, 0.55); --text-muted: rgba(255, 255, 255, 0.35);
      --border-subtle: rgba(255, 255, 255, 0.08); --border-default: rgba(255, 255, 255, 0.12); --border-accent: rgba(212, 175, 55, 0.35);
      --font-size-xs: 0.75rem; --font-size-sm: 0.875rem; --font-size-base: 1rem; --font-size-lg: 1.125rem; --font-size-xl: 1.25rem; --font-size-2xl: 1.5rem; --font-size-3xl: 1.875rem;
      --font-weight-normal: 400; --font-weight-medium: 500; --font-weight-semibold: 600; --font-weight-bold: 700;
      --line-height-tight: 1.25; --line-height-normal: 1.5; --line-height-relaxed: 1.75;
      --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-xl: 20px; --radius-2xl: 24px; --radius-full: 9999px;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3); --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.3); --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.3); --shadow-xl: 0 12px 24px rgba(0, 0, 0, 0.35); --shadow-glow: 0 0 20px rgba(212, 175, 55, 0.15);
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1); --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1); --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
      /* Fluid scaling — пропорции Apple: уменьшается пропорционально экрану */
      --fluid-xs: clamp(0.7rem, 1.8vw, 0.8rem);
      --fluid-sm: clamp(0.8rem, 2.2vw, 0.95rem);
      --fluid-base: clamp(0.9rem, 2.8vw, 1.05rem);
      --fluid-md: clamp(1rem, 3.2vw, 1.2rem);
      --fluid-lg: clamp(1.1rem, 3.8vw, 1.4rem);
      --fluid-xl: clamp(1.2rem, 4.5vw, 1.6rem);
      --fluid-2xl: clamp(1.4rem, 5.5vw, 2.4rem);
      --spacing-xs: clamp(4px, 1.2vw, 8px);
      --spacing-sm: clamp(6px, 1.8vw, 12px);
      --spacing-md: clamp(10px, 2.5vw, 18px);
      --spacing-lg: clamp(14px, 3.5vw, 24px);
      --spacing-xl: clamp(18px, 4.5vw, 28px);
      --radius-sm: clamp(6px, 1.8vw, 10px);
      --radius-md: clamp(8px, 2.2vw, 14px);
      --radius-lg: clamp(12px, 3vw, 20px);
      /* базовые переменные темы по умолчанию (dark premium) */
      --tg-theme-bg-color: #0A0A1A;
      --tg-theme-secondary-bg-color: rgba(255,255,255,0.08);
      --tg-theme-text-color: #ffffff;
      --tg-theme-hint-color: rgba(224, 224, 240, 0.7);
      --tg-theme-border-color: rgba(var(--primary-rgb), 0.3);
      --tg-theme-button-color: var(--primary-color);
      --tg-theme-button-text-color: #0A0A1A;
    }
    .theme-light {
      --tg-theme-bg-color: #f5f3ff;
      --tg-theme-secondary-bg-color: rgba(255,255,255,0.92);
      --tg-theme-text-color: #1f2937;
      --tg-theme-hint-color: rgba(31, 41, 55, 0.6);
      --tg-theme-border-color: rgba(var(--primary-rgb), 0.35);
      --tg-theme-button-color: var(--primary-color);
      --tg-theme-button-text-color: #1f2937;
      --subtitle-readable: rgba(31,41,55,0.88);
    }
    .theme-dark {
      --tg-theme-bg-color: #0A0A1A;
      --tg-theme-secondary-bg-color: rgba(255,255,255,0.08);
      --tg-theme-text-color: #ffffff;
      --tg-theme-hint-color: rgba(224,224,240,0.7);
      --tg-theme-border-color: rgba(var(--primary-rgb), 0.3);
      --tg-theme-button-color: var(--primary-color);
      --tg-theme-button-text-color: #0A0A1A;
      --subtitle-readable: rgba(255,255,255,0.92);
    }
    /* Дополнительная тема: бумага + благородное золото (демо, только по флагу) */
    body.theme-paper-gold {
      --gold-foil: #C9A961;
      --gold-light: #E5D4A1;
      --gold-dark: #A68B4B;
      --primary-color: #C9A961;
      --primary-light: #E5D4A1;
      --secondary-color: #A68B4B;
      --primary-rgb: 201, 169, 97;
      --secondary-rgb: 166, 139, 75;
      --bg-primary: #0D0D0D;
      --bg-secondary: rgba(255,255,255,0.03);
      --bg-tertiary: rgba(255,255,255,0.06);
      --tg-theme-bg-color: #0D0D0D;
      --tg-theme-secondary-bg-color: rgba(32,32,32,0.9);
      --tg-theme-text-color: #F5F5F5;
      --tg-theme-hint-color: rgba(229, 212, 161, 0.7);
      --tg-theme-border-color: rgba(201,169,97,0.4);
      --tg-theme-button-color: #C9A961;
      --tg-theme-button-text-color: #111111;
      background-color: var(--bg-primary);
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
      background-blend-mode: multiply;
    }
    body.theme-paper-gold .app-logo{
      filter:drop-shadow(0 2px 8px rgba(201,169,97,0.3));
      opacity:0.96;
    }
    body.theme-paper-gold h1,
    body.theme-paper-gold .home-tagline{
      -webkit-background-clip:text;
      background-clip:text;
      background-image:linear-gradient(135deg,#E5D4A1 0%,#C9A961 45%,#A68B4B 80%);
      color:transparent;
    }
    body.theme-paper-gold button{
      background:linear-gradient(135deg,#E5D4A1 0%,#C9A961 50%,#A68B4B 100%);
      box-shadow:0 6px 20px rgba(201,169,97,0.35);
      color:#111111;
    }
    body.theme-paper-gold button.secondary{
      background:rgba(32,32,32,0.9);
      color:rgba(245,245,245,0.9);
      border:1px solid rgba(201,169,97,0.4);
      box-shadow:none;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    html { height: 100%; }
    body {
      background: linear-gradient(160deg,#08071a 0%,#100828 40%,#0b1022 70%,#08071a 100%) !important;
      color: var(--tg-theme-text-color) !important;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: var(--fluid-base);
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    body::before {
      content:"";
      position:fixed;
      inset:0;
      z-index:0;
      /* Один плавный градиент без стопов — резкие стопы давали полосу через логотип в превью */
      background: linear-gradient(180deg, rgba(1,6,26,0.5) 0%, rgba(8,10,38,0.65) 100%);
      pointer-events:none;
    }
    body::after {
      content:"";
      position:fixed;
      inset:0;
      z-index:0;
      /* Плавный градиент без стопов — иначе в превью видна полоса через логотип */
      background: linear-gradient(180deg, rgba(1,6,26,0.22) 0%, rgba(8,10,38,0.2) 100%);
      pointer-events:none;
    }
    .content-wrapper { max-width: min(600px,100%); margin: 0 auto; padding: var(--spacing-lg); width: 100%; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; color: var(--tg-theme-text-color, #fff); font-size: var(--fluid-sm); margin-bottom: 8px; font-weight: 500; }
    input::placeholder, textarea::placeholder { color: var(--tg-theme-hint-color, rgba(255,255,255,.55)); opacity: 1; }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 12px 16px; background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.05));
      border: 1px solid var(--tg-theme-border-color, rgba(255, 255, 255, 0.1)); border-radius: 8px;
      color: var(--tg-theme-text-color, #fff); font-size: var(--fluid-base); box-sizing: border-box;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none; border-color: rgba(var(--primary-rgb),0.6); box-shadow: 0 0 0 2px rgba(var(--primary-rgb),0.12);
    }
    .checkbox-group { display: flex; align-items: center; margin-top: 8px; }
    .checkbox-group input[type="checkbox"] { width: 18px; height: 18px; margin-right: 8px; cursor: pointer; }
    .checkbox-group label { margin: 0; font-size: var(--fluid-sm); color: var(--tg-theme-text-color, #fff); opacity: 0.9; }
    small { color: var(--tg-theme-hint-color, rgba(255, 255, 255, 0.6)); font-size: var(--fluid-xs); }
    h3 { color: var(--tg-theme-text-color, #fff); font-size: var(--fluid-md); margin: 0 0 15px 0; font-weight: 600; }
    #payBtn {
      width: 100%; padding: 13px 24px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border: none; border-radius: 14px; color: var(--tg-theme-button-text-color, #fff); font-size: 1rem; font-weight: 600;
      cursor: pointer; transition: all 0.3s; margin-top: 16px; box-shadow: 0 4px 15px rgba(var(--primary-rgb),0.3);
    }
    #payBtn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4); }
    #payBtn:active { transform: translateY(0); }
    .form-section {
      background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.05)); border-radius: 12px; padding: 20px; margin-bottom: 20px;
      border: 1px solid var(--tg-theme-border-color, rgba(255, 255, 255, 0.1));
    }
    .request-examples {
      margin: 20px 0; padding: 15px; background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.05));
      border-radius: 12px; border: 1px solid var(--tg-theme-border-color, rgba(255, 255, 255, 0.1));
    }
    .request-examples h3 { font-size: var(--fluid-md); color: var(--tg-theme-text-color, #fff); margin: 0 0 12px 0; font-weight: 500; }
    .examples-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; }
    .example-btn {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-light), var(--primary-color));
      border: 1px solid rgba(var(--primary-rgb), 0.7); color: #0A0A1A;
      padding: 10px 12px; border-radius: 8px; font-size: var(--fluid-xs); font-weight: 600;
      cursor: pointer; text-align: left; transition: all 0.2s; width: 100%;
      white-space: normal; word-wrap: break-word; word-break: break-word;
      box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.4);
    }
    .example-btn:hover { opacity: 0.95; transform: translateY(-2px); box-shadow: 0 6px 18px rgba(var(--primary-rgb), 0.5); background: linear-gradient(135deg, var(--primary-light), var(--primary-color), var(--primary-light)); }
    .example-btn.special { background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); border-color: rgba(var(--primary-rgb), 0.7); }
    /* ===== MODE SELECTOR — компактные кнопки с яркой подсветкой ===== */
    .mode-selector {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(var(--primary-rgb), 0.1);
      border-radius: 16px;
      padding: 14px 12px;
      margin: 0 0 16px;
    }
    .mode-selector h3 {
      color: #ffffff;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
      text-align: center;
    }
    .mode-subtitle {
      color: rgba(255, 255, 255, 0.6);
      font-size: 12px;
      text-align: center;
      margin-bottom: 12px;
    }
    .mode-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .mode-btn {
      position: relative;
      flex: 1;
      min-width: 0;
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
      justify-content: center !important;
      min-height: 56px !important;
      max-height: 64px !important;
      padding: 8px 6px !important;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(var(--primary-rgb), 0.15);
      border-radius: 10px;
      color: #ffffff !important;
      font-family: 'Comfortaa', sans-serif;
      font-size: 8px !important;
      font-weight: 600 !important;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      line-height: 1.2 !important;
      white-space: normal !important;
      word-wrap: break-word !important;
      overflow: hidden !important;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important;
    }
    .mode-btn .mode-label {
      display: -webkit-box !important;
      -webkit-box-orient: vertical !important;
      -webkit-line-clamp: 2 !important;
      overflow: hidden !important;
      word-wrap: break-word !important;
      white-space: normal !important;
      text-overflow: ellipsis;
      min-width: 0;
      width: 100%;
      font-size: inherit;
      line-height: 1.2 !important;
      font-weight: inherit;
      text-align: center;
    }
    .mode-btn.active .mode-label { font-weight: 600; }
    .mode-btn:hover {
      background: rgba(var(--primary-rgb), 0.1);
      border-color: rgba(var(--primary-rgb), 0.3);
      color: #ffffff;
      transform: translateY(-1px);
    }
    .mode-btn.active {
      background: linear-gradient(135deg,
        rgba(var(--primary-rgb), 0.3) 0%,
        rgba(var(--primary-rgb), 0.15) 100%);
      border: 2px solid #D4AF37;
      color: #FFE55C !important;
      font-weight: 600;
      box-shadow:
        0 0 20px rgba(var(--primary-rgb), 0.6),
        0 0 40px rgba(var(--primary-rgb), 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      transform: scale(1.02);
      text-shadow:
        0 0 10px rgba(var(--primary-rgb), 0.8),
        0 0 20px rgba(var(--primary-rgb), 0.5) !important;
    }
    .mode-btn.active::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(135deg,
        rgba(var(--primary-rgb), 0.8),
        rgba(var(--secondary-rgb), 0.4));
      border-radius: 10px;
      opacity: 0.3;
      z-index: -1;
      filter: blur(8px);
    }
    .mode-btn.active::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 150%;
      height: 150%;
      background: radial-gradient(circle,
        rgba(var(--primary-rgb), 0.4),
        transparent 70%);
      -webkit-animation: activePulse 2s ease-in-out infinite;
      animation: activePulse 2s ease-in-out infinite;
      pointer-events: none;
      border-radius: 50%;
    }
    @-webkit-keyframes activePulse {
      0%, 100% { -webkit-transform: translate(-50%, -50%) scale(1); transform: translate(-50%, -50%) scale(1); opacity: 0.5; }
      50% { -webkit-transform: translate(-50%, -50%) scale(1.1); transform: translate(-50%, -50%) scale(1.1); opacity: 0.8; }
    }
    @keyframes activePulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; }
      50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.8; }
    }
    .mode-btn:active { transform: scale(0.98); transition: transform 0.1s; }
    @media (max-width: 380px) {
      .mode-btn {
        font-size: 7px !important;
        min-height: 60px !important;
        max-height: 60px !important;
        padding: 6px 4px !important;
        border-radius: 8px;
      }
      .mode-selector {
        padding: 14px 12px;
        margin: 10px;
      }
      .mode-selector h3 {
        font-size: 14px;
      }
      .mode-subtitle {
        font-size: 11px;
      }
    }
    .mode-btn[data-mode="transit"] .mode-label {
      display: -webkit-box !important;
      word-break: break-word !important;
      hyphens: auto !important;
    }
    .mode-icon { display: none; }
    .mode-label { font-weight: 700; font-size: inherit; line-height: 1.25; }
    .mode-desc { display: none; }
    /* Аккордеон второго человека */
    #secondPersonAccordion .pfa-header { background: rgba(var(--primary-rgb),0.06); border: 1px solid rgba(var(--primary-rgb),0.18); }
    #secondPersonAccordion .pfa-header:hover { background: rgba(var(--primary-rgb),0.1); }
    #secondPersonFormWrap { overflow: hidden; transition: max-height .38s cubic-bezier(.4,0,.2,1), opacity .3s ease; max-height: 0; opacity: 0; }
    #transitFormWrap { overflow: hidden; transition: max-height .38s cubic-bezier(.4,0,.2,1), opacity .3s ease; max-height: 0; opacity: 0; }
    .mode-info {
      min-width: 44px; min-height: 44px; width: 44px; height: 44px; border-radius: 50%; border: 1px solid rgba(var(--primary-rgb),0.4);
      color: rgba(var(--primary-rgb),0.7); font-size: 0.7rem; font-weight: 700;
      display: inline-flex; align-items: center; justify-content: center;
      flex-shrink: 0; cursor: pointer; line-height: 1; transition: border-color 0.2s, color 0.2s;
      font-style: normal; user-select: none;
    }
    .mode-info:active { color: var(--primary-color); border-color: var(--primary-color); }
    /* Тултип подсказки */
    #modeTooltip {
      display: none; position: fixed; z-index: 9999;
      background: rgba(25,25,35,0.97); border: 1px solid rgba(var(--primary-rgb),0.3);
      color: rgba(255,255,255,0.88); font-size: 0.8rem; line-height: 1.45;
      padding: 9px 13px; border-radius: 10px; max-width: 220px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4); pointer-events: none;
    }
    .location-input-wrapper { position: relative; }
    .location-input {
      width: 100%; padding: 12px 16px; background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.05));
      border: 1px solid var(--tg-theme-border-color, rgba(255, 255, 255, 0.1)); border-radius: 8px;
      color: var(--tg-theme-text-color, #fff); font-size: var(--fluid-base); box-sizing: border-box;
    }
    .location-input:focus {
      outline: none; border-color: rgba(var(--primary-rgb),0.6); box-shadow: 0 0 0 2px rgba(var(--primary-rgb),0.12);
    }
    .location-suggestions {
      position: absolute; z-index: 1000; background: var(--tg-theme-bg-color, #1a1a1a);
      border: 1px solid var(--tg-theme-border-color, rgba(255, 255, 255, 0.1)); border-radius: 8px;
      max-height: 200px; overflow-y: auto; width: 100%; margin-top: 4px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      display: none;
    }
    .location-suggestion {
      padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--tg-theme-border-color, rgba(255, 255, 255, 0.1));
      color: var(--tg-theme-text-color, #fff); font-size: var(--fluid-base); transition: background 0.2s;
    }
    .location-suggestion:hover { background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.1)); }
    .location-suggestion:last-child { border-bottom: none; }
    .stepper {
      display: flex; gap: 8px; align-items: center; margin-bottom: 16px; position: relative;
    }
    .step-line {
      position: absolute; left: 12px; right: 12px; height: 2px; background: var(--tg-theme-border-color); top: 18px; z-index: 0;
    }
    .step-indicator {
      position: relative; z-index: 1; padding: 8px 12px; border-radius: 10px; border: 1px solid var(--tg-theme-border-color);
      background: var(--tg-theme-secondary-bg-color); color: var(--tg-theme-text-color); font-weight: 600; font-size: var(--fluid-sm);
      flex: 1; text-align: center;
    }
    .step-indicator.active {
      border-color: var(--tg-theme-button-color); background: linear-gradient(135deg, var(--tg-theme-button-color), var(--secondary-color));
      color: var(--tg-theme-button-text-color); box-shadow: 0 6px 18px rgba(var(--primary-rgb),0.25);
    }
    .step-panel { margin-top: 20px; }
    .step-nav { display: flex; gap: 12px; margin-top: 16px; }
    .step-nav button { flex: 1; text-transform: none; letter-spacing: 0; }
    .form-submit-sticky { position: sticky; bottom: 0; background: none; padding: 14px 0 6px; margin: 0; z-index: 5; display: flex; flex-direction: column; align-items: stretch; gap: 0; }
    .form-submit-sticky button#stepNext { flex: none; width: 100%; }
    .form-nav-links{display:flex;justify-content:center;gap:14px;margin-top:18px;padding:10px 0}
    .form-nav-link{background:none;border:none;color:rgba(var(--primary-rgb),0.55);font-size:0.8rem;cursor:pointer;font-family:inherit;padding:0;min-height:unset;box-shadow:none;animation:none;font-weight:500}
    .form-nav-link:hover{color:rgba(var(--primary-rgb),0.8)}
    @media (max-width: 600px) {
      .examples-grid { grid-template-columns: 1fr; }
      .content-wrapper { padding: 15px; }
      #payBtn { padding: 14px; font-size: 15px; }
    }
    /* Остальные стили приложения */
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Comfortaa',sans-serif}
    .container{max-width:min(600px,100%);margin:0 auto;width:100%;position:relative;z-index:1;padding:0 var(--spacing-md);padding-left:max(var(--spacing-md),env(safe-area-inset-left,0));padding-right:max(var(--spacing-md),env(safe-area-inset-right,0))}
    .page{position:fixed;inset:0;display:none !important;flex-direction:column;overflow:hidden}
    .page.active{display:flex !important}
    .page-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:0 var(--spacing-md) calc(env(safe-area-inset-bottom) + 24px)}
    .page-header{flex-shrink:0}
    .page-footer{flex-shrink:0;padding:var(--spacing-md);padding-bottom:max(var(--spacing-md),env(safe-area-inset-bottom))}
    header{text-align:center;margin:var(--spacing-xl) 0 var(--spacing-lg);position:relative}
    .lang-switcher-compact{position:relative;z-index:1}
    .lang-switcher-btn{
      display:inline-flex !important;align-items:center;justify-content:center;gap:2px;
      min-width:40px !important;min-height:40px !important;width:40px !important;height:40px !important;
      padding:0 !important;font-size:9px;line-height:1;
      background:radial-gradient(circle at 30% 0%,rgba(212,175,55,0.45) 0%,rgba(212,175,55,0.16) 40%,rgba(10,10,26,0.9) 100%) !important;
      border:1.5px solid rgba(212,175,55,0.85) !important;
      border-radius:999px !important;
      color:rgba(255,240,210,0.95);
      cursor:pointer;font-family:inherit;font-weight:600;letter-spacing:0.06em;
      transition:background .2s, border-color .2s, color .2s, transform .12s;
      box-shadow:0 4px 18px rgba(0,0,0,0.45) !important;
      animation:none !important;transform:translateY(0) !important;
    }
    .lang-switcher-btn:hover{
      background:radial-gradient(circle at 30% 0%,rgba(212,175,55,0.65) 0%,rgba(212,175,55,0.24) 42%,rgba(10,10,26,0.95) 100%) !important;
      border-color:rgba(212,175,55,0.95) !important;
      color:#fff;
      transform:translateY(-1px) !important;
    }
    #langSwitcherIcon{font-size:10px;opacity:0.7;line-height:1}
    #langSwitcherCurrent{text-align:center;font-size:9px;font-weight:700;letter-spacing:0.08em}
    .lang-dropdown{
      position:absolute;top:calc(100% + 6px);right:0;left:auto;
      margin-top:0;width:46px;padding:4px 3px;
      background:linear-gradient(160deg,#141226 0%,#09081a 100%);
      border:1px solid rgba(212,175,55,0.55);
      border-radius:14px;
      box-shadow:0 10px 28px rgba(0,0,0,0.7);
      overflow:hidden;z-index:9999
    }
    .lang-dropdown[hidden]{display:none !important}
    .lang-opt{
      display:flex;align-items:center;justify-content:center;width:100%;
      min-height:32px;padding:6px 0;
      text-align:center;background:transparent;border:none;border-radius:999px;
      color:rgba(255,255,255,0.75);font-size:9px;font-weight:600;letter-spacing:0.06em;
      cursor:pointer;font-family:inherit;transition:color .15s,background .15s;animation:none;box-shadow:none;margin:1px 0;
    }
    .lang-opt:hover,.lang-opt:active{
      background:rgba(212,175,55,0.18);
      color:#fde68a;
    }
    h1{font-size:var(--fluid-2xl);background:linear-gradient(135deg,var(--primary-color),var(--secondary-color),var(--primary-color));background-size:300% 300%;animation:gradientShift 4s ease infinite;-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:700;letter-spacing:-1px;line-height:1.2;padding-bottom:4px}
    .subtitle{color:var(--subtitle-readable,var(--tg-theme-text-color));font-size:var(--fluid-base);margin-top:8px;font-weight:400}
    .tagline{color:var(--primary-color);font-size:var(--fluid-sm);font-weight:400;margin:6px 0 0;letter-spacing:0.1px;opacity:0.75}
    .section{background:var(--tg-theme-secondary-bg-color);border-radius:var(--radius-lg);padding:var(--spacing-lg) var(--spacing-lg);box-shadow:0 4px 18px rgba(var(--primary-rgb),0.08);border:1px solid rgba(255,255,255,0.06);position:relative;overflow:hidden;margin-bottom:var(--spacing-lg);overflow-wrap:break-word;word-break:break-word}
    #paymentPage .section{background:rgba(20,18,45,0.98);min-height:300px;color:#fff}
    body.theme-light #paymentPage .section{background:rgba(250,248,255,0.98);color:#1f2937}
    .section::before{display:none}
    .field{margin-bottom:var(--spacing-md);text-align:left}
    .field label{font-size:0.85rem;font-weight:500;color:rgba(255,255,255,0.85);margin-bottom:6px;display:flex;align-items:center;gap:8px}
    .field input:not([type="checkbox"]):not([type="radio"]),.field select,.field textarea{font-size:0.92rem;padding:10px 14px}
    label{display:block;margin-bottom:10px;color:var(--tg-theme-text-color,#2d2d2d);font-weight:500;font-size:1.05rem;display:flex;align-items:center;gap:10px}
    label::before{content:attr(data-icon);font-size:1.25rem}
    input,textarea,select{width:100%;padding:var(--spacing-md);border-radius:var(--radius-md);border:1px solid var(--tg-theme-border-color,#e5e7eb);background:var(--tg-theme-secondary-bg-color,#fff);color:var(--tg-theme-text-color,#2d2d2d);font-size:var(--fluid-base);transition:all .3s ease;font-family:'Comfortaa',sans-serif}
    input:focus,textarea:focus,select:focus{outline:none;border-color:rgba(var(--primary-rgb),0.6);box-shadow:0 0 0 3px rgba(var(--primary-rgb),.12)}
    input.valid,textarea.valid{border-color:#4ade80}
    /* Улучшения для date/time inputs на Android */
    input[type="date"],input[type="time"]{
      font-size:1.2rem;
      min-height:56px;
      font-weight:500;
      letter-spacing:0.3px;
      padding:15px 18px;
      font-weight:600;
      letter-spacing:0.4px;
      -webkit-appearance:none;
      -moz-appearance:none;
      appearance:none;
      background:rgba(255,255,255,0.12);
      border:2px solid rgba(var(--primary-rgb),0.4);
      color:#fff;
      border-radius:12px;
      transition:all 0.2s ease;
    }
    input[type="date"]:focus,input[type="time"]:focus{
      border-color:rgba(var(--primary-rgb),0.8);
      background:rgba(255,255,255,0.16);
      outline:none;
      box-shadow:0 0 0 3px rgba(var(--primary-rgb),0.15);
    }
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator{
      width:32px;
      height:32px;
      min-width:32px;
      min-height:32px;
      opacity:0.85;
      cursor:pointer;
      filter:invert(1) brightness(1.2);
      padding:4px;
      border-radius:6px;
      transition:all 0.2s ease;
    }
    input[type="date"]::-webkit-calendar-picker-indicator:hover,
    input[type="time"]::-webkit-calendar-picker-indicator:hover{
      opacity:1;
      background:rgba(var(--primary-rgb),0.2);
    }
    /* Placeholder для пустых date/time inputs */
    input[type="date"]:not(:focus):invalid,
    input[type="time"]:not(:focus):invalid{
      color:rgba(255,255,255,0.5);
      font-weight:500;
    }
    /* Улучшенная видимость для Android Xiaomi и других мобильных устройств */
    @media (max-width: 600px) {
      input[type="date"],input[type="time"]{
        font-size:1.3rem;
        min-height:60px;
        padding:17px 22px;
        border-width:2.5px;
        font-weight:700;
        letter-spacing:0.5px;
        text-shadow:0 1px 2px rgba(0,0,0,0.3);
      }
      input[type="date"]::-webkit-calendar-picker-indicator,
      input[type="time"]::-webkit-calendar-picker-indicator{
        width:38px;
        height:38px;
        min-width:38px;
        min-height:38px;
        filter:invert(1) brightness(1.5) contrast(1.2);
      }
      input[type="date"]::-webkit-datetime-edit-fields-wrapper,
      input[type="time"]::-webkit-datetime-edit-fields-wrapper{
        padding:2px 0;
      }
      input[type="date"]::-webkit-datetime-edit-text,
      input[type="time"]::-webkit-datetime-edit-text{
        padding:0 4px;
        font-weight:500;
      }
      input[type="date"]::-webkit-datetime-edit-day-field,
      input[type="date"]::-webkit-datetime-edit-month-field,
      input[type="date"]::-webkit-datetime-edit-year-field,
      input[type="time"]::-webkit-datetime-edit-hour-field,
      input[type="time"]::-webkit-datetime-edit-minute-field{
        padding:2px 4px;
        border-radius:0;
        background:transparent;
        font-weight:500;
      }
    }
    .birthdate-wrap{position:relative}
    .birthdate-wrap.has-date{padding-right:2.75rem}
    #birthdate{padding-right:2.5rem;min-width:0}
    .birthdate-check{position:absolute;right:16px;top:50%;transform:translateY(-50%);pointer-events:none;color:#4ade80;font-size:1.15rem;display:none;font-weight:700}
    .birthdate-wrap.has-date .birthdate-check{display:block}
    /* Удобный ввод даты с компьютера: три выпадающих списка */
    .date-group{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .date-group select{flex:1 1 auto;min-width:80px;max-width:120px}
    .date-group .date-group-day{min-width:70px}
    .date-group .date-group-month{min-width:110px}
    .date-group .date-group-year{min-width:90px}
    .birthdate-wrap .date-group + input[type="date"]{position:absolute;width:1px;height:1px;clip:rect(0,0,0,0);opacity:0;pointer-events:none;overflow:hidden}
    @media (max-width:480px){
      .date-group{flex-direction:column;align-items:stretch;gap:12px}
      .date-group select{width:100%;max-width:none;min-width:0;min-height:48px;font-size:1rem;-webkit-tap-highlight-color:rgba(var(--primary-rgb),0.15)}
    }
    .time-group{display:flex;flex-direction:column;align-items:flex-start;gap:var(--spacing-sm);margin:0}
    .time-group-input{flex:0 0 auto;min-width:0;width:100%;max-width:none}
    .time-group-checkbox{margin:0;width:100%;align-self:flex-start;justify-content:flex-start}
    .checkbox{display:flex;align-items:center;gap:10px;margin-top:0}
    .checkbox input{width:22px;height:22px;min-width:22px;accent-color:var(--primary-color);opacity:.65}
    .time-group .checkbox input{opacity:.45}
    .checkbox label{margin-bottom:0;font-weight:500;color:var(--tg-theme-text-color,#fff);font-size:1rem;display:flex;align-items:center;gap:6px;opacity:.88}
    select{appearance:none;background:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23B8860B' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E") no-repeat right 16px center;background-size:20px;padding-right:48px}
    textarea:not(.request-textarea){min-height:140px;line-height:1.6;resize:vertical}
    textarea.request-textarea{line-height:1.6;}
    .request-label{font-size:var(--fluid-md);text-align:center;margin-bottom:var(--spacing-sm);color:var(--primary-color);font-weight:700;letter-spacing:-0.5px}
    .request-help-row{display:flex;align-items:center;justify-content:space-between;gap:var(--spacing-sm);margin-bottom:var(--spacing-sm)}
    .request-help-row .request-label{margin-bottom:0;text-align:left;font-size:var(--fluid-base);letter-spacing:-0.2px;line-height:1.2;flex:1;min-width:0}
    /* Apple-style quick picker */
    /* Referral card */
    .referral-card{background:linear-gradient(135deg,rgba(var(--primary-rgb),0.1),rgba(var(--primary-rgb),0.05));border:1px solid rgba(var(--primary-rgb),0.3);border-radius:16px;padding:18px;margin:0 0 16px}
    .referral-link-row{display:flex;gap:8px;align-items:center;margin:12px 0;min-width:0;flex-wrap:wrap}
    .referral-link-input{flex:1;min-width:120px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.12);border-radius:10px;color:#fff;font-size:0.78rem;padding:10px 12px;font-family:monospace;outline:none;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
    .referral-share-btn{padding:10px 14px !important;border-radius:10px !important;background:rgba(var(--primary-rgb),0.12) !important;border:1px solid rgba(var(--primary-rgb),0.45) !important;color:var(--primary-color) !important;font-weight:700 !important;font-size:0.8rem !important;cursor:pointer;font-family:inherit;white-space:nowrap;flex-shrink:0;box-shadow:none !important;animation:none !important;transition:background .2s;letter-spacing:0 !important}
    .referral-share-btn:active{background:rgba(var(--primary-rgb),0.22) !important}
    .referral-stats{display:flex;gap:10px;margin-top:12px}
    .referral-stat-box{flex:1;background:rgba(255,255,255,0.05);border-radius:10px;padding:10px;text-align:center}
    .referral-stat-num{font-size:1.4rem;font-weight:700;color:var(--primary-color)}
    .referral-stat-label{font-size:0.7rem;color:rgba(255,255,255,0.5);margin-top:2px}
    .quick-picker{position:relative;margin-bottom:12px}
    .quick-picker-btn{width:100%;padding:12px 16px;border-radius:12px;background:rgba(var(--primary-rgb),0.1);border:1px solid rgba(var(--primary-rgb),0.35);color:var(--primary-color);font-size:0.95rem;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:space-between;transition:background .2s}
    .quick-picker-btn:hover{background:rgba(var(--primary-rgb),0.16)}
    .quick-picker-btn .qa{transition:transform .25s ease;font-size:0.75rem;opacity:0.7}
    .quick-picker-btn.open .qa{transform:rotate(180deg)}
    .quick-picker-sheet{position:absolute;left:0;right:0;top:calc(100% + 6px);z-index:200;background:#1a1730;border:1px solid rgba(var(--primary-rgb),0.25);border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,.8);overflow:hidden;animation:sheetIn .2s ease}
    @keyframes sheetIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
    .quick-picker-scroll{max-height:260px;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:6px 0}
    .quick-picker-scroll::-webkit-scrollbar{width:3px}
    .quick-picker-scroll::-webkit-scrollbar-track{background:transparent}
    .quick-picker-scroll::-webkit-scrollbar-thumb{background:rgba(var(--primary-rgb),0.3);border-radius:2px}
    .quick-cat{display:none}
    /* Новый блок ввода запроса */
    .request-input-box{border:1px solid rgba(255,255,255,0.1);border-radius:14px;overflow:visible;background:rgba(255,255,255,0.04);position:relative;}
    .request-textarea{width:100%;background:transparent;border:none;border-radius:14px 14px 0 0;padding:14px 14px 10px;resize:none;min-height:90px;font-size:16px;color:#fff;font-family:inherit;box-sizing:border-box;outline:none;}
    .request-textarea::placeholder{color:rgba(255,255,255,0.55);opacity:1;}
    .request-textarea:focus{outline:none;box-shadow:none;border:none;}
    .request-quick-bar{border-top:1px solid rgba(255,255,255,0.07);position:relative;}
    .request-quick-toggle{width:100%;background:none;border:none;color:rgba(var(--primary-rgb),0.55);font-size:0.72rem;font-weight:600;font-family:inherit;padding:8px 14px;cursor:pointer;display:flex;align-items:center;gap:6px;letter-spacing:0.03em;transition:color .2s;min-height:unset;box-shadow:none;animation:none;margin:0;border-radius:0 0 14px 14px;justify-content:space-between;}
    /* Soul Chat page */
    .sc-msg-user{display:flex;justify-content:flex-end;margin-bottom:12px;padding:0 4px;}
    .sc-msg-soul{display:flex;justify-content:flex-start;margin-bottom:12px;padding:0 4px;}
    .sc-bubble-user{max-width:80%;padding:12px 16px;border-radius:18px 18px 4px 18px;background:rgba(var(--primary-rgb),0.14);border:1px solid rgba(var(--primary-rgb),0.28);font-size:0.9rem;line-height:1.6;color:#fff;white-space:pre-wrap;overflow-wrap:break-word;word-break:break-word}
    .sc-bubble-soul{max-width:88%;padding:14px 18px;border-radius:18px 18px 18px 4px;background:linear-gradient(135deg,rgba(var(--primary-rgb),0.08),rgba(var(--secondary-rgb),0.04));border:1px solid rgba(255,255,255,0.12);border-left:3px solid rgba(var(--primary-rgb),0.4);font-size:0.92rem;line-height:1.72;color:rgba(255,255,255,0.95);white-space:pre-wrap;overflow-wrap:break-word;word-break:break-word;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
    .sc-send-bar{border-top:1px solid rgba(255,255,255,0.06);padding:10px 12px;display:flex;justify-content:flex-end;align-items:center;gap:8px;}
    .sc-char-hint{font-size:0.7rem;color:rgba(255,255,255,0.25);flex:1;}
    @keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.5;transform:scale(0.88);}}
    @keyframes sc-spin{to{transform:rotate(360deg);}}
    .request-quick-toggle:hover{color:rgba(var(--primary-rgb),0.85);}
    .request-quick-toggle.open{color:rgba(var(--primary-rgb),0.9);}
    .request-quick-dropdown{position:absolute;left:0;right:0;bottom:calc(100% + 4px);z-index:200;background:#1c1930;border:1px solid rgba(var(--primary-rgb),0.2);border-radius:14px;box-shadow:0 -8px 32px rgba(0,0,0,.75);max-height:240px;overflow-y:auto;}
    .request-quick-dropdown::-webkit-scrollbar{width:3px}
    .request-quick-dropdown::-webkit-scrollbar-thumb{background:rgba(var(--primary-rgb),0.25);border-radius:2px}
    .request-quick-dropdown .quick-item{display:block;width:100%;padding:10px 14px;background:none;border:none;color:rgba(255,255,255,0.8);font-size:0.82rem;font-weight:500;cursor:pointer;font-family:inherit;text-align:left;border-bottom:1px solid rgba(255,255,255,0.04);transition:background .15s;min-height:unset;box-shadow:none;animation:none;margin:0;border-radius:0;}
    .request-quick-dropdown .quick-item:last-child{border-bottom:none;border-radius:0 0 14px 14px;}
    .request-quick-dropdown .quick-item:first-child{border-radius:14px 14px 0 0;}
    .request-quick-dropdown .quick-item:hover,.request-quick-dropdown .quick-item:active{background:rgba(var(--primary-rgb),0.09);color:#fff;}
    .quick-item{display:block;width:100%;padding:11px 16px;background:none;border:none;color:rgba(255,255,255,0.85);font-size:0.9rem;font-weight:500;cursor:pointer;font-family:inherit;text-align:left;transition:background .15s;border-bottom:1px solid rgba(255,255,255,0.04)}
    .quick-item:last-child{border-bottom:none}
    .quick-item:hover,.quick-item:active{background:rgba(var(--primary-rgb),0.1);color:var(--primary-color)}
    /* Старые стили (оставляем для совместимости) */
    .quick-dropdown{position:relative;flex:1 1 auto;min-width:0;margin-bottom:var(--spacing-sm);min-width:120px}
    @media (max-width: 380px){
      .request-help-row{flex-wrap:wrap}
      .request-help-row .request-label{flex:1 1 100%;margin-bottom:var(--spacing-xs)}
      .quick-dropdown{flex:1 1 100%}
    }
    .request-help-toggle{width:100%;min-height:auto;margin:0;padding:var(--spacing-sm) var(--spacing-md);border-radius:var(--radius-md);background:linear-gradient(135deg,rgba(var(--primary-rgb),0.2),rgba(var(--primary-rgb),0.12));color:var(--primary-color);border:1px solid rgba(var(--primary-rgb),0.5);box-shadow:none;text-transform:none;letter-spacing:0;font-size:var(--fluid-sm);font-weight:600;flex:0 0 auto;white-space:nowrap;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:all .2s}
    .request-help-toggle::after{content:'';width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:6px solid currentColor;margin-left:6px;opacity:.8;transition:transform .2s}
    .request-help-toggle.open::after{transform:rotate(180deg)}
    .request-help-toggle:hover{background:rgba(var(--primary-rgb),.25)}
    .request-examples{display:none;position:absolute;top:100%;left:0;right:0;margin-top:4px;padding:var(--spacing-md);background:rgba(255,255,255,0.08);backdrop-filter:blur(16px);border:1px solid rgba(255,255,255,0.18);border-radius:var(--radius-md);box-shadow:0 8px 24px rgba(0,0,0,.5);max-height:min(45vh,220px);overflow-y:auto;z-index:100;-webkit-overflow-scrolling:touch}
    .request-examples.open{display:block}
    body.theme-light .request-examples{background:rgba(255,255,255,0.95);border-color:rgba(var(--primary-rgb),0.4);box-shadow:0 8px 24px rgba(0,0,0,0.12)}
    .quick-list{display:flex;flex-direction:column;gap:0;width:100%}
    .quick-list .example-btn{width:100% !important;padding:14px 18px !important;font-size:1.05rem !important;line-height:1.4 !important;min-height:auto !important;border-radius:0 !important;white-space:normal !important;overflow:visible !important;text-overflow:clip !important;box-sizing:border-box;background:transparent !important;border:none !important;border-bottom:1px solid rgba(255,255,255,0.1) !important;color:var(--tg-theme-text-color,#fff) !important;box-shadow:none !important;font-weight:500 !important;text-align:left !important;transition:all .2s !important}
    .quick-list .example-btn:last-child{border-bottom:none !important}
    .quick-list .example-btn:hover{background:rgba(var(--primary-rgb),.2) !important;color:var(--primary-light) !important;transform:none !important}
    body.theme-light .quick-list .example-btn{color:#1f2937 !important;border-bottom-color:rgba(31,41,55,0.1) !important}
    body.theme-light .quick-list .example-btn:hover{background:rgba(var(--primary-rgb),.15) !important;color:var(--primary-color) !important}
    .example-btn{width:auto;min-width:0;max-width:none;flex-shrink:0;white-space:normal;text-transform:none;letter-spacing:0;font-size:.95rem;font-weight:600;padding:12px 16px;margin:0;min-height:auto;border-radius:12px;box-shadow:none;word-wrap:break-word;word-break:break-word;overflow:visible}
    .example-btn::after{display:none}
    .example-btn:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(var(--primary-rgb),0.45)}
    button{background:linear-gradient(135deg, var(--primary-color), var(--secondary-color), var(--primary-color));background-size:300% 300%;animation:gradientShift 4s ease infinite;color:var(--tg-theme-button-text-color);border:none;padding:13px 24px;font-size:1rem;border-radius:14px;width:100%;font-weight:600;cursor:pointer;transition:all .25s ease;box-shadow:0 8px 22px rgba(var(--primary-rgb),0.4);margin-top:8px;letter-spacing:0;text-transform:none;min-height:48px;position:relative;overflow:hidden}
    button::after{display:none}
    button:hover{transform:translateY(-1px);box-shadow:0 10px 28px rgba(var(--primary-rgb),0.5)}
    button:active{transform:translateY(1px);box-shadow:0 4px 12px rgba(var(--primary-rgb),0.3)}
    button:disabled{background:rgba(255,255,255,0.15);cursor:not-allowed;transform:none;box-shadow:none;opacity:.6;animation:none}
    button.secondary{background:rgba(255,255,255,0.07);color:rgba(255,255,255,0.75);border:1px solid rgba(255,255,255,0.12);box-shadow:none;text-transform:none;letter-spacing:0;font-weight:500;min-height:42px;animation:none;font-size:0.92rem}
    button.secondary:hover{background:rgba(255,255,255,0.12);color:rgba(255,255,255,0.9)}
    button:focus-visible,.home-nav-link:focus-visible,[role="button"]:focus-visible,a:focus-visible,.lang-switcher-btn:focus-visible,#profileIconBtn:focus-visible,.profile-back-btn:focus-visible,.stories-close:focus-visible,.mode-info:focus-visible,.ppc-details-btn:focus-visible{outline:2px solid var(--tg-theme-button-color);outline-offset:2px}
    .btn-group{display:flex;gap:15px;margin-top:25px}
    .btn-group button{flex:1}
    .price-tag{background:linear-gradient(90deg,var(--primary-color),var(--secondary-color));color:white;padding:10px 18px;border-radius:12px;font-size:1.3rem;font-weight:700;text-align:center;margin:16px 0;box-shadow:0 4px 15px rgba(var(--primary-rgb),.3);letter-spacing:0.5px}
    .payment-info{background:rgba(var(--primary-rgb),.05);border-left:3px solid rgba(var(--primary-rgb),0.5);padding:14px;border-radius:0 12px 12px 0;margin:12px 0;font-size:.92rem;line-height:1.6}
    .payment-info::before{content:"";font-size:1.3rem}
    .success-icon{font-size:5rem;text-align:center;margin:20px 0;background:linear-gradient(90deg,var(--primary-color),var(--secondary-color));-webkit-background-clip:text;background-clip:text;color:transparent}
    .keys-composition{display:flex;align-items:center;justify-content:center;gap:20px;margin:25px 0;flex-wrap:wrap}
    .keys-composition svg{filter:drop-shadow(0 4px 12px rgba(var(--primary-rgb),.2));transition:transform .3s ease}
    .keys-composition .key-music{transform:rotate(-10deg);width:56px;height:80px}
    .keys-composition .key-door{transform:rotate(8deg);width:52px;height:80px}
    .keys-composition .key-music:hover,.keys-composition .key-door:hover{transform:rotate(0) scale(1.05)}
    .keys-composition-small{display:flex;align-items:center;justify-content:center;gap:12px;margin:15px 0}
    .keys-composition-small .key-music{width:36px;height:50px;transform:rotate(-8deg);opacity:.9}
    .keys-composition-small .key-door{width:34px;height:50px;transform:rotate(6deg);opacity:.9}
    .app-logo{display:block;margin:0 auto;max-width:140px;width:100%;height:auto;border-radius:0;box-shadow:none;opacity:0.94}
    /* Главная — минимализм: контент по центру, забота о взгляде */
    #homeHero{position:relative;text-align:center;background:linear-gradient(180deg,rgba(1,6,26,0.4) 0%,transparent 100%);flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:max(56px,calc(env(safe-area-inset-top)+50px)) var(--spacing-lg) var(--spacing-xl);gap:0;box-sizing:border-box;min-height:0}
    #homeHero .home-tagline{font-size:0.72rem;font-weight:400;letter-spacing:0.14em;color:rgba(var(--primary-rgb),0.45);margin-top:var(--spacing-md);text-transform:uppercase}
    #homeHero .home-greeting{font-size:0.95rem;color:rgba(255,255,255,0.6);line-height:1.6;max-width:240px;margin:var(--spacing-lg) auto var(--spacing-xl);letter-spacing:0.01em}
    #homeHero #startBtn{margin-top:0;width:auto;max-width:280px;padding:14px 36px;font-weight:600;letter-spacing:0.02em;border-radius:50px;align-self:center}
    /* Главная: только кнопки (язык слева, профиль справа), без панели */
    #homeTopBar{box-sizing:border-box;flex-shrink:0}
    #homeTopBar .home-topbar-slot{display:flex;align-items:center;justify-content:center;box-sizing:border-box}
    #homeTopBar .lang-switcher-compact{position:relative;display:flex;align-items:center;justify-content:center;box-sizing:border-box}
    /* Унификация кнопок topbar: 44×44, шрифт 9px Comfortaa, SVG 18×18 — перебивают все глобальные и медиаправила */
    #homeTopBar .home-topbar-btn,#homeTopBar #profileIconBtn,#homeTopBar .lang-switcher-btn{box-sizing:border-box !important;width:40px !important;height:40px !important;min-width:40px !important;min-height:40px !important;max-width:40px !important;max-height:40px !important;margin:0 !important;padding:0 !important;border:1.5px solid rgba(var(--primary-rgb),0.4) !important;border-radius:50% !important;display:flex !important;align-items:center !important;justify-content:center !important;flex-shrink:0 !important;line-height:0 !important;font-size:9px !important;font-family:'Comfortaa',sans-serif !important;font-weight:600 !important;color:rgba(var(--primary-rgb),0.9) !important;overflow:hidden !important;vertical-align:middle !important;background:linear-gradient(135deg,rgba(var(--primary-rgb),0.18),rgba(var(--secondary-rgb),0.14)) !important;cursor:pointer !important;box-shadow:0 2px 12px rgba(0,0,0,0.3) !important;position:relative !important;top:auto !important;right:auto !important;bottom:auto !important;left:auto;aspect-ratio:1/1 !important}
    #homeTopBar .home-topbar-btn svg,#homeTopBar #profileIconBtn svg{display:block !important;vertical-align:middle !important;width:18px !important;height:18px !important;min-width:18px !important;min-height:18px !important;flex-shrink:0 !important;fill:rgba(var(--primary-rgb),0.9) !important}
    #homeTopBar .home-topbar-btn span,#homeTopBar .lang-switcher-btn span{line-height:0 !important;vertical-align:middle !important;font-size:9px !important;font-family:'Comfortaa',sans-serif !important;font-weight:600 !important;color:rgba(var(--primary-rgb),0.9) !important}
    #homeTopBar .home-topbar-btn:active,#homeTopBar #profileIconBtn:active{background:rgba(var(--primary-rgb),0.28) !important}
    .lang-switcher-compact{position:relative}
    /* Нижняя зона: три ссылки строго в одну строку без переноса слова */
    .home-lower{display:flex;flex-direction:column;align-items:center;text-align:center}
    .home-nav{display:flex !important;flex-wrap:nowrap !important;justify-content:space-between !important;align-items:center !important;gap:4px !important;width:100%;max-width:100%;padding:8px 6px !important;margin-top:var(--spacing-lg) !important;box-sizing:border-box !important}
    .home-nav .home-nav-link{flex:1 1 0 !important;min-width:0 !important;max-width:none !important;text-align:center !important;white-space:nowrap !important;word-break:normal !important;overflow:visible !important;font-size:0.7rem !important;line-height:1.2 !important;padding:6px 2px !important;background:none !important;border:none !important;color:rgba(var(--primary-rgb),0.65) !important;cursor:pointer !important;font-family:inherit !important;font-weight:600 !important;box-shadow:none !important}
    .app-logo.success{max-width:180px;margin-bottom:15px}
    /* ── СТОРИС-ОНБОРДИНГ ── */
    #onboardingPage{
      position:fixed;inset:0;z-index:10001;
      background:#0A0A1A url('assets/bg-yupsoul.png') center/cover no-repeat;
      overflow:hidden;user-select:none;
      display:flex;flex-direction:column;
      padding-top:max(28px,calc(env(safe-area-inset-top)+14px));
      padding-bottom:max(24px,calc(env(safe-area-inset-bottom)+12px));
    }
    #onboardingPage::before{content:"";position:fixed;inset:0;background:linear-gradient(180deg,rgba(4,4,20,.5) 0%,rgba(8,10,35,.75) 100%);z-index:0;pointer-events:none}
    /* Прогресс-бары */
    .stories-bars{position:relative;display:flex;gap:5px;z-index:10;padding:0 44px 0 16px;flex-shrink:0;margin-bottom:0}
    .story-bar{flex:1;height:3px;border-radius:2px;background:rgba(255,255,255,0.25);overflow:hidden}
    .story-bar-fill{height:100%;width:0;background:rgba(255,255,255,0.9);border-radius:2px}
    .story-bar-fill.done{width:100%;transition:none}
    .story-bar-fill.playing{width:100%;transition:width var(--story-dur,4s) linear}
    /* Кнопка закрыть */
    .stories-close{position:absolute;top:max(24px,calc(env(safe-area-inset-top)+10px));right:14px;z-index:11;background:rgba(15,12,40,0.72);border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.8);font-size:0.9rem;min-width:44px;min-height:44px;width:44px;height:44px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s;padding:0;line-height:1;isolation:isolate;flex-shrink:0}
    .stories-close:hover{background:rgba(15,12,40,0.9)}
    /* Зоны тапа */
    .stories-tap-prev,.stories-tap-next{position:absolute;top:0;bottom:0;width:40%;z-index:5;cursor:pointer}
    .stories-tap-prev{left:0}
    .stories-tap-next{right:0}
    /* Бренд-блок превью — воздух, без давления */
    .ob-brand{position:relative;z-index:6;text-align:center;padding:clamp(56px,11vh,96px) 28px 0;pointer-events:none;flex-shrink:0}
    .ob-brand-logo{width:72px;height:72px;margin:0 auto 10px;display:block;opacity:0.95;filter:drop-shadow(0 3px 12px rgba(var(--primary-rgb),0.2))}
    .ob-brand-divider{width:28px;height:1px;background:linear-gradient(90deg,transparent,rgba(var(--primary-rgb),0.35),transparent);margin:10px auto}
    .ob-brand-tag{font-size:0.72rem;color:rgba(var(--primary-rgb),0.45);line-height:1.6;max-width:220px;margin:0 auto;letter-spacing:0.03em}
    /* Слайды — flex-grow, контент у верхнего края своей зоны */
    .onboarding-slide{position:relative;z-index:1;display:none;flex-direction:column;align-items:center;justify-content:flex-start;flex:1;padding:clamp(24px,7vh,60px) 36px clamp(16px,4vh,32px);text-align:center}
    .onboarding-slide.active{display:flex}
    /* Акцентный декор вместо иконки */
    .ob-slide-accent{width:32px;height:2px;background:linear-gradient(90deg,transparent,rgba(var(--primary-rgb),0.7),transparent);border-radius:2px;margin:0 auto 28px;animation:accentFade .5s ease-out}
    .ob-icon-wrap{width:80px;height:80px;margin:0 auto 24px;flex-shrink:0;filter:drop-shadow(0 4px 18px rgba(var(--primary-rgb),0.35));}
    .ob-icon-wrap img{width:100%;height:100%;object-fit:contain;display:block;}
    .ob-icon-sm{width:36px;height:36px;flex-shrink:0;filter:drop-shadow(0 2px 8px rgba(var(--primary-rgb),0.3));}
    .ob-icon-sm img{width:100%;height:100%;object-fit:contain;display:block;}
    @keyframes accentFade{from{opacity:0;transform:scaleX(0.4)}to{opacity:1;transform:scaleX(1)}}
    .onboarding-title{font-size:1.25rem !important;font-weight:600 !important;color:rgba(255,248,225,0.96);margin:0 0 16px 0;line-height:1.35;max-width:260px;letter-spacing:-0.01em}
    .onboarding-text{font-size:0.85rem !important;line-height:1.7 !important;color:rgba(255,255,255,0.5);margin:0 0 28px 0;max-width:240px}
    .onboarding-btn{padding:14px 32px;border-radius:var(--radius-lg);background:linear-gradient(135deg,var(--primary-color),#c9922e);border:none;color:#0a0810;font-size:0.9rem !important;font-weight:700;cursor:pointer;font-family:inherit;box-shadow:0 4px 20px rgba(var(--primary-rgb),0.3);transition:transform .2s,box-shadow .2s;min-width:180px;width:auto;margin-top:0;min-height:unset;animation:none;letter-spacing:0.03em;text-transform:none}
    .onboarding-btn:hover{transform:translateY(-1px);box-shadow:0 6px 24px rgba(var(--primary-rgb),0.4)}
    .onboarding-btn:active{transform:translateY(1px)}
    .onboarding-dots{display:none}
    .onboarding-progress{display:none}
    .onboarding-progress-bar{display:none}
    .onboarding-skip{display:none}
    .success-title{font-size:2.2rem;font-weight:700;text-align:center;margin:20px 0;background:linear-gradient(90deg,var(--primary-color),var(--secondary-color));-webkit-background-clip:text;background-clip:text;color:transparent}
    .success-text{font-size:1.15rem;line-height:1.7;margin:20px 0;text-align:center;padding:0 10px}
    .loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px 40px;text-align:center;min-height:70vh}
    .spinner{width:60px;height:60px;border:4px solid rgba(var(--primary-rgb),.15);border-top-color:var(--primary-color);border-radius:50%;margin:0 auto 25px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-text{font-size:1.5rem;color:var(--primary-color);font-weight:600;margin-bottom:15px}
    .song-preview{background:rgba(var(--primary-rgb),0.06);border-radius:16px;padding:20px;margin:20px 0;text-align:left;border:1px solid rgba(var(--primary-rgb),0.25)}
    .song-preview h3{color:var(--primary-color);font-size:1.1rem;margin-bottom:8px;text-align:center}
    .song-preview p{font-size:0.9rem;line-height:1.65;color:rgba(255,255,255,0.6)}
    footer{text-align:center;padding:20px 0 max(16px,env(safe-area-inset-bottom));color:rgba(255,255,255,0.22);font-size:var(--fluid-xs);margin-top:auto;letter-spacing:0.02em}
    .footer-help{display:inline-flex !important;align-items:center;justify-content:center;color:rgba(var(--primary-rgb),0.4) !important;font-size:.78rem !important;cursor:pointer;border:none !important;background:none !important;font-family:inherit;padding:8px 16px !important;margin:0 !important;border-radius:20px !important;box-shadow:none !important;animation:none !important;min-height:unset !important;width:auto !important;font-weight:400 !important;letter-spacing:0.04em !important;transition:color .2s,background .2s}
    .footer-help:hover,.footer-help:active{color:rgba(var(--primary-rgb),0.75) !important;background:rgba(var(--primary-rgb),0.06) !important}
    /* Карточки героев */
    .hero-card{background:rgba(255,255,255,0.04);border:1px solid rgba(var(--primary-rgb),0.12);border-radius:16px;padding:16px;margin-bottom:12px;transition:border-color .2s}
    .hero-card.expanded{border-color:rgba(var(--primary-rgb),0.28)}
    .hero-card-head{display:flex;align-items:center;gap:12px;cursor:pointer}
    .hero-avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,rgba(var(--primary-rgb),0.3),rgba(var(--primary-rgb),0.08));display:flex;align-items:center;justify-content:center;font-size:1.15rem;font-weight:700;color:var(--primary-color);flex-shrink:0;border:1px solid rgba(var(--primary-rgb),0.22)}
    .hero-card-name{font-size:1rem;font-weight:600;color:#fff;line-height:1.25}
    .hero-card-meta{font-size:0.77rem;color:rgba(255,255,255,0.4);margin-top:3px;line-height:1.4}
    .hero-card-chevron{margin-left:auto;font-size:0.72rem;color:rgba(255,255,255,0.3);transition:transform .25s;flex-shrink:0}
    .hero-card.expanded .hero-card-chevron{transform:rotate(180deg)}
    .hero-card-body{display:none;margin-top:14px;padding-top:14px;border-top:1px solid rgba(255,255,255,0.07)}
    .hero-card.expanded .hero-card-body{display:block}
    .hca-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .hca-btn{padding:8px 13px;border-radius:10px;border:1px solid rgba(var(--primary-rgb),0.28);background:rgba(var(--primary-rgb),0.07);color:var(--primary-color);font-size:0.82rem;font-weight:600;cursor:pointer;font-family:inherit;white-space:nowrap;min-height:unset;width:auto;box-shadow:none;animation:none;margin:0;transition:background .2s;letter-spacing:0;line-height:1.3}
    .hca-btn:active{background:rgba(var(--primary-rgb),0.18)}
    .hca-btn.hca-danger{border-color:rgba(239,68,68,0.28);color:rgba(239,68,68,0.7);background:rgba(239,68,68,0.06)}
    .hca-btn.hca-secondary{border-color:rgba(255,255,255,0.15);color:rgba(255,255,255,0.55);background:rgba(255,255,255,0.04)}
    /* История генераций в карточке героя */
    .hero-hist-section{margin-top:14px}
    .hero-hist-loading{font-size:0.82rem;color:rgba(255,255,255,0.35);text-align:center;padding:12px 0}
    .hero-hist-empty{font-size:0.82rem;color:rgba(255,255,255,0.3);text-align:center;padding:12px 0}
    .hero-hist-item{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:12px 14px;margin-bottom:8px}
    .hero-hist-title{font-size:0.88rem;font-weight:600;color:rgba(255,255,255,0.88);margin-bottom:4px}
    .hero-hist-meta{font-size:0.74rem;color:rgba(255,255,255,0.35);margin-bottom:10px}
    .hero-hist-block-label{font-size:0.74rem;font-weight:600;color:rgba(var(--primary-rgb),0.6);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:5px}
    .hero-hist-text{font-size:0.8rem;color:rgba(255,255,255,0.55);line-height:1.55;white-space:pre-wrap;max-height:160px;overflow-y:auto;margin-bottom:10px}
    .hero-hist-audio{display:inline-flex;align-items:center;gap:6px;font-size:0.8rem;color:var(--primary-color);text-decoration:none;background:rgba(var(--primary-rgb),0.08);border:1px solid rgba(var(--primary-rgb),0.25);border-radius:8px;padding:6px 12px;margin-top:4px}
    .hero-hist-toggle{font-size:0.78rem;color:rgba(255,255,255,0.35);background:none;border:none;cursor:pointer;font-family:inherit;padding:0;margin-bottom:8px;min-height:unset;width:auto;box-shadow:none;animation:none;letter-spacing:0}
    .hero-style-badge{display:inline-block;font-size:0.72rem;background:rgba(var(--primary-rgb),0.1);border:1px solid rgba(var(--primary-rgb),0.22);color:rgba(var(--primary-rgb),0.75);border-radius:6px;padding:2px 8px;margin-top:5px}
    /* Страница помощи */
    #helpPage .help-header{padding:max(20px,calc(env(safe-area-inset-top)+12px)) 20px 16px 20px}
    #loadingPage{align-items:center;justify-content:center}
    #successPage,.page#paymentThanksPage{flex-direction:column}
    .ppc-feature{display:flex;align-items:center;gap:4px}
    .ppc-info{width:14px;height:14px;border-radius:50%;border:1px solid rgba(var(--primary-rgb),0.35);color:rgba(var(--primary-rgb),0.6);font-size:0.6rem;font-weight:700;display:inline-flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;line-height:1;font-style:normal;user-select:none;margin-left:2px}
    .ppc-info:active{color:var(--primary-color);border-color:var(--primary-color)}
    #helpPage .help-back-row{display:flex;align-items:center;margin-bottom:12px}
    #helpPage .help-back-btn{background:none;border:none;color:rgba(255,255,255,0.5);font-size:1.5rem;cursor:pointer;padding:6px 10px;line-height:1;min-height:unset;width:auto;box-shadow:none;animation:none;margin:0;flex-shrink:0}
    #helpPage .help-title-wrap{text-align:center;padding:0 40px}
    #helpPage .help-title{font-size:1.35rem;font-weight:700;color:var(--primary-color);margin-bottom:4px}
    #helpPage .help-subtitle{font-size:0.85rem;color:rgba(255,255,255,0.45);line-height:1.5}
    .help-section{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:14px;margin:0 0 12px;overflow:hidden}
    .help-section-title{width:100%;background:none;border:none;color:rgba(255,255,255,0.85);font-size:0.95rem;font-weight:600;padding:15px 16px;text-align:left;cursor:pointer;font-family:inherit;display:flex;justify-content:space-between;align-items:center;gap:8px;line-height:1.35}
    .help-section-title .hst-icon{font-size:1.1rem;flex-shrink:0}
    .help-section-title .hst-chevron{font-size:0.7rem;opacity:0.45;transition:transform .25s;flex-shrink:0}
    .help-section.open .hst-chevron{transform:rotate(180deg)}
    .help-section-body{display:none;padding:0 16px 16px;font-size:0.87rem;color:rgba(255,255,255,0.6);line-height:1.65}
    .help-section.open .help-section-body{display:block}
    .help-section-body p{margin:0 0 8px}
    .help-section-body p:last-child{margin:0}
    .help-section-body ul{margin:6px 0 8px;padding-left:18px}
    .help-section-body ul li{margin-bottom:4px}
    .help-section-body strong{color:rgba(255,255,255,0.82)}
    .help-support-btn{width:100%;padding:13px 24px;border-radius:14px;background:linear-gradient(135deg,rgba(var(--primary-rgb),0.18),rgba(var(--primary-rgb),0.08)) !important;border:1px solid rgba(var(--primary-rgb),0.35);color:var(--primary-color) !important;font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit;margin-top:16px;transition:background .2s;animation:none !important;box-shadow:none !important;min-height:48px}
    .help-support-btn:hover{background:rgba(var(--primary-rgb),0.22) !important}
    .help-support-btn:active{background:rgba(var(--primary-rgb),0.28) !important}
    .birthplace-wrap{position:relative}
    .birthplace-suggestions{display:none;position:absolute;left:0;right:0;top:100%;margin-top:4px;background:var(--tg-theme-bg-color,rgba(15,12,40,0.98));border:2px solid rgba(var(--primary-rgb),0.5);border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.3);max-height:280px;overflow-y:auto;z-index:50;list-style:none;padding:6px 0}
    .birthplace-suggestions li{padding:14px 18px;cursor:pointer;font-size:1.05rem;color:var(--tg-theme-text-color,#fff);border-bottom:1px solid rgba(255,255,255,0.1);transition:all .2s;font-weight:400}
    .birthplace-suggestions li:last-child{border-bottom:none}
    .birthplace-suggestions li:hover,.birthplace-suggestions li.selected{background:rgba(var(--primary-rgb),.2);color:var(--primary-light)}
    .birthplace-suggestions .place-type{font-size:.9rem;color:rgba(255,255,255,0.6);margin-top:3px;font-weight:400}
    #birthplace,#birthplace2,#heroBirthplace{padding-right:3rem;text-overflow:ellipsis;min-width:0;font-size:1.05rem;font-weight:500}
    .birthplace-check{position:absolute;right:16px;top:50%;transform:translateY(-50%);pointer-events:none;color:#4ade80;font-size:1.15rem;display:none;font-weight:700;flex-shrink:0}
    .birthplace-wrap.has-place .birthplace-check{display:block}
    .birthplace-hint{margin-top:8px;font-size:.95rem;color:rgba(var(--primary-rgb),0.9);line-height:1.6;font-weight:500;background:rgba(var(--primary-rgb),0.08);padding:10px 14px;border-radius:10px;border:1px solid rgba(var(--primary-rgb),0.25)}
    @media (max-width: 600px) {
      .birthplace-suggestions{max-height:240px;border-width:2.5px}
      .birthplace-suggestions li{padding:16px 20px;font-size:1.2rem;font-weight:400;letter-spacing:0}
      .birthplace-suggestions .place-type{font-size:0.95rem;font-weight:400}
      #birthplace,#birthplace2,#heroBirthplace{font-size:1rem;padding:12px 48px 12px 16px;font-weight:500;letter-spacing:0}
      .birthplace-hint{font-size:0.9rem;padding:10px 14px}
      .field input:not([type="checkbox"]):not([type="radio"]){
        font-size:0.95rem;
        padding:12px 14px;
      }
      .field select{
        font-size:0.95rem;
        padding:12px 14px;
      }
    }
    
    #formPage header h1{font-size:clamp(1.1rem,4vw,1.35rem)}
    #formPage header .subtitle{font-size:0.72rem}
    #transitFormWrap { overflow: hidden; transition: max-height .38s cubic-bezier(.4,0,.2,1), opacity .3s ease; max-height: 0; opacity: 0; }
    #secondPersonForm{padding-top:8px;}
    
    /* Панель навигации для превью в браузере */
    .preview-nav{background:white;border-radius:16px;padding:12px;margin-bottom:25px;box-shadow:0 4px 20px rgba(var(--primary-rgb),.12);text-align:center;border:1px solid #e5e7eb;display:none}
    .preview-nav.show{display:block}
    .preview-nav-buttons{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:10px}
    .preview-nav button{background:rgba(var(--primary-rgb),0.1);color:var(--primary-color);border:1px solid rgba(var(--primary-rgb),0.35);padding:6px 14px;margin:0 4px;border-radius:20px;cursor:pointer;font-weight:600;transition:all .2s;font-size:.9rem;min-width:90px;min-height:auto;animation:none}
    .preview-nav button:hover{background:rgba(var(--primary-rgb),0.2);color:var(--primary-color);transform:translateY(-1px)}
    .preview-nav button.active{background:linear-gradient(90deg,var(--primary-color),var(--secondary-color));color:white;border-color:transparent;box-shadow:0 4px 15px rgba(var(--primary-rgb),.3)}
    
    @media (max-width:480px){.container{padding:0 var(--spacing-sm)}h1{font-size:var(--fluid-2xl)}.subtitle{font-size:var(--fluid-base)}.tagline{font-size:var(--fluid-md)}.section{padding:var(--spacing-lg) var(--spacing-md)}.btn-group{flex-direction:column}.btn-group button{width:100%}button{font-size:1rem;padding:13px 20px;min-height:48px}.price-tag{font-size:1.25rem;padding:10px 15px}.success-icon{font-size:4rem}.success-title{font-size:1.9rem}.success-text{font-size:1.05rem}.preview-nav-buttons{flex-direction:column;align-items:center}.preview-nav button{width:100%;max-width:200px}}
    @media (max-width:360px){.container{padding:0 var(--spacing-xs)}.section{padding:var(--spacing-md) var(--spacing-sm)}.content-wrapper{padding:12px}.profile-header{padding:max(16px,calc(env(safe-area-inset-top)+10px)) 14px 12px}.profile-scroll{padding:6px 14px calc(env(safe-area-inset-bottom)+120px)}}
    @media (max-height:500px) and (orientation:landscape){
      .profile-header{padding:max(12px,calc(env(safe-area-inset-top)+8px)) 16px 10px}
      .page-scroll{padding-bottom:max(16px,calc(env(safe-area-inset-bottom)+16px))}
      .ob-brand{padding-top:clamp(24px,6vh,48px)}
      .onboarding-slide{padding:clamp(16px,4vh,36px) 28px clamp(12px,3vh,24px)}
    }

    /* ── ИКОНКА ПРОФИЛЯ (в шапке главной страницы) ── */
    #profileIconBtn{min-width:44px;min-height:44px;width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,rgba(var(--primary-rgb),0.18),rgba(var(--secondary-rgb),0.14));border:1.5px solid rgba(var(--primary-rgb),0.4);cursor:pointer;padding:0;margin:0;box-shadow:0 2px 12px rgba(0,0,0,0.3);animation:none;display:flex;align-items:center;justify-content:center;font-size:0.85rem;font-weight:700;color:var(--primary-color);font-family:inherit;letter-spacing:0;line-height:1;transition:background .2s,border-color .2s;flex-shrink:0}
    #profileIconBtn:active{background:rgba(var(--primary-rgb),0.28)}

    /* ── ПРОФИЛЬ ── */
    .profile-header{display:flex;justify-content:space-between;align-items:center;padding:max(20px,calc(env(safe-area-inset-top)+12px)) 16px 16px;flex-shrink:0;background:#08071a;z-index:10;margin-bottom:0}
    .profile-header .profile-header-title{flex:1;text-align:center;margin:0}
    .profile-header-title{font-size:1.05rem;font-weight:600;color:rgba(255,255,255,0.85);letter-spacing:0.02em}
    /* Кнопки хедера: простой вид без неона (как до eb18e12) */
    .profile-back-btn,.header-back-btn{background:none;border:none;color:rgba(255,255,255,0.5);font-size:1.4rem;cursor:pointer;min-width:44px;min-height:44px;padding:10px;box-shadow:none;animation:none;margin:0;line-height:1;display:inline-flex;align-items:center;justify-content:center;flex-shrink:0}
    .btn-nav{background:none;border:none;color:rgba(255,255,255,0.55);font-size:1.5rem;cursor:pointer;min-width:44px;min-height:44px;padding:8px;box-shadow:none;animation:none;margin:0;line-height:1;display:inline-flex;align-items:center;justify-content:center;flex-shrink:0}
    .header-menu-btn,.btn-info{background:none;border:none;color:rgba(255,255,255,0.6);font-size:1.2rem;cursor:pointer;min-width:44px;min-height:44px;padding:10px;box-shadow:none;animation:none;margin:0;display:inline-flex;align-items:center;justify-content:center;flex-shrink:0}
    .profile-back-btn svg,.header-back-btn svg,.btn-nav svg,.header-menu-btn svg,.btn-info svg{width:18px !important;height:18px !important;flex-shrink:0 !important;fill:currentColor;stroke:currentColor}
    button.profile-back-btn,button.header-back-btn,button.btn-nav,button.header-menu-btn,button.btn-info{width:44px !important;height:44px !important;min-width:44px !important;min-height:44px !important;border-radius:50% !important}
    .btn-magic{border:1px solid rgba(var(--primary-rgb),0.4) !important;background:rgba(var(--primary-rgb),0.1) !important;box-shadow:none !important}
    .btn-pay{box-shadow:none !important}
    .btn-secondary{border:1px solid rgba(255,255,255,0.2) !important;background:rgba(255,255,255,0.04) !important;box-shadow:none !important}
    .form-header-bar,.form-nav-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;padding-top:max(10px,env(safe-area-inset-top));position:relative;flex-shrink:0;background:transparent;backdrop-filter:none;-webkit-backdrop-filter:none;z-index:100}
    .profile-scroll{padding:24px 20px calc(env(safe-area-inset-bottom)+120px)}
    .profile-identity{text-align:center;margin-bottom:28px;padding-top:8px}
    .profile-avatar-wrap{position:relative;width:88px;height:88px;margin:4px auto 18px;cursor:pointer}
    .profile-avatar{width:100%;height:100%;border-radius:28px;background:linear-gradient(145deg,rgba(var(--primary-rgb),0.2),rgba(var(--secondary-rgb),0.15));display:flex;align-items:center;justify-content:center;font-size:2.2rem;color:#fff;font-weight:700;letter-spacing:0;box-shadow:0 10px 32px rgba(0,0,0,0.6);overflow:hidden;transition:filter .18s,transform .18s}
    .profile-avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
    .profile-avatar-wrap:active .profile-avatar{filter:brightness(0.78);transform:translateY(1px)}
    .profile-avatar-edit{position:absolute;bottom:-4px;right:-4px;min-width:36px;min-height:36px;width:36px;height:36px;border-radius:50%;background:#1a1628;border:1.5px solid rgba(var(--primary-rgb),0.5);display:flex;align-items:center;justify-content:center;font-size:0.65rem;color:rgba(var(--primary-rgb),0.85);pointer-events:none}
    .profile-avatar-spinner{position:absolute;inset:0;border-radius:50%;background:rgba(10,8,25,0.6);display:none;align-items:center;justify-content:center;font-size:0.7rem;color:rgba(var(--primary-rgb),0.8)}
    .profile-name{font-size:1.3rem;font-weight:700;color:#fff;letter-spacing:0.01em;margin-bottom:8px}
    .profile-plan-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(var(--primary-rgb),0.1);border:1px solid rgba(var(--primary-rgb),0.28);border-radius:20px;padding:4px 12px;font-size:0.75rem;font-weight:600;color:rgba(var(--primary-rgb),0.85);letter-spacing:0.04em;text-transform:uppercase}
    .profile-balance-card{background:linear-gradient(135deg,rgba(var(--primary-rgb),0.07),rgba(var(--secondary-rgb),0.04));border:1px solid rgba(var(--primary-rgb),0.2);border-radius:18px;padding:18px 20px;margin-bottom:28px;display:flex;align-items:center;justify-content:space-between;gap:16px}
    .profile-balance-left{}
    .profile-balance-label{font-size:0.8rem;color:rgba(255,255,255,0.55);margin-bottom:4px;letter-spacing:0.02em}
    .profile-balance-value{font-size:2.2rem;font-weight:800;color:var(--primary-color);line-height:1}
    .profile-balance-hint{font-size:0.78rem;color:rgba(255,255,255,0.4);margin-top:6px;line-height:1.45}
    .profile-balance-icon{font-size:1.8rem;color:rgba(var(--primary-rgb),0.3);line-height:1;font-family:Georgia,serif;font-style:italic}
    .profile-section-title{font-size:0.72rem;font-weight:700;letter-spacing:0.12em;color:rgba(255,255,255,0.35);text-transform:uppercase;margin-bottom:14px;display:flex;align-items:center;gap:10px}
    .profile-section-title::after{content:'';flex:1;height:1px;background:rgba(255,255,255,0.06)}
    /* Карточка «Мои данные» — glassmorphism + glow */
    #profileSectionMyData.profile-section-title{color:rgba(var(--primary-rgb),0.9);font-size:0.75rem;letter-spacing:0.1em;margin-bottom:16px;padding-left:4px;position:relative}
    #profileSectionMyData.profile-section-title::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:12px;background:linear-gradient(180deg,#D4AF37,rgba(var(--primary-rgb),0.3));border-radius:2px}
    #profileDataCard{position:relative;display:flex;align-items:center;justify-content:space-between;gap:12px;background:linear-gradient(135deg,rgba(var(--primary-rgb),0.08) 0%,rgba(var(--primary-rgb),0.02) 100%);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(var(--primary-rgb),0.2);border-radius:20px;padding:20px 18px;margin-bottom:24px;overflow:hidden;transition:all 0.4s cubic-bezier(0.4,0,0.2,1);box-shadow:0 8px 32px rgba(var(--primary-rgb),0.1),inset 0 1px 0 rgba(255,255,255,0.05);box-sizing:border-box}
    #profileDataCard::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(var(--primary-rgb),0.15) 0%,transparent 70%);animation:profileDataCardPulse 8s ease-in-out infinite;pointer-events:none;opacity:0.5}
    @keyframes profileDataCardPulse{0%,100%{transform:scale(1);opacity:0.5}50%{transform:scale(1.1);opacity:0.8}}
    #profileDataCard:hover{transform:translateY(-2px);border-color:rgba(var(--primary-rgb),0.4);box-shadow:0 12px 40px rgba(var(--primary-rgb),0.2),inset 0 1px 0 rgba(255,255,255,0.1)}
    #profileDataCard .pfa-info{flex:1;min-width:0}
    #profileDataCard #profileEditBtn{position:relative;padding:16px 20px;background:linear-gradient(135deg,rgba(var(--primary-rgb),0.15) 0%,rgba(var(--primary-rgb),0.05) 100%);border:1px solid rgba(var(--primary-rgb),0.3);border-radius:14px;color:#D4AF37;font-family:'Comfortaa',sans-serif;font-size:0.95rem;font-weight:600;letter-spacing:0.02em;cursor:pointer;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);overflow:hidden;display:flex;align-items:center;justify-content:center;gap:10px;min-height:44px;box-shadow:none;animation:none;white-space:nowrap;flex-shrink:0}
    #profileDataCard #profileEditBtn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(var(--primary-rgb),0.3),transparent);transition:left 0.6s ease}
    #profileDataCard #profileEditBtn:hover::before{left:100%}
    #profileDataCard #profileEditBtn:hover{background:linear-gradient(135deg,rgba(var(--primary-rgb),0.25) 0%,rgba(var(--primary-rgb),0.1) 100%);border-color:rgba(var(--primary-rgb),0.5);transform:translateY(-1px);box-shadow:0 8px 24px rgba(var(--primary-rgb),0.3),inset 0 1px 0 rgba(255,255,255,0.1)}
    #profileDataCard #profileEditBtn:active{transform:scale(0.98);transition:transform 0.1s ease}
    /* YupSoul — компактная кнопка «Изменить» в профиле */
    #profileSectionMyData.profile-section-title{margin-bottom:12px}
    #profileDataCard{padding:12px 16px !important;margin-bottom:16px !important}
    #profileDataCard #profileEditBtn{padding:8px 16px !important;font-size:0.9rem !important;font-weight:500 !important;border-radius:20px !important;border:1px solid rgba(var(--primary-rgb),0.6) !important;background:rgba(var(--primary-rgb),0.1) !important;color:#D4AF37 !important;box-shadow:0 0 8px rgba(var(--primary-rgb),0.3) !important;backdrop-filter:blur(4px);min-height:unset !important;gap:6px !important}
    #profileDataCard #profileEditBtn::before{display:none}
    #profileDataCard #profileEditBtn:hover{background:rgba(var(--primary-rgb),0.2) !important;box-shadow:0 0 12px rgba(var(--primary-rgb),0.5) !important;transform:translateY(-1px)}
    #profileDataCard #profileEditBtn svg{width:14px !important;height:14px !important;fill:#D4AF37 !important;stroke:#D4AF37 !important}
    /* YupSoul — воздух в профиле: отступы и структура */
    #profilePage .profile-header{margin-bottom:24px !important}
    #profilePage .profile-section-title{margin-top:0 !important;margin-bottom:16px !important;padding-top:8px !important}
    #profilePage .profile-balance-card{margin-bottom:24px !important;padding:20px !important;border-radius:16px !important;box-shadow:0 4px 20px rgba(0,0,0,0.3) !important}
    #profilePage #profileDataCard{margin-bottom:24px !important;border-radius:16px !important;box-shadow:0 4px 20px rgba(0,0,0,0.3) !important}
    #profilePage .profile-plans-grid{margin-bottom:24px !important}
    #profilePage .profile-track-list{margin-bottom:24px !important}
    #profilePage .profile-referral-section{margin-bottom:24px !important;padding:20px !important;border-radius:16px !important;box-shadow:0 4px 20px rgba(0,0,0,0.2) !important}
    #profilePage .profile-create-btn{margin-top:24px !important;margin-bottom:12px !important}
    #profilePage .profile-create-btn + button{margin-top:0 !important}
    @media (max-width:480px){
      #profilePage .profile-scroll{padding:16px 12px calc(env(safe-area-inset-bottom)+120px) !important}
      #profilePage .profile-balance-card,#profilePage #profileDataCard,#profilePage .profile-referral-section{padding:16px !important;margin-bottom:20px !important}
    }
    /* Сетка планов */
    #profileSectionPlans.profile-section-title{margin-top:24px}
    .profile-plans-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
    .profile-plan-card{background:rgba(255,255,255,0.04);border:1.5px solid rgba(255,255,255,0.1);border-radius:16px;padding:16px 14px;position:relative;display:flex;flex-direction:column;gap:4px;transition:border-color .2s,background .2s}
    .profile-plan-card.current{background:rgba(var(--primary-rgb),0.07);border-color:rgba(var(--primary-rgb),0.38)}
    .profile-plan-card.popular{background:linear-gradient(135deg,rgba(var(--secondary-rgb),0.08),rgba(var(--primary-rgb),0.06));border-color:rgba(var(--secondary-rgb),0.35);grid-column:1 / -1}
    .ppc-badge{font-size:0.62rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:rgba(var(--primary-rgb),0.7);margin-bottom:4px}
    .ppc-badge.hot{color:var(--secondary-color)}
    .ppc-name{font-size:1rem;font-weight:700;color:#fff;margin-bottom:8px}
    .ppc-features{display:flex;flex-direction:column;gap:4px;margin-bottom:10px;flex:1}
    .ppc-feature{font-size:0.78rem;color:rgba(255,255,255,0.6);line-height:1.45}
    .ppc-price-wrap{display:flex;align-items:baseline;gap:8px;margin-bottom:8px}
    .ppc-price{font-size:0.85rem;font-weight:700;color:rgba(var(--primary-rgb),0.85)}
    .ppc-save{font-size:0.68rem;font-weight:600;color:var(--secondary-color);background:rgba(var(--secondary-rgb),0.1);border:1px solid rgba(var(--secondary-rgb),0.25);border-radius:10px;padding:2px 6px;white-space:nowrap}
    .profile-plan-card.current .ppc-price{color:rgba(255,255,255,0.4);font-size:0.75rem;font-weight:400}
    .profile-plan-card.master{background:linear-gradient(135deg,rgba(var(--primary-rgb),0.1),rgba(var(--secondary-rgb),0.07));border-color:rgba(var(--primary-rgb),0.5);grid-column:1 / -1}
    .ppc-badge.master-badge{color:var(--primary-color)}
    .ppc-btn.master-btn{background:linear-gradient(135deg,rgba(var(--primary-rgb),0.3),rgba(var(--secondary-rgb),0.25));border:1px solid rgba(var(--primary-rgb),0.5);color:var(--primary-color)}
    .ppc-btn{padding:8px 14px;border-radius:10px;background:rgba(var(--primary-rgb),0.15);border:1px solid rgba(var(--primary-rgb),0.35);color:var(--primary-color);font-size:0.78rem;font-weight:600;cursor:pointer;font-family:inherit;min-height:unset;box-shadow:none;animation:none;margin:0;letter-spacing:0.02em;width:100%}
    .ppc-btn:active{background:rgba(var(--primary-rgb),0.25)}
    .ppc-btn.popular-btn{background:linear-gradient(135deg,rgba(var(--secondary-rgb),0.25),rgba(var(--primary-rgb),0.18));border-color:rgba(var(--secondary-rgb),0.45);color:var(--secondary-color)}
    @media (max-width:520px){
      .profile-plans-grid{grid-template-columns:1fr}
    }
    /* Кнопка «Подробнее» под тарифной карточкой */
    .ppc-details-btn{width:100%;background:none;border:none;color:rgba(255,255,255,0.28);font-size:0.7rem;font-weight:500;font-family:inherit;min-height:44px;padding:12px 0;cursor:pointer;text-align:center;letter-spacing:0.03em;box-shadow:none;animation:none;margin:0;transition:color .2s;text-decoration:underline;text-underline-offset:3px;display:inline-flex;align-items:center;justify-content:center;}
    .ppc-details-btn:hover{color:rgba(255,255,255,0.55);}
    /* Модал описания тарифа */
    .plan-modal-overlay{position:fixed;inset:0;z-index:3000;background:rgba(0,0,0,0.65);backdrop-filter:blur(4px);display:flex;align-items:flex-end;justify-content:center;}
    .plan-modal-sheet{background:linear-gradient(165deg,#130826 0%,#0d1830 100%);border-radius:22px 22px 0 0;padding:28px 22px 36px;max-height:85vh;overflow-y:auto;width:100%;max-width:520px;box-sizing:border-box;}
    .plan-modal-sheet::-webkit-scrollbar{width:3px}
    .plan-modal-sheet::-webkit-scrollbar-thumb{background:rgba(var(--primary-rgb),0.2);border-radius:2px}
    .plan-modal-handle{width:40px;height:4px;border-radius:2px;background:rgba(255,255,255,0.15);margin:0 auto 24px;}
    .plan-modal-title{font-size:1.3rem;font-weight:700;color:var(--primary-color);margin-bottom:4px;}
    .plan-modal-price{font-size:0.9rem;color:rgba(255,255,255,0.5);margin-bottom:20px;}
    .plan-modal-section{font-size:0.72rem;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:rgba(var(--primary-rgb),0.55);margin:18px 0 10px;}
    .plan-modal-feature{display:flex;gap:10px;align-items:flex-start;margin-bottom:12px;}
    .plan-modal-feature-icon{flex-shrink:0;width:28px;height:28px;border-radius:8px;background:rgba(var(--primary-rgb),0.1);border:1px solid rgba(var(--primary-rgb),0.2);display:flex;align-items:center;justify-content:center;font-size:0.85rem;}
    .plan-modal-feature-text{font-size:0.84rem;color:rgba(255,255,255,0.75);line-height:1.5;}
    .plan-modal-feature-text strong{color:#fff;font-weight:600;}
    .plan-modal-cta{width:100%;margin-top:24px;padding:14px;border-radius:14px;font-size:0.95rem;font-weight:700;font-family:inherit;cursor:pointer;letter-spacing:0.02em;box-shadow:none;animation:none;}
    .plan-modal-cta.gold{background:linear-gradient(135deg,rgba(var(--primary-rgb),0.25),rgba(var(--primary-rgb),0.15));border:1px solid rgba(var(--primary-rgb),0.5);color:var(--primary-color);}
    .plan-modal-cta.pink{background:linear-gradient(135deg,rgba(var(--secondary-rgb),0.3),rgba(var(--primary-rgb),0.15));border:1px solid rgba(var(--secondary-rgb),0.5);color:var(--secondary-color);}
    .plan-modal-close{width:100%;margin-top:10px;padding:12px;border-radius:14px;font-size:0.85rem;font-weight:500;font-family:inherit;cursor:pointer;background:none;border:none;color:rgba(255,255,255,0.3);min-height:unset;box-shadow:none;animation:none;}
    /* Разовые треки */
    .profile-track-list{display:flex;flex-direction:column;gap:6px;margin-bottom:28px}
    .profile-track-item{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:13px;padding:13px 14px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:background .15s,border-color .15s}
    .profile-track-item:active{background:rgba(255,255,255,0.06);border-color:rgba(var(--primary-rgb),0.25)}
    .pti-name{font-size:0.88rem;font-weight:600;color:rgba(255,255,255,0.75)}
    .pti-desc{font-size:0.72rem;color:rgba(255,255,255,0.3);margin-top:3px}
    .pti-right{display:flex;align-items:center;gap:8px}
    .pti-price{font-size:0.88rem;font-weight:700;color:rgba(var(--primary-rgb),0.85)}
    .pti-arrow{font-size:0.8rem;color:rgba(255,255,255,0.2);line-height:1}
    /* Реферал */
    .profile-referral-section{margin-bottom:28px;background:linear-gradient(135deg,rgba(var(--primary-rgb),0.06),rgba(var(--primary-rgb),0.02));border:1px solid rgba(var(--primary-rgb),0.15);border-radius:18px;padding:18px 16px}
    .profile-referral-section .profile-section-title{margin-bottom:8px}
    .profile-ref-tagline{font-size:0.82rem;color:rgba(255,255,255,0.5);margin-bottom:16px;line-height:1.5}
    .profile-ref-link-row{display:none}
    .profile-ref-share-btn{width:100%;padding:13px 20px;border-radius:13px;background:rgba(var(--primary-rgb),0.14);border:1.5px solid rgba(var(--primary-rgb),0.38);color:var(--primary-color);font-weight:700;font-size:0.92rem;cursor:pointer;font-family:inherit;min-height:unset;box-shadow:none;animation:none;margin:0 0 14px;letter-spacing:0.02em;transition:background .2s}
    .profile-ref-share-btn:active{background:rgba(var(--primary-rgb),0.25)}
    .profile-ref-milestones{display:flex;align-items:center;justify-content:center;gap:4px;margin:10px 0 14px;flex-wrap:wrap}
    .ref-milestone{display:flex;flex-direction:column;align-items:center;gap:1px;background:rgba(var(--primary-rgb),0.07);border:1px solid rgba(var(--primary-rgb),0.15);border-radius:10px;padding:6px 8px;min-width:36px;transition:background .2s,border-color .2s}
    .ref-milestone.reached{background:rgba(var(--primary-rgb),0.18);border-color:rgba(var(--primary-rgb),0.5)}
    .ref-milestone.next{border-color:rgba(var(--primary-rgb),0.4);box-shadow:0 0 8px rgba(var(--primary-rgb),0.15)}
    .ref-mi-num{font-size:0.9rem;font-weight:800;color:var(--primary-color);line-height:1}
    .ref-mi-label{font-size:0.55rem;color:rgba(255,255,255,0.35);line-height:1}
    .ref-milestone-arrow{font-size:0.65rem;color:rgba(var(--primary-rgb),0.3);flex-shrink:0}
    .profile-ref-stats{display:flex;gap:10px}
    .profile-ref-stats span{flex:1;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:10px 12px;display:flex;flex-direction:column;align-items:center;gap:2px}
    .profile-ref-stats strong{font-size:1.4rem;font-weight:800;color:var(--primary-color);line-height:1}
    .profile-ref-stats-label{font-size:0.68rem;color:rgba(255,255,255,0.38);margin-top:2px;text-align:center}
    .profile-create-btn{width:100%;padding:15px 24px;border-radius:16px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));border:none;color:#fff;font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit;margin-bottom:12px;letter-spacing:0.02em;box-shadow:0 4px 20px rgba(var(--primary-rgb),0.2);transition:transform .15s,box-shadow .15s}
    .profile-create-btn:active{transform:scale(0.98)}
    /* ── ФОРМА: АККОРДЕОН ПРОФИЛЯ ── */
    .pfa-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:rgba(var(--primary-rgb),0.05);border:1px solid rgba(var(--primary-rgb),0.2);border-radius:14px;cursor:pointer;font-family:'Comfortaa',sans-serif;transition:background .2s,border-color .2s;user-select:none;-webkit-user-select:none;box-sizing:border-box;}
    .pfa-header:active{background:rgba(var(--primary-rgb),0.12);border-color:rgba(var(--primary-rgb),0.38);}
    .pfa-info{display:flex;align-items:center;gap:8px;min-width:0;flex:1;overflow:hidden;}
    .pfa-icon{color:rgba(var(--primary-rgb),0.7);flex-shrink:0;}
    .pfa-name{font-size:0.95rem;font-weight:700;color:rgba(255,255,255,0.92);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:'Comfortaa',sans-serif;}
    .pfa-sep{color:rgba(var(--primary-rgb),0.4);font-size:0.85rem;flex-shrink:0;}
    .pfa-date{font-size:0.85rem;color:rgba(var(--primary-rgb),0.82);white-space:nowrap;flex-shrink:0;font-family:'Comfortaa',sans-serif;}
    .pfa-chevron{color:rgba(var(--primary-rgb),0.65);flex-shrink:0;margin-left:12px;transition:transform .28s ease;display:flex;align-items:center;}
    .pfa-chevron.open{transform:rotate(180deg);}
    #formFieldsWrap{overflow:hidden;transition:max-height .38s cubic-bezier(.4,0,.2,1),opacity .3s ease;max-height:2400px;}
    #formFieldsWrap.pfw-collapsed{max-height:0!important;opacity:0;pointer-events:none;}
    #formFieldsWrap.no-anim{transition:none!important;}
    @media (prefers-reduced-motion:reduce){
      *,*::before,*::after{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important}
    }
    /* Декоративный hover (transform, box-shadow) отключаем на тач-устройствах — не «залипает» */
    @media (hover:none){
      button:hover,#payBtn:hover,.example-btn:hover,.onboarding-btn:hover,.preview-nav button:hover{transform:none}
      .keys-composition .key-music:hover{transform:rotate(-10deg)}
      .keys-composition .key-door:hover{transform:rotate(8deg)}
    }
    /* iOS/Android: при фокусе на элементе с текстом < 16px браузер делает автозум. Фиксируем минимум 16px у кликабельных элементов. Кнопки режимов — компактно (8px). */
    @media (hover:none) and (pointer:coarse){
      button,a,input,select,textarea,[role="button"],.mode-info,.form-nav-link,.home-nav-link,.lang-switcher-btn,.lang-opt,.ppc-details-btn,.ppc-btn,.request-quick-toggle,.quick-item,.quick-picker-btn,.onboarding-btn,.hca-btn,.hero-hist-toggle,.stories-close,.profile-back-btn,.preview-nav button,.example-btn,.request-help-toggle{font-size:max(1rem,16px)}
      .mode-btn,.mode-btn .mode-label{font-size:8px !important}
      .request-quick-dropdown .quick-item{font-size:max(1rem,16px)}
      #homeTopBar .home-topbar-btn,#homeTopBar #profileIconBtn,#homeTopBar .lang-switcher-btn,#homeTopBar .home-topbar-btn span{font-size:9px !important}
    }

    /* ============================================
       YUPSOUL — Адаптивность для маленьких экранов
       ============================================ */
    * { box-sizing: border-box; }
    html, body {
      width: 100%;
      min-width: 320px !important;
      max-width: 100vw;
      overflow-x: hidden;
    }
    body { font-size: 16px; }
    #app, .app-container, .main-wrapper {
      width: 100%;
      min-width: 320px;
      max-width: 100%;
      margin: 0 auto;
      padding: 0;
    }
    @media (max-width: 480px) {
      .profilePage, #profilePage, .page-content {
        padding-left: 12px !important;
        padding-right: 12px !important;
      }
      .profile-section, .profile-card, .content-block {
        padding: 14px !important;
        margin-bottom: 16px !important;
      }
    }
    @media (max-width: 480px) {
      h1, .header-title { font-size: 1.1rem !important; }
      h2, .section-title { font-size: 0.95rem !important; }
      p, .text-content, .profile-field { font-size: 0.85rem !important; }
      button, .btn { font-size: 0.9rem !important; padding: 10px 16px !important; }
    }
    button, .btn, .profile-back-btn, .header-menu-btn, .action-button {
      min-width: 40px !important;
      min-height: 40px !important;
      flex-shrink: 0 !important;
    }
    .header, .page-header, #homeTopBar {
      min-height: 56px !important;
      flex-shrink: 0 !important;
      padding: 10px 12px !important;
    }
    @media (max-width: 480px) {
      .header, .page-header { padding: 8px 12px !important; min-height: 50px !important; }
    }
    .card, .profile-card, .content-block, .section-container { min-width: 280px !important; }
    .flex-container, .button-group, .profile-actions { flex-wrap: wrap !important; gap: 8px !important; }
    @media (max-width: 480px) {
      .flex-container, .button-group { flex-direction: column !important; width: 100%; }
      .flex-container > *, .button-group > * { width: 100% !important; flex: 1 1 100% !important; }
    }
    img, svg, .icon { max-width: 100%; height: auto; flex-shrink: 0; }
    .modal, .popup, .dialog-overlay {
      max-width: 100% !important;
      min-width: 320px !important;
      margin: 10px !important;
    }
    @media (max-width: 480px) {
      .modal, .popup { margin: 5px !important; padding: 12px !important; }
    }
    input, textarea, select { min-width: 200px !important; font-size: 16px !important; }
    #startBtn, .main-action-btn, .create-song-btn {
      min-width: 240px !important;
      max-width: 90% !important;
      width: auto !important;
      padding: 14px 28px !important;
      font-size: 1rem !important;
    }
    @media (max-width: 480px) {
      #startBtn, .main-action-btn { min-width: 200px !important; padding: 12px 24px !important; font-size: 0.95rem !important; }
    }
    .nav-menu, .bottom-nav, .menu-buttons { flex-wrap: wrap !important; justify-content: center !important; }
    @media (max-width: 480px) {
      .nav-menu, .bottom-nav { gap: 6px !important; }
      .nav-menu button, .bottom-nav button { min-width: 80px !important; font-size: 0.8rem !important; padding: 8px 12px !important; }
    }
    .logo, .app-logo, .brand-image { max-width: 120px !important; width: 30% !important; min-width: 80px !important; }
    @media (max-width: 480px) { .logo, .app-logo { max-width: 100px !important; width: 35% !important; } }
    .greeting, .welcome-text, #homeGreeting { font-size: 0.9rem !important; max-width: 90% !important; word-wrap: break-word; }
    @media (max-width: 480px) { .greeting { font-size: 0.85rem !important; } }
    body, html, #app { overflow-x: hidden !important; position: relative; width: 100%; }
    .grid-container, .cards-grid, .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }
    @media (max-width: 480px) {
      .grid-container, .cards-grid { grid-template-columns: 1fr; gap: 8px; }
    }
    .card, .button, .profile-block { box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3); min-height: auto; }
    footer, .app-footer, .footer-info { padding: 12px !important; font-size: 0.75rem !important; }
    .tg-theme-params { width: 100%; }
    @supports (padding: max(0px)) {
      body { padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); }
      .header, .page-header { padding-top: max(10px, env(safe-area-inset-top)); padding-bottom: max(10px, env(safe-area-inset-bottom)); }
    }
    /* Сетка тарифов на очень узких экранах — одна колонка */
    @media (max-width: 400px) {
      .profile-plans-grid { grid-template-columns: 1fr !important; }
    }
    /* Модалка планов — вписывается в экран */
    @media (max-width: 480px) {
      .plan-modal-sheet { max-width: 100% !important; margin: 0 !important; padding: 20px 16px 28px !important; border-radius: 20px 20px 0 0 !important; }
    }

    /* ============================================
       YUPSOUL — Запрет сжатия на маленьких экранах
       ============================================ */
    html, body {
      min-width: 0 !important;
      width: 100%;
      overflow-x: hidden;
      font-size: 16px !important;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    * {
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    #app, .app-container, .main-wrapper, .page-content, #homePage, #profilePage {
      min-width: 0 !important;
      width: 100% !important;
      max-width: 100vw !important;
      margin: 0 auto !important;
      padding: 12px !important;
      box-sizing: border-box !important;
    }
    h1, h2, h3, h4, h5, h6 {
      font-size: clamp(1rem, 2.5vw, 1.5rem) !important;
    }
    p, span, div, label, input, textarea, button {
      font-size: clamp(0.875rem, 2vw, 1rem) !important;
    }
    button, .btn, .action-button, .card-button {
      min-width: 0 !important;
      min-height: 44px !important;
      padding: 12px 20px !important;
      font-size: 0.95rem !important;
      white-space: normal !important;
      flex-shrink: 0 !important;
    }
    .card, .profile-card, .content-block, .section-container, .format-song-block {
      min-width: 0 !important;
      width: 100% !important;
      padding: 16px !important;
      margin-bottom: 16px !important;
      box-sizing: border-box !important;
    }
    input, textarea, select, .text-input, .query-input {
      min-width: 0 !important;
      width: 100% !important;
      font-size: 16px !important;
      padding: 12px !important;
    }
    .birthdate-block, .user-info-block, .profile-field {
      min-width: 0 !important;
      width: 100% !important;
      padding: 14px 16px !important;
      font-size: 1rem !important;
    }
    .section-title, .block-title, h2 {
      min-width: 0 !important;
      font-size: 1.1rem !important;
      margin-bottom: 12px !important;
    }
    .format-buttons, .mode-buttons, .song-format-buttons {
      display: flex !important;
      flex-wrap: wrap !important;
      gap: 10px !important;
      justify-content: center !important;
      min-width: 0 !important;
    }
    .format-buttons button, .mode-buttons button, .song-format-buttons button {
      min-width: 90px !important;
      flex: 1 1 90px !important;
      padding: 12px 14px !important;
      font-size: 0.9rem !important;
    }
    #startBtn, .main-action-btn, .create-song-btn {
      min-width: 0 !important;
      max-width: 95% !important;
      width: auto !important;
      padding: 16px 32px !important;
      font-size: 1.05rem !important;
      margin: 16px auto !important;
      display: block !important;
    }
    .nav-buttons, .bottom-menu, .quick-actions, .home-nav {
      display: flex !important;
      flex-wrap: wrap !important;
      gap: 8px !important;
      justify-content: center !important;
      min-width: 0 !important;
    }
    .nav-buttons button, .bottom-menu button, .quick-actions button {
      min-width: 0 !important;
      padding: 10px 14px !important;
      font-size: 0.85rem !important;
      white-space: normal !important;
    }
    .header, .page-header, #homeTopBar {
      min-height: 56px !important;
      height: auto !important;
      padding: 10px 12px !important;
      flex-shrink: 0 !important;
    }
    @media (max-width: 360px) {
      html, body { font-size: 15px !important; }
      #app, .app-container { padding: 10px !important; min-width: 0 !important; }
      .card, .profile-card { min-width: 0 !important; padding: 14px !important; }
      button, .btn { min-width: 80px !important; min-height: 40px !important; font-size: 0.9rem !important; }
      #startBtn, .main-action-btn { min-width: 0 !important; width: 100% !important; font-size: 1rem !important; }
      .format-buttons, .mode-buttons, .song-format-buttons { gap: 8px !important; }
    }
    @media (min-width: 361px) and (max-width: 375px) {
      #app, .app-container { padding: 12px !important; min-width: 0 !important; }
      .card, .profile-card { min-width: 0 !important; }
      .format-buttons button, .mode-buttons button, .song-format-buttons button { min-width: 92px !important; font-size: 0.85rem !important; }
    }
    body, html, #app {
      overflow-x: hidden !important;
      position: relative !important;
      max-width: 100vw !important;
    }
    .flex-container, .flex-box {
      flex-shrink: 0 !important;
      min-width: 0 !important;
    }
    .flex-container > *, .flex-box > * {
      flex-shrink: 0 !important;
    }
    .grid-container, .cards-grid {
      grid-template-columns: 1fr !important;
      min-width: 0 !important;
    }
    .logo, .app-logo, .brand-image {
      min-width: 0 !important;
      max-width: 140px !important;
      width: 35% !important;
      flex-shrink: 0 !important;
    }
    .greeting, .welcome-text, #homeGreeting {
      min-width: 0 !important;
      font-size: 1rem !important;
      line-height: 1.4 !important;
    }
    footer, .app-footer {
      min-width: 0 !important;
      padding: 12px !important;
      font-size: 0.8rem !important;
    }

    /* ============================================
       YUPSOUL — ПОЛНОЕ удаление заголовка с названием бота
       (Telegram уже показывает название в окне)
       ============================================ */
    .header-title,
    .page-header-title,
    .app-title,
    .yupsoul-title,
    span.header-title,
    div.header-title,
    .text-title,
    .title-text,
    .header-text,
    .app-name,
    .brand-title,
    span[class*="header-title"],
    #homeTopBar .header-title,
    .form-header-bar .header-title,
    .page-header .header-title,
    header.page-header > h1 {
      display: none !important;
      visibility: hidden !important;
      position: absolute !important;
      left: -9999px !important;
      overflow: hidden !important;
      width: 0 !important;
      height: 0 !important;
      padding: 0 !important;
      margin: 0 !important;
      opacity: 0 !important;
    }
    .header-title-container,
    .page-header-text,
    .title-wrapper,
    .header-center,
    .header-middle,
    .title-container,
    .header-text-wrapper,
    .center-slot,
    .middle-section {
      display: none !important;
    }
    [style*="YupSoul Personal Music"] {
      display: none !important;
    }
    .form-header-bar > *:not(button) {
      display: none !important;
    }
    .header,
    .page-header,
    #homeTopBar,
    .form-header-bar,
    .page-header-bar,
    .header-container {
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      background: transparent !important;
      background-color: transparent !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      border: none !important;
      box-shadow: none !important;
      min-height: 56px !important;
      height: auto !important;
      margin: 0 !important;
    }
    #homeTopBar,
    .form-header-bar,
    .page-header {
      padding: max(10px, env(safe-area-inset-top)) 16px 0 !important;
    }
    #homeTopBar::before,
    #homeTopBar::after,
    .form-header-bar::before,
    .form-header-bar::after,
    .page-header::before,
    .page-header::after {
      display: none !important;
      content: none !important;
    }
    .header-back-btn,
    .header-menu-btn,
    .profile-back-btn,
    .profile-icon-btn,
    .btn-nav,
    .btn-info {
      display: inline-flex !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    /* ============================================
       YUPSOUL — ПОЛНОЕ УДАЛЕНИЕ ЧЕРНОЙ ПАНЕЛИ
       ============================================ */
    #homeTopBar,
    .page-header,
    .form-header-bar,
    .header-container,
    .page-header-bar,
    .header-wrapper {
      background: transparent !important;
      background-color: transparent !important;
      border: none !important;
      box-shadow: none !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      min-height: 0 !important;
      padding-top: max(8px, env(safe-area-inset-top)) !important;
      padding-bottom: 8px !important;
    }
    .page-header > span,
    .form-header-bar > span,
    .page-header > div:not([class*="back"]):not([class*="menu"]):not([class*="btn"]):not(.home-topbar-slot),
    .form-header-bar > div {
      display: none !important;
    }
    .profile-back-btn,
    .header-back-btn,
    .btn-nav,
    .profile-icon-btn,
    .header-menu-btn,
    .btn-info {
      display: flex !important;
      visibility: visible !important;
      opacity: 1 !important;
      position: relative !important;
      z-index: 100 !important;
    }
    #homeTopBar,
    .page-header,
    .form-header-bar {
      font-size: 0 !important;
    }
    #homeTopBar > *,
    .page-header > *,
    .form-header-bar > * {
      font-size: 16px !important;
    }
    .header-center,
    .header-middle,
    .center-slot,
    .middle-slot,
    .title-wrapper,
    .text-container {
      display: none !important;
      visibility: hidden !important;
      width: 0 !important;
      height: 0 !important;
    }
    .form-header-bar > :not(button):not(.home-topbar-slot) {
      display: none !important;
    }

    /* ============================================
       YUPSOUL — УДАЛИТЬ ЧЁРНУЮ ПАНЕЛЬ И ТЕКСТ
       ============================================ */
    .form-header-bar,
    .page-header,
    #homeTopBar {
      background: transparent !important;
      background-color: transparent !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      box-shadow: none !important;
      border: none !important;
      padding-top: 8px !important;
      padding-bottom: 8px !important;
    }
    .header-title,
    span.header-title,
    div.header-title,
    .page-header-title,
    .app-title,
    .form-header-bar .header-title,
    .page-header .header-title {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      width: 0 !important;
      height: 0 !important;
      overflow: hidden !important;
      position: absolute !important;
      left: -9999px !important;
    }
    .form-header-bar > span,
    .form-header-bar > div:not([class*="btn"]):not([class*="back"]):not([class*="menu"]),
    .page-header > span,
    .page-header > div:not([class*="btn"]):not([class*="back"]):not([class*="menu"]) {
      display: none !important;
    }
    .profile-back-btn,
    .header-back-btn,
    .btn-nav,
    .profile-icon-btn,
    .header-menu-btn,
    .btn-info,
    button[class*="back"],
    button[class*="menu"] {
      display: flex !important;
      visibility: visible !important;
      opacity: 1 !important;
      position: relative !important;
    }
    .form-header-bar,
    .page-header,
    #homeTopBar {
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      min-height: 44px !important;
    }
    .form-header-bar::before,
    .form-header-bar::after,
    .page-header::before,
    .page-header::after {
      display: none !important;
      content: none !important;
    }

    /* Финальный CSS-удар (пробивает inline и скрипты) */
    #formNavBar,
    .form-header-bar,
    .form-nav-bar,
    .page-header,
    #homeTopBar,
    .header-container {
      background: transparent !important;
      background-color: transparent !important;
      box-shadow: none !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      padding: 8px 12px !important;
      min-height: 44px !important;
    }
    .header-title,
    .page-header-title,
    .app-title,
    span.header-title,
    div.header-title,
    .form-header-bar > span,
    .form-header-bar > div:not([class*="btn"]):not([class*="back"]):not([class*="menu"]) {
      display: none !important;
      visibility: hidden !important;
      width: 0 !important;
      height: 0 !important;
      overflow: hidden !important;
    }
    .profile-back-btn,
    .header-back-btn,
    .btn-nav,
    .profile-icon-btn,
    .header-menu-btn,
    .btn-info {
      display: flex !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    /* ========== YupSoul ТЗ: полная прозрачность хедеров, скрытие текста ========== */
    #homeTopBar,
    .form-header-bar,
    .page-header,
    .header-container,
    .page-header-bar {
      background: transparent !important;
      background-color: transparent !important;
      border: none !important;
      box-shadow: none !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      min-height: 44px !important;
      padding: 8px 12px !important;
    }
    .header-title,
    .page-header-title,
    .app-title,
    span.header-title,
    div.header-title,
    .form-header-bar .header-title,
    .page-header .header-title,
    [style*="YupSoul Personal Music"] {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      width: 0 !important;
      height: 0 !important;
      overflow: hidden !important;
      position: absolute !important;
      left: -9999px !important;
    }
    #homeTopBar > :not(button):not(.home-topbar-slot),
    .form-header-bar > :not(button):not(.home-topbar-slot),
    .page-header > :not(button):not(.home-topbar-slot) {
      display: none !important;
    }
    .profile-back-btn,
    .header-back-btn,
    .btn-nav,
    .profile-icon-btn,
    .header-menu-btn,
    .btn-info,
    .home-topbar-btn {
      display: flex !important;
      visibility: visible !important;
      opacity: 1 !important;
      position: relative !important;
      z-index: 100 !important;
    }
    #homeTopBar,
    .form-header-bar,
    .page-header {
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
    }
    #homeTopBar::before,
    #homeTopBar::after,
    .form-header-bar::before,
    .form-header-bar::after,
    .page-header::before,
    .page-header::after {
      display: none !important;
      content: none !important;
    }

    /* ========== YupSoul ТЗ: кнопки навигации круглые 40x40, неон ========== */
    #homeTopBar .home-topbar-btn,
    #homeTopBar #profileIconBtn,
    #homeTopBar .lang-switcher-btn,
    .profile-back-btn,
    .header-back-btn,
    .btn-nav,
    .header-menu-btn,
    .btn-info {
      width: 40px !important;
      height: 40px !important;
      min-width: 40px !important;
      max-width: 40px !important;
      min-height: 40px !important;
      max-height: 40px !important;
      border-radius: 50% !important;
      aspect-ratio: 1 / 1 !important;
      padding: 0 !important;
      margin: 0 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
    #homeTopBar .home-topbar-btn svg,
    #homeTopBar #profileIconBtn svg,
    .profile-back-btn svg,
    .header-back-btn svg,
    .btn-nav svg,
    .header-menu-btn svg,
    .btn-info svg {
      width: 18px !important;
      height: 18px !important;
      flex-shrink: 0 !important;
    }
    .profile-back-btn,
    .header-back-btn,
    .btn-nav {
      border: 1px solid rgba(255, 0, 85, 0.7) !important;
      background: rgba(255, 0, 85, 0.1) !important;
      box-shadow:
        0 0 6px rgba(255, 0, 85, 0.5),
        0 0 12px rgba(255, 0, 85, 0.3),
        0 0 20px rgba(255, 0, 85, 0.1) !important;
      backdrop-filter: blur(4px) !important;
    }
    .header-menu-btn,
    .btn-info,
    #profileIconBtn {
      border: 1px solid rgba(0, 217, 255, 0.7) !important;
      background: rgba(0, 217, 255, 0.1) !important;
      box-shadow:
        0 0 6px rgba(0, 217, 255, 0.5),
        0 0 12px rgba(0, 217, 255, 0.3),
        0 0 20px rgba(0, 217, 255, 0.1) !important;
      backdrop-filter: blur(4px) !important;
    }
    .header-menu-btn svg,
    .btn-info svg,
    #profileIconBtn svg {
      fill: #FFD700 !important;
      stroke: #FFD700 !important;
      filter: drop-shadow(0 0 3px rgba(255, 215, 0, 0.6)) !important;
    }
    .profile-back-btn svg,
    .header-back-btn svg,
    .btn-nav svg {
      fill: rgba(255, 255, 255, 0.95) !important;
      stroke: rgba(255, 255, 255, 0.95) !important;
    }

    /* На странице профиля — кнопки без неона, нейтральные */
    #profilePage .profile-back-btn,
    #profilePage .header-back-btn,
    #profilePage .btn-nav,
    #profilePage .header-menu-btn,
    #profilePage .btn-info {
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      background: rgba(255, 255, 255, 0.06) !important;
      box-shadow: none !important;
      backdrop-filter: none !important;
    }
    #profilePage .profile-back-btn svg,
    #profilePage .header-back-btn svg,
    #profilePage .btn-nav svg {
      fill: rgba(255, 255, 255, 0.85) !important;
      stroke: rgba(255, 255, 255, 0.85) !important;
    }
    #profilePage .header-menu-btn svg,
    #profilePage .btn-info svg {
      fill: rgba(255, 255, 255, 0.8) !important;
      stroke: rgba(255, 255, 255, 0.8) !important;
      filter: none !important;
    }

    /* ========== YupSoul ТЗ: адаптив на малых экранах (обновлено) ========== */
    html, body {
      min-width: 0 !important;
      width: 100%;
      overflow-x: hidden;
      font-size: 16px !important;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    #app, .app-container, .main-wrapper, .page-content, #homePage, #profilePage {
      min-width: 0 !important;
      width: 100% !important;
      max-width: 100vw !important;
      margin: 0 auto !important;
      padding: 12px !important;
      box-sizing: border-box !important;
    }
    button, .btn, .profile-back-btn, .header-menu-btn, .action-button {
      min-width: 40px !important;
      min-height: 40px !important;
      flex-shrink: 0 !important;
    }
    .card, .profile-card, .content-block, .section-container {
      min-width: 0 !important;
    }
    @media (max-width: 360px) {
      html, body { font-size: 15px !important; }
      #app, .app-container { padding: 10px !important; min-width: 0 !important; }
      .card, .profile-card { min-width: 0 !important; padding: 14px !important; }
      button, .btn { min-width: 80px !important; min-height: 42px !important; }
    }

    /* ============================================
       YUPSOUL — ПРЕМИАЛЬНЫЙ ДИЗАЙН КНОПОК
       Элегантность, глубина, дорогая простота
       ============================================ */

    /* --- БАЗОВЫЕ СТИЛИ ВСЕХ КНОПОК --- */
    button,
    .btn,
    [role="button"] {
      border-radius: 14px !important;
      padding: 14px 28px !important;
      min-height: 52px !important;
      font-family: 'Comfortaa', sans-serif !important;
      font-size: 0.95rem !important;
      font-weight: 600 !important;
      letter-spacing: 0.02em !important;
      line-height: 1.4 !important;
      background: linear-gradient(135deg, #D4AF37 0%, #B8860B 50%, #A67308 100%) !important;
      border: 1px solid rgba(212, 175, 55, 0.4) !important;
      box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.2),
        0 1px 3px rgba(212, 175, 55, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
      color: #0A0A1A !important;
      text-shadow: 0 1px 0 rgba(255, 255, 255, 0.2) !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      cursor: pointer !important;
      position: relative !important;
      overflow: hidden !important;
    }
    button:hover,
    .btn:hover,
    [role="button"]:hover {
      background: linear-gradient(135deg, #E5C156 0%, #C99B1F 50%, #B8860B 100%) !important;
      box-shadow:
        0 8px 24px rgba(0, 0, 0, 0.3),
        0 2px 6px rgba(212, 175, 55, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.15) !important;
      transform: translateY(-2px) !important;
      border-color: rgba(212, 175, 55, 0.6) !important;
    }
    button:active,
    .btn:active,
    [role="button"]:active {
      transform: translateY(0) scale(0.98) !important;
      box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.2),
        0 1px 2px rgba(212, 175, 55, 0.1),
        inset 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    }
    button:disabled,
    .btn:disabled,
    [role="button"]:disabled {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.3) 0%, rgba(184, 134, 11, 0.2) 100%) !important;
      border-color: rgba(212, 175, 55, 0.2) !important;
      box-shadow: none !important;
      color: rgba(255, 255, 255, 0.4) !important;
      cursor: not-allowed !important;
      transform: none !important;
    }

    /* --- КНОПКИ ХЕДЕРА --- */
    .profile-back-btn,
    .header-back-btn,
    .btn-nav {
      width: 44px !important;
      height: 44px !important;
      min-width: 44px !important;
      min-height: 44px !important;
      border-radius: 50% !important;
      padding: 0 !important;
      background: rgba(255, 255, 255, 0.03) !important;
      border: 1px solid rgba(255, 255, 255, 0.08) !important;
      box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.05) !important;
      color: rgba(255, 255, 255, 0.7) !important;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    .profile-back-btn:hover,
    .header-back-btn:hover,
    .btn-nav:hover {
      background: rgba(255, 255, 255, 0.06) !important;
      border-color: rgba(255, 255, 255, 0.15) !important;
      color: rgba(255, 255, 255, 0.9) !important;
      box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.08) !important;
    }
    .header-menu-btn,
    .btn-info,
    #profileIconBtn {
      width: 44px !important;
      height: 44px !important;
      min-width: 44px !important;
      min-height: 44px !important;
      border-radius: 50% !important;
      padding: 0 !important;
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.08) 0%, rgba(184, 134, 11, 0.05) 100%) !important;
      border: 1px solid rgba(212, 175, 55, 0.3) !important;
      box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.15),
        0 1px 2px rgba(212, 175, 55, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.05) !important;
      color: #D4AF37 !important;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    .header-menu-btn:hover,
    .btn-info:hover,
    #profileIconBtn:hover {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(184, 134, 11, 0.1) 100%) !important;
      border-color: rgba(212, 175, 55, 0.5) !important;
      box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.2),
        0 2px 4px rgba(212, 175, 55, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.08) !important;
    }
    .profile-back-btn svg,
    .header-back-btn svg,
    .btn-nav svg,
    .header-menu-btn svg,
    .btn-info svg,
    #profileIconBtn svg {
      width: 20px !important;
      height: 20px !important;
      flex-shrink: 0 !important;
      fill: currentColor !important;
      stroke: currentColor !important;
    }

    /* --- КНОПКИ РЕЖИМОВ --- */
    .mode-btn {
      min-height: 72px !important;
      padding: 12px 16px !important;
      border-radius: 12px !important;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.02) 100%) !important;
      border: 1px solid rgba(255, 255, 255, 0.08) !important;
      box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.03) !important;
      color: rgba(255, 255, 255, 0.75) !important;
      font-size: 0.85rem !important;
      font-weight: 600 !important;
      text-align: center !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    .mode-btn:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.04) 100%) !important;
      border-color: rgba(255, 255, 255, 0.15) !important;
      color: rgba(255, 255, 255, 0.9) !important;
      transform: translateY(-1px) !important;
      box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.05) !important;
    }
    .mode-btn.active {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.12) 0%, rgba(184, 134, 11, 0.08) 100%) !important;
      border: 1.5px solid rgba(212, 175, 55, 0.5) !important;
      color: #FFD76E !important;
      box-shadow:
        0 4px 16px rgba(212, 175, 55, 0.15),
        0 2px 6px rgba(212, 175, 55, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.08) !important;
      transform: translateY(-1px) !important;
    }
    .mode-btn.active .mode-label {
      font-weight: 700 !important;
      text-shadow: 0 1px 2px rgba(212, 175, 55, 0.3) !important;
    }

    /* --- ВТОРИЧНЫЕ КНОПКИ --- */
    button.secondary,
    .btn-secondary,
    .form-nav-link,
    .help-support-btn {
      background: rgba(255, 255, 255, 0.03) !important;
      border: 1px solid rgba(255, 255, 255, 0.12) !important;
      box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.03) !important;
      color: rgba(255, 255, 255, 0.65) !important;
      text-shadow: none !important;
    }
    button.secondary:hover,
    .btn-secondary:hover,
    .form-nav-link:hover,
    .help-support-btn:hover {
      background: rgba(255, 255, 255, 0.06) !important;
      border-color: rgba(255, 255, 255, 0.2) !important;
      color: rgba(255, 255, 255, 0.85) !important;
      box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.05) !important;
    }

    /* --- КНОПКИ ОПЛАТЫ --- */
    #payOvPayBtn {
      background: linear-gradient(135deg, #D4AF37 0%, #B8860B 50%, #A67308 100%) !important;
      border: 1px solid rgba(212, 175, 55, 0.4) !important;
      box-shadow:
        0 4px 16px rgba(212, 175, 55, 0.2),
        0 2px 6px rgba(212, 175, 55, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.15) !important;
      color: #0A0A1A !important;
      text-shadow: 0 1px 0 rgba(255, 255, 255, 0.2) !important;
    }
    #payOvPayBtn:hover {
      background: linear-gradient(135deg, #E5C156 0%, #C99B1F 50%, #B8860B 100%) !important;
      border-color: rgba(212, 175, 55, 0.6) !important;
      box-shadow:
        0 8px 24px rgba(212, 175, 55, 0.3),
        0 4px 10px rgba(212, 175, 55, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
      transform: translateY(-2px) !important;
    }
    #payOvStarsBtn {
      background: linear-gradient(135deg, #9B7DE8 0%, #7C5AE8 50%, #6B4BD6 100%) !important;
      border: 1px solid rgba(156, 125, 232, 0.4) !important;
      box-shadow:
        0 4px 16px rgba(156, 125, 232, 0.2),
        0 2px 6px rgba(156, 125, 232, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.15) !important;
      color: #FFFFFF !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
    #payOvStarsBtn:hover {
      background: linear-gradient(135deg, #AB8FF5 0%, #8C6BF5 50%, #7B5AE3 100%) !important;
      border-color: rgba(156, 125, 232, 0.6) !important;
      box-shadow:
        0 8px 24px rgba(156, 125, 232, 0.3),
        0 4px 10px rgba(156, 125, 232, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
      transform: translateY(-2px) !important;
    }

    /* --- КНОПКА ИЗМЕНИТЬ В ПРОФИЛЕ --- */
    #profileEditBtn {
      padding: 10px 20px !important;
      min-height: 44px !important;
      border-radius: 22px !important;
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(184, 134, 11, 0.05) 100%) !important;
      border: 1px solid rgba(212, 175, 55, 0.4) !important;
      box-shadow:
        0 2px 8px rgba(212, 175, 55, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.05) !important;
      color: #D4AF37 !important;
      font-size: 0.9rem !important;
      font-weight: 600 !important;
      letter-spacing: 0.01em !important;
    }
    #profileEditBtn:hover {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.18) 0%, rgba(184, 134, 11, 0.1) 100%) !important;
      border-color: rgba(212, 175, 55, 0.6) !important;
      box-shadow:
        0 4px 12px rgba(212, 175, 55, 0.15),
        0 2px 4px rgba(212, 175, 55, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.08) !important;
      transform: translateY(-1px) !important;
    }

    /* --- ЛАБОРАТОРИЯ (Герои) --- */
    .hca-btn {
      padding: 10px 16px !important;
      min-height: 42px !important;
      border-radius: 10px !important;
      font-size: 0.85rem !important;
      font-weight: 600 !important;
    }
    .hca-btn.hero-solo-btn,
    .hca-btn.hero-duo-btn {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.08) 0%, rgba(184, 134, 11, 0.05) 100%) !important;
      border: 1px solid rgba(212, 175, 55, 0.3) !important;
      color: #D4AF37 !important;
      box-shadow: 0 2px 8px rgba(212, 175, 55, 0.1) !important;
    }
    .hca-btn.hero-solo-btn:hover,
    .hca-btn.hero-duo-btn:hover {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(184, 134, 11, 0.1) 100%) !important;
      border-color: rgba(212, 175, 55, 0.5) !important;
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.15) !important;
      transform: translateY(-1px) !important;
    }
    .hca-btn.hca-danger {
      background: rgba(239, 68, 68, 0.06) !important;
      border: 1px solid rgba(239, 68, 68, 0.25) !important;
      color: rgba(239, 68, 68, 0.65) !important;
    }
    .hca-btn.hca-danger:hover {
      background: rgba(239, 68, 68, 0.12) !important;
      border-color: rgba(239, 68, 68, 0.4) !important;
      color: rgba(239, 68, 68, 0.85) !important;
    }

    /* --- БЫСТРЫЕ ЗАПРОСЫ --- */
    .quick-item,
    .example-btn {
      padding: 12px 16px !important;
      border-radius: 10px !important;
      font-size: 0.85rem !important;
      font-weight: 500 !important;
      background: rgba(255, 255, 255, 0.02) !important;
      border: 1px solid rgba(255, 255, 255, 0.06) !important;
      color: rgba(255, 255, 255, 0.75) !important;
      text-align: left !important;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    .quick-item:hover,
    .example-btn:hover {
      background: rgba(255, 255, 255, 0.05) !important;
      border-color: rgba(255, 255, 255, 0.12) !important;
      color: rgba(255, 255, 255, 0.9) !important;
      transform: translateX(2px) !important;
    }

    /* --- ГЛАВНАЯ КНОПКА СОЗДАТЬ СВОЮ ПЕСНЮ --- */
    #startBtn,
    .profile-create-btn,
    .onboarding-btn {
      padding: 16px 40px !important;
      min-height: 56px !important;
      border-radius: 28px !important;
      background: linear-gradient(135deg, #D4AF37 0%, #B8860B 45%, #A67308 100%) !important;
      border: 1px solid rgba(212, 175, 55, 0.4) !important;
      box-shadow:
        0 8px 24px rgba(212, 175, 55, 0.25),
        0 4px 10px rgba(212, 175, 55, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
      color: #0A0A1A !important;
      font-size: 1rem !important;
      font-weight: 700 !important;
      letter-spacing: 0.02em !important;
      text-shadow: 0 1px 0 rgba(255, 255, 255, 0.25) !important;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    #startBtn:hover,
    .profile-create-btn:hover,
    .onboarding-btn:hover {
      background: linear-gradient(135deg, #E5C156 0%, #C99B1F 45%, #B8860B 100%) !important;
      border-color: rgba(212, 175, 55, 0.6) !important;
      box-shadow:
        0 12px 32px rgba(212, 175, 55, 0.35),
        0 6px 14px rgba(212, 175, 55, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.25) !important;
      transform: translateY(-3px) !important;
    }
    #startBtn:active,
    .profile-create-btn:active,
    .onboarding-btn:active {
      transform: translateY(-1px) scale(0.98) !important;
      box-shadow:
        0 4px 12px rgba(212, 175, 55, 0.2),
        0 2px 4px rgba(212, 175, 55, 0.1),
        inset 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    }

    /* --- КНОПКИ ТАРИФОВ --- */
    .ppc-btn,
    .plan-modal-cta {
      padding: 12px 20px !important;
      min-height: 46px !important;
      border-radius: 12px !important;
      font-size: 0.88rem !important;
      font-weight: 600 !important;
    }
    .ppc-btn.master-btn {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(184, 134, 11, 0.1) 100%) !important;
      border: 1px solid rgba(212, 175, 55, 0.4) !important;
      color: #D4AF37 !important;
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.15) !important;
    }
    .ppc-btn.master-btn:hover {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.25) 0%, rgba(184, 134, 11, 0.18) 100%) !important;
      border-color: rgba(212, 175, 55, 0.6) !important;
      box-shadow: 0 6px 16px rgba(212, 175, 55, 0.2) !important;
      transform: translateY(-2px) !important;
    }

    /* --- АДАПТИВНОСТЬ ПРЕМИУМ --- */
    @media (max-width: 480px) {
      button,
      .btn,
      [role="button"] {
        padding: 13px 24px !important;
        min-height: 50px !important;
        font-size: 0.9rem !important;
      }
      #startBtn,
      .profile-create-btn,
      .onboarding-btn {
        padding: 15px 32px !important;
        min-height: 54px !important;
        font-size: 0.95rem !important;
      }
      .mode-btn {
        min-height: 68px !important;
        padding: 10px 14px !important;
        font-size: 0.8rem !important;
      }
    }

    /* --- ПРЕМИУМ БЛИКИ И ГЛУБИНА --- */
    button::before,
    .btn::before,
    [role="button"]::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.1),
        transparent
      );
      transition: left 0.5s ease;
      pointer-events: none;
    }
    button:hover::before,
    .btn:hover::before,
    [role="button"]:hover::before {
      left: 100%;
    }
    .mode-btn.active::after,
    #startBtn::after,
    .profile-create-btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: inherit;
      background: radial-gradient(
        circle at 50% 0%,
        rgba(255, 255, 255, 0.08),
        transparent 70%
      );
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .mode-btn.active:hover::after,
    #startBtn:hover::after,
    .profile-create-btn:hover::after {
      opacity: 1;
    }

    /* --- УБРАТЬ ДЕШЁВЫЕ АНИМАЦИИ --- */
    button,
    .btn,
    [role="button"],
    #startBtn,
    .profile-create-btn,
    .onboarding-btn {
      animation: none !important;
      background-size: 100% 100% !important;
    }

    /* ============================================
       YUPSOUL — ФИНАЛЬНЫЙ CSS (ЗАМЕНЯЕТ ВСЁ)
       ============================================ */
    #homeTopBar,
    .page-header,
    .form-header-bar,
    .header-container,
    .profile-header {
      background: transparent !important;
      background-color: transparent !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      border: none !important;
      box-shadow: none !important;
      padding: 8px 12px !important;
      min-height: 44px !important;
    }
    .header-title,
    .page-header-title,
    .app-title,
    .profile-header-title,
    span.header-title,
    div.header-title,
    .form-header-bar .header-title,
    .page-header .header-title,
    .profile-header .profile-header-title,
    [style*="YupSoul Personal Music"],
    [style*="Personal Music"] {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      width: 0 !important;
      height: 0 !important;
      overflow: hidden !important;
      position: absolute !important;
      left: -9999px !important;
    }
    #homeTopBar > :not(button):not(.home-topbar-slot),
    .form-header-bar > :not(button):not(.home-topbar-slot),
    .page-header > :not(button):not(.home-topbar-slot),
    .profile-header > :not(button):not(.profile-header-title) {
      display: none !important;
    }
    .profile-back-btn,
    .header-back-btn,
    .btn-nav,
    .header-menu-btn,
    .btn-info,
    #profileIconBtn,
    .lang-switcher-btn,
    .home-topbar-btn {
      width: 40px !important;
      height: 40px !important;
      min-width: 40px !important;
      min-height: 40px !important;
      max-width: 40px !important;
      max-height: 40px !important;
      border-radius: 50% !important;
      border: 1px solid rgba(212, 175, 55, 0.4) !important;
      background: rgba(212, 175, 55, 0.08) !important;
      box-shadow: none !important;
      backdrop-filter: none !important;
      animation: none !important;
      padding: 0 !important;
      margin: 0 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
    .profile-back-btn:hover,
    .header-back-btn:hover,
    .btn-nav:hover,
    .header-menu-btn:hover,
    .btn-info:hover,
    #profileIconBtn:hover,
    .lang-switcher-btn:hover,
    .home-topbar-btn:hover {
      background: rgba(212, 175, 55, 0.15) !important;
      border-color: rgba(212, 175, 55, 0.6) !important;
      transform: translateY(-1px) !important;
    }
    .profile-back-btn svg,
    .header-back-btn svg,
    .btn-nav svg,
    .header-menu-btn svg,
    .btn-info svg,
    #profileIconBtn svg,
    .lang-switcher-btn svg,
    .home-topbar-btn svg {
      width: 18px !important;
      height: 18px !important;
      fill: #D4AF37 !important;
      stroke: #D4AF37 !important;
      filter: none !important;
    }
    button,
    .btn,
    [role="button"],
    #startBtn,
    #stepNext,
    #payBtn,
    #payOvPayBtn,
    .profile-create-btn,
    .onboarding-btn,
    .hca-btn,
    .ppc-btn,
    .mode-btn,
    .example-btn,
    .quick-item,
    .help-support-btn,
    .profile-ref-share-btn,
    .plan-modal-cta {
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3) !important;
      animation: none !important;
      background-size: 100% 100% !important;
      border: 1px solid rgba(212, 175, 55, 0.3) !important;
    }
    #startBtn,
    #stepNext,
    #payBtn,
    #payOvPayBtn,
    .profile-create-btn,
    .onboarding-btn {
      background: linear-gradient(135deg, #D4AF37 0%, #B8860B 100%) !important;
      border: 1px solid rgba(212, 175, 55, 0.4) !important;
      color: #0A0A1A !important;
    }
    #startBtn:hover,
    #stepNext:hover,
    #payBtn:hover,
    #payOvPayBtn:hover,
    .profile-create-btn:hover,
    .onboarding-btn:hover {
      background: linear-gradient(135deg, #E5C156 0%, #C99B1F 100%) !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4) !important;
    }
    button.secondary,
    .btn-secondary,
    .form-nav-link,
    .help-support-btn,
    .profile-ref-share-btn,
    #payOvBackBtn {
      background: rgba(255, 255, 255, 0.05) !important;
      border: 1px solid rgba(255, 255, 255, 0.15) !important;
      color: rgba(255, 255, 255, 0.7) !important;
      box-shadow: none !important;
    }
    button.secondary:hover,
    .btn-secondary:hover,
    .form-nav-link:hover,
    .help-support-btn:hover,
    .profile-ref-share-btn:hover,
    #payOvBackBtn:hover {
      background: rgba(255, 255, 255, 0.1) !important;
      border-color: rgba(255, 255, 255, 0.25) !important;
      color: rgba(255, 255, 255, 0.9) !important;
    }
    .mode-btn {
      background: rgba(255, 255, 255, 0.03) !important;
      border: 1px solid rgba(212, 175, 55, 0.2) !important;
      box-shadow: none !important;
      animation: none !important;
    }
    .mode-btn.active {
      background: rgba(212, 175, 55, 0.12) !important;
      border: 1.5px solid rgba(212, 175, 55, 0.5) !important;
      color: #FFD76E !important;
      box-shadow: 0 0 12px rgba(212, 175, 55, 0.2) !important;
    }
    .mode-btn.active::before,
    .mode-btn.active::after {
      display: none !important;
    }
    html, body {
      min-width: 0 !important;
      width: 100%;
      overflow-x: hidden;
      font-size: 16px !important;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    #app, .app-container, .main-wrapper, .page-content, #homePage, #profilePage, #formPage {
      min-width: 0 !important;
      width: 100% !important;
      max-width: 100vw !important;
      margin: 0 auto !important;
      padding: 12px !important;
      box-sizing: border-box !important;
    }
    button, .btn, .profile-back-btn, .header-menu-btn, .action-button {
      min-width: 40px !important;
      min-height: 40px !important;
      flex-shrink: 0 !important;
    }
    .card, .profile-card, .content-block, .section-container {
      min-width: 0 !important;
    }
    @media (max-width: 360px) {
      html, body { font-size: 15px !important; }
      #app, .app-container { padding: 10px !important; min-width: 0 !important; }
      .card, .profile-card { min-width: 0 !important; padding: 14px !important; }
      button, .btn { min-width: 80px !important; min-height: 42px !important; font-size: 0.9rem !important; }
    }
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.2s !important;
    }
    button, .btn, [role="button"], #startBtn, .profile-create-btn, .onboarding-btn {
      animation: none !important;
      background-size: 100% 100% !important;
    }
    #profileEditBtn {
      padding: 8px 16px !important;
      font-size: 0.9rem !important;
      font-weight: 500 !important;
      border-radius: 20px !important;
      border: 1px solid rgba(212, 175, 55, 0.6) !important;
      background: rgba(212, 175, 55, 0.1) !important;
      color: #D4AF37 !important;
      box-shadow: none !important;
      backdrop-filter: blur(4px);
      min-height: unset !important;
      gap: 6px !important;
      width: auto !important;
      max-width: fit-content !important;
    }
    #profileEditBtn:hover {
      background: rgba(212, 175, 55, 0.2) !important;
      border-color: rgba(212, 175, 55, 0.8) !important;
      transform: translateY(-1px) !important;
    }
    #profileEditBtn::before {
      display: none !important;
    }
    #profilePage .profile-header {
      margin-bottom: 24px !important;
    }
    #profilePage .profile-section-title {
      margin-top: 0 !important;
      margin-bottom: 16px !important;
      padding-top: 8px !important;
    }
    #profilePage .profile-balance-card,
    #profilePage #profileDataCard,
    #profilePage .profile-referral-section {
      padding: 16px !important;
      margin-bottom: 20px !important;
      border-radius: 16px !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }
    #profilePage .profile-create-btn {
      margin-top: 24px !important;
      margin-bottom: 12px !important;
    }
    @media (max-width: 480px) {
      #profilePage .profile-scroll {
        padding: 16px 12px calc(env(safe-area-inset-bottom) + 120px) !important;
      }
    }
  </style>
</head>
<body>
  <!-- Панель навигации для превью (показывается только в браузере) -->
  <div class="container">
    <div class="preview-nav" id="previewNav">
      <div style="font-weight:600;color:var(--primary-color);margin-bottom:8px">🎨 Режим превью</div>
      <div class="preview-nav-buttons">
        <button class="active" data-page="home">Главная</button>
        <button data-page="form">Форма</button>
        <button data-page="payment">Оплата</button>
        <button data-page="loading">Загрузка</button>
        <button data-page="success">Успех</button>
      </div>
    </div>
  </div>

  <!-- Онбординг — формат сторис -->
  <!-- ── Гейт-экран: пользователь ещё не нажал /start в боте ─────────────── -->
  <div id="botGatePage" style="display:none;position:fixed;inset:0;z-index:9999;background:linear-gradient(165deg,#0a0818 0%,#130826 50%,#0d1525 100%);flex-direction:column;align-items:center;justify-content:center;padding:32px 28px;text-align:center;font-family:'Comfortaa',sans-serif;">
    <img src="assets/logo-yupsoul.png" alt="YupSoul" style="width:80px;height:80px;object-fit:contain;border-radius:50%;border:2px solid rgba(var(--primary-rgb),0.25);margin-bottom:28px;">
    <div style="font-size:1.4rem;font-weight:700;color:var(--primary-color);margin-bottom:12px;line-height:1.3;">Один шаг до твоей песни</div>
    <div style="font-size:0.92rem;color:rgba(255,255,255,0.6);line-height:1.8;max-width:290px;margin-bottom:8px;">Готовую песню мы отправим тебе прямо в Telegram.</div>
    <div style="font-size:0.92rem;color:rgba(255,255,255,0.45);line-height:1.8;max-width:290px;margin-bottom:32px;">Чтобы бот мог написать тебе — нажми «Старт» в чате с ботом. Один раз, навсегда.</div>
    <button id="gateOpenBotBtn" type="button" style="width:100%;max-width:300px;padding:15px 24px;border-radius:14px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));border:none;color:#fff;font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit;box-shadow:0 6px 24px rgba(var(--primary-rgb),0.3);letter-spacing:0;margin-bottom:16px;">
      Перейти в бота и нажать Старт
    </button>
    <button id="gateCheckBtn" type="button" style="background:none;border:none;color:rgba(var(--primary-rgb),0.5);font-size:0.82rem;cursor:pointer;font-family:inherit;padding:8px 0;min-height:unset;box-shadow:none;animation:none;text-decoration:underline;text-underline-offset:3px;">
      Уже нажал Старт → войти
    </button>
  </div>
  <!-- ──────────────────────────────────────────────────────────────────────── -->

  <div id="onboardingPage" style="display:none">

    <!-- Прогресс-бары сторис -->
    <div class="stories-bars">
      <div class="story-bar"><div class="story-bar-fill" id="storyBar1"></div></div>
      <div class="story-bar"><div class="story-bar-fill" id="storyBar2"></div></div>
      <div class="story-bar"><div class="story-bar-fill" id="storyBar3"></div></div>
    </div>

    <!-- Кнопка закрыть -->
    <button class="stories-close" id="onboardingSkip" aria-label="Закрыть">✕</button>

    <!-- Бренд-блок: лого + слоган -->
    <div class="ob-brand">
      <img src="assets/logo-yupsoul.png" alt="YupSoul" class="ob-brand-logo" loading="lazy">
      <div class="ob-brand-divider"></div>
      <div class="ob-brand-tag">Первый в мире сервис, который превращает дату рождения в персональную музыку</div>
    </div>

    <!-- Зоны тапа: влево = назад, вправо = вперёд -->
    <div class="stories-tap-prev" id="storiesTapPrev"></div>
    <div class="stories-tap-next" id="storiesTapNext"></div>

    <!-- Слайд 1 — Открытие -->
    <div class="onboarding-slide active" data-step="1">
      <div class="ob-icon-wrap"><img src="assets/icons/music.png" alt="" loading="lazy"></div>
      <h2 class="onboarding-title" id="obTitle1">Есть песня — о тебе</h2>
      <p class="onboarding-text" id="obText1">Написанная по дате рождения. Не шаблон — живой текст о твоём характере, силе и пути.</p>
    </div>

    <!-- Слайд 2 — Ценность -->
    <div class="onboarding-slide" data-step="2">
      <div class="ob-icon-wrap"><img src="assets/icons/profile.png" alt="" loading="lazy"></div>
      <h2 class="onboarding-title" id="obTitle2">Только о тебе</h2>
      <p class="onboarding-text" id="obText2">Каждая — уникальна. Её больше нет ни у кого. Ни одна не повторяется.</p>
    </div>

    <!-- Слайд 3 — Начать -->
    <div class="onboarding-slide" data-step="3">
      <div class="ob-icon-wrap"><img src="assets/icons/lightning.png" alt="" loading="lazy"></div>
      <h2 class="onboarding-title" id="obTitle3">Первая — в подарок</h2>
      <p class="onboarding-text" id="obText3">Введи дату рождения. Песня придёт в чат с ботом.</p>
      <button class="onboarding-btn" id="onboardingStartBtn" style="display:none"></button>
    </div>

    <!-- Скрытые элементы для совместимости со старым JS -->
    <div class="onboarding-dots" style="display:none">
      <button class="onboarding-dot active" data-step="1"></button>
      <button class="onboarding-dot" data-step="2"></button>
      <button class="onboarding-dot" data-step="3"></button>
    </div>
    <div class="onboarding-progress" style="display:none">
      <div class="onboarding-progress-bar" id="onboardingProgressBar"></div>
    </div>
  </div>

  <!-- Страницы приложения -->
    <!-- Главная страница -->
    <div class="page" id="homePage">

      <!-- Только кнопки: язык слева, профиль справа, без панели и заголовка -->
      <div id="homeTopBar" style="display:flex;justify-content:space-between;align-items:center;padding:max(10px,env(safe-area-inset-top)) 16px 0;position:absolute;top:0;left:0;right:0;z-index:20;pointer-events:none;">
        <div class="home-topbar-slot" style="pointer-events:auto;">
          <div id="langSwitcher" class="lang-switcher-compact" aria-label="Язык интерфейса">
            <button type="button" id="langSwitcherBtn" class="lang-switcher-btn home-topbar-btn btn-info header-menu-btn" title="Язык">
              <span id="langSwitcherIcon" aria-hidden="true"></span>
              <span id="langSwitcherCurrent">RU</span>
            </button>
            <div id="langSwitcherDropdown" class="lang-dropdown" hidden>
              <button type="button" class="lang-opt" data-lang="ru">RU</button>
              <button type="button" class="lang-opt" data-lang="en">EN</button>
              <button type="button" class="lang-opt" data-lang="de">DE</button>
              <button type="button" class="lang-opt" data-lang="fr">FR</button>
            </div>
          </div>
        </div>
        <div class="home-topbar-slot" style="pointer-events:auto;">
          <button id="profileIconBtn" class="home-topbar-btn header-menu-btn btn-info" onclick="goToProfileFrom('homePage')" aria-label="Профиль" title="Профиль">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="8" r="4" fill="currentColor" opacity="0.9"/>
              <path d="M4 20c0-4 3.6-7 8-7s8 3 8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity="0.9"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Лого и приветствие — по центру -->
      <div id="homeHero">
        <img src="assets/logo-yupsoul.png" alt="YupSoul" class="app-logo" width="140" height="140">
        <div id="homeTagline" class="home-tagline">Музыка твоей души</div>
        <p id="homeGreeting" class="home-greeting">Привет</p>
        <button id="startBtn" class="btn-primary">Создать свою песню</button>
      </div>

      <!-- Нижняя зона — тихо, когда пусто -->
      <div class="home-lower" style="flex-shrink:0;padding:var(--spacing-md) var(--spacing-md) max(var(--spacing-lg),env(safe-area-inset-bottom))">

      <!-- Баннер восстановления — мягко, без давления -->
      <div id="recoveryBanner" style="display:none;margin:0 0 var(--spacing-md) 0;background:rgba(5,150,105,0.08);border:1px solid rgba(16,185,129,0.2);border-radius:var(--radius-md);padding:var(--spacing-md) var(--spacing-lg);position:relative;">
        <button id="recoveryDismissBtn" style="position:absolute;top:8px;right:10px;background:none;border:none;color:rgba(255,255,255,0.3);font-size:1rem;line-height:1;cursor:pointer;padding:2px 4px;min-height:unset;width:auto;box-shadow:none;animation:none;margin:0;font-weight:400;" title="Закрыть">✕</button>
        <div id="recoveryBannerText" style="font-size:0.88rem;color:rgba(209,250,229,0.85);line-height:1.5;margin-bottom:10px;padding-right:20px;">
          <strong style="color:#6ee7b7;">Твоя заявка ждёт!</strong> Получи первую песню бесплатно.
        </div>
        <button id="recoveryClaimBtn" style="width:100%;padding:12px 24px;border-radius:12px;background:linear-gradient(135deg,#059669,#10b981);border:none;color:#fff;font-size:0.95rem;font-weight:700;cursor:pointer;font-family:inherit;">
          Получить бесплатно
        </button>
      </div>

      <!-- Админка — только для админов, ненавязчиво -->
      <div id="adminLinkWrap" style="display:none;margin-top:var(--spacing-lg);text-align:center">
        <button type="button" id="adminLinkBtn" onclick="goToPage('adminPage')" style="background:none;border:none;color:rgba(var(--primary-rgb),0.35);font-size:0.72rem;cursor:pointer;font-family:inherit;min-height:unset;box-shadow:none;animation:none;padding:6px 12px;margin:0;font-weight:400;letter-spacing:0.03em">Админка</button>
      </div>

      <!-- Профиль, Лаборатория, Помощь — без переносов, стили в CSS -->
      <nav class="home-nav">
        <button type="button" class="home-nav-link" onclick="goToSoulChat()">Soul Chat</button>
        <button type="button" id="goHeroesBtn" class="home-nav-link" onclick="goToHeroesFrom('homePage')">Лаборатория</button>
        <button type="button" id="goHelpBtn" class="home-nav-link" onclick="goToHelpFrom('homePage')">Помощь</button>
      </nav>

      </div><!-- /нижняя обёртка -->

      <footer>
        <p>YupSoul • 2026 • v1.2.77</p>
      </footer>
    </div>

    <!-- Страница помощи и поддержки -->
    <div class="page" id="helpPage">
      <div class="help-header page-header">
        <div class="help-back-row">
          <button type="button" class="help-back-btn" onclick="goBack()" aria-label="Назад">←</button>
        </div>
        <div class="help-title-wrap">
          <div id="helpPageTitle" class="help-title">Помощь и поддержка</div>
          <div id="helpPageSubtitle" class="help-subtitle">Всё о YupSoul — просто и по делу</div>
        </div>
      </div>
      <div class="page-scroll" style="padding-top:12px">

        <!-- Что такое YupSoul -->
        <div class="help-section open">
          <button type="button" class="help-section-title" onclick="this.closest('.help-section').classList.toggle('open')">
            <span class="hst-icon"></span><span id="helpT1" style="flex:1">Что такое YupSoul</span><span class="hst-chevron">▼</span>
          </button>
          <div id="helpB1" class="help-section-body">
            <p>YupSoul создаёт <strong>персональную песню именно для тебя</strong> — на основе даты, времени и места рождения. Система анализирует твою личность и пишет песню о твоих реальных качествах, пути и силе.</p>
            <p>Это не шаблон и не случайный текст — каждая песня уникальна и принадлежит только тебе.</p>
          </div>
        </div>

        <!-- Что можно создать -->
        <div class="help-section">
          <button type="button" class="help-section-title" onclick="this.closest('.help-section').classList.toggle('open')">
            <span class="hst-icon"></span><span id="helpT2" style="flex:1">Что можно создать</span><span class="hst-chevron">▼</span>
          </button>
          <div id="helpB2" class="help-section-body">
            <ul>
              <li><strong>Песня о себе</strong> — твой личный звуковой портрет: кто ты, твоя сила и внутренний путь</li>
              <li><strong>Песня для пары</strong> — для двоих (влюблённых, друзей, подруг). Анализирует обе карты и отражает союз</li>
              <li><strong>Энергия дня</strong> — песня под конкретную дату и место. Какие возможности открываются прямо сейчас</li>
            </ul>
            <p>Также есть <strong>быстрые запросы</strong> — готовые идеи: песня силы, поздравление с днём рождения, медитативная, про отпускание прошлого и другие.</p>
          </div>
        </div>

        <!-- Сколько ждать -->
        <div class="help-section">
          <button type="button" class="help-section-title" onclick="this.closest('.help-section').classList.toggle('open')">
            <span class="hst-icon">⏱</span><span id="helpT3" style="flex:1">Сколько ждать песню</span><span class="hst-chevron">▼</span>
          </button>
          <div id="helpB3" class="help-section-body">
            <p>Обычно <strong>5–15 минут</strong>. Бот пришлёт уведомление в чат, как только песня будет готова.</p>
            <p>Можно закрыть приложение — результат придёт сам, ты ничего не потеряешь.</p>
          </div>
        </div>

        <!-- Не знаю время рождения -->
        <div class="help-section">
          <button type="button" class="help-section-title" onclick="this.closest('.help-section').classList.toggle('open')">
            <span class="hst-icon">🕐</span><span id="helpT4" style="flex:1">Не знаю точное время рождения</span><span class="hst-chevron">▼</span>
          </button>
          <div id="helpB4" class="help-section-body">
            <p>Не страшно. Отметь <strong>«Время неизвестно»</strong> — система создаст полноценную песню на основе остальных данных.</p>
          </div>
        </div>

        <!-- Бесплатные генерации -->
        <div class="help-section">
          <button type="button" class="help-section-title" onclick="this.closest('.help-section').classList.toggle('open')">
            <span class="hst-icon"></span><span id="helpT5" style="flex:1">Бесплатные генерации</span><span class="hst-chevron">▼</span>
          </button>
          <div id="helpB5" class="help-section-body">
            <p><strong>Первая генерация — бесплатно.</strong></p>
            <p>Получить ещё бесплатные можно через реферальную программу: поделись своей ссылкой. Когда 5 приглашённых тобой друзей создадут первую песню — тебе автоматически начислится 1 бесплатная генерация.</p>
            <p>Реферальная ссылка — в разделе «Профиль», блок «Пригласи друга».</p>
          </div>
        </div>

        <!-- Оплата -->
        <div class="help-section">
          <button type="button" class="help-section-title" onclick="this.closest('.help-section').classList.toggle('open')">
            <span class="hst-icon"></span><span id="helpT6" style="flex:1">Оплата и промокоды</span><span class="hst-chevron">▼</span>
          </button>
          <div id="helpB6" class="help-section-body">
            <p>Дополнительные генерации оплачиваются по тарифу. Способы оплаты отображаются на экране при оформлении заявки.</p>
            <p>Если у тебя есть <strong>промокод</strong> — введи его на экране оплаты. Промокоды чувствительны к регистру, вводи точно как написано.</p>
          </div>
        </div>

        <!-- Проблемы и ошибки -->
        <div class="help-section">
          <button type="button" class="help-section-title" onclick="this.closest('.help-section').classList.toggle('open')">
            <span class="hst-icon">⚠️</span><span id="helpT7" style="flex:1">Что-то пошло не так</span><span class="hst-chevron">▼</span>
          </button>
          <div id="helpB7" class="help-section-body">
            <p><strong>Приложение закрылось или показало ошибку</strong> — попробуй открыть бота заново. Незавершённые заявки восстанавливаются автоматически.</p>
            <p><strong>Оплатил, но песни нет</strong> — подожди 15–20 минут (песня может ещё генерироваться). Если результата нет — напиши боту в чат: «песня не пришла» — он попробует отправить повторно. Повторную попытку можно делать раз в 10 минут. Действует в течение 30 дней после заказа. Или напиши в поддержку.</p>
            <p><strong>Промокод не принимается</strong> — проверь регистр букв. Если всё верно — напиши нам с указанием кода.</p>
          </div>
        </div>

        <!-- Кнопка поддержки -->
        <button type="button" class="help-support-btn" id="helpSupportBtn">Написать в поддержку</button>

      </div>
    </div>

    <!-- Страница «Профиль» -->
    <div class="page" id="profilePage">
      <!-- Шапка: Назад, заголовок «Профиль», справа — Помощь (иконка ?) -->
      <div class="profile-header">
        <button type="button" class="profile-back-btn header-back-btn btn-nav" onclick="goBack()" aria-label="Назад">←</button>
        <div id="profilePageTitle" class="profile-header-title">Профиль</div>
        <button type="button" class="header-menu-btn btn-info" onclick="goToHelpFrom('profilePage')" aria-label="Помощь" title="Помощь">?</button>
      </div>

      <div class="profile-scroll page-scroll">
        <!-- Ошибка загрузки профиля / подписки -->
        <div id="profileLoadErrorWrap" style="display:none;margin-bottom:16px;padding:14px 16px;background:rgba(var(--secondary-rgb),0.08);border:1px solid rgba(var(--secondary-rgb),0.25);border-radius:14px;">
          <div id="profileLoadErrorText" style="font-size:0.88rem;color:rgba(255,255,255,0.75);line-height:1.5;margin-bottom:12px;">Не удалось загрузить подписку. Проверьте интернет.</div>
          <button type="button" id="profileLoadRetryBtn" style="width:100%;padding:10px 16px;border-radius:12px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.9);font-size:0.88rem;font-weight:600;cursor:pointer;font-family:inherit;">Повторить</button>
        </div>
        <!-- Идентификация: аватар + имя + план -->
        <div class="profile-identity">
          <div class="profile-avatar-wrap" id="profileAvatarWrap" title="Изменить фото" role="button" aria-label="Изменить фото" tabindex="0">
            <div id="profileAvatar" class="profile-avatar">
              <span id="profileAvatarInitial"></span>
            </div>
            <div class="profile-avatar-edit">✎</div>
            <div class="profile-avatar-spinner" id="profileAvatarSpinner">…</div>
          </div>
          <!-- Скрытый input для выбора фото -->
          <input type="file" id="avatarFileInput" accept="image/*" style="display:none">
          <div id="profileName" class="profile-name">Загрузка…</div>
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:center;">
            <div id="profilePlanBadge" class="profile-plan-badge">✦ YupSoul Free</div>
          </div>
        </div>

        <!-- Баланс генераций -->
        <div class="profile-balance-card">
          <div class="profile-balance-left">
            <div id="profileBalanceLabel" class="profile-balance-label">Бесплатных генераций</div>
            <div id="profileCreditsCount" class="profile-balance-value">—</div>
            <div id="profileBalanceHintText" class="profile-balance-hint">Приглашай друзей — получай треки в подарок</div>
            <div id="profileRenewalDate" class="profile-balance-hint" style="display:none;color:rgba(var(--primary-rgb),0.75);margin-top:4px;font-weight:600;"></div>
          </div>
          <div class="profile-balance-icon"><img src="assets/icons/music.png" style="width:32px;height:32px;object-fit:contain;display:block;opacity:0.85;" alt="" loading="lazy"></div>
        </div>

        <!-- Мои данные -->
        <div id="profileSectionMyData" class="profile-section-title">Мои данные</div>
        <div id="profileDataCard">
          <div class="pfa-info">
            <svg class="pfa-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="2"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <span id="profileDataName" class="pfa-name">—</span>
            <span id="profileDataSep" class="pfa-sep" style="display:none;">·</span>
            <span id="profileDataDate" class="pfa-date"></span>
            <span id="profileDataCitySep" class="pfa-sep" style="display:none;">·</span>
            <span id="profileDataCity" class="pfa-date" style="color:rgba(255,255,255,0.35);"></span>
          </div>
          <button type="button" id="profileEditBtn" onclick="goToPage('formPage')">Изменить →</button>
        </div>

        <!-- Тарифы -->
        <div id="profileSectionPlans" class="profile-section-title">Тарифы</div>
        <div class="profile-plans-grid">
          <!-- Free -->
          <div class="profile-plan-card current" id="planCardFree">
            <div id="planFreeBadge" class="ppc-badge">Текущий</div>
            <div class="ppc-name">Free</div>
            <div class="ppc-features">
              <div class="ppc-feature"><span id="planFreeF1">✦ 1 трек в подарок</span> <i class="ppc-info" data-tip="Первая песня создаётся бесплатно — без условий и скрытых платежей.">i</i></div>
              <div class="ppc-feature"><span id="planFreeF2">✦ Все форматы</span> <i class="ppc-info" data-tip="Доступны все три формата: Для себя, Для двоих и Энергия дня.">i</i></div>
            </div>
            <div id="planFreePrice" class="ppc-price">Уже у тебя</div>
          </div>
          <!-- Soul Basic -->
          <div class="profile-plan-card" id="planCardBasic">
            <div class="ppc-badge" style="visibility:hidden">—</div>
            <div class="ppc-name">Basic</div>
            <div class="ppc-features">
              <div class="ppc-feature"><span id="planBasicF1">✦ 5 треков/мес</span> <i class="ppc-info" data-tip="5 новых персональных песен каждый месяц. Разовая цена — $5.99/трек. По подписке выходит $3/трек. Экономия 50%.">i</i></div>
              <div class="ppc-feature"><span id="planBasicF2">✦ Soul Chat (до 50 сообщ/мес)</span> <i class="ppc-info" data-tip="Soul Chat — живой разговор с твоей душой на основе твоих личных данных. Задавай вопросы о себе, своём характере, пути и предназначении. До 50 сообщений в месяц.">i</i></div>
              <div class="ppc-feature"><span id="planBasicF3">✦ История заказов</span> <i class="ppc-info" data-tip="Все твои песни сохраняются в истории. Можно вернуться, переслушать и поделиться в любое время.">i</i></div>
            </div>
            <div class="ppc-price-wrap">
              <div class="ppc-price">$14.99/мес</div>
              <div id="planBasicSave" class="ppc-save">−50% vs разовых</div>
            </div>
            <button class="ppc-btn" id="planBtnBasic">Оформить</button>
            <button class="ppc-details-btn" id="planDetailsBasic" onclick="openPlanDetails('basic')">Подробнее</button>
          </div>
          <!-- Soul Plus -->
          <div class="profile-plan-card popular" id="planCardPlus">
            <div id="planPlusBadge" class="ppc-badge hot">✦ Популярный</div>
            <div class="ppc-name">Plus</div>
            <div class="ppc-features">
              <div class="ppc-feature"><span id="planPlusF1">✦ 10 треков/мес</span> <i class="ppc-info" data-tip="10 персональных песен в месяц. Разовая цена — $5.99/трек. По подписке выходит $2.5/трек. Экономия 58%.">i</i></div>
              <div class="ppc-feature"><span id="planPlusF2">✦ Soul Chat без лимита</span> <i class="ppc-info" data-tip="Soul Chat — живой разговор с твоей душой. В Plus — без ограничений по количеству сессий. Общайся когда угодно.">i</i></div>
              <div class="ppc-feature"><span id="planPlusF3">✦ Приоритет обработки</span> <i class="ppc-info" data-tip="Твои заявки идут в первую очередь — песня готова быстрее, чем у других пользователей.">i</i></div>
              <div class="ppc-feature"><span id="planPlusF4">✦ Полная история треков</span> <i class="ppc-info" data-tip="Все твои песни сохраняются с текстами, аудио и датами создания — всегда доступны в профиле.">i</i></div>
              <div class="ppc-feature"><span id="planPlusF5">✦ Выбор стилей музыки</span> <i class="ppc-info" data-tip="Укажи желаемый жанр или стиль (поп, соул, джаз, электронная и т.д.) — песня будет создана в этом звучании.">i</i></div>
            </div>
            <div class="ppc-price-wrap">
              <div class="ppc-price">$24.99/мес</div>
              <div id="planPlusSave" class="ppc-save">−58% vs разовых</div>
            </div>
            <button class="ppc-btn popular-btn" id="planBtnPlus">Оформить</button>
            <button class="ppc-details-btn" id="planDetailsPlus" onclick="openPlanDetails('plus')">Подробнее</button>
          </div>
          <!-- Мастер — Лаборатория -->
          <div class="profile-plan-card master" id="planCardMaster">
            <div id="planMasterBadge" class="ppc-badge master-badge">Мастер</div>
            <div id="planMasterName" class="ppc-name">Лаборатория</div>
            <div class="ppc-features">
              <div class="ppc-feature"><span id="planMasterF1">✦ 30 треков/мес</span> <i class="ppc-info" data-tip="30 персональных песен каждый месяц — для себя и для близких. Максимальный объём.">i</i></div>
              <div class="ppc-feature"><span id="planMasterF2">✦ Картотека людей</span> <i class="ppc-info" data-tip="Добавляй близких в Лабораторию и создавай для них песни в один тап. Данные сохраняются — вводить повторно не нужно.">i</i></div>
              <div class="ppc-feature"><span id="planMasterF3">✦ История генераций</span> <i class="ppc-info" data-tip="Полная история всех созданных песен с текстами, аудио и датами — для тебя и для каждого из твоих людей.">i</i></div>
              <div class="ppc-feature"><span id="planMasterF4">✦ Soul Chat без лимита</span> <i class="ppc-info" data-tip="Неограниченный доступ к Soul Chat — разговаривай с душой столько, сколько нужно.">i</i></div>
              <div class="ppc-feature"><span id="planMasterF5">✦ Выбор стилей музыки</span> <i class="ppc-info" data-tip="Укажи желаемый жанр или стиль (поп, соул, джаз, электронная и т.д.) — песня будет создана в этом звучании.">i</i></div>
            </div>
            <div class="ppc-price-wrap">
              <div class="ppc-price" id="masterPriceEl">$39.99/мес</div>
              <div id="planMasterSave" class="ppc-save">−83% vs разовых</div>
            </div>
            <button class="ppc-btn master-btn" id="planBtnMaster">Открыть Лабораторию</button>
            <button class="ppc-details-btn" id="planDetailsMaster" onclick="openPlanDetails('master')">Подробнее</button>
          </div>
        </div>

        <!-- Разовые треки -->
        <div id="profileSectionTracks" class="profile-section-title" style="margin-top:24px">Разовые треки</div>
        <div class="profile-track-list">
          <div class="profile-track-item" onclick="goToPage('formPage');setTimeout(function(){var b=document.querySelector('.mode-btn[data-mode=\'single\']');if(b){b.click();}},100)">
            <div>
              <div id="ptiSingleName" class="pti-name">Для себя</div>
              <div id="ptiSingleDesc" class="pti-desc">Твоя личность в звуке</div>
            </div>
            <div class="pti-right"><div class="pti-price">$5.99</div><div class="pti-arrow">›</div></div>
          </div>
          <div class="profile-track-item" onclick="goToPage('formPage');setTimeout(function(){var b=document.querySelector('.mode-btn[data-mode=\'couple\']');if(b){b.click();}},100)">
            <div>
              <div id="ptiCoupleName" class="pti-name">Для двоих</div>
              <div id="ptiCoupleDesc" class="pti-desc">Ваша связь и резонанс</div>
            </div>
            <div class="pti-right"><div class="pti-price">$8.99</div><div class="pti-arrow">›</div></div>
          </div>
          <div class="profile-track-item" onclick="goToPage('formPage');setTimeout(function(){var b=document.querySelector('.mode-btn[data-mode=\'transit\']');if(b){b.click();}},100)">
            <div>
              <div id="ptiTransitName" class="pti-name">Энергия дня</div>
              <div id="ptiTransitDesc" class="pti-desc">Песня под сегодняшний день</div>
            </div>
            <div class="pti-right"><div class="pti-price">$6.99</div><div class="pti-arrow">›</div></div>
          </div>
        </div>

        <!-- Реферальная программа -->
        <div class="profile-referral-section">
          <div class="profile-section-title">
            <div style="width:18px;height:18px;border-radius:5px;overflow:hidden;background:#fdf8ec;box-shadow:0 1px 4px rgba(0,0,0,0.2);flex-shrink:0;display:inline-flex;align-items:center;justify-content:center;"><img src="assets/icons/forward.png" style="width:100%;height:100%;object-fit:contain;display:block;padding:2px;box-sizing:border-box;" alt="" loading="lazy"></div>
            <span id="profileInviteFriendTitle">Пригласи друга</span>
          </div>
          <div id="profileRefTagline" class="profile-ref-tagline">Приглашай друзей — получай бесплатные песни по нарастающей</div>
          <div class="profile-ref-milestones">
            <div class="ref-milestone" data-n="1"><span class="ref-mi-num">1</span><span class="ref-mi-label">друг</span></div>
            <div class="ref-milestone-arrow">→</div>
            <div class="ref-milestone" data-n="3"><span class="ref-mi-num">3</span><span class="ref-mi-label">друга</span></div>
            <div class="ref-milestone-arrow">→</div>
            <div class="ref-milestone" data-n="5"><span class="ref-mi-num">5</span><span class="ref-mi-label">друзей</span></div>
            <div class="ref-milestone-arrow">→</div>
            <div class="ref-milestone" data-n="10"><span class="ref-mi-num">10</span><span class="ref-mi-label">друзей</span></div>
            <div class="ref-milestone-arrow">→</div>
            <div class="ref-milestone" data-n="15"><span class="ref-mi-num">15</span><span class="ref-mi-label">друзей</span></div>
          </div>
          <div class="profile-ref-link-row">
            <input id="profileRefLinkInput" readonly placeholder="Загрузка…">
          </div>
          <button type="button" id="profileRefShareBtn" class="profile-ref-share-btn">Поделиться ссылкой</button>
          <div class="profile-ref-stats">
            <span><strong id="profileRefInvited">0</strong><span id="profileRefInvitedLabel" class="profile-ref-stats-label">Приглашено</span></span>
            <span><strong id="profileRefRewarded">0</strong><span id="profileRefActivatedLabel" class="profile-ref-stats-label">Активировано</span></span>
          </div>
          <div id="profileRefNextHint" style="font-size:0.72rem;color:rgba(var(--primary-rgb),0.6);text-align:center;margin-top:6px;"></div>
        </div>

        <!-- Действия -->
        <button type="button" id="profileCreateSongBtn" class="profile-create-btn">
          Создать свою песню
        </button>
        <button type="button" id="profileHelpBtn" class="secondary" onclick="goToHelpFrom('profilePage')" style="width:100%;margin-bottom:16px;background:transparent;border-color:rgba(255,255,255,0.1);color:rgba(255,255,255,0.4);font-size:0.82rem;">Помощь и поддержка</button>
      </div>
    </div>

    <!-- Страница «Мои герои» (тариф Мастер) -->
    <div class="page" id="heroesPage">
      <!-- Шапка страницы -->
      <div class="page-header" style="padding:max(20px,calc(env(safe-area-inset-top)+12px)) 18px 12px; display:flex; align-items:center; gap:12px;">
        <button type="button" id="heroesBackBtn" style="background:none;border:none;color:rgba(255,255,255,0.5);font-size:1.4rem;cursor:pointer;padding:4px 8px;min-height:unset;width:auto;box-shadow:none;animation:none;margin:0;line-height:1">←</button>
        <div style="flex:1">
          <div id="heroesPageTitle" style="font-size:1.15rem;font-weight:700;color:#fff;line-height:1.2">Лаборатория</div>
          <div style="font-size:0.75rem;color:rgba(var(--primary-rgb),0.65);margin-top:2px" id="masterAccessBadge"></div>
        </div>
      </div>

      <!-- Paywall (показывается если нет доступа) -->
      <div id="masterPaywall" class="page-scroll" style="display:none; padding-top:28px;">
        <div style="text-align:center; margin-bottom:20px">
          <div style="font-size:2rem;margin-bottom:12px;color:var(--primary-color);letter-spacing:0.1em">✦</div>
          <div id="heroesPromoHeading" style="font-size:1.2rem;font-weight:700;color:var(--primary-color);margin-bottom:8px">Личный кабинет для мастеров</div>
          <div id="heroesPromoDesc" style="font-size:0.85rem;color:rgba(255,255,255,0.5);line-height:1.6">Добавляй людей один раз — и генерируй для них<br>песни в один тап. Полная история с текстами.</div>
        </div>
        <div style="background:rgba(var(--primary-rgb),0.06);border:1px solid rgba(var(--primary-rgb),0.18);border-radius:14px;padding:16px;margin-bottom:22px;font-size:0.82rem;color:rgba(255,255,255,0.55);line-height:1.65">
          <div id="heroesPromoFeaturesTitle" style="color:var(--primary-color);font-weight:600;margin-bottom:8px">Что входит в тариф:</div>
          <div id="heroesF1">✦ Неограниченное число героев</div>
          <div id="heroesF2">✦ Быстрый запуск соло и совместных песен</div>
          <div id="heroesF3">✦ Предпочтения по стилю музыки</div>
          <div id="heroesF4">✦ Полная история генераций с текстами и анализом</div>
          <div id="heroesF5">✦ Аудио прямо из карточки героя</div>
        </div>
        <button type="button" id="masterTrialBtn" style="width:100%;padding:13px 24px;border-radius:14px;background:linear-gradient(135deg,rgba(var(--primary-rgb),0.2),rgba(var(--primary-rgb),0.08));border:1px solid rgba(var(--primary-rgb),0.4);color:var(--primary-color);font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit;margin-bottom:12px;box-shadow:none;animation:none;letter-spacing:0;min-height:48px">1 день бесплатно — попробовать</button>
        <button type="button" id="masterSubBtn" onclick="showPlanConfirm('plan_master','Лаборатория')" style="width:100%;padding:14px 24px;border-radius:14px;background:linear-gradient(135deg,rgba(167,139,250,0.15),rgba(167,139,250,0.06));border:1.5px solid rgba(167,139,250,0.35);color:rgba(167,139,250,0.9);font-size:0.95rem;font-weight:700;cursor:pointer;font-family:inherit;box-shadow:none;animation:none;letter-spacing:0;min-height:48px">Оформить Лабораторию — $39.99/мес</button>
        <div id="heroesSubNote" style="font-size:0.7rem;color:rgba(255,255,255,0.22);text-align:center;margin-top:12px">30 треков в месяц · Оплата через HOT Pay</div>
      </div>

      <!-- Кабинет героев (показывается если есть доступ) -->
      <div id="masterCabinet" class="page-scroll" style="display:none;">
        <!-- Строка поиска + кнопка добавить -->
        <div style="display:flex;gap:10px;margin-bottom:16px">
          <input type="text" id="heroesSearch" placeholder="Поиск по имени…" style="flex:1;margin:0;padding:11px 14px;font-size:0.88rem">
          <button type="button" id="heroesSearchBtn" style="width:auto;padding:11px 14px;font-size:0.88rem;min-height:44px;box-shadow:none;animation:none;letter-spacing:0;background:rgba(var(--primary-rgb),0.12);border-color:rgba(var(--primary-rgb),0.3);color:var(--primary-color);flex-shrink:0">Найти</button>
        </div>
        <div id="heroesList"></div>
        <button type="button" id="addHeroBtn" style="margin-top:12px;width:100%;background:rgba(var(--primary-rgb),0.08);border:1px dashed rgba(var(--primary-rgb),0.35);color:rgba(var(--primary-rgb),0.8);font-size:0.9rem;padding:13px 24px;border-radius:14px;box-shadow:none;animation:none;letter-spacing:0;min-height:48px">+ Добавить героя</button>
      </div>

      <!-- Форма добавления/редактирования героя -->
      <div id="heroFormWrap" style="display:none; padding:16px 16px 90px; overflow-y:auto; flex:1">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:18px">
          <button type="button" id="heroFormCancel" style="background:none;border:none;color:rgba(255,255,255,0.4);font-size:1.3rem;cursor:pointer;padding:4px;min-height:unset;width:auto;box-shadow:none;animation:none;margin:0">←</button>
          <div style="font-size:1rem;font-weight:700;color:#fff" id="heroFormTitle">Добавить героя</div>
        </div>
        <div class="field"><label for="heroName">Имя *</label><input type="text" id="heroName" placeholder="Как зовут человека"></div>
        <div class="field"><label id="heroRelLabel" for="heroRelationship">Кто для тебя</label>
          <select id="heroRelationship">
            <option value="">— выбери —</option>
            <option value="мать">Мать</option>
            <option value="отец">Отец</option>
            <option value="дочь">Дочь</option>
            <option value="сын">Сын</option>
            <option value="сестра">Сестра</option>
            <option value="брат">Брат</option>
            <option value="бабушка">Бабушка</option>
            <option value="дедушка">Дедушка</option>
            <option value="муж">Муж</option>
            <option value="жена">Жена</option>
            <option value="любимый человек">Любимый человек</option>
            <option value="друг">Друг</option>
            <option value="подруга">Подруга</option>
            <option value="коллега">Коллега</option>
            <option value="наставник">Наставник</option>
            <option value="другое">Другое</option>
          </select>
        </div>
        <div class="field">
          <label for="heroBirthdate" data-icon="📅">Дата рождения</label>
          <div id="heroBirthdateWrap" class="birthdate-wrap">
            <div class="date-group" role="group" aria-label="Дата рождения">
              <select id="heroBirthdateDay" class="date-group-day" aria-label="День"><option value="">День</option></select>
              <select id="heroBirthdateMonth" class="date-group-month" aria-label="Месяц"><option value="">Месяц</option></select>
              <select id="heroBirthdateYear" class="date-group-year" aria-label="Год"><option value="">Год</option></select>
            </div>
            <input type="date" id="heroBirthdate" tabindex="-1">
          </div>
          <div id="heroBirthdateHint" style="font-size:0.85rem;color:var(--tg-theme-hint-color,#9ca3af);margin-top:6px;">Выбери день, месяц и год</div>
        </div>
        <div class="field">
          <label for="heroBirthplace" data-icon="📍">Место рождения</label>
          <div id="heroBirthplaceWrap" class="birthplace-wrap">
            <input type="text" id="heroBirthplace" placeholder="Москва, Лондон, Нью-Йорк…" autocomplete="off">
            <span id="heroBirthplaceCheck" class="birthplace-check" aria-hidden="true"></span>
            <ul id="heroBirthplaceSuggestions" class="birthplace-suggestions" aria-hidden="true" aria-live="polite"></ul>
          </div>
          <div id="heroBirthplaceHint" class="birthplace-hint" style="display:block;font-size:0.9rem;color:rgba(var(--primary-rgb),0.85);margin-top:8px;line-height:1.5;">Начни вводить город и выбери из выпавшего списка.</div>
        </div>
        <div class="field">
          <label id="heroTimeBirthLabel" for="heroBirthtime" data-icon="🕐">Время рождения</label>
          <div class="time-group" role="group" aria-label="Время рождения">
            <input type="time" id="heroBirthtime" class="time-group-input">
            <div class="checkbox time-group-checkbox">
              <input type="checkbox" id="heroBirthtimeUnknown">
              <label for="heroBirthtimeUnknown">Не знаю точное время</label>
            </div>
          </div>
        </div>
        <div class="field"><label for="heroGender">Пол</label>
          <select id="heroGender">
            <option value="">Выбери</option>
            <option value="female">Женский</option>
            <option value="male">Мужской</option>
          </select>
        </div>
        <div class="field"><label id="heroStyleLabel" for="heroStyle">Любимые стили музыки</label><input type="text" id="heroStyle" placeholder="поп, джаз, электронная…"></div>
        <div class="field"><label for="heroNotes">Заметки</label><textarea id="heroNotes" placeholder="Что важно помнить об этом человеке" rows="2"></textarea></div>
        <div style="display:flex;gap:10px;margin-top:6px">
          <button type="button" id="heroFormSave" style="flex:2">Сохранить</button>
        </div>
      </div>
    </div>
    
    <!-- Страница формы: панель вырезана — навигация через Telegram (назад) и нижнее меню (Профиль) -->
    <div class="page" id="formPage">
      <div class="page-scroll">
      <!-- Выбор героя для мастер-пользователей (скрыт у обычных) -->
      <div id="forWhoWrap" style="display:none; padding:0; margin-bottom:16px">
        <div class="field" style="margin-bottom:0">
          <label id="forWhoLabel" for="forWho" style="font-size:0.82rem">Для кого генерируем?</label>
          <select id="forWho">
            <option value="">Для себя</option>
          </select>
        </div>
      </div>
      
      <div class="section">
        <div class="step-panel" data-step="1">
          <div class="mode-selector">
            <h3>
              <div style="width:28px;height:28px;border-radius:8px;overflow:hidden;flex-shrink:0;box-shadow:0 2px 6px rgba(0,0,0,0.25);"><img src="assets/icons/writing.png" alt="" style="width:100%;height:100%;object-fit:contain;display:block;" loading="lazy"></div>
              Формат песни
            </h3>
            <p class="mode-subtitle">Для кого создаём?</p>
            <div class="mode-buttons">
              <button type="button" class="mode-btn btn-magic active" data-mode="single">
                <span class="mode-label" data-i18n="modeSingle">Обо мне</span>
                <span class="mode-desc" data-i18n="modeSingleDesc">Песня по твоей дате рождения</span>
              </button>
              <button type="button" class="mode-btn btn-magic" data-mode="couple">
                <span class="mode-label" data-i18n="modeCouple">Про двоих</span>
                <span class="mode-desc" data-i18n="modeCoupleDesc">Песня для двух людей</span>
              </button>
              <button type="button" class="mode-btn btn-magic" data-mode="transit">
                <span class="mode-label" data-i18n="modeTransit">Энергия<br>момента</span>
                <span class="mode-desc" data-i18n="modeTransitDesc">Песня о сегодняшнем дне</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Аккордеон профиля для возвращающегося пользователя -->
        <div id="profileAccordion" style="display:none;margin-bottom:12px;">
          <div class="pfa-header" onclick="toggleProfileAccordion()">
            <div class="pfa-info">
              <svg class="pfa-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="2"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
              <span id="pfaName" class="pfa-name"></span>
              <span class="pfa-sep" id="pfaSep" style="display:none">·</span>
              <span id="pfaDate" class="pfa-date"></span>
            </div>
            <div class="pfa-chevron" id="pfaChevron">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
          </div>
        </div>

        <div id="formFieldsWrap">
        <div class="step-panel" data-step="2">
        <div class="field">
          <label id="nameLabel" for="name" data-icon="">Имя</label>
            <input type="text" id="name" placeholder="Как тебя зовут?" required aria-label="Имя">
        </div>
        
        <div class="field">
          <label id="birthdateLbl" for="birthdate" data-icon="📅">Дата рождения</label>
          <div id="birthdateWrap" class="birthdate-wrap">
            <div class="date-group" role="group" aria-label="Дата рождения">
              <select id="birthdateDay" class="date-group-day" aria-label="День"><option value="">День</option></select>
              <select id="birthdateMonth" class="date-group-month" aria-label="Месяц"><option value="">Месяц</option></select>
              <select id="birthdateYear" class="date-group-year" aria-label="Год"><option value="">Год</option></select>
            </div>
            <input type="date" id="birthdate" required aria-label="Дата рождения" tabindex="-1">
            <span id="birthdateCheck" class="birthdate-check" aria-hidden="true"></span>
          </div>
        </div>
        
        <div class="field">
          <label id="birthplaceLbl" for="birthplace" data-icon="📍">Место рождения</label>
          <div id="birthplaceWrap" class="birthplace-wrap">
              <input type="text" id="birthplace" placeholder="Москва, Лондон, Нью-Йорк..." required autocomplete="off" aria-label="Локация рождения">
              <span id="birthplaceCheck" class="birthplace-check" aria-hidden="true"></span>
            <ul id="birthplaceSuggestions" class="birthplace-suggestions" aria-hidden="true" aria-live="polite"></ul>
          </div>
          <div id="birthplaceHint" class="birthplace-hint" style="display:none;font-size:0.9rem;color:rgba(var(--primary-rgb),0.85);margin-top:8px;line-height:1.5;">Начни вводить город и выбери из выпавшего списка.</div>
        </div>
        
        <div class="field">
          <label id="birthtimeLbl" data-icon="🕐">Время рождения</label>
          <div class="time-group" role="group" aria-label="Время рождения">
            <input type="time" id="birthtime" required aria-label="Время" class="time-group-input">
            <div class="checkbox time-group-checkbox">
              <input type="checkbox" id="unknown" aria-label="Не знаю точное время">
              <label for="unknown">Не знаю точное время</label>
            </div>
          </div>
        </div>
        
        <div class="field">
          <label for="gender" id="genderLabel">Пол</label>
          <select id="gender" required aria-label="Пол">
              <option value="">Выбери</option>
            <option value="male">Мужской</option>
            <option value="female">Женский</option>
          </select>
        </div>
        
        <div class="field">
            <select id="language" required aria-label="Язык песни и описания" title="На каком языке будет текст песни и расшифровка">
              <option value="">Язык песни</option>
            <option value="ru">Русский</option>
            <option value="en">English</option>
            <option value="de">Deutsch</option>
            <option value="fr">Français</option>
            <option value="uk">Українська</option>
          </select>
        </div>
        
        </div>
        </div><!-- /formFieldsWrap -->

        <!-- Аккордеон второго человека — отдельно, рядом с первым -->
        <div id="secondPersonAccordion" style="display:none;margin-top:8px;">
          <div class="pfa-header" onclick="toggleSecondPersonAccordion()">
            <div class="pfa-info">
              <svg class="pfa-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="2"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
              <span id="p2AccName" class="pfa-name">Данные второго человека</span>
              <span class="pfa-sep" id="p2AccSep" style="display:none">·</span>
              <span id="p2AccDate" class="pfa-date"></span>
            </div>
            <div class="pfa-chevron" id="p2AccChevron">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
          </div>
          <div id="secondPersonFormWrap">
            <div id="secondPersonForm" style="padding-top:8px;">
              <div class="field">
                <label for="name2" data-icon="">Имя</label>
                <input type="text" id="name2" placeholder="Имя второго человека" maxlength="50">
              </div>
              <div class="field">
                <label for="birthdate2" data-icon="📅">Дата рождения</label>
                <div id="birthdate2Wrap" class="birthdate-wrap">
                  <div class="date-group" role="group" aria-label="Дата рождения второго">
                    <select id="birthdate2Day" class="date-group-day" aria-label="День"><option value="">День</option></select>
                    <select id="birthdate2Month" class="date-group-month" aria-label="Месяц"><option value="">Месяц</option></select>
                    <select id="birthdate2Year" class="date-group-year" aria-label="Год"><option value="">Год</option></select>
                  </div>
                  <input type="date" id="birthdate2" tabindex="-1">
                </div>
              </div>
              <div class="field">
                <label for="birthplace2" data-icon="📍">Место рождения</label>
                <div id="birthplace2Wrap" class="birthplace-wrap">
                  <input type="text" id="birthplace2" placeholder="Москва, Лондон, Нью-Йорк..." maxlength="100" autocomplete="off" aria-label="Локация рождения второго">
                  <span id="birthplace2Check" class="birthplace-check" aria-hidden="true"></span>
                  <ul id="birthplaceSuggestions2" class="birthplace-suggestions" aria-hidden="true" aria-live="polite"></ul>
                </div>
                <div id="birthplace2Hint" class="birthplace-hint" style="display:none;font-size:0.9rem;color:rgba(var(--primary-rgb),0.85);margin-top:8px;line-height:1.5;">Начни вводить город и выбери из выпавшего списка.</div>
              </div>
              <div class="field">
                <label data-icon="🕐">Время рождения</label>
                <div class="time-group" role="group">
                  <input type="time" id="birthtime2" aria-label="Время" class="time-group-input">
                  <div class="checkbox time-group-checkbox">
                    <input type="checkbox" id="unknown2" aria-label="Не знаю точное время">
                    <label for="unknown2">Не знаю точное время</label>
                  </div>
                </div>
              </div>
              <div class="field">
                <label for="gender2" data-icon="⚧">Пол</label>
                <select id="gender2">
                  <option value="">Выбери</option>
                  <option value="female">Женский</option>
                  <option value="male">Мужской</option>
                </select>
              </div>
              <input type="hidden" id="person2Relationship">
            </div>
          </div>
        </div>

        <!-- Аккордеон энергии момента — отдельно, как второй человек -->
        <div id="transitAccordion" style="display:none;margin-top:8px;">
          <div class="pfa-header" onclick="toggleTransitAccordion()">
            <div class="pfa-info">
              <svg class="pfa-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
              <span id="transitAccName" class="pfa-name">Энергия момента</span>
              <span class="pfa-sep" id="transitAccSep" style="display:none">·</span>
              <span id="transitAccDate" class="pfa-date"></span>
            </div>
            <div class="pfa-chevron" id="transitAccChevron">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
          </div>
          <div id="transitFormWrap">
            <div id="transitForm" style="padding-top:8px;">
              <div class="field">
                <label for="transitDate" data-icon="📅">Дата события</label>
                <input type="date" id="transitDate" min="2024-01-01" max="2030-12-31" placeholder="Дата события">
              </div>
              <div class="field">
                <label for="transitTime" data-icon="🕐">Время события</label>
                <input type="time" id="transitTime" placeholder="Время события">
              </div>
              <div class="field form-group location-input-wrapper">
                <label for="transitLocation" data-icon="📍">Город для энергии момента</label>
                <input type="text" id="transitLocation" class="location-input" placeholder="Москва, Лондон, Нью-Йорк..." maxlength="100" autocomplete="off">
                <div id="transitLocationSuggestions" class="location-suggestions" aria-live="polite"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="step-panel" data-step="3">
        <div class="field">
          <div class="request-label">Что будешь исследовать сегодня?</div>

          <!-- Блок ввода: textarea + нижняя полоска с быстрыми запросами -->
          <div class="request-input-box">
            <textarea id="request" class="request-textarea" placeholder="Напиши любой запрос" aria-label="Запрос" rows="4"></textarea>
            <div class="request-quick-bar">
              <button type="button" class="request-quick-toggle" id="quickPickerBtn" onclick="toggleQuickPicker(event)">
                <span id="quickPickerLabel">✦ Быстрые запросы</span>
                <svg id="quickPickerArrow" width="12" height="12" viewBox="0 0 24 24" fill="none" style="transition:transform .2s;flex-shrink:0;"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
              <div id="quickPickerSheet" class="request-quick-dropdown" style="display:none;">
                <button type="button" class="quick-item example-btn" data-text="Весёлая песня с самоиронией про мои слабости и привычки">Весёлая про слабости</button>
                <button type="button" class="quick-item example-btn" data-text="Юмор и лёгкость — добрый взгляд на себя">Юмор и лёгкость</button>
                <button type="button" class="quick-item example-btn" data-text="Режим юмор 100% — весёлая песня с максимальным юмором и лёгкостью">Режим: юмор 100%</button>
                <button type="button" class="quick-item example-btn" data-text="Трогательное поздравление с днём рождения — душевная песня-подарок">Трогательное поздравление</button>
                <button type="button" class="quick-item example-btn" data-text="Забавное поздравление с днём рождения — тепло и с улыбкой">Забавное поздравление</button>
                <button type="button" class="quick-item example-btn" data-text="Мощная песня о моей силе и преодолении трудностей">Сила и преодоление</button>
                <button type="button" class="quick-item example-btn" data-text="Уверенность, предназначение и опора на себя">Уверенность и путь</button>
                <button type="button" class="quick-item example-btn" data-text="Яркая самопрезентация — кто я и что несу в мир">Кто я и моя миссия</button>
                <button type="button" class="quick-item example-btn" data-text="Гармония в отношениях и любовь к себе">Гармония и любовь к себе</button>
                <button type="button" class="quick-item example-btn" data-text="Отпустить прошлое и открыть новые возможности">Отпустить прошлое</button>
                <button type="button" class="quick-item example-btn" data-text="Исцелить детские травмы и обрести свободу">Исцеление и свобода</button>
                <button type="button" class="quick-item example-btn" data-text="Медитативная песня для практики и тишины">Тишина и медитация</button>
              </div>
            </div>
          </div>
        </div>
        <!-- Стиль песни (для всех тарифов) -->
        <div class="field" style="margin-top:14px;">
          <label for="requestPreferredStyle" id="requestPreferredStyleLabel" style="font-size:0.82rem;color:rgba(255,255,255,0.5);">Стиль песни</label>
          <input type="text" id="requestPreferredStyle" placeholder="Стиль песни: поп, r&b, рэп, хип‑хоп, техно, house, ambient…" maxlength="120" autocomplete="off" style="margin-top:6px;font-size:0.9rem;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:#fff;width:100%;box-sizing:border-box;">
          <div class="quick-list" id="styleQuickList" style="margin-top:10px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.18);">
            <button type="button" class="quick-item example-btn style-quick" data-style="поп">Поп</button>
            <button type="button" class="quick-item example-btn style-quick" data-style="soul">Soul</button>
            <button type="button" class="quick-item example-btn style-quick" data-style="r&b">R&B</button>
            <button type="button" class="quick-item example-btn style-quick" data-style="рэп / hip‑hop">Рэп / hip‑hop</button>
            <button type="button" class="quick-item example-btn style-quick" data-style="электронная / techno / house">Электронная / techno / house</button>
            <button type="button" class="quick-item example-btn style-quick" data-style="ambient / медитативная">Ambient / медитативная</button>
            <button type="button" class="quick-item example-btn style-quick" data-style="акустика / piano / ballad">Акустика / piano / ballad</button>
          </div>
        </div>

        <p id="submitHint" style="display:none"></p>

        <!-- Кнопка отправки — sticky внизу, всегда доступна -->
        <div class="step-nav form-submit-sticky">
          <button id="stepNext" class="btn-pay">Отправить заявку</button>
        </div>
      </div>
      
      </div><!-- /page-scroll -->
    </div>
    </div><!-- /formPage -->
    
    <!-- paymentPage убран из .page-системы — заменён на #paymentOverlay ниже -->
    
    <!-- Страница загрузки -->
    <div class="page" id="loadingPage">
      <div class="loading">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingTitle">Заявка принята</div>
        <div id="loadingDesc" style="color:rgba(255,255,255,0.55);font-size:0.92rem;text-align:center;max-width:320px;line-height:1.7;margin-top:12px;">
          Песня создаётся. Придёт в чат с ботом.<br>Можно закрыть окно.
        </div>
        <div id="loadingCountdown" style="margin-top:20px;color:rgba(var(--primary-rgb),0.65);font-size:0.9rem;"></div>
      </div>
    </div>
    
    <!-- Страница успеха -->
    <div class="page" id="successPage">
      <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 28px calc(env(safe-area-inset-bottom)+24px);text-align:center;">
        <div style="font-size:3rem;margin-bottom:20px;">✉️</div>
        <div id="successTitle" style="font-size:1.45rem;font-weight:800;color:var(--primary-color);margin-bottom:14px;line-height:1.3;">Заявка принята!</div>
        <p id="successDesc" style="font-size:0.95rem;color:rgba(255,255,255,0.65);line-height:1.75;max-width:280px;margin:0 0 32px;">
          Твоя песня генерируется.<br>Как только будет готова — придёт в бот.<br>
          <span style="color:rgba(255,255,255,0.4);font-size:0.85rem;">Обычно 10–20 минут.</span>
        </p>
        <button id="openBotBtn" type="button" style="width:100%;max-width:320px;padding:14px 24px;border-radius:14px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));border:none;color:#fff;font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit;margin-bottom:12px;letter-spacing:0;">
          Перейти в бот
        </button>
        <p id="successHint" style="font-size:0.78rem;color:rgba(255,255,255,0.35);line-height:1.6;max-width:290px;margin:0 0 28px;">
          Не пришла через 20 мин? Напиши боту «песня не пришла».
        </p>
        <button class="secondary" id="newKeyBtn" style="width:100%;max-width:320px;margin-bottom:4px;">Создать ещё одну песню</button>
        <button type="button" id="successToProfileBtn" class="form-nav-link" onclick="goToProfileFrom('successPage')" style="background:none;border:none;color:rgba(255,255,255,0.25);font-size:0.78rem;cursor:pointer;font-family:inherit;padding:8px 0;width:100%;text-align:center;min-height:unset;box-shadow:none;">Перейти в профиль</button>
      </div>
    </div>

    <!-- ══════════════ SOUL CHAT PAGE ══════════════ -->
    <div class="page" id="soulChatPage">

      <!-- Шапка — показывается только в промо-режиме -->
      <div id="scHeader" class="profile-header">
        <button type="button" class="profile-back-btn header-back-btn btn-nav" onclick="goBack()" aria-label="Назад">←</button>
        <div class="profile-header-title">Soul Chat</div>
        <button type="button" class="header-menu-btn btn-info" onclick="goToHelpFrom('soulChatPage')" aria-label="Помощь"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="8" r="4" fill="currentColor" opacity="0.9"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity="0.9"/></svg></button>
      </div>

      <!-- Полноэкранная загрузка — по умолчанию скрыта; сразу показываем шапку и промо с «Проверяем доступ» -->
      <div id="scGlobalLoading" style="flex:1;display:none;align-items:center;justify-content:center;color:rgba(255,255,255,0.35);font-size:0.9rem;"><span id="scGlobalLoadingText">Загружаю…</span></div>

      <!-- ПРОМО-ЗОНА: по умолчанию видна (шапка + «Проверяем доступ»), при ответе API — тарифы/подарок или чат -->
      <div id="scPromoArea" class="page-scroll" style="padding:16px 20px calc(env(safe-area-inset-bottom)+32px);">

        <!-- Сообщение при временной ошибке загрузки (сеть/таймаут) -->
        <div id="scPromoErrorWrap" style="display:none;margin-bottom:16px;padding:14px 16px;background:rgba(var(--secondary-rgb),0.08);border:1px solid rgba(var(--secondary-rgb),0.25);border-radius:14px;">
          <div id="scPromoErrorText" style="font-size:0.88rem;color:rgba(255,255,255,0.75);line-height:1.5;margin-bottom:12px;">Временная ошибка загрузки. Можно выбрать тариф или купить сутки.</div>
          <button type="button" id="scPromoRetryBtn" style="width:100%;padding:10px 16px;border-radius:12px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.9);font-size:0.88rem;font-weight:600;cursor:pointer;font-family:inherit;">Повторить</button>
        </div>

        <!-- Краткое описание + кнопка «Подробнее» -->
        <div style="margin-bottom:18px;">
          <div id="scPromoIntro" style="font-size:0.9rem;color:rgba(255,255,255,0.65);line-height:1.65;margin-bottom:10px;">
            Soul Chat — твой ИИ-ассистент, который понимает тебя словно лучший друг или Высшее Я. Отвечает на вопросы о характере, предназначении и пути.
          </div>
          <button type="button" id="scMoreBtn" style="background:none;border:none;color:rgba(var(--primary-rgb),0.7);font-size:0.82rem;cursor:pointer;padding:0;font-family:inherit;box-shadow:none;animation:none;min-height:unset;">
            <span id="scMoreBtnText">Подробнее ↓</span>
          </button>
        </div>

        <!-- Расширенная инфо (статистика + примеры) — скрыта по умолчанию -->
        <div id="scMoreContent" style="display:none;margin-bottom:18px;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;">
            <div style="background:rgba(var(--primary-rgb),0.06);border:1px solid rgba(var(--primary-rgb),0.14);border-radius:14px;padding:12px;text-align:center;">
              <div style="font-size:1.4rem;font-weight:700;color:var(--primary-color);line-height:1;">78%</div>
              <div id="scStat1" style="font-size:0.7rem;color:rgba(255,255,255,0.5);margin-top:4px;line-height:1.4;">отмечают снижение тревоги</div>
            </div>
            <div style="background:rgba(var(--secondary-rgb),0.06);border:1px solid rgba(var(--secondary-rgb),0.14);border-radius:14px;padding:12px;text-align:center;">
              <div style="font-size:1.4rem;font-weight:700;color:var(--secondary-color);line-height:1;">91%</div>
              <div id="scStat2" style="font-size:0.7rem;color:rgba(255,255,255,0.5);margin-top:4px;line-height:1.4;">чувствуют себя понятыми</div>
            </div>
            <div style="background:rgba(var(--primary-rgb),0.06);border:1px solid rgba(var(--primary-rgb),0.14);border-radius:14px;padding:12px;text-align:center;">
              <div style="font-size:1.4rem;font-weight:700;color:var(--primary-color);line-height:1;">3×</div>
              <div id="scStat3" style="font-size:0.7rem;color:rgba(255,255,255,0.5);margin-top:4px;line-height:1.4;">быстрее находят ответ</div>
            </div>
            <div style="background:rgba(var(--secondary-rgb),0.06);border:1px solid rgba(var(--secondary-rgb),0.14);border-radius:14px;padding:12px;text-align:center;">
              <div style="font-size:1.4rem;font-weight:700;color:var(--secondary-color);line-height:1;">84%</div>
              <div id="scStat4" style="font-size:0.7rem;color:rgba(255,255,255,0.5);margin-top:4px;line-height:1.4;">возвращаются снова</div>
            </div>
          </div>
          <div id="scExamplesTitle" style="font-size:0.7rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.3);margin-bottom:8px;">Примеры вопросов</div>
          <div style="display:flex;flex-direction:column;gap:6px;">
            <div id="scEx1" style="background:rgba(var(--primary-rgb),0.05);border:1px solid rgba(var(--primary-rgb),0.12);border-radius:10px;padding:10px 12px;font-size:0.85rem;color:rgba(255,255,255,0.7);line-height:1.5;">«Почему мне так сложно говорить о своих чувствах?»</div>
            <div id="scEx2" style="background:rgba(var(--primary-rgb),0.05);border:1px solid rgba(var(--primary-rgb),0.12);border-radius:10px;padding:10px 12px;font-size:0.85rem;color:rgba(255,255,255,0.7);line-height:1.5;">«Какой мой главный страх и как с ним работать?»</div>
            <div id="scEx3" style="background:rgba(var(--primary-rgb),0.05);border:1px solid rgba(var(--primary-rgb),0.12);border-radius:10px;padding:10px 12px;font-size:0.85rem;color:rgba(255,255,255,0.7);line-height:1.5;">«В чём моё предназначение и как к нему прийти?»</div>
          </div>
        </div>

        <!-- Проверка доступа (видно сразу при открытии Soul Chat, скрывается по ответу API) -->
        <div id="scPageLoading" style="display:block;text-align:center;padding:20px 0;color:rgba(255,255,255,0.45);font-size:0.9rem;">Проверяем доступ…</div>

        <!-- Тарифы -->
        <div id="scPagePromo">
          <div style="background:rgba(15,12,40,0.8);border:1px solid rgba(var(--primary-rgb),0.2);border-radius:18px;padding:16px;margin-bottom:12px;">
            <div id="scSubIncluded" style="font-size:0.65rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:rgba(var(--primary-rgb),0.5);margin-bottom:10px;">Soul Chat включён в подписку</div>
            <div style="display:flex;flex-direction:column;gap:7px;">
              <div style="display:flex;justify-content:space-between;align-items:center;padding:9px 12px;background:rgba(255,255,255,0.04);border-radius:10px;">
                <div><div style="font-size:0.85rem;font-weight:600;color:#fff;">Basic</div><div style="font-size:0.7rem;color:rgba(255,255,255,0.38);">5 треков/мес + Soul Chat</div></div>
                <div style="font-size:0.85rem;font-weight:700;color:var(--primary-color);">$14.99/мес</div>
              </div>
              <div style="display:flex;justify-content:space-between;align-items:center;padding:9px 12px;background:linear-gradient(135deg,rgba(var(--secondary-rgb),0.07),rgba(var(--primary-rgb),0.04));border:1px solid rgba(var(--secondary-rgb),0.18);border-radius:10px;">
                <div><div style="font-size:0.85rem;font-weight:600;color:#fff;">Plus <span style="font-size:0.68rem;color:rgba(var(--primary-rgb),0.6);font-weight:400;">✦ Популярный</span></div><div style="font-size:0.7rem;color:rgba(255,255,255,0.38);">10 треков/мес + Chat без лимита</div></div>
                <div style="font-size:0.85rem;font-weight:700;color:var(--secondary-color);">$24.99/мес</div>
              </div>
              <div style="display:flex;justify-content:space-between;align-items:center;padding:9px 12px;background:rgba(var(--primary-rgb),0.04);border:1px solid rgba(var(--primary-rgb),0.12);border-radius:10px;">
                <div><div style="font-size:0.85rem;font-weight:600;color:#fff;">Лаборатория</div><div style="font-size:0.7rem;color:rgba(255,255,255,0.38);">30 треков/мес + Chat без лимита</div></div>
                <div style="font-size:0.85rem;font-weight:700;color:var(--primary-color);">$39.99/мес</div>
              </div>
            </div>
            <button id="scChoosePlanBtn" onclick="goToProfileFrom('soulChatPage')" style="width:100%;margin-top:12px;padding:12px;border-radius:13px;background:linear-gradient(135deg,rgba(var(--primary-rgb),0.25),rgba(var(--secondary-rgb),0.2));border:1px solid rgba(var(--primary-rgb),0.4);color:var(--primary-color);font-size:0.92rem;font-weight:700;cursor:pointer;font-family:inherit;letter-spacing:0.02em;box-shadow:none;animation:none;">
              Выбрать тариф →
            </button>
          </div>

          <!-- Подарочные 24ч -->
          <div id="scPageGiftWrap" style="display:none;background:linear-gradient(135deg,rgba(var(--primary-rgb),0.08),rgba(var(--secondary-rgb),0.06));border:1px solid rgba(var(--primary-rgb),0.3);border-radius:16px;padding:16px;text-align:center;margin-bottom:10px;">
            <div style="font-size:1.6rem;margin-bottom:6px;"></div>
            <div id="scGiftHeading" style="font-weight:700;color:var(--primary-color);margin-bottom:4px;">Попробуй бесплатно — 24 часа</div>
            <div id="scGiftNote" style="font-size:0.83rem;color:rgba(255,255,255,0.6);line-height:1.5;margin-bottom:12px;">Один раз для каждого пользователя</div>
            <button id="scPageGiftBtn" type="button" style="padding:12px 24px;border-radius:13px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));border:none;color:#fff;font-size:0.92rem;font-weight:700;cursor:pointer;font-family:inherit;width:100%;">
              Получить 24 часа бесплатно
            </button>
          </div>

          <!-- Купить сутки -->
          <div id="scPageBuyDayWrap" style="display:none;border:1px solid rgba(255,255,255,0.1);border-radius:14px;padding:14px;text-align:center;">
            <div id="scBuyDayNote" style="font-size:0.78rem;color:rgba(255,255,255,0.4);margin-bottom:9px;line-height:1.5;">Не готов к подписке? Попробуй разовый доступ</div>
            <button id="scPageBuyDayBtn" type="button" style="width:100%;padding:11px;border-radius:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.7);font-size:0.88rem;font-weight:600;cursor:pointer;font-family:inherit;box-shadow:none;animation:none;">
              Открыть Soul Chat на 24ч — $2.99
            </button>
            <div id="scPageBuyDayStatus" style="display:none;font-size:0.78rem;color:rgba(var(--primary-rgb),0.7);margin-top:7px;"></div>
          </div>
        </div>
      </div>

      <!-- ЧАТ-ЗОНА: есть доступ — история прокручивается, ввод фиксирован внизу -->
      <!-- Шапка чата: назад, контекст карточки (имя, дата), таймер доступа -->
      <div id="scChatHeader" style="display:none;flex-shrink:0;align-items:center;gap:10px;padding:max(10px,env(safe-area-inset-top)) 16px 12px;border-bottom:1px solid rgba(255,255,255,0.08);background:rgba(8,7,26,0.6);">
        <button type="button" class="profile-back-btn" onclick="goBack()" aria-label="Назад" style="margin-right:auto;">←</button>
        <button id="scCardPickerBtn" type="button" title="Контекст чата — сменить карточку" style="display:none;font-size:0.8rem;font-weight:600;color:var(--primary-color);background:rgba(var(--primary-rgb),0.12);border:1px solid rgba(var(--primary-rgb),0.28);border-radius:12px;padding:6px 14px;cursor:pointer;font-family:inherit;white-space:nowrap;max-width:200px;overflow:hidden;text-overflow:ellipsis;" onclick="scOpenCardPicker()">— ▾</button>
        <div id="scPageTimer" style="display:none;font-size:0.72rem;color:rgba(var(--primary-rgb),0.65);background:rgba(var(--primary-rgb),0.1);padding:5px 12px;border-radius:14px;white-space:nowrap;"></div>
      </div>

      <!-- Модальное окно выбора карточек (синастрия) -->
      <div id="scCardPickerModal" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,0.65);" onclick="if(event.target===this)scCloseCardPicker()">
        <div style="position:absolute;bottom:0;left:0;right:0;background:#0f0e24;border-radius:20px 20px 0 0;padding:20px 16px calc(env(safe-area-inset-bottom)+20px);max-height:82vh;display:flex;flex-direction:column;">
          <div style="display:flex;align-items:center;margin-bottom:16px;">
            <div style="font-size:1rem;font-weight:700;color:var(--primary-color);flex:1;">Контекст чата</div>
            <button type="button" onclick="scCloseCardPicker()" style="background:none;border:none;color:rgba(255,255,255,0.4);font-size:1.3rem;cursor:pointer;padding:0;line-height:1;">×</button>
          </div>
          <!-- Переключатель режима -->
          <div id="scPickerModeTabs" style="display:flex;gap:8px;margin-bottom:16px;">
            <button id="scPickerTabSingle" type="button" class="btn-magic" onclick="scSetPickerMode('single')" style="flex:1;padding:8px;border-radius:10px;font-size:0.82rem;font-weight:600;cursor:pointer;font-family:inherit;background:rgba(var(--primary-rgb),0.18);color:var(--primary-color);">Одна карточка</button>
            <button id="scPickerTabSynastry" type="button" class="btn-magic" onclick="scSetPickerMode('synastry')" style="flex:1;padding:8px;border-radius:10px;font-size:0.82rem;font-weight:600;cursor:pointer;font-family:inherit;background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.5);">Синастрия (2 карточки)</button>
          </div>
          <!-- Режим: одна карточка -->
          <div id="scPickerSinglePane" style="flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:8px;min-height:0;">
            <div id="scPickerSingleList" style="display:flex;flex-direction:column;gap:8px;"></div>
          </div>
          <!-- Режим: синастрия -->
          <div id="scPickerSynastryPane" style="display:none;flex:1;overflow-y:auto;display:none;flex-direction:column;gap:12px;min-height:0;">
            <div>
              <div style="font-size:0.75rem;color:rgba(255,255,255,0.4);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.06em;">Карточка A</div>
              <div id="scPickerSynListA" style="display:flex;flex-direction:column;gap:6px;"></div>
            </div>
            <div>
              <div style="font-size:0.75rem;color:rgba(255,255,255,0.4);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.06em;">Карточка B</div>
              <div id="scPickerSynListB" style="display:flex;flex-direction:column;gap:6px;"></div>
            </div>
          </div>
          <!-- Кнопка применить -->
          <button id="scPickerApplyBtn" type="button" class="btn-pay" onclick="scApplyCardPicker()" style="margin-top:16px;width:100%;padding:13px;border-radius:13px;background:linear-gradient(135deg,rgba(var(--primary-rgb),0.28),rgba(var(--secondary-rgb),0.18));border:1px solid rgba(var(--primary-rgb),0.4);color:var(--primary-color);font-size:0.92rem;font-weight:700;cursor:pointer;font-family:inherit;box-shadow:none;">Применить</button>
        </div>
      </div>

      <!-- Список сообщений — flex:1 + overflow-y:auto -->
      <div id="scPageChat" style="display:none;flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;background:linear-gradient(180deg,transparent 0%,rgba(8,7,26,0.3) 100%);">
        <!-- Если нет ни заявки, ни профиля -->
        <div id="scPageNoRequest" style="display:none;background:linear-gradient(135deg,rgba(var(--primary-rgb),0.08),rgba(var(--secondary-rgb),0.05));border:1px solid rgba(var(--primary-rgb),0.25);border-radius:16px;padding:18px;text-align:center;">
          <div style="font-size:1.4rem;margin-bottom:8px;"></div>
          <div style="font-weight:700;color:var(--primary-color);margin-bottom:6px;font-size:0.92rem;">Нужны твои данные</div>
          <div style="font-size:0.82rem;color:rgba(255,255,255,0.55);line-height:1.6;margin-bottom:14px;">Soul Chat строит персональный разговор на основе имени и даты рождения. Заполни профиль или создай первую заявку на песню.</div>
          <div style="display:flex;flex-direction:column;gap:9px;">
            <button type="button" onclick="goToPage('profilePage')" style="width:100%;padding:11px;border-radius:12px;background:linear-gradient(135deg,rgba(var(--primary-rgb),0.25),rgba(var(--secondary-rgb),0.2));border:1px solid rgba(var(--primary-rgb),0.4);color:var(--primary-color);font-size:0.9rem;font-weight:700;cursor:pointer;font-family:inherit;box-shadow:none;animation:none;">
              Заполнить профиль →
            </button>
            <button type="button" onclick="goToPage('formPage')" style="width:100%;padding:11px;border-radius:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);color:rgba(255,255,255,0.6);font-size:0.86rem;font-weight:500;cursor:pointer;font-family:inherit;box-shadow:none;animation:none;">
              Создать заявку на песню →
            </button>
          </div>
        </div>
        <!-- История сообщений -->
        <div id="scPageHistory" aria-live="polite" aria-label="История диалога Soul Chat"></div>
        <!-- Тизер синастрии для Basic/Plus (не Master) -->
        <div id="scSynastryTeaser" style="display:none;margin-top:12px;padding:12px 14px;border-radius:14px;background:rgba(var(--primary-rgb),0.07);border:1px solid rgba(var(--primary-rgb),0.18);font-size:0.82rem;color:rgba(255,255,255,0.6);line-height:1.5;">
          <span style="color:rgba(var(--primary-rgb),0.8);">✦</span> Синастрия — глубокий диалог на любые темы на основе двух карт сразу — доступна в тарифе Лаборатория
          <button type="button" onclick="goToMasterPlanFrom('soulChatPage')" style="display:inline-block;margin-left:8px;padding:3px 10px;border-radius:8px;background:rgba(var(--primary-rgb),0.15);border:1px solid rgba(var(--primary-rgb),0.3);color:var(--primary-color);font-size:0.78rem;font-weight:600;cursor:pointer;font-family:inherit;box-shadow:none;animation:none;min-height:unset;">Открыть тариф →</button>
        </div>
        <div id="scPageStatus" style="display:none;text-align:center;font-size:0.8rem;color:rgba(255,255,255,0.45);padding:8px 0;"></div>
      </div>

      <!-- Поле ввода — прилипает к низу, вне зоны скролла -->
      <div id="scInputArea" style="display:none;flex-shrink:0;padding:12px 14px calc(env(safe-area-inset-bottom)+12px);border-top:1px solid rgba(var(--primary-rgb),0.1);background:linear-gradient(180deg,#0a091e 0%,#08071a 100%);">
        <div class="request-input-box">
          <textarea id="scPageQuestion" class="request-textarea" rows="2"
            placeholder="Задай вопрос своей душе…" aria-label="Вопрос"></textarea>
          <div class="sc-send-bar">
            <span class="sc-char-hint" id="scPageCharHint"></span>
            <button id="scPageSendBtn" type="button" style="padding:9px 18px;border-radius:10px;background:linear-gradient(135deg,rgba(var(--primary-rgb),0.28),rgba(var(--secondary-rgb),0.18));border:1px solid rgba(var(--primary-rgb),0.38);color:var(--primary-color);font-size:0.85rem;font-weight:700;cursor:pointer;font-family:inherit;letter-spacing:0.02em;box-shadow:none;animation:none;min-height:unset;white-space:nowrap;">
              Спросить
            </button>
          </div>
        </div>
      </div>

    </div>
    <!-- ═══════════════════════════════════════════ -->

    <!-- Страница «Спасибо за оплату» (редирект с HOT) -->
    <div class="page" id="paymentThanksPage">
      <header class="page-header">
        <div style="font-size:0.78rem;font-weight:400;letter-spacing:0.12em;color:rgba(var(--primary-rgb),0.5);margin:2px 0 0;text-transform:uppercase">Музыка твоей души</div>
        <div id="paymentThanksSubtitle" class="subtitle">заявка принята</div>
      </header>
      <div class="section page-scroll" style="text-align:center; padding-top:40px">
        <div id="paymentThanksIcon" style="width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,rgba(var(--primary-rgb),0.2),rgba(var(--primary-rgb),0.06));border:1.5px solid rgba(var(--primary-rgb),0.35);display:flex;align-items:center;justify-content:center;margin:0 auto 20px;font-size:1.8rem;color:var(--primary-color);font-weight:300"></div>
        <h2 id="paymentThanksTitle" class="success-title" style="font-size:1.5rem; margin:0 0 12px 0">Оплата прошла</h2>
        <p class="success-text" id="paymentThanksMessage" style="margin:0 0 24px 0; font-size:0.92rem; color:rgba(255,255,255,0.6); line-height:1.65">
          Песня создаётся. Придёт в чат с ботом. Можно закрыть окно.
        </p>
        <button id="paymentThanksBackBtn" class="primary" style="margin-bottom:12px">Создать свою песню</button>
        <p id="paymentThanksHint" style="font-size:0.72rem;color:rgba(255,255,255,0.3);line-height:1.5;margin:0;">Не пришла за 20 минут? Напиши боту «песня не пришла»</p>
      </div>
  </div>

  <script>
    // Глобальная обработка ошибок — приложение не «зависает» без обратной связи
    (function() {
      var errorMsg = 'Что-то пошло не так. Попробуй обновить.';
      function showErrorToast() {
        try {
          var toast = document.createElement('div');
          toast.setAttribute('role', 'alert');
          toast.style.cssText = 'position:fixed;inset:0;z-index:99999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);color:#fff;font-family:inherit;font-size:1rem;padding:24px;text-align:center;';
          toast.textContent = errorMsg;
          document.body.appendChild(toast);
          setTimeout(function() { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 8000);
        } catch (_) {}
      }
      window.onerror = function(msg, url, line, col, err) {
        console.error('[YupSoul]', msg, url, line, col, err);
        showErrorToast();
        return true;
      };
      window.addEventListener('unhandledrejection', function(e) {
        console.error('[YupSoul] unhandledrejection', e.reason);
        showErrorToast();
        e.preventDefault();
      });
    })();
    document.addEventListener('DOMContentLoaded', function() {
      (function removeBotNameHeaders() {
        document.querySelectorAll('.header-title, .page-header-title, .app-title').forEach(function(el) { el.remove(); });
        document.querySelectorAll('#homeTopBar, .page-header, .form-header-bar').forEach(function(header) {
          [].slice.call(header.childNodes).forEach(function(node) {
            if (node.nodeType === 1 && node.textContent && node.textContent.trim() === 'YupSoul Personal Music') node.remove();
          });
        });
      })();
      var tg = null;
      var INIT_DATA_STORAGE_KEY = 'tg_init_data';
      var LANG_STORAGE_KEY = 'yupsoul_lang';
      var BOT_USERNAME = 'Yup_Soul_bot'; // единственное место для имени бота
      var LANG = {
        ru: {
          tagline: 'Музыка твоей души',
          startBtn: 'Создать свою песню', myProfile: 'Профиль', myHeroes: 'Лаборатория', myHelp: 'Помощь', admin: 'Админка',
          profileTitle: 'Профиль', profileSubtitle: 'Твои данные и бесплатные генерации',
          profileFreeCredits: 'Бесплатных генераций', profileInviteFriend: 'Пригласи друга', profileShare: 'Поделиться',
          profileInvited: 'Приглашено', profileActivated: 'Активировано', profileCreateSong: 'Создать песню',
          heroesTitle: 'Лаборатория', heroesSubtitle: 'Картотека людей',
          searchByName: 'Поиск по имени', searchPlaceholder: 'Введите имя...', searchBtn: 'Искать',
          addHero: '➕ Добавить героя', heroName: 'Имя *', heroBirthdate: 'Дата рождения', heroBirthtime: 'Время рождения',
          heroBirthplace: 'Место рождения', heroBirthplacePh: 'Город, страна', heroNotes: 'Досье / заметки', heroNotesPh: 'Заметки о клиенте',
          unknownTime: 'Не знаю точное время', cancel: 'Отмена', save: 'Сохранить', back: '← Назад',
          gender: 'Пол', genderSelect: 'Выбери', male: 'Мужской', female: 'Женский', other: 'Другой',
          modeType: 'Формат песни', modeSubtitle: 'Для кого создаём?',
          modeSingle: 'Обо мне', modeSingleDesc: 'Песня по твоей дате рождения',
          modeCouple: 'Про двоих', modeCoupleDesc: 'Песня для двух людей',
          modeTransit: 'Энергия<br>момента', modeTransitDesc: 'Песня о сегодняшнем дне',
          namePh: 'Как тебя зовут?', birthdateLabel: 'Дата рождения', birthplacePh: 'Город или страна — выбери из подсказок',
          birthplaceHint: 'Начни вводить город и выбери из выпавшего списка.',
          unknownTimeShort: 'Не знаю', secondPersonTitle: 'Для двоих', name2Ph: 'Имя второго человека',
          birthplace2Ph: 'Место рождения второго', birthtime2Ph: 'Время рождения',
          transitTitle: 'Энергия момента', transitDatePh: 'Дата события', transitTimePh: 'Время события',
          transitLocationPh: 'Город для энергии момента', transitLocationOk: 'Локация указана верно',
          transitIntentPh: 'Намерение момента',
          sendRequest: 'Что будешь исследовать сегодня?', quickRequests: 'Быстрые запросы', hide: 'Скрыть',
          requestDesc: 'О чём песня? Любой запрос — от юмора до глубокой темы',
          requestQuickHint: 'Выбери готовый запрос или напиши свой',
          requestPh: 'Напиши любой запрос', toPayment: 'К оплате',
          paymentSubtitle: 'Твоя песня', paymentAndAccess: 'Оплата и доступ',
          paymentIntro: 'Первая песня — в подарок. Дальше можно оплатить отдельный элемент или оформить подписку на полный доступ.',
          loadingPricing: 'Загрузка тарифов...', currentItem: 'Текущий элемент',
          promoCode: 'Промокод', apply: 'Применить', backFromPayment: '← Назад',
          submitAndContinue: 'Оформить и продолжить', submitRequest: 'Отправить заявку',
          submitHint: 'Песня придёт в этот чат с ботом. Если вы ещё не нажимали «Старт» в боте — нажмите его сейчас.',
          paymentPageIntroAfterSubmit: 'Заявка отправлена. Введите промокод или нажмите кнопку ниже для оплаты через HOT Pay.',
          paymentPageIntroOrPay: 'Или введите промокод, или оплатите через HOT Pay.',
          paymentPageTagline: 'Промокод или оплата',
          payWithHot: 'Оплатить через HOT Pay',
          firstFree: 'Первая песня доступна бесплатно.',
          paymentRequired: 'Оплата требуется для новых заявок.',
          subscriptionActive: 'У вас активная подписка — можно продолжить.',
          catalogLoadFailed: 'Тарифы не загрузились. Нажмите «Оформить и продолжить» — стоимость определит бэкенд.',
          promoApplied: 'Промокод {code}: -{amount} {currency}',
          creatingKey: 'Создаю твою песню...',
          creatingKeyDesc: 'Магия творится в реальном времени. Твоя персональная песня формируется на основе твоих данных.',
          keyActivated: 'Песня создана!', done: 'Готово!',
          successText: 'Твоя персональная песня создана! Уникальный трек по твоим данным — слушай когда захочешь.',
          yourSong: 'Твоя песня',
          songPreviewText: 'Твоя уникальная аудиокомпозиция уже ждёт тебя в боте. Слушай её каждое утро, чтобы настроиться на волну успеха.',
          whatNext: 'Что дальше:', openBot: 'Открой бота',
          soulChat: 'Поговорить с душой', soulChatPay: 'К оплате — Soul Basic / Soul Plus',
          newKey: 'Создать ещё одну песню',
          paymentThanks: 'Спасибо за оплату', thanksSubtitle: 'заявка принята', paymentThanksBackToForm: 'Создать свою песню',
          songInProgress: 'Песня генерируется на сервере и придёт в этот чат с ботом. Можно закрыть окно — ничего не пропадёт. Спасибо',
          songInProgressConfirmed: 'Заявка принята. Песня генерируется на нашем сервере — когда будет готова, придёт сюда в чат с ботом. Можно закрыть окно — ничего не пропадёт. Спасибо, что остаёшься с нами',
          thanksDone: 'Готово',
          notFromTelegram: 'Открой приложение из чата с ботом в Telegram (кнопка меню) — иначе заявка не отправится.',
          notFound: 'Не найдено', searchError: 'Ошибка поиска',
          soulChatLoad: 'Загрузка…',
          soulChatHasAccess: 'У тебя есть доступ к Soul Chat. Нажми кнопку ниже — откроется бот. В боте напиши /soulchat и задай вопрос своей душе.',
          soulChatNoAccess: 'Soul Chat — диалоги с душой. Доступ по подписке Soul Basic (до 50 сообщений/мес) или Soul Plus (без лимита).',
          soulChatDefault: 'Soul Chat — диалоги с душой по заявке. Доступ по подписке.',
          soulChatNoApi: 'Soul Chat — диалоги с душой по заявке. Доступ по подписке Soul Basic или Soul Plus. Оформи в приложении: «К оплате».',
          greeting: 'Привет, {name}!',
          greetingDefault: 'Привет',
          onboardingSlide1Title: 'Есть песня — о тебе',
          onboardingSlide1Text: 'Написанная по дате рождения. Не шаблон — живой текст о твоём характере, силе и пути.',
          onboardingSlide2Title: 'Только о тебе',
          onboardingSlide2Text: 'Каждая — уникальна. Её больше нет ни у кого. Ни одна не повторяется.',
          onboardingSlide3Title: 'Первая — в подарок',
          onboardingSlide3Text: 'Введи дату рождения — и получи свою песню в чат с ботом.',
          onboardingBtnStart: 'Получить свою песню',
          alertNameShort: 'Имя должно содержать минимум 2 символа', alertBirthdate: 'Выбери дату рождения',
          alertBirthplace: 'Место рождения должно содержать минимум 3 символа', alertBirthplaceHint: 'Выбери локацию из списка подсказок',
          alertBirthtime: 'Укажи время рождения или отметь "Не знаю"', alertGender: 'Укажи пол', alertLanguage: 'Выбери язык',
          alertName2Short: 'Имя второго человека — минимум 2 символа', alertBirthdate2: 'Укажи дату рождения второго человека',
          alertBirthplace2: 'Место рождения второго человека должно содержать минимум 3 символа',
          alertBirthtime2: 'Укажи время рождения второго человека', alertGender2: 'Выбери пол второго человека',
          alertTransitDate: 'Укажи дату события', alertTransitLocation: 'Укажи локацию события', alertTransitConfirm: 'Подтверди, что локация указана верно',
          alertRequestShort: 'Добавь запрос (5+ символов)', alertRequestLong: 'Расскажи Вселенной подробнее (минимум 15 символов)',
          alertYourPath: 'Выбери свой путь', alertNoApi: 'Не настроен адрес API.', alertOpenFromBot: 'Открой приложение из чата с ботом в Telegram — иначе заявку нельзя принять.',
          alertServerSleep: 'Сервер проснулся не сразу. Подожди около минуты и нажми «Отправить заявку» снова.',
          sending: 'Отправляю…',
          universeHeard: '{name}, Вселенная услышала твой запрос.\n\nТвоя песня формируется и придёт в этот чат, когда будет готова.',
          universeHeardCouple: '{name} и {name2}, Вселенная услышала ваш запрос.\n\nВаша песня формируется и придёт в этот чат, когда будет готова.',
          universeHeardTransit: '{name}, Вселенная услышала твой запрос.\n\nПесня «Энергия Дня» формируется и придёт в этот чат, когда будет готова.',
          langSong: 'Язык песни', langRu: 'Русский', langEn: 'English', langDe: 'Deutsch', langFr: 'Français', langUk: 'Українська',
          quick1: 'Гармония и любовь к себе', quick2: 'Уверенность и предназначение', quick3: 'Творческий потенциал', quick4: 'Отпустить прошлое',
          quick5: 'Баланс жизни', quick6: 'Доверие и принятие', quick7: 'Исцеление и свобода', quick8: 'Путь к счастью',
          quick9: 'Сила и преодоление', quick10: 'Глубина и тишина', quick11: 'Нежность и забота', quick12: 'Юмор и лёгкость',
          quick1t: 'Гармония в отношениях и любовь к себе', quick2t: 'Уверенность, предназначение и опора на себя',
          quick3t: 'Раскрыть творческий потенциал без страха', quick4t: 'Отпустить прошлое и открыть новые возможности',
          quick5t: 'Баланс работы и личной жизни', quick6t: 'Доверять жизни и отпускать контроль',
          quick7t: 'Исцелить детские травмы и обрести свободу', quick8t: 'Найти свой путь к счастью и спокойствию',
          quick9t: 'Мощная песня о моей силе и преодолении', quick10t: 'Медитативная песня для практики и исцеления',
          quick11t: 'Тёплая песня о заботе и нежности', quick12t: 'Весёлая песня с самоиронией про мои слабости',
          promoError: 'Не удалось применить промокод',
          promoCleared: 'Промокод очищен.', promoApplied: 'Промокод применён: итоговая сумма {amount} {currency}',
          promoAppliedHint: 'Промокод {code}: -{amount} {currency}',
          paymentRequiredOpening: 'Требуется оплата. Открываю HOT Checkout...',
          promoFreeGen: 'Промокод дал бесплатную генерацию. Запуск...',
          hotCheckoutOpened: 'Открыт HOT Checkout. После оплаты вернись в Mini App — статус обновится автоматически.',
          paymentNotConfirmed: 'Оплата пока не подтверждена. Проверь статус позже или открой оплату повторно.',
          paymentConfirmed: 'Оплата подтверждена. Запускаю генерацию...',
          paymentReceivedNoStart: 'Оплата получена, но авто‑старт не удался. Запусти генерацию в админке по request_id: {id}',
          submitFailed: 'Не удалось отправить заявку. Подожди минуту и нажми «Отправить заявку» снова или открой Mini App заново из чата с ботом.',
          errorOp: 'Ошибка операции оплаты/заявки',
          alertTransitLocation: 'Укажи локацию события', alertTransitConfirm: 'Подтверди, что локация указана верно',
          alertNoApi: 'Не настроен адрес API.', alertOpenFromBot: 'Открой приложение из чата с ботом в Telegram — иначе заявку нельзя принять.',
          alertOpenFromBotShort: 'Открой приложение из чата с ботом в Telegram.',
          alertPaymentFirst: 'Сначала нажмите «Отправить заявку» на предыдущем шаге.',
          alertLinkCopied: 'Ссылка скопирована. Вставьте её в Safari или Chrome и откройте.',
          alertHeroName: 'Введите имя', alertError: 'Ошибка', alertDeleteConfirm: 'Удалить «{name}»? Это действие нельзя отменить.',
          alertSubmitError: 'Ошибка при отправке',
          copyLinkPrompt: 'Скопируйте эту ссылку и откройте в браузере:',
          songFormingText: 'Твоя песня формируется и придёт в этот чат, когда будет готова.',
          heroesLoading: 'Загрузка...', heroesEmpty: 'Пока нет героев. Нажми «Добавить героя».',
          heroesLoadError: 'Не удалось загрузить список. Проверьте настройку API.',
          loading: 'Загрузка…', noCardsYet: 'Нет завершённых карточек', heroHistLoading: 'Загрузка истории…', heroHistEmpty: 'Генераций пока нет', heroHistLoadError: 'Не удалось загрузить историю', heroesPageLoadError: 'Не удалось загрузить героев', retry: 'Повторить',
          forMyself: 'Для себя', forHero: 'Для: {name}',
          previewHome: 'Главная', previewForm: 'Форма', previewPayment: 'Оплата', previewLoading: 'Загрузка', previewSuccess: 'Успех',
          supportBtn: 'Написать в поддержку',
          subActivated: 'Подписка активирована!', subBtnProfile: 'Мой профиль',
          helpPageTitle: 'Помощь и поддержка', helpPageSubtitle: 'Всё о YupSoul — просто и по делу',
          profileHelpBtn: 'Помощь и поддержка',
          profilePageTitle: 'Профиль', profileSectionMyData: 'Мои данные', profileSectionPlans: 'Тарифы',
          profileLoadError: 'Не удалось загрузить подписку. Проверьте интернет.', profileLoadRetry: 'Повторить',
          profileEditBtn: 'Изменить →', profileBalanceHintText: 'Приглашай друзей — получай треки в подарок',
          profileSectionTracks: 'Разовые треки', profileRefTagline: 'Приглашай друзей — получай бесплатные песни по нарастающей',
          profileRefInvited: 'Приглашено', profileRefActivated: 'Активировано',
          planCurrentBadge: 'Текущий', planFreeYours: 'Уже у тебя', planSubscribeBtn: 'Оформить',
          planDetailsBtn: 'Подробнее', planPopularBadge: '✦ Популярный', planMasterBadgeText: 'Мастер',
          planMasterNameText: 'Лаборатория', planOpenMasterBtn: 'Открыть Лабораторию',
          ptiSingleName: 'Для себя', ptiSingleDesc: 'Твоя личность в звуке',
          ptiCoupleName: 'Для двоих', ptiCoupleDesc: 'Ваша связь и резонанс',
          ptiTransitName: 'Энергия дня', ptiTransitDesc: 'Песня под сегодняшний день',
          successTitle: 'Заявка принята!', successDesc: 'Твоя песня генерируется. Как только будет готова — придёт в бот. Обычно 10–20 минут.',
          successHint: 'Не пришла через 20 мин? Напиши боту «песня не пришла».', successToProfile: 'Перейти в профиль',
          loadingTitle: 'Заявка принята',
          heroesPageTitle: 'Лаборатория', heroesPromoHeading: 'Личный кабинет для мастеров',
          heroesPromoDesc: 'Добавляй людей один раз — и генерируй для них песни в один тап. Полная история с текстами.',
          heroesPromoFeaturesTitle: 'Что входит в тариф:',
          heroesF1: '✦ Неограниченное число героев', heroesF2: '✦ Быстрый запуск соло и совместных песен',
          heroesF3: '✦ Предпочтения по стилю музыки', heroesF4: '✦ Полная история генераций с текстами и анализом',
          heroesF5: '✦ Аудио прямо из карточки героя',
          heroesTrialBtn: '1 день бесплатно — попробовать', heroesSubBtn: 'Оформить Лабораторию — $39.99/мес',
          heroesSubNote: '30 треков в месяц · Оплата через HOT Pay',
          heroFormTitle: 'Добавить героя', heroRelLabel: 'Кто для тебя', heroBirthdateHint: 'Выбери день, месяц и год',
          heroTimeBirthLabel: 'Время рождения', heroStyleLabel: 'Любимые стили музыки', heroStylePh: 'поп, джаз, электронная…',
          requestPreferredStyleLabel: 'Стиль песни',
          requestPreferredStylePh: 'Стиль песни: поп, r&b, рэп, хип‑хоп, техно, house, ambient…',
          heroRelOpt0: '— выбери —', heroRelOpt1: 'Мать', heroRelOpt2: 'Отец', heroRelOpt3: 'Дочь', heroRelOpt4: 'Сын',
          heroRelOpt5: 'Сестра', heroRelOpt6: 'Брат', heroRelOpt7: 'Бабушка', heroRelOpt8: 'Дедушка',
          heroRelOpt9: 'Муж', heroRelOpt10: 'Жена', heroRelOpt11: 'Любимый человек',
          heroRelOpt12: 'Друг', heroRelOpt13: 'Подруга', heroRelOpt14: 'Коллега', heroRelOpt15: 'Наставник', heroRelOpt16: 'Другое',
          dateDay: 'День', dateMonth: 'Месяц', dateYear: 'Год',
          scLoading: 'Загружаю…', scPromoIntro: 'Soul Chat — твой ИИ-ассистент, который понимает тебя словно лучший друг или Высшее Я. Отвечает на вопросы о характере, предназначении и пути.',
          scPromoErrorText: 'Временная ошибка загрузки. Можно выбрать тариф или купить сутки.', scPromoRetryBtn: 'Повторить',
          scMoreBtnText: 'Подробнее ↓', scMoreBtnCollapse: 'Свернуть ↑', scStat1: 'отмечают снижение тревоги', scStat2: 'чувствуют себя понятыми',
          scStat3: 'быстрее находят ответ', scStat4: 'возвращаются снова',
          scExamplesTitle: 'Примеры вопросов',
          scEx1: '«Почему мне так сложно говорить о своих чувствах?»', scEx2: '«Какой мой главный страх и как с ним работать?»',
          scEx3: '«В чём моё предназначение и как к нему прийти?»',
          scSubIncluded: 'Soul Chat включён в подписку', scChoosePlanBtn: 'Выбрать тариф →',
          scGiftHeading: 'Попробуй бесплатно — 24 часа', scGiftNote: 'Один раз для каждого пользователя',
          scGiftBtnText: 'Получить 24 часа бесплатно', scBuyDayNote: 'Не готов к подписке? Попробуй разовый доступ',
          scBuyDayBtnText: 'Открыть Soul Chat на 24ч — $2.99', scToastPaymentReceived: 'Оплата получена, доступ открыт',
          helpT1: 'Что такое YupSoul', helpB1: '<p>YupSoul создаёт <strong>персональную песню именно для тебя</strong> — на основе даты, времени и места рождения. Система анализирует твою личность и пишет песню о твоих реальных качествах, пути и силе.</p><p>Это не шаблон и не случайный текст — каждая песня уникальна и принадлежит только тебе.</p>',
          helpT2: 'Что можно создать', helpB2: '<ul><li><strong>Песня о себе</strong> — твой личный звуковой портрет: кто ты, твоя сила и внутренний путь</li><li><strong>Песня для пары</strong> — для двоих (влюблённых, друзей, подруг). Анализирует обе карты и отражает союз</li><li><strong>Энергия дня</strong> — песня под конкретную дату и место. Какие возможности открываются прямо сейчас</li></ul><p>Также есть <strong>быстрые запросы</strong> — готовые идеи: песня силы, поздравление с днём рождения, медитативная, про отпускание прошлого и другие.</p>',
          helpT3: 'Сколько ждать песню', helpB3: '<p>Обычно <strong>5–15 минут</strong>. Бот пришлёт уведомление в чат, как только песня будет готова.</p><p>Можно закрыть приложение — результат придёт сам, ты ничего не потеряешь.</p>',
          helpT4: 'Не знаю точное время рождения', helpB4: '<p>Не страшно. Отметь <strong>«Время неизвестно»</strong> — система создаст полноценную песню на основе остальных данных.</p>',
          helpT5: 'Бесплатные генерации', helpB5: '<p><strong>Первая генерация — бесплатно.</strong></p><p>Получить ещё бесплатные можно через реферальную программу: поделись своей ссылкой. Когда 5 приглашённых тобой друзей создадут первую песню — тебе автоматически начислится 1 бесплатная генерация.</p><p>Реферальная ссылка — в разделе «Профиль», блок «Пригласи друга».</p>',
          helpT6: 'Оплата и промокоды', helpB6: '<p>Дополнительные генерации оплачиваются по тарифу. Способы оплаты отображаются на экране при оформлении заявки.</p><p>Если у тебя есть <strong>промокод</strong> — введи его на экране оплаты. Промокоды чувствительны к регистру, вводи точно как написано.</p>',
          helpT7: 'Что-то пошло не так', helpB7: '<p><strong>Приложение закрылось или показало ошибку</strong> — попробуй открыть бота заново. Незавершённые заявки восстанавливаются автоматически.</p><p><strong>Оплатил, но песни нет</strong> — подожди 15–20 минут. Если результата нет — напиши боту «песня не пришла». Или напиши в поддержку.</p><p><strong>Промокод не принимается</strong> — проверь регистр букв. Если всё верно — напиши нам с указанием кода.</p>',
          profileBalanceLbl: 'Бесплатных генераций',
          planFreeF1: '✦ 1 трек в подарок', planFreeF2: '✦ Все форматы',
          planBasicF1: '✦ 5 треков/мес', planBasicF2: '✦ Soul Chat (до 50 сообщ/мес)', planBasicF3: '✦ История заказов', planBasicSave: '−50% vs разовых',
          planPlusF1: '✦ 10 треков/мес', planPlusF2: '✦ Soul Chat без лимита', planPlusF3: '✦ Приоритет обработки', planPlusF4: '✦ Полная история треков', planPlusSave: '−58% vs разовых',
          planMasterF1: '✦ 30 треков/мес', planMasterF2: '✦ Картотека людей', planMasterF3: '✦ История генераций', planMasterF4: '✦ Soul Chat без лимита', planMasterSave: '−83% vs разовых',
          refFriend1: 'друг', refFriend2: 'друга', refFriend5: 'друзей', refLinkLoading: 'Загрузка…',
          quickPickerLabel: '✦ Быстрые запросы',
          forWhoLabel: 'Для кого генерируем?', nameLbl: 'Имя', birthdateLbl: 'Дата рождения', birthplaceLbl: 'Место рождения', birthtimeLbl: 'Время рождения',
          payOvCardTitleDefault: 'Оплата заявки', payOvTrialText: 'Первая песня — в подарок!', payOvFreeClaimBtn: 'Получить бесплатно',
          payOvPromoToggle: '▸ Есть промокод?', orPay: 'Или оплати:', priceLabel: 'Цена:',
          payOvLinkHint: 'Если окно не открылось — скопируйте ссылку и вставьте в браузер:',
          payOvCopyBtn: 'Скопировать ссылку оплаты', payOvCheckBtn: 'Я уже оплатил — проверить',
          payOvPromoConfirmBtn: 'Подтвердить и отправить',
          paymentThanksTitle: 'Оплата прошла', paymentThanksMsg: 'Песня создаётся. Придёт в чат с ботом. Можно закрыть окно.',
          paymentThanksHintText: 'Не пришла за 20 минут? Напиши боту «песня не пришла»'
        },
        en: {
          tagline: 'Music of your soul',
          startBtn: 'Create My Song', myProfile: 'Profile', myHeroes: 'Lab', myHelp: 'Help', admin: 'Admin',
          profileTitle: 'Profile', profileSubtitle: 'Your data and free generations',
          profileFreeCredits: 'Free generations', profileInviteFriend: 'Invite a friend', profileShare: 'Share',
          profileInvited: 'Invited', profileActivated: 'Activated', profileCreateSong: 'Create song',
          heroesTitle: 'Laboratory', heroesSubtitle: 'People directory',
          searchByName: 'Search by name', searchPlaceholder: 'Enter name...', searchBtn: 'Search',
          addHero: '➕ Add Hero', heroName: 'Name *', heroBirthdate: 'Date of birth', heroBirthtime: 'Time of birth',
          heroBirthplace: 'Place of birth', heroBirthplacePh: 'City, country', heroNotes: 'Notes', heroNotesPh: 'Client notes',
          unknownTime: "I don't know exact time", cancel: 'Cancel', save: 'Save', back: '← Back',
          gender: 'Gender', genderSelect: 'Choose', male: 'Male', female: 'Female', other: 'Other',
          modeType: 'Song format', modeSubtitle: 'Who is it for?',
          modeSingle: 'About me', modeSingleDesc: 'A song by your date of birth',
          modeCouple: 'About us', modeCoupleDesc: 'A song for two people',
          modeTransit: 'This<br>moment', modeTransitDesc: "A song about today",
          namePh: "What's your name?", birthdateLabel: 'Date of birth', birthplacePh: 'City or country — choose from suggestions',
          birthplaceHint: 'Start typing your city and pick from the list.',
          unknownTimeShort: "Don't know", secondPersonTitle: 'For two', name2Ph: "Second person's name",
          birthplace2Ph: "Second person's place of birth", birthtime2Ph: 'Time of birth',
          transitTitle: 'Energy of the moment', transitDatePh: 'Event date', transitTimePh: 'Event time',
          transitLocationPh: 'City for the moment energy', transitLocationOk: 'Location is correct',
          transitIntentPh: 'Intention for this moment',
          sendRequest: 'What will you explore today?', quickRequests: 'Quick requests', hide: 'Hide',
          requestDesc: 'What\'s the song about? Any request — from humor to deep themes.',
          requestQuickHint: 'Pick a ready-made request or write your own',
          requestPh: 'Write any request', toPayment: 'To payment',
          paymentSubtitle: 'Your sound key', paymentAndAccess: 'Payment & access',
          paymentIntro: 'First song is free. You can pay for individual items or subscribe for full access.',
          loadingPricing: 'Loading plans...', currentItem: 'Current item',
          promoCode: 'Promo code', apply: 'Apply', backFromPayment: '← Back',
          submitAndContinue: 'Checkout & continue', submitRequest: 'Submit request',
          submitHint: 'The song will arrive in this chat with the bot. If you haven\'t pressed «Start» in the bot yet — do it now.',
          paymentPageIntroAfterSubmit: 'Request submitted. Enter a promo code or tap the button below to pay via HOT Pay.',
          paymentPageTagline: 'Promo code or payment',
          payWithHot: 'Pay via HOT Pay',
          firstFree: 'Your first sound key is free.',
          paymentRequired: 'Payment required for new requests.',
          subscriptionActive: 'You have an active subscription — continue.',
          catalogLoadFailed: 'Pricing failed to load. Press «Continue» — backend will determine cost.',
          promoApplied: 'Promo {code}: -{amount} {currency}',
          creatingKey: 'Creating your key...',
          creatingKeyDesc: 'Magic happens in real time. Your personal sound key is being formed from your unique data.',
          keyActivated: 'Key activated!', done: 'Done!',
          successText: 'Your personal sound key is created! Your unique artifact of strength for the game of life.',
          yourSong: 'Your song',
          songPreviewText: 'Your unique audio piece is waiting for you in the bot. Listen every morning to tune into success.',
          whatNext: 'What next:', openBot: 'Open the bot',
          soulChat: 'Talk to your soul', soulChatPay: 'To payment — Soul Basic / Soul Plus',
          newKey: 'Create another key',
          paymentThanks: 'Thank you for payment', thanksSubtitle: 'request accepted', paymentThanksBackToForm: 'Create your song',
          songInProgress: 'Song is being generated and will arrive in the bot chat when ready.',
          songInProgressConfirmed: 'Request accepted. Song is being generated — no need to pay again. It will arrive in the bot chat when ready.',
          thanksDone: 'Done',
          notFromTelegram: 'Open the app from the bot chat in Telegram (menu button) — otherwise the request cannot be sent.',
          notFound: 'Not found', searchError: 'Search error',
          soulChatLoad: 'Loading…',
          soulChatHasAccess: "You have Soul Chat access. Tap below — the bot will open. In the bot, type /soulchat and ask your soul a question.",
          soulChatNoAccess: 'Soul Chat — dialogues with your soul. Available with Soul Basic (up to 50 messages/month) or Soul Plus (unlimited) subscription.',
          soulChatDefault: 'Soul Chat — dialogues with your soul per request. Available by subscription.',
          soulChatNoApi: 'Soul Chat — dialogues with your soul. Available with Soul Basic or Soul Plus subscription. Go to «To payment» in the app.',
          greeting: "Hi, {name}! Come back whenever you want to remember who you are.",
          greetingDefault: "Come back whenever you want to remember who you are.",
          onboardingSlide1Title: 'There is a song — about you',
          onboardingSlide1Text: 'Written from your date of birth. Not a template — a real text about your character, strength and path.',
          onboardingSlide2Title: 'Only about you',
          onboardingSlide2Text: 'A smart analysis of your personality becomes a living song — unique, only yours.',
          onboardingSlide3Title: 'First one — as a gift',
          onboardingSlide3Text: 'Enter your date of birth. Your song will arrive right here in chat.',
          onboardingBtnStart: 'Get my song',
          alertNameShort: 'Name must be at least 2 characters', alertBirthdate: 'Choose date of birth',
          alertBirthplace: 'Place of birth must be at least 3 characters', alertBirthplaceHint: 'Pick a location from the suggestions',
          alertBirthtime: 'Enter time of birth or check "Don\'t know"', alertGender: 'Select gender', alertLanguage: 'Choose language',
          alertName2Short: "Second person's name — at least 2 characters", alertBirthdate2: "Enter second person's date of birth",
          alertBirthplace2: "Second person's place of birth must be at least 3 characters",
          alertBirthtime2: "Enter second person's time of birth", alertGender2: "Select second person's gender",
          alertTransitDate: 'Enter event date', alertTransitLocation: 'Enter event location', alertTransitConfirm: 'Confirm the location is correct',
          alertRequestShort: 'Add a request (5+ characters)', alertRequestLong: 'Tell the Universe more (at least 15 characters)',
          alertYourPath: 'Choose your path', alertNoApi: 'API address not configured.', alertOpenFromBot: 'Open the app from the bot chat in Telegram — otherwise the request cannot be accepted.',
          alertServerSleep: 'Server was slow to wake up. Wait about a minute and tap «Submit request» again.',
          sending: 'Sending…',
          universeHeard: '{name}, the Universe heard your request.\n\nYour sound key is being created and will arrive in this chat when ready.',
          universeHeardCouple: '{name} and {name2}, the Universe heard your request.\n\nYour sound key is being created and will arrive in this chat when ready.',
          universeHeardTransit: '{name}, the Universe heard your request.\n\nYour Day Energy sound key is being created and will arrive in this chat when ready.',
          langSong: 'Song language', langRu: 'Russian', langEn: 'English', langDe: 'German', langFr: 'French', langUk: 'Ukrainian',
          quick1: 'Harmony and self-love', quick2: 'Confidence and purpose', quick3: 'Creative potential', quick4: 'Let go of the past',
          quick5: 'Life balance', quick6: 'Trust and acceptance', quick7: 'Healing and freedom', quick8: 'Path to happiness',
          quick9: 'Strength and overcoming', quick10: 'Depth and silence', quick11: 'Tenderness and care', quick12: 'Humor and lightness',
          quick1t: 'Harmony in relationships and self-love', quick2t: 'Confidence, purpose, and self-reliance',
          quick3t: 'Unlock creative potential without fear', quick4t: 'Let go of the past and open to new possibilities',
          quick5t: 'Balance of work and personal life', quick6t: 'Trust life and release control',
          quick7t: 'Heal childhood wounds and find freedom', quick8t: 'Find your path to happiness and peace',
          quick9t: 'Powerful song about my strength and overcoming', quick10t: 'Meditative song for practice and healing',
          quick11t: 'Warm song about care and tenderness', quick12t: 'Playful song with self-irony about my quirks',
          promoError: 'Could not apply promo code',
          promoCleared: 'Promo code cleared.', promoApplied: 'Promo applied: final amount {amount} {currency}',
          promoAppliedHint: 'Promo {code}: -{amount} {currency}',
          paymentRequiredOpening: 'Payment required. Opening HOT Checkout...',
          promoFreeGen: 'Promo gives free generation. Starting...',
          hotCheckoutOpened: 'HOT Checkout opened. After payment, return to the Mini App — status will update automatically.',
          paymentNotConfirmed: 'Payment not yet confirmed. Check status later or open payment again.',
          paymentConfirmed: 'Payment confirmed. Starting generation...',
          paymentReceivedNoStart: 'Payment received, but auto-start failed. Start generation in admin by request_id: {id}',
          submitFailed: 'Could not submit request. Wait a minute and tap «Submit request» again or reopen the Mini App from the bot chat.',
          errorOp: 'Payment/request operation error',
          alertTransitLocation: 'Enter event location', alertTransitConfirm: 'Confirm the location is correct',
          alertNoApi: 'API address not configured.', alertOpenFromBot: 'Open the app from the bot chat in Telegram — otherwise the request cannot be accepted.',
          alertOpenFromBotShort: 'Open the app from the bot chat in Telegram.',
          alertPaymentFirst: 'First tap «Submit request» on the previous step.',
          alertLinkCopied: 'Link copied. Paste it in Safari or Chrome and open.',
          alertHeroName: 'Enter name', alertError: 'Error', alertDeleteConfirm: 'Delete «{name}»? This action cannot be undone.',
          alertSubmitError: 'Submit error',
          copyLinkPrompt: 'Copy this link and open it in browser:',
          songFormingText: 'Your sound key is being created and will arrive in this chat when ready.',
          heroesLoading: 'Loading...', heroesEmpty: 'No heroes yet. Tap «Add Hero».',
          heroesLoadError: 'Failed to load list. Check API settings.',
          loading: 'Loading…', noCardsYet: 'No completed cards yet', heroHistLoading: 'Loading history…', heroHistEmpty: 'No generations yet', heroHistLoadError: 'Could not load history', heroesPageLoadError: 'Could not load heroes', retry: 'Retry',
          forMyself: 'For myself', forHero: 'For: {name}',
          previewHome: 'Home', previewForm: 'Form', previewPayment: 'Payment', previewLoading: 'Loading', previewSuccess: 'Success',
          supportBtn: 'Contact support',
          subActivated: 'Subscription activated!', subBtnProfile: 'My profile',
          helpPageTitle: 'Help & Support', helpPageSubtitle: 'Everything about YupSoul — clear and simple',
          profileHelpBtn: 'Help & support',
          profilePageTitle: 'Profile', profileSectionMyData: 'My data', profileSectionPlans: 'Plans',
          profileLoadError: 'Could not load subscription. Check your connection.', profileLoadRetry: 'Retry',
          profileEditBtn: 'Edit →', profileBalanceHintText: 'Invite friends — get free tracks',
          profileSectionTracks: 'Single tracks', profileRefTagline: 'Invite friends — earn free songs',
          profileRefInvited: 'Invited', profileRefActivated: 'Activated',
          planCurrentBadge: 'Current', planFreeYours: 'Already yours', planSubscribeBtn: 'Subscribe',
          planDetailsBtn: 'Details', planPopularBadge: '✦ Popular', planMasterBadgeText: 'Master',
          planMasterNameText: 'Laboratory', planOpenMasterBtn: 'Open Laboratory',
          ptiSingleName: 'For myself', ptiSingleDesc: 'Your personality in sound',
          ptiCoupleName: 'For two', ptiCoupleDesc: 'Your bond and resonance',
          ptiTransitName: 'Day energy', ptiTransitDesc: 'A song for today',
          successTitle: 'Request accepted!', successDesc: 'Your song is being generated. When ready — it\'ll arrive in the bot. Usually 10–20 minutes.',
          successHint: 'Not arrived in 20 min? Tell the bot "song not arrived".', successToProfile: 'Go to profile',
          loadingTitle: 'Request accepted',
          heroesPageTitle: 'Laboratory', heroesPromoHeading: 'Master\'s Dashboard',
          heroesPromoDesc: 'Add people once — and generate songs for them in one tap. Full history with lyrics.',
          heroesPromoFeaturesTitle: 'What\'s included:',
          heroesF1: '✦ Unlimited number of people', heroesF2: '✦ Quick solo & duo song generation',
          heroesF3: '✦ Music style preferences', heroesF4: '✦ Full history with lyrics & analysis',
          heroesF5: '✦ Audio straight from the person\'s card',
          heroesTrialBtn: '1 day free — try it out', heroesSubBtn: 'Subscribe to Laboratory — $39.99/mo',
          heroesSubNote: '30 tracks/month · Payment via HOT Pay',
          heroFormTitle: 'Add person', heroRelLabel: 'Relationship', heroBirthdateHint: 'Select day, month and year',
          heroTimeBirthLabel: 'Time of birth', heroStyleLabel: 'Favourite music styles', heroStylePh: 'pop, jazz, electronic…',
          requestPreferredStyleLabel: 'Song style',
          requestPreferredStylePh: 'Song style: pop, R&B, hip‑hop, techno, house, ambient…',
          heroRelOpt0: '— select —', heroRelOpt1: 'Mother', heroRelOpt2: 'Father', heroRelOpt3: 'Daughter', heroRelOpt4: 'Son',
          heroRelOpt5: 'Sister', heroRelOpt6: 'Brother', heroRelOpt7: 'Grandmother', heroRelOpt8: 'Grandfather',
          heroRelOpt9: 'Husband', heroRelOpt10: 'Wife', heroRelOpt11: 'Loved one',
          heroRelOpt12: 'Friend', heroRelOpt13: 'Girlfriend', heroRelOpt14: 'Colleague', heroRelOpt15: 'Mentor', heroRelOpt16: 'Other',
          dateDay: 'Day', dateMonth: 'Month', dateYear: 'Year',
          scLoading: 'Loading…', scPromoIntro: 'Soul Chat is your AI assistant that understands you like a best friend or your Higher Self. Answers questions about your character, purpose and path.',
          scPromoErrorText: 'Temporary loading error. You can choose a plan or buy 24h access.', scPromoRetryBtn: 'Retry',
          scMoreBtnText: 'More ↓', scMoreBtnCollapse: 'Collapse ↑', scStat1: 'report reduced anxiety', scStat2: 'feel understood',
          scStat3: 'find answers faster', scStat4: 'come back again',
          scExamplesTitle: 'Example questions',
          scEx1: '"Why is it so hard for me to talk about my feelings?"', scEx2: '"What is my main fear and how to work with it?"',
          scEx3: '"What is my purpose and how do I get there?"',
          scSubIncluded: 'Soul Chat included in subscription', scChoosePlanBtn: 'Choose a plan →',
          scGiftHeading: 'Try free — 24 hours', scGiftNote: 'One time per user',
          scGiftBtnText: 'Get 24 hours free', scBuyDayNote: 'Not ready for a subscription? Try single access',
          scBuyDayBtnText: 'Open Soul Chat for 24h — $2.99', scToastPaymentReceived: 'Payment received, access granted',
          helpT1: 'What is YupSoul', helpB1: '<p>YupSoul creates a <strong>personal song just for you</strong> — based on your date, time and place of birth. The system analyses your personality and writes a song about your real qualities, path and strength.</p><p>This is not a template — each song is unique and belongs only to you.</p>',
          helpT2: 'What can be created', helpB2: '<ul><li><strong>Song about me</strong> — your personal sonic portrait: who you are, your strength and inner path</li><li><strong>Song for two</strong> — for a couple (lovers, friends). Analyses both charts and reflects the union</li><li><strong>Day energy</strong> — a song for a specific date and place. What opportunities are opening right now</li></ul><p>There are also <strong>quick requests</strong> — ready-made ideas: power song, birthday song, meditative, about letting go of the past, and more.</p>',
          helpT3: 'How long to wait', helpB3: '<p>Usually <strong>5–15 minutes</strong>. The bot will send a notification when your song is ready.</p><p>You can close the app — the result will arrive on its own, nothing will be lost.</p>',
          helpT4: "I don't know my exact birth time", helpB4: '<p>No problem. Check <strong>"Time unknown"</strong> — the system will create a full song based on the other data.</p>',
          helpT5: 'Free generations', helpB5: '<p><strong>The first generation is free.</strong></p><p>Get more free ones through the referral programme: share your link. When 5 of your invited friends create their first song — you automatically receive 1 free generation.</p><p>Your referral link is in the "Profile" section, "Invite a friend" block.</p>',
          helpT6: 'Payment & promo codes', helpB6: '<p>Additional generations are paid according to the tariff. Payment options are shown on screen when placing an order.</p><p>If you have a <strong>promo code</strong> — enter it on the payment screen. Promo codes are case-sensitive.</p>',
          helpT7: 'Something went wrong', helpB7: '<p><strong>App closed or showed an error</strong> — try reopening the bot. Unfinished orders are restored automatically.</p><p><strong>Paid but no song</strong> — wait 15–20 minutes. If nothing arrives — tell the bot "song not arrived". Or contact support.</p><p><strong>Promo code not accepted</strong> — check the letter case. If everything is correct — write to us with the code.</p>',
          profileBalanceLbl: 'Free generations',
          planFreeF1: '✦ 1 free track', planFreeF2: '✦ All formats',
          planBasicF1: '✦ 5 tracks/mo', planBasicF2: '✦ Soul Chat (up to 50 msg/mo)', planBasicF3: '✦ Order history', planBasicSave: '−50% vs singles',
          planPlusF1: '✦ 10 tracks/mo', planPlusF2: '✦ Soul Chat unlimited', planPlusF3: '✦ Priority processing', planPlusF4: '✦ Full track history', planPlusSave: '−58% vs singles',
          planMasterF1: '✦ 30 tracks/mo', planMasterF2: '✦ People directory', planMasterF3: '✦ Generation history', planMasterF4: '✦ Soul Chat unlimited', planMasterSave: '−83% vs singles',
          refFriend1: 'friend', refFriend2: 'friends', refFriend5: 'friends', refLinkLoading: 'Loading…',
          quickPickerLabel: '✦ Quick requests',
          forWhoLabel: 'Who are we generating for?', nameLbl: 'Name', birthdateLbl: 'Date of birth', birthplaceLbl: 'Place of birth', birthtimeLbl: 'Time of birth',
          payOvCardTitleDefault: 'Payment', payOvTrialText: 'First song — free gift!', payOvFreeClaimBtn: 'Get for free',
          payOvPromoToggle: '▸ Have a promo code?', orPay: 'Or pay:', priceLabel: 'Price:',
          payOvLinkHint: "If the window didn't open — copy the link and paste in your browser:",
          payOvCopyBtn: 'Copy payment link', payOvCheckBtn: "I've already paid — verify",
          payOvPromoConfirmBtn: 'Confirm and submit',
          paymentThanksTitle: 'Payment successful', paymentThanksMsg: 'Song is being created. It will arrive in the bot chat. You can close the window.',
          paymentThanksHintText: "Not arrived in 20 minutes? Message the bot 'song not received'"
        },
        de: {
          tagline: 'Musik deiner Seele',
          startBtn: 'Mein Lied erschaffen', myProfile: 'Profil', myHeroes: 'Labor', myHelp: 'Hilfe', admin: 'Admin',
          profileTitle: 'Profil', profileSubtitle: 'Deine Daten und kostenlose Generierungen',
          profileFreeCredits: 'Kostenlose Generierungen', profileInviteFriend: 'Freund einladen', profileShare: 'Teilen',
          profileInvited: 'Eingeladen', profileActivated: 'Aktiviert', profileCreateSong: 'Lied erstellen',
          heroesTitle: 'Labor', heroesSubtitle: 'Personen-Kartei',
          searchByName: 'Suche nach Name', searchPlaceholder: 'Name eingeben...', searchBtn: 'Suchen',
          addHero: '➕ Held hinzufügen', heroName: 'Name *', heroBirthdate: 'Geburtsdatum', heroBirthtime: 'Geburtszeit',
          heroBirthplace: 'Geburtsort', heroBirthplacePh: 'Stadt, Land', heroNotes: 'Notizen', heroNotesPh: 'Klientennotizen',
          unknownTime: 'Exakte Zeit unbekannt', cancel: 'Abbrechen', save: 'Speichern', back: '← Zurück',
          gender: 'Geschlecht', genderSelect: 'Wählen', male: 'Männlich', female: 'Weiblich', other: 'Divers',
          modeType: 'Song-Format', modeSubtitle: 'Für wen erstellen wir?',
          modeSingle: 'Über mich', modeSingleDesc: 'Ein Lied nach deinem Geburtsdatum.',
          modeCouple: 'Über uns zwei', modeCoupleDesc: 'Ein Lied für zwei Menschen.',
          modeTransit: 'Energie<br>des Moments', modeTransitDesc: 'Ein Lied über den heutigen Tag.',
          namePh: 'Wie heißt du?', birthdateLabel: 'Geburtsdatum', birthplacePh: 'Stadt oder Land — wähle aus den Vorschlägen',
          birthplaceHint: 'Stadt eintippen und aus der Liste auswählen.',
          unknownTimeShort: 'Unbekannt', secondPersonTitle: 'Zu zweit', name2Ph: 'Name der zweiten Person',
          birthplace2Ph: 'Geburtsort der zweiten Person', birthtime2Ph: 'Geburtszeit',
          transitTitle: 'Energie des Augenblicks', transitDatePh: 'Ereignisdatum', transitTimePh: 'Ereigniszeit',
          transitLocationPh: 'Stadt für die Momentenergie', transitLocationOk: 'Ort ist korrekt',
          transitIntentPh: 'Absicht für diesen Moment',
          sendRequest: 'Was wirst du heute erkunden?', quickRequests: 'Schnellanfragen', hide: 'Ausblenden',
          requestDesc: 'Worum geht das Lied? Jede Anfrage — von Humor bis tiefe Themen.',
          requestQuickHint: 'Wähle eine Vorlage oder schreib deine eigene',
          requestPh: 'Schreib eine beliebige Anfrage', toPayment: 'Zur Kasse',
          paymentSubtitle: 'Dein Klangschlüssel', paymentAndAccess: 'Zahlung & Zugang',
          paymentIntro: 'Das erste Lied ist gratis. Du kannst Einzelelemente kaufen oder ein Abo für vollen Zugang abschließen.',
          loadingPricing: 'Tarife laden...', currentItem: 'Aktuelles Element',
          promoCode: 'Gutscheincode', apply: 'Anwenden', backFromPayment: '← Zurück',
          submitAndContinue: 'Zur Kasse & weiter', submitRequest: 'Anfrage senden',
          submitHint: 'Das Lied kommt in diesen Chat mit dem Bot. Falls Sie im Bot noch nicht auf «Start» geklickt haben — tun Sie es jetzt.',
          paymentPageIntroAfterSubmit: 'Anfrage gesendet. Gutscheincode eingeben oder unten tippen für Zahlung via HOT Pay.',
          paymentPageTagline: 'Gutscheincode oder Zahlung',
          payWithHot: 'Zahlen via HOT Pay',
          firstFree: 'Dein erster Klangschlüssel ist kostenlos.',
          subscriptionActive: 'Du hast ein aktives Abo — fahre fort.',
          catalogLoadFailed: 'Tarife konnten nicht geladen werden. Tippe «Zur Kasse» — der Backend bestimmt den Preis.',
          paymentRequired: 'Zahlung für neue Anfragen erforderlich.',
          promoApplied: 'Gutschein {code}: -{amount} {currency}',
          creatingKey: 'Dein Schlüssel wird erstellt...',
          creatingKeyDesc: 'Magie passiert in Echtzeit. Dein persönlicher Klangschlüssel wird aus deinen einzigartigen Daten geformt.',
          keyActivated: 'Schlüssel aktiviert!', done: 'Fertig!',
          successText: 'Dein persönlicher Klangschlüssel ist erstellt! Dein einzigartiges Kraftartefakt für das Spiel des Lebens.',
          yourSong: 'Dein Lied',
          songPreviewText: 'Deine einzigartige Komposition wartet im Bot. Höre sie jeden Morgen, um dich auf Erfolg einzustimmen.',
          whatNext: 'Was weiter:', openBot: 'Bot öffnen',
          soulChat: 'Mit deiner Seele sprechen', soulChatPay: 'Zur Kasse — Soul Basic / Soul Plus',
          newKey: 'Weiteren Schlüssel erstellen',
          paymentThanks: 'Danke für die Zahlung', thanksSubtitle: 'Anfrage angenommen', paymentThanksBackToForm: 'Dein Lied erstellen',
          songInProgress: 'Das Lied wird generiert und kommt im Bot-Chat, wenn es fertig ist.',
          songInProgressConfirmed: 'Anfrage angenommen. Lied wird generiert — erneute Zahlung nicht nötig. Es kommt im Bot-Chat, wenn es fertig ist.',
          thanksDone: 'Fertig',
          notFromTelegram: 'Öffne die App aus dem Bot-Chat in Telegram (Menü) — sonst kann die Anfrage nicht gesendet werden.',
          notFound: 'Nicht gefunden', searchError: 'Suchfehler',
          soulChatLoad: 'Laden…',
          soulChatHasAccess: 'Du hast Soul Chat. Tippe unten — der Bot öffnet sich. Im Bot: /soulchat und stelle deiner Seele eine Frage.',
          soulChatNoAccess: 'Soul Chat — Dialoge mit deiner Seele. Mit Soul Basic (bis 50 Nachrichten/Monat) oder Soul Plus (unbegrenzt) Abo.',
          soulChatDefault: 'Soul Chat — Dialoge mit deiner Seele pro Anfrage. Per Abo.',
          soulChatNoApi: 'Soul Chat — Dialoge mit deiner Seele. Mit Soul Basic oder Soul Plus Abo. Gehe zu «Zur Kasse» in der App.',
          greeting: 'Hallo, {name}! Komm zurück, wann immer du dich erinnern willst, wer du bist.',
          greetingDefault: 'Komm zurück, wann immer du dich erinnern willst, wer du bist.',
          onboardingSlide1Title: 'Es gibt ein Lied — über dich',
          onboardingSlide1Text: 'Geschrieben nach deinem Geburtsdatum. Kein Template — ein echter Text über deinen Charakter und Weg.',
          onboardingSlide2Title: 'Nur über dich',
          onboardingSlide2Text: 'Eine smarte Analyse deiner Persönlichkeit wird zu einem lebendigen Lied — einzigartig, nur deins.',
          onboardingSlide3Title: 'Das erste — als Geschenk',
          onboardingSlide3Text: 'Gib dein Geburtsdatum ein. Dein Lied kommt in den Bot-Chat.',
          onboardingBtnStart: 'Mein Lied hören',
          alertNameShort: 'Name muss mindestens 2 Zeichen haben', alertBirthdate: 'Wähle Geburtsdatum',
          alertBirthplace: 'Geburtsort muss mindestens 3 Zeichen haben', alertBirthplaceHint: 'Wähle einen Ort aus den Vorschlägen',
          alertBirthtime: 'Geburtszeit eingeben oder "Unbekannt" wählen', alertGender: 'Geschlecht wählen', alertLanguage: 'Sprache wählen',
          alertName2Short: 'Name der zweiten Person — mindestens 2 Zeichen', alertBirthdate2: 'Geburtsdatum der zweiten Person eingeben',
          alertBirthplace2: 'Geburtsort der zweiten Person muss mindestens 3 Zeichen haben',
          alertBirthtime2: 'Geburtszeit der zweiten Person eingeben', alertGender2: 'Geschlecht der zweiten Person wählen',
          alertTransitDate: 'Ereignisdatum eingeben', alertTransitLocation: 'Ereignisort eingeben', alertTransitConfirm: 'Bestätige, dass der Ort korrekt ist',
          alertRequestShort: 'Anfrage hinzufügen (5+ Zeichen)', alertRequestLong: 'Erzähle dem Universum mehr (mindestens 15 Zeichen)',
          alertYourPath: 'Wähle deinen Weg', alertNoApi: 'API-Adresse nicht konfiguriert.', alertOpenFromBot: 'Öffne die App aus dem Bot-Chat in Telegram — sonst wird die Anfrage nicht angenommen.',
          alertServerSleep: 'Server brauchte etwas zum Aufwachen. Warte etwa eine Minute und tippe erneut auf «Anfrage senden».',
          sending: 'Sende…',
          universeHeard: '{name}, das Universum hat deine Anfrage gehört.\n\nDein Klangschlüssel wird erstellt und kommt in diesen Chat, wenn er fertig ist.',
          universeHeardCouple: '{name} und {name2}, das Universum hat eure Anfrage gehört.\n\nEuer Klangschlüssel wird erstellt und kommt in diesen Chat, wenn er fertig ist.',
          universeHeardTransit: '{name}, das Universum hat deine Anfrage gehört.\n\nDein Tagesenergie-Klangschlüssel wird erstellt und kommt in diesen Chat, wenn er fertig ist.',
          langSong: 'Liedsprache', langRu: 'Russisch', langEn: 'Englisch', langDe: 'Deutsch', langFr: 'Französisch', langUk: 'Ukrainisch',
          quick1: 'Harmonie und Selbstliebe', quick2: 'Selbstvertrauen und Bestimmung', quick3: 'Kreatives Potenzial', quick4: 'Vergangenheit loslassen',
          quick5: 'Lebensbalance', quick6: 'Vertrauen und Akzeptanz', quick7: 'Heilung und Freiheit', quick8: 'Weg zum Glück',
          quick9: 'Kraft und Überwindung', quick10: 'Tiefe und Stille', quick11: 'Zärtlichkeit und Fürsorge', quick12: 'Humor und Leichtigkeit',
          quick1t: 'Harmonie in Beziehungen und Selbstliebe', quick2t: 'Selbstvertrauen, Bestimmung und Selbstständigkeit',
          quick3t: 'Kreatives Potenzial ohne Angst entfalten', quick4t: 'Vergangenheit loslassen und neue Möglichkeiten öffnen',
          quick5t: 'Balance von Arbeit und Privatleben', quick6t: 'Dem Leben vertrauen und Kontrolle loslassen',
          quick7t: 'Kindheitstraumen heilen und Freiheit finden', quick8t: 'Deinen Weg zu Glück und Frieden finden',
          quick9t: 'Kraftvolles Lied über meine Stärke und Überwindung', quick10t: 'Meditatives Lied für Praxis und Heilung',
          quick11t: 'Warmes Lied über Fürsorge und Zärtlichkeit', quick12t: 'Verspieltes Lied mit Selbstironie über meine Eigenheiten',
          promoError: 'Gutscheincode konnte nicht angewendet werden',
          promoCleared: 'Gutscheincode entfernt.', promoApplied: 'Gutschein angewendet: Endsumme {amount} {currency}',
          promoAppliedHint: 'Gutschein {code}: -{amount} {currency}',
          paymentRequiredOpening: 'Zahlung erforderlich. Öffne HOT Checkout...',
          promoFreeGen: 'Gutschein ermöglicht kostenlose Generierung. Starte...',
          hotCheckoutOpened: 'HOT Checkout geöffnet. Nach der Zahlung kehre zur Mini App zurück — der Status wird automatisch aktualisiert.',
          paymentNotConfirmed: 'Zahlung noch nicht bestätigt. Später prüfen oder Zahlung erneut öffnen.',
          paymentConfirmed: 'Zahlung bestätigt. Generierung startet...',
          paymentReceivedNoStart: 'Zahlung erhalten, aber Auto-Start fehlgeschlagen. Starte Generierung in der Admin per request_id: {id}',
          submitFailed: 'Anfrage konnte nicht gesendet werden. Warte eine Minute und tippe erneut auf «Anfrage senden» oder öffne die Mini App neu aus dem Bot-Chat.',
          errorOp: 'Fehler bei Zahlung/Anfrage',
          alertTransitLocation: 'Ereignisort eingeben', alertTransitConfirm: 'Bestätige, dass der Ort korrekt ist',
          alertNoApi: 'API-Adresse nicht konfiguriert.', alertOpenFromBot: 'Öffne die App aus dem Bot-Chat in Telegram — sonst wird die Anfrage nicht angenommen.',
          alertOpenFromBotShort: 'Öffne die App aus dem Bot-Chat in Telegram.',
          alertPaymentFirst: 'Tippe zuerst auf «Anfrage senden» im vorherigen Schritt.',
          alertLinkCopied: 'Link kopiert. Füge ihn in Safari oder Chrome ein und öffne ihn.',
          alertHeroName: 'Name eingeben', alertError: 'Fehler', alertDeleteConfirm: '«{name}» löschen? Diese Aktion kann nicht rückgängig gemacht werden.',
          alertSubmitError: 'Sendefehler',
          copyLinkPrompt: 'Kopiere diesen Link und öffne ihn im Browser:',
          songFormingText: 'Dein Klangschlüssel wird erstellt und kommt in diesen Chat, wenn er fertig ist.',
          heroesLoading: 'Laden...', heroesEmpty: 'Noch keine Helden. Tippe auf «Held hinzufügen».',
          heroesLoadError: 'Liste konnte nicht geladen werden. API-Einstellungen prüfen.',
          loading: 'Laden…', noCardsYet: 'Noch keine abgeschlossenen Karten', heroHistLoading: 'Verlauf wird geladen…', heroHistEmpty: 'Noch keine Generierungen', heroHistLoadError: 'Verlauf konnte nicht geladen werden', heroesPageLoadError: 'Helden konnten nicht geladen werden', retry: 'Wiederholen',
          forMyself: 'Für mich', forHero: 'Für: {name}',
          previewHome: 'Startseite', previewForm: 'Formular', previewPayment: 'Zahlung', previewLoading: 'Laden', previewSuccess: 'Erfolg',
          supportBtn: 'Support kontaktieren',
          subActivated: 'Abo aktiviert!', subBtnProfile: 'Mein Profil',
          helpPageTitle: 'Hilfe & Support', helpPageSubtitle: 'Alles über YupSoul — klar und kurz',
          profileHelpBtn: 'Hilfe & Support',
          profilePageTitle: 'Profil', profileSectionMyData: 'Meine Daten', profileSectionPlans: 'Tarife',
          profileLoadError: 'Abo konnte nicht geladen werden. Verbindung prüfen.', profileLoadRetry: 'Wiederholen',
          profileEditBtn: 'Bearbeiten →', profileBalanceHintText: 'Freunde einladen — Gratistracks erhalten',
          profileSectionTracks: 'Einzeltracks', profileRefTagline: 'Freunde einladen — kostenlose Songs erhalten',
          profileRefInvited: 'Eingeladen', profileRefActivated: 'Aktiviert',
          planCurrentBadge: 'Aktuell', planFreeYours: 'Bereits deins', planSubscribeBtn: 'Abonnieren',
          planDetailsBtn: 'Details', planPopularBadge: '✦ Beliebt', planMasterBadgeText: 'Meister',
          planMasterNameText: 'Labor', planOpenMasterBtn: 'Labor öffnen',
          ptiSingleName: 'Für mich', ptiSingleDesc: 'Deine Persönlichkeit im Klang',
          ptiCoupleName: 'Für zwei', ptiCoupleDesc: 'Eure Verbindung und Resonanz',
          ptiTransitName: 'Tagesenergie', ptiTransitDesc: 'Ein Lied für heute',
          successTitle: 'Anfrage angenommen!', successDesc: 'Dein Song wird erstellt. Wenn er fertig ist — kommt er im Bot an. Normalerweise 10–20 Minuten.',
          successHint: 'Nicht angekommen nach 20 Min? Schreib dem Bot "Song nicht angekommen".', successToProfile: 'Zum Profil',
          loadingTitle: 'Anfrage angenommen',
          heroesPageTitle: 'Labor', heroesPromoHeading: 'Meister-Dashboard',
          heroesPromoDesc: 'Personen einmal hinzufügen — und Songs für sie in einem Tipp erstellen. Komplette Geschichte mit Texten.',
          heroesPromoFeaturesTitle: 'Was ist enthalten:',
          heroesF1: '✦ Unbegrenzte Personenanzahl', heroesF2: '✦ Schnelle Solo- & Duo-Song-Erstellung',
          heroesF3: '✦ Musikstil-Präferenzen', heroesF4: '✦ Komplette Geschichte mit Texten & Analyse',
          heroesF5: '✦ Audio direkt aus der Personenkarte',
          heroesTrialBtn: '1 Tag kostenlos — ausprobieren', heroesSubBtn: 'Labor abonnieren — $39.99/Mon.',
          heroesSubNote: '30 Tracks/Monat · Zahlung via HOT Pay',
          heroFormTitle: 'Person hinzufügen', heroRelLabel: 'Beziehung', heroBirthdateHint: 'Tag, Monat und Jahr wählen',
          heroTimeBirthLabel: 'Geburtszeit', heroStyleLabel: 'Lieblingsmusikstile', heroStylePh: 'Pop, Jazz, Elektronisch…',
          requestPreferredStyleLabel: 'Song-Stil',
          requestPreferredStylePh: 'Song-Stil: Pop, Soul, R&B, Hip‑Hop, Techno, House, Ambient…',
          heroRelOpt0: '— auswählen —', heroRelOpt1: 'Mutter', heroRelOpt2: 'Vater', heroRelOpt3: 'Tochter', heroRelOpt4: 'Sohn',
          heroRelOpt5: 'Schwester', heroRelOpt6: 'Bruder', heroRelOpt7: 'Großmutter', heroRelOpt8: 'Großvater',
          heroRelOpt9: 'Ehemann', heroRelOpt10: 'Ehefrau', heroRelOpt11: 'Geliebte Person',
          heroRelOpt12: 'Freund', heroRelOpt13: 'Freundin', heroRelOpt14: 'Kollege', heroRelOpt15: 'Mentor', heroRelOpt16: 'Anderes',
          dateDay: 'Tag', dateMonth: 'Monat', dateYear: 'Jahr',
          scLoading: 'Lade…', scPromoIntro: 'Soul Chat ist dein KI-Assistent, der dich versteht wie ein bester Freund oder dein Höheres Selbst. Beantwortet Fragen zu Charakter, Bestimmung und Weg.',
          scPromoErrorText: 'Temporärer Lade Fehler. Du kannst einen Tarif wählen oder 24h-Zugang kaufen.', scPromoRetryBtn: 'Wiederholen',
          scMoreBtnText: 'Mehr ↓', scMoreBtnCollapse: 'Einklappen ↑', scStat1: 'berichten von weniger Angst', scStat2: 'fühlen sich verstanden',
          scStat3: 'finden Antworten schneller', scStat4: 'kommen wieder',
          scExamplesTitle: 'Beispielfragen',
          scEx1: '„Warum fällt es mir so schwer, über meine Gefühle zu reden?"', scEx2: '„Was ist meine größte Angst und wie gehe ich damit um?"',
          scEx3: '„Was ist mein Lebensweg und wie komme ich dahin?"',
          scSubIncluded: 'Soul Chat im Abo enthalten', scChoosePlanBtn: 'Tarif wählen →',
          scGiftHeading: 'Kostenlos testen — 24 Stunden', scGiftNote: 'Einmalig pro Nutzer',
          scGiftBtnText: '24 Stunden kostenlos', scBuyDayNote: 'Noch nicht bereit für ein Abo? Teste den Einzelzugang',
          scBuyDayBtnText: 'Soul Chat 24h öffnen — $2.99', scToastPaymentReceived: 'Zahlung erhalten, Zugang aktiv',
          helpT1: 'Was ist YupSoul', helpB1: '<p>YupSoul erstellt ein <strong>persönliches Lied genau für dich</strong> — basierend auf Datum, Uhrzeit und Geburtsort. Das System analysiert deine Persönlichkeit und schreibt ein Lied über deine echten Qualitäten, Weg und Stärke.</p><p>Dies ist kein Template — jedes Lied ist einzigartig und gehört nur dir.</p>',
          helpT2: 'Was kann erstellt werden', helpB2: '<ul><li><strong>Lied über mich</strong> — dein persönliches Klangportrait: wer du bist, deine Stärke und innerer Weg</li><li><strong>Lied für zwei</strong> — für ein Paar (Verliebte, Freunde). Analysiert beide Karten und spiegelt die Verbindung wider</li><li><strong>Tagesenergie</strong> — ein Lied für ein bestimmtes Datum und Ort. Welche Möglichkeiten öffnen sich gerade jetzt</li></ul><p>Es gibt auch <strong>Schnellanfragen</strong> — fertige Ideen: Kraftlied, Geburtstagslied, meditativ, über das Loslassen der Vergangenheit und mehr.</p>',
          helpT3: 'Wie lange warten', helpB3: '<p>Normalerweise <strong>5–15 Minuten</strong>. Der Bot schickt eine Benachrichtigung, wenn dein Lied fertig ist.</p><p>Du kannst die App schließen — das Ergebnis kommt von selbst, nichts geht verloren.</p>',
          helpT4: 'Ich kenne meine genaue Geburtszeit nicht', helpB4: '<p>Kein Problem. Wähle <strong>„Zeit unbekannt"</strong> — das System erstellt ein vollständiges Lied anhand der anderen Daten.</p>',
          helpT5: 'Kostenlose Generierungen', helpB5: '<p><strong>Die erste Generierung ist kostenlos.</strong></p><p>Weitere kostenlose gibt es über das Empfehlungsprogramm: Teile deinen Link. Wenn 5 deiner eingeladenen Freunde ihr erstes Lied erstellen — erhältst du automatisch 1 kostenlose Generierung.</p><p>Dein Empfehlungslink ist im Bereich „Profil", Block „Freund einladen".</p>',
          helpT6: 'Zahlung & Gutscheincodes', helpB6: '<p>Zusätzliche Generierungen werden nach Tarif bezahlt. Zahlungsoptionen werden beim Aufgeben einer Bestellung angezeigt.</p><p>Wenn du einen <strong>Gutscheincode</strong> hast — gib ihn auf dem Zahlungsbildschirm ein. Codes sind Groß-/Kleinschreibung-sensitiv.</p>',
          helpT7: 'Etwas ist schiefgelaufen', helpB7: '<p><strong>App geschlossen oder Fehler</strong> — versuche den Bot neu zu öffnen. Unfertige Bestellungen werden automatisch wiederhergestellt.</p><p><strong>Bezahlt aber kein Lied</strong> — warte 15–20 Minuten. Wenn nichts kommt — schreib dem Bot „Lied nicht angekommen". Oder kontaktiere den Support.</p><p><strong>Gutscheincode nicht akzeptiert</strong> — Groß-/Kleinschreibung prüfen. Falls alles korrekt — schreib uns mit dem Code.</p>',
          profileBalanceLbl: 'Kostenlose Generierungen',
          planFreeF1: '✦ 1 kostenloses Lied', planFreeF2: '✦ Alle Formate',
          planBasicF1: '✦ 5 Lieder/Mo.', planBasicF2: '✦ Soul Chat (bis 50 Nachr./Mo.)', planBasicF3: '✦ Bestellhistorie', planBasicSave: '−50% vs Einzelkauf',
          planPlusF1: '✦ 10 Lieder/Mo.', planPlusF2: '✦ Soul Chat unbegrenzt', planPlusF3: '✦ Prioritätsverarbeitung', planPlusF4: '✦ Vollständige Titel-Historie', planPlusSave: '−58% vs Einzelkauf',
          planMasterF1: '✦ 30 Lieder/Mo.', planMasterF2: '✦ Personenverzeichnis', planMasterF3: '✦ Generierungshistorie', planMasterF4: '✦ Soul Chat unbegrenzt', planMasterSave: '−83% vs Einzelkauf',
          refFriend1: 'Freund', refFriend2: 'Freunde', refFriend5: 'Freunde', refLinkLoading: 'Laden…',
          quickPickerLabel: '✦ Schnellanfragen',
          forWhoLabel: 'Für wen generieren wir?', nameLbl: 'Name', birthdateLbl: 'Geburtsdatum', birthplaceLbl: 'Geburtsort', birthtimeLbl: 'Geburtszeit',
          payOvCardTitleDefault: 'Zahlung', payOvTrialText: 'Erstes Lied — Geschenk!', payOvFreeClaimBtn: 'Kostenlos erhalten',
          payOvPromoToggle: '▸ Haben Sie einen Code?', orPay: 'Oder bezahle:', priceLabel: 'Preis:',
          payOvLinkHint: 'Wenn sich das Fenster nicht öffnete — Link kopieren und im Browser einfügen:',
          payOvCopyBtn: 'Zahlungslink kopieren', payOvCheckBtn: 'Ich habe bezahlt — prüfen',
          payOvPromoConfirmBtn: 'Bestätigen und senden',
          paymentThanksTitle: 'Zahlung erfolgreich', paymentThanksMsg: 'Lied wird erstellt. Kommt im Bot-Chat an. Fenster kann geschlossen werden.',
          paymentThanksHintText: 'Nicht in 20 Min. angekommen? Schreib dem Bot „Lied nicht angekommen"'
        },
        fr: {
          tagline: 'La musique de ton âme',
          startBtn: 'Créer ma chanson', myProfile: 'Profil', myHeroes: 'Labo', myHelp: 'Aide', admin: 'Admin',
          profileTitle: 'Profil', profileSubtitle: 'Tes données et générations gratuites',
          profileFreeCredits: 'Générations gratuites', profileInviteFriend: 'Inviter un ami', profileShare: 'Partager',
          profileInvited: 'Invités', profileActivated: 'Activés', profileCreateSong: 'Créer une chanson',
          heroesTitle: 'Laboratoire', heroesSubtitle: 'Répertoire des personnes',
          searchByName: 'Rechercher par nom', searchPlaceholder: 'Entrer le nom...', searchBtn: 'Rechercher',
          addHero: '➕ Ajouter un héros', heroName: 'Nom *', heroBirthdate: 'Date de naissance', heroBirthtime: 'Heure de naissance',
          heroBirthplace: 'Lieu de naissance', heroBirthplacePh: 'Ville, pays', heroNotes: 'Notes', heroNotesPh: 'Notes client',
          unknownTime: "Heure exacte inconnue", cancel: 'Annuler', save: 'Enregistrer', back: '← Retour',
          gender: 'Genre', genderSelect: 'Choisir', male: 'Homme', female: 'Femme', other: 'Autre',
          modeType: "Format de chanson", modeSubtitle: 'Pour qui créons-nous ?',
          modeSingle: 'À mon sujet', modeSingleDesc: 'Une chanson selon ta date de naissance.',
          modeCouple: 'Nous deux', modeCoupleDesc: 'Une chanson pour deux personnes.',
          modeTransit: "Énergie<br>du moment", modeTransitDesc: "Une chanson sur la journée d'aujourd'hui.",
          namePh: "Comment tu t'appelles ?", birthdateLabel: 'Date de naissance', birthplacePh: 'Ville ou pays — choisis parmi les suggestions',
          birthplaceHint: 'Tape ta ville et choisis dans la liste.',
          unknownTimeShort: 'Inconnu', secondPersonTitle: 'À deux', name2Ph: "Nom de la deuxième personne",
          birthplace2Ph: "Lieu de naissance de la deuxième personne", birthtime2Ph: 'Heure de naissance',
          transitTitle: "Énergie du moment", transitDatePh: 'Date de l\'événement', transitTimePh: "Heure de l'événement",
          transitLocationPh: 'Ville pour l\'énergie du moment', transitLocationOk: 'Le lieu est correct',
          transitIntentPh: 'Intention pour ce moment',
          sendRequest: 'Que vas-tu explorer aujourd\'hui ?', quickRequests: 'Demandes rapides', hide: 'Masquer',
          requestDesc: 'De quoi parle la chanson ? Toute demande — de l\'humour aux thèmes profonds.',
          requestQuickHint: 'Choisis une demande prête ou écris la tienne',
          requestPh: 'Écris n\'importe quelle demande', toPayment: 'Paiement',
          paymentSubtitle: 'Ta clé sonore', paymentAndAccess: 'Paiement et accès',
          paymentIntro: 'La première chanson est offerte. Tu peux payer des éléments individuels ou t\'abonner pour un accès complet.',
          loadingPricing: 'Chargement des tarifs...', currentItem: 'Élément actuel',
          promoCode: 'Code promo', apply: 'Appliquer', backFromPayment: '← Retour',
          submitAndContinue: 'Payer et continuer', submitRequest: 'Envoyer la demande',
          submitHint: 'La chanson arrivera dans ce chat avec le bot. Si vous n\'avez pas encore appuyé sur «Démarrer» dans le bot — faites-le maintenant.',
          paymentPageIntroAfterSubmit: 'Demande envoyée. Entre le code promo ou appuie ci-dessous pour payer via HOT Pay.',
          paymentPageTagline: 'Code promo ou paiement',
          payWithHot: 'Payer via HOT Pay',
          firstFree: 'Ta première clé sonore est gratuite.',
          subscriptionActive: 'Tu as un abonnement actif — continue.',
          catalogLoadFailed: 'Tarifs non chargés. Appuie sur «Payer» — le backend déterminera le prix.',
          paymentRequired: 'Paiement requis pour les nouvelles demandes.',
          promoApplied: 'Code promo {code}: -{amount} {currency}',
          creatingKey: 'Création de ta clé...',
          creatingKeyDesc: 'La magie opère en temps réel. Ta clé sonore personnelle se forme à partir de tes données uniques.',
          keyActivated: 'Clé activée !', done: 'Terminé !',
          successText: 'Ta clé sonore personnelle est créée ! Ton artefact unique de force pour le jeu de la vie.',
          yourSong: 'Ta chanson',
          songPreviewText: 'Ta composition unique t\'attend dans le bot. Écoute-la chaque matin pour te mettre sur la voie du succès.',
          whatNext: 'Et après :', openBot: 'Ouvre le bot',
          soulChat: 'Parler à ton âme', soulChatPay: 'Paiement — Soul Basic / Soul Plus',
          newKey: 'Créer une autre clé',
          paymentThanks: 'Merci pour le paiement', thanksSubtitle: 'demande acceptée', paymentThanksBackToForm: 'Créer ta chanson',
          songInProgress: 'La chanson est en cours de génération et arrivera dans le chat du bot quand elle sera prête.',
          songInProgressConfirmed: 'Demande acceptée. Chanson en génération — pas besoin de payer à nouveau. Elle arrivera dans le chat du bot quand elle sera prête.',
          thanksDone: 'Terminé',
          notFromTelegram: 'Ouvre l\'app depuis le chat du bot dans Telegram (bouton menu) — sinon la demande ne peut pas être envoyée.',
          notFound: 'Non trouvé', searchError: 'Erreur de recherche',
          soulChatLoad: 'Chargement…',
          soulChatHasAccess: "Tu as accès à Soul Chat. Appuie ci-dessous — le bot s'ouvrira. Dans le bot, tape /soulchat et pose une question à ton âme.",
          soulChatNoAccess: 'Soul Chat — dialogues avec ton âme. Avec abonnement Soul Basic (jusqu\'à 50 messages/mois) ou Soul Plus (illimité).',
          soulChatDefault: 'Soul Chat — dialogues avec ton âme par demande. Sur abonnement.',
          soulChatNoApi: 'Soul Chat — dialogues avec ton âme. Avec abonnement Soul Basic ou Soul Plus. Va dans «Paiement» dans l\'app.',
          greeting: 'Salut, {name} ! Reviens quand tu veux te souvenir de qui tu es.',
          greetingDefault: 'Reviens quand tu veux te souvenir de qui tu es.',
          onboardingSlide1Title: 'Il y a une chanson — sur toi',
          onboardingSlide1Text: 'Écrite selon ta date de naissance. Pas un modèle — un vrai texte sur ton caractère et ton chemin.',
          onboardingSlide2Title: 'Seulement sur toi',
          onboardingSlide2Text: 'Une analyse intelligente de ta personnalité devient une chanson vivante — unique, rien qu\'à toi.',
          onboardingSlide3Title: 'La première — en cadeau',
          onboardingSlide3Text: 'Saisis ta date de naissance. Ta chanson arrivera dans le chat du bot.',
          onboardingBtnStart: 'Recevoir ma chanson',
          alertNameShort: 'Le nom doit contenir au moins 2 caractères', alertBirthdate: 'Choisis la date de naissance',
          alertBirthplace: 'Le lieu de naissance doit contenir au moins 3 caractères', alertBirthplaceHint: 'Choisis un lieu dans les suggestions',
          alertBirthtime: 'Entre l\'heure de naissance ou coche "Inconnu"', alertGender: 'Choisis le genre', alertLanguage: 'Choisis la langue',
          alertName2Short: 'Le nom de la 2e personne — au moins 2 caractères', alertBirthdate2: 'Entre la date de naissance de la 2e personne',
          alertBirthplace2: 'Le lieu de naissance de la 2e personne doit contenir au moins 3 caractères',
          alertBirthtime2: 'Entre l\'heure de naissance de la 2e personne', alertGender2: 'Choisis le genre de la 2e personne',
          alertTransitDate: 'Entre la date de l\'événement', alertTransitLocation: 'Entre le lieu de l\'événement', alertTransitConfirm: 'Confirme que le lieu est correct',
          alertRequestShort: 'Ajoute une demande (5+ caractères)', alertRequestLong: 'Dis-en plus à l\'Univers (au moins 15 caractères)',
          alertYourPath: 'Choisis ton chemin', alertNoApi: 'Adresse API non configurée.', alertOpenFromBot: 'Ouvre l\'app depuis le chat du bot dans Telegram — sinon la demande ne peut pas être acceptée.',
          alertServerSleep: 'Le serveur s\'est réveillé lentement. Attends environ une minute et appuie à nouveau sur «Envoyer la demande».',
          sending: 'Envoi…',
          universeHeard: '{name}, l\'Univers a entendu ta demande.\n\nTa clé sonore est en cours de création et arrivera dans ce chat quand elle sera prête.',
          universeHeardCouple: '{name} et {name2}, l\'Univers a entendu votre demande.\n\nVotre clé sonore est en cours de création et arrivera dans ce chat quand elle sera prête.',
          universeHeardTransit: '{name}, l\'Univers a entendu ta demande.\n\nTa clé sonore Énergie du jour est en cours de création et arrivera dans ce chat quand elle sera prête.',
          langSong: 'Langue de la chanson', langRu: 'Russe', langEn: 'Anglais', langDe: 'Allemand', langFr: 'Français', langUk: 'Ukrainien',
          quick1: 'Harmonie et amour de soi', quick2: 'Confiance et but', quick3: 'Potentiel créatif', quick4: 'Lâcher le passé',
          quick5: 'Équilibre de vie', quick6: 'Confiance et acceptation', quick7: 'Guérison et liberté', quick8: 'Chemin vers le bonheur',
          quick9: 'Force et dépassement', quick10: 'Profondeur et silence', quick11: 'Tendresse et soin', quick12: 'Humor et légèreté',
          quick1t: 'Harmonie dans les relations et amour de soi', quick2t: 'Confiance, but et autonomie',
          quick3t: 'Libérer ton potentiel créatif sans peur', quick4t: 'Lâcher le passé et ouvrir de nouvelles possibilités',
          quick5t: 'Équilibre travail et vie personnelle', quick6t: 'Faire confiance à la vie et lâcher le contrôle',
          quick7t: 'Guérir les blessures d\'enfance et trouver la liberté', quick8t: 'Trouver ton chemin vers le bonheur et la paix',
          quick9t: 'Chanson puissante sur ma force et mon dépassement', quick10t: 'Chanson méditative pour la pratique et la guérison',
          quick11t: 'Chanson chaleureuse sur le soin et la tendresse', quick12t: 'Chanson ludique avec auto-ironie sur mes travers',
          promoError: 'Code promo non appliqué',
          promoCleared: 'Code promo effacé.', promoApplied: 'Code promo appliqué: montant final {amount} {currency}',
          promoAppliedHint: 'Code promo {code}: -{amount} {currency}',
          paymentRequiredOpening: 'Paiement requis. Ouverture de HOT Checkout...',
          promoFreeGen: 'Le code promo donne une génération gratuite. Démarrage...',
          hotCheckoutOpened: 'HOT Checkout ouvert. Après paiement, reviens dans la Mini App — le statut se mettra à jour automatiquement.',
          paymentNotConfirmed: 'Paiement pas encore confirmé. Vérifie plus tard ou rouvre le paiement.',
          paymentConfirmed: 'Paiement confirmé. Démarrage de la génération...',
          paymentReceivedNoStart: 'Paiement reçu, mais démarrage auto échoué. Lance la génération dans l\'admin par request_id: {id}',
          submitFailed: 'Demande non envoyée. Attends une minute et appuie à nouveau sur «Envoyer la demande» ou rouvre la Mini App depuis le chat du bot.',
          errorOp: 'Erreur opération paiement/demande',
          alertTransitLocation: 'Entre le lieu de l\'événement', alertTransitConfirm: 'Confirme que le lieu est correct',
          alertNoApi: 'Adresse API non configurée.', alertOpenFromBot: 'Ouvre l\'app depuis le chat du bot dans Telegram — sinon la demande ne peut pas être acceptée.',
          alertOpenFromBotShort: 'Ouvre l\'app depuis le chat du bot dans Telegram.',
          alertPaymentFirst: 'Appuie d\'abord sur «Envoyer la demande» à l\'étape précédente.',
          alertLinkCopied: 'Lien copié. Colle-le dans Safari ou Chrome et ouvre-le.',
          alertHeroName: 'Entre le nom', alertError: 'Erreur', alertDeleteConfirm: 'Supprimer «{name}» ? Cette action ne peut pas être annulée.',
          alertSubmitError: 'Erreur d\'envoi',
          copyLinkPrompt: 'Copie ce lien et ouvre-le dans le navigateur:',
          songFormingText: 'Ta clé sonore est en cours de création et arrivera dans ce chat quand elle sera prête.',
          heroesLoading: 'Chargement...', heroesEmpty: 'Pas encore de héros. Appuie sur «Ajouter un héros».',
          heroesLoadError: 'Impossible de charger la liste. Vérifier les paramètres API.',
          loading: 'Chargement…', noCardsYet: 'Pas encore de cartes terminées', heroHistLoading: 'Chargement de l\'historique…', heroHistEmpty: 'Pas encore de générations', heroHistLoadError: 'Impossible de charger l\'historique', heroesPageLoadError: 'Impossible de charger les héros', retry: 'Réessayer',
          forMyself: 'Pour moi', forHero: 'Pour: {name}',
          previewHome: 'Accueil', previewForm: 'Formulaire', previewPayment: 'Paiement', previewLoading: 'Chargement', previewSuccess: 'Succès',
          supportBtn: 'Contacter le support',
          subActivated: 'Abonnement activé !', subBtnProfile: 'Mon profil',
          helpPageTitle: 'Aide & Support', helpPageSubtitle: 'Tout sur YupSoul — simple et concis',
          profileHelpBtn: 'Aide & support',
          profilePageTitle: 'Profil', profileSectionMyData: 'Mes données', profileSectionPlans: 'Abonnements',
          profileLoadError: 'Impossible de charger l\'abonnement. Vérifie ta connexion.', profileLoadRetry: 'Réessayer',
          profileEditBtn: 'Modifier →', profileBalanceHintText: 'Invite des amis — reçois des titres gratuits',
          profileSectionTracks: 'Titres individuels', profileRefTagline: 'Invite des amis — gagne des chansons gratuites',
          profileRefInvited: 'Invités', profileRefActivated: 'Activés',
          planCurrentBadge: 'Actuel', planFreeYours: 'Déjà le tien', planSubscribeBtn: "S'abonner",
          planDetailsBtn: 'Détails', planPopularBadge: '✦ Populaire', planMasterBadgeText: 'Maître',
          planMasterNameText: 'Laboratoire', planOpenMasterBtn: 'Ouvrir le Laboratoire',
          ptiSingleName: 'Pour moi', ptiSingleDesc: 'Ta personnalité en sons',
          ptiCoupleName: 'Pour deux', ptiCoupleDesc: 'Votre lien et résonance',
          ptiTransitName: "Énergie du jour", ptiTransitDesc: "Une chanson pour aujourd'hui",
          successTitle: 'Demande acceptée !', successDesc: "Ta chanson est en cours de création. Quand elle sera prête — elle arrivera dans le bot. Généralement 10–20 minutes.",
          successHint: 'Pas reçue en 20 min ? Dis au bot « chanson non reçue ».', successToProfile: 'Aller au profil',
          loadingTitle: 'Demande acceptée',
          heroesPageTitle: 'Laboratoire', heroesPromoHeading: 'Espace Maître',
          heroesPromoDesc: "Ajoute des personnes une fois — et génère des chansons pour elles en un tap. Historique complet avec paroles.",
          heroesPromoFeaturesTitle: 'Ce qui est inclus :',
          heroesF1: '✦ Nombre illimité de personnes', heroesF2: '✦ Génération solo & duo rapide',
          heroesF3: '✦ Préférences de style musical', heroesF4: '✦ Historique complet avec paroles & analyse',
          heroesF5: '✦ Audio directement depuis la fiche personne',
          heroesTrialBtn: '1 jour gratuit — essayer', heroesSubBtn: "S'abonner au Laboratoire — $39.99/mois",
          heroesSubNote: '30 titres/mois · Paiement via HOT Pay',
          heroFormTitle: 'Ajouter une personne', heroRelLabel: 'Relation', heroBirthdateHint: 'Sélectionne jour, mois et année',
          heroTimeBirthLabel: 'Heure de naissance', heroStyleLabel: 'Styles musicaux préférés', heroStylePh: 'pop, jazz, électronique…',
          requestPreferredStyleLabel: 'Style de la chanson',
          requestPreferredStylePh: "Style de la chanson : pop, soul, R&B, hip‑hop, techno, house, ambient…",
          heroRelOpt0: '— choisir —', heroRelOpt1: 'Mère', heroRelOpt2: 'Père', heroRelOpt3: 'Fille', heroRelOpt4: 'Fils',
          heroRelOpt5: 'Sœur', heroRelOpt6: 'Frère', heroRelOpt7: 'Grand-mère', heroRelOpt8: 'Grand-père',
          heroRelOpt9: 'Mari', heroRelOpt10: 'Femme', heroRelOpt11: 'Être aimé',
          heroRelOpt12: 'Ami', heroRelOpt13: 'Amie', heroRelOpt14: 'Collègue', heroRelOpt15: 'Mentor', heroRelOpt16: 'Autre',
          dateDay: 'Jour', dateMonth: 'Mois', dateYear: 'Année',
          scLoading: 'Chargement…', scPromoIntro: "Soul Chat est ton assistant IA qui te comprend comme un meilleur ami ou ton Moi Supérieur. Répond aux questions sur ton caractère, ta vocation et ton chemin.",
          scPromoErrorText: 'Erreur de chargement temporaire. Tu peux choisir un abonnement ou acheter 24h.', scPromoRetryBtn: 'Réessayer',
          scMoreBtnText: 'Plus ↓', scMoreBtnCollapse: 'Réduire ↑', scStat1: "signalent moins d'anxiété", scStat2: 'se sentent compris',
          scStat3: 'trouvent des réponses plus vite', scStat4: 'reviennent',
          scExamplesTitle: 'Exemples de questions',
          scEx1: '« Pourquoi est-il si difficile pour moi de parler de mes sentiments ? »', scEx2: '« Quelle est ma principale peur et comment y faire face ? »',
          scEx3: '« Quelle est ma vocation et comment y parvenir ? »',
          scSubIncluded: "Soul Chat inclus dans l'abonnement", scChoosePlanBtn: 'Choisir un abonnement →',
          scGiftHeading: 'Essayer gratuitement — 24 heures', scGiftNote: 'Une fois par utilisateur',
          scGiftBtnText: 'Obtenir 24 heures gratuitement', scBuyDayNote: "Pas prêt pour un abonnement ? Essaie l'accès individuel",
          scBuyDayBtnText: 'Ouvrir Soul Chat 24h — $2.99', scToastPaymentReceived: 'Paiement reçu, accès activé',
          helpT1: 'Qu\'est-ce que YupSoul', helpB1: '<p>YupSoul crée une <strong>chanson personnelle rien que pour toi</strong> — basée sur ta date, heure et lieu de naissance. Le système analyse ta personnalité et écrit une chanson sur tes vraies qualités, ton chemin et ta force.</p><p>Ce n\'est pas un modèle — chaque chanson est unique et t\'appartient.</p>',
          helpT2: 'Ce qu\'on peut créer', helpB2: '<ul><li><strong>Chanson sur moi</strong> — ton portrait sonore personnel : qui tu es, ta force et ton chemin intérieur</li><li><strong>Chanson pour deux</strong> — pour un couple (amoureux, amis). Analyse les deux cartes et reflète l\'union</li><li><strong>Énergie du jour</strong> — une chanson pour une date et un lieu précis. Quelles opportunités s\'ouvrent en ce moment</li></ul><p>Il y a aussi des <strong>requêtes rapides</strong> — idées prêtes : chanson de force, d\'anniversaire, méditative, sur le lâcher-prise, et plus.</p>',
          helpT3: 'Combien de temps attendre', helpB3: '<p>Généralement <strong>5–15 minutes</strong>. Le bot enverra une notification quand ta chanson sera prête.</p><p>Tu peux fermer l\'appli — le résultat arrivera tout seul, rien ne sera perdu.</p>',
          helpT4: 'Je ne connais pas mon heure de naissance exacte', helpB4: '<p>Pas de problème. Coche <strong>« Heure inconnue »</strong> — le système créera une chanson complète avec les autres données.</p>',
          helpT5: 'Générations gratuites', helpB5: '<p><strong>La première génération est gratuite.</strong></p><p>Obtiens-en d\'autres gratuitement via le programme de parrainage : partage ton lien. Quand 5 de tes amis invités créent leur première chanson — tu reçois automatiquement 1 génération gratuite.</p><p>Ton lien de parrainage est dans la section « Profil », bloc « Inviter un ami ».</p>',
          helpT6: 'Paiement & codes promo', helpB6: '<p>Les générations supplémentaires sont payantes selon le tarif. Les options de paiement s\'affichent lors de la commande.</p><p>Si tu as un <strong>code promo</strong> — saisis-le sur l\'écran de paiement. Les codes sont sensibles à la casse.</p>',
          helpT7: 'Quelque chose a mal tourné', helpB7: '<p><strong>L\'appli s\'est fermée ou a affiché une erreur</strong> — essaie de rouvrir le bot. Les commandes inachevées sont restaurées automatiquement.</p><p><strong>Payé mais pas de chanson</strong> — attends 15–20 minutes. Si rien n\'arrive — dis au bot « chanson non reçue ». Ou contacte le support.</p><p><strong>Code promo non accepté</strong> — vérifie la casse. Si tout est correct — écris-nous avec le code.</p>',
          profileBalanceLbl: 'Générations gratuites',
          planFreeF1: '✦ 1 chanson gratuite', planFreeF2: '✦ Tous les formats',
          planBasicF1: '✦ 5 titres/mois', planBasicF2: '✦ Soul Chat (50 messages/mois)', planBasicF3: '✦ Historique commandes', planBasicSave: '−50% vs séparés',
          planPlusF1: '✦ 10 titres/mois', planPlusF2: '✦ Soul Chat illimité', planPlusF3: '✦ Traitement prioritaire', planPlusF4: '✦ Historique complet', planPlusSave: '−58% vs séparés',
          planMasterF1: '✦ 30 titres/mois', planMasterF2: '✦ Répertoire de personnes', planMasterF3: '✦ Historique des générations', planMasterF4: '✦ Soul Chat illimité', planMasterSave: '−83% vs séparés',
          refFriend1: 'ami', refFriend2: 'amis', refFriend5: 'amis', refLinkLoading: 'Chargement…',
          quickPickerLabel: '✦ Demandes rapides',
          forWhoLabel: 'Pour qui générons-nous?', nameLbl: 'Prénom', birthdateLbl: 'Date de naissance', birthplaceLbl: 'Lieu de naissance', birthtimeLbl: 'Heure de naissance',
          payOvCardTitleDefault: 'Paiement', payOvTrialText: 'Première chanson — cadeau!', payOvFreeClaimBtn: 'Obtenir gratuitement',
          payOvPromoToggle: '▸ Vous avez un code promo?', orPay: 'Ou payez:', priceLabel: 'Prix:',
          payOvLinkHint: "Si la fenêtre ne s'est pas ouverte — copiez le lien et collez dans votre navigateur:",
          payOvCopyBtn: 'Copier le lien de paiement', payOvCheckBtn: "J'ai déjà payé — vérifier",
          payOvPromoConfirmBtn: 'Confirmer et envoyer',
          paymentThanksTitle: 'Paiement effectué', paymentThanksMsg: 'Chanson en cours de création. Arrivera dans le chat du bot. Vous pouvez fermer.',
          paymentThanksHintText: "Pas arrivée en 20 min? Écrivez au bot «chanson non reçue»"
        }
      };
      var currentLang = 'ru';
      function detectLang() {
        try {
          var stored = localStorage.getItem(LANG_STORAGE_KEY);
          if (stored === 'ru' || stored === 'en' || stored === 'de' || stored === 'fr') return stored;
          var lc = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.language_code) || (typeof navigator !== 'undefined' && navigator.language) || '';
          lc = (lc || '').toLowerCase();
          if (/^en/.test(lc)) return 'en';
          if (/^de/.test(lc)) return 'de';
          if (/^fr/.test(lc)) return 'fr';
          if (/^uk/.test(lc)) return 'ru';
          return 'ru';
        } catch (_) { return 'ru'; }
      }
      function t(k, vars) {
        // Защита от неподдерживаемых языков
        if (!LANG[currentLang]) {
          console.warn('[i18n] Неподдерживаемый язык:', currentLang, '- переключаюсь на русский');
          currentLang = 'ru';
          try { localStorage.setItem(LANG_STORAGE_KEY, 'ru'); } catch (_) {}
        }
        var s = (LANG[currentLang] && LANG[currentLang][k]) || (LANG.ru && LANG.ru[k]) || k;
        if (vars && typeof s === 'string') {
          Object.keys(vars).forEach(function(key) { s = s.replace(new RegExp('\\{' + key + '\\}', 'g'), vars[key]); });
        }
        return s;
      }
      function applyTranslations() {
        document.documentElement.lang = currentLang || 'ru';
        var map = [
          ['tagline','#homeTagline'], ['startBtn','#startBtn'], ['myProfile','#goProfileBtn'], ['myHeroes','#goHeroesBtn'], ['myHelp','#goHelpBtn'], ['admin','#adminLinkBtn'],
          ['profileShare','#profileRefShareBtn'], ['profileCreateSong','#profileCreateSongBtn'],
          ['heroesTitle','#heroesPage header h1'], ['heroesSubtitle','#heroesPage .subtitle'],
          ['searchByName','#heroesPage label[for="heroesSearch"]'], ['searchPlaceholder','#heroesSearch'], ['searchBtn','#heroesSearchBtn'],
          ['addHero','#addHeroBtn'], ['heroName','#heroFormWrap label[for="heroName"]'], ['heroBirthdate','#heroFormWrap label[for="heroBirthdate"]'],
          ['heroBirthtime','#heroFormWrap label[for="heroBirthtime"]'], ['heroBirthplace','#heroFormWrap label[for="heroBirthplace"]'],
          ['heroNotes','#heroFormWrap label[for="heroNotes"]'], ['unknownTime','#heroFormWrap label[for="heroBirthtimeUnknown"]'],
          ['cancel','#heroFormCancel'], ['save','#heroFormSave'], ['back','#heroesBackBtn'],
          ['modeType','.mode-selector h3'], ['modeSubtitle','.mode-subtitle'],
          ['modeSingle','.mode-btn[data-mode="single"] .mode-label'], ['modeSingleDesc','.mode-btn[data-mode="single"] .mode-desc'],
          ['modeCouple','.mode-btn[data-mode="couple"] .mode-label'], ['modeCoupleDesc','.mode-btn[data-mode="couple"] .mode-desc'],
          ['modeTransitDesc','.mode-btn[data-mode="transit"] .mode-desc'],
          ['secondPersonTitle','#secondPersonForm h3'], ['transitTitle','#transitForm h3'],
          ['sendRequest','.request-label'], ['requestDesc','#requestDesc'], ['requestQuickHint','#requestQuickHint'], ['submitRequest','#stepNext'], ['submitHint','#submitHint'],
          ['paymentSubtitle','#paymentPage .subtitle'], ['paymentPageTagline','#paymentPage .tagline'],
          ['promoCode','#promoCodeInput'], ['apply','#promoApplyBtn'], ['backFromPayment','#backFromPaymentBtn'],
          ['paymentPageIntroAfterSubmit','#paymentIntro'], ['loadingDesc','#loadingDesc'], ['priceSummaryLabel','#priceSummaryLabel'],
          ['payWithHot','#payBtn'], ['creatingKey','.loading-text'], ['keyActivated','#successPage .subtitle'],
          ['done','.success-title'], ['soulChat','#soulChatBtn'], ['soulChatPay','#soulChatPayBtn'], ['newKey','#newKeyBtn'],
          ['paymentThanks','#paymentThanksPage .success-title'], ['thanksSubtitle','#paymentThanksPage .subtitle'],
          ['thanksDone','#paymentThanksBackBtn'], ['gender','#genderLabel'], ['genderSelect','#gender option[value=""]'],
          ['previewHome','button[data-page="home"]'], ['previewForm','button[data-page="form"]'], 
          ['previewPayment','button[data-page="payment"]'], ['previewLoading','button[data-page="loading"]'], ['previewSuccess','button[data-page="success"]'],
          ['supportBtn','#helpSupportBtn'],
          ['helpPageTitle','#helpPageTitle'], ['helpPageSubtitle','#helpPageSubtitle'],
          ['profileHelpBtn','#profileHelpBtn'],
          ['helpT1','#helpT1'], ['helpT2','#helpT2'], ['helpT3','#helpT3'], ['helpT4','#helpT4'],
          ['helpT5','#helpT5'], ['helpT6','#helpT6'], ['helpT7','#helpT7'],
          ['forWhoLabel','#forWhoLabel'], ['nameLbl','#nameLabel'],
          ['birthdateLbl','#birthdateLbl'], ['birthplaceLbl','#birthplaceLbl'], ['birthtimeLbl','#birthtimeLbl'],
          ['requestPreferredStyleLabel','#requestPreferredStyleLabel']
        ];
        // innerHTML — для подписей с переносом (напр. «Энергия» + «момента» на двух строках)
        var htmlMap = [
          ['modeTransit','.mode-btn[data-mode="transit"] .mode-label'],
          ['helpB1','#helpB1'], ['helpB2','#helpB2'], ['helpB3','#helpB3'], ['helpB4','#helpB4'],
          ['helpB5','#helpB5'], ['helpB6','#helpB6'], ['helpB7','#helpB7']
        ];
        map.forEach(function(pair) {
          var el = document.querySelector(pair[1]);
          if (el) {
            if (pair[1].indexOf('placeholder') === -1 && (pair[1].indexOf('#') === 0 || pair[1].indexOf('label') >= 0 || pair[1].indexOf('h3') >= 0 || pair[1].indexOf('.') >= 0)) {
              if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.placeholder = t(pair[0]);
              else el.textContent = t(pair[0]);
            } else if (pair[1].indexOf('placeholder') >= 0 || (el.tagName === 'INPUT' && pair[0] === 'searchPlaceholder')) el.placeholder = t(pair[0]);
            else el.textContent = t(pair[0]);
          }
        });
        var phMap = [
          ['namePh','#name'], ['birthplacePh','#birthplace'], ['name2Ph','#name2'], ['birthplace2Ph','#birthplace2'],
          ['transitDatePh','#transitDate'], ['transitTimePh','#transitTime'], ['transitLocationPh','#transitLocation'],
          ['transitIntentPh','#transitIntent'], ['requestPh','#request'], ['heroBirthplacePh','#heroBirthplace'],
          ['heroNotesPh','#heroNotes'], ['heroName','#heroName'], ['promoCode','#promoCodeInput']
        ];
        phMap.forEach(function(p) { var e = document.querySelector(p[1]); if (e) e.placeholder = t(p[0]); });
        htmlMap.forEach(function(p) { var e = document.querySelector(p[1]); if (e) e.innerHTML = t(p[0]); });
        var selectOpts = [['genderSelect','gender'],['male','male'],['female','female'],['other','other'],['langSong','language'],['langRu','ru'],['langEn','en'],['langDe','de'],['langFr','fr'],['langUk','uk']];
        var genderSelect = document.getElementById('gender'); if (genderSelect) {
          var opts = genderSelect.querySelectorAll('option'); if (opts[0]) opts[0].textContent = t('genderSelect');
          if (opts[1]) opts[1].textContent = t('male'); if (opts[2]) opts[2].textContent = t('female');
          var o3 = genderSelect.querySelector('option[value="other"]'); if (o3) o3.textContent = t('other');
        }
        var gender2 = document.getElementById('gender2'); if (gender2) {
          var o2 = gender2.querySelectorAll('option'); if (o2[0]) o2[0].textContent = t('genderSelect');
          if (o2[1]) o2[1].textContent = t('female'); if (o2[2]) o2[2].textContent = t('male');
          var o23 = gender2.querySelector('option[value="other"]'); if (o23) o23.textContent = t('other');
        }
        var heroGender = document.getElementById('heroGender'); if (heroGender) {
          var hOpts = heroGender.querySelectorAll('option'); if (hOpts[0]) hOpts[0].textContent = t('genderSelect');
          if (hOpts[1]) hOpts[1].textContent = t('male'); if (hOpts[2]) hOpts[2].textContent = t('female');
          var hO3 = heroGender.querySelector('option[value="other"]'); if (hO3) hO3.textContent = t('other');
        }
        var langSelect = document.getElementById('language'); if (langSelect) {
          var lOpts = langSelect.querySelectorAll('option');
          if (lOpts[0]) lOpts[0].textContent = t('langSong');
          var lRu = langSelect.querySelector('option[value="ru"]'); if (lRu) lRu.textContent = t('langRu');
          var lEn = langSelect.querySelector('option[value="en"]'); if (lEn) lEn.textContent = t('langEn');
          var lDe = langSelect.querySelector('option[value="de"]'); if (lDe) lDe.textContent = t('langDe');
          var lFr = langSelect.querySelector('option[value="fr"]'); if (lFr) lFr.textContent = t('langFr');
          var lUk = langSelect.querySelector('option[value="uk"]'); if (lUk) lUk.textContent = t('langUk');
        }
        var heroOpt = document.querySelector('#heroGender option[value=""]'); if (heroOpt) heroOpt.textContent = t('genderSelect');
        var heroMale = document.querySelector('#heroGender option[value="male"]'); if (heroMale) heroMale.textContent = t('male');
        var heroFemale = document.querySelector('#heroGender option[value="female"]'); if (heroFemale) heroFemale.textContent = t('female');
        document.getElementById('birthplaceHint') && (document.getElementById('birthplaceHint').textContent = t('birthplaceHint'));
        document.getElementById('birthplace2Hint') && (document.getElementById('birthplace2Hint').textContent = t('birthplaceHint'));
        document.querySelector('label[for="unknown"]') && (document.querySelector('label[for="unknown"]').textContent = t('unknownTime'));
        document.querySelector('label[for="unknown2"]') && (document.querySelector('label[for="unknown2"]').textContent = t('unknownTimeShort'));
        var quickBtns = document.querySelectorAll('.example-btn'); var quickK = ['quick1','quick2','quick3','quick4','quick5','quick6','quick7','quick8','quick9','quick10','quick11','quick12']; var quickT = ['quick1t','quick2t','quick3t','quick4t','quick5t','quick6t','quick7t','quick8t','quick9t','quick10t','quick11t','quick12t'];
        quickBtns.forEach(function(btn, i) { if (btn && i < quickK.length) { btn.textContent = t(quickK[i]); btn.setAttribute('data-text', t(quickT[i])); } });
        var gh = document.getElementById('homeGreeting');
        if (gh) gh.textContent = (userProfile && userProfile.name) ? t('greeting', { name: userProfile.name }) : t('greetingDefault');
        var langCurrentEl = document.getElementById('langSwitcherCurrent');
        if (langCurrentEl) { var codes = { ru: 'RU', en: 'EN', de: 'DE', fr: 'FR' }; langCurrentEl.textContent = codes[currentLang] || 'RU'; }
        // Онбординг (превью-сторис) — на языке интерфейса
        // Переводы для 3 слайдов онбординга
        var obTitle1 = document.getElementById('obTitle1'); var obText1 = document.getElementById('obText1');
        var obTitle2 = document.getElementById('obTitle2'); var obText2 = document.getElementById('obText2');
        var obTitle3 = document.getElementById('obTitle3'); var obText3 = document.getElementById('obText3');
        if (obTitle1) obTitle1.textContent = t('onboardingSlide1Title');
        if (obText1)  obText1.textContent  = t('onboardingSlide1Text');
        if (obTitle2) obTitle2.textContent = t('onboardingSlide2Title');
        if (obText2)  obText2.textContent  = t('onboardingSlide2Text');
        if (obTitle3) obTitle3.textContent = t('onboardingSlide3Title');
        if (obText3)  obText3.textContent  = t('onboardingSlide3Text');
        var startBtn = document.getElementById('onboardingStartBtn'); if (startBtn) startBtn.textContent = t('onboardingBtnStart');
        // ── Новые переводы всех страниц ──────────────────────────────────────
        var newMap = [
          // heroes page
          ['heroesPageTitle','#heroesPageTitle'], ['heroesPromoHeading','#heroesPromoHeading'],
          ['heroesPromoDesc','#heroesPromoDesc'], ['heroesPromoFeaturesTitle','#heroesPromoFeaturesTitle'],
          ['heroesF1','#heroesF1'], ['heroesF2','#heroesF2'], ['heroesF3','#heroesF3'],
          ['heroesF4','#heroesF4'], ['heroesF5','#heroesF5'],
          ['heroesTrialBtn','#masterTrialBtn'], ['heroesSubBtn','#masterSubBtn'],
          ['heroesSubNote','#heroesSubNote'],
          ['heroFormTitle','#heroFormTitle'], ['heroRelLabel','#heroRelLabel'],
          ['heroBirthdateHint','#heroBirthdateHint'],
          ['heroTimeBirthLabel','#heroTimeBirthLabel'], ['heroStyleLabel','#heroStyleLabel'],
          // profile page
          ['profilePageTitle','#profilePageTitle'], ['profileSectionMyData','#profileSectionMyData'],
          ['profileSectionPlans','#profileSectionPlans'], ['profileLoadError','#profileLoadErrorText'], ['profileLoadRetry','#profileLoadRetryBtn'],
          ['profileEditBtn','#profileEditBtn'],
          ['profileBalanceHintText','#profileBalanceHintText'],
          ['profileSectionTracks','#profileSectionTracks'],
          ['profileRefTagline','#profileRefTagline'],
          ['profileInviteFriend','#profileInviteFriendTitle'],
          ['profileRefInvited','#profileRefInvitedLabel'], ['profileRefActivated','#profileRefActivatedLabel'],
          ['planCurrentBadge','#planFreeBadge'], ['planFreeYours','#planFreePrice'],
          ['planSubscribeBtn','#planBtnBasic'], ['planDetailsBtn','#planDetailsBasic'],
          ['planPopularBadge','#planPlusBadge'],
          ['planSubscribeBtn','#planBtnPlus'], ['planDetailsBtn','#planDetailsPlus'],
          ['planMasterBadgeText','#planMasterBadge'], ['planMasterNameText','#planMasterName'],
          ['planOpenMasterBtn','#planBtnMaster'], ['planDetailsBtn','#planDetailsMaster'],
          ['ptiSingleName','#ptiSingleName'], ['ptiSingleDesc','#ptiSingleDesc'],
          ['ptiCoupleName','#ptiCoupleName'], ['ptiCoupleDesc','#ptiCoupleDesc'],
          ['ptiTransitName','#ptiTransitName'], ['ptiTransitDesc','#ptiTransitDesc'],
          // success page
          ['successTitle','#successTitle'], ['successHint','#successHint'],
          ['successToProfile','#successToProfileBtn'], ['openBot','#openBotBtn'],
          // loading page
          ['loadingTitle','#loadingTitle'],
          // soul chat promo
          ['scLoading','#scGlobalLoadingText'], ['scPromoIntro','#scPromoIntro'],
          ['scMoreBtnText','#scMoreBtnText'], ['scStat1','#scStat1'], ['scStat2','#scStat2'],
          ['scStat3','#scStat3'], ['scStat4','#scStat4'], ['scExamplesTitle','#scExamplesTitle'],
          ['scEx1','#scEx1'], ['scEx2','#scEx2'], ['scEx3','#scEx3'],
          ['scPromoErrorText','#scPromoErrorText'], ['scPromoRetryBtn','#scPromoRetryBtn'],
          ['scSubIncluded','#scSubIncluded'], ['scChoosePlanBtn','#scChoosePlanBtn'],
          ['scGiftHeading','#scGiftHeading'], ['scGiftNote','#scGiftNote'],
          ['scGiftBtnText','#scPageGiftBtn'], ['scBuyDayNote','#scBuyDayNote'],
          ['scBuyDayBtnText','#scPageBuyDayBtn'],
          // payment overlay
          ['payOvCardTitleDefault','#payOvCardTitle'], ['payOvTrialText','#payOvTrialText'],
          ['payOvFreeClaimBtn','#payOvFreeClaimBtn'], ['payOvPromoToggle','#payOvPromoToggle'],
          ['apply','#payOvPromoBtn'], ['orPay','#payOvOrPayText'], ['priceLabel','#payOvPriceLabel'],
          ['payWithHot','#payOvPayBtn'], ['payOvLinkHint','#payOvLinkHint'],
          ['payOvCopyBtn','#payOvCopyBtn'], ['payOvCheckBtn','#payOvCheckBtn'],
          ['payOvPromoConfirmBtn','#payOvPromoConfirmBtn'], ['backFromPayment','#payOvBackBtn'],
          // payment thanks page
          ['paymentThanksTitle','#paymentThanksTitle'],
          ['paymentThanksMsg','#paymentThanksMessage'],
          ['paymentThanksHintText','#paymentThanksHint'],
          // profile plan features
          ['profileBalanceLbl','#profileBalanceLabel'],
          ['planFreeF1','#planFreeF1'], ['planFreeF2','#planFreeF2'],
          ['planBasicF1','#planBasicF1'], ['planBasicF2','#planBasicF2'], ['planBasicF3','#planBasicF3'], ['planBasicSave','#planBasicSave'],
          ['planPlusF1','#planPlusF1'], ['planPlusF2','#planPlusF2'], ['planPlusF3','#planPlusF3'], ['planPlusF4','#planPlusF4'], ['planPlusSave','#planPlusSave'],
          ['planMasterF1','#planMasterF1'], ['planMasterF2','#planMasterF2'], ['planMasterF3','#planMasterF3'], ['planMasterF4','#planMasterF4'], ['planMasterSave','#planMasterSave'],
          // quick picker label
          ['quickPickerLabel','#quickPickerLabel']
        ];
        newMap.forEach(function(pair) {
          var el = document.querySelector(pair[1]);
          if (el) {
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.placeholder = t(pair[0]);
            else el.textContent = t(pair[0]);
          }
        });
        // Реферальные метки (1 друг / 3 друга / 5+ друзей)
        document.querySelectorAll('.ref-milestone[data-n]').forEach(function(m) {
          var n = parseInt(m.getAttribute('data-n'));
          var lbl = m.querySelector('.ref-mi-label');
          if (lbl) {
            if (n === 1) lbl.textContent = t('refFriend1');
            else if (n === 3) lbl.textContent = t('refFriend2');
            else lbl.textContent = t('refFriend5');
          }
        });
        var refLink = document.getElementById('profileRefLinkInput');
        if (refLink && !refLink.value) refLink.placeholder = t('refLinkLoading');
        // successDesc — innerHTML чтобы сохранить <br>
        var sdEl = document.getElementById('successDesc');
        if (sdEl) sdEl.innerHTML = t('successDesc').replace(/\n/g,'<br>');
        // Перевод плейсхолдеров новых полей
        var newPh = [['heroStylePh','#heroStyle'], ['requestPreferredStylePh','#requestPreferredStyle']];
        newPh.forEach(function(p){ var e = document.querySelector(p[1]); if(e) e.placeholder = t(p[0]); });
        // Перевод опций heroRelationship
        var relSel = document.getElementById('heroRelationship');
        if (relSel) {
          var relOpts = relSel.querySelectorAll('option');
          var relKeys = ['heroRelOpt0','heroRelOpt1','heroRelOpt2','heroRelOpt3','heroRelOpt4','heroRelOpt5','heroRelOpt6','heroRelOpt7','heroRelOpt8','heroRelOpt9','heroRelOpt10','heroRelOpt11','heroRelOpt12','heroRelOpt13','heroRelOpt14','heroRelOpt15','heroRelOpt16'];
          relOpts.forEach(function(opt, i) { if (relKeys[i]) opt.textContent = t(relKeys[i]); });
        }
        // Перевод опций dateDay/dateMonth/dateYear во всех date-group select
        document.querySelectorAll('.date-group-day option[value=""]').forEach(function(o){ o.textContent = t('dateDay'); });
        document.querySelectorAll('.date-group-month option[value=""]').forEach(function(o){ o.textContent = t('dateMonth'); });
        document.querySelectorAll('.date-group-year option[value=""]').forEach(function(o){ o.textContent = t('dateYear'); });
        // Убеждаемся, что кнопка оплаты имеет правильный текст после применения переводов
        ensurePayButtonText();
      }
      function setLang(lang) {
        // Валидация поддерживаемых языков
        var supportedLangs = ['ru', 'en', 'de', 'fr'];
        if (supportedLangs.indexOf(lang) === -1) {
          console.warn('[i18n] Попытка установить неподдерживаемый язык:', lang, '- используется русский');
          lang = 'ru';
        }
        currentLang = lang;
        try { localStorage.setItem(LANG_STORAGE_KEY, lang); } catch (_) {}
        // Язык песни не меняем при смене языка интерфейса — это независимый выбор пользователя
        applyTranslations();
        // Формат даты в Chromium/WebView зависит от lang самого input — обновляем
        document.querySelectorAll('input[type="date"]').forEach(function(el) { el.lang = lang; });
        // Принудительно обновляем кнопку оплаты после смены языка
        ensurePayButtonText();
      }
      function ensurePayButtonText() {
        var payBtn = document.getElementById('payOvPayBtn');
        if (!payBtn || payBtn.disabled) return;
        var isFree = activePromo && Number(activePromo.amount_after) === 0;
        if (isFree) return;
        var sku = pendingPaymentSku || getCurrentSku();
        var item = pricingCatalog && pricingCatalog.find(function(x) { return x && x.sku === sku; });
        var priceStr = item ? (String(item.price) + ' ' + (item.currency || 'USDT')) : '';
        payBtn.textContent = priceStr ? ('Оплатить ' + priceStr) : 'Оплатить через HOT Pay';
        payBtn.style.background = 'linear-gradient(135deg,var(--primary-color),var(--secondary-color))';
      }
      function isTelegramWebApp() {
        return !!(window.Telegram && window.Telegram.WebApp);
      }
      function getInitData() {
        var current = '';
        try {
          var wa = window.Telegram && window.Telegram.WebApp;
          current = (wa && wa.initData) ? String(wa.initData) : (tg && tg.initData) ? String(tg.initData) : '';
          console.log('[initData] Telegram WebApp доступен:', !!(wa));
          console.log('[initData] initData из WebApp:', current ? 'есть данные (' + current.length + ' символов)' : 'пустые данные');
        } catch (e) { 
          console.error('[initData] Ошибка получения initData:', e);
          current = ''; 
        }
        if (current) {
          try { localStorage.setItem(INIT_DATA_STORAGE_KEY, current); } catch (_) {}
          console.log('[initData] Используем свежие данные из Telegram');
          return current;
        }
        try { 
          var stored = localStorage.getItem(INIT_DATA_STORAGE_KEY) || '';
          console.log('[initData] Используем сохраненные данные:', stored ? 'есть данные (' + stored.length + ' символов)' : 'нет данных');
          if (!stored) {
            console.warn('[initData] КРИТИЧНО: Нет initData! Приложение запущено не из Telegram или данные не сохранились');
            
            // Показываем пользователю инструкции и предлагаем демо-режим
            setTimeout(function() {
              var message = '⚠️ Проблема с авторизацией Telegram!\n\n' +
                           '🔧 Возможные решения:\n' +
                           '1. Откройте приложение из бота @YupSoul_bot (кнопка меню ☰)\n' +
                           '2. Обновите Telegram до последней версии\n' +
                           '3. Перезапустите Telegram\n' +
                           '4. Попробуйте web.telegram.org\n\n' +
                           '💡 Или продолжить в демо-режиме (без оплаты)';
              
              if (confirm(message + '\n\nПродолжить в демо-режиме?')) {
                console.log('[Demo] Пользователь выбрал демо-режим');
                window.demoMode = true;
                // Создаем фиктивные данные для демо
                window.fallbackUserData = {
                  id: 'demo_user',
                  first_name: 'Demo User',
                  username: 'demo'
                };
              }
            }, 3000);
          }
          return stored;
        } catch (_) { 
          console.error('[initData] Ошибка чтения из localStorage');
          return ''; 
        }
      }
      function initApp() {
        try {
          console.log('[App] Инициализация приложения');
          console.log('[App] window.Telegram доступен:', !!(window.Telegram));
          console.log('[App] window.Telegram.WebApp доступен:', !!(window.Telegram && window.Telegram.WebApp));
          
      if (window.Telegram && window.Telegram.WebApp) {
            tg = window.Telegram.WebApp;
            console.log('[Telegram] WebApp инициализирован');
            console.log('[Telegram] Версия:', tg.version);
            console.log('[Telegram] Платформа:', tg.platform);
            console.log('[Telegram] initData длина:', tg.initData ? tg.initData.length : 0);
            
            // Проверяем версию Telegram WebApp
            var version = parseFloat(tg.version) || 0;
            if (version < 6.1) {
              console.warn('[Telegram] Старая версия WebApp (' + tg.version + ') может не поддерживать initData');
              console.warn('[Telegram] Рекомендуется обновить Telegram до последней версии');
            }
            
        tg.ready();
            tg.expand();
            // Закрашиваем шапку Telegram в цвет фона — убирает золотистую полоску
            try {
              if (tg.setHeaderColor) tg.setHeaderColor('#08071a');
              if (tg.setBackgroundColor) tg.setBackgroundColor('#08071a');
            } catch(e) {}
            console.log('[Telegram] ready() и expand() выполнены');
            // Кешируем photo_url в localStorage — иногда недоступен после редиректа HOT Pay
            try {
              var _u = tg.initDataUnsafe && tg.initDataUnsafe.user;
              if (_u && _u.photo_url) localStorage.setItem('tg_photo_url', _u.photo_url);
              if (_u && _u.id) localStorage.setItem('tg_user_id', String(_u.id));
            } catch(e) {}
            // Сохраняем tg_username при каждом открытии — нужно для связи с клиентом из админки
            try {
              var _initD = tg.initData;
              if (_initD) {
                var _base = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
                fetch(_base + '/api/user/sync', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': _initD }
                }).catch(function(){});
              }
            } catch(e) {}
            
            if (tg.enableClosingConfirmation) {
              tg.enableClosingConfirmation();
              console.log('[Telegram] enableClosingConfirmation включен');
            } else {
              console.warn('[Telegram] enableClosingConfirmation не поддерживается в этой версии');
            }
            getInitData();
            
            // Для старых версий Telegram пытаемся получить хотя бы базовую информацию о пользователе
            if ((!tg.initData || tg.initData.length < 10) && tg.initDataUnsafe && tg.initDataUnsafe.user) {
              console.log('[Telegram] Используем initDataUnsafe как fallback для старой версии');
              console.log('[Telegram] Пользователь:', tg.initDataUnsafe.user.first_name, tg.initDataUnsafe.user.id);
              
              // Создаем минимальные данные для работы (только для отображения, не для API)
              window.fallbackUserData = {
                id: tg.initDataUnsafe.user.id,
                first_name: tg.initDataUnsafe.user.first_name,
                username: tg.initDataUnsafe.user.username
              };
            }
            
            return true;
          } else {
            console.error('[Telegram] WebApp НЕ ДОСТУПЕН!');
            console.error('[Telegram] Приложение запущено не из Telegram или в неподдерживаемом браузере');
            // Показываем предупреждение пользователю
            setTimeout(function() {
              if (!tg) {
                alert('⚠️ Приложение должно быть запущено из Telegram!\n\n' +
                      '1. Откройте @YupSoul_bot в Telegram\n' +
                      '2. Нажмите кнопку меню (☰) или "Открыть приложение"\n' +
                      '3. Если не работает - обновите Telegram до последней версии');
              }
            }, 2000);
          }
        } catch (e) { 
          console.error('[Telegram] Ошибка инициализации:', e); 
        }
        return false;
      }
      if (!initApp()) {
        var attempts = 0;
        var t = setInterval(function() {
          attempts++;
          if (initApp() || attempts >= 50) {
            clearInterval(t);
            if (!tg) showNotFromTelegramBanner();
          }
        }, 100);
      }
      function showNotFromTelegramBanner() {
        var banner = document.createElement('div');
        banner.id = 'not-telegram-banner';
        banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:9999;background:#fef3c7;color:#92400e;padding:12px 16px;text-align:center;font-size:0.95rem;border-bottom:1px solid #f59e0b;';
        banner.textContent = t('notFromTelegram');
        document.body.insertBefore(banner, document.body.firstChild);
      }
      function getPlacesSearchUrl(q) {
        var base = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        if (base) return base + '/api/places?q=' + encodeURIComponent(q);
        return 'https://nominatim.openstreetmap.org/search?q=' + encodeURIComponent(q) + '&format=json&limit=8&addressdetails=1';
      }
      async function showLocationSuggestions(inputElement, suggestionsContainerId, confirmCheckboxId) {
        var value = inputElement.value.trim();
        var suggestionsContainer = document.getElementById(suggestionsContainerId);
        if (value.length < 2) {
          if (suggestionsContainer) suggestionsContainer.style.display = 'none';
          return;
        }
        try {
          var url = getPlacesSearchUrl(value);
          var headers = { 'Accept': 'application/json' };
          if (url.indexOf('nominatim') !== -1) { headers['User-Agent'] = 'YupSoulMiniApp/1.0'; }
          var response = await fetch(url, { headers: headers });
          var locations = await response.json();
          if (locations.length === 0) {
            if (suggestionsContainer) {
              suggestionsContainer.innerHTML = '<div style="padding: 10px; color: var(--tg-theme-hint-color, rgba(255,255,255,0.6)); text-align: center;">' + t('notFound') + '</div>';
              suggestionsContainer.style.display = 'block';
            }
            return;
          }
          if (suggestionsContainer) {
            suggestionsContainer.innerHTML = locations.map(function(loc) {
              var display = (loc.display_name || '')
                .replace(', Россия', '').replace(', Беларусь', '').replace(', Российская Федерация', '').replace(', Republic of Belarus', '');
              var safe = typeof escHtml === 'function' ? escHtml(display) : String(display).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
              return '<div class="location-suggestion" data-value="' + safe + '">' + safe + '</div>';
            }).join('');
            suggestionsContainer.style.display = 'block';
            suggestionsContainer.querySelectorAll('.location-suggestion').forEach(function(item) {
              item.addEventListener('click', function() {
                inputElement.value = item.getAttribute('data-value');
                suggestionsContainer.style.display = 'none';
                if (confirmCheckboxId) {
                  var checkbox = document.getElementById(confirmCheckboxId);
                  if (checkbox) checkbox.checked = true;
                }
              });
            });
          }
        } catch (err) {
          console.error('Ошибка поиска местоположения:', err);
          if (suggestionsContainer) {
            suggestionsContainer.innerHTML = '<div style="padding: 10px; color: #ef4444; text-align: center;">' + t('searchError') + '</div>';
            suggestionsContainer.style.display = 'block';
          }
        }
      }
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.location-input-wrapper')) {
          document.querySelectorAll('.location-suggestions').forEach(function(el) { el.style.display = 'none'; });
        }
      });
      var userTariff = 'basic';
      var userProfile = null;
      var heroesCache = [];
      var editingHeroId = null;
      var pricingCatalog = [];
      var freeTrialAvailable = true;
      var hasSubscriptionActive = false;
      var catalogLoadError = false;
      var activePromo = null;
      var pendingPaymentRequestId = null;
      var pendingPaymentSku = null;
      var selectedMode = 'single';

      function getCurrentSku() {
        var modeSku = (typeof selectedMode !== 'undefined' && selectedMode) ? selectedMode : 'single';
        if (modeSku === 'couple') return 'couple_song';
        if (modeSku === 'transit') return 'transit_energy_song';
        return 'single_song';
      }
      // ── Payment Overlay helpers ──────────────────────────────────────────
      function showPaymentOverlay() {
        var ov = document.getElementById('paymentOverlay');
        if (!ov) return;
        console.log('[Payment Overlay] Открытие окна оплаты');
        console.log('[Payment Overlay] pendingPaymentRequestId:', pendingPaymentRequestId);
        console.log('[Payment Overlay] freeTrialAvailable:', freeTrialAvailable);
        
        ov.style.display = 'flex';
        if (tg && tg.expand) try { tg.expand(); } catch(e) {}
        
        // Сброс UI
        setPaymentStatus('', '');
        hidePromoConfirmButton();
        showPaymentSection();
        
        var pi = document.getElementById('payOvPromoInput');
        if (pi) pi.value = '';
        var promoSection = document.getElementById('payOvPromoSection');
        if (promoSection) promoSection.style.display = 'none';
        var promoToggle = document.getElementById('payOvPromoToggle');
        if (promoToggle) promoToggle.textContent = '▸ Есть промокод?';
        
        var lr = document.getElementById('payOvLinkRow');
        if (lr) lr.style.display = 'none';
        
        var cb = document.getElementById('payOvCheckBtn');
        if (cb) cb.style.display = 'none';
        
        ov.scrollTop = 0;
        
        // Free trial блок
        var freeClaimBtn = document.getElementById('payOvFreeClaimBtn');
        var hint = document.getElementById('payOvTrialHint');
        if (freeTrialAvailable) {
          if (freeClaimBtn) freeClaimBtn.style.display = '';
          if (hint) hint.style.display = '';
        } else {
          if (freeClaimBtn) freeClaimBtn.style.display = 'none';
          if (hint) hint.style.display = 'none';
        }
        
        updatePaymentUiFromCatalog();
      }
      function hidePaymentOverlay() {
        console.log('[Payment Overlay] Закрытие окна оплаты');
        var ov = document.getElementById('paymentOverlay');
        if (ov) ov.style.display = 'none';
        
        // Полный сброс состояния
        setPaymentStatus('', '');
        activePromo = null;
        resetPaymentUI();
        
        var pi = document.getElementById('payOvPromoInput');
        if (pi) pi.value = '';
        
        var lr = document.getElementById('payOvLinkRow');
        if (lr) lr.style.display = 'none';
        
        var cb = document.getElementById('payOvCheckBtn');
        if (cb) cb.style.display = 'none';
      }
      // ── Надёжный экран "Заявка принята" — position:fixed, z-index:10000 ─────────
      function showConfirm(title, desc) {
        hidePaymentOverlay();
        showConfirmOverlay(title, desc, function() { goToPage('successPage'); });
      }
      // Экраны «Заявка принята» — фиксированный оверлей, всегда виден поверх всего
      var _confirmAutoTimer = null;
      function showConfirmOverlay(title, desc, onDone) {
        hidePaymentOverlay();
        var ov = document.getElementById('confirmOverlay');
        if (!ov) { if (onDone) onDone(); return; }
        var tEl = document.getElementById('confirmTitle');
        var dEl = document.getElementById('confirmDesc');
        if (tEl) tEl.textContent = title || 'Заявка принята!';
        if (dEl) dEl.innerHTML = desc || 'Анализирую твои данные и создаю уникальную песню.<br><br>Песня придёт в этот чат. Можешь закрыть приложение — ничего не пропадёт.';
        ov.style.display = 'block';
        // Только ручной клик — без авто-скрытия
        var btn = document.getElementById('confirmContinueBtn');
        if (btn) {
          btn.onclick = function() { if (onDone) onDone(); hideConfirmOverlay(); };
        }
      }
      function hideConfirmOverlay() {
        if (_confirmAutoTimer) { clearTimeout(_confirmAutoTimer); _confirmAutoTimer = null; }
        var ov = document.getElementById('confirmOverlay');
        if (ov) ov.style.display = 'none';
        var btn = document.getElementById('confirmContinueBtn');
        if (btn) btn.onclick = null;
      }
      var _toastTimer = null;
      function showToast(message) {
        var el = document.getElementById('scToast');
        if (!el) return;
        if (_toastTimer) clearTimeout(_toastTimer);
        el.textContent = message || '';
        el.style.display = 'block';
        _toastTimer = setTimeout(function() { el.style.display = 'none'; _toastTimer = null; }, 3000);
      }
      function setPaymentStatus(text, tone) {
        var el = document.getElementById('payOvStatus');
        if (!el) return;
        if (!text) { el.style.display = 'none'; return; }
        el.style.display = 'block';
        el.textContent = text;
        el.style.color = 'rgba(255,255,255,.95)';
        if (tone === 'ok')    { el.style.border = '1px solid rgba(var(--primary-rgb),.5)';  el.style.background = 'rgba(var(--primary-rgb),.18)'; return; }
        if (tone === 'warn')  { el.style.border = '1px solid rgba(var(--primary-rgb),.45)'; el.style.background = 'rgba(var(--primary-rgb),.12)'; return; }
        if (tone === 'error') { el.style.border = '1px solid rgba(var(--secondary-rgb),.5)';  el.style.background = 'rgba(var(--secondary-rgb),.12)'; return; }
        el.style.border = '1px solid rgba(var(--primary-rgb),.35)';
        el.style.background = 'rgba(var(--primary-rgb),.1)';
      }
      var DEFAULT_PRICES = { single_song: { title: 'Single song', price: '5.99', currency: 'USDT' }, couple_song: { title: 'Couple song', price: '8.99', currency: 'USDT' }, transit_energy_song: { title: 'Transit energy song', price: '6.99', currency: 'USDT' } };
      function updatePaymentUiFromCatalog() {
        try {
          var sku = getCurrentSku();
          var item = pricingCatalog.find(function(x) { return x && x.sku === sku; }) || DEFAULT_PRICES[sku] || null;
          
          var priceLabel = document.getElementById('priceLabel');
          var priceValue = document.getElementById('priceValue');
          var priceHint = document.getElementById('priceHint');
          var notice = document.getElementById('pricingNotice');
          
          if (priceLabel) priceLabel.textContent = item ? (item.title || sku) : sku;
          if (priceValue) {
            if (activePromo) {
              priceValue.textContent = String(activePromo.amount_after) + ' ' + (activePromo.currency || (item && item.currency) || 'USDT');
            } else {
              priceValue.textContent = item ? (String(item.price) + ' ' + (item.currency || 'USDT')) : '—';
            }
          }
          if (priceHint) {
            if (activePromo) {
              priceHint.textContent = t('promoAppliedHint', { code: activePromo.code, amount: activePromo.discount_amount, currency: activePromo.currency || (item && item.currency) || 'USDT' });
            } else {
              priceHint.textContent = '';
            }
          }
          if (notice) {
            if (catalogLoadError) {
              notice.textContent = t('catalogLoadFailed');
              notice.style.borderColor = 'rgba(var(--primary-rgb),.4)';
              notice.style.background = 'rgba(var(--primary-rgb),.12)';
              notice.style.color = 'rgba(255,255,255,.95)';
            } else if (hasSubscriptionActive) {
              notice.textContent = t('subscriptionActive');
              notice.style.borderColor = 'rgba(16,185,129,.4)';
              notice.style.background = 'rgba(16,185,129,.12)';
              notice.style.color = 'rgba(255,255,255,.95)';
            } else if (freeTrialAvailable) {
              notice.textContent = t('firstFree');
              notice.style.borderColor = 'rgba(var(--primary-rgb),.4)';
              notice.style.background = 'rgba(var(--primary-rgb),.12)';
              notice.style.color = 'rgba(255,255,255,.95)';
            } else {
              notice.textContent = t('paymentRequired');
              notice.style.borderColor = 'rgba(var(--primary-rgb),.35)';
              notice.style.background = 'rgba(var(--primary-rgb),.1)';
              notice.style.color = 'rgba(255,255,255,.95)';
            }
          }
          // Обновляем цену в overlay (новый элемент payOvPriceDisplay)
          var priceDisplay = document.getElementById('payOvPriceDisplay');
          var priceHintOv = document.getElementById('payOvPriceHint');
          if (priceDisplay) {
            if (activePromo) {
              priceDisplay.textContent = String(activePromo.amount_after) + ' ' + (activePromo.currency || (item && item.currency) || 'USDT');
            } else {
              priceDisplay.textContent = item ? (String(item.price) + ' ' + (item.currency || 'USDT')) : '5.99 USDT';
            }
          }
          if (priceHintOv) {
            if (activePromo && Number(activePromo.amount_after) > 0) {
              priceHintOv.textContent = '💚 Скидка: ' + activePromo.discount_amount + ' ' + (activePromo.currency || 'USDT');
            } else {
              priceHintOv.textContent = '';
            }
          }
          var subEl = document.getElementById('payOvSubtitle');
          if (subEl) subEl.textContent = item ? (item.title || 'Твоя песня') : 'Твоя песня';
          var cardTitleEl = document.getElementById('payOvCardTitle');
          if (cardTitleEl) cardTitleEl.textContent = item ? (item.title || 'Оплата') : 'Оплата заявки';
        } catch (e) {
          console.warn('[updatePaymentUiFromCatalog]', e);
          var n = document.getElementById('pricingNotice');
          if (n) { n.textContent = t('catalogLoadFailed'); n.style.display = 'block'; }
        }
      }
      async function loadPricingCatalog() {
        var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        var initData = (tg && tg.initData) ? tg.initData : (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) || '';
        catalogLoadError = false;
        if (!apiBase) {
          catalogLoadError = true;
          updatePaymentUiFromCatalog();
          return;
        }
        try {
          var url = apiBase + '/api/pricing/catalog';
          var sep = url.indexOf('?') >= 0 ? '&' : '?';
          if (initData) url += sep + 'initData=' + encodeURIComponent(initData);
          var resp = await fetch(url, { headers: { 'X-Telegram-Init': initData } });
          var json = await resp.json().catch(function() { return {}; });
          if (resp.ok && json.success) {
            pricingCatalog = Array.isArray(json.catalog) ? json.catalog : [];
            freeTrialAvailable = !!(json.free_trial && json.free_trial.available);
            hasSubscriptionActive = !!(json.subscription_active);
            catalogLoadError = false;
            updatePaymentUiFromCatalog();
            // Проверяем зависшую заявку (не при возврате с HOT Pay — там заявка уже оплачена)
            var _curSearch = typeof window.location !== 'undefined' ? (window.location.search || '') : '';
            if (_curSearch.indexOf('payment=success') === -1) {
              checkPendingRequestOnStart();
            }
            // Загружаем реферальные данные
            loadReferralStats();
          } else {
            catalogLoadError = true;
            updatePaymentUiFromCatalog();
          }
        } catch (e) {
          console.warn('[loadPricingCatalog]', e);
          catalogLoadError = true;
          updatePaymentUiFromCatalog();
        }
      }
      // Загружает реферальную статистику и показывает блок «Пригласи друга»
      async function loadReferralStats() {
        var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        var initData = getInitData();
        if (!apiBase || !initData) return;
        try {
          var resp = await fetch(apiBase + '/api/referral/stats', { headers: { 'X-Telegram-Init': initData } });
          if (!resp.ok) return;
          var data = await resp.json().catch(function() { return null; });
          if (!data || !data.code || !data.link) return;
          var inp = document.getElementById('referralLinkInput');
          if (inp) inp.value = data.link || '';
          var inv = document.getElementById('refInvitedCount');
          if (inv) inv.textContent = data.invited_count || 0;
          var rew = document.getElementById('refRewardedCount');
          if (rew) rew.textContent = data.rewarded_count || 0;
          var crd = document.getElementById('refCreditsCount');
          if (crd) crd.textContent = data.credits || 0;
          var card = document.getElementById('referralCard');
          if (card) card.style.display = 'block';
        } catch (e) { console.warn('[Referral] Не удалось загрузить статистику:', e); }
      }

      // Загружает данные профиля на страницу «Профиль»
      async function loadProfilePage() {
        var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        var initData = getInitData();
        var avatarEl = document.getElementById('profileAvatar');
        var avatarInitialEl = document.getElementById('profileAvatarInitial');
        var nameEl = document.getElementById('profileName');
        var planBadgeEl = document.getElementById('profilePlanBadge');
        var creditsEl = document.getElementById('profileCreditsCount');
        var refLinkEl = document.getElementById('profileRefLinkInput');
        var refInvEl = document.getElementById('profileRefInvited');
        var refRewEl = document.getElementById('profileRefRewarded');
        var errorWrap = document.getElementById('profileLoadErrorWrap');
        if (errorWrap) errorWrap.style.display = 'none';
        if (nameEl) nameEl.textContent = (typeof t === 'function' ? t('loading') : 'Загрузка…');
        if (creditsEl) creditsEl.textContent = '—';
        if (refLinkEl) refLinkEl.value = '';
        if (refInvEl) refInvEl.textContent = '0';
        if (refRewEl) refRewEl.textContent = '0';
        var tgUser = tg && tg.initDataUnsafe && tg.initDataUnsafe.user;
        var displayName = (tgUser && tgUser.first_name) ? tgUser.first_name : 'Гость';

        function setAvatarPhoto(src) {
          if (!avatarEl) return;
          var existing = avatarEl.querySelector('img');
          if (!existing) {
            var img = document.createElement('img');
            img.alt = 'avatar';
            avatarEl.insertBefore(img, avatarEl.firstChild);
            existing = img;
          }
          existing.src = src;
          existing.style.display = 'block';
          if (avatarInitialEl) avatarInitialEl.style.display = 'none';
        }

        // Сначала — инициал
        if (avatarInitialEl) avatarInitialEl.textContent = displayName.charAt(0).toUpperCase();
        // Telegram photo_url: берём из initDataUnsafe или из кеша localStorage
        var photoUrl = (tgUser && tgUser.photo_url) || '';
        if (!photoUrl) { try { photoUrl = localStorage.getItem('tg_photo_url') || ''; } catch(e) {} }
        if (photoUrl) setAvatarPhoto(photoUrl);
        if (!initData || !apiBase) {
          if (nameEl) nameEl.textContent = displayName;
          return;
        }
        try {
          var profileResp = await fetch(apiBase + '/api/user/profile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
            body: JSON.stringify({ initData: initData })
          });
          var profileJson = await profileResp.json().catch(function() { return {}; });
          if (!profileResp.ok) {
            if (nameEl) nameEl.textContent = displayName;
            var errWrap = document.getElementById('profileLoadErrorWrap');
            var errText = document.getElementById('profileLoadErrorText');
            if (errWrap) errWrap.style.display = 'block';
            if (errText) errText.textContent = (typeof t === 'function' ? t('profileLoadError') : 'Не удалось загрузить подписку. Проверьте интернет.');
            return;
          }
          if (profileJson.profile && profileJson.profile.name) displayName = profileJson.profile.name;

          // Параллельно загружаем referral + pricing
          var [refResp, pricingResp] = await Promise.allSettled([
            fetch(apiBase + '/api/referral/stats', { headers: { 'X-Telegram-Init': initData } }),
            fetch(apiBase + '/api/pricing/catalog', { headers: { 'X-Telegram-Init': initData } })
          ]);
          var refData = (refResp.status === 'fulfilled') ? await refResp.value.json().catch(function(){ return null; }) : null;
          var pricingData = (pricingResp.status === 'fulfilled') ? await pricingResp.value.json().catch(function(){ return null; }) : null;

          if (nameEl) nameEl.textContent = displayName;
          if (avatarInitialEl) avatarInitialEl.textContent = displayName.charAt(0).toUpperCase();

          // Карточка «Мои данные»
          var pdName     = document.getElementById('profileDataName');
          var pdDate     = document.getElementById('profileDataDate');
          var pdSep      = document.getElementById('profileDataSep');
          var pdCity     = document.getElementById('profileDataCity');
          var pdCitySep  = document.getElementById('profileDataCitySep');
          if (pdName) pdName.textContent = displayName || '—';
          if (pdDate && profileJson.profile && profileJson.profile.birthdate) {
            var bd = new Date(profileJson.profile.birthdate + 'T00:00:00');
            pdDate.textContent = bd.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
            if (pdSep) pdSep.style.display = '';
          } else if (pdDate) {
            pdDate.textContent = '';
            if (pdSep) pdSep.style.display = 'none';
          }
          var cityVal = profileJson.profile && (profileJson.profile.birthplace || profileJson.profile.birth_city || '');
          if (pdCity && cityVal) {
            pdCity.textContent = cityVal;
            if (pdCitySep) pdCitySep.style.display = '';
          } else if (pdCity) {
            pdCity.textContent = '';
            if (pdCitySep) pdCitySep.style.display = 'none';
          }

          // Фото из профиля (приоритет выше Telegram photo_url)
          if (profileJson.profile && profileJson.profile.avatar_url) {
            setAvatarPhoto(profileJson.profile.avatar_url);
          }


          // Реферальные ссылки
          if (refLinkEl) refLinkEl.value = (refData && refData.link) ? refData.link : '';
          var invCount = (refData && typeof refData.invited_count === 'number') ? refData.invited_count : 0;
          if (refInvEl) refInvEl.textContent = invCount;
          if (refRewEl) refRewEl.textContent = (refData && typeof refData.rewarded_count === 'number') ? refData.rewarded_count : 0;

          // Прогресс по milestone-порогам: 1→3→5→10→15
          var refThresholds = [1, 3, 5, 10, 15];
          function nextRefThreshold(n) {
            for (var i = 0; i < refThresholds.length; i++) { if (refThresholds[i] > n) return refThresholds[i]; }
            return 15 + Math.ceil((n - 14) / 5) * 5;
          }
          document.querySelectorAll('.ref-milestone').forEach(function(el) {
            var n = parseInt(el.getAttribute('data-n'), 10);
            el.classList.remove('reached', 'next');
            if (invCount >= n) el.classList.add('reached');
          });
          var nextN = nextRefThreshold(invCount);
          var nextEl = document.querySelector('.ref-milestone[data-n="' + nextN + '"]');
          if (nextEl) nextEl.classList.add('next');
          var hintEl = document.getElementById('profileRefNextHint');
          if (hintEl) {
            var rem = nextN - invCount;
            hintEl.textContent = invCount === 0
              ? 'Пригласи первого друга — получи бесплатную песню'
              : 'До следующей бесплатной песни: ещё ' + rem + ' ' + (rem === 1 ? 'друг' : rem < 5 ? 'друга' : 'друзей');
          }

          // --- Статус подписки (новый API) ---
          var subData = null;
          try {
            var subResp = await fetch(apiBase + '/api/subscription/status', { headers: { 'X-Telegram-Init': initData } });
            subData = await subResp.json().catch(function(){ return null; });
          } catch (subErr) {
            console.warn('[Profile] Не удалось загрузить статус подписки:', subErr);
          }

          var balanceLabelEl = document.getElementById('profileBalanceLabel');
          var balanceHintEl = document.getElementById('profileBalanceHint');
          var renewalDateEl = document.getElementById('profileRenewalDate');

          // Сбрасываем все карточки тарифов в исходное состояние
          var allPlanCards = ['planCardFree','planCardBasic','planCardPlus','planCardMaster'];
          var allPlanBtns = {
            planCardBasic: { btnId: 'planBtnBasic', origText: 'Оформить' },
            planCardPlus:  { btnId: 'planBtnPlus',  origText: 'Оформить' },
            planCardMaster:{ btnId: 'planBtnMaster', origText: 'Открыть Лабораторию' },
          };
          allPlanCards.forEach(function(id) {
            var card = document.getElementById(id);
            if (card) card.classList.remove('current');
          });
          Object.values(allPlanBtns).forEach(function(b) {
            var btn = document.getElementById(b.btnId);
            if (btn) { btn.textContent = b.origText; btn.disabled = false; btn.style.opacity = ''; }
          });

          var subActive = subData && subData.subscription_active;
          var planSku = subData && subData.plan_sku;
          var planName = (subData && subData.plan_name) || 'Free';

          // Карта SKU → ID карточки и цвет
          var planCardMap = {
            soul_basic_sub: { cardId: 'planCardBasic', btnId: 'planBtnBasic', color: 'var(--primary-color)', bg: 'rgba(var(--primary-rgb),0.12)', border: 'rgba(var(--primary-rgb),0.45)' },
            soul_plus_sub:  { cardId: 'planCardPlus',  btnId: 'planBtnPlus',  color: 'var(--secondary-color)', bg: 'rgba(var(--secondary-rgb),0.12)', border: 'rgba(var(--secondary-rgb),0.45)' },
            master_monthly: { cardId: 'planCardMaster', btnId: 'planBtnMaster', color: '#a78bfa', bg: 'rgba(167,139,250,0.12)', border: 'rgba(167,139,250,0.45)' },
          };

          if (subActive && planSku && planCardMap[planSku]) {
            var pm = planCardMap[planSku];
            var tracksUsed = subData.tracks_used_this_month || 0;
            var tracksLimit = subData.tracks_limit || 0;
            var tracksRemaining = subData.tracks_remaining || 0;
            var renewAt = subData.renew_at;
            var renewDateStr = renewAt
              ? new Date(renewAt).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' })
              : null;

            // Бейдж плана
            if (planBadgeEl) {
              planBadgeEl.textContent = '✦ ' + planName;
              planBadgeEl.style.background = pm.bg;
              planBadgeEl.style.borderColor = pm.border;
              planBadgeEl.style.color = pm.color;
              planBadgeEl.title = (typeof t === 'function' ? t('planCurrentBadge') : 'Текущий тариф');
            }

            // Баланс-карточка: счётчик треков
            if (balanceLabelEl) balanceLabelEl.textContent = 'Треков в этом месяце';
            if (creditsEl) creditsEl.textContent = tracksUsed + ' / ' + tracksLimit;
            if (balanceHintEl) balanceHintEl.textContent = tracksRemaining + ' треков ещё доступно';
            if (renewalDateEl && renewDateStr) {
              renewalDateEl.textContent = 'Обновляется ' + renewDateStr;
              renewalDateEl.style.display = '';
            }

            // Выделяем активную карточку
            var cardFree = document.getElementById('planCardFree');
            if (cardFree) cardFree.classList.remove('current');
            var activeCard = document.getElementById(pm.cardId);
            if (activeCard) { activeCard.classList.add('current'); activeCard.style.borderColor = pm.border; }
            var activeBtn = document.getElementById(pm.btnId);
            if (activeBtn) { activeBtn.textContent = '✓ Активен'; activeBtn.disabled = true; activeBtn.style.opacity = '0.5'; }


          } else {
            // Free план
            if (planBadgeEl) { planBadgeEl.textContent = '✦ YupSoul Free'; planBadgeEl.style.background = ''; planBadgeEl.style.borderColor = ''; planBadgeEl.style.color = ''; planBadgeEl.title = (typeof t === 'function' ? t('planCurrentBadge') : 'Текущий тариф'); }
            var credits = (refData && typeof refData.credits === 'number') ? refData.credits : 0;
            if (creditsEl) creditsEl.textContent = credits;
            if (balanceLabelEl) balanceLabelEl.textContent = 'Бесплатных генераций';
            if (balanceHintEl) balanceHintEl.textContent = 'Приглашай друзей — получай треки в подарок';
            if (renewalDateEl) renewalDateEl.style.display = 'none';
            // Бесплатная карточка — текущая
            var cardFree2 = document.getElementById('planCardFree');
            if (cardFree2) cardFree2.classList.add('current');
          }
        } catch (e) {
          console.warn('[Profile] Ошибка загрузки:', e);
          if (nameEl) nameEl.textContent = displayName;
          if (creditsEl) creditsEl.textContent = '—';
          var errWrap = document.getElementById('profileLoadErrorWrap');
          var errText = document.getElementById('profileLoadErrorText');
          if (errWrap) errWrap.style.display = 'block';
          if (errText) errText.textContent = (typeof t === 'function' ? t('profileLoadError') : 'Не удалось загрузить подписку. Проверьте интернет.');
        }
      }

      (function bindProfileLoadRetry() {
        var btn = document.getElementById('profileLoadRetryBtn');
        if (btn) btn.addEventListener('click', function() { if (typeof loadProfilePage === 'function') loadProfilePage(); });
      })();

      // Аккордеон: открыть/закрыть поля формы
      function toggleProfileAccordion() {
        var wrap = document.getElementById('formFieldsWrap');
        var chevron = document.getElementById('pfaChevron');
        if (!wrap) return;
        var isCollapsed = wrap.classList.contains('pfw-collapsed');
        if (isCollapsed) {
          wrap.classList.remove('pfw-collapsed');
          if (chevron) chevron.classList.remove('open');
        } else {
          wrap.classList.add('pfw-collapsed');
          if (chevron) chevron.classList.add('open');
        }
      }
      window.toggleProfileAccordion = toggleProfileAccordion;

      // ── Аккордеон второго человека ──────────────────────────────────────────
      var p2AccOpen = false;
      function toggleSecondPersonAccordion() {
        var wrap = document.getElementById('secondPersonFormWrap');
        var chevron = document.getElementById('p2AccChevron');
        if (!wrap) return;
        p2AccOpen = !p2AccOpen;
        if (p2AccOpen) {
          wrap.style.maxHeight = '2000px';
          wrap.style.opacity = '1';
          if (chevron) chevron.style.transform = 'rotate(180deg)';
        } else {
          wrap.style.maxHeight = '0';
          wrap.style.opacity = '0';
          if (chevron) chevron.style.transform = '';
        }
      }
      window.toggleSecondPersonAccordion = toggleSecondPersonAccordion;

      function openSecondPersonAccordion() {
        if (!p2AccOpen) toggleSecondPersonAccordion();
      }

      function updateP2AccordionSummary() {
        var name2 = (document.getElementById('name2') || {}).value || '';
        var bd2 = (document.getElementById('birthdate2') || {}).value || '';
        var nameEl = document.getElementById('p2AccName');
        var dateEl = document.getElementById('p2AccDate');
        var sepEl  = document.getElementById('p2AccSep');
        if (!nameEl) return;
        if (name2) {
          nameEl.textContent = name2;
          if (bd2 && dateEl) {
            var parts = bd2.split('-');
            dateEl.textContent = parts.length === 3 ? parts[2] + '.' + parts[1] + '.' + parts[0] : bd2;
            if (sepEl) sepEl.style.display = '';
          } else {
            if (dateEl) dateEl.textContent = '';
            if (sepEl) sepEl.style.display = 'none';
          }
        } else {
          nameEl.textContent = 'Данные второго человека';
          if (dateEl) dateEl.textContent = '';
          if (sepEl) sepEl.style.display = 'none';
        }
      }
      window.updateP2AccordionSummary = updateP2AccordionSummary;

      // ── Аккордеон энергии момента ──────────────────────────────────────────
      var transitAccOpen = false;
      function toggleTransitAccordion() {
        var wrap = document.getElementById('transitFormWrap');
        var chevron = document.getElementById('transitAccChevron');
        if (!wrap) return;
        transitAccOpen = !transitAccOpen;
        if (transitAccOpen) {
          wrap.style.maxHeight = '2000px';
          wrap.style.opacity = '1';
          if (chevron) chevron.style.transform = 'rotate(180deg)';
        } else {
          wrap.style.maxHeight = '0';
          wrap.style.opacity = '0';
          if (chevron) chevron.style.transform = '';
        }
      }
      window.toggleTransitAccordion = toggleTransitAccordion;

      function openTransitAccordion() {
        if (!transitAccOpen) toggleTransitAccordion();
      }

      function updateTransitAccordionSummary() {
        var transitDate = (document.getElementById('transitDate') || {}).value || '';
        var transitLocation = (document.getElementById('transitLocation') || {}).value || '';
        var dateEl = document.getElementById('transitAccDate');
        var sepEl  = document.getElementById('transitAccSep');
        if (!dateEl) return;
        var parts = [];
        if (transitDate) {
          var dateParts = transitDate.split('-');
          if (dateParts.length === 3) {
            parts.push(dateParts[2] + '.' + dateParts[1] + '.' + dateParts[0]);
          } else {
            parts.push(transitDate);
          }
        }
        if (transitLocation) {
          parts.push(transitLocation);
        }
        if (parts.length > 0) {
          dateEl.textContent = parts.join(' · ');
          if (sepEl) sepEl.style.display = '';
        } else {
          dateEl.textContent = '';
          if (sepEl) sepEl.style.display = 'none';
        }
      }
      window.updateTransitAccordionSummary = updateTransitAccordionSummary;

      // Следим за полями второго человека для обновления сводки в шапке
      document.addEventListener('DOMContentLoaded', function() {
        ['name2', 'birthdate2'].forEach(function(id) {
          var el = document.getElementById(id);
          if (el) el.addEventListener('change', updateP2AccordionSummary);
          if (el && el.tagName === 'INPUT') el.addEventListener('input', updateP2AccordionSummary);
        });
        // Следим за полями энергии момента для обновления сводки в шапке
        ['transitDate', 'transitLocation'].forEach(function(id) {
          var el = document.getElementById(id);
          if (el) el.addEventListener('change', updateTransitAccordionSummary);
          if (el && el.tagName === 'INPUT') el.addEventListener('input', updateTransitAccordionSummary);
        });
      });

      // Автозаполнение формы из профиля + аккордеон для повторных визитов
      async function loadSavedProfileForForm() {
        var accordion = document.getElementById('profileAccordion');
        var formWrap = document.getElementById('formFieldsWrap');
        // Сброс: скрываем аккордеон, форму держим свёрнутой до получения данных
        if (accordion) accordion.style.display = 'none';
        // Убираем transition на время инициализации — без видимого прыжка
        if (formWrap) { formWrap.classList.add('no-anim'); formWrap.classList.add('pfw-collapsed'); }

        var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        var initData = getInitData();
        if (!apiBase || !initData) {
          // Нет бэкенда — показываем форму открытой сразу, без анимации
          if (formWrap) { formWrap.classList.remove('pfw-collapsed'); formWrap.classList.remove('no-anim'); }
          return;
        }
        try {
          var resp = await fetch(apiBase + '/api/user/profile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
            body: JSON.stringify({ initData: initData })
          });
          var json = await resp.json().catch(function() { return {}; });
          var p = json && json.profile;
          if (!p) {
            // Профиля нет — показываем форму без анимации прыжка
            if (formWrap) {
              formWrap.classList.add('no-anim');
              formWrap.classList.remove('pfw-collapsed');
              // Включаем анимацию обратно после рендера
              requestAnimationFrame(function() { requestAnimationFrame(function() { if (formWrap) formWrap.classList.remove('no-anim'); }); });
            }
            return;
          }

          // Предзаполняем поля формы
          var nameEl = document.getElementById('name');
          var birthdateEl = document.getElementById('birthdate');
          var birthplaceEl = document.getElementById('birthplace');
          var birthtimeEl = document.getElementById('birthtime');
          var unknownEl = document.getElementById('unknown');
          if (nameEl && p.name) nameEl.value = p.name;
          if (birthdateEl && p.birthdate) {
            birthdateEl.value = p.birthdate;
            var parts = p.birthdate.split('-');
            if (parts.length === 3) {
              var dayEl = document.getElementById('birthdateDay');
              var monEl = document.getElementById('birthdateMonth');
              var yrEl  = document.getElementById('birthdateYear');
              if (dayEl) dayEl.value = parseInt(parts[2], 10);
              if (monEl) monEl.value = parseInt(parts[1], 10);
              if (yrEl)  yrEl.value  = parts[0];
              var checkEl = document.getElementById('birthdateCheck');
              if (checkEl) { checkEl.style.display = 'flex'; checkEl.style.opacity = '1'; }
            }
          }
          if (birthplaceEl && p.birthplace) birthplaceEl.value = p.birthplace;
          if (birthtimeEl && p.birthtime) birthtimeEl.value = p.birthtime;
          if (unknownEl && p.birthtime_unknown) unknownEl.checked = true;

          // Язык песни
          var langEl = document.getElementById('language');
          if (langEl) {
            var tgLc = ((tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.language_code) || '').toLowerCase();
            var telegramSongLang = /^uk/.test(tgLc) ? 'uk' : /^en/.test(tgLc) ? 'en' : /^de/.test(tgLc) ? 'de' : /^fr/.test(tgLc) ? 'fr' : 'ru';
            var profileLang = p.language || '';
            if (profileLang && !(profileLang === 'ru' && telegramSongLang !== 'ru')) {
              langEl.value = profileLang;
            } else {
              langEl.value = telegramSongLang;
            }
          }

          // Показываем аккордеон если есть имя И дата рождения (минимум для отправки)
          if (p.name && p.birthdate) {
            var pfaNameEl = document.getElementById('pfaName');
            var pfaDateEl = document.getElementById('pfaDate');
            var pfaSepEl  = document.getElementById('pfaSep');
            var chevronEl = document.getElementById('pfaChevron');
            if (pfaNameEl) pfaNameEl.textContent = p.name;
            var d = new Date(p.birthdate + 'T00:00:00');
            var dateStr = d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
            if (pfaDateEl) pfaDateEl.textContent = dateStr;
            if (pfaSepEl) pfaSepEl.style.display = 'inline';
            if (accordion) accordion.style.display = 'block';
            // Сворачиваем поля — форма заполнена, пользователь может сразу отправить
            if (formWrap) formWrap.classList.add('pfw-collapsed');
            if (chevronEl) chevronEl.classList.add('open');
            // Снимаем no-anim после первого рендера — дальше transitions работают нормально
            requestAnimationFrame(function() { requestAnimationFrame(function() { if (formWrap) formWrap.classList.remove('no-anim'); }); });
          } else {
            // Профиль есть, но данные неполные — показываем форму открытой
            if (formWrap) {
              formWrap.classList.add('no-anim');
              formWrap.classList.remove('pfw-collapsed');
              requestAnimationFrame(function() { requestAnimationFrame(function() { if (formWrap) formWrap.classList.remove('no-anim'); }); });
            }
          }
        } catch(e) {
          console.warn('[Form] Ошибка загрузки профиля:', e);
          // При ошибке — показываем форму открытой, иначе pointer-events:none заблокирует всё
          if (formWrap) { formWrap.classList.remove('pfw-collapsed'); formWrap.classList.remove('no-anim'); }
        }
        // Дефолтный язык по Telegram
        var langElFallback = document.getElementById('language');
        if (langElFallback && !langElFallback.value) {
          var tgLcFb = ((tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.language_code) || '').toLowerCase();
          langElFallback.value = /^uk/.test(tgLcFb) ? 'uk' : /^en/.test(tgLcFb) ? 'en' : /^de/.test(tgLcFb) ? 'de' : /^fr/.test(tgLcFb) ? 'fr' : 'ru';
        }
      }

      // Проверяет при запуске есть ли зависшая заявка (работает и для новичков и для повторных)
      async function checkPendingRequestOnStart() {
        var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        var initData = getInitData();
        if (!apiBase || !initData) return;
        try {
          var resp = await fetch(apiBase + '/api/my/pending-request', { headers: { 'X-Telegram-Init': initData } });
          var json = await resp.json().catch(function() { return {}; });
          if (!resp.ok || !json.ok || !json.pending || !json.request_id) return;
          // Есть зависшая заявка — показываем восстановительный баннер на главной
          pendingPaymentRequestId = json.request_id;
          pendingPaymentSku = json.sku || null;
          var banner = document.getElementById('recoveryBanner');
          var bannerText = document.getElementById('recoveryBannerText');
          var rb = document.getElementById('recoveryClaimBtn');
          if (banner) {
            if (freeTrialAvailable) {
              // Новый пользователь — предлагаем бесплатный ключ
              if (bannerText) bannerText.innerHTML = '<strong style="color:#6ee7b7;">Твоя заявка ждёт!</strong><br>Получи первую песню бесплатно.';
              if (rb) rb.textContent = 'Получить бесплатно';
            } else {
              // Повторный пользователь — у него незавершённая оплата
              if (bannerText) bannerText.innerHTML = '<strong style="color:#6ee7b7;">Незавершённый заказ</strong><br>У тебя есть заявка, ожидающая оплаты.';
              if (rb) rb.textContent = 'Перейти к оплате';
            }
            banner.style.display = 'block';
            // Когда баннер заказа показан — скрываем реферальный блок (не перегружаем экран)
            var refCard = document.getElementById('referralCard');
            if (refCard) refCard.style.display = 'none';
            var dismissBtn = document.getElementById('recoveryDismissBtn');
            if (dismissBtn) dismissBtn.addEventListener('click', function() {
              banner.style.display = 'none';
              if (refCard) refCard.style.display = 'block';
              // Отменяем заявку на сервере — при следующем входе баннер не появится
              var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
              var initData = getInitData();
              if (apiBase && initData && pendingPaymentRequestId) {
                fetch(apiBase + '/api/my/pending-request/dismiss', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
                  body: JSON.stringify({ request_id: pendingPaymentRequestId })
                }).catch(function() {});
              }
            });
            if (rb) rb.addEventListener('click', function() {
              banner.style.display = 'none';
              showPaymentOverlay();
            });
          }
        } catch (e) { /* не критично */ }
      }

      // ── Тогл статистики рефералов ─────────────────────────────────────
      (function() {
        var toggle = document.getElementById('refStatsToggle');
        var block = document.getElementById('refStatsBlock');
        if (!toggle || !block) return;
        toggle.addEventListener('click', function() {
          var open = block.style.display !== 'none';
          block.style.display = open ? 'none' : 'flex';
          toggle.textContent = open ? '▸ моя статистика' : '▾ моя статистика';
          toggle.style.color = open ? 'rgba(var(--primary-rgb),0.4)' : 'rgba(var(--primary-rgb),0.7)';
          if (!open && typeof loadReferralStats === 'function') loadReferralStats();
        });
      })();

      // ── Реферальная кнопка «Поделиться» ──────────────────────────────
      (function() {
        var shareBtn = document.getElementById('referralShareBtn');
        if (!shareBtn) return;
        shareBtn.addEventListener('click', function() {
          var link = (document.getElementById('referralLinkInput') || {}).value || '';
          if (!link) return;
          var tgWeb = window.Telegram && window.Telegram.WebApp;
          if (tgWeb && tgWeb.openTelegramLink) {
            tgWeb.openTelegramLink('https://t.me/share/url?url=' + encodeURIComponent(link) +
              '&text=' + encodeURIComponent('Получи персональную песню бесплатно в YupSoul!'));
          } else if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(link).then(function() {
              shareBtn.textContent = 'Скопировано!';
              setTimeout(function() { shareBtn.textContent = 'Поделиться'; }, 2000);
            });
          } else {
            shareBtn.textContent = 'Скопировано!';
            setTimeout(function() { shareBtn.textContent = 'Поделиться'; }, 2000);
          }
        });
      })();

      // ── Helper-функции для UI промокода и оплаты ──────────────────────
      function showPromoConfirmButton() {
        var hint = document.getElementById('payOvPromoSuccessHint');
        var btn = document.getElementById('payOvPromoConfirmBtn');
        if (hint) hint.style.display = '';
        if (btn) btn.style.display = '';
      }

      function hidePromoConfirmButton() {
        var hint = document.getElementById('payOvPromoSuccessHint');
        var btn = document.getElementById('payOvPromoConfirmBtn');
        if (hint) hint.style.display = 'none';
        if (btn) btn.style.display = 'none';
      }

      function hidePaymentSection() {
        var section = document.getElementById('payOvPaymentSection');
        if (section) section.style.display = 'none';
      }

      function showPaymentSection() {
        var section = document.getElementById('payOvPaymentSection');
        if (section) section.style.display = '';
      }

      function updatePaymentSectionWithDiscount() {
        var priceDisplay = document.getElementById('payOvPriceDisplay');
        var priceHint = document.getElementById('payOvPriceHint');
        
        if (activePromo && priceDisplay) {
          priceDisplay.textContent = activePromo.amount_after + ' ' + activePromo.currency;
        }
        
        if (activePromo && priceHint) {
          priceHint.textContent = '💚 Скидка: ' + activePromo.discount_amount + ' ' + activePromo.currency;
        }
        
        showPaymentSection();
      }

      function resetPaymentUI() {
        hidePromoConfirmButton();
        showPaymentSection();
        
        var priceDisplay = document.getElementById('payOvPriceDisplay');
        var priceHint = document.getElementById('payOvPriceHint');
        
        // Сброс цены к оригинальной (из каталога)
        if (priceDisplay && pricingCatalog && pricingCatalog.length) {
          var item = pricingCatalog.find(function(x) { return x && x.sku === pendingPaymentSku; });
          if (item) {
            priceDisplay.textContent = item.price + ' ' + (item.currency || 'USDT');
          }
        }
        
        if (priceHint) priceHint.textContent = '';
      }

      async function applyPromoCode() {
        var input = document.getElementById('payOvPromoInput') || document.getElementById('promoCodeInput');
        if (!input) return;
        var code = String(input.value || '').trim().toUpperCase();
        if (!code) {
          activePromo = null;
          resetPaymentUI();
          setPaymentStatus(t('promoCleared'), 'warn');
          return;
        }
        var sku = pendingPaymentSku;
        if (!sku) {
          setPaymentStatus('Сначала отправь заявку', 'error');
          return;
        }
        
        var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        var initData = getInitData();
        if (!apiBase || !initData) {
          setPaymentStatus('Нет соединения с сервером', 'error');
          return;
        }
        
        setPaymentStatus('Проверяю промокод...', 'warn');
        
        try {
          var resp = await fetch(apiBase + '/api/promos/validate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
            body: JSON.stringify({ code: code, sku: sku, initData: initData })
          });
          var json = await resp.json().catch(function() { return {}; });
          
          if (!resp.ok || !json.valid) {
            activePromo = null;
            resetPaymentUI();
            var reasonMap = {
              not_found: 'Промокод не найден',
              expired: 'Срок действия промокода истёк',
              not_started: 'Промокод ещё не активен',
              inactive: 'Промокод деактивирован',
              user_limit_reached: 'Вы уже использовали этот промокод',
              global_limit_reached: 'Промокод больше недоступен (лимит исчерпан)',
              sku_mismatch: 'Этот промокод не действует для выбранного типа заявки',
              empty: 'Введите промокод'
            };
            var errMsg = json.error || reasonMap[json.reason] || 'Промокод недействителен';
            throw new Error(errMsg);
          }
          
          activePromo = {
            code: code,
            sku: sku,
            amount_before: json.amount_before,
            amount_after: json.amount_after,
            discount_amount: json.discount_amount,
            currency: json.currency || 'USDT'
          };
          
          var isFree = Number(activePromo.amount_after) === 0;
          
          if (isFree) {
            // Промокод даёт 100% скидку
            setPaymentStatus('Промокод применён! Генерация бесплатна.', 'ok');
            showPromoConfirmButton();
            hidePaymentSection();
          } else {
            // Промокод даёт частичную скидку
            setPaymentStatus('Промокод применён! Скидка: ' + activePromo.discount_amount + ' ' + activePromo.currency, 'ok');
            updatePaymentSectionWithDiscount();
            hidePromoConfirmButton();
          }
          
        } catch (e) {
          setPaymentStatus((e.message || 'Ошибка проверки промокода'), 'error');
        }
      }
      function fetchWithTimeout(url, options, timeoutMs) {
        timeoutMs = timeoutMs || 18000;
        var controller = new AbortController();
        var timeoutId = setTimeout(function() { controller.abort(); }, timeoutMs);
        var opts = options || {};
        opts.signal = controller.signal;
        return fetch(url, opts).then(function(r) {
          clearTimeout(timeoutId);
          return r;
        }, function(err) {
          clearTimeout(timeoutId);
          if (err && err.name === 'AbortError') throw new Error('Превышено время ожидания. Проверь интернет и попробуй снова.');
          throw err;
        });
      }
      function heroesApi(path, opts) {
        var base = (window.HEROES_API_BASE || '').replace(/\/$/, '');
        if (!base) return Promise.reject(new Error('API не настроен'));
        var initData = (tg && tg.initData) ? tg.initData : '';
        var url = base + '/api' + path;
        var sep = path.indexOf('?') >= 0 ? '&' : '?';
        if (initData && (!opts || opts.method === 'GET')) url += sep + 'initData=' + encodeURIComponent(initData);
        if (opts && opts.query) url += (url.indexOf('?') >= 0 ? '&' : '?') + opts.query;
        var options = { headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData } };
        if (opts && opts.method) options.method = opts.method;
        if (opts && opts.body) options.body = JSON.stringify(opts.body);
        return fetchWithTimeout(url, options, 18000).then(function(r) {
          if (r.status === 204) return null;
          return r.json().then(function(j) { if (!r.ok) throw new Error(j.error || r.statusText); return j; });
        });
      }
      function loadMe() {
        if (!(window.HEROES_API_BASE || '').replace(/\/$/, '')) return;
        heroesApi('/me', { method: 'POST', body: { initData: (tg && tg.initData) || '' } }).then(function(d) {
          userTariff = (d && d.tariff) || 'basic';
          var masterNav = document.getElementById('masterNav');
          if (masterNav && userTariff === 'master') masterNav.style.display = 'block';
        }).catch(function() {});
      }
      async function fetchUserProfile() {
        var base = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        if (!base || !tg || !tg.initData) return null;
        try {
          var res = await fetchWithTimeout(base + '/api/user/profile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': tg.initData },
            body: JSON.stringify({ initData: tg.initData })
          }, 18000);
          var json = await res.json().catch(function() { return {}; });
          return json.profile || null;
        } catch (e) { return null; }
      }
      if (tg) loadMe();
      currentLang = detectLang();
      applyTranslations();
      
      // ═══════════════════════════════════════════════════════════════════
      // ═══════════════════════════════════════════════════════════════════
      // ОНБОРДИНГ — формат сторис (прогресс-бары + тап для навигации)
      // ═══════════════════════════════════════════════════════════════════
      (function() {
        var ONBOARDING_KEY = 'yupsoul_onboarding_seen';
        var TOTAL_SLIDES = 3;
        var SLIDE_DURATION = 4500;

        var onboardingPage = document.getElementById('onboardingPage');
        var homePage = document.getElementById('homePage');
        var slides = document.querySelectorAll('.onboarding-slide');
        var skipBtn = document.getElementById('onboardingSkip');
        var startBtn = document.getElementById('onboardingStartBtn');
        var tapPrev = document.getElementById('storiesTapPrev');
        var tapNext = document.getElementById('storiesTapNext');

        var currentStep = 1;
        var autoTimer = null;

        // Устанавливаем CSS-переменную для длительности анимации
        if (onboardingPage) onboardingPage.style.setProperty('--story-dur', (SLIDE_DURATION / 1000) + 's');

        // Получаем fill-элементы прогресс-баров
        function getBar(i) { return document.getElementById('storyBar' + i); }

        function updateBars(activeStep) {
          for (var i = 1; i <= TOTAL_SLIDES; i++) {
            var fill = getBar(i);
            if (!fill) continue;
            // Сброс анимации
            fill.style.transition = 'none';
            if (i < activeStep) {
              fill.style.width = '100%'; // уже просмотрен
            } else if (i === activeStep) {
              fill.style.width = '0%';
              // Принудительный reflow чтобы transition сработал
              void fill.offsetWidth;
              fill.style.transition = 'width ' + (SLIDE_DURATION / 1000) + 's linear';
              fill.style.width = '100%';
            } else {
              fill.style.width = '0%'; // ещё не смотрели
            }
          }
        }

        function showOnboarding() {
          if (onboardingPage) onboardingPage.style.display = 'flex';
          if (homePage) homePage.classList.remove('active');
          goToStep(1);
        }

        function hideOnboarding() {
          if (autoTimer) clearTimeout(autoTimer);
          if (onboardingPage) onboardingPage.style.display = 'none';
          var alreadyActive = document.querySelector('.page.active');
          if (!alreadyActive && homePage) homePage.classList.add('active');
          try { localStorage.setItem(ONBOARDING_KEY, 'true'); } catch(_) {}
        }

        function goToStep(step) {
          if (step < 1) { hideOnboarding(); return; }
          if (step > TOTAL_SLIDES) { hideOnboarding(); return; }

          if (autoTimer) clearTimeout(autoTimer);
          currentStep = step;

          slides.forEach(function(s) {
            s.classList.toggle('active', parseInt(s.dataset.step) === step);
          });

          updateBars(step);

          // Автопереход на следующий слайд (последний — закрыть)
          autoTimer = setTimeout(function() {
            goToStep(currentStep + 1);
          }, SLIDE_DURATION);
        }

        // Кнопка закрыть (X)
        if (skipBtn) skipBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          hideOnboarding();
        });

        // Кнопка «Начать» на последнем слайде
        if (startBtn) startBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          hideOnboarding();
        });

        // Тап-зоны: влево = предыдущий, вправо = следующий
        if (tapPrev) tapPrev.addEventListener('click', function() { goToStep(currentStep - 1); });
        if (tapNext) tapNext.addEventListener('click', function() { goToStep(currentStep + 1); });

        // Поддержка свайпа (дополнительно к зонам тапа)
        var touchStartX = 0;
        if (onboardingPage) {
          onboardingPage.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
          }, { passive: true });
          onboardingPage.addEventListener('touchend', function(e) {
            var dx = e.changedTouches[0].screenX - touchStartX;
            if (Math.abs(dx) > 60) {
              if (dx < 0) goToStep(currentStep + 1);
              else goToStep(currentStep - 1);
            }
          }, { passive: true });
        }

        // Показываем онбординг или гейт
        var _urlParams = typeof window.location !== 'undefined' ? (window.location.search || '') : '';
        var _isPaymentReturn = _urlParams.indexOf('payment=success') !== -1;

        function _hasSeenOnboarding() {
          try { return !!localStorage.getItem(ONBOARDING_KEY); } catch(_) { return false; }
        }

        window.startApp = function() {
          if (_isPaymentReturn || _hasSeenOnboarding()) {
            // Повторный визит или возврат с оплаты — сразу на главную
            if (homePage) homePage.classList.add('active');
            try { localStorage.setItem(ONBOARDING_KEY, 'true'); } catch(_) {}
          } else {
            showOnboarding();
          }
        };
        var startApp = window.startApp;

        // Проверяем, нажал ли пользователь /start в боте
        // Пропускаем проверку: без initData (браузер/превью) или возврат с оплаты
        var _initDataForGate = getInitData ? getInitData() : '';
        var _apiBaseForGate = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        if (_initDataForGate && _apiBaseForGate && !_isPaymentReturn) {
          (function checkBotStarted() {
            var gateEl = document.getElementById('botGatePage');
            fetch(_apiBaseForGate + '/api/user/bot-status', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': _initDataForGate },
              body: JSON.stringify({ initData: _initDataForGate })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
              if (data && data.started === false) {
                // Показываем гейт
                if (gateEl) { gateEl.style.display = 'flex'; }
              } else {
                if (gateEl) gateEl.style.display = 'none';
                startApp();
              }
            })
            .catch(function() {
              // Ошибка сети — не блокируем, пускаем в приложение
              if (gateEl) gateEl.style.display = 'none';
              startApp();
            });
          })();
        } else {
          startApp();
        }
      })();

      // ── Логика гейт-экрана ─────────────────────────────────────────────────
      (function initGateScreen() {
        var gateOpenBtn = document.getElementById('gateOpenBotBtn');
        var gateCheckBtn = document.getElementById('gateCheckBtn');
        var BOT_UN = window.BOT_USERNAME || 'Yup_Soul_bot';
        if (gateOpenBtn) {
          gateOpenBtn.addEventListener('click', function() {
            var botUrl = 'https://t.me/' + BOT_UN + '?start=mini_init';
            if (tg && tg.openTelegramLink) {
              tg.openTelegramLink(botUrl);
            } else {
              window.open(botUrl, '_blank');
            }
          });
        }
        if (gateCheckBtn) {
          gateCheckBtn.addEventListener('click', function() {
            gateCheckBtn.textContent = 'Проверяем…';
            gateCheckBtn.disabled = true;
            var initData = getInitData ? getInitData() : '';
            var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
            if (!initData || !apiBase) { gateCheckBtn.textContent = 'Уже нажал Старт → войти'; gateCheckBtn.disabled = false; return; }
            fetch(apiBase + '/api/user/bot-status', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
              body: JSON.stringify({ initData: initData })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
              if (data && data.started) {
                var gateEl = document.getElementById('botGatePage');
                if (gateEl) gateEl.style.display = 'none';
                if (window.startApp) window.startApp();
              } else {
                gateCheckBtn.textContent = 'Ещё не нажат Старт :(';
                setTimeout(function() { gateCheckBtn.textContent = 'Уже нажал Старт → войти'; gateCheckBtn.disabled = false; }, 2000);
              }
            })
            .catch(function() {
              gateCheckBtn.textContent = 'Уже нажал Старт → войти';
              gateCheckBtn.disabled = false;
            });
          });
        }
      })();

      // Проверяем демо-режим и показываем индикатор
      function checkDemoMode() {
        try {
          var search = (window && window.location && window.location.search) ? window.location.search : '';
          // Явный демо-режим только по флагу в URL (?demo=1 / ?demo=true) или вручную выставленному window.demoMode
          var explicitDemo = /[?&]demo=1(?:&|$)/.test(search) || /[?&]demo=true(?:&|$)/i.test(search);
          if (window.demoMode || explicitDemo) {
            var demoIndicator = document.createElement('div');
            demoIndicator.id = 'demoIndicator';
            demoIndicator.style.cssText = 'position:fixed;top:10px;left:10px;background:rgba(255,165,0,0.9);color:white;padding:8px 12px;border-radius:6px;font-size:12px;z-index:9999;font-weight:600;';
            demoIndicator.textContent = '💡 ДЕМО-РЕЖИМ';
            document.body.appendChild(demoIndicator);
            console.log('[Demo] Индикатор демо-режима добавлен');
          }
        } catch (e) {
          if (window.demoMode) {
            var demoIndicator = document.createElement('div');
            demoIndicator.id = 'demoIndicator';
            demoIndicator.style.cssText = 'position:fixed;top:10px;left:10px;background:rgba(255,165,0,0.9);color:white;padding:8px 12px;border-radius:6px;font-size:12px;z-index:9999;font-weight:600;';
            demoIndicator.textContent = '💡 ДЕМО-РЕЖИМ';
            document.body.appendChild(demoIndicator);
          }
        }
      }
      
      // Проверяем демо-режим через 2 секунды после загрузки
      setTimeout(checkDemoMode, 2000);
      (function initLangSwitcher() {
        var btn = document.getElementById('langSwitcherBtn');
        var dropdown = document.getElementById('langSwitcherDropdown');
        var opts = document.querySelectorAll('.lang-opt');
        function closeDropdown() { if (dropdown) dropdown.setAttribute('hidden', ''); }
        if (btn && dropdown) {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (dropdown.getAttribute('hidden') !== null) dropdown.removeAttribute('hidden');
            else closeDropdown();
          });
          document.addEventListener('click', function() { closeDropdown(); });
          dropdown.addEventListener('click', function(e) { e.stopPropagation(); });
        }
        opts.forEach(function(o) {
          o.addEventListener('click', function() {
            var lang = o.getAttribute('data-lang');
            if (lang) { setLang(lang); closeDropdown(); }
          });
        });
      })();

      setTimeout(function() {
        try {
        // Загружаем каталог цен, free trial, реферальные данные и проверяем зависшие заявки
        loadPricingCatalog();
        (function initProfile() {
          if (!tg || !tg.initData) return;
          fetchUserProfile().then(function(p) {
            userProfile = p;
            var greetEl = document.getElementById('homeGreeting');
            if (greetEl) {
              greetEl.textContent = (p && p.name) ? t('greeting', { name: p.name }) : t('greetingDefault');
              greetEl.style.display = 'block';
            }
          });
        })();
        if (!tg) {
          var p = document.getElementById('previewNav');
          if (p) p.classList.add('show');
          document.body.classList.add('preview-mode');
        }
        var todayStr = new Date().toISOString().split('T')[0];
        var minDate = new Date();
        minDate.setFullYear(minDate.getFullYear() - 100);
        var minDateStr = minDate.toISOString().split('T')[0];
        var birthdateEl = document.getElementById('birthdate');
        if (birthdateEl) {
          birthdateEl.max = todayStr;
          birthdateEl.min = minDateStr;
        }
        var birthdate2El = document.getElementById('birthdate2');
        if (birthdate2El) {
          birthdate2El.max = todayStr;
          birthdate2El.min = minDateStr;
        }
        var unknown = document.getElementById('unknown');
        var birthtime = document.getElementById('birthtime');
        if (unknown && birthtime) unknown.addEventListener('change', function() {
          birthtime.required = !unknown.checked;
        });
        var birthdateWrap = document.getElementById('birthdateWrap');
        var birthdateCheck = document.getElementById('birthdateCheck');
        var birthdateInput = document.getElementById('birthdate');
        var birthplaceInput = document.getElementById('birthplace');
        var monthsRu = ['января','февраля','марта','апреля','мая','июня','июля','августа','сентября','октября','ноября','декабря'];
        var monthsRuNom = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
        function formatDateRu(dateStr) {
          if (!dateStr) return '';
          var d = new Date(dateStr + 'T12:00:00');
          if (isNaN(d.getTime())) return dateStr;
          return d.getDate() + ' ' + monthsRu[d.getMonth()] + ' ' + d.getFullYear() + ' г.';
        }
        (function initDateGroups() {
          var yearEnd = new Date().getFullYear();
          var yearStart = yearEnd - 100;
          function fillOneDateGroup(dayId, monthId, yearId, yearMax) {
            yearMax = yearMax || yearEnd;
            var dSel = document.getElementById(dayId);
            var mSel = document.getElementById(monthId);
            var ySel = document.getElementById(yearId);
            if (dSel) { dSel.innerHTML = '<option value="">День</option>'; for (var i = 1; i <= 31; i++) dSel.innerHTML += '<option value="' + i + '">' + i + '</option>'; }
            if (mSel) { mSel.innerHTML = '<option value="">Месяц</option>'; for (var j = 1; j <= 12; j++) mSel.innerHTML += '<option value="' + j + '">' + monthsRuNom[j - 1] + '</option>'; }
            if (ySel) { ySel.innerHTML = '<option value="">Год</option>'; for (var k = yearMax; k >= yearStart; k--) ySel.innerHTML += '<option value="' + k + '">' + k + '</option>'; }
          }
          function selectsToInput(dayId, monthId, yearId, inputId, wrapId, checkId) {
            var d = document.getElementById(dayId);
            var m = document.getElementById(monthId);
            var y = document.getElementById(yearId);
            var inp = document.getElementById(inputId);
            var wrap = wrapId ? document.getElementById(wrapId) : null;
            var chk = checkId ? document.getElementById(checkId) : null;
            if (!inp || !d || !m || !y) return;
            var day = parseInt(d.value, 10); var month = parseInt(m.value, 10); var year = parseInt(y.value, 10);
            if (!day || !month || !year) { inp.value = ''; if (wrap) wrap.classList.remove('has-date'); if (chk) chk.setAttribute('aria-hidden', 'true'); return; }
            var lastDay = new Date(year, month, 0).getDate();
            if (day > lastDay) day = lastDay;
            var yyyy = year; var mm = month < 10 ? '0' + month : '' + month; var dd = day < 10 ? '0' + day : '' + day;
            inp.value = yyyy + '-' + mm + '-' + dd;
            if (wrap) wrap.classList.add('has-date');
            if (chk) chk.setAttribute('aria-hidden', 'false');
          }
          function inputToSelects(inputId, dayId, monthId, yearId, wrapId, checkId) {
            var inp = document.getElementById(inputId);
            var d = document.getElementById(dayId);
            var m = document.getElementById(monthId);
            var y = document.getElementById(yearId);
            var wrap = wrapId ? document.getElementById(wrapId) : null;
            var chk = checkId ? document.getElementById(checkId) : null;
            if (!inp || !d || !m || !y) return;
            var v = (inp.value || '').trim();
            if (!v) { d.value = ''; m.value = ''; y.value = ''; if (wrap) wrap.classList.remove('has-date'); if (chk) chk.setAttribute('aria-hidden', 'true'); return; }
            var parts = v.split(/[-T]/);
            var yyyy = parseInt(parts[0], 10); var mm = parseInt(parts[1], 10); var dd = parseInt(parts[2], 10);
            if (isNaN(yyyy) || isNaN(mm) || isNaN(dd)) return;
            d.value = dd; m.value = mm; y.value = yyyy;
            if (wrap) wrap.classList.add('has-date');
            if (chk) chk.setAttribute('aria-hidden', 'false');
          }
          // yearEnd = текущий год: можно вводить даты рождения вплоть до сегодня (в т.ч. детей)
          fillOneDateGroup('birthdateDay', 'birthdateMonth', 'birthdateYear', yearEnd);
          fillOneDateGroup('birthdate2Day', 'birthdate2Month', 'birthdate2Year', yearEnd);
          fillOneDateGroup('heroBirthdateDay', 'heroBirthdateMonth', 'heroBirthdateYear', yearEnd);
          [['birthdateDay','birthdateMonth','birthdateYear','birthdate','birthdateWrap','birthdateCheck'],
           ['birthdate2Day','birthdate2Month','birthdate2Year','birthdate2','birthdate2Wrap',null],
           ['heroBirthdateDay','heroBirthdateMonth','heroBirthdateYear','heroBirthdate','heroBirthdateWrap',null]].forEach(function(ids) {
            var dayId = ids[0], monthId = ids[1], yearId = ids[2], inputId = ids[3], wrapId = ids[4], checkId = ids[5];
            var onCh = function() { selectsToInput(dayId, monthId, yearId, inputId, wrapId, checkId); };
            var d = document.getElementById(dayId), m = document.getElementById(monthId), y = document.getElementById(yearId);
            if (d) d.addEventListener('change', onCh);
            if (m) m.addEventListener('change', onCh);
            if (y) y.addEventListener('change', onCh);
            inputToSelects(inputId, dayId, monthId, yearId, wrapId, checkId);
          });
          window.updateDateSelectsFromInput = function(inputId) {
            var map = { birthdate: ['birthdate','birthdateDay','birthdateMonth','birthdateYear','birthdateWrap','birthdateCheck'], birthdate2: ['birthdate2','birthdate2Day','birthdate2Month','birthdate2Year','birthdate2Wrap',null], heroBirthdate: ['heroBirthdate','heroBirthdateDay','heroBirthdateMonth','heroBirthdateYear','heroBirthdateWrap',null] };
            var cfg = map[inputId];
            if (cfg) inputToSelects(cfg[0], cfg[1], cfg[2], cfg[3], cfg[4], cfg[5]);
          };
        })();
        if (birthplaceInput) {
          var suggestionsEl = document.getElementById('birthplaceSuggestions');
          var wrap = document.getElementById('birthplaceWrap');
          var checkEl = document.getElementById('birthplaceCheck');
          var hintEl = document.getElementById('birthplaceHint');
          var debounceTimer = null;
          var lastSearch = '';
          function hideSuggestions() {
            if (suggestionsEl) { suggestionsEl.innerHTML = ''; suggestionsEl.setAttribute('aria-hidden', 'true'); suggestionsEl.style.display = 'none'; }
          }
          function showPlaceConfirm(displayName) {}
          function selectPlace(displayName, lat, lon) {
            var full = (displayName || '').trim();
            birthplaceInput.value = full;
            birthplaceInput.setAttribute('title', full);
            birthplaceInput.setAttribute('data-place-selected', '1');
            if (lat != null && lon != null) {
              birthplaceInput.setAttribute('data-lat', String(lat));
              birthplaceInput.setAttribute('data-lon', String(lon));
            }
            if (wrap) wrap.classList.add('has-place');
            if (checkEl) checkEl.setAttribute('aria-hidden', 'false');
            if (hintEl) hintEl.style.display = 'none';
            showPlaceConfirm(displayName);
            hideSuggestions();
          }
          function clearPlaceSelection() {
            birthplaceInput.removeAttribute('data-place-selected');
            birthplaceInput.removeAttribute('data-lat');
            birthplaceInput.removeAttribute('data-lon');
            if (wrap) wrap.classList.remove('has-place');
            if (checkEl) checkEl.setAttribute('aria-hidden', 'true');
            if (hintEl) hintEl.style.display = 'none';
          }
          function fetchPlaces(q) {
            if (!q || q.length < 2) { hideSuggestions(); return; }
            var url = typeof getPlacesSearchUrl === 'function' ? getPlacesSearchUrl(q) : ('https://nominatim.openstreetmap.org/search?q=' + encodeURIComponent(q) + '&format=json&limit=8&addressdetails=1');
            var headers = { 'Accept': 'application/json' };
            if (url.indexOf('nominatim') !== -1) { headers['Accept-Language'] = 'ru'; headers['User-Agent'] = 'YupSoulMiniApp/1.0 (contact@yupsoul.com)'; }
            fetch(url, { headers: headers })
              .then(function(r) { return r.json(); })
              .then(function(list) {
                if (lastSearch !== q) return;
                if (!suggestionsEl) return;
                suggestionsEl.innerHTML = '';
                (list || []).forEach(function(item) {
                  var li = document.createElement('li');
                  var main = item.display_name || (item.address && (item.address.city || item.address.town || item.address.village || item.address.state || item.address.country));
                  var sub = item.address && item.address.country ? (item.address.country + (item.address.country_code ? ' (' + item.address.country_code.toUpperCase() + ')' : '')) : '';
                  li.textContent = main;
                  if (sub) { var sp = document.createElement('div'); sp.className = 'place-type'; sp.textContent = sub; li.appendChild(sp); }
                  var lat = item.lat; var lon = item.lon;
                  li.addEventListener('click', function() { selectPlace(item.display_name || main, lat, lon); });
                  suggestionsEl.appendChild(li);
                });
                suggestionsEl.style.display = (list && list.length) ? 'block' : 'none';
                suggestionsEl.setAttribute('aria-hidden', list && list.length ? 'false' : 'true');
              })
              .catch(function() { hideSuggestions(); });
          }
          birthplaceInput.addEventListener('input', function() {
            var v = birthplaceInput.value.trim();
            clearPlaceSelection();
            if (v) {
              lastSearch = v;
              clearTimeout(debounceTimer);
              debounceTimer = setTimeout(function() { fetchPlaces(v); }, 320);
            } else {
              hideSuggestions();
            }
          });
          birthplaceInput.addEventListener('focus', function() {
            var v = birthplaceInput.value.trim();
            var isSelected = !!birthplaceInput.getAttribute('data-place-selected');
            if (hintEl) hintEl.style.display = (!v && !isSelected) ? 'block' : 'none';
            if (v && v.length >= 2) { lastSearch = v; fetchPlaces(v); }
          });
          birthplaceInput.addEventListener('blur', function() {
            setTimeout(hideSuggestions, 200);
            if (hintEl) hintEl.style.display = 'none';
          });
          if (birthplaceInput.value.trim() && birthplaceInput.getAttribute('data-place-selected') && wrap) {
            wrap.classList.add('has-place');
            if (checkEl) checkEl.setAttribute('aria-hidden', 'false');
          }
        }
        var birthplace2Input = document.getElementById('birthplace2');
        if (birthplace2Input) {
          var sugg2El = document.getElementById('birthplaceSuggestions2');
          var wrap2El = document.getElementById('birthplace2Wrap');
          var check2El = document.getElementById('birthplace2Check');
          var hint2El = document.getElementById('birthplace2Hint');
          var debounce2 = null;
          var lastSearch2 = '';
          function hideSuggestions2() {
            if (sugg2El) { sugg2El.innerHTML = ''; sugg2El.setAttribute('aria-hidden', 'true'); sugg2El.style.display = 'none'; }
          }
          function selectPlace2(displayName, lat, lon) {
            var full = (displayName || '').trim();
            birthplace2Input.value = full;
            birthplace2Input.setAttribute('data-place-selected', '1');
            if (lat != null && lon != null) {
              birthplace2Input.setAttribute('data-lat', String(lat));
              birthplace2Input.setAttribute('data-lon', String(lon));
            }
            if (wrap2El) wrap2El.classList.add('has-place');
            if (check2El) check2El.setAttribute('aria-hidden', 'false');
            if (hint2El) hint2El.style.display = 'none';
            hideSuggestions2();
          }
          function clearPlace2Selection() {
            birthplace2Input.removeAttribute('data-place-selected');
            birthplace2Input.removeAttribute('data-lat');
            birthplace2Input.removeAttribute('data-lon');
            if (wrap2El) wrap2El.classList.remove('has-place');
            if (check2El) check2El.setAttribute('aria-hidden', 'true');
          }
          function fetchPlaces2(q) {
            if (!q || q.length < 2) { hideSuggestions2(); return; }
            var url = typeof getPlacesSearchUrl === 'function' ? getPlacesSearchUrl(q) : ('https://nominatim.openstreetmap.org/search?q=' + encodeURIComponent(q) + '&format=json&limit=8&addressdetails=1');
            var headers = { 'Accept': 'application/json' };
            if (url.indexOf('nominatim') !== -1) { headers['Accept-Language'] = 'ru'; headers['User-Agent'] = 'YupSoulMiniApp/1.0 (contact@yupsoul.com)'; }
            fetch(url, { headers: headers })
              .then(function(r) { return r.json(); })
              .then(function(list) {
                if (lastSearch2 !== q) return;
                if (!sugg2El) return;
                sugg2El.innerHTML = '';
                (list || []).forEach(function(item) {
                  var li = document.createElement('li');
                  var main = item.display_name || (item.address && (item.address.city || item.address.town || item.address.village || item.address.state || item.address.country));
                  var sub = item.address && item.address.country ? (item.address.country + (item.address.country_code ? ' (' + item.address.country_code.toUpperCase() + ')' : '')) : '';
                  li.textContent = main;
                  if (sub) { var sp = document.createElement('div'); sp.className = 'place-type'; sp.textContent = sub; li.appendChild(sp); }
                  var lat = item.lat; var lon = item.lon;
                  li.addEventListener('click', function() { selectPlace2(item.display_name || main, lat, lon); });
                  sugg2El.appendChild(li);
                });
                sugg2El.style.display = (list && list.length) ? 'block' : 'none';
                sugg2El.setAttribute('aria-hidden', (list && list.length) ? 'false' : 'true');
              })
              .catch(function() { hideSuggestions2(); });
          }
          birthplace2Input.addEventListener('input', function() {
            var v = birthplace2Input.value.trim();
            clearPlace2Selection();
            if (v) { lastSearch2 = v; clearTimeout(debounce2); debounce2 = setTimeout(function() { fetchPlaces2(v); }, 320); }
            else { hideSuggestions2(); }
          });
          birthplace2Input.addEventListener('focus', function() {
            var v = birthplace2Input.value.trim();
            var isSelected2 = !!birthplace2Input.getAttribute('data-place-selected');
            if (hint2El) hint2El.style.display = (!v && !isSelected2) ? 'block' : 'none';
            if (v && v.length >= 2) { lastSearch2 = v; fetchPlaces2(v); }
          });
          birthplace2Input.addEventListener('blur', function() {
            setTimeout(hideSuggestions2, 200);
            if (hint2El) hint2El.style.display = 'none';
          });
        }
        var transitLocationInput = document.getElementById('transitLocation');
        if (transitLocationInput) {
          var debounceTransit = null;
          transitLocationInput.addEventListener('input', function() {
            var self = this;
            clearTimeout(debounceTransit);
            debounceTransit = setTimeout(function() { showLocationSuggestions(self, 'transitLocationSuggestions', null); }, 320);
          });
        }
        var formPage = document.getElementById('formPage');
        if (formPage && userTariff === 'master') loadForWhoSelect();
      
      // ── Soul Chat: полный UI на soulChatPage (initSoulChatPage). Старый блок карточки удалён. ──
      var scCurrentRequestId = null;
      window._scLastRequestId = null;
      window._scHasProfile    = false;
      window._scIsMaster      = false;
      window._scRequestId2    = null;
      window._scUserCards     = [];
      window._scPickerMode    = 'single';
      window._scPickerSelA    = null;
      window._scPickerSelB    = null;

      // ══════════════ SOUL CHAT PAGE ══════════════
      function goToSoulChat() {
        window.returnToPage = 'homePage';
        window._scHistoryLoaded = false; // При каждом открытии страницы история подгружается заново
        goToPage('soulChatPage');
      }
      window.goToSoulChat = goToSoulChat;

      async function initSoulChatPage() {
        var scHeader    = document.getElementById('scHeader');
        var scChatHdr   = document.getElementById('scChatHeader');
        var promoArea   = document.getElementById('scPromoArea');
        var chatEl      = document.getElementById('scPageChat');
        var inputArea   = document.getElementById('scInputArea');
        var loadEl      = document.getElementById('scPageLoading');
        var globalLoad  = document.getElementById('scGlobalLoading');
        var giftWrap    = document.getElementById('scPageGiftWrap');
        var buyDayWrap  = document.getElementById('scPageBuyDayWrap');
        var errorWrap   = document.getElementById('scPromoErrorWrap');
        var retryBtn    = document.getElementById('scPromoRetryBtn');

        function hideGlobalLoading() {
          if (globalLoad) globalLoad.style.display = 'none';
          if (loadEl) loadEl.style.display = 'none';
        }

        // Защита от зависания: через 3 сек принудительно убираем «Проверяем доступ» и показываем промо с сообщением об ошибке
        var accessTimeout = setTimeout(function() {
          var stillChecking = (loadEl && loadEl.style.display !== 'none') || (globalLoad && globalLoad.style.display !== 'none');
          if (stillChecking) {
            hideGlobalLoading();
            if (scHeader) scHeader.style.display = '';
            if (scChatHdr) scChatHdr.style.display = 'none';
            if (promoArea) promoArea.style.display = '';
            if (chatEl) chatEl.style.display = 'none';
            if (inputArea) inputArea.style.display = 'none';
            if (giftWrap) giftWrap.style.display = 'none';
            if (buyDayWrap) buyDayWrap.style.display = '';
            if (errorWrap) errorWrap.style.display = '';
          }
        }, 3000);

        // Переключение между промо-режимом и чат-режимом. isLoadError = true при таймауте/сети/ошибке
        function showPromo(isLoadError) {
          if (accessTimeout) { clearTimeout(accessTimeout); accessTimeout = null; }
          hideGlobalLoading();
          if (scHeader)   scHeader.style.display   = '';
          if (scChatHdr)  scChatHdr.style.display  = 'none';
          if (promoArea)  promoArea.style.display   = '';
          if (chatEl)     chatEl.style.display      = 'none';
          if (inputArea)  inputArea.style.display   = 'none';
          if (errorWrap)  errorWrap.style.display   = (isLoadError ? '' : 'none');
        }
        function showChat() {
          if (accessTimeout) { clearTimeout(accessTimeout); accessTimeout = null; }
          hideGlobalLoading();
          if (scHeader)   scHeader.style.display   = 'none';
          if (scChatHdr)  { scChatHdr.style.display = 'flex'; }
          if (promoArea)  promoArea.style.display   = 'none';
          if (chatEl)     { chatEl.style.display = 'flex'; chatEl.scrollTop = 0; }
          if (inputArea)  inputArea.style.display   = '';
        }

        // Сразу показываем экран подписки (шапка + промо), внутри — «Проверяем доступ…». Так пользователь не висит на полном экране загрузки.
        if (scHeader)   scHeader.style.display   = '';
        if (promoArea)  promoArea.style.display  = '';
        if (loadEl)     loadEl.style.display     = 'block';
        if (globalLoad) globalLoad.style.display = 'none';
        if (chatEl)     chatEl.style.display     = 'none';
        if (inputArea)  inputArea.style.display  = 'none';
        if (scChatHdr)  scChatHdr.style.display  = 'none';
        if (giftWrap)   giftWrap.style.display   = 'none';
        if (buyDayWrap) buyDayWrap.style.display  = 'none';
        if (errorWrap)  errorWrap.style.display   = 'none';

        try {
          var apiBase  = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
          var initData = typeof getInitData === 'function' ? getInitData() : '';
          if (!apiBase || !initData) {
            showPromo(true);
            return;
          }

          var resp = await fetchWithTimeout(apiBase + '/api/soul-chat/access', {
            method: 'GET',
            headers: { 'X-Telegram-Init': initData }
          }, 15000);
          var json = await resp.json().catch(function(){ return {}; });

          // При любой ошибке HTTP (401, 403, 5xx) — показываем окно с состоянием подписки и сообщением об ошибке
          if (!resp.ok) {
            showPromo(true);
            return;
          }

          window._scLastRequestId = (json && json.last_request_id) || null;
          window._scHasProfile   = !!(json && json.has_profile);
          window._scIsMaster     = !!(json && json.is_master);

          if (json && json.allowed === true) {
            var hadReturnFlag = false;
            try {
              var ts = sessionStorage.getItem('soul_chat_return_from_payment');
              if (ts && (Date.now() - parseInt(ts, 10)) < 5 * 60 * 1000) { hadReturnFlag = true; sessionStorage.removeItem('soul_chat_return_from_payment'); }
            } catch(_) {}
            if (hadReturnFlag && typeof showToast === 'function') showToast(typeof t === 'function' ? t('scToastPaymentReceived') : 'Оплата получена, доступ открыт');
            showChat();
            // Если нет данных — показываем блок-подсказку, скрываем поле ввода
            var noReqEl  = document.getElementById('scPageNoRequest');
            var hasData  = window._scLastRequestId || window._scHasProfile;
            if (!hasData) {
              if (noReqEl)   noReqEl.style.display   = '';
              if (inputArea) inputArea.style.display  = 'none';
            } else {
              if (noReqEl)   noReqEl.style.display   = 'none';
            }
            // Кнопка выбора карточек — только для Master
            var cardPickerBtn = document.getElementById('scCardPickerBtn');
            if (window._scIsMaster) {
              if (cardPickerBtn) cardPickerBtn.style.display = '';
              scLoadUserCards(apiBase, initData);
            } else {
              if (cardPickerBtn) cardPickerBtn.style.display = 'none';
              // Тизер синастрии для Basic/Plus
              var teaserEl = document.getElementById('scSynastryTeaser');
              if (teaserEl) teaserEl.style.display = '';
            }
            // Обновляем заголовок кнопки карточки
            scUpdateCardPickerLabel();
            // Таймер доступа
            var timerEl = document.getElementById('scPageTimer');
            if (timerEl && json.expires_at) {
              timerEl.style.display = 'inline-block';
              var exp = new Date(json.expires_at);
              var updateTimer = function() {
                var diff = Math.max(0, exp - Date.now());
                var h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000);
                timerEl.textContent = 'Доступ: ещё ' + h + 'ч ' + m + 'мин';
                if (diff > 0) setTimeout(updateTimer, 60000);
              };
              updateTimer();
            }
            // Загружаем историю диалогов
            scLoadHistory(apiBase, initData);
          } else {
            // Нет доступа — показываем промо (шапка + зона с тарифами/подарком), убираем загрузку (не ошибка)
            showPromo(false);
            if (json && json.trial_available) {
              if (giftWrap)   giftWrap.style.display   = '';
              if (buyDayWrap) buyDayWrap.style.display  = 'none';
            } else {
              if (giftWrap)   giftWrap.style.display   = 'none';
              if (buyDayWrap) buyDayWrap.style.display  = '';
            }
          }
        } catch(e) {
          // Ошибка (сеть, getInitData, разбор ответа) — показываем промо с сообщением об ошибке
          showPromo(true);
        }
      }

      (function bindScPromoRetry() {
        var btn = document.getElementById('scPromoRetryBtn');
        if (btn) btn.addEventListener('click', function() { initSoulChatPage(); });
      })();

      // Загрузка и отображение истории диалогов Soul Chat
      window._scHistoryLoaded = false;
      async function scLoadHistory(apiBase, initData) {
        if (window._scHistoryLoaded) return; // Уже загружали в этой сессии
        var historyEl = document.getElementById('scPageHistory');
        if (!historyEl) return;

        // Мгновенно показываем кэш из localStorage
        var cacheKey = 'scHistory_' + (window._tgUserId || 'anon');
        try {
          var cached = localStorage.getItem(cacheKey);
          if (cached) {
            var cachedMsgs = JSON.parse(cached);
            if (Array.isArray(cachedMsgs) && cachedMsgs.length > 0) {
              scRenderHistory(historyEl, cachedMsgs);
              window._scHistoryLoaded = true;
            }
          }
        } catch(e) {}

        // Запрашиваем актуальную историю с сервера
        try {
          var r = await fetchWithTimeout(apiBase + '/api/soul-chat/history', {
            headers: { 'X-Telegram-Init': initData }
          }, 15000);
          var d = await r.json().catch(function(){ return {}; });
          if (d.success && Array.isArray(d.messages)) {
            // Если с сервера больше сообщений — перерисовываем
            scRenderHistory(historyEl, d.messages);
            window._scHistoryLoaded = true;
            try { localStorage.setItem(cacheKey, JSON.stringify(d.messages.slice(-50))); } catch(e) {}
          }
        } catch(e) {}

        // Прокручиваем вниз
        var chatEl = document.getElementById('scPageChat');
        if (chatEl) setTimeout(function(){ chatEl.scrollTop = chatEl.scrollHeight; }, 100);
      }

      function scRenderHistory(historyEl, messages) {
        historyEl.innerHTML = '';
        if (!messages || messages.length === 0) return;
        // Метка «начало истории»
        var divider = document.createElement('div');
        divider.style.cssText = 'text-align:center;font-size:0.72rem;color:rgba(255,255,255,0.25);padding:6px 0 10px;';
        divider.textContent = '✦ история переписки ✦';
        historyEl.appendChild(divider);
        messages.forEach(function(msg) {
          scPageAddMsg('user', msg.question);
          scPageAddMsg('soul', msg.answer);
        });
      }

      // ── Card Picker (синастрия) ─────────────────────────────────────────────
      async function scLoadUserCards(apiBase, initData) {
        try {
          var r = await fetch(apiBase + '/api/user/cards', {
            headers: { 'X-Telegram-Init': initData }
          });
          var d = await r.json().catch(function(){ return {}; });
          if (d.success && Array.isArray(d.cards)) {
            window._scUserCards = d.cards;
            // Если текущая карточка есть — предвыбрать её
            if (!window._scPickerSelA && window._scLastRequestId) {
              window._scPickerSelA = window._scLastRequestId;
            }
            scUpdateCardPickerLabel();
          }
        } catch(e) {}
      }

      function scCardLabel(card) {
        if (!card) return '—';
        var icon = card.mode === 'couple' ? ' ♥' : '';
        if (card.mode === 'couple' && card.person2_name) {
          return card.name + ' & ' + card.person2_name + icon;
        }
        return card.name + (card.birthdate ? ', ' + card.birthdate : '') + icon;
      }

      function scUpdateCardPickerLabel() {
        var btn = document.getElementById('scCardPickerBtn');
        if (!btn) return;
        var cards = window._scUserCards || [];
        var selA = window._scPickerSelA || window._scLastRequestId;
        var selB = window._scRequestId2;
        var cardA = cards.find(function(c){ return c.id === selA; });
        var cardB = selB ? cards.find(function(c){ return c.id === selB; }) : null;
        if (cardA && cardB) {
          var nameA = cardA.name || '?';
          var nameB = cardB.name || '?';
          btn.textContent = nameA + ' ↔ ' + nameB + ' ▾';
        } else if (cardA) {
          btn.textContent = scCardLabel(cardA) + ' ▾';
        } else {
          btn.textContent = 'Выбрать карточку ▾';
        }
      }

      function scBuildPickerList(containerId, selectedId, onSelect) {
        var container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        var cards = window._scUserCards || [];
        if (cards.length === 0) {
          container.innerHTML = '<div style="color:rgba(255,255,255,0.35);font-size:0.82rem;text-align:center;padding:12px 0;">' + (typeof t === 'function' ? t('noCardsYet') : 'Нет завершённых карточек') + '</div>';
          return;
        }
        cards.forEach(function(card) {
          var isSelected = card.id === selectedId;
          var item = document.createElement('button');
          item.type = 'button';
          item.className = 'btn-secondary';
          item.style.cssText = 'width:100%;text-align:left;padding:9px 12px;border-radius:10px;font-family:inherit;font-size:0.84rem;cursor:pointer;border:1px solid ' +
            (isSelected ? 'rgba(var(--primary-rgb),0.5)' : 'rgba(255,255,255,0.1)') + ';background:' +
            (isSelected ? 'rgba(var(--primary-rgb),0.14)' : 'rgba(255,255,255,0.04)') + ';color:' +
            (isSelected ? 'var(--primary-color)' : 'rgba(255,255,255,0.75)') + ';';
          item.textContent = scCardLabel(card);
          item.setAttribute('data-id', card.id);
          item.addEventListener('click', function() { onSelect(card.id); });
          container.appendChild(item);
        });
      }

      function scSetPickerMode(mode) {
        window._scPickerMode = mode;
        var singlePane = document.getElementById('scPickerSinglePane');
        var synPane = document.getElementById('scPickerSynastryPane');
        var tabSingle = document.getElementById('scPickerTabSingle');
        var tabSyn = document.getElementById('scPickerTabSynastry');
        var activeTab = 'border:1px solid rgba(var(--primary-rgb),0.5);background:rgba(var(--primary-rgb),0.18);color:var(--primary-color);';
        var inactiveTab = 'border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.5);';
        if (mode === 'single') {
          if (singlePane) singlePane.style.display = 'flex';
          if (synPane)    synPane.style.display    = 'none';
          if (tabSingle)  tabSingle.style.cssText  += activeTab;
          if (tabSyn)     tabSyn.style.cssText     += inactiveTab;
          scBuildPickerList('scPickerSingleList', window._scPickerSelA || window._scLastRequestId, function(id) {
            window._scPickerSelA = id;
            window._scRequestId2 = null;
            scBuildPickerList('scPickerSingleList', id, arguments.callee);
          });
        } else {
          if (singlePane) singlePane.style.display = 'none';
          if (synPane)    synPane.style.display    = 'flex';
          if (tabSingle)  tabSingle.style.cssText  += inactiveTab;
          if (tabSyn)     tabSyn.style.cssText     += activeTab;
          var rebuildA = function(selId) {
            window._scPickerSelA = selId;
            scBuildPickerList('scPickerSynListA', selId, rebuildA);
          };
          var rebuildB = function(selId) {
            window._scPickerSelB = selId;
            scBuildPickerList('scPickerSynListB', selId, rebuildB);
          };
          scBuildPickerList('scPickerSynListA', window._scPickerSelA || window._scLastRequestId, rebuildA);
          scBuildPickerList('scPickerSynListB', window._scPickerSelB, rebuildB);
        }
      }

      function scOpenCardPicker() {
        var modal = document.getElementById('scCardPickerModal');
        if (!modal) return;
        modal.style.display = '';
        // Перезапускаем текущий режим чтобы отрисовать актуальный список
        scSetPickerMode(window._scPickerMode || 'single');
      }
      window.scOpenCardPicker = scOpenCardPicker;

      function scCloseCardPicker() {
        var modal = document.getElementById('scCardPickerModal');
        if (modal) modal.style.display = 'none';
      }
      window.scCloseCardPicker = scCloseCardPicker;

      function scApplyCardPicker() {
        if (window._scPickerMode === 'single') {
          var selA = window._scPickerSelA || window._scLastRequestId;
          window._scLastRequestId = selA || window._scLastRequestId;
          window._scRequestId2 = null;
        } else {
          var selA2 = window._scPickerSelA || window._scLastRequestId;
          var selB2 = window._scPickerSelB;
          if (selA2) window._scLastRequestId = selA2;
          window._scRequestId2 = (selB2 && selB2 !== selA2) ? selB2 : null;
        }
        scUpdateCardPickerLabel();
        scCloseCardPicker();
      }
      window.scApplyCardPicker = scApplyCardPicker;
      // ── /Card Picker ────────────────────────────────────────────────────────

      // Кнопка «Подробнее» в промо Soul Chat
      (function() {
        var btn = document.getElementById('scMoreBtn');
        var content = document.getElementById('scMoreContent');
        var textEl = document.getElementById('scMoreBtnText');
        if (!btn || !content) return;
        btn.addEventListener('click', function() {
          if (content.style.display === 'none') {
            content.style.display = 'block';
            if (textEl) textEl.textContent = (typeof t === 'function' ? t('scMoreBtnCollapse') : 'Свернуть ↑');
          } else {
            content.style.display = 'none';
            if (textEl) textEl.textContent = (typeof t === 'function' ? t('scMoreBtnText') : 'Подробнее ↓');
          }
        });
      })();

      // Кнопка «Купить 24ч доступ» на странице Soul Chat
      (function() {
        var btn = document.getElementById('scPageBuyDayBtn');
        var statusEl = document.getElementById('scPageBuyDayStatus');
        if (!btn) return;
        btn.addEventListener('click', async function() {
          btn.disabled = true; btn.textContent = 'Создаю ссылку…';
          var apiBase  = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
          var initData = getInitData();
          if (!apiBase || !initData) { btn.disabled = false; btn.textContent = 'Открыть Soul Chat на 24ч — $2.99'; return; }
          try {
            var r = await fetch(apiBase + '/api/soul-chat/buy-day', {
              method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
              body: JSON.stringify({ initData: initData })
            });
            var j = await r.json().catch(function(){ return {}; });
            if (j && j.checkout_url) {
              try { sessionStorage.setItem('soul_chat_return_from_payment', Date.now().toString()); } catch(_) {}
              window.open(j.checkout_url, '_blank');
              if (statusEl) { statusEl.textContent = 'Ссылка открыта — после оплаты вернись сюда'; statusEl.style.display = ''; }
              btn.disabled = false; btn.textContent = 'Открыть Soul Chat на 24ч — $2.99';
            } else {
              btn.disabled = false; btn.textContent = 'Открыть Soul Chat на 24ч — $2.99';
              if (statusEl) { statusEl.textContent = j && j.error ? j.error : 'Ошибка. Попробуй ещё раз.'; statusEl.style.display = ''; }
            }
          } catch(e) { btn.disabled = false; btn.textContent = 'Открыть Soul Chat на 24ч — $2.99'; }
        });
      })();

      // Кнопка «Получить подарок» на странице Soul Chat
      (function() {
        var btn = document.getElementById('scPageGiftBtn');
        if (!btn) return;
        btn.addEventListener('click', async function() {
          btn.disabled = true; btn.textContent = 'Активирую…';
          var apiBase  = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
          var initData = getInitData();
          if (!apiBase || !initData) { btn.disabled = false; btn.textContent = 'Попробовать'; return; }
          try {
            var r = await fetch(apiBase + '/api/soul-chat/activate-gift', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ initData: initData })
            });
            var j = await r.json().catch(function(){ return {}; });
            if (j && (j.ok || j.success)) {
              initSoulChatPage();
            } else {
              btn.disabled = false; btn.textContent = 'Получить 24 часа бесплатно';
              alert(j && j.error ? j.error : 'Ошибка активации');
            }
          } catch(e) { btn.disabled = false; btn.textContent = 'Получить 24 часа бесплатно'; }
        });
      })();

      // Добавляет сообщение в историю Soul Chat (глобальная функция)
      function scPageAddMsg(role, text) {
        var historyEl = document.getElementById('scPageHistory');
        if (!historyEl) return;
        var isUser = (role === 'user');
        var wrap = document.createElement('div');
        wrap.className = isUser ? 'sc-msg-user' : 'sc-msg-soul';
        var bubble = document.createElement('div');
        bubble.className = isUser ? 'sc-bubble-user' : 'sc-bubble-soul';
        bubble.textContent = text;
        wrap.appendChild(bubble);
        historyEl.appendChild(wrap);
        var chatEl = document.getElementById('scPageChat');
        if (chatEl) chatEl.scrollTop = chatEl.scrollHeight;
      }

      // Кнопка «Спросить» на странице Soul Chat
      (function() {
        var sendBtn   = document.getElementById('scPageSendBtn');
        var questionEl = document.getElementById('scPageQuestion');
        var statusEl   = document.getElementById('scPageStatus');
        if (!sendBtn || !questionEl) return;

        sendBtn.addEventListener('click', async function() {
          var question = questionEl.value.trim();
          if (!question) return;
          var apiBase  = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
          var initData = getInitData();
          if (!apiBase || !initData) return;

          scPageAddMsg('user', question);
          questionEl.value = '';
          questionEl.blur();
          sendBtn.disabled = true;
          if (statusEl) { statusEl.textContent = '🧘 Слушаю душу…'; statusEl.style.display = ''; }

          try {
            var resp = await fetchWithTimeout(apiBase + '/api/soul-chat', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
              body: JSON.stringify({
                initData: initData,
                question: question,
                request_id: window._scLastRequestId || '',
                request_id_2: window._scRequestId2 || ''
              })
            }, 20000);
            var json = await resp.json().catch(function(){ return {}; });
            var answer = (json && json.data && json.data.answer) || (json && json.answer) || null;
            if (answer) {
              scPageAddMsg('soul', answer);
              // Обновляем кэш истории в localStorage
              try {
                var cacheKey = 'scHistory_' + (window._tgUserId || 'anon');
                var cached = JSON.parse(localStorage.getItem(cacheKey) || '[]');
                cached.push({ question: question, answer: answer, created_at: new Date().toISOString() });
                localStorage.setItem(cacheKey, JSON.stringify(cached.slice(-50)));
              } catch(ex) {}
            } else if (json && json.error) {
              scPageAddMsg('soul', '❌ ' + json.error);
              if (!json.success) setTimeout(function(){ initSoulChatPage(); }, 1200);
            } else {
              scPageAddMsg('soul', '❌ Ошибка. Попробуй ещё раз.');
            }
          } catch(e) {
            scPageAddMsg('soul', '❌ Ошибка соединения.');
          } finally {
            sendBtn.disabled = false;
            if (statusEl) statusEl.style.display = 'none';
          }
        });

        // Счётчик символов
        var charHintEl = document.getElementById('scPageCharHint');
        questionEl.addEventListener('input', function() {
          var len = questionEl.value.length;
          if (charHintEl) charHintEl.textContent = len > 10 ? len + ' симв.' : '';
        });

        // Ctrl+Enter/Cmd+Enter для отправки
        questionEl.addEventListener('keydown', function(e) {
          if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') sendBtn.click();
        });
      })();
      // ═══════════════════════════════════════════

      // Навигация по страницам
      function goToPage(pageId) {
        if (!pageId) {
          console.warn('[goToPage] pageId пустой — переходим на homePage');
          pageId = 'homePage';
        }
        var currentPage = document.querySelector('.page.active');
        
        if (tg && tg.MainButton && tg.MainButton.hide) tg.MainButton.hide();
        // Всегда проверяем кнопку оплаты при переходах между страницами
        ensurePayButtonText();
        
        var target = document.getElementById(pageId);
        if (!target) {
          console.warn('[goToPage] Страница не найдена:', pageId, '— переходим на homePage');
          target = document.getElementById('homePage');
          if (!target) return;
        }
        // Сначала показываем целевую страницу — без кадра «все скрыты» (убирает прыжок при входе в Soul Chat и др.)
        target.classList.add('active');
        target.setAttribute('role', 'main');
        document.querySelectorAll('.page').forEach(function(page) {
          if (page !== target) {
            page.classList.remove('active');
            page.removeAttribute('role');
          }
        });
        // На всякий случай скрываем онбординг если он остался видимым
        var obp = document.getElementById('onboardingPage');
        if (obp && obp.style.display !== 'none') obp.style.display = 'none';
        // Сброс скролла у .page-scroll целевой страницы (после отрисовки, чтобы не дергало)
        try {
          var scrollArea = document.querySelector('#' + pageId + ' .page-scroll');
          if (scrollArea) {
            scrollArea.scrollTop = 0;
          }
          if (pageId === 'soulChatPage') {
            var scChat = document.getElementById('scPageChat');
            if (scChat) scChat.scrollTop = 0;
          }
        } catch(e) {}
        if (pageId === 'formPage' && userTariff === 'master') loadForWhoSelect();
        if (pageId === 'formPage') loadSavedProfileForForm();
        if (pageId === 'homePage' && typeof loadReferralStats === 'function') loadReferralStats();
        if (pageId === 'profilePage' && typeof loadProfilePage === 'function') loadProfilePage();
        // paymentPage теперь overlay — здесь ничего не делаем
        // Soul Chat блок удалён со successPage — initSoulChat вызывать не нужно
        if (pageId === 'soulChatPage') initSoulChatPage();
        if (document.getElementById('previewNav') && document.getElementById('previewNav').classList.contains('show')) {
          document.querySelectorAll('.preview-nav button').forEach(function(btn) {
            btn.classList.remove('active');
          });
          var pageMap = { 'homePage': 'home', 'formPage': 'form', 'paymentPage': 'payment', 'loadingPage': 'loading', 'successPage': 'success', 'heroesPage': 'heroes', 'paymentThanksPage': 'payment' };
          var activeBtn = document.querySelector('.preview-nav button[data-page="' + (pageMap[pageId] || '') + '"]');
          if (activeBtn) activeBtn.classList.add('active');
        }
      }
      // Делаем goToPage глобальной — нужно для onclick-атрибутов (кнопка Помощь, кнопки назад)
      window.goToPage = goToPage;
      window.returnToPage = null;
      function goBack() {
        var target = window.returnToPage || 'homePage';
        window.returnToPage = null;
        goToPage(target);
      }
      window.goBack = goBack;
      function goToProfileFrom(from) { window.returnToPage = from; goToPage('profilePage'); }
      function goToMasterPlanFrom(from) {
        window.returnToPage = from;
        goToPage('profilePage');
        setTimeout(function() {
          var el = document.getElementById('planCardMaster');
          if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 200);
      }
      window.goToMasterPlanFrom = goToMasterPlanFrom;
      function goToHeroesFrom(from) { window.returnToPage = from; goToPage('heroesPage'); initHeroesPage(); }
      function goToHelpFrom(from) { window.returnToPage = from; goToPage('helpPage'); }
      window.goToProfileFrom = goToProfileFrom;
      window.goToHeroesFrom = goToHeroesFrom;
      window.goToHelpFrom = goToHelpFrom;

      // Сворачиваемый реферальный блок
      var referralToggleBtn = document.getElementById('referralToggleBtn');
      if (referralToggleBtn) {
        referralToggleBtn.addEventListener('click', function() {
          var body = document.getElementById('referralBody');
          var chevron = document.getElementById('referralToggleChevron');
          if (!body) return;
          var isOpen = body.style.display !== 'none';
          body.style.display = isOpen ? 'none' : 'block';
          if (chevron) chevron.style.transform = isOpen ? '' : 'rotate(90deg)';
          if (!isOpen && typeof loadReferralStats === 'function') loadReferralStats();
        });
      }

      // Редирект с HOT: при открытии с ?payment=success показываем страницу «Спасибо за оплату»
      var search = typeof window.location !== 'undefined' && window.location.search ? window.location.search : '';
      var paymentThanksMsg = document.getElementById('paymentThanksMessage');
      if (search.indexOf('payment=success') !== -1) {
        goToPage('paymentThanksPage');
        var requestIdMatch = search.match(/request_id=([^&\s]+)/);
        var thanksRequestId = requestIdMatch ? decodeURIComponent(requestIdMatch[1]) : null;

        // Мгновенно определяем тип оплаты из localStorage (сохранили перед редиректом на HOT)
        var pendingPayment = null;
        try {
          var _pp = localStorage.getItem('pending_payment_type');
          if (_pp) { pendingPayment = JSON.parse(_pp); localStorage.removeItem('pending_payment_type'); }
        } catch(e) {}
        var isSubPaymentImmediate = pendingPayment && pendingPayment.type === 'subscription'
          && pendingPayment.ts && (Date.now() - pendingPayment.ts) < 30 * 60 * 1000; // не старше 30 мин

        if (isSubPaymentImmediate) {
          // Сразу показываем экран подписки — без ожидания API
          var subName = pendingPayment.plan_name || (
            pendingPayment.plan_key === 'plan_basic' ? 'Basic' :
            pendingPayment.plan_key === 'plan_plus' ? 'Plus' : 'Лаборатория');
          var ptTitle = document.getElementById('paymentThanksTitle');
          var ptSubtitle = document.getElementById('paymentThanksSubtitle');
          var ptHint = document.getElementById('paymentThanksHint');
          var ptBackBtn = document.getElementById('paymentThanksBackBtn');
          if (ptTitle) ptTitle.textContent = t('subActivated');
          if (ptSubtitle) ptSubtitle.textContent = subName;
          if (paymentThanksMsg) paymentThanksMsg.innerHTML =
            t('subscriptionActive').replace('—', '<br>').replace('продолжить', 'продолжить 🎶') ||
            ('Твой план <strong>' + subName + '</strong> активен.<br><span style="opacity:0.7">Треки и Soul Chat доступны.</span>');
          if (ptHint) {
            ptHint.style.display = '';
            ptHint.textContent = 'Если тариф не обновился — обнови страницу или закрой и открой приложение.';
          }
          if (ptBackBtn) {
            ptBackBtn.textContent = t('subBtnProfile');
            ptBackBtn.onclick = function() {
              goToPage('profilePage');
              setTimeout(function() { if (typeof loadProfilePage === 'function') loadProfilePage(); }, 400);
            };
          }
        }

        (async function checkPaymentAndConfirm() {
          if (!thanksRequestId) {
            if (!isSubPaymentImmediate) {
              var ptTitle = document.getElementById('paymentThanksTitle');
              var ptSub = document.getElementById('paymentThanksSubtitle');
              var ptBack = document.getElementById('paymentThanksBackBtn');
              if (paymentThanksMsg) paymentThanksMsg.textContent = t('songInProgress');
              if (ptTitle) ptTitle.textContent = typeof t === 'function' ? t('paymentThanks') : 'Спасибо за оплату';
              if (ptSub) ptSub.textContent = typeof t === 'function' ? t('thanksSubtitle') : 'заявка принята';
              if (ptBack) { ptBack.textContent = (typeof t === 'function' ? t('paymentThanksBackToForm') : 'Создать свою песню'); ptBack.onclick = function() { goToPage('formPage'); }; }
            }
            return;
          }
          var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
          var initData = (tg && tg.initData) ? tg.initData : (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) || '';
          if (!apiBase || !initData) {
            if (paymentThanksMsg && !isSubPaymentImmediate) paymentThanksMsg.textContent = t('songInProgress');
            return;
          }
          try {
            var payStatus = '';
            var payMode = '';
            var isSub = isSubPaymentImmediate;

            // Определяем ожидаемый plan_sku по plan_key из localStorage
            var LOCAL_PLAN_SKU_MAP = { plan_basic: 'soul_basic_sub', plan_plus: 'soul_plus_sub', plan_master: 'master_monthly' };
            var expectedPlanSku = (pendingPayment && pendingPayment.plan_key)
              ? (LOCAL_PLAN_SKU_MAP[pendingPayment.plan_key] || null)
              : null;

            // ── Для подписок: моментально запускаем claim (без задержки) и повторяем до успеха ──
            if (isSubPaymentImmediate && thanksRequestId) {
              (async function runClaimLoop() {
                var maxClaimAttempts = 25;
                var claimIntervalMs = 1500;
                for (var ci = 0; ci < maxClaimAttempts; ci++) {
                  try {
                    var claimResp = await fetch(apiBase + '/api/subscription/claim', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
                      body: JSON.stringify({ request_id: thanksRequestId, initData: initData })
                    });
                    var claimJson = await claimResp.json().catch(function(){ return {}; });
                    if (claimJson && claimJson.success) {
                      console.log('[sub] claim ok:', claimJson.status, 'plan:', claimJson.plan_sku);
                      var curPage = document.querySelector('.page.active');
                      if (curPage && curPage.id === 'profilePage' && typeof loadProfilePage === 'function') {
                        setTimeout(function() { loadProfilePage(); }, 200);
                      }
                      return;
                    }
                    if (claimResp.status !== 202) break;
                  } catch(claimErr) {
                    console.warn('[sub] claim attempt', ci, claimErr && claimErr.message);
                  }
                  if (ci < maxClaimAttempts - 1) await new Promise(function(r){ setTimeout(r, claimIntervalMs); });
                }
              })();
            }

            // ── Поллинг payment_status (вебхук путь) ──
            var maxAttempts = isSubPaymentImmediate ? 20 : 5;
            var delayMs = 3000;
            for (var attempt = 0; attempt < maxAttempts; attempt++) {
              try {
                var statusResp = await fetchWithTimeout(apiBase + '/api/payments/hot/status?request_id=' + encodeURIComponent(thanksRequestId), {
                  headers: { 'X-Telegram-Init': initData }
                }, 10000);
                var statusJson = await statusResp.json().catch(function() { return {}; });
                payStatus = statusJson && statusJson.data && statusJson.data.payment_status ? String(statusJson.data.payment_status).toLowerCase() : '';
                payMode = statusJson && statusJson.data && statusJson.data.mode ? String(statusJson.data.mode) : '';
                if (payStatus === 'paid') break;
              } catch (statusErr) {
                console.warn('[payment/return] status attempt', attempt, statusErr && statusErr.message);
              }
              if (attempt < maxAttempts - 1) await new Promise(function(r) { setTimeout(r, delayMs); });
            }
            isSub = isSubPaymentImmediate || (payMode && payMode.startsWith('sub_'));

            if (payStatus === 'paid') {
              // Моментально: confirm + один запрос subscription/status (запускает repair_on_read)
              fetch(apiBase + '/api/payments/hot/confirm', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
                body: JSON.stringify({ request_id: thanksRequestId, initData: initData })
              }).catch(function(){});
              if (isSub) {
                fetch(apiBase + '/api/subscription/status', { headers: { 'X-Telegram-Init': initData } }).catch(function(){});
              }
            } else if (isSub && thanksRequestId) {
              // Вебхук не пришёл за 60 сек — финальный вызов claim (страховка)
              try {
                await fetch(apiBase + '/api/subscription/claim', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
                  body: JSON.stringify({ request_id: thanksRequestId, initData: initData })
                });
              } catch(e) {}
            }

            // ── Ждём появления нужной подписки в БД, обновляем кнопку ──
            // Важно: проверяем конкретный plan_sku (защита от апгрейда Basic→Plus,
            // когда subscription_active=true ещё от Basic, но Plus ещё не активирован)
            if (isSub) {
              var expectedSkuFromMode = payMode.startsWith('sub_') ? payMode.slice(4) : null;
              var targetPlanSku = expectedSkuFromMode || expectedPlanSku || null;
              var subCheckDelayMs = 800;
              for (var si = 0; si < 20; si++) {
                if (si > 0) await new Promise(function(r){ setTimeout(r, subCheckDelayMs); });
                try {
                  var subCheckResp = await fetch(apiBase + '/api/subscription/status', { headers: { 'X-Telegram-Init': initData } });
                  var subCheckJson = await subCheckResp.json().catch(function(){ return {}; });
                  // Если знаем ожидаемый план — ждём именно его (апгрейд Basic→Plus)
                  var planMatched = subCheckJson && subCheckJson.subscription_active &&
                    (!targetPlanSku || subCheckJson.plan_sku === targetPlanSku);
                  if (planMatched) {
                    var ptB2 = document.getElementById('paymentThanksBackBtn');
                    if (ptB2 && !ptB2._subConfirmed) {
                      ptB2._subConfirmed = true;
                      ptB2.textContent = '✓ ' + t('subBtnProfile');
                    }
                    // После подтверждения — обновляем профиль если он открыт
                    var curPg = document.querySelector('.page.active');
                    if (curPg && curPg.id === 'profilePage' && typeof loadProfilePage === 'function') {
                      setTimeout(function() { loadProfilePage(); }, 300);
                    }
                    break;
                  }
                } catch(e2) {}
              }
            }
            // Если не знали про подписку из localStorage — определяем по mode
            if (!isSubPaymentImmediate) {
              var isSubFromMode = payMode.startsWith('sub_');
              if (isSubFromMode && paymentThanksMsg) {
                var sn = payMode.includes('basic') ? 'Basic' : payMode.includes('plus') ? 'Plus' : 'Лаборатория';
                var ptT = document.getElementById('paymentThanksTitle');
                var ptS = document.getElementById('paymentThanksSubtitle');
                var ptH = document.getElementById('paymentThanksHint');
                var ptB = document.getElementById('paymentThanksBackBtn');
                if (ptT) ptT.textContent = t('subActivated');
                if (ptS) ptS.textContent = sn;
                paymentThanksMsg.innerHTML = 'Plan <strong>' + sn + '</strong> — ' + t('subscriptionActive');
                if (ptH) ptH.style.display = 'none';
                if (ptB) { ptB.textContent = t('subBtnProfile'); ptB.onclick = function() { goToPage('profilePage'); setTimeout(function() { if(typeof loadProfilePage==='function') loadProfilePage(); }, 600); }; }
              } else if (paymentThanksMsg) {
                paymentThanksMsg.textContent = t('songInProgressConfirmed');
              }
            }
          } catch (e) {
            console.warn('[payment/return] Ошибка проверки оплаты:', e && e.message);
            if (paymentThanksMsg) {
              paymentThanksMsg.innerHTML = (isSubPaymentImmediate || (payMode && String(payMode).startsWith('sub_')))
                ? 'Оплата получена. Если тариф не обновился — <strong>обнови страницу</strong> или закрой и открой приложение.'
                : t('songInProgress');
            }
            var ptHint = document.getElementById('paymentThanksHint');
            if (ptHint) { ptHint.style.display = ''; ptHint.textContent = 'Деньги списались? Тариф подтянется в течение минуты. Если нет — напиши в поддержку.'; }
          }
        })().catch(function(err) {
          console.warn('[payment/return] Необработанная ошибка:', err && err.message);
          var msg = document.getElementById('paymentThanksMessage');
          var hint = document.getElementById('paymentThanksHint');
          if (msg) msg.innerHTML = 'Оплата получена. Если тариф не обновился — <strong>обнови страницу</strong> или закрой и открой приложение.';
          if (hint) { hint.style.display = ''; hint.textContent = 'Деньги списались? Тариф подтянется в течение минуты. Если нет — напиши в поддержку.'; }
        });
        if (window.history && window.history.replaceState) {
          var cleanUrl = window.location.pathname + (window.location.hash || '');
          window.history.replaceState({}, '', cleanUrl);
        }
      }
      var paymentThanksBackBtn = document.getElementById('paymentThanksBackBtn');
      if (paymentThanksBackBtn) paymentThanksBackBtn.addEventListener('click', function() {
        goToPage('formPage');
      });

      // Открытие через кнопку «Оплатить сейчас» из бота: ?request_id=X без payment=success
      // Проверяем статус заявки и автоматически показываем нужный экран
      if (search.indexOf('payment=success') === -1) {
        var botRidMatch = search.match(/request_id=([^&\s]+)/);
        var botRequestId = botRidMatch ? decodeURIComponent(botRidMatch[1]) : null;
        if (botRequestId) {
          (async function checkBotPendingRequest() {
            try {
              var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
              var initData = (tg && tg.initData) ? tg.initData : '';
              if (!apiBase || !initData) return;
              var resp = await fetchWithTimeout(apiBase + '/api/payments/hot/status?request_id=' + encodeURIComponent(botRequestId), {
                headers: { 'X-Telegram-Init': initData }
              }, 10000);
              var json = await resp.json().catch(function() { return {}; });
              var gs = json && json.data ? String(json.data.generation_status || '').toLowerCase() : '';
              var ps = json && json.data ? String(json.data.payment_status || '').toLowerCase() : '';
              if (gs === 'pending_payment' || ps === 'requires_payment') {
                // Заявка ещё не оплачена — показываем оверлей оплаты
                pendingPaymentRequestId = botRequestId;
                var mode = json.data && json.data.mode ? String(json.data.mode) : 'single';
                if (mode === 'couple') pendingPaymentSku = 'couple_song';
                else if (mode === 'transit') pendingPaymentSku = 'transit_energy_song';
                else pendingPaymentSku = 'single_song';
                showPaymentOverlay();
              } else if (['completed', 'processing', 'suno_processing', 'lyrics_generated', 'astro_calculated'].includes(gs)
                         || ['paid', 'subscription_active', 'gift_used', 'promo_applied'].includes(ps)) {
                // Заявка уже в работе — ничего делать не нужно, остаёмся на главном экране
                console.log('[BotLink] Заявка уже оплачена/в работе:', gs, ps);
              }
            } catch (e) {
              console.warn('[BotLink] Ошибка проверки заявки:', e.message);
            }
          })();
        }
      }

      // Кнопки навигации
      var startBtn = document.getElementById('startBtn');
      if (startBtn) startBtn.addEventListener('click', function() {
        fillFormFromProfile(userProfile || (tg && tg.initDataUnsafe && tg.initDataUnsafe.user));
        goToPage('formPage');
      });


      var stepNext = document.getElementById('stepNext');

      function applyTheme() {
        // Фон и контраст заточены под тёмную тему; светлая тема даёт нечитаемые цвета — всегда тёмная.
        document.body.classList.remove('theme-light', 'theme-dark');
        document.body.classList.add('theme-dark');
      }
      applyTheme();
      try {
        if (tg && tg.onEvent) tg.onEvent('themeChanged', applyTheme);
      } catch (_) {}

      function toggleFormsByMode(mode) {
        var p2Accordion = document.getElementById('secondPersonAccordion');
        var transitAccordion = document.getElementById('transitAccordion');
        if (p2Accordion) p2Accordion.style.display = 'none';
        if (transitAccordion) transitAccordion.style.display = 'none';
        if (mode === 'couple') {
          if (p2Accordion) {
            p2Accordion.style.display = 'block';
            // Авто-открыть если ещё закрыт
            setTimeout(function() { openSecondPersonAccordion(); }, 80);
          }
        } else if (mode === 'transit') {
          if (transitAccordion) {
            transitAccordion.style.display = 'block';
            // Авто-открыть если ещё закрыт
            setTimeout(function() { openTransitAccordion(); }, 80);
          }
        }
        if (mode !== 'couple') {
          var p2r = document.getElementById('person2Relationship');
          if (p2r) p2r.value = '';
          // Закрыть аккордеон при смене режима
          if (p2AccOpen) toggleSecondPersonAccordion();
        }
        if (mode !== 'transit') {
          // Закрыть аккордеон энергии момента при смене режима
          if (transitAccOpen) toggleTransitAccordion();
        }
      }

      function updateStepUI() {
        document.querySelectorAll('.mode-btn').forEach(function(btn) { btn.style.display = ''; });
      }

      function setMode(mode) {
        selectedMode = mode || 'single';
        document.querySelectorAll('.mode-btn').forEach(function(btn) {
          btn.classList.toggle('active', btn.getAttribute('data-mode') === selectedMode);
        });
        toggleFormsByMode(selectedMode);
        // Если пользователь выбирает режим — показываем поля формы, чтобы можно было сразу заполнить/редактировать
        try {
          var formWrap = document.getElementById('formFieldsWrap');
          if (formWrap && formWrap.classList.contains('pfw-collapsed')) {
            formWrap.classList.remove('pfw-collapsed');
            formWrap.classList.remove('no-anim');
          }
        } catch (e) { /* безопасно */ }
        updatePaymentUiFromCatalog();
      }

      function validateStep(step) {
        if (step === 1) {
          selectedMode = selectedMode || 'single';
          return true;
        }
        if (step === 2) {
          var nameEl = document.getElementById('name');
          var name = (nameEl ? nameEl.value : '').trim();
          var birthdateEl = document.getElementById('birthdate');
          var birthdate = birthdateEl ? birthdateEl.value : '';
          var birthplaceEl = document.getElementById('birthplace');
          var birthplace = (birthplaceEl ? birthplaceEl.value : '').trim();
          var unknownEl = document.getElementById('unknown');
          var birthtimeEl = document.getElementById('birthtime');
          var birthtimeVal = (unknownEl && unknownEl.checked) ? 'ok' : (birthtimeEl ? birthtimeEl.value : '');
          var genderEl = document.getElementById('gender');
          var gender = genderEl ? genderEl.value : '';
          var langEl = document.getElementById('language');
          var language = langEl ? langEl.value : '';
          if (name.length < 2) { alert(t('alertNameShort')); return false; }
          if (!birthdate) { alert(t('alertBirthdate')); return false; }
          if (birthplace.length < 3) { alert(t('alertBirthplace')); return false; }
          var birthplaceField = document.getElementById('birthplace');
          var hasCoords = birthplaceField && birthplaceField.getAttribute('data-lat') && birthplaceField.getAttribute('data-lon');
          var hasPlaceSelected = birthplaceField && birthplaceField.getAttribute('data-place-selected');
          var fromProfile = birthplaceField && birthplaceField.getAttribute('data-from-profile') === '1';
          if (!hasCoords && !hasPlaceSelected && !fromProfile) {
            var birthplaceHint = document.getElementById('birthplaceHint');
            if (birthplaceHint) birthplaceHint.style.display = 'block';
            try { birthplaceField && birthplaceField.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (_) {}
            alert(t('alertBirthplaceHint'));
            return false;
          }
          if (!birthtimeVal) { alert(t('alertBirthtime')); return false; }
          if (!gender) { alert(t('alertGender')); return false; }
          if (!language) { alert(t('alertLanguage')); return false; }
          if (selectedMode === 'couple') {
            var name2 = (document.getElementById('name2').value || '').trim();
            var birthdate2 = document.getElementById('birthdate2').value;
            var birthplace2El = document.getElementById('birthplace2');
            var birthplace2 = birthplace2El ? birthplace2El.value.trim() : '';
            var bp2PlaceSelected = birthplace2El && birthplace2El.getAttribute('data-place-selected');
            var bp2FromProfile = birthplace2El && birthplace2El.getAttribute('data-from-profile') === '1';
            if (name2.length < 2) { alert(t('alertName2Short')); return false; }
            if (!birthdate2) { alert(t('alertBirthdate2')); return false; }
            if (birthplace2.length < 3) { alert(t('alertBirthplace2')); return false; }
            if (!bp2PlaceSelected && !bp2FromProfile) {
              alert(t('alertBirthplaceHint'));
              try { birthplace2El && birthplace2El.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (_) {}
              return false;
            }
            var birthtime2Val = (document.getElementById('unknown2') && document.getElementById('unknown2').checked) ? 'ok' : (document.getElementById('birthtime2') ? document.getElementById('birthtime2').value : '');
            if (!birthtime2Val) { alert(t('alertBirthtime2')); return false; }
            if (!(document.getElementById('gender2') && document.getElementById('gender2').value)) { alert(t('alertGender2')); return false; }
          }
          if (selectedMode === 'transit') {
            var tDate = document.getElementById('transitDate').value;
            var tLoc = document.getElementById('transitLocation').value.trim();
            if (!tDate) { alert(t('alertTransitDate')); return false; }
            if (!tLoc) { alert(t('alertTransitLocation')); return false; }
          }
          return true;
        }
        if (step === 3) {
          var request = document.getElementById('request').value.trim();
          if (request.length < 5) { alert(t('alertRequestShort')); return false; }
          return true;
        }
        return true;
      }

      document.querySelectorAll('.mode-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          if (e.target.classList.contains('mode-info')) return;
          setMode(this.getAttribute('data-mode'));
        });
      });

      // Тултип для кнопок режима
      (function() {
        var tooltip = document.getElementById('modeTooltip');
        var tooltipTimer = null;
        function hideTooltip() {
          if (tooltip) tooltip.style.display = 'none';
          clearTimeout(tooltipTimer);
        }
        document.querySelectorAll('.mode-info').forEach(function(icon) {
          icon.addEventListener('click', function(e) {
            e.stopPropagation();
            if (!tooltip) return;
            var descEl = this.closest('.mode-btn').querySelector('.mode-desc');
            var text = descEl ? descEl.textContent.trim() : '';
            if (!text) return;
            tooltip.textContent = text;
            var rect = this.getBoundingClientRect();
            tooltip.style.display = 'block';
            var tw = tooltip.offsetWidth || 180;
            var left = Math.min(rect.left, window.innerWidth - tw - 12);
            tooltip.style.left = Math.max(8, left) + 'px';
            tooltip.style.top = (rect.bottom + 8) + 'px';
            clearTimeout(tooltipTimer);
            tooltipTimer = setTimeout(hideTooltip, 3000);
          });
        });
        document.addEventListener('click', hideTooltip);
      })();

      function toggleQuickPicker(e) {
        if (e) e.stopPropagation();
        var btn = document.getElementById('quickPickerBtn');
        var sheet = document.getElementById('quickPickerSheet');
        var arrow = document.getElementById('quickPickerArrow');
        if (!btn || !sheet) return;
        var isOpen = sheet.style.display !== 'none';
        if (isOpen) {
          sheet.style.display = 'none';
          btn.classList.remove('open');
          if (arrow) arrow.style.transform = '';
        } else {
          sheet.style.display = 'block';
          btn.classList.add('open');
          if (arrow) arrow.style.transform = 'rotate(180deg)';
        }
      }
      // Экспортируем в глобальный scope — onclick-атрибут требует window.*
      window.toggleQuickPicker = toggleQuickPicker;

      (function() {
        document.addEventListener('click', function(e) {
          var sheet = document.getElementById('quickPickerSheet');
          var btn = document.getElementById('quickPickerBtn');
          if (!sheet || sheet.style.display === 'none') return;
          var box = document.querySelector('.request-input-box');
          if (box && box.contains(e.target)) return;
          sheet.style.display = 'none';
          if (btn) btn.classList.remove('open');
          var arrow = document.getElementById('quickPickerArrow');
          if (arrow) arrow.style.transform = '';
        });

        setTimeout(function() {
          var sheet = document.getElementById('quickPickerSheet');
          if (!sheet) return;
          sheet.querySelectorAll('.quick-item').forEach(function(item) {
            item.addEventListener('click', function() {
              var requestField = document.getElementById('request');
              if (requestField) {
                requestField.value = this.getAttribute('data-text') || '';
                requestField.focus();
              }
              sheet.style.display = 'none';
              var btn = document.getElementById('quickPickerBtn');
              if (btn) btn.classList.remove('open');
              var arrow = document.getElementById('quickPickerArrow');
              if (arrow) arrow.style.transform = '';
            });
          });
        }, 300);
      })();

      if (stepNext) stepNext.addEventListener('click', async function() {
        if (!validateStep(1) || !validateStep(2) || !validateStep(3)) return;
        var mode = selectedMode || 'single';
        var name1 = document.getElementById('name').value.trim();
        var birthdate1 = document.getElementById('birthdate').value;
        var birthplace1 = document.getElementById('birthplace').value.trim();
        var birthtime1 = document.getElementById('birthtime').value;
        var birthtimeUnknown1 = document.getElementById('unknown').checked;
        var gender1 = document.getElementById('gender').value;
        var requestText = document.getElementById('request').value.trim();
        if (name1.length < 2) { alert(t('alertNameShort')); return; }
        if (!birthdate1) { alert(t('alertBirthdate')); return; }
        if (birthplace1.length < 3) { alert(t('alertBirthplace')); return; }
        if (!birthtimeUnknown1 && !birthtime1) { alert(t('alertBirthtime')); return; }
        if (!gender1) { alert(t('alertGender')); return; }
        if (requestText.length < 15) { alert(t('alertRequestLong')); return; }
        var songLangEl = document.getElementById('language');
        var songLanguage = (songLangEl && songLangEl.value) ? songLangEl.value : 'ru';
        var payload = {
          mode: mode,
          person1: { name: name1, birthdate: birthdate1, birthplace: birthplace1, birthtime: birthtimeUnknown1 ? null : birthtime1, birthtimeUnknown: birthtimeUnknown1, gender: gender1 },
          request: requestText,
          language: songLanguage
        };
        // Если есть активный промокод — передаём его серверу для проверки ДО 402
        if (activePromo && activePromo.code) {
          payload.promo_code = activePromo.code;
        }
        var preferredStyleEl = document.getElementById('requestPreferredStyle');
        if (preferredStyleEl && preferredStyleEl.value.trim()) {
          payload.preferred_style = preferredStyleEl.value.trim();
        }
        var birthplaceField = document.getElementById('birthplace');
        if (birthplaceField && birthplaceField.getAttribute('data-lat') && birthplaceField.getAttribute('data-lon')) {
          payload.person1.birthplaceLat = parseFloat(birthplaceField.getAttribute('data-lat'));
          payload.person1.birthplaceLon = parseFloat(birthplaceField.getAttribute('data-lon'));
        }
        var forWho = document.getElementById('forWho');
        if (forWho && forWho.value && userTariff === 'master') payload.clientId = forWho.value;
        if (mode === 'couple') {
          var name2 = document.getElementById('name2').value.trim();
          var birthdate2 = document.getElementById('birthdate2').value;
          var birthplace2 = document.getElementById('birthplace2').value.trim();
          var birthtime2 = document.getElementById('birthtime2').value;
          var birthtimeUnknown2 = document.getElementById('unknown2').checked;
          var gender2 = document.getElementById('gender2').value;
          if (name2.length < 2) { alert(t('alertName2Short')); return; }
          if (!birthdate2) { alert(t('alertBirthdate2')); return; }
          if (birthplace2.length < 3) { alert(t('alertBirthplace2')); return; }
          if (!birthtimeUnknown2 && !birthtime2) { alert(t('alertBirthtime2')); return; }
          if (!gender2) { alert(t('alertGender2')); return; }
          var p2relField = document.getElementById('person2Relationship');
          var relationship2 = p2relField ? p2relField.value.trim() : '';
          payload.person2 = { name: name2, birthdate: birthdate2, birthplace: birthplace2, birthtime: birthtimeUnknown2 ? null : birthtime2, birthtimeUnknown: birthtimeUnknown2, gender: gender2 };
          if (relationship2) payload.person2.relationship = relationship2;
          var bp2Field = document.getElementById('birthplace2');
          if (bp2Field && bp2Field.getAttribute('data-lat') && bp2Field.getAttribute('data-lon')) {
            payload.person2.birthplaceLat = parseFloat(bp2Field.getAttribute('data-lat'));
            payload.person2.birthplaceLon = parseFloat(bp2Field.getAttribute('data-lon'));
          }
        }
        if (mode === 'transit') {
          var transitDate = document.getElementById('transitDate').value;
          var transitTime = document.getElementById('transitTime').value;
          var transitLocation = (document.getElementById('transitLocation') && document.getElementById('transitLocation').value) ? document.getElementById('transitLocation').value.trim() : '';
          var transitIntent = (document.getElementById('transitIntent') && document.getElementById('transitIntent').value) ? document.getElementById('transitIntent').value.trim() : null;
          if (!transitDate) { alert(t('alertTransitDate')); return; }
          if (!transitLocation) { alert(t('alertTransitLocation')); return; }
          payload.transit = { date: transitDate, time: transitTime || null, location: transitLocation, intent: transitIntent || null };
        }
        var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        if (!apiBase) { alert(t('alertNoApi')); return; }
        var initData = getInitData();
        if (!initData) { alert(t('alertOpenFromBot')); return; }
        payload.initData = initData;

        try {
          var checkRes = await fetch(apiBase + '/api/check-chat', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData }, body: JSON.stringify({ initData: initData }) });
          var checkJson = await checkRes.json().catch(function() { return {}; });
          if (checkJson.chat_available === false) {
            alert(checkJson.error || 'Сначала нажмите «Старт» в боте (или отправьте боту любое сообщение), затем отправьте заявку снова.');
            return;
          }
        } catch (checkErr) {
          // если проверка недоступна — не блокируем отправку
        }

        var stepNextOriginalText = stepNext.textContent;
        stepNext.disabled = true;
        stepNext.textContent = t('sending');
        try {
          var controller = new AbortController();
          var timeoutId = setTimeout(function() { controller.abort(); }, 90000);
          var response = await fetch(apiBase + '/api/submit-request', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData }, body: JSON.stringify(payload), signal: controller.signal });
          clearTimeout(timeoutId);
          var result = await response.json().catch(function() { return {}; });

          if (response.ok && result.ok && result.requestId && !result.payment_required) {
            if (typeof scCurrentRequestId !== 'undefined') scCurrentRequestId = result.requestId;
            if (tg && tg.disableClosingConfirmation) try { tg.disableClosingConfirmation(); } catch (e) {}
            showConfirmOverlay('Заявка принята, ' + name1 + '!', 'Песня генерируется на нашем сервере. Когда будет готова — придёт сюда в этот чат с ботом.<br><br>Можешь закрыть приложение — ничего не пропадёт. Спасибо, что остаёшься с нами<br><br><span style="font-size:0.9em;color:rgba(255,255,255,0.6)">Нет песни? Напиши боту «песня не пришла».</span>', function() { goToPage('successPage'); });
          } else if ((response.status === 402 || (result && result.payment_required)) && result.requestId) {
            console.log('[Submit] 402 Payment Required — открываем окно оплаты');
            console.log('[Submit] requestId:', result.requestId, 'sku:', result.sku);
            
            // Сохраняем ID заявки и SKU для оплаты
            pendingPaymentRequestId = result.requestId;
            pendingPaymentSku = result.sku || getCurrentSku();
            activePromo = null; // Сбрасываем промокод (пользователь может ввести новый)
            
            // Открываем окно оплаты и обновляем UI
            showPaymentOverlay();
            updatePaymentUiFromCatalog();
            setPaymentStatus('', '');
          } else {
            var errMsg = result.error || result.message || (typeof t === 'function' ? t('submitFailed') : 'Не удалось отправить заявку.');
            if (response.status === 503) errMsg = t('alertServerSleep');
            stepNext.disabled = false;
            stepNext.textContent = stepNextOriginalText;
            alert(errMsg);
            return;
          }
        } catch (e) {
          stepNext.disabled = false;
          stepNext.textContent = stepNextOriginalText;
          if (e && e.name === 'AbortError') { alert(t('alertServerSleep')); return; }
          var catchMsg = (e && e.message) ? (typeof t === 'function' ? t('submitFailed') + ' ' + e.message : e.message) : (typeof t === 'function' ? t('submitFailed') : 'Не удалось отправить заявку.');
          alert(catchMsg);
          return;
        }
        stepNext.disabled = false;
        stepNext.textContent = stepNextOriginalText;
      });
      setMode('single');
      updateStepUI();
      // ── Overlay: кнопка «Применить промокод» ────────────────────────────
      var payOvPromoBtn = document.getElementById('payOvPromoBtn');
      if (payOvPromoBtn) payOvPromoBtn.addEventListener('click', applyPromoCode);
      var payOvPromoToggle = document.getElementById('payOvPromoToggle');
      if (payOvPromoToggle) payOvPromoToggle.addEventListener('click', function() {
        var section = document.getElementById('payOvPromoSection');
        if (!section) return;
        var isOpen = section.style.display !== 'none';
        section.style.display = isOpen ? 'none' : 'block';
        payOvPromoToggle.textContent = isOpen ? '▸ Есть промокод?' : '▾ Свернуть';
      });

      // ── Overlay: кнопка «Подтвердить и отправить» (промокод 100%) ──
      var payOvPromoConfirmBtn = document.getElementById('payOvPromoConfirmBtn');
      if (payOvPromoConfirmBtn) payOvPromoConfirmBtn.addEventListener('click', async function() {
        console.log('[Promo Confirm] Нажата кнопка подтверждения промокода');
        
        if (!pendingPaymentRequestId) {
          setPaymentStatus('❌ Нет активной заявки', 'error');
          return;
        }
        
        if (!activePromo || Number(activePromo.amount_after) !== 0) {
          setPaymentStatus('❌ Промокод не даёт 100% скидку', 'error');
          return;
        }
        
        var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        var initData = getInitData();
        if (!apiBase || !initData) {
          setPaymentStatus('❌ Нет соединения с сервером', 'error');
          return;
        }
        
        payOvPromoConfirmBtn.disabled = true;
        payOvPromoConfirmBtn.textContent = 'Подтверждаю...';
        setPaymentStatus('Применяю промокод...', 'ok');
        
        try {
          var resp = await fetch(apiBase + '/api/payments/hot/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
            body: JSON.stringify({
              request_id: pendingPaymentRequestId,
              promo_code: activePromo.code,
              initData: initData
            })
          });
          
          var json = await resp.json().catch(function() { return {}; });
          
          if (!resp.ok || !json.success) {
            throw new Error(json.error || json.message || 'Ошибка применения промокода');
          }
          
          // Проверяем, что промокод действительно дал бесплатный доступ
          if (json.free_applied || (json.provider === 'promo' && Number(json.amount) === 0)) {
            console.log('[Promo Confirm] Промокод применён успешно');
            pendingPaymentRequestId = null;
            pendingPaymentSku = null;
            activePromo = null;
            
            hidePaymentOverlay();
            showConfirm(
              'Промокод применён!',
              'Твоя песня создаётся и скоро придёт в бот.<br><br>Песня придёт в этот чат. Можешь закрыть приложение — ничего не пропадёт.'
            );
          } else {
            throw new Error('Промокод не дал бесплатный доступ');
          }
          
        } catch (e) {
          console.error('[Promo Confirm] Ошибка:', e);
          setPaymentStatus('❌ ' + (e.message || 'Ошибка применения промокода'), 'error');
          payOvPromoConfirmBtn.disabled = false;
          payOvPromoConfirmBtn.textContent = 'Подтвердить и отправить';
        }
      });

      // ── Overlay: кнопка «Получить бесплатный ключ» (первый подарочный доступ) ──
      var payOvFreeClaimBtn = document.getElementById('payOvFreeClaimBtn');
      if (payOvFreeClaimBtn) payOvFreeClaimBtn.addEventListener('click', async function() {
        console.log('[Free Trial] Нажата кнопка "Получить бесплатный ключ"');
        console.log('[Free Trial] pendingPaymentRequestId:', pendingPaymentRequestId);
        
        if (!pendingPaymentRequestId) {
          setPaymentStatus('❌ Нет активной заявки. Заполни форму заново.', 'error');
          return;
        }
        
        var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        var initData = getInitData();
        if (!apiBase || !initData) {
          setPaymentStatus('❌ Нет соединения с сервером. Проверь интернет.', 'error');
          return;
        }
        
        payOvFreeClaimBtn.disabled = true;
        payOvFreeClaimBtn.textContent = 'Активирую подарок...';
        setPaymentStatus('Активирую бесплатный доступ...', 'ok');
        
        try {
          var resp = await fetch(apiBase + '/api/free-trial/claim', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
            body: JSON.stringify({ request_id: pendingPaymentRequestId, initData: initData })
          });
          var json = await resp.json().catch(function() { return {}; });
          
          if (resp.ok && json.ok) {
            console.log('[Free Trial] Подарок активирован успешно');
            pendingPaymentRequestId = null;
            pendingPaymentSku = null;
            showConfirm('Первая песня в подарок!', 'Создаём твою персональную песню.<br><br>Песня придёт в этот чат. Можешь закрыть приложение — ничего не пропадёт.');
          } else {
            var errMsg = json.error || json.message || 'Не удалось активировать подарок';
            console.warn('[Free Trial] Ошибка:', errMsg);
            setPaymentStatus('❌ ' + errMsg, 'error');
            payOvFreeClaimBtn.disabled = false;
            payOvFreeClaimBtn.textContent = 'Получить бесплатную песню';
          }
        } catch (e) {
          console.error('[Free Trial] Ошибка соединения:', e);
          setPaymentStatus('❌ Ошибка соединения. Попробуй снова.', 'error');
          payOvFreeClaimBtn.disabled = false;
          payOvFreeClaimBtn.textContent = 'Получить бесплатную песню';
        }
      });

      // ── Overlay: кнопка «Назад» ─────────────────────────────────────────
      var payOvBackBtn = document.getElementById('payOvBackBtn');
      if (payOvBackBtn) payOvBackBtn.addEventListener('click', function() {
        hidePaymentOverlay();
        if (tg && tg.MainButton && tg.MainButton.hide) tg.MainButton.hide();
      });

      // ── Overlay: кнопка «Я уже оплатил» ────────────────────────────────
      var payOvCheckBtn = document.getElementById('payOvCheckBtn');
      if (payOvCheckBtn) payOvCheckBtn.addEventListener('click', async function() {
        if (!pendingPaymentRequestId) { setPaymentStatus('Нет активной заявки для проверки', 'error'); return; }
        var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        var initData = getInitData();
        if (!apiBase || !initData) { setPaymentStatus('Нет соединения с сервером', 'error'); return; }
        payOvCheckBtn.disabled = true;
        payOvCheckBtn.textContent = 'Проверяю...';
        setPaymentStatus('Проверяю статус оплаты...', 'warn');
        try {
          var st = '';
          for (var i = 0; i < 5; i++) {
            var r = await fetchWithTimeout(apiBase + '/api/payments/hot/status?request_id=' + encodeURIComponent(pendingPaymentRequestId), { headers: { 'X-Telegram-Init': initData } }, 10000);
            var j = await r.json().catch(function() { return {}; });
            st = j && j.data && j.data.payment_status ? String(j.data.payment_status).toLowerCase() : '';
            if (st === 'paid') break;
            if (i < 4) await new Promise(function(res) { setTimeout(res, 1500); });
          }
          if (st === 'paid') {
            setPaymentStatus('Оплата подтверждена! Запускаем создание...', 'ok');
            await fetch(apiBase + '/api/payments/hot/confirm', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
              body: JSON.stringify({ request_id: pendingPaymentRequestId, initData: initData })
            }).catch(function(){});
            pendingPaymentRequestId = null; pendingPaymentSku = null;
            setTimeout(function() { hidePaymentOverlay(); showConfirm('Оплата подтверждена!', 'Запускаем создание твоей песни.<br><br>Песня придёт в этот чат. Можешь закрыть приложение — ничего не пропадёт.'); }, 1200);
          } else {
            setPaymentStatus('Оплата пока не подтверждена. Подожди немного и проверь снова.', 'warn');
          }
        } catch(e) {
          setPaymentStatus('Ошибка проверки: ' + (e && e.message ? e.message : 'попробуй снова'), 'error');
        } finally {
          payOvCheckBtn.disabled = false;
          payOvCheckBtn.textContent = 'Я уже оплатил — проверить';
        }
      });

      // ── Overlay: кнопка «Оплатить» ──────────────────────────────────────
      var payBtn = document.getElementById('payOvPayBtn');
      if (payBtn) payBtn.addEventListener('click', async function() {
        console.log('[HOT Pay] Нажата кнопка оплаты');
        
        if (payBtn.disabled) {
          console.log('[HOT Pay] Кнопка отключена, игнорируем клик');
          return;
        }
        
        if (!pendingPaymentRequestId) {
          console.error('[HOT Pay] КРИТИЧНО: Нет pendingPaymentRequestId!');
          setPaymentStatus('❌ Сначала заполни форму и отправь заявку', 'error');
          return;
        }
        
        var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        if (!apiBase) { 
          console.error('[HOT Pay] Нет API базового URL');
          alert(t('alertNoApi')); 
          return; 
        }
        
        var initData = getInitData();
        if (!initData) { 
          console.error('[HOT Pay] Нет initData - проблема с авторизацией Telegram');
          
          if (window.demoMode) {
            console.log('[HOT Pay] Демо-режим: показываем сообщение о необходимости авторизации');
            alert('💡 Демо-режим\n\n' +
                  'Для оплаты необходимо открыть приложение из Telegram бота @YupSoul_bot\n\n' +
                  '📱 Как это сделать:\n' +
                  '1. Откройте @YupSoul_bot в Telegram\n' +
                  '2. Нажмите кнопку меню (☰) или "Открыть приложение"\n' +
                  '3. Заполните форму и оплатите');
            return;
          }
          
          var errorMessage = '⚠️ Ошибка авторизации Telegram!\n\n' +
                            '🔧 Решения:\n' +
                            '• Откройте приложение из бота @YupSoul_bot (кнопка меню ☰)\n' +
                            '• Обновите Telegram до последней версии\n' +
                            '• Перезапустите Telegram\n' +
                            '• Попробуйте web.telegram.org\n\n' +
                            '💡 Ваша версия Telegram: ' + (tg && tg.version ? tg.version : 'неизвестна');
          
          if (confirm(errorMessage + '\n\nПродолжить в демо-режиме?')) {
            window.demoMode = true;
            alert('💡 Демо-режим активирован\n\nВы можете заполнить форму, но оплата будет недоступна.');
          }
          return; 
        }
        
        console.log('[HOT Pay] Все проверки пройдены, apiBase:', apiBase);
        console.log('[HOT Pay] pendingPaymentRequestId:', pendingPaymentRequestId);
        console.log('[HOT Pay] Telegram WebApp доступен:', !!(window.Telegram && window.Telegram.WebApp));
        
        // Дополнительная проверка версии для оплаты
        if (tg && tg.version) {
          var version = parseFloat(tg.version) || 0;
          if (version < 6.1) {
            console.warn('[HOT Pay] Версия Telegram (' + tg.version + ') может не поддерживать оплату');
            alert('⚠️ Для оплаты требуется более новая версия Telegram!\n\n' +
                  '📱 Ваша версия: ' + tg.version + '\n' +
                  'Требуется: 6.1 или выше\n\n' +
                  '🔄 Обновите Telegram и попробуйте снова');
            return;
          }
        }

        // Используем только ПРОВЕРЕННЫЙ промокод (activePromo). Если в поле текст, но activePromo=null —
        // значит промокод был отклонён, и отправлять его не нужно.
        var promoCode = activePromo ? activePromo.code : null;
        var hotPayload = {
          request_id: pendingPaymentRequestId,
          sku: pendingPaymentSku,
          promo_code: promoCode || null,
          initData: initData
        };

        payBtn.disabled = true;
        payBtn.textContent = t('sending');
        console.log('[HOT Pay] Начинаем создание платежа, payload:', hotPayload);
        
        try {
          var hotCtrl = new AbortController();
          var hotTimeout = setTimeout(function() { hotCtrl.abort(); }, 30000);
          console.log('[HOT Pay] Отправляем запрос на:', apiBase + '/api/payments/hot/create');
          
          var hotResp = await fetch(apiBase + '/api/payments/hot/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
            body: JSON.stringify(hotPayload),
            signal: hotCtrl.signal
          });
          clearTimeout(hotTimeout);
          
          console.log('[HOT Pay] Ответ сервера, статус:', hotResp.status, hotResp.ok);
          var hotJson = await hotResp.json().catch(function(e) { 
            console.error('[HOT Pay] Ошибка парсинга JSON:', e); 
            return {}; 
          });
          console.log('[HOT Pay] Данные ответа:', hotJson);

          if (!hotResp.ok || !hotJson.success) {
            var errorMsg = hotJson.error || 'Не удалось создать оплату HOT';
            console.error('[HOT Pay] Ошибка создания платежа:', errorMsg);
            console.error('[HOT Pay] Статус ответа:', hotResp.status, hotResp.statusText);
            
            if (hotResp.status === 401) {
              errorMsg = 'Ошибка авторизации (401). Приложение должно быть запущено из Telegram бота!';
              console.error('[HOT Pay] КРИТИЧНО: Проблема с initData - приложение запущено не из Telegram');
            } else if (hotResp.status === 403) {
              errorMsg = 'Доступ запрещен (403). Проверьте права доступа.';
            } else if (hotResp.status >= 500) {
              errorMsg = 'Ошибка сервера (' + hotResp.status + '). Попробуйте позже.';
            }
            
            throw new Error(errorMsg);
          }
          // КРИТИЧНО: Если промокод дал 100% скидку или free_applied — показываем экран подтверждения
          if (hotJson.free_applied || (hotJson.success && hotJson.provider === 'promo' && Number(hotJson.amount) === 0)) {
            console.log('[HOT Pay] Промокод дал бесплатную генерацию — показываем экран подтверждения');
            pendingPaymentRequestId = null;
            pendingPaymentSku = null;
            activePromo = null;
            showConfirmOverlay('Заявка принята!', 'Промокод применён!<br><br>Песня генерируется на нашем сервере — когда будет готова, придёт сюда в чат с ботом. Можешь закрыть приложение — ничего не пропадёт. Спасибо<br><br><span style="font-size:0.9em;color:rgba(255,255,255,0.6)">Нет песни? Напиши боту «песня не пришла».</span>', function() { goToPage('successPage'); });
            return;
          }
          if (!hotJson.checkout_url) {
            console.error('[HOT Pay] Checkout URL не получен в ответе:', hotJson);
            throw new Error('Checkout URL не получен');
          }
          var checkoutUrl = String(hotJson.checkout_url);
          console.log('[HOT Pay] Получен checkout_url:', checkoutUrl);
          setPaymentStatus('Открываю страницу оплаты...', 'warn');

          var lastCheckoutUrl = checkoutUrl;
          var hintEl = document.getElementById('payOvLinkRow');
          var copyBtn = document.getElementById('payOvCopyBtn');
          if (copyBtn) {
            copyBtn.onclick = function() {
              try {
                navigator.clipboard.writeText(lastCheckoutUrl);
                alert(t('alertLinkCopied'));
              } catch (e) {
                prompt(t('copyLinkPrompt'), lastCheckoutUrl);
              }
            };
          }
          if (hintEl) hintEl.style.display = 'block';

          var opened = false;
          console.log('[HOT Pay] Пытаемся открыть ссылку оплаты:', checkoutUrl);
          
          try {
            if (window.Telegram && window.Telegram.WebApp && typeof window.Telegram.WebApp.openLink === 'function') {
              console.log('[HOT Pay] Используем Telegram.WebApp.openLink');
              try {
                window.Telegram.WebApp.openLink(checkoutUrl, { try_instant_view: false });
                console.log('[HOT Pay] openLink с try_instant_view: false - успешно');
              } catch (e1) {
                console.log('[HOT Pay] openLink с try_instant_view: false - ошибка:', e1);
                window.Telegram.WebApp.openLink(checkoutUrl);
                console.log('[HOT Pay] openLink без параметров - успешно');
              }
              opened = true;
            } else {
              console.log('[HOT Pay] Telegram.WebApp.openLink недоступен');
            }
          } catch (linkErr) {
            console.error('[HOT Pay] Ошибка Telegram.WebApp.openLink:', linkErr);
          }
          
          if (!opened) {
            console.log('[HOT Pay] Пытаемся открыть через window.open');
            var newWindow = window.open(checkoutUrl, '_blank', 'noopener,noreferrer');
            if (newWindow) {
              opened = true;
              console.log('[HOT Pay] window.open - успешно');
            } else {
              console.log('[HOT Pay] window.open - заблокировано браузером');
              // Пытаемся открыть через location.href как последний вариант
              console.log('[HOT Pay] Пытаемся открыть через location.href');
              try {
                window.location.href = checkoutUrl;
                opened = true;
                console.log('[HOT Pay] location.href - успешно');
              } catch (e) {
                console.error('[HOT Pay] location.href - ошибка:', e);
              }
            }
          }
          
          if (!opened) {
            console.error('[HOT Pay] Не удалось открыть ссылку ни одним способом');
            setPaymentStatus('⚠️ Не удалось открыть автоматически. Нажмите «Скопировать ссылку» ниже и откройте в браузере.', 'error');
            payBtn.disabled = false;
            payBtn.textContent = t('payWithHot');
            return;
          } else {
            console.log('[HOT Pay] Ссылка успешно открыта, начинаем проверку статуса оплаты');
          }

          setPaymentStatus(t('hotCheckoutOpened'), 'warn');
          // Показываем кнопку ручной проверки — на случай если webhook задержится
          var checkBtn = document.getElementById('payOvCheckBtn');
          if (checkBtn) checkBtn.style.display = 'block';
          var maxAttempts = 60;
          var attempt = 0;
          var paid = false;
          while (attempt < maxAttempts) {
            attempt += 1;
            await new Promise(function(resolve) { setTimeout(resolve, 3000); });
            var statusResp = await fetchWithTimeout(apiBase + '/api/payments/hot/status?request_id=' + encodeURIComponent(pendingPaymentRequestId), { headers: { 'X-Telegram-Init': initData } }, 10000);
            var statusJson = await statusResp.json().catch(function() { return {}; });
            var paymentStatus = statusJson && statusJson.data && statusJson.data.payment_status ? String(statusJson.data.payment_status).toLowerCase() : '';
            if (paymentStatus === 'paid') { paid = true; break; }
          }
          if (!paid) {
            setPaymentStatus(t('paymentNotConfirmed'), 'warn');
            payBtn.disabled = false;
            payBtn.textContent = t('payWithHot');
            return;
          }
          setPaymentStatus(t('paymentConfirmed'), 'ok');
          var confirmResp = await fetch(apiBase + '/api/payments/hot/confirm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
            body: JSON.stringify({ request_id: pendingPaymentRequestId, initData: initData })
          });
          if (!confirmResp.ok) throw new Error('Ошибка подтверждения оплаты (' + confirmResp.status + ')');
          pendingPaymentRequestId = null;
          pendingPaymentSku = null;
          hidePaymentOverlay();
          showConfirm('Оплата подтверждена!', 'Запускаем создание твоей песни.<br><br>Песня придёт в этот чат. Можешь закрыть приложение — ничего не пропадёт.');
        } catch (error) {
          console.error('[HOT Pay] Критическая ошибка:', error);
          var msg = (error && error.message) ? String(error.message) : t('errorOp');
          var hint = '';
          if (error.name === 'AbortError') {
            hint = ' Превышено время ожидания — попробуй ещё раз.';
          } else if (msg && (msg.toLowerCase().includes('промокод') || msg.toLowerCase().includes('promo'))) {
            // Промокод не подошёл — чистим поле и activePromo чтобы не мешал следующей попытке
            activePromo = null;
            var promoInputErr = document.getElementById('payOvPromoInput');
            if (promoInputErr) promoInputErr.value = '';
            hint = ' Оплати без промокода или введи другой.';
          } else if (msg && msg.includes('fetch')) {
            hint = ' Проверь интернет-соединение.';
          }
          setPaymentStatus('❌ ' + msg + hint, 'error');
          // Скроллим оверлей наверх, чтобы ошибка была видна
          var ovScroll = document.getElementById('paymentOverlay');
          if (ovScroll) ovScroll.scrollTop = 0;
        } finally {
          console.log('[HOT Pay] Завершение обработки, восстанавливаем кнопку');
          payBtn.disabled = false;
          // Текст кнопки: сбрасываем в HOT Pay (активный промокод уже очищен при ошибке промокода)
          var isFreeAfterError = activePromo && Number(activePromo.amount_after) === 0;
          payBtn.textContent = isFreeAfterError ? 'Получить бесплатно' : 'Оплатить через HOT Pay';
          payBtn.style.background = isFreeAfterError ? 'linear-gradient(135deg,#059669,#10b981)' : 'linear-gradient(135deg,var(--primary-color),var(--secondary-color))';
        }
      });
      
      var goProfileBtn = document.getElementById('goProfileBtn');
      if (goProfileBtn) goProfileBtn.addEventListener('click', function() { goToPage('profilePage'); });
      var goHeroesBtn = document.getElementById('goHeroesBtn');
      if (goHeroesBtn) goHeroesBtn.addEventListener('click', function() { goToPage('heroesPage'); initHeroesPage(); });
      var profileCreateSongBtn = document.getElementById('profileCreateSongBtn');
      if (profileCreateSongBtn) profileCreateSongBtn.addEventListener('click', function() { goToPage('formPage'); });
      var PLAN_PRICES = { plan_basic: '$14.99', plan_plus: '$24.99', plan_master: '$39.99' };
      var PLAN_TRACKS = { plan_basic: '5', plan_plus: '10', plan_master: '30' };
      var PLAN_SKU_MAP = { plan_basic: 'soul_basic_sub', plan_plus: 'soul_plus_sub', plan_master: 'master_monthly' };
      var PLAN_STARS = { plan_basic: '1 150 ⭐', plan_plus: '1 920 ⭐', plan_master: '3 070 ⭐' };

      // ── Stars: универсальная функция открытия инвойса ─────────────────────
      window.payWithStars = async function payWithStars(sku, requestId, btn) {
        var apiBase  = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        var initData = getInitData ? getInitData() : '';
        if (!apiBase || !initData) { alert('Ошибка авторизации. Открой приложение из Telegram.'); return; }
        var origText = btn ? btn.textContent : '';
        if (btn) { btn.disabled = true; btn.textContent = 'Создаём инвойс…'; }
        try {
          var resp = await fetch(apiBase + '/api/payments/stars/invoice', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
            body: JSON.stringify({ sku: sku, initData: initData, request_id: requestId || null })
          });
          var data = await resp.json().catch(function() { return {}; });
          if (!data.success || !data.invoice_link) {
            alert('Не удалось создать инвойс: ' + (data.error || 'попробуй ещё раз'));
            return;
          }
          // Открываем инвойс Stars через Telegram WebApp
          var tgApp = window.Telegram && window.Telegram.WebApp;
          if (tgApp && typeof tgApp.openInvoice === 'function') {
            tgApp.openInvoice(data.invoice_link, function(status) {
              if (status === 'paid') {
                if (btn) btn.textContent = 'Оплачено!';
                setTimeout(function() {
                  var ov = document.getElementById('planConfirmOverlay') || document.getElementById('paymentOverlay');
                  if (ov) ov.style.display = 'none';
                }, 1200);
              } else {
                if (btn) { btn.disabled = false; btn.textContent = origText; }
              }
            });
          } else if (tgApp && typeof tgApp.openLink === 'function') {
            tgApp.openLink(data.invoice_link);
            if (btn) { btn.disabled = false; btn.textContent = origText; }
          } else {
            window.open(data.invoice_link, '_blank');
            if (btn) { btn.disabled = false; btn.textContent = origText; }
          }
        } catch (e) {
          alert('Ошибка соединения: ' + (e.message || e));
          if (btn) { btn.disabled = false; btn.textContent = origText; }
        }
      };

      // Кнопка Stars в оверлее разовой покупки
      var payOvStarsBtn = document.getElementById('payOvStarsBtn');
      if (payOvStarsBtn) payOvStarsBtn.addEventListener('click', function() {
        var sku = pendingPaymentSku || '';
        if (!sku) { alert('Сначала заполни форму заявки.'); return; }
        payWithStars(sku, pendingPaymentRequestId, payOvStarsBtn);
      });

      window.showPlanConfirm = function showPlanConfirm(planKey, planName) {
        var overlay = document.getElementById('planConfirmOverlay');
        var title = document.getElementById('planConfirmTitle');
        var desc = document.getElementById('planConfirmDesc');
        var btn = document.getElementById('planConfirmBtn');
        var starsBtn = document.getElementById('planConfirmStarsBtn');
        if (!overlay) return;
        var price = PLAN_PRICES[planKey] || '';
        var tracks = PLAN_TRACKS[planKey] || '';
        var starsPrice = PLAN_STARS[planKey] || '';
        if (title) title.textContent = planName + (price ? ' — ' + price + '/мес' : '');
        if (desc) desc.textContent = (tracks ? tracks + ' персональных треков в месяц.' : '') + ' Оплата через HOT Pay. Приложение остаётся открытым.';
        if (starsBtn && starsPrice) {
          starsBtn.textContent = '⭐ Оплатить звёздами — ' + starsPrice;
          starsBtn.disabled = false;
          var skuForStars = PLAN_SKU_MAP[planKey] || '';
          starsBtn.onclick = function() { payWithStars(skuForStars, null, starsBtn); };
        }
        if (btn) {
          btn.textContent = 'Перейти к оплате →';
          btn.onclick = async function() {
            btn.textContent = 'Загружаем…';
            btn.disabled = true;
            try {
              var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
              var initData = getInitData ? getInitData() : '';
              var resp = await fetch(apiBase + '/api/payments/subscription/checkout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
                body: JSON.stringify({ initData: initData, plan_key: planKey, name: (userProfile && userProfile.name) || '' })
              });
              var data = await resp.json().catch(function() { return {}; });
              if (data.already_subscribed) {
                overlay.style.display = 'none';
                alert('У тебя уже активна эта подписка.');
                return;
              }
              if (!data.success || !data.checkout_url) {
                btn.textContent = 'Перейти к оплате →';
                btn.disabled = false;
                alert('Не удалось создать ссылку на оплату. Попробуй ещё раз.');
                return;
              }
              overlay.style.display = 'none';
              // Сохраняем в localStorage что это оплата подписки — нужно для экрана после возврата
              try {
                localStorage.setItem('pending_payment_type', JSON.stringify({
                  type: 'subscription', plan_key: planKey, plan_name: planName, ts: Date.now()
                }));
              } catch(e) {}
              // Открываем оплату без закрытия приложения
              if (tg && tg.openLink) {
                tg.openLink(data.checkout_url);
              } else {
                window.open(data.checkout_url, '_blank');
              }
            } catch(e) {
              btn.textContent = 'Перейти к оплате →';
              btn.disabled = false;
              alert('Ошибка соединения. Попробуй ещё раз.');
            }
          };
        }
        overlay.style.display = 'flex';
      }

      var planBtnBasic = document.getElementById('planBtnBasic');
      if (planBtnBasic) planBtnBasic.addEventListener('click', function() {
        showPlanConfirm('plan_basic', 'Basic');
      });
      var planBtnPlus = document.getElementById('planBtnPlus');
      if (planBtnPlus) planBtnPlus.addEventListener('click', function() {
        showPlanConfirm('plan_plus', 'Plus');
      });
      var planBtnMaster = document.getElementById('planBtnMaster');
      if (planBtnMaster) planBtnMaster.addEventListener('click', function() {
        showPlanConfirm('plan_master', 'Лаборатория');
      });

      // Тултипы для фич тарифов (.ppc-info)
      (function() {
        var tooltip = document.getElementById('modeTooltip');
        if (!tooltip) return;
        var timer = null;
        function hide() { tooltip.style.display = 'none'; clearTimeout(timer); }
        document.querySelectorAll('.ppc-info').forEach(function(icon) {
          icon.addEventListener('click', function(e) {
            e.stopPropagation();
            var text = this.getAttribute('data-tip') || '';
            if (!text) return;
            tooltip.textContent = text;
            tooltip.style.display = 'block';
            var rect = this.getBoundingClientRect();
            var tw = tooltip.offsetWidth || 220;
            var left = Math.min(rect.left, window.innerWidth - tw - 12);
            tooltip.style.left = Math.max(8, left) + 'px';
            tooltip.style.top = (rect.bottom + 8) + 'px';
            clearTimeout(timer);
            timer = setTimeout(hide, 4000);
          });
        });
      })();
      var profileRefShareBtn = document.getElementById('profileRefShareBtn');
      if (profileRefShareBtn) profileRefShareBtn.addEventListener('click', function() {
        var link = (document.getElementById('profileRefLinkInput') || {}).value || '';
        if (!link) return;
        if (tg && tg.openTelegramLink) {
          tg.openTelegramLink('https://t.me/share/url?url=' + encodeURIComponent(link) + '&text=' + encodeURIComponent('Попробуй YupSoul — первую песню получишь бесплатно'));
        } else {
          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(link);
              profileRefShareBtn.textContent = t('profileShare') + ' ✓';
              setTimeout(function() { profileRefShareBtn.textContent = t('profileShare'); }, 2000);
            }
          } catch (e) {}
        }
      });

      // ── ЗАГРУЗКА ФОТО ПРОФИЛЯ ─────────────────────────────────────────────
      (function setupAvatarUpload() {
        var wrap = document.getElementById('profileAvatarWrap');
        var input = document.getElementById('avatarFileInput');
        var spinner = document.getElementById('profileAvatarSpinner');

        if (!wrap || !input) return;

        wrap.addEventListener('click', function() { input.click(); });
        wrap.addEventListener('keydown', function(e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); input.click(); } });

        input.addEventListener('change', function() {
          var file = input.files && input.files[0];
          if (!file) return;
          if (!file.type.startsWith('image/')) { alert('Выбери изображение'); return; }

          var reader = new FileReader();
          reader.onload = function(e) {
            var src = e.target.result;
            var img = new Image();
            img.onload = function() {
              // Ресайз до 256×256 через Canvas
              var SIZE = 256;
              var canvas = document.createElement('canvas');
              canvas.width = SIZE; canvas.height = SIZE;
              var ctx = canvas.getContext('2d');
              // Кроп по центру
              var sw = img.width, sh = img.height;
              var side = Math.min(sw, sh);
              var sx = (sw - side) / 2, sy = (sh - side) / 2;
              ctx.drawImage(img, sx, sy, side, side, 0, 0, SIZE, SIZE);
              var base64 = canvas.toDataURL('image/jpeg', 0.85);

              // Показываем превью сразу
              var avatarEl = document.getElementById('profileAvatar');
              var initEl   = document.getElementById('profileAvatarInitial');
              if (avatarEl) {
                var existing = avatarEl.querySelector('img');
                if (!existing) { existing = document.createElement('img'); existing.alt='avatar'; avatarEl.insertBefore(existing, avatarEl.firstChild); }
                existing.src = base64; existing.style.display = 'block';
              }
              if (initEl) initEl.style.display = 'none';

              // Загружаем на сервер
              var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
              var initData = getInitData();
              if (!apiBase || !initData) return;
              if (spinner) { spinner.style.display = 'flex'; }
              fetch(apiBase + '/api/user/avatar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
                body: JSON.stringify({ initData: initData, avatar_base64: base64 })
              })
              .then(function(r) { return r.json(); })
              .then(function(json) {
                if (spinner) spinner.style.display = 'none';
                if (!json.ok) console.warn('[Avatar] upload error:', json.error);
              })
              .catch(function(err) {
                if (spinner) spinner.style.display = 'none';
                console.warn('[Avatar] upload failed:', err);
              });
            };
            img.src = src;
          };
          reader.readAsDataURL(file);
          input.value = ''; // сбрасываем для повторного выбора
        });
      })();

      // ── Инициализация страницы героев ────────────────────────────────────
      function initHeroesPage() {
        var paywall = document.getElementById('masterPaywall');
        var cabinet = document.getElementById('masterCabinet');
        var formWrap = document.getElementById('heroFormWrap');
        if (!paywall || !cabinet) return;
        paywall.style.display = 'none';
        cabinet.style.display = 'none';
        if (formWrap) formWrap.style.display = 'none';
        var badge = document.getElementById('masterAccessBadge');
        if (badge) badge.textContent = (typeof t === 'function' ? t('loading') : 'Загрузка…');

        heroesApi('/master/access', { method: 'GET' }).then(function(d) {
          if (d && d.access) {
            var sub = d.source === 'trial' ? 'Пробный период' : 'Подписка активна';
            if (d.renew_at) {
              var exp = new Date(d.renew_at);
              sub += ' · до ' + exp.toLocaleDateString('ru-RU', { day:'numeric', month:'short' });
            }
            if (badge) badge.textContent = sub;
            cabinet.style.display = 'block';
            loadHeroesList();
          } else {
            if (badge) badge.textContent = '';
            paywall.style.display = 'block';
          }
        }).catch(function() {
          if (badge) badge.textContent = '';
          paywall.style.display = 'block';
        });
      }

      // ── Триал и подписка ─────────────────────────────────────────────────
      var masterTrialBtn = document.getElementById('masterTrialBtn');
      var masterSubBtn = document.getElementById('masterSubBtn');
      if (masterTrialBtn) masterTrialBtn.addEventListener('click', function() {
        masterTrialBtn.disabled = true;
        masterTrialBtn.textContent = 'Подключаем…';
        heroesApi('/master/trial/start', { method: 'POST', body: { initData: (tg && tg.initData) || '' } }).then(function(d) {
          if (d && d.ok) {
            var paywall = document.getElementById('masterPaywall');
            var cabinet = document.getElementById('masterCabinet');
            var badge = document.getElementById('masterAccessBadge');
            if (paywall) paywall.style.display = 'none';
            if (cabinet) { cabinet.style.display = 'block'; loadHeroesList(); }
            if (badge) {
              var exp = d.renew_at ? new Date(d.renew_at).toLocaleString('ru-RU', { day:'numeric', month:'short', hour:'2-digit', minute:'2-digit' }) : '';
              badge.textContent = 'Пробный период' + (exp ? ' · до ' + exp : '');
            }
          } else {
            alert(d && d.error ? d.error : 'Не удалось активировать');
            masterTrialBtn.disabled = false;
            masterTrialBtn.textContent = '1 день бесплатно — попробовать';
          }
        }).catch(function(e) {
          alert('Ошибка: ' + (e.message || e));
          masterTrialBtn.disabled = false;
          masterTrialBtn.textContent = '1 день бесплатно — попробовать';
        });
      });
      if (masterSubBtn) masterSubBtn.addEventListener('click', function() {
        masterSubBtn.disabled = true;
        masterSubBtn.textContent = 'Открываем оплату…';
        heroesApi('/master/subscribe', { method: 'POST', body: { initData: (tg && tg.initData) || '' } }).then(function(d) {
          if (d && d.payment_url) {
            if (tg && tg.openLink) tg.openLink(d.payment_url);
            else window.open(d.payment_url, '_blank');
          }
          masterSubBtn.disabled = false;
          var priceStr = (d && d.payment_amount != null && d.payment_currency) ? (d.payment_amount + ' ' + d.payment_currency + '/мес') : '39.99 USDT/мес';
          masterSubBtn.textContent = 'Подписка — ' + priceStr;
        }).catch(function(e) {
          alert('Ошибка: ' + (e.message || e));
          masterSubBtn.disabled = false;
          masterSubBtn.textContent = 'Подписка — 39.99 USDT/мес';
        });
      });

      // ── Список героев ─────────────────────────────────────────────────────
      function escHtml(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

      function loadHeroesList() {
        var listEl = document.getElementById('heroesList');
        if (!listEl) return;
        listEl.innerHTML = '<div style="text-align:center;padding:24px 0;font-size:0.85rem;color:rgba(255,255,255,0.3)">' + (typeof t === 'function' ? t('loading') : 'Загрузка…') + '</div>';
        var search = (document.getElementById('heroesSearch') || {}).value || '';
        var q = search.trim() ? '?search=' + encodeURIComponent(search.trim()) : '';
        heroesApi('/heroes' + q, { method: 'GET' }).then(function(d) {
          heroesCache = (d && d.clients) || [];
          if (!heroesCache.length) {
            listEl.innerHTML = '<div style="text-align:center;padding:32px 0">' +
              '<div style="font-size:2rem;margin-bottom:10px">🌟</div>' +
              '<div style="font-size:0.9rem;color:rgba(255,255,255,0.35);line-height:1.55">Пока нет ни одного героя.<br>Добавь первого — и создавай для него<br>персональные песни в один тап.</div></div>';
            return;
          }
          listEl.innerHTML = heroesCache.map(function(h) {
            var initials = (h.name || '?').trim().split(/\s+/).map(function(w){ return w[0]; }).slice(0,2).join('').toUpperCase();
            var metaParts = [];
            if (h.relationship) metaParts.push(h.relationship);
            if (h.birth_date) metaParts.push(new Date(h.birth_date).toLocaleDateString('ru-RU', { day:'numeric', month:'long', year:'numeric' }));
            if (h.birth_place) metaParts.push(h.birth_place);
            return '<div class="hero-card" id="hcard-' + escHtml(h.id) + '">' +
              '<div class="hero-card-head" onclick="toggleHeroCard(\'' + escHtml(h.id) + '\')">' +
              '<div class="hero-avatar">' + escHtml(initials) + '</div>' +
              '<div style="flex:1;min-width:0">' +
              '<div class="hero-card-name">' + escHtml(h.name) + '</div>' +
              '<div class="hero-card-meta">' + escHtml(metaParts.join(' · ')) + '</div>' +
              (h.preferred_style ? '<div class="hero-style-badge">' + escHtml(h.preferred_style) + '</div>' : '') +
              '</div>' +
              '<div class="hero-card-chevron">▼</div>' +
              '</div>' +
              '<div class="hero-card-body">' +
              (h.notes ? '<div style="font-size:0.82rem;color:rgba(255,255,255,0.45);line-height:1.5;margin-bottom:12px">' + escHtml(h.notes) + '</div>' : '') +
              '<div class="hca-row">' +
              '<button type="button" class="hca-btn hero-solo-btn" data-id="' + escHtml(h.id) + '" data-name="' + escHtml(h.name) + '">Соло</button>' +
              '<button type="button" class="hca-btn hero-duo-btn" data-id="' + escHtml(h.id) + '" data-name="' + escHtml(h.name) + '">🎶 Вместе со мной</button>' +
              '<button type="button" class="hca-btn hca-secondary hero-edit-btn" data-id="' + escHtml(h.id) + '">✏️ Изменить</button>' +
              '<button type="button" class="hca-btn hca-danger hero-delete-btn" data-id="' + escHtml(h.id) + '" data-name="' + escHtml(h.name) + '">Удалить</button>' +
              '</div>' +
              '<div class="hero-hist-section" id="hhist-' + escHtml(h.id) + '">' +
              '<button type="button" class="hero-hist-toggle hero-hist-load-btn" data-id="' + escHtml(h.id) + '">▸ История генераций</button>' +
              '<div class="hero-hist-content" id="hhist-content-' + escHtml(h.id) + '" style="display:none"></div>' +
              '</div>' +
              '</div>' +
              '</div>';
          }).join('');

          // Раскрытие карточки
          listEl.querySelectorAll('.hero-hist-load-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
              e.stopPropagation();
              var id = btn.getAttribute('data-id');
              var contentEl = document.getElementById('hhist-content-' + id);
              if (!contentEl) return;
              if (contentEl.style.display === 'block') { contentEl.style.display = 'none'; btn.textContent = '▸ История генераций'; return; }
              contentEl.style.display = 'block';
              btn.textContent = '▾ История генераций';
              if (contentEl.dataset.loaded) return;
              contentEl.dataset.loaded = '1';
              contentEl.innerHTML = '<div class="hero-hist-loading">' + (typeof t === 'function' ? t('heroHistLoading') : 'Загрузка истории…') + '</div>';
              heroesApi('/heroes/' + id + '/requests', { method: 'GET' }).then(function(d) {
                var reqs = (d && d.requests) || [];
                if (!reqs.length) { contentEl.innerHTML = '<div class="hero-hist-empty">' + (typeof t === 'function' ? t('heroHistEmpty') : 'Генераций пока нет') + '</div>'; return; }
                contentEl.innerHTML = reqs.map(function(r) {
                  var statusEmoji = { completed:'', error:'', pending:'', pending_payment:'' }[r.generation_status] || '';
                  var dateStr = r.created_at ? new Date(r.created_at).toLocaleString('ru-RU', { day:'numeric', month:'short', hour:'2-digit', minute:'2-digit' }) : '';
                  var html = '<div class="hero-hist-item">';
                  html += '<div class="hero-hist-title">' + statusEmoji + ' ' + escHtml(r.title || '(без названия)') + '</div>';
                  html += '<div class="hero-hist-meta">' + escHtml(dateStr) + (r.request_type ? ' · ' + escHtml(r.request_type) : '') + '</div>';
                  if (r.lyrics) {
                    html += '<div class="hero-hist-block-label">Текст песни</div>';
                    html += '<div class="hero-hist-text">' + escHtml(r.lyrics) + '</div>';
                  }
                  if (r.detailed_analysis) {
                    html += '<button type="button" class="hero-hist-toggle hha-toggle" style="margin-bottom:4px">▸ Анализ</button>';
                    html += '<div class="hero-hist-text" style="display:none">' + escHtml(r.detailed_analysis) + '</div>';
                  }
                  if (r.cover_letter) {
                    html += '<button type="button" class="hero-hist-toggle hha-toggle" style="margin-bottom:4px">▸ Сопроводительное письмо</button>';
                    html += '<div class="hero-hist-text" style="display:none">' + escHtml(r.cover_letter) + '</div>';
                  }
                  if (r.audio_url) {
                    html += '<a href="' + escHtml(r.audio_url) + '" target="_blank" class="hero-hist-audio">🎧 Слушать</a>';
                  }
                  html += '</div>';
                  return html;
                }).join('');
                // Раскрытие анализа/письма
                contentEl.querySelectorAll('.hha-toggle').forEach(function(tb) {
                  tb.addEventListener('click', function() {
                    var next = tb.nextElementSibling;
                    if (!next) return;
                    var open = next.style.display === 'block';
                    next.style.display = open ? 'none' : 'block';
                    tb.textContent = tb.textContent.replace(/^[▸▾]\s/, (open ? '▸ ' : '▾ '));
                  });
                });
              }).catch(function() { contentEl.innerHTML = '<div class="hero-hist-empty">' + (typeof t === 'function' ? t('heroHistLoadError') : 'Не удалось загрузить историю') + '</div>'; });
            });
          });

          // Кнопки Соло / Вместе
          listEl.querySelectorAll('.hero-solo-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
              e.stopPropagation();
              var heroId = btn.getAttribute('data-id');
              var heroName = btn.getAttribute('data-name') || '';
              var h = heroesCache.find(function(c){ return c.id === heroId; }) || {};
              startHeroRequest({ hero: h, mode: 'single', forWho: heroName });
            });
          });
          listEl.querySelectorAll('.hero-duo-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
              e.stopPropagation();
              var heroId = btn.getAttribute('data-id');
              var heroName = btn.getAttribute('data-name') || '';
              var h = heroesCache.find(function(c){ return c.id === heroId; }) || {};
              startHeroRequest({ hero: h, mode: 'couple', forWho: heroName });
            });
          });

          // Кнопки Изменить / Удалить
          listEl.querySelectorAll('.hero-edit-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
              e.stopPropagation();
              var id = btn.getAttribute('data-id');
              var h = heroesCache.find(function(c) { return c.id === id; });
              if (!h) return;
              openHeroForm(h);
            });
          });
          listEl.querySelectorAll('.hero-delete-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
              e.stopPropagation();
              var id = btn.getAttribute('data-id');
              var name = btn.getAttribute('data-name') || 'этого героя';
              if (!confirm('Удалить «' + name + '»?')) return;
              heroesApi('/heroes/' + id, { method: 'DELETE' }).then(function() { loadHeroesList(); }).catch(function(e) { alert('Ошибка: ' + (e.message || e)); });
            });
          });
        }).catch(function() {
          if (listEl) listEl.innerHTML = '<div style="color:rgba(239,68,68,0.7);font-size:0.85rem;text-align:center;padding:20px">' + (typeof t === 'function' ? t('heroesPageLoadError') : 'Не удалось загрузить героев') + '</div>';
        });
      }

      // Раскрытие/схлопывание карточки
      window.toggleHeroCard = function(id) {
        var card = document.getElementById('hcard-' + id);
        if (!card) return;
        card.classList.toggle('expanded');
      };

      // ── Форма героя ───────────────────────────────────────────────────────
      function openHeroForm(h) {
        var cabinet = document.getElementById('masterCabinet');
        var formWrap = document.getElementById('heroFormWrap');
        var titleEl = document.getElementById('heroFormTitle');
        if (cabinet) cabinet.style.display = 'none';
        if (!formWrap) return;
        formWrap.style.display = 'block';
        if (h && h.id) {
          editingHeroId = h.id;
          if (titleEl) titleEl.textContent = 'Изменить героя';
        } else {
          editingHeroId = null;
          if (titleEl) titleEl.textContent = 'Добавить героя';
        }
        document.getElementById('heroName').value = (h && h.name) || '';
        document.getElementById('heroRelationship').value = (h && h.relationship) || '';
        document.getElementById('heroBirthdate').value = (h && h.birth_date) || '';
        if (typeof updateDateSelectsFromInput === 'function') updateDateSelectsFromInput('heroBirthdate');
        document.getElementById('heroBirthtime').value = ((h && h.birth_time) || '').substring(0, 5);
        document.getElementById('heroBirthtimeUnknown').checked = !!(h && h.birthtime_unknown);
        document.getElementById('heroGender').value = (h && h.gender) || '';
        document.getElementById('heroStyle').value = (h && h.preferred_style) || '';
        document.getElementById('heroNotes').value = (h && h.notes) || '';
        // Город: восстанавливаем значение и состояние чекмарка
        var hpInput = document.getElementById('heroBirthplace');
        var hpWrap  = document.getElementById('heroBirthplaceWrap');
        var hpCheck = document.getElementById('heroBirthplaceCheck');
        var hpHint  = document.getElementById('heroBirthplaceHint');
        var birthPlaceVal = (h && h.birth_place) || '';
        if (hpInput) hpInput.value = birthPlaceVal;
        if (hpWrap)  hpWrap.classList.toggle('has-place', !!birthPlaceVal);
        if (hpCheck) hpCheck.setAttribute('aria-hidden', birthPlaceVal ? 'false' : 'true');
        if (hpInput && birthPlaceVal) hpInput.setAttribute('data-place-selected','1');
        else if (hpInput) hpInput.removeAttribute('data-place-selected');
        if (hpHint)  hpHint.style.display = 'none';
        formWrap.scrollTop = 0;
      }

      function closeHeroForm() {
        var cabinet = document.getElementById('masterCabinet');
        var formWrap = document.getElementById('heroFormWrap');
        if (formWrap) formWrap.style.display = 'none';
        if (cabinet) cabinet.style.display = 'block';
        editingHeroId = null;
      }

      var addHeroBtn = document.getElementById('addHeroBtn');
      if (addHeroBtn) addHeroBtn.addEventListener('click', function() { openHeroForm(null); });
      var heroFormCancel = document.getElementById('heroFormCancel');
      if (heroFormCancel) heroFormCancel.addEventListener('click', closeHeroForm);

      var heroFormSave = document.getElementById('heroFormSave');
      if (heroFormSave) heroFormSave.addEventListener('click', function() {
        var name = (document.getElementById('heroName') || {}).value.trim();
        if (!name) { alert('Укажи имя героя'); return; }
        heroFormSave.disabled = true;
        heroFormSave.textContent = 'Сохраняем…';
        var payload = {
          initData: (tg && tg.initData) || '',
          name: name,
          relationship: (document.getElementById('heroRelationship') || {}).value || null,
          birth_date: (document.getElementById('heroBirthdate') || {}).value || null,
          birth_time: (document.getElementById('heroBirthtime') || {}).value || null,
          birth_place: (document.getElementById('heroBirthplace') || {}).value.trim() || null,
          birthtime_unknown: (document.getElementById('heroBirthtimeUnknown') || {}).checked,
          gender: (document.getElementById('heroGender') || {}).value || null,
          preferred_style: (document.getElementById('heroStyle') || {}).value.trim() || null,
          notes: (document.getElementById('heroNotes') || {}).value.trim() || null
        };
        var apiCall = editingHeroId
          ? heroesApi('/heroes/' + editingHeroId, { method: 'PATCH', body: payload })
          : heroesApi('/heroes', { method: 'POST', body: payload });
        apiCall.then(function() {
          closeHeroForm();
          loadHeroesList();
        }).catch(function(e) {
          alert('Ошибка: ' + (e.message || e));
        }).finally(function() {
          heroFormSave.disabled = false;
          heroFormSave.textContent = 'Сохранить';
        });
      });

      var heroesSearchBtn = document.getElementById('heroesSearchBtn');
      if (heroesSearchBtn) heroesSearchBtn.addEventListener('click', loadHeroesList);
      var heroesBackBtn = document.getElementById('heroesBackBtn');
      if (heroesBackBtn) heroesBackBtn.addEventListener('click', function() {
        var formWrap = document.getElementById('heroFormWrap');
        if (formWrap && formWrap.style.display !== 'none') { closeHeroForm(); return; }
        goBack();
      });
      var todayHero = new Date();
      var heroBirthdateEl = document.getElementById('heroBirthdate');
      if (heroBirthdateEl) {
        heroBirthdateEl.max = todayHero.toISOString().split('T')[0];
        var minH = new Date(); minH.setFullYear(minH.getFullYear() - 100);
        heroBirthdateEl.min = minH.toISOString().split('T')[0];
      }

      // ── Автодополнение города для формы героя ────────────────────────────
      (function() {
        var hInput = document.getElementById('heroBirthplace');
        var hSugg  = document.getElementById('heroBirthplaceSuggestions');
        var hWrap  = document.getElementById('heroBirthplaceWrap');
        var hCheck = document.getElementById('heroBirthplaceCheck');
        var hHint  = document.getElementById('heroBirthplaceHint');
        if (!hInput) return;
        var hDebounce = null;
        var hLastQ = '';

        function hHideSuggestions() {
          if (hSugg) { hSugg.innerHTML = ''; hSugg.setAttribute('aria-hidden','true'); hSugg.style.display = 'none'; }
        }
        function hSelectPlace(displayName, lat, lon) {
          hInput.value = (displayName || '').trim();
          hInput.setAttribute('data-place-selected','1');
          if (lat != null) hInput.setAttribute('data-lat', String(lat));
          if (lon != null) hInput.setAttribute('data-lon', String(lon));
          if (hWrap)  hWrap.classList.add('has-place');
          if (hCheck) hCheck.setAttribute('aria-hidden','false');
          if (hHint)  hHint.style.display = 'none';
          hHideSuggestions();
        }
        function hClearSelection() {
          hInput.removeAttribute('data-place-selected');
          hInput.removeAttribute('data-lat');
          hInput.removeAttribute('data-lon');
          if (hWrap)  hWrap.classList.remove('has-place');
          if (hCheck) hCheck.setAttribute('aria-hidden','true');
        }
        function hFetchPlaces(q) {
          if (!q || q.length < 2) { hHideSuggestions(); return; }
          var url = typeof getPlacesSearchUrl === 'function' ? getPlacesSearchUrl(q) : ('https://nominatim.openstreetmap.org/search?q=' + encodeURIComponent(q) + '&format=json&limit=8&addressdetails=1');
          var headers = { 'Accept': 'application/json' };
          if (url.indexOf('nominatim') !== -1) { headers['Accept-Language'] = 'ru'; headers['User-Agent'] = 'YupSoulMiniApp/1.0'; }
          fetch(url, { headers: headers })
            .then(function(r){ return r.json(); })
            .then(function(list){
              if (hLastQ !== q || !hSugg) return;
              hSugg.innerHTML = '';
              (list || []).forEach(function(item) {
                var li = document.createElement('li');
                var main = item.display_name || (item.address && (item.address.city || item.address.town || item.address.village || item.address.state || item.address.country)) || '';
                var country = item.address && item.address.country ? item.address.country : '';
                li.textContent = main;
                if (country) {
                  var sp = document.createElement('div');
                  sp.className = 'place-type';
                  sp.textContent = country + (item.address.country_code ? ' (' + item.address.country_code.toUpperCase() + ')' : '');
                  li.appendChild(sp);
                }
                li.addEventListener('click', function(){ hSelectPlace(item.display_name || main, item.lat, item.lon); });
                hSugg.appendChild(li);
              });
              hSugg.style.display = (list && list.length) ? 'block' : 'none';
              hSugg.setAttribute('aria-hidden', (list && list.length) ? 'false' : 'true');
            })
            .catch(function(){ hHideSuggestions(); });
        }
        hInput.addEventListener('input', function(){
          var v = hInput.value.trim();
          hClearSelection();
          if (v) { hLastQ = v; clearTimeout(hDebounce); hDebounce = setTimeout(function(){ hFetchPlaces(v); }, 320); }
          else hHideSuggestions();
        });
        hInput.addEventListener('focus', function(){
          if (hHint) hHint.style.display = 'none';
          var v = hInput.value.trim();
          if (v && v.length >= 2) { hLastQ = v; hFetchPlaces(v); }
        });
        hInput.addEventListener('blur', function(){
          setTimeout(hHideSuggestions, 200);
        });
      })();

      // ── Быстрый запуск из карточки героя ─────────────────────────────────
      // Хранит данные heroRequest пока loadForWhoSelect не завершился асинхронно
      var _pendingHeroRequest = null;

      function _applyHeroRequest(hero, mode) {
        setMode(mode);
        if (mode === 'couple') {
          // Скрываем forWhoWrap (может быть показан async-колбэком loadForWhoSelect)
          var fww = document.getElementById('forWhoWrap');
          if (fww) fww.style.display = 'none';

          // Предзаполняем person1 профилем текущего пользователя
          fillFormFromProfile(userProfile || (tg && tg.initDataUnsafe && tg.initDataUnsafe.user));
          // Чтобы не требовало «выбери город из списка»: если у person1 уже есть город (3+ символов), считаем его выбранным
          var bp1 = document.getElementById('birthplace');
          if (bp1 && bp1.value.trim().length >= 3) {
            if (!bp1.getAttribute('data-place-selected')) {
              bp1.setAttribute('data-place-selected', '1');
              bp1.setAttribute('data-from-profile', '1');
            }
            var bw1 = document.getElementById('birthplaceWrap');
            if (bw1) bw1.classList.add('has-place');
            var bch1 = document.getElementById('birthplaceCheck');
            if (bch1) bch1.setAttribute('aria-hidden', 'false');
          }
          // Всегда скрываем подсказку для person1 при предзаполнении
          var bHint1 = document.getElementById('birthplaceHint');
          if (bHint1) bHint1.style.display = 'none';

          // Заполняем поля person2 из карточки героя
          var n2   = document.getElementById('name2');
          var bd2  = document.getElementById('birthdate2');
          var bt2  = document.getElementById('birthtime2');
          var unk2 = document.getElementById('unknown2');
          var g2   = document.getElementById('gender2');
          var bp2  = document.getElementById('birthplace2');

          if (n2)   n2.value   = hero.name || '';
          if (bd2)  { bd2.value = (hero.birth_date || '').substring(0, 10); if (typeof updateDateSelectsFromInput === 'function') updateDateSelectsFromInput('birthdate2'); }
          if (bt2)  bt2.value  = (hero.birth_time || '').substring(0, 5);
          if (unk2) unk2.checked = !!hero.birthtime_unknown;
          if (g2)   g2.value   = hero.gender || '';
          var p2rel = document.getElementById('person2Relationship');
          if (p2rel) p2rel.value = hero.relationship || '';
          if (bp2) {
            bp2.value = hero.birth_place || '';
            if (hero.birth_place && hero.birth_place.trim().length >= 3) {
              bp2.setAttribute('data-from-profile', '1');
              bp2.setAttribute('data-place-selected', '1');
              if (hero.birth_lat) bp2.setAttribute('data-lat', String(hero.birth_lat));
              if (hero.birth_lon) bp2.setAttribute('data-lon', String(hero.birth_lon));
              var bw2 = document.getElementById('birthplace2Wrap');
              if (bw2) bw2.classList.add('has-place');
              var bch2 = document.getElementById('birthplace2Check');
              if (bch2) bch2.setAttribute('aria-hidden', 'false');
              var bHint2 = document.getElementById('birthplace2Hint');
              if (bHint2) bHint2.style.display = 'none';
            }
          }
          // Собираем контекст пары для запроса
          (function() {
            var reqEl = document.getElementById('request');
            if (!reqEl || reqEl.value) return;
            var parts = ['Создать совместную песню для нас двоих'];
            if (hero.relationship) parts.push('Кем является ' + hero.name + ' для меня: ' + hero.relationship);
            if (hero.preferred_style) parts.push('Предпочтительный стиль: ' + hero.preferred_style);
            if (hero.notes) parts.push('Особенности и контекст: ' + hero.notes);
            reqEl.value = parts.join('. ');
          })();

          // Скроллим к secondPersonForm чтобы пользователь видел заполненные поля
          setTimeout(function() {
            var sf = document.getElementById('secondPersonForm');
            if (sf) try { sf.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch(e) {}
          }, 100);

        } else {
          // ── Режим «соло»: герой = person1 ──
          var forWhoEl = document.getElementById('forWho');
          if (forWhoEl && hero.id) {
            if (!forWhoEl.querySelector('option[value="' + hero.id + '"]')) {
              var pendingOpt = document.createElement('option');
              pendingOpt.value = hero.id;
              pendingOpt.textContent = hero.name || hero.id;
              pendingOpt.setAttribute('data-pending', '1');
              forWhoEl.appendChild(pendingOpt);
            }
            forWhoEl.value = hero.id;
          }
          fillFormFromHero(hero);
          // Собираем контекст героя для запроса — relationship + preferred_style + notes
          (function() {
            var reqEl = document.getElementById('request');
            if (!reqEl || reqEl.value) return;
            var parts = ['Создать персональную песню'];
            if (hero.relationship) parts.push('Это моя ' + hero.relationship + ' — ' + (hero.name || ''));
            if (hero.preferred_style) parts.push('Предпочтительный стиль: ' + hero.preferred_style);
            if (hero.notes) parts.push('Особенности и контекст: ' + hero.notes);
            if (parts.length > 1) reqEl.value = parts.join('. ');
          })();
        }
      }

      function startHeroRequest(opts) {
        var hero = opts.hero || {};
        var mode = opts.mode || 'single';

        _pendingHeroRequest = { hero: hero, mode: mode };
        goToPage('formPage');

        // Применяем немедленно
        _applyHeroRequest(hero, mode);
        // И повторяем через 600мс — после того как loadForWhoSelect завершит async-запрос
        // и попытается перезаписать forWhoWrap/heroesCache
        setTimeout(function() {
          if (_pendingHeroRequest) {
            _applyHeroRequest(_pendingHeroRequest.hero, _pendingHeroRequest.mode);
            _pendingHeroRequest = null;
          }
        }, 600);
      }

      function fillFormFromProfile(profileOrTgUser) {
        if (!profileOrTgUser) return;
        var nameEl = document.getElementById('name');
        var bd = document.getElementById('birthdate');
        var bt = document.getElementById('birthtime');
        var bp = document.getElementById('birthplace');
        var unk = document.getElementById('unknown');
        var g = document.getElementById('gender');
        var langEl = document.getElementById('language');
        var isProfile = profileOrTgUser && (profileOrTgUser.birthdate != null || profileOrTgUser.birthplace != null);
        var firstName = profileOrTgUser.first_name || profileOrTgUser.name;
        if (nameEl && firstName) nameEl.value = firstName;
        if (isProfile) {
          if (bd) { bd.value = (profileOrTgUser.birthdate || '').toString().slice(0, 10); if (typeof updateDateSelectsFromInput === 'function') updateDateSelectsFromInput('birthdate'); }
          if (bt) bt.value = (profileOrTgUser.birthtime || '').toString().slice(0, 5);
          if (bp) {
            bp.value = profileOrTgUser.birthplace || '';
            if (profileOrTgUser.birthplace && profileOrTgUser.birthplace.length >= 3) {
              bp.setAttribute('data-from-profile', '1');
              bp.setAttribute('data-place-selected', '1');
              var bw = document.getElementById('birthplaceWrap'); if (bw) bw.classList.add('has-place');
              var bch = document.getElementById('birthplaceCheck'); if (bch) bch.setAttribute('aria-hidden', 'false');
              var bHintP = document.getElementById('birthplaceHint'); if (bHintP) bHintP.style.display = 'none';
              if (profileOrTgUser.birthplace_lat != null && profileOrTgUser.birthplace_lon != null) {
                bp.setAttribute('data-lat', String(profileOrTgUser.birthplace_lat));
                bp.setAttribute('data-lon', String(profileOrTgUser.birthplace_lon));
              } else {
                bp.removeAttribute('data-lat');
                bp.removeAttribute('data-lon');
              }
            } else {
              bp.removeAttribute('data-from-profile');
              bp.removeAttribute('data-place-selected');
              bp.removeAttribute('data-lat');
              bp.removeAttribute('data-lon');
              var bw = document.getElementById('birthplaceWrap'); if (bw) bw.classList.remove('has-place');
              var bch = document.getElementById('birthplaceCheck'); if (bch) bch.setAttribute('aria-hidden', 'true');
            }
          }
          if (unk) unk.checked = !!profileOrTgUser.birthtime_unknown;
          if (g) g.value = profileOrTgUser.gender || '';
          if (langEl && profileOrTgUser.language) langEl.value = profileOrTgUser.language;
          var bdWrap = document.getElementById('birthdateWrap');
          if (bdWrap) {
            if (profileOrTgUser.birthdate) { bdWrap.classList.add('has-date'); var bc = document.getElementById('birthdateCheck'); if (bc) bc.setAttribute('aria-hidden', 'false'); }
            else { bdWrap.classList.remove('has-date'); var bc = document.getElementById('birthdateCheck'); if (bc) bc.setAttribute('aria-hidden', 'true'); }
          }
        }
      }
      function fillFormFromHero(hero) {
        if (!hero) return;
        var nameEl = document.getElementById('name');
        var bd = document.getElementById('birthdate');
        var bt = document.getElementById('birthtime');
        var bp = document.getElementById('birthplace');
        var unk = document.getElementById('unknown');
        var g = document.getElementById('gender');
        if (nameEl) nameEl.value = hero.name || '';
        if (bd) { bd.value = hero.birth_date || ''; if (typeof updateDateSelectsFromInput === 'function') updateDateSelectsFromInput('birthdate'); }
        if (bt) bt.value = (hero.birth_time || '').substring(0, 5);
        if (bp) {
          bp.value = hero.birth_place || '';
          bp.removeAttribute('data-lat');
          bp.removeAttribute('data-lon');
          if (hero.birth_place && String(hero.birth_place).trim().length >= 3) {
            bp.setAttribute('data-from-profile', '1');
            bp.setAttribute('data-place-selected', '1');
            var bw = document.getElementById('birthplaceWrap'); if (bw) bw.classList.add('has-place');
            var bch = document.getElementById('birthplaceCheck'); if (bch) bch.setAttribute('aria-hidden', 'false');
            var bHint = document.getElementById('birthplaceHint'); if (bHint) bHint.style.display = 'none';
          } else {
            bp.removeAttribute('data-from-profile');
            bp.removeAttribute('data-place-selected');
            var bw = document.getElementById('birthplaceWrap'); if (bw) bw.classList.remove('has-place');
            var bch = document.getElementById('birthplaceCheck'); if (bch) bch.setAttribute('aria-hidden', 'true');
          }
        }
        if (unk) unk.checked = !!hero.birthtime_unknown;
        if (g) g.value = hero.gender || '';
        var langEl = document.getElementById('language');
        if (langEl && hero.language) langEl.value = hero.language;
        var bdWrap = document.getElementById('birthdateWrap');
        if (bdWrap) {
          if (hero.birth_date) { bdWrap.classList.add('has-date'); var bc = document.getElementById('birthdateCheck'); if (bc) bc.setAttribute('aria-hidden', 'false'); }
          else { bdWrap.classList.remove('has-date'); var bc = document.getElementById('birthdateCheck'); if (bc) bc.setAttribute('aria-hidden', 'true'); }
        }
      }
      function loadForWhoSelect() {
        var wrap = document.getElementById('forWhoWrap');
        var sel = document.getElementById('forWho');
        if (!wrap || !sel) return;
        if (userTariff !== 'master') { wrap.style.display = 'none'; return; }
        // Не показываем в couple-режиме (герой = person2, forWho не нужен)
        if (selectedMode !== 'couple') wrap.style.display = 'block';
        if (wrap._errorEl) { wrap._errorEl.style.display = 'none'; sel.style.display = ''; }
        heroesApi('/heroes', { method: 'GET' }).then(function(d) {
          heroesCache = (d && d.clients) || [];
          var esc = typeof escHtml === 'function' ? escHtml : function(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); };
          sel.innerHTML = '<option value="">' + t('forMyself') + '</option>' + heroesCache.map(function(h) { return '<option value="' + esc(h.id || '') + '">' + t('forHero', { name: esc(h.name || '—') }) + '</option>'; }).join('');
          // Используем onchange вместо addEventListener чтобы не накапливать дублирующие слушатели
          sel.onchange = function() {
            var id = sel.value;
            if (!id) { fillFormFromHero(null); return; }
            var hero = heroesCache.find(function(c) { return c.id === id; });
            if (hero) fillFormFromHero(hero);
          };
          // После загрузки тоже проверяем режим
          if (selectedMode !== 'couple') wrap.style.display = 'block';
          else wrap.style.display = 'none';
          // Если есть ожидающий героям — переприменяем (защита от гонки)
          if (_pendingHeroRequest) {
            _applyHeroRequest(_pendingHeroRequest.hero, _pendingHeroRequest.mode);
          }
        }).catch(function() {
          wrap.style.display = 'block';
          if (!wrap._errorEl) {
            wrap._errorEl = document.createElement('div');
            wrap._errorEl.className = 'forWho-error';
            wrap._errorEl.setAttribute('role', 'alert');
            wrap._errorEl.style.cssText = 'font-size:0.9rem;color:var(--tg-theme-hint-color,rgba(255,255,255,0.7));margin-top:8px;';
            var msg = document.createElement('span');
            msg.className = 'forWho-error-msg';
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'forWho-retry';
            btn.textContent = typeof t === 'function' ? t('retry') : 'Повторить';
            btn.style.cssText = 'margin-left:8px;padding:4px 10px;font-size:0.85rem;cursor:pointer;';
            wrap._errorEl.appendChild(msg);
            wrap._errorEl.appendChild(btn);
            wrap.appendChild(wrap._errorEl);
            btn.addEventListener('click', function() { loadForWhoSelect(); });
          }
          wrap._errorEl.querySelector('.forWho-error-msg').textContent = typeof t === 'function' ? t('heroesLoadError') : 'Не удалось загрузить список.';
          wrap._errorEl.style.display = 'block';
          sel.style.display = 'none';
        });
      }

      var soulChatBtn = document.getElementById('soulChatBtn');
      if (soulChatBtn) soulChatBtn.addEventListener('click', function() {
        goToPage('soulChatPage');
      });
      var soulChatPayBtn = document.getElementById('soulChatPayBtn');
      if (soulChatPayBtn) soulChatPayBtn.addEventListener('click', function() { goToPage('formPage'); setTimeout(function() { var stepNext = document.getElementById('stepNext'); if (stepNext) stepNext.click(); }, 100); });
      function openBotLink(payload) {
        var botUrl = 'https://t.me/' + BOT_USERNAME + (payload ? '?start=' + payload : '');
        if (tg && tg.openTelegramLink) tg.openTelegramLink(botUrl);
        else if (tg && tg.openLink) tg.openLink(botUrl);
        else window.open(botUrl, '_blank');
      }
      var openBotBtn = document.getElementById('openBotBtn');
      if (openBotBtn) openBotBtn.addEventListener('click', function() {
        openBotLink('song_ready');
        setTimeout(function() { try { if (tg && tg.close) tg.close(); } catch(e){} }, 400);
      });
      var openBotBeforeSubmitBtn = document.getElementById('openBotBeforeSubmitBtn');
      if (openBotBeforeSubmitBtn) openBotBeforeSubmitBtn.addEventListener('click', function() { openBotLink('miniapp_start'); });
      var helpSupportBtn = document.getElementById('helpSupportBtn');
      // Загружаем актуальный support_username из бэкенда
      var SUPPORT_USERNAME = BOT_USERNAME;
      (function() {
        var _base = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        if (!_base) return;
        fetch(_base + '/api/config').then(function(r){ return r.json(); }).then(function(d){
          if (d && d.support_username) SUPPORT_USERNAME = d.support_username;
        }).catch(function(){});
      })();
      if (helpSupportBtn) helpSupportBtn.addEventListener('click', function() {
        var supportUrl = 'https://t.me/' + SUPPORT_USERNAME;
        try {
          if (tg && tg.openTelegramLink) { tg.openTelegramLink(supportUrl); return; }
          if (tg && tg.openLink) { tg.openLink(supportUrl); return; }
        } catch(e) {}
        window.open(supportUrl, '_blank');
      });
      var newKeyBtn = document.getElementById('newKeyBtn');
      if (newKeyBtn) newKeyBtn.addEventListener('click', function() {
        var n = document.getElementById('name');
        var bd = document.getElementById('birthdate');
        var bp = document.getElementById('birthplace');
        var bt = document.getElementById('birthtime');
        var g = document.getElementById('gender');
        var langEl = document.getElementById('language');
        var r = document.getElementById('request');
        if (n) n.value = '';
        if (bd) { bd.value = ''; if (typeof updateDateSelectsFromInput === 'function') updateDateSelectsFromInput('birthdate'); }
        if (bp) bp.value = '';
        if (bt) bt.value = '';
        var unknownChk = document.getElementById('unknown'); if (unknownChk) unknownChk.checked = false;
        if (g) g.value = '';
        if (langEl) langEl.value = '';
        if (r) r.value = '';
        var bdWrap = document.getElementById('birthdateWrap');
        if (bdWrap) { bdWrap.classList.remove('has-date'); var bc = document.getElementById('birthdateCheck'); if (bc) bc.setAttribute('aria-hidden', 'true'); }
        var birthplaceHint = document.getElementById('birthplaceHint');
        if (birthplaceHint) birthplaceHint.style.display = 'none';
        var bpEl = document.getElementById('birthplace');
        if (bpEl) { bpEl.removeAttribute('data-place-selected'); bpEl.removeAttribute('data-lat'); bpEl.removeAttribute('data-lon'); }
        var wrap = document.getElementById('birthplaceWrap');
        if (wrap) wrap.classList.remove('has-place');
        goToPage('formPage');
      });
      
      document.querySelectorAll('.preview-nav button').forEach(function(button) {
        button.addEventListener('click', function() {
          var pageMap = { 'home': 'homePage', 'form': 'formPage', 'payment': 'paymentPage', 'loading': 'loadingPage', 'success': 'successPage', 'heroes': 'heroesPage' };
          document.querySelectorAll('.preview-nav button').forEach(function(btn) { btn.classList.remove('active'); });
          this.classList.add('active');
          goToPage(pageMap[button.getAttribute('data-page')] || 'homePage');
        });
      });
      
      (function checkAdminAndShowLink() {
        var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        var initData = (tg && tg.initData) ? tg.initData : (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) || '';
        if (!apiBase || !initData) return;
        fetch(apiBase + '/api/admin/me', { headers: { 'X-Telegram-Init': initData } })
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (!data || !data.admin) return;
            var wrap = document.getElementById('adminLinkWrap');
            var btn = document.getElementById('adminLinkBtn');
            if (!wrap || !btn) return;
            wrap.style.display = 'block';
            btn.addEventListener('click', function(e) {
              e.preventDefault();
              var url = apiBase + '/admin';
              if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.openLink) window.Telegram.WebApp.openLink(url);
              else window.open(url, '_blank');
            });
          })
          .catch(function() {});
      })();
        } catch (e) {
          console.warn('App init error:', e);
        }
      }, 50);
    });
  </script>

  <!--
    PAYMENT OVERLAY — изолированный оверлей оплаты.
    Прямой ребёнок <body>, вне любых stacking context.
    z-index:9999 — выше всего на странице.
    Управляется через showPaymentOverlay() / hidePaymentOverlay() в JS.
  -->
  <div id="paymentOverlay" style="
    display:none;
    position:fixed;inset:0;
    z-index:9999;
    overflow-y:auto;overflow-x:hidden;
    background:linear-gradient(165deg,#0d0b1e 0%,#160a2e 45%,#0d1830 100%);
    color:#fff;
    font-family:'Comfortaa',sans-serif;
  ">
    <div style="max-width:520px;margin:0 auto;padding:28px 18px 40px;">
      <!-- Заголовок -->
      <div style="text-align:center;margin-bottom:24px;">
        <div style="font-size:1.9rem;font-weight:700;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color),var(--primary-color));background-size:300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">YupSoul</div>
        <div style="font-size:0.72rem;font-weight:400;letter-spacing:0.12em;color:rgba(var(--primary-rgb),0.5);margin:2px 0 4px;text-transform:uppercase">Музыка твоей души</div>
        <div id="payOvSubtitle" style="color:rgba(255,255,255,0.75);font-size:0.95rem;margin-top:2px;">Твоя песня</div>
      </div>

      <!-- Карточка оплаты: один продукт, одна цена, один CTA -->
      <div style="background:rgba(15,12,40,0.96);border:1px solid rgba(var(--primary-rgb),0.3);border-radius:18px;padding:24px 20px;">
        <div id="payOvCardTitle" style="color:var(--primary-color);font-weight:700;font-size:1.05rem;margin-bottom:10px;">Оплата заявки</div>

        <!-- Подсказка для новичков (показывается только если free_trial доступен) -->
        <div id="payOvTrialHint" style="display:none;background:rgba(5,150,105,0.15);border:1.5px solid rgba(16,185,129,0.5);border-radius:14px;padding:16px;margin-bottom:16px;">
          <div style="font-size:0.95rem;color:#d1fae5;line-height:1.6;margin-bottom:12px;">
            <strong id="payOvTrialText" style="color:#6ee7b7;">Первая песня — в подарок!</strong>
          </div>
          <button id="payOvFreeClaimBtn" type="button"
            style="width:100%;padding:14px;border-radius:11px;background:linear-gradient(135deg,#059669,#10b981);border:none;color:#fff;font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit;letter-spacing:0.2px;">
            Получить бесплатно
          </button>
        </div>

        <!-- Промокод — раскрываемый блок, чтобы не перегружать экран -->
        <div style="margin-bottom:16px;">
          <button type="button" id="payOvPromoToggle" style="width:100%;padding:10px 0;background:none;border:none;color:rgba(var(--primary-rgb),0.85);font-size:0.9rem;cursor:pointer;font-family:inherit;text-align:left;">▸ Есть промокод?</button>
          <div id="payOvPromoSection" style="display:none;margin-top:8px;">
            <input id="payOvPromoInput" type="text" placeholder="Введите промокод"
              style="display:block;width:100%;box-sizing:border-box;padding:12px 14px;border-radius:10px;border:1.5px solid rgba(var(--primary-rgb),0.65);background:rgba(255,255,255,0.14);color:#fff;font-size:1rem;font-family:inherit;text-transform:uppercase;outline:none;-webkit-appearance:none;margin-bottom:8px;">
            <button id="payOvPromoBtn" type="button"
              style="display:block;width:100%;box-sizing:border-box;padding:11px;border-radius:10px;background:rgba(var(--primary-rgb),0.18);border:1.5px solid rgba(var(--primary-rgb),0.55);color:var(--primary-color);font-weight:600;font-size:0.9rem;cursor:pointer;font-family:inherit;">
              Применить
            </button>
          </div>
        </div>

        <!-- Успешное применение промокода 100% -->
        <div id="payOvPromoSuccessHint" style="display:none;background:rgba(5,150,105,0.15);border:1.5px solid rgba(16,185,129,0.5);border-radius:14px;padding:16px;margin-bottom:16px;">
          <p style="color:#d1fae5;font-size:0.95rem;line-height:1.6;margin:0;">
            <strong style="color:#6ee7b7;">Промокод применён!</strong> Генерация бесплатна.
          </p>
        </div>

        <!-- Кнопка подтверждения промокода 100% -->
        <button id="payOvPromoConfirmBtn" type="button" style="display:none;width:100%;padding:16px;border-radius:13px;background:linear-gradient(135deg,#059669,#10b981);border:none;color:#fff;font-size:1.05rem;font-weight:700;cursor:pointer;font-family:inherit;margin-bottom:16px;letter-spacing:0.3px;">
          Подтвердить и отправить
        </button>

        <!-- Статус (ошибки, предупреждения) -->
        <div id="payOvStatus" style="display:none;border-radius:10px;padding:11px 14px;margin-bottom:14px;font-size:0.88rem;line-height:1.5;"></div>

        <!-- Секция оплаты (HOT Pay) -->
        <div id="payOvPaymentSection" style="margin-bottom:16px;">
          <p id="payOvOrPayText" style="color:rgba(255,255,255,0.8);font-size:0.95rem;margin-bottom:10px;">Или оплати:</p>
          <div style="background:rgba(var(--primary-rgb),0.06);border-radius:12px;padding:14px;margin-bottom:12px;text-align:center;">
            <div id="payOvPriceLabel" style="color:rgba(255,255,255,0.6);font-size:0.85rem;margin-bottom:4px;">Цена:</div>
            <div id="payOvPriceDisplay" style="font-size:1.3rem;font-weight:700;color:var(--primary-color);">5.99 USDT</div>
            <div id="payOvPriceHint" style="font-size:0.8rem;color:rgba(16,185,129,0.8);margin-top:6px;"></div>
          </div>
          <button id="payOvPayBtn" type="button"
            style="width:100%;padding:13px 24px;border-radius:14px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));border:none;color:#fff;font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit;margin-bottom:10px;letter-spacing:0;">
            Оплатить через HOT Pay
          </button>
          <button id="payOvStarsBtn" type="button"
            style="width:100%;padding:13px 24px;border-radius:14px;background:linear-gradient(135deg,#7c3aed,#4f46e5);border:none;color:#fff;font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit;margin-bottom:0;letter-spacing:0;">
            Оплатить звёздами Telegram
          </button>
        </div>

        <!-- Кнопка «скопировать ссылку» (показывается если openLink не сработал) -->
        <div id="payOvLinkRow" style="display:none;margin-bottom:12px;">
          <p id="payOvLinkHint" style="color:rgba(255,255,255,0.75);font-size:0.85rem;margin-bottom:6px;">
            Если окно не открылось — скопируйте ссылку и вставьте в браузер:
          </p>
          <button id="payOvCopyBtn" type="button"
            style="width:100%;padding:11px;border-radius:10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);color:#fff;font-size:0.9rem;cursor:pointer;font-family:inherit;">
            Скопировать ссылку оплаты
          </button>
        </div>

        <!-- Кнопка ручной проверки (показывается после открытия HOT Pay) -->
        <button id="payOvCheckBtn" type="button" style="display:none;width:100%;padding:13px;border-radius:13px;background:rgba(16,185,129,0.12);border:1.5px solid rgba(16,185,129,0.4);color:rgba(16,185,129,0.95);font-size:0.9rem;font-weight:600;cursor:pointer;font-family:inherit;margin-bottom:11px;">
          Я уже оплатил — проверить
        </button>

        <!-- Кнопка назад -->
        <button id="payOvBackBtn" type="button"
          style="width:100%;padding:13px;border-radius:13px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.65);font-size:0.9rem;cursor:pointer;font-family:inherit;">
          ← Назад
        </button>
      </div>
    </div>
  </div>

  <!-- Тост (короткое уведомление) -->
  <div id="scToast" style="display:none;position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom) + 24px);transform:translateX(-50%);z-index:10002;padding:12px 20px;border-radius:14px;background:rgba(15,12,40,0.95);border:1px solid rgba(var(--primary-rgb),0.4);color:rgba(255,255,255,0.95);font-size:0.9rem;font-family:'Comfortaa',sans-serif;box-shadow:0 8px 24px rgba(0,0,0,0.4);max-width:90%;text-align:center;"></div>

  <!-- ЭКРАН ПОДТВЕРЖДЕНИЯ ЗАЯВКИ — position:fixed, z-index выше оплаты, всегда поверх всего -->
  <div id="confirmOverlay" style="
    display:none;
    position:fixed;inset:0;
    z-index:10000;
    background:linear-gradient(165deg,#0d0b1e 0%,#160a2e 45%,#0d1830 100%);
    overflow-y:auto;
    font-family:'Comfortaa',sans-serif;
  ">
    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100%;padding:40px 24px;text-align:center;background:linear-gradient(180deg,rgba(1,6,26,.7) 0%,rgba(8,10,38,.85) 100%);">
      <div style="width:64px;height:64px;border:4px solid rgba(var(--primary-rgb),.15);border-top-color:var(--primary-color);border-radius:50%;margin:0 auto 24px;animation:confirmSpin 1s linear infinite;"></div>
      <div style="font-size:1.5rem;color:var(--primary-color);font-weight:700;margin-bottom:16px;" id="confirmTitle">Заявка принята!</div>
      <div style="color:rgba(255,255,255,0.8);font-size:1rem;line-height:1.8;max-width:340px;" id="confirmDesc">
        Анализирую твои данные и создаю уникальную песню.<br><br>
        Песня придёт в этот чат. Можешь закрыть приложение — ничего не пропадёт.
      </div>
      <button id="confirmContinueBtn" type="button" style="margin-top:28px;padding:13px 44px;border-radius:14px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));border:none;color:#fff;font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit;box-shadow:0 6px 24px rgba(var(--primary-rgb),0.35);letter-spacing:0;">
        Продолжить →
      </button>
    </div>
  </div>
  <!-- Попап подтверждения перед оформлением подписки (без чёрной подложки — раньше её не было) -->
  <div id="planConfirmOverlay" style="
    display:none;position:fixed;inset:0;z-index:10000;
    background:transparent;
    align-items:flex-end;justify-content:center;padding:0 0 env(safe-area-inset-bottom,0) 0;
  " onclick="if(event.target===this)this.style.display='none'">
    <div style="
      background:linear-gradient(160deg,#1a1030 0%,#0d1830 100%);
      border:1px solid rgba(var(--primary-rgb),0.25);
      border-radius:20px 20px 0 0;
      padding:28px 24px 32px;
      max-width:480px;width:100%;
      text-align:center;
    ">
      <div style="width:40px;height:4px;border-radius:2px;background:rgba(255,255,255,0.15);margin:0 auto 20px;"></div>
      <div id="planConfirmTitle" style="font-size:1.15rem;font-weight:700;color:var(--primary-color);margin-bottom:10px;"></div>
      <div id="planConfirmDesc" style="font-size:0.88rem;color:rgba(255,255,255,0.65);line-height:1.5;margin-bottom:24px;"></div>
      <button id="planConfirmBtn" type="button" style="
        width:100%;padding:14px;border-radius:14px;
        background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));
        border:none;color:#fff;font-size:1rem;font-weight:700;
        cursor:pointer;font-family:inherit;
        box-shadow:0 6px 20px rgba(var(--primary-rgb),0.3);
        margin-bottom:10px;
      ">Перейти в бот →</button>
      <button id="planConfirmStarsBtn" type="button" style="
        width:100%;padding:14px;border-radius:14px;
        background:linear-gradient(135deg,#7c3aed,#4f46e5);
        border:none;color:#fff;font-size:1rem;font-weight:700;
        cursor:pointer;font-family:inherit;
        box-shadow:0 6px 20px rgba(124,58,237,0.3);
        margin-bottom:10px;
      ">⭐ Оплатить звёздами</button>
      <button type="button" onclick="document.getElementById('planConfirmOverlay').style.display='none'" style="
        width:100%;padding:12px;border-radius:14px;
        background:transparent;border:1px solid rgba(255,255,255,0.15);
        color:rgba(255,255,255,0.5);font-size:0.9rem;
        cursor:pointer;font-family:inherit;
      ">Отмена</button>
    </div>
  </div>

  <style>
    @keyframes confirmSpin { to { transform: rotate(360deg); } }
    @keyframes planModalIn { from{opacity:0;transform:translateY(40px)} to{opacity:1;transform:translateY(0)} }
    .plan-modal-sheet { animation: planModalIn .25s ease; }
  </style>

  <!-- Модал описания тарифа -->
  <div id="planModalOverlay" class="plan-modal-overlay" style="display:none;" onclick="closePlanModal(event)">
    <div class="plan-modal-sheet" id="planModalSheet">
      <div class="plan-modal-handle"></div>
      <div id="planModalContent"></div>
    </div>
  </div>

  <script>
    var PLAN_DETAILS = {
      basic: {
        title: 'Soul Basic',
        price: '$14.99 / месяц',
        color: 'gold',
        features: [
          { icon: '', name: '5 треков в месяц', desc: 'Каждый месяц — 5 новых персональных песен. Цена за трек по подписке: ~$3 вместо $5.99 в розницу. Экономия 50%.' },
          { icon: '', name: 'Soul Chat', desc: 'ИИ-диалог с твоей душой на основе даты рождения, имени и личных данных. Задавай вопросы о себе, своём характере, пути и предназначении.' },
          { icon: '', name: 'История заказов', desc: 'Все созданные треки сохраняются в твоём профиле. Можно вернуться, переслушать и поделиться в любое время.' },
          { icon: '', name: 'Все форматы', desc: 'Для себя, Для двоих и Энергия дня — доступны все три формата создания песни.' },
        ]
      },
      plus: {
        title: 'Soul Plus',
        price: '$24.99 / месяц',
        color: 'pink',
        features: [
          { icon: '', name: '10 треков в месяц', desc: '10 персональных песен каждый месяц. Цена за трек ~$2.5 — экономия 58% по сравнению с разовой покупкой.' },
          { icon: '', name: 'Soul Chat без лимита', desc: 'Неограниченное количество диалогов с Soul Chat. Общайся с ИИ-отражением своей души когда угодно и сколько угодно.' },
          { icon: '', name: 'Приоритет обработки', desc: 'Твои заявки обрабатываются в первую очередь — песня готова быстрее, чем у остальных пользователей.' },
          { icon: '', name: 'Полная история треков', desc: 'Все треки сохраняются с текстами, аудио и датами создания — всегда доступны в профиле.' },
        ]
      },
      master: {
        title: 'Лаборатория',
        price: '$39.99 / месяц',
        color: 'gold',
        features: [
          { icon: '', name: '30 треков в месяц', desc: 'Максимальный объём — 30 персональных песен каждый месяц для себя и близких. Цена за трек ~$1.33 — экономия 83%.' },
          { icon: '', name: 'Картотека людей', desc: 'Добавляй близких в Лабораторию и создавай для них песни в один тап. Имя, дата рождения и другие данные сохраняются — вводить повторно не нужно.' },
          { icon: '', name: 'История всех генераций', desc: 'Полная история всех созданных треков с текстами, аудио и датами — для тебя и для каждого человека в Картотеке.' },
          { icon: '', name: 'Soul Chat без лимита', desc: 'Неограниченный доступ к Soul Chat для тебя и всех людей из Картотеки.' },
          { icon: '', name: 'Максимальный приоритет', desc: 'Самый высокий приоритет в очереди — песни готовы быстрее всего.' },
        ]
      }
    };

    function openPlanDetails(plan) {
      var data = PLAN_DETAILS[plan];
      if (!data) return;
      var content = document.getElementById('planModalContent');
      if (!content) return;
      var featuresHtml = data.features.map(function(f) {
        return '<div class="plan-modal-feature">'
          + '<div class="plan-modal-feature-icon">' + f.icon + '</div>'
          + '<div class="plan-modal-feature-text"><strong>' + f.name + '</strong><br>' + f.desc + '</div>'
          + '</div>';
      }).join('');
      content.innerHTML = ''
        + '<div class="plan-modal-title">' + data.title + '</div>'
        + '<div class="plan-modal-price">' + data.price + '</div>'
        + '<div class="plan-modal-section">Что входит</div>'
        + featuresHtml
        + '<button class="plan-modal-cta ' + data.color + '" onclick="closePlanModal();document.getElementById(\'planBtn\' + \'' + (plan.charAt(0).toUpperCase()+plan.slice(1)) + '\') && document.getElementById(\'planBtn\' + \'' + (plan.charAt(0).toUpperCase()+plan.slice(1)) + '\').click()">Оформить ' + data.title + '</button>'
        + '<button class="plan-modal-close" onclick="closePlanModal()">Закрыть</button>';
      var overlay = document.getElementById('planModalOverlay');
      if (overlay) { overlay.style.display = 'flex'; document.body.style.overflow = 'hidden'; }
    }
    function closePlanModal(e) {
      if (e && e.target !== document.getElementById('planModalOverlay')) return;
      var overlay = document.getElementById('planModalOverlay');
      if (overlay) { overlay.style.display = 'none'; document.body.style.overflow = ''; }
    }
    window.openPlanDetails = openPlanDetails;
    window.closePlanModal = closePlanModal;
  </script>

  <script>
  (function removeBotNameHeaders() {
    setTimeout(function() {
      console.log('[YupSoul] Финальная зачистка хедера...');
      document.querySelectorAll('.header-title, .page-header-title, .app-title, .profile-header-title').forEach(function(el) {
        el.remove();
      });
      /* Только элементы, у которых весь текст ровно "YupSoul Personal Music" — иначе скрыли бы большой контейнер и белый экран */
      document.querySelectorAll('*').forEach(function(el) {
        if (el.children.length > 0) return;
        var t = el.textContent && el.textContent.trim();
        if (t === 'YupSoul Personal Music') {
          if (!el.classList.contains('logo') && !el.classList.contains('app-logo')) {
            el.style.display = 'none';
            el.style.visibility = 'hidden';
            el.style.width = '0';
            el.style.height = '0';
            el.style.padding = '0';
            el.style.margin = '0';
          }
        }
      });
      var headers = document.querySelectorAll('#homeTopBar, .page-header, .form-header-bar, .profile-header');
      headers.forEach(function(header) {
        header.style.background = 'transparent';
        header.style.backgroundColor = 'transparent';
        header.style.boxShadow = 'none';
        header.style.backdropFilter = 'none';
        header.style.padding = '8px 12px';
        header.style.minHeight = '44px';
        header.style.display = 'flex';
        header.style.justifyContent = 'space-between';
        header.style.alignItems = 'center';
        /* Не скрываем дочерние элементы — иначе скрываются слоты с кнопками (.home-topbar-slot) и весь контент */
      });
      console.log('[YupSoul] Зачистка завершена.');
    }, 2000);
  })();

  (function validatePremiumDesign() {
    if (typeof console === 'undefined') return;
    console.log('[Premium Validator] Запуск проверки...');
    var issues = [];
    var emojiPattern = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u;
    try {
      document.querySelectorAll('button, span, div, p, label, h1, h2, h3').forEach(function(el) {
        if (el.textContent && emojiPattern.test(el.textContent)) issues.push('Эмодзи: ' + (el.className || el.tagName));
      });
      document.querySelectorAll('button, .btn').forEach(function(el) {
        var style = window.getComputedStyle(el);
        var padding = parseInt(style.paddingTop, 10) || 0;
        if (padding < 12 && el.offsetHeight > 0) issues.push('Маленький padding у кнопки: ' + padding + 'px');
      });
      document.querySelectorAll('button, .btn').forEach(function(el) {
        if (el.offsetHeight > 0 && el.offsetHeight < 44) issues.push('Кнопка < 44px: ' + el.offsetHeight + 'px');
      });
      if (issues.length > 0) {
        console.warn('[Premium Validator] Найдено проблем: ' + issues.length);
        issues.slice(0, 10).forEach(function(i) { console.warn('  ' + i); });
      } else {
        console.log('[Premium Validator] Все проверки пройдены.');
      }
    } catch (e) { console.warn('[Premium Validator] Ошибка:', e); }
  })();

  window.checkPremiumCompliance = function checkPremiumCompliance() {
    var emojiRanges = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu;
    var emojiCount = (document.body.textContent.match(emojiRanges) || []).length;
    var buttons = document.querySelectorAll('button');
    var allMinHeight = true;
    for (var i = 0; i < buttons.length; i++) { if (buttons[i].offsetHeight > 0 && buttons[i].offsetHeight < 44) { allMinHeight = false; break; } }
    var goldEls = document.querySelectorAll('[style*="#D4AF37"], [style*="gold"]').length;
    console.log('=== PREMIUM COMPLIANCE ===');
    console.log('Эмодзи:', emojiCount === 0 ? 'OK' : 'Найдено: ' + emojiCount);
    console.log('Кнопки >= 44px:', allMinHeight ? 'OK' : 'Есть кнопки < 44px');
    console.log('Золотых элементов:', goldEls < 20 ? 'OK (' + goldEls + ')' : 'Много (' + goldEls + ')');
  };

  // Демо-тема «бумага + золотая фольга» включается только по ?style=paper или ?style=paper-gold
  (function enablePaperGoldFromQuery() {
    try {
      var qs = window.location.search || '';
      if (/[?&]style=paper(?:-gold)?(?:&|$)/.test(qs)) {
        document.addEventListener('DOMContentLoaded', function() {
          document.body.classList.add('theme-paper-gold');
        });
      }
    } catch (e) {}
  })();
  </script>
</body>
</html>
