# Расширение проекта

Краткий гайд, куда смотреть и что менять, чтобы расширять проект без поломок.

## Внешние API (справочник в коде)

- **DeepSeek** — `bot/deepseek.js`. Ссылка на доки и вариант через OpenAI SDK — в комментарии в начале файла. Замена модели: константа `DEFAULT_MODEL` или опция `opts.model`.
- **Suno** — `bot/suno.js`. Генерация: `generateMusic({ prompt, title, style })`; поллинг: `pollMusicResult(taskId)`. Callback: `BACKEND_URL` или `SUNO_CALLBACK_URL`. Документация: https://docs.sunoapi.org (индекс llms.txt), разделы Generate Music, Get Music Generation Details, Callbacks. Модель по умолчанию: V4_5ALL.
- **Геокодинг** — `bot/geocode.js` (Nominatim). Замена провайдера — только этот файл.

## Куда добавлять новое

| Цель | Где |
|-----|-----|
| Другой LLM вместо/рядом с DeepSeek | Новый файл по образцу `deepseek.js` (или обёртка с тем же интерфейсом `chatCompletion(system, user, opts)`), в `workerGenerate.js` подставляешь нужный модуль. |
| Другой генератор музыки | Новый файл по образцу `suno.js` (`generateMusic` + способ получить аудио). В `workerGenerate.js` после парсинга ответа LLM вызываешь новый модуль вместо Suno. |
| Новый шаг в пайплайне заявки | `workerGenerate.js` → `processOneRequest`: добавить шаг до/после DeepSeek или Suno. Либо новый воркер (отдельный скрипт + сервис/cron). |
| Новый системный промпт или вариант | Таблица `prompt_templates` в Supabase. Либо новый шаблон в БД + в коде выбор по имени (см. `promptTemplates.js`, `MAIN_PROMPT_NAME`). Файлы шаблонов в `bot/prompts/`. |
| Новые поля в заявке | Миграция в Supabase (новые колонки в `track_requests`), обновить форму в Mini App (payload), в боте — `saveRequest` и при необходимости воркер. |
| Новый тип уведомления (email, другой мессенджер) | Отдельный модуль (например `notify.js`), вызов из бота или воркера после нужного события. Токены/ключи — в .env. |

## Конфигурация и env

- Все ключи и URL — в `.env`. В коде только `process.env.*`. Для новых сервисов добавляй переменные в `.env.example` и в `docs/ЗАПУСК_БЕЗ_ЗАГЛУШЕК.md`.
- Проверка наличия переменных перед стартом: `npm run check-env` (скрипт `bot/check-env.js`).

## Алгоритм и контракты

- Единое описание потока: `docs/ALGORITHM.md`. При добавлении шагов (например, премодерация, ещё один LLM) обновляй этот файл, чтобы новые участники понимали порядок.
- Ответ DeepSeek парсится в `workerGenerate.js` → `parseSongFromResponse`. Если меняешь формат ответа (блоки, метки), меняй парсер и при необходимости промпт в БД.

## Деплой

- Бот и воркер на Render описаны в `render.yaml`. Новый фоновый сервис — новый элемент в `services` с своим `startCommand` и теми же (или доп.) env.

Если нужно добавить конкретный сценарий (например, второй язык, второй канал доставки) — можно описать его здесь отдельным пунктом и указать точные файлы/функции.
