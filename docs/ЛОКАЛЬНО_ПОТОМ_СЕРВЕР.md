# Сначала тест на компьютере — потом перенос на сервер

Так можно проверить весь поток локально, а затем задеплоить тот же код на Render без изменений.

---

## Часть 1. Настройка и тест на компьютере

### 1.1. Переменные окружения

1. В папке **bot** создай файл **`.env`** (скопируй из `.env.example`).
2. Заполни минимум:
   - **BOT_TOKEN** — токен от @BotFather (можно тот же, что потом на сервере).
   - **SUPABASE_URL**, **SUPABASE_SERVICE_KEY** — из Supabase → Project Settings → API.
   - **DEEPSEEK_API_KEY** — https://platform.deepseek.com/api_keys
   - **SUNO_API_KEY** — https://sunoapi.org/api-key
3. Опционально: **ADMIN_TELEGRAM_IDS**, **MINI_APP_URL**.  
   **BACKEND_URL** для локального теста можно не ставить — Suno callback не обязателен, воркер забирает результат поллингом.

Проверка:

```bash
cd bot && npm run check-env
```

### 1.2. База данных (один раз)

**Вариант А — одной командой (рекомендуется):**

1. Добавь в `bot/.env` строку DATABASE_URL (если её ещё нет):
   ```bash
   cd bot && npm run ensure-db-url
   ```
   В `.env` появится строка с плейсхолдером; хост подставится из твоего SUPABASE_URL.
2. Открой `bot/.env` и замени **ЗАМЕНИ_ПАРОЛЬ_БД** на пароль из Supabase → Settings → Database → Database password.
3. Выполни миграции и загрузку промпта:
   ```bash
   cd bot && npm run setup:db
   ```

**Вариант Б — вручную в Supabase SQL Editor:**

1. Supabase → SQL Editor. По очереди выполни **содержимое** файлов (копируй весь текст, не только имена):
   - `bot/supabase-schema.sql`
   - `bot/supabase-migration-astro-and-columns.sql`
   - `bot/supabase-migration-detailed-analysis.sql`
   - `bot/supabase-migration-prompt-templates.sql`
2. Загрузи промпт:
   ```bash
   cd bot && npm run seed-ideally-tuned
   ```

### 1.3. Запуск на компьютере

**Терминал 1 — бот:**

```bash
cd bot && npm start
```

Должно появиться что-то вроде: порт открыт, бот подключён.

**Терминал 2 — воркер (цикл):**

```bash
cd bot && npm run worker:loop
```

Воркер раз в минуту проверяет заявки и обрабатывает одну за раз (астро → DeepSeek → Suno → отправка аудио в чат).

### 1.4. Проверка потока

1. В Telegram открой бота → меню → Mini App.
2. Заполни форму (дата, место, время и т.д.) и нажми фиолетовую кнопку «Отправить заявку».
3. В чате должны прийти сообщения «Получил заявку…» и «Заявка принята!».
4. Подожди 1–2 минуты (или дольше, в зависимости от DeepSeek/Suno). Воркер подхватит заявку, сгенерирует текст и аудио — в чат придёт трек.
5. При необходимости проверь `/get_analysis` (расшифровка появится только после оплаты, т.е. после проставления `analysis_paid` в БД).

Когда всё работает локально — переходи к части 2.

---

## Часть 2. Перенос на сервер

Код менять не нужно — только задеплоить и настроить окружение на Render.

### 2.1. Залить код

```bash
git add -A && git commit -m "Готово к деплою" && git push
```

Render подхватит обновления из репозитория (если автодеплой включён).

### 2.2. Остановить локальные процессы

Останови на компьютере бота и воркер (Ctrl+C в обоих терминалах).  
С одним и тем же **BOT_TOKEN** должен работать только один процесс бота (либо локально, либо на сервере), иначе обновления будут «разъезжаться».

### 2.3. Настройка на Render

1. **Web-сервис (бот + API):**
   - В Dashboard сервиса → Environment задай переменные: **BOT_TOKEN**, **SUPABASE_URL**, **SUPABASE_SERVICE_KEY**, **DEEPSEEK_API_KEY**, **SUNO_API_KEY** (и при желании **ADMIN_TELEGRAM_IDS**, **MINI_APP_URL**).
   - Задай **BACKEND_URL** = URL твоего сервиса (например `https://telegram-miniapp-ar09.onrender.com`), чтобы Suno callback вызывал твой домен.

2. **Фоновый воркер (yupsoul-worker):**
   - Включи сервис **yupsoul-worker** в Render (если ещё не включён).
   - Задай ему те же переменные: **BOT_TOKEN**, **SUPABASE_URL**, **SUPABASE_SERVICE_KEY**, **DEEPSEEK_API_KEY**, **SUNO_API_KEY** (BACKEND_URL по желанию).

Подробнее: **docs/ЧЕКЛИСТ_ДЕПЛОЙ_И_ДАЛЬШЕ.md**.

### 2.4. Проверка на сервере

1. Открой бота в Telegram и снова отправь заявку из Mini App.
2. Убедись, что ответы приходят от бота (уже с сервера).
3. Дождись обработки воркером на Render — в чат должно прийти аудио.

---

## Кратко

| Этап        | Где        | Действие |
|------------|------------|----------|
| Тест       | Компьютер  | `.env` → миграции → seed → `npm start` + `npm run worker:loop` → проверить заявку и аудио |
| Перенос    | Сервер     | `git push` → остановить локальные бот и воркер → в Render задать env для веб-сервиса и воркера |
| База       | Одна       | Supabase общая; миграции делаются один раз, и локально и на сервере используется одна БД |

Если позже захочешь снова тестировать на компьютере — просто запусти бота и воркер локально и **останови** их на Render (или используй отдельный тестовый BOT_TOKEN для локальной разработки).
