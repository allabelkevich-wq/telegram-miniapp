# Глюки в Telegram: что проверить

Если в Telegram не открывается приложение, заявки или админка — пройди по списку ниже.

---

## 1. Приложение (Mini App) не открывается или белый экран

- **Откуда открываешь:** только через **кнопку меню** в чате с ботом (внизу «✨ Открыть приложение»). Не по прямой ссылке в браузере.
- **Обнови страницу:** в WebView иногда зажми обновление или закрой и снова открой приложение из бота.
- **Версия Telegram:** обнови приложение до последней версии (мобильный или десктоп).
- **Ссылка в боте:** в Render (Environment) переменная **MINI_APP_URL** — URL приложения на Vercel (например `https://telegram-miniapp-six-teal.vercel.app`), без index.html. После смены URL перезапусти бота / Redeploy.
- **Кнопка меню пропадает?** Бот выставляет её при старте (`setChatMenuButton`), но на Free-плане Render бот «засыпает» — после пробуждения кнопка может не успеть появиться или Telegram её сбрасывает. **Надёжный способ:** задать кнопку один раз в **@BotFather**: открой @BotFather → выбери своего бота → **Bot Settings** → **Menu Button** → **Configure menu button** → введи URL приложения: `https://telegram-miniapp-six-teal.vercel.app` (без слэша в конце). Тогда кнопка хранится на стороне Telegram и не зависит от того, запущен ли бот.
- **Vercel:** после пуша в репо деплой обновляется за 1–2 минуты; в Telegram закрой и снова открой приложение, чтобы подтянуть новую версию.

---

## 2. Форма открывается, но заявка не отправляется

- Открывай приложение **только из чата с ботом** (кнопка меню «✨ Открыть приложение»). Иначе Telegram не даёт отправить данные в бота.
- На странице оплаты нажми **«Отправить заявку»**. Данные уходят либо через **sendData** (Telegram), либо через **API** (запасной способ).
- **Запасной способ (API):** если sendData не срабатывает, приложение шлёт заявку на `POST /api/submit-request` бота. Для этого в `public/index.html` задай **BACKEND_URL** — URL бота на Render (например `https://yourservice.onrender.com`), без слэша в конце. То же значение можно задать в **HEROES_API_BASE** (тогда и «Мои герои», и отправка заявки будут ходить на этот URL).
- Проверь, что **бот запущен** на Render (статус Live). После «сна» первый ответ может прийти через 30–60 сек.
- В чате с ботом после успешной отправки должно прийти «✅ Заявка принята!». Если нет — смотри логи бота на Render (Logs); при отправке через API в логах будет строка `[submit-request] Заявка принята`.

---

## 3. Команда /admin не отвечает или «висит»

- **Кто может:** только пользователи, чей Telegram ID указан в **ADMIN_TELEGRAM_IDS** в Render (переменные окружения). Узнать свой ID: написать боту @userinfobot в Telegram.
- **Где писать:** команду **/admin** нужно писать **в чат с ботом** (тот же чат, где открываешь приложение), а не в группу или другому боту.
- **Задержка на Render (Free):** если бот «спал», первый ответ может приходить **до 50–60 секунд**. Подожди минуту.
- Если через минуту ответа нет — открой на Render вкладку **Logs** и посмотри, есть ли ошибки при команде /admin (таймаут Supabase, ошибка БД и т.п.).

---

## 4. /admin_check для проверки бота и базы

В чате с ботом напиши **/admin_check** (тоже только если твой ID в ADMIN_TELEGRAM_IDS). Бот ответит, подключён ли Supabase и сколько записей в track_requests. Если команда не отвечает — бот не получает сообщения или падает (смотри Logs на Render).

---

## 5. Воркер и полный цикл: как проверить, что трек придёт

Пока ждёшь трек после отправки заявки — можно убедиться, что всё настроено.

1. **Заявка уже отправлена**  
   В чате с ботом пришло «✅ Заявка принята!». Если нет — см. раздел 2 выше.

2. **Заявка в базе**  
   Напиши боту **/admin** (если ты в ADMIN_TELEGRAM_IDS). В списке должна быть новая заявка со статусом **pending**. Если списка нет — проверь **/admin_check**.

3. **Воркер на Render запущен**  
   Render Dashboard → сервис **yupsoul-worker** (Background Worker) → статус **Live**, не suspended.  
   В **Environment** у воркера заданы: `BOT_TOKEN`, `SUPABASE_URL`, `SUPABASE_SERVICE_KEY`, `DEEPSEEK_API_KEY`, `SUNO_API_KEY`.

4. **Логи воркера**  
   У сервиса **yupsoul-worker** открой вкладку **Logs**. Должны быть строки вроде:  
   `[WorkerLoop] Запуск…`, затем «Обрабатываю заявку…», «Натальная карта…», «Отправлено пользователю…».  
   Если видишь «Нет заявок pending» — воркер работает, но очередь пуста (подожди или отправь ещё одну заявку).  
   Если ошибки по DEEPSEEK или SUNO — проверь ключи и квоту.

5. **Сколько ждать**  
   Воркер по умолчанию проверяет очередь раз в **5 минут** (`WORKER_INTERVAL_MS=300000`). После пробуждения Render (free) первый запуск может занять до минуты. Итого: от отправки заявки до трека в чате может пройти **примерно 5–10 минут**.

Подробнее: **docs/ПРОВЕРКА_ПОЛНОГО_ЦИКЛА.md** и **docs/ЗАПУСК_ПОЛНОГО_ПАЙПЛАЙНА.md**.

**Если на Render не добавлена карта** и воркер там не запускается — можно крутить воркер **у себя на компьютере**. Бот пусть остаётся на Render, не запускай бота локально. В папке `bot` должен быть `.env` с теми же переменными (BOT_TOKEN, SUPABASE_*, DEEPSEEK_API_KEY, SUNO_API_KEY). Затем в терминале:
```bash
cd bot && npm run worker:loop
```
Оставь окно открытым. Воркер раз в 5 минут будет забирать заявки из Supabase и отправлять треки в Telegram. Когда закроешь терминал — воркер остановится; новые заявки будут ждать до следующего запуска.

---

## 6. Краткий чек-лист

| Проверка | Действие |
|----------|----------|
| Открываю приложение только из чата с ботом | Кнопка меню внизу в чате с ботом |
| MINI_APP_URL в боте совпадает с приложением | Vercel: `https://telegram-miniapp-six-teal.vercel.app` (или твой домен) |
| Бот на Render в статусе Live | Dashboard Render → сервис → Logs при ошибках |
| Мой ID в ADMIN_TELEGRAM_IDS | Переменные в Render, команды /admin и /admin_check в личке с ботом |
| Telegram обновлён | App Store / Google Play / desktop |
| После пуша в репо подождала 1–2 минуты | GitHub Pages / Vercel обновляется не мгновенно |
| Трек не пришёл | Проверить воркер на Render (раздел 5), логи, DEEPSEEK/SUNO ключи |

Если после этого что-то всё равно не работает — опиши, что именно: «не открывается приложение» / «открывается, но кнопки нет» / «/admin не отвечает» и т.д., и при возможности скрин или текст ошибки из Logs на Render.
