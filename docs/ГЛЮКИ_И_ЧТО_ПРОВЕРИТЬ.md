# Глюки в Telegram: что проверить

Если в Telegram не открывается приложение, заявки или админка — пройди по списку ниже.

---

## 1. Приложение (Mini App) не открывается или белый экран

- **Откуда открываешь:** только через **кнопку меню** в чате с ботом (внизу «✨ Открыть приложение»). Не по прямой ссылке в браузере.
- **Обнови страницу:** в WebView иногда зажми обновление или закрой и снова открой приложение из бота.
- **Версия Telegram:** обнови приложение до последней версии (мобильный или десктоп).
- **Ссылка в боте:** в Render (Environment) переменная **MINI_APP_URL** — URL приложения на Vercel (например `https://telegram-miniapp-six-teal.vercel.app`), без index.html. После смены URL перезапусти бота / Redeploy.
- **Кнопка меню слетает?** В коде бота **отключена** установка кнопки через API — бот не вызывает `setChatMenuButton`, поэтому настройку задаёшь **только в @BotFather**. **Актуальная ссылка:** `https://telegram-miniapp-six-teal.vercel.app` (без слэша в конце).
- **В BotFather кнопка «Сохранить» просто грузится?** Не используй My Bots → Bot Settings → Menu Button. Напиши @BotFather **в чате** команду **`/setmenubutton`** → выбери своего бота → выбери **Configure menu button** → вставь URL: `https://telegram-miniapp-six-teal.vercel.app` → при необходимости введи текст кнопки (например «Открыть приложение»). Сохранение через команду часто срабатывает, когда интерфейс зависает.
- **Vercel:** после пуша в репо деплой обновляется за 1–2 минуты; в Telegram закрой и снова открой приложение, чтобы подтянуть новую версию.

---

## 2. Форма открывается, но заявка не отправляется

- Открывай приложение **только из чата с ботом** (кнопка меню «✨ Открыть приложение»). Иначе Telegram не даёт отправить данные в бота.
- На странице оплаты нажми **«Отправить заявку»**. Данные уходят либо через **sendData** (Telegram), либо через **API** (запасной способ).
- **Запасной способ (API):** если sendData не срабатывает, приложение шлёт заявку на `POST /api/submit-request` бота. Для этого в `public/index.html` задай **BACKEND_URL** — URL бота на Render (например `https://yourservice.onrender.com`), без слэша в конце. То же значение можно задать в **HEROES_API_BASE** (тогда и «Мои герои», и отправка заявки будут ходить на этот URL).
- Проверь, что **бот запущен** на Render (статус Live). После «сна» первый ответ может прийти через 30–60 сек.
- В чате с ботом после успешной отправки должно прийти «✅ Заявка принята!». Если нет — смотри логи бота на Render (Logs); при отправке через API в логах будет строка `[submit-request] Заявка принята`.

---

## 3. Команда /admin не отвечает или «висит»

- **Кто может:** только пользователи, чей Telegram ID указан в **ADMIN_TELEGRAM_IDS** в Render (переменные окружения). Узнать свой ID: написать боту @userinfobot в Telegram.
- **Где писать:** команду **/admin** нужно писать **в чат с ботом** (тот же чат, где открываешь приложение), а не в группу или другому боту.
- **Задержка на Render (Free):** если бот «спал», первый ответ может приходить **до 50–60 секунд**. Подожди минуту.
- Если через минуту ответа нет — открой на Render вкладку **Logs** и посмотри, есть ли ошибки при команде /admin (таймаут Supabase, ошибка БД и т.п.).

---

## 4. /admin_check для проверки бота и базы

В чате с ботом напиши **/admin_check** (тоже только если твой ID в ADMIN_TELEGRAM_IDS). Бот ответит, подключён ли Supabase и сколько записей в track_requests. Если команда не отвечает — бот не получает сообщения или падает (смотри Logs на Render).

---

## 4.1. Команды не откликаются вообще (/start, /ping, /admin и т.д.)

- **В браузере сначала «пробуждение», потом серый экран:** после деплоя при открытии ссылки на сервис (например …/healthz или корень) должна появляться страница с текстом «Сервис работает» или «Запуск…», а не пустой серый экран. Если видишь серый экран — открой **Render → твой сервис → Logs**: возможно, при старте падает ошибка (нет BOT_TOKEN, ошибка Supabase и т.п.). Исправь переменные окружения и сделай Redeploy. Обнови страницу в браузере через 1–2 минуты.
- **Проверка связи:** напиши боту **/ping**. Должен прийти ответ «Бот на связи. Команды работают.» Если ответа нет — бот не получает апдейты от Telegram.
- **Почему так бывает:** на Render (Free) сервис **засыпает** после ~15 мин без запросов. Пока он спит, бот не опрашивает Telegram — команды «висят». Разбудить: открой в браузере `https://твой-сервис.onrender.com/healthz`, подожди 30–60 сек, затем снова напиши боту **/ping** или **/start**.
- **Сообщение «просто грузит», ответа нет:** как только бот получит апдейт, он сразу отправит индикатор «печатает…». Если даже «печатает» не появляется — бот ещё не получил сообщение (часто из‑за сна Render). Открой в браузере `https://твой-сервис.onrender.com/healthz`, подожди 30–60 сек, затем снова напиши боту; после пробуждения должен появиться «печатает…», затем ответ.
- **Логи:** в Render → твой сервис → **Logs**. Когда бот получает сообщение, в логах появляется строка вида `[TG] msg from 123456789 : /ping`. Если после твоей команды такой строки нет — сервис спал или не успел обработать; разбуди через healthz и попробуй ещё раз.
- **Бот не видит команды:** чаще всего у бота **установлен webhook** (старый URL). Тогда Telegram шлёт все сообщения туда, а не боту на Render. **Что сделать:** при каждом старте бот сам сбрасывает webhook. Открой в браузере **`https://твой-сервис.onrender.com/healthz?webhook=1`** — там будет статус webhook (или ссылка «Статус webhook» на главной странице /healthz). Если указан какой-то URL — сделай **Redeploy**, подожди 1–2 мин, снова открой .../healthz?webhook=1 — должно быть «(не установлен)». Затем напиши боту /ping.
- **Настройки TG:** команды задаются в коде бота (`setMyCommands`). В @BotFather отдельно настраивать список команд не нужно — бот при старте сам регистрирует: /start, /ping, /get_analysis, /admin, /admin_check.

---

## 4.2. Заявки не доходят до воркера (трек не приходит)

- **Бот только сохраняет заявки в Supabase.** Обработкой (астро → DeepSeek → Suno → отправка трека) занимается **воркер** — отдельный процесс. На Render по умолчанию **воркер не запущен** (нужна карта для Background Worker или ты запускаешь его вручную).
- **Проверь, что заявка в базе:** напиши боту **/admin** (если ты админ). В списке должна быть заявка со статусом **pending**. Если её нет — проблема в сохранении (см. раздел 2; проверь SUPABASE_URL и SUPABASE_SERVICE_KEY в Render).
- **Запуск воркера локально:** в папке `bot` создай/скопируй `.env` с теми же **SUPABASE_URL**, **SUPABASE_SERVICE_KEY**, **BOT_TOKEN**, **DEEPSEEK_API_KEY**, **SUNO_API_KEY**, что и на Render. В терминале: `cd bot && npm run worker:loop`. Оставь окно открытым — воркер раз в 5 минут забирает из Supabase заявки со статусом `pending` и обрабатывает их. Если воркер не запущен ни на Render, ни локально — заявки так и останутся в очереди, трек не придёт.
- В логах воркера при отсутствии заявок будет: `[Worker] Нет заявок pending`. После отправки новой заявки из приложения при следующем тике воркер её подхватит.

---

## 5. Воркер и полный цикл: как проверить, что трек придёт

Пока ждёшь трек после отправки заявки — можно убедиться, что всё настроено.

1. **Заявка уже отправлена**  
   В чате с ботом пришло «✅ Заявка принята!». Если нет — см. раздел 2 выше.

2. **Заявка в базе**  
   Напиши боту **/admin** (если ты в ADMIN_TELEGRAM_IDS). В списке должна быть новая заявка со статусом **pending**. Если списка нет — проверь **/admin_check**.

3. **Воркер на Render запущен**  
   Render Dashboard → сервис **yupsoul-worker** (Background Worker) → статус **Live**, не suspended.  
   В **Environment** у воркера заданы: `BOT_TOKEN`, `SUPABASE_URL`, `SUPABASE_SERVICE_KEY`, `DEEPSEEK_API_KEY`, `SUNO_API_KEY`.

4. **Логи воркера**  
   У сервиса **yupsoul-worker** открой вкладку **Logs**. Должны быть строки вроде:  
   `[WorkerLoop] Запуск…`, затем «Обрабатываю заявку…», «Натальная карта…», «Отправлено пользователю…».  
   Если видишь «Нет заявок pending» — воркер работает, но очередь пуста (подожди или отправь ещё одну заявку).  
   Если ошибки по DEEPSEEK или SUNO — проверь ключи и квоту.

5. **Сколько ждать**  
   Воркер по умолчанию проверяет очередь раз в **5 минут** (`WORKER_INTERVAL_MS=300000`). После пробуждения Render (free) первый запуск может занять до минуты. Итого: от отправки заявки до трека в чате может пройти **примерно 5–10 минут**.

Подробнее: **docs/ПРОВЕРКА_ПОЛНОГО_ЦИКЛА.md** и **docs/ЗАПУСК_ПОЛНОГО_ПАЙПЛАЙНА.md**.

**Если на Render не добавлена карта** и воркер там не запускается — можно крутить воркер **у себя на компьютере**. Бот пусть остаётся на Render, не запускай бота локально. В папке `bot` должен быть `.env` с теми же переменными (BOT_TOKEN, SUPABASE_*, DEEPSEEK_API_KEY, SUNO_API_KEY). Затем в терминале:
```bash
cd bot && npm run worker:loop
```
Оставь окно открытым. Воркер раз в 5 минут будет забирать заявки из Supabase и отправлять треки в Telegram. Когда закроешь терминал — воркер остановится; новые заявки будут ждать до следующего запуска.

---

## 6. Краткий чек-лист

| Проверка | Действие |
|----------|----------|
| Открываю приложение только из чата с ботом | Кнопка меню внизу в чате с ботом |
| MINI_APP_URL в боте совпадает с приложением | Vercel: `https://telegram-miniapp-six-teal.vercel.app` (или твой домен) |
| Бот на Render в статусе Live | Dashboard Render → сервис → Logs при ошибках |
| Мой ID в ADMIN_TELEGRAM_IDS | Переменные в Render, команды /admin и /admin_check в личке с ботом |
| Telegram обновлён | App Store / Google Play / desktop |
| После пуша в репо подождала 1–2 минуты | GitHub Pages / Vercel обновляется не мгновенно |
| Трек не пришёл | Проверить воркер на Render (раздел 5), логи, DEEPSEEK/SUNO ключи |

Если после этого что-то всё равно не работает — опиши, что именно: «не открывается приложение» / «открывается, но кнопки нет» / «/admin не отвечает» и т.д., и при возможности скрин или текст ошибки из Logs на Render.
