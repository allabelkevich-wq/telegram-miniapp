# Заявки: просмотр и обработка

Понятная логика от отправки заявки до готового трека и как админ смотрит заявки.

---

## 1. Как пользователь отправляет заявку

1. Пользователь открывает бота в Telegram → нажимает кнопку меню (или «Открыть приложение» после `/start`).
2. Открывается Mini App: форма (имя, дата/место/время рождения, запрос и т.д.).
3. Заполняет форму → переходит на страницу оплаты → нажимает **«Отправить заявку»**.
4. Появляется **фиолетовая кнопка внизу экрана** — «Отправить заявку во Вселенную» (кнопка Telegram). Нужно нажать именно её.
5. Пользователь нажимает эту нижнюю кнопку → приложение показывает «Отправляю заявку…» и **закрывается**.
6. Пользователь оказывается в чате с ботом и видит сообщения:
   - «Получил заявку, сохраняю…»
   - «Заявка принята! Твой персональный звуковой ключ будет создан…»

**Важно:** ответ «Заявка принята!» приходит **в чат с ботом**, а не в окне приложения. На телефоне приложение после отправки специально закрывается — так пользователь сразу видит ответ в чате. Если окно «Заявка принята» в приложении не открывалось на телефоне — это нормально: смотри ответ в чате.

---

## 2. Что делает бот с заявкой

- Получает данные из Mini App (событие `web_app_data`).
- Сохраняет заявку в Supabase в таблицу **`track_requests`** со статусом **`pending`**.
- Отвечает в чат: «Заявка принята!» и при необходимости запускает расчёт натальной карты (астро).
- Если в `.env` указаны админы (`ADMIN_TELEGRAM_IDS`) — отправляет им в личку уведомление о новой заявке.

---

## 3. Как админ смотрит заявки

Команды только для пользователей, чей Telegram ID указан в `ADMIN_TELEGRAM_IDS` в `bot/.env`.

| Команда | Что делает |
|--------|-------------|
| **`/admin`** | Список последних заявок из Supabase: ID, имя, дата/место, запрос, статус, дата создания. Если Supabase недоступен — показываются заявки из памяти бота (если есть). |
| **`/admin_check`** | Проверка подключения к Supabase и количество записей в `track_requests`. Пишет: «Подключение к Supabase: OK. В таблице track_requests записей: N». |

Если заявок 0 — отправь тестовую заявку из приложения (из чата с ботом открой Mini App и отправь форму), затем снова `/admin`.

---

## 4. Как заявки обрабатываются (до аудио)

Обработкой занимается **воркер**: он берёт заявки со статусом **`pending`**, считает натальную карту, генерирует текст и музыку, отправляет аудио пользователю в Telegram.

**Статусы заявки в БД:**

| Статус | Значение |
|--------|----------|
| `pending` | Ожидает обработки |
| `processing` | Воркер взял в работу |
| `completed` | Готово: аудио отправлено пользователю |
| `failed` | Ошибка (например, ошибка API); в `error_message` можно посмотреть причину |

**Как запускать воркер:**

- **Один раз вручную (одна заявка):**  
  `cd bot && npm run worker:full`
- **Цикл (каждые N минут, например на Render):**  
  `cd bot && npm run worker:loop`  
  Интервал по умолчанию 5 минут (переменная `WORKER_INTERVAL_MS` в `.env`).

Воркер:
1. Выбирает одну заявку со статусом `pending` (по очереди создания).
2. При необходимости считает натальную карту и сохраняет в `astro_snapshots`.
3. Генерирует архетип и текст песни (DeepSeek), название.
4. Запускает генерацию аудио (Suno), по готовности получает ссылку.
5. Обновляет заявку: `audio_url`, `status = 'completed'`.
6. Отправляет пользователю в Telegram сообщение со ссылкой на трек (или файлом).

Если воркер не запущен — заявки так и останутся в `pending`; пользователь уже видел «Заявка принята!», но трек придёт только после работы воркера.

---

## 5. Краткая схема

```
Пользователь (Mini App) → «Отправить заявку» → приложение закрывается
       ↓
Чат с ботом: «Получил заявку…» → «Заявка принята!»
       ↓
Бот пишет в Supabase: track_requests (status = pending)
       ↓
Админ: /admin — список заявок, /admin_check — проверка БД
       ↓
Воркер (worker:full или worker:loop): берёт pending → астро → DeepSeek → Suno → отправка аудио в чат пользователю
```

---

## 6. Частые вопросы

**На телефоне после нажатия «Отправить заявку» не открывается окно «Заявка принята».**  
Так и задумано: приложение закрывается, чтобы пользователь сразу увидел ответ в чате с ботом («Заявка принята!»). Смотри ответ там.

**Заявки не появляются в /admin.**  
Убедись, что приложение открыто **из Telegram** (кнопка меню в чате с ботом), а не в браузере. Проверь `/admin_check`: если записей 0, отправь заявку из приложения ещё раз из чата с ботом.

**После «Отправить заявку» ничего не происходит / заявка не уходит.**  
Нужно нажать **фиолетовую кнопку внизу экрана** («Отправить заявку во Вселенную») — это отдельная кнопка Telegram. Не путать с кнопкой «Отправить заявку» на странице: сначала она, затем появляется нижняя кнопка — нажимай её. Если нижняя кнопка не появляется или не срабатывает — обнови приложение (закрой и открой снова из чата с ботом), обнови версию Telegram.

**Трек не приходит пользователю.**  
Запусти воркер (`npm run worker:full` или на Render — Background Worker с `npm run worker:loop`). Проверь в `.env`: `DEEPSEEK_API_KEY`, `SUNO_API_KEY`. В Supabase у заявки должен смениться статус с `pending` на `processing`, затем `completed`.
