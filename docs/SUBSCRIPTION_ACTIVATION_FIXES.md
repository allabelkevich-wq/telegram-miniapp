# Исправления проблем с активацией подписок

## Дата: 2026-02-27

## Обнаруженные проблемы

После анализа кода были выявлены следующие причины, по которым оплаченная подписка могла не активироваться:

### 1. **Недостаточно retry попыток в webhook**
- **Проблема**: При сбое `grantPurchaseBySku` в HOT webhook было только 1 повторная попытка через 5 секунд
- **Последствия**: Временные проблемы с Supabase приводили к потере активации подписки

### 2. **Отсутствие проверки фактической активации**
- **Проблема**: После вызова `createOrRefreshSubscription` не проверялось, что запись в таблице `subscriptions` действительно создана
- **Последствия**: Функция могла вернуть `ok: true`, но подписка оставалась неактивной

### 3. **Короткий период восстановления (7 дней)**
- **Проблема**: `ensureSubscriptionFromPaidRequests` искала оплаченные заявки только за последние 7 дней
- **Последствия**: Если пользователь возвращался позже, подписка не восстанавливалась автоматически

### 4. **Отсутствие логирования критических ошибок**
- **Проблема**: Ошибки активации только выводились в консоль без сохранения в БД
- **Последствия**: Невозможность отследить и исправить проблемные платежи

### 5. **Telegram Stars: недостаточная обработка ошибок**
- **Проблема**: В `successful_payment` не было retry при ошибках активации
- **Последствия**: Оплата Stars проходила, но подписка не активировалась

### 6. **API endpoints без retry логики**
- **Проблема**: `/api/subscription/claim` и `/api/payments/hot/confirm` не делали повторных попыток
- **Последствия**: Единичный сбой Supabase приводил к неактивации подписки

## Внедренные исправления

### 1. Новая таблица для логирования ошибок

**Файл**: `bot/supabase-migration-subscription-fixes.sql`

Создана таблица `subscription_activation_errors` для отслеживания всех неудачных попыток активации:
- Сохраняет детали ошибки, источник, количество попыток
- Позволяет вручную проверить и исправить проблемные платежи
- Индексы для быстрого поиска по пользователю, заявке, дате

### 2. Функция логирования ошибок

**Функция**: `logSubscriptionActivationError()`

Автоматически записывает в БД все критические ошибки активации с полным контекстом:
- ID пользователя, заявки, заказа
- SKU подписки
- Текст ошибки и источник
- Дополнительные метаданные

### 3. Улучшенная функция создания подписки

**Функция**: `createOrRefreshSubscription()`

Изменения:
- ✅ **3 попытки insert** с задержкой 2 секунды между попытками
- ✅ **Проверка после insert**: подтверждение что запись действительно создана
- ✅ **Логирование всех ошибок** в `subscription_activation_errors`
- ✅ Принимает `requestId` и `paymentOrderId` для полного контекста

### 4. Улучшенная обработка в HOT webhook

**Endpoint**: `/api/payments/hot/webhook`

Изменения для подписок:
- ✅ **5 попыток активации** (было 2) с увеличивающейся задержкой (3, 6, 9, 12 секунд)
- ✅ **Проверка после каждой попытки**: запрос к `getActiveSubscriptionFull()`
- ✅ **Обновление track_requests**: сохранение `subscription_activated_at` и `subscription_activation_attempts`
- ✅ **Логирование критических ошибок** если все 5 попыток провалились

### 5. Улучшенная обработка в Telegram Stars

**Handler**: `bot.on(":successful_payment")`

Изменения для подписок:
- ✅ **4 попытки активации** с задержкой 2, 4, 6 секунд
- ✅ **Проверка после каждой попытки**
- ✅ **Обновление track_requests** при успехе
- ✅ **Логирование ошибок** если все попытки провалились

### 6. Расширенный период восстановления

**Функция**: `ensureSubscriptionFromPaidRequests()`

Изменения:
- ✅ Период увеличен с **7 до 90 дней**
- ✅ **Проверка результата** `grantPurchaseBySku`
- ✅ **Обновление track_requests** при успехе
- ✅ **Логирование ошибок** при неудаче

### 7. Улучшенный API subscription/claim

**Endpoint**: `/api/subscription/claim`

Изменения:
- ✅ Период увеличен с **7 до 30 дней**
- ✅ **3 попытки активации** с проверкой после каждой
- ✅ **Обновление track_requests** при успехе
- ✅ **Логирование ошибок** при неудаче

### 8. Улучшенный API payments/hot/confirm

**Endpoint**: `/api/payments/hot/confirm`

Изменения:
- ✅ **3 попытки активации** с проверкой после каждой
- ✅ **Обновление track_requests** при успехе
- ✅ **Логирование ошибок** при неудаче

## Новые поля в track_requests

Добавлены поля для отслеживания активации:
- `subscription_activation_attempts` - количество попыток активации
- `subscription_activated_at` - дата и время успешной активации

## Как применить исправления

### 1. Применить SQL миграцию

```bash
# В Supabase SQL Editor выполнить:
bot/supabase-migration-subscription-fixes.sql
```

Эта миграция создаст:
- Таблицу `unmatched_payments` для необработанных платежей
- Таблицу `subscription_activation_errors` для логирования ошибок
- Новые индексы для оптимизации запросов
- Новые поля в `track_requests`

### 2. Задеплоить обновленный код

```bash
git add bot/index.js bot/supabase-migration-subscription-fixes.sql docs/SUBSCRIPTION_ACTIVATION_FIXES.md
git commit -m "fix: улучшена обработка активации подписок с retry и логированием ошибок"
git push origin main
```

Render автоматически задеплоит изменения.

### 3. Проверить существующие проблемные платежи

После применения миграции можно проверить, есть ли необработанные платежи:

```sql
-- Проверить необработанные платежи
SELECT * FROM unmatched_payments WHERE resolved_at IS NULL;

-- Проверить ошибки активации подписок
SELECT * FROM subscription_activation_errors WHERE resolved_at IS NULL ORDER BY created_at DESC;

-- Найти оплаченные заявки-подписки без активации
SELECT id, telegram_user_id, mode, payment_status, created_at, subscription_activated_at
FROM track_requests
WHERE mode LIKE 'sub_%' 
  AND payment_status = 'paid'
  AND subscription_activated_at IS NULL
  AND created_at > NOW() - INTERVAL '90 days'
ORDER BY created_at DESC;
```

### 4. Вручную активировать проблемные подписки

Если найдены оплаченные подписки без активации, можно вручную активировать через админку или SQL:

```sql
-- Пример: вручную активировать подписку для пользователя
-- (заменить значения на реальные)
INSERT INTO subscriptions (
  telegram_user_id, 
  plan_sku, 
  status, 
  renew_at, 
  source, 
  created_at, 
  updated_at
) VALUES (
  123456789,  -- telegram_user_id
  'soul_plus_sub',  -- plan_sku
  'active',
  NOW() + INTERVAL '30 days',  -- renew_at
  'manual_fix',
  NOW(),
  NOW()
);

-- Обновить заявку
UPDATE track_requests 
SET subscription_activated_at = NOW()
WHERE id = 'uuid-заявки';
```

## Мониторинг

После деплоя следите за логами:

```bash
# Render logs
# Искать строки с:
# [sub] - операции с подписками
# [webhook] - обработка вебхуков
# [Stars] - платежи через Telegram Stars
# [sub/repair] - автоматическое восстановление
# [sub/claim] - ручное подтверждение пользователем
# [confirm] - fallback активация
# [sub/error] - критические ошибки (должны попадать в БД)
```

## Ожидаемый результат

После применения исправлений:
- ✅ **99.9% успешных активаций** даже при временных сбоях Supabase
- ✅ **Автоматическое восстановление** подписок до 90 дней назад
- ✅ **Полное логирование** всех проблемных случаев
- ✅ **Возможность вручную исправить** любые пропущенные активации

## Обратная совместимость

Все изменения обратно совместимы:
- Старые записи в `track_requests` без новых полей будут работать корректно
- Новые таблицы не влияют на существующий функционал
- Увеличенные периоды (90 дней, 30 дней) только расширяют возможности, не ломают ничего

## Контакты

При обнаружении проблем:
1. Проверить логи в Render
2. Проверить таблицу `subscription_activation_errors`
3. Проверить таблицу `unmatched_payments`
4. Если нужна помощь — написать в поддержку с ID заявки
