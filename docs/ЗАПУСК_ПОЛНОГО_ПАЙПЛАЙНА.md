# Запуск полного пайплайна (заявка → астро → DeepSeek → Suno → аудио в Telegram)

Один раз настроил — дальше только запускать два процесса: **бот** и **воркер**.

---

## Что должно быть сделано до запуска

1. **Миграции в Supabase** выполнены (schema + astro-and-columns + detailed-analysis + prompt-templates).  
   См. `docs/КАК_ВЫПОЛНИТЬ_МИГРАЦИЮ.md`.

2. **Промпт в БД:**  
   `cd bot && npm run seed-ideally-tuned`

3. **В `bot/.env` заданы:**
   - `BOT_TOKEN` — токен бота
   - `SUPABASE_URL`, `SUPABASE_SERVICE_KEY` — доступ к БД
   - `DEEPSEEK_API_KEY` — для генерации текста песен ([platform.deepseek.com](https://platform.deepseek.com/api_keys))
   - `SUNO_API_KEY` — для генерации музыки (например [sunoapi.org](https://sunoapi.org))
   - по желанию: `ADMIN_TELEGRAM_IDS`, `BACKEND_URL`, `SUNO_MODEL`, `SUNO_VOCAL_GENDER`

Проверка: `cd bot && npm run check-env`

---

## Запуск процессов

### 1. Бот (приём заявок, ответы в чат, /admin)

В первом терминале:

```bash
cd /Users/arhan/telegram-miniapp/bot
npm start
```

Бот должен вывести что-то вроде: «Бот запущен», «Supabase: подключен», «Кнопка меню установлена».

### 2. Воркер (астро → DeepSeek → Suno → отправка аудио)

Во втором терминале (или в фоне):

```bash
cd /Users/arhan/telegram-miniapp/bot
npm run worker:start
```

Или с интервалом по умолчанию (5 минут):

```bash
npm run worker:loop
```

- **worker:start** — проверка очереди каждые **60 секунд** (удобно для теста).
- **worker:loop** — каждые **5 минут** (можно задать `WORKER_INTERVAL_MS` в `.env` в миллисекундах).

При старте воркер пишет:  
«Пайплайн: заявка → астро (Swiss Ephemeris) → DeepSeek (текст) → Suno (аудио) → отправка в Telegram».

Если в `.env` нет `DEEPSEEK_API_KEY` или `SUNO_API_KEY`, в логе будет предупреждение — добавь ключи, иначе генерация не пойдёт.

---

## Как это работает по шагам

1. Пользователь отправляет заявку из Mini App (кнопка внизу экрана «Отправить заявку во Вселенную»).
2. Бот сохраняет заявку в Supabase (`track_requests`, статус `pending`) и отвечает в чат: «Заявка принята!».
3. Воркер раз в N секунд/минут смотрит: есть ли заявка со статусом `pending`.
4. Для первой такой заявки воркер:
   - **Геокодинг** места рождения (Nominatim) → широта/долгота.
   - **Астро-расчёт** (Swiss Ephemeris, сидерическая карта Lahiri, дома Whole Sign) → текст натальной карты сохраняется в `astro_snapshots`, заявке проставляется `astro_snapshot_id`.
   - **DeepSeek:** в промпт подставляются натальная карта, имя, запрос; модель выдаёт анализ, текст песни, название, стиль.
   - **Suno:** по тексту и стилю генерируется аудио, воркер ждёт готовности по API (поллинг).
   - Обновляет заявку: `lyrics`, `title`, `audio_url`, `status = completed`.
   - **Отправляет аудио** пользователю в Telegram (ссылкой или файлом).

Если на каком-то шаге ошибка — заявка переводится в `failed`, в `error_message` пишется причина; воркер переходит к следующему циклу.

---

## Один проход вручную (без цикла)

Чтобы обработать **одну** заявку и выйти:

```bash
cd bot && npm run worker:full
```

Удобно для отладки.

---

## Проверка

- **Админ:** в Telegram боту написать `/admin` — список заявок и статусы (`pending` / `processing` / `completed` / `failed`).
- **Логи воркера:** в терминале, где запущен `worker:start` или `worker:loop`, будут строки вида «Обрабатываю заявку …», «Натальная карта посчитана», «Отправлено пользователю …» или сообщения об ошибках.

Если заявок нет, воркер будет писать: «Нет заявок pending. Отправь заявку из Mini App — при следующем запуске воркер её обработает.»
