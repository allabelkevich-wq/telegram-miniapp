# Админка внутри приложения и отслеживание воркера

## Идея

- **Бот** — только платформа: открытие Mini App, приём заявок (web_app_data + POST /api/submit-request), уведомления пользователю и админам. Команды `/admin` и `/admin_check` можно оставить как запасной вариант или убрать.
- **Админка** — внутри приложения: админ открывает то же приложение из бота и видит отдельный блок «Админка»: список заявок и **статус воркера** (последний запуск, сколько в очереди, последняя ошибка).

## Что для этого нужно

### 1. Воркер пишет «сердцебиение» в Supabase

Чтобы отслеживать воркер из приложения, он должен куда-то писать свой статус. Вариант:

- Таблица **`worker_status`** в Supabase (одна строка, обновляется каждые N минут):
  - `updated_at` — когда воркер последний раз отчитался
  - `last_processed_id` — id последней обработанной заявки (или `null`)
  - `last_error` — текст последней ошибки (или `null`)
  - `pending_count` — сколько заявок в статусе pending (опционально)

Воркер (`worker-loop.js` / `workerGenerate.js`) после каждого тика вызывает обновление этой строки. По `updated_at` в приложении можно показывать: «Воркер работал 2 мин назад» / «Воркер не отчитывался >10 мин».

### 2. API для админа на бэкенде

Доступ только по валидному `initData` и проверка, что Telegram ID пользователя входит в `ADMIN_TELEGRAM_IDS`:

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/api/admin/me` | Тело: `initData` (или заголовок `X-Telegram-Init`). Ответ: `{ admin: true/false, userId }` — чтобы приложение показывало блок «Админка» только админу. |
| GET | `/api/admin/requests` | То же. Ответ: JSON со списком заявок (как в текущем `/admin`). |
| GET | `/api/admin/worker-status` | То же. Ответ: `{ updatedAt, lastProcessedId, lastError, pendingCount }` из таблицы `worker_status`. |

Все три маршрута: валидация `initData` → извлечение `telegram_user_id` → проверка `ADMIN_IDS` → при отсутствии прав 403.

### 3. Приложение (Mini App)

- При загрузке (или при переходе в раздел «Настройки» / «Ещё»): запрос `GET /api/admin/me` с текущим `initData` (из `Telegram.WebApp.initData`).
- Если `admin === true` — показывать пункт меню/кнопку «Админка».
- В экране «Админка»:
  - Запросы `GET /api/admin/requests` и `GET /api/admin/worker-status`.
  - Вывод списка заявок (как сейчас в боте) и блока «Воркер»:
    - последний запуск: по `updatedAt` (например: «2 мин назад»);
    - в очереди: `pendingCount`;
    - последняя ошибка: `lastError` (если есть).

Бот тогда остаётся только платформой: открытие приложения, приём заявок, отправка сообщений. Отслеживание воркера и список заявок — внутри приложения.

### 4. Таблица `worker_status` в Supabase

Минимальная схема (одна строка, id=1):

```sql
create table if not exists worker_status (
  id int primary key default 1,
  updated_at timestamptz not null default now(),
  last_processed_id uuid references track_requests(id),
  last_error text,
  pending_count int
);

-- одна строка
insert into worker_status (id, updated_at, last_error, pending_count)
values (1, now(), null, 0)
on conflict (id) do nothing;
```

Воркер раз в тик делает `update worker_status set updated_at = now(), last_processed_id = ..., last_error = ..., pending_count = ... where id = 1`.

## Итог

| Компонент | Роль |
|-----------|------|
| Бот | Платформа: кнопка «Открыть приложение», приём заявок, уведомления. По желанию оставить `/admin` и `/admin_check` как запас. |
| Воркер | Продолжает обрабатывать заявки + пишет статус в `worker_status`. |
| Backend | Уже есть `validateInitData` и `ADMIN_IDS`. Добавить GET `/api/admin/me`, `/api/admin/requests`, `/api/admin/worker-status`. |
| Mini App | По `admin/me` показывать «Админка», в ней — запросы к `admin/requests` и `admin/worker-status`, отображение заявок и статуса воркера. |

Так воркер можно отслеживать админу внутри приложения, а бот остаётся только платформой.
