# Проверка полного цикла работы

Пошаговая проверка: от открытия приложения до появления заявки в админке (и при желании — до готового трека).

---

## Автоматическая проверка (перед ручным тестом)

Один раз прогнать все проверки без ручных действий:

```bash
cd bot && npm run verify
```

Скрипт проверяет: переменные окружения (BOT_TOKEN, Supabase), доступ к Telegram Bot API (getMe), подключение к Supabase и количество записей в `track_requests`, доступность бота по адресу healthz (бот должен быть запущен). Выход 0 — всё ок, 1 — есть ошибки.

---

## Перед началом

1. **Окружение**
   ```bash
   cd bot && npm run check-env
   ```
   Должны быть: `BOT_TOKEN`, `SUPABASE_URL`, `SUPABASE_SERVICE_KEY`. Для генерации треков — `DEEPSEEK_API_KEY`, `SUNO_API_KEY`.

2. **Бот запущен**
   ```bash
   cd bot && npm start
   ```
   В логе: «Бот запущен», «Supabase: подключен», «Кнопка меню установлена: …».

3. **(Опционально) Воркер** — если проверяешь цикл до аудио:
   ```bash
   cd bot && npm run worker:start
   ```
   В логе: «Пайплайн: заявка → астро → …».

---

## Шаг 1 — Открыть приложение из Telegram

- Открыть чат с ботом в Telegram.
- Нажать кнопку меню (или «✨ Открыть приложение» после `/start`).
- Должно открыться Mini App (форма YupSoul).

**Проверка:** видна главная с кнопкой «✨ Начать», без лишней кнопки «Забота».

---

## Шаг 2 — Заполнить форму и дойти до отправки

- Нажать «✨ Начать» → форма.
- Заполнить: **имя** (минимум 2 символа), **дата рождения**, **место рождения** (выбрать из подсказок и подтвердить галочку), **время** или «Не знаю», **пол**, **язык**, **запрос** (минимум 10 символов).
- «Далее» → страница оплаты/поддержки.
- Нажать **«Отправить заявку»** на странице.

**Проверка:** внизу экрана появляется фиолетовая кнопка Telegram: **«Отправить заявку во Вселенную»**.

---

## Шаг 3 — Отправить заявку

- Нажать **нижнюю кнопку** «Отправить заявку во Вселенную».
- Приложение закроется, фокус — в чате с ботом.

**Проверка в чате:**
- «⏳ Получил заявку, сохраняю…»
- «✅ Заявка принята! Твой персональный звуковой ключ будет создан…»

Если админ указан в `ADMIN_TELEGRAM_IDS` — в личку приходит уведомление о новой заявке.

---

## Шаг 4 — Админка: заявка в БД

В чате с ботом (под аккаунтом из `ADMIN_TELEGRAM_IDS`):

- Написать **`/admin`**.

**Проверка:** в списке есть новая заявка с твоим именем, датой/местом, запросом, статусом `pending`.

Дополнительно:
- **`/admin_check`** — «Подключение к Supabase: OK. В таблице track_requests записей: N» (N > 0).

---

## Шаг 5 — (Опционально) Воркер и трек

Если воркер запущен (`npm run worker:start` или `worker:loop`):

- В логе воркера: «Обрабатываю заявку …», «Натальная карта посчитана», затем генерация и «Отправлено пользователю …».
- В чате с ботом пользователю приходит сообщение со ссылкой/файлом трека.
- В `/admin` статус заявки меняется на `completed`.

Один проход вручную (без цикла):
```bash
cd bot && npm run worker:full
```

---

## Краткая схема

| Шаг | Действие | Ожидаемый результат |
|-----|----------|----------------------|
| 1 | Открыть приложение из чата с ботом | Mini App открыт, без «Забота» |
| 2 | Заполнить форму → «Отправить заявку» | Появилась нижняя кнопка Telegram |
| 3 | Нажать нижнюю кнопку | В чате: «Заявка принята!» |
| 4 | `/admin` (от админа) | Заявка в списке, статус `pending` |
| 5 | Воркер работает | Статус → `completed`, пользователю пришёл трек |

---

## Если что-то не так

- **Заявка не уходит** — нажимать именно **нижнюю** кнопку Telegram, открывать приложение **из чата с ботом**, не из браузера.
- **В /admin пусто** — отправить заявку ещё раз из приложения, затем снова `/admin`; проверить `/admin_check`.
- **Трек не приходит** — запустить воркер, проверить `DEEPSEEK_API_KEY` и `SUNO_API_KEY` в `.env`.

Подробнее: `ЗАЯВКИ_ПРОСМОТР_И_ОБРАБОТКА.md`, `ЗАПУСК_ПОЛНОГО_ПАЙПЛАЙНА.md`.
