# Tasklist YupSoul — полный чек-лист по 5 этапам

Чеклист задач разбит по этапам: **Telegram‑бот (MVP)**, **пайплайн генерации**, **веб‑сайт**, **админка** и **реферальная система**.  
Задачи в формате GitHub‑чекбоксов.

*Источник: Desktop/## Tasklist YupSoul.txt*

---

## Этап 1 — Telegram‑бот (MVP без реальных интеграций)

- [x] **Подготовка инфраструктуры**
  - [x] Настроить проект в Supabase (БД, Auth, Storage, RLS по умолчанию).
  - [x] Создать таблицы: telegram_accounts, profiles, track_requests, track_jobs, payments, products.
  - [x] Завести продукты (products) для базовых пакетов: single_track, track_pack.

- [x] **Базовый Telegram‑бот**
  - [x] Создать бота в BotFather, получить токен.
  - [x] Инициализировать Node/TS‑проект для бота.
  - [x] Подключить Telegram‑SDK (например, grammY/telegraf) и запустить простое /start.

- [x] **Онбординг пользователя**
  - [x] Реализовать команду/меню /start с объяснением сути сервиса.
  - [x] Добавить диалог по сбору: даты рождения, времени рождения (с поддержкой «не знаю»), места рождения, пола, любимого стиля музыки.
  - [x] Сохранять/обновлять данные в telegram_accounts и profiles.

- [x] **Создание запроса на трек (без реальной генерации)**
  - [x] Реализовать команду/кнопку «Создать трек».
  - [x] Добавить выбор типа промпта: стандартный / кастомный текст.
  - [x] Сохранять запрос в track_requests в статусе pending (пока без привязки к оплате).

- [x] **Подписки и энергия (MVP, Telegram Stars)**
  - [x] Добавить учёт энергии: energy_accounts, energy_transactions.
  - [x] Обновить subscriptions для Telegram‑аккаунтов.
  - [x] Настроить продукты: подписки + пакеты энергии.
  - [x] Реализовать оплату Stars и начисление энергии/подписки.
  - [x] Резерв энергии при создании трека.
  - [x] Списание энергии только при успешной генерации.
  - [x] Команда клейма дневной энергии.

- [x] **UX подписки и оплаты (MVP)**
  - [x] Кнопка пополнения энергии в главном меню.
  - [x] Показ фич тарифа в разделе «Подписка».
  - [x] Улучшенные тексты оплаты и клейма.

- [x] **Мок‑воркер генерации**
  - [x] Поднять отдельный процесс воркера (Node + TS).
  - [x] Реализовать чтение track_jobs со статусом pending.
  - [ ] Для MVP вместо реальных API:
    - [x] «Фейковый» расчёт натальной карты (заглушка).
    - [x] «Фейковый» текст песни и название.
    - [x] «Фейковый» URL трека.
  - [x] Обновлять статусы track_requests и track_jobs и отправлять уведомление в ТГ.

- [x] **Команда «Мои треки»**
  - [x] Реализовать вывод последних track_requests с их статусами.
  - [x] Для готовых треков выводить ссылку на прослушивание (пока можно использовать фиктивные).

- [x] **Навигация и админка в боте (MVP)**
  - [x] Кнопки: «Мои песни», «Настройки профиля», «Подписка», «Рефералка».
  - [x] Команды: /menu, /profile_settings, /subscription, /referrals, /my_songs.
  - [x] Базовое админ‑меню и разделы (статистика/пользователи/треки/очередь).

---

## Этап 2 — Реальный пайплайн генерации треков

- [ ] **Астрологический движок**
  - [ ] Выбрать и подключить библиотеку для сидерической натальной карты (Placidus + Lahiri).
  - [ ] Обернуть её в отдельный модуль astroLib (Node/TS).
  - [ ] Реализовать функцию: данные рождения → подробный AstroSnapshot.
  - [ ] Сохранять результаты в astro_snapshots и привязывать к track_requests.

- [ ] **Система управления промптами**
  - [ ] Создать таблицу prompt_templates в Supabase.
  - [ ] Реализовать модуль загрузки промптов из БД (по name и is_active).
  - [ ] Реализовать функцию подстановки переменных в шаблоны промптов.
  - [ ] Создать начальные версии промптов:
    - [ ] deepseek_archetype_v1 (архетип на основе натальной карты),
    - [ ] deepseek_lyrics_v1 (текст песни),
    - [ ] deepseek_title_v1 (название трека),
    - [ ] suno_config_v1 (параметры для SUNO).

- [ ] **Интеграция с DeepSeek**
  - [ ] Настроить клиент DeepSeek с конфигом и логированием.
  - [ ] Реализовать функцию для получения архетипа (AstroSnapshot → Archetype) с использованием промпта из БД.
  - [ ] Реализовать функцию для генерации текста песни с использованием промпта из БД.
  - [ ] Реализовать функцию для генерации названия трека с использованием промпта из БД.
  - [ ] Сохранить архетип и тексты в user_archetypes и track_requests.

- [ ] **Интеграция с SUNO**
  - [ ] Настроить клиент SUNO API.
  - [ ] Реализовать формирование запроса (lyrics + style + голос).
  - [ ] Добавить функцию старта генерации и получения suno_request_id.
  - [ ] Реализовать поллинг или приём webhook‑ов статуса генерации.
  - [ ] Выбрать один трек из двух и сохранить его ID/URL в track_requests.

- [ ] **Усиление очереди и воркера**
  - [ ] Разбить пайплайн на шаги (astro, archetype, lyrics, title, suno, finalize).
  - [ ] Добавить поле step и attempt в track_jobs.
  - [ ] Реализовать ретраи с лимитом и логирование ошибок.
  - [ ] Добавить метрики/логи по времени выполнения шагов.

- [ ] **Уведомления пользователю**
  - [ ] Реализовать финальное уведомление в Telegram с названием трека и ссылкой.
  - [ ] Настроить базовые email‑уведомления (через Supabase или внешний сервис), если нужно.

---

## Этап 3 — Веб‑сайт на Vercel

- [ ] **Инициализация проекта**
  - [ ] Создать Next.js (TypeScript, App Router) проект для сайта.
  - [ ] Подключить Supabase client и Supabase Auth.

- [ ] **Авторизация и профиль**
  - [ ] Настроить вход через Google.
  - [ ] Привязать users/profiles к входящим пользователям.
  - [ ] Создать страницу профиля:
    - [ ] редактирование даты/времени/места рождения,
    - [ ] выбор пола и любимого стиля,
    - [ ] переключатель «Разрешить показывать мои треки в "Звуках Души"».

- [ ] **Создание трека с сайта**
  - [ ] Добавить страницу/секцию «Создать трек».
  - [ ] Дать выбор стандартного/кастомного промпта.
  - [ ] Реализовать создание track_requests через безопасный backend‑маршрут.
  - [ ] Подключить платежи (Lava + Hot‑Pay) на сайте.

- [ ] **История треков**
  - [ ] Страница «Мои треки»: список track_requests текущего пользователя, статусы и ссылки на прослушивание.

- [ ] **Страница «Звуки Души»**
  - [ ] Создать публичную страницу галереи.
  - [ ] Подключить данные из public_tracks (только одобренные треки).
  - [ ] Добавить плеер (HTML5 audio) и краткие описания.
  - [ ] Добавить CTA‑кнопки: «Создать свой трек», «Перейти в Telegram‑бота».

---

## Этап 4 — Админка

- [ ] **Базовый доступ**
  - [ ] Ввести роль admin/moderator (через Supabase и/или claims).
  - [ ] Закрыть админку RLS‑политиками и проверками на уровне приложения.

- [ ] **Раздел "Пользователи"**
  - [ ] Список пользователей с поиском по email, Telegram ID, имени.
  - [ ] Просмотр профиля и связанных треков.
  - [ ] Возможность пометить пользователя (tags/flags).

- [ ] **Раздел "Треки"**
  - [ ] Список track_requests с фильтрами (статус, дата, канал).
  - [ ] Просмотр деталей: архетип, текст песни, ссылка на трек.
  - [ ] Ручное изменение статуса (для отладки и поддержки).

- [ ] **Модерация "Звуков Души"**
  - [ ] Интерфейс для просмотра кандидатов в public_tracks.
  - [ ] Кнопки «Одобрить» / «Скрыть».
  - [ ] Теги для классификации (настроение, стиль, архетип).

- [ ] **Управление промптами**
  - [ ] Раздел «Промпты» в админке: список шаблонов с версиями, просмотр и редактирование, создание новой версии (копирование + редактирование), переключение is_active, валидация переменных перед сохранением.

- [ ] **Аналитика**
  - [ ] Базовая панель: количество пользователей, количество треков (созданных/готовых), конверсия в оплату и т.п.

---

## Этап 5 — Реферальная система

- [ ] **Простая одноуровневая рефералка**
  - [ ] Добавить таблицу referrals (уже описана в vision).
  - [ ] Для каждого пользователя сгенерировать реферальный код/ссылку.
  - [ ] В ТГ и на сайте: показывать персональный реферальный код, принимать реферал‑код при регистрации/первом онбординге.
  - [ ] Привязывать новых пользователей/оплаты к referrals.
  - [ ] Начислять бонусы (скидка/бесплатный трек) за успешные оплаты приглашённых.

- [ ] **Интеграция с основным UX**
  - [ ] Показать пользователю, сколько людей он привёл и какие бонусы получил.
  - [ ] Добавить отдельный раздел/команду «Рефералы» (в ТГ и на сайте).

---

## Meta‑задачи для развития

- [ ] Настроить мониторинг и логирование (логи воркера, ошибки интеграций).
- [ ] Добавить трейсинг ключевых шагов пайплайна (идентификатор запроса/трек‑ID).
- [ ] Продумать миграции данных и версионирование схемы БД.
- [ ] Подготовить базовый набор документации для разработчиков (README, диаграммы, примеры запросов).
