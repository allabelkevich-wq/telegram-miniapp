# Чек-ап алгоритма и архитектуры

## Цепочка алгоритма (соответствует docs/ALGORITHM.md)

1. **Mini App** → пользователь вводит дату/место/время/запрос → кнопка «Отправить заявку» → `sendData(payload)`.
2. **Бот** (`message:web_app_data`) → парсит payload → `saveRequest()` в Supabase. Если сохранение не удалось — отвечает ошибкой и выходит (не пишет «Заявка принята»).
3. **Астро** (в фоне от бота или в воркере): геокод места → расчёт натальной карты (astroLib) → запись в `astro_snapshots`, привязка к заявке.
4. **Воркер** (workerGenerate / runFullPipeline): одна заявка `pending` → при необходимости считает астро (runOnceWithAstro) → загружает «идеально отлаженный промпт» + карту → DeepSeek → парсинг 4 частей (анализ, стили, лирика, название) → сохранение анализа (и лирики/названия) → Suno → отправка аудио в Telegram.
5. **Расшифровка**: по команде `/get_analysis` или фразам «расшифровка» — бот отдаёт `detailed_analysis` только если `analysis_paid = true`.

## Исправленные моменты

- При неудачном сохранении заявки бот не говорит «Заявка принята», а сообщает об ошибке.
- Общая функция `onBotStart` в index.js — без дублирования кода запуска.
- Команда `get_analysis` добавлена в меню бота.
- Воркер: общая функция `runOneRow()` для runOnce и runOnceWithAstro; при отсутствии колонки `detailed_analysis` в БД сохраняются хотя бы lyrics/title, запрос не падает.

## Точки входа

| Скрипт | Назначение |
|--------|------------|
| `node healthz.js` | Render: порт + /healthz, затем подгрузка бота и API |
| `node index.js` | Локально: бот + Express на PORT |
| `node workerGenerate.js` | Одна заявка pending с уже готовым астро |
| `node runFullPipeline.js` | Одна заявка pending, при необходимости астро, затем генерация |

## Зависимости окружения

- Бот: `BOT_TOKEN`, опционально `SUPABASE_*`, `ADMIN_TELEGRAM_IDS`, `MINI_APP_URL`.
- Воркер: `BOT_TOKEN`, `SUPABASE_*`, `DEEPSEEK_API_KEY`, `SUNO_API_KEY`.

## Проверка кода (краткий аудит)

Проверены критические пути:

- **Бот**: приём `web_app_data` → проверка `requestId` после сохранения; ответ об ошибке при неудачном сохранении; `/get_analysis` — проверка колонки `detailed_analysis`, `analysis_paid`, разбивка длинного текста по лимиту Telegram (4096), защита от пустого текста.
- **Воркер**: парсинг 4 частей ответа LLM; fallback при отсутствии колонки `detailed_analysis`; обновление статуса при ошибках; передача параметров Suno из env.
- **DeepSeek**: ретрай при 500/503; безопасное чтение `res.json()`; формирование сообщений об ошибках.
- **Suno**: чтение ответа с fallback; callback URL из env.
- **POST /suno-callback**: разбор `req.body?.data?.taskId` и `req.body?.taskId`; ответ 200.

Явных багов в этих путях не найдено. Рекомендация: после настройки env и миграций один раз прогнать полный цикл (заявка из Mini App → ответ бота → воркер → аудио в чат) для уверенности.
