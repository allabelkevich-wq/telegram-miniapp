# План подготовки к полной миграции БД

Пошаговый порядок: проверка → бэкап → базовая миграция → проверка → воркер → деплой → тест → дополнительные миграции → код статусов.

---

## ВАРИАНТ «ОДНИМ ФАЙЛОМ» (рекомендуется)

### Как сделать по шагам

**Шаг 1 — Бэкап в Supabase**

1. Зайди на [supabase.com](https://supabase.com) → свой проект.
2. Слева: **Project Settings** (иконка шестерёнки внизу).
3. В меню слева: **Backups**.
4. Нажми **Create manual backup** (или **Restore** → перед миграцией лучше сделать бэкап через дашборд, если есть пункт Point in time / Backups).

**Шаг 2 — Миграция БД**

1. В том же проекте Supabase слева открой **SQL Editor**.
2. Нажми **New query**.
3. Открой в редакторе файл **`bot/RUN_IN_SUPABASE.sql`** из этого репозитория.
4. Скопируй **весь** его текст (Ctrl+A → Ctrl+C) и вставь в окно запроса в Supabase (Ctrl+V).
5. Нажми **Run** (или Ctrl+Enter).
6. Внизу должно появиться сообщение об успешном выполнении (Success). Если есть ошибка — скопируй текст ошибки и проверь, что таблица `track_requests` не конфликтует (скрипт рассчитан на повторный запуск).

**Шаг 3 — Webhook на Render**

1. Зайди на [dashboard.render.com](https://dashboard.render.com).
2. Выбери сервис с ботом (тот, что открывается по `https://telegram-miniapp-ar09.onrender.com`).
3. Слева: **Environment**.
4. В **Environment Variables** добавь или измени:
   - **Key:** `WEBHOOK_URL`
   - **Value:** `https://telegram-miniapp-ar09.onrender.com` (без слэша в конце).
5. Сохрани. Нажми **Manual Deploy** → **Deploy latest commit** (или **Clear build cache & deploy**), чтобы бот перезапустился с webhook и перестал давать 409.

**Шаг 4 — Проверка**

1. Открой Mini App в Telegram и отправь тестовую заявку.
2. Убедись, что бот принял заявку и в ответ прислал (или потом прислал) сгенерированную песню.
3. В Supabase → **Table Editor** → таблица **track_requests**: у новой строки должны заполниться поля `lyrics`, `title`, `audio_url` после генерации.

---

Кратко:
- **Бэкап:** Supabase → Project Settings → Backups → Create manual backup.
- **Миграция:** Supabase → SQL Editor → New query → вставь целиком **`bot/RUN_IN_SUPABASE.sql`** → Run.
- **Webhook:** Render → твой сервис → Environment → добавить `WEBHOOK_URL` = `https://telegram-miniapp-ar09.onrender.com` → Manual Deploy.
- После этого — тест заявки из Mini App.

Дальше в документе — пошаговый вариант с проверкой колонок, если нужен контроль по этапам.

---

## ПОДГОТОВИТЕЛЬНЫЕ ШАГИ (до миграции)

### Шаг 1: Проверьте текущее состояние БД

В Supabase → SQL Editor выполни:

```sql
-- Проверить существующие таблицы
select table_name from information_schema.tables
where table_schema = 'public' and table_name in ('track_requests', 'astro_snapshots');

-- Проверить существующие колонки в track_requests
select column_name, data_type
from information_schema.columns
where table_name = 'track_requests'
order by ordinal_position;
```

### Шаг 2: Создайте резервную копию (обязательно!)

**Вариант A — Supabase:** Project Settings → Backups → Create manual backup.

**Вариант B — экспорт в CSV (если есть доступ к psql с файловой системой):**
```sql
copy track_requests to '/tmp/track_requests_backup.csv' with csv header;
copy astro_snapshots to '/tmp/astro_snapshots_backup.csv' with csv header;
```
На Supabase через веб-интерфейс экспорт делается через Backups или через экспорт таблиц в дашборде.

---

## БАЗОВАЯ МИГРАЦИЯ

### Шаг 3: Выполните базовую миграцию

Файл в репозитории: **`bot/supabase-migration-astro-and-columns.sql`**.

Содержимое:
- Таблица `astro_snapshots` (если ещё нет).
- Колонки в `track_requests`: `astro_snapshot_id`, `language`, `lyrics`, `title`, `audio_url`, `suno_task_id`, `error_message`.

Выполни в Supabase → SQL Editor: скопируй содержимое файла и Run.

### Шаг 4: Проверка после базовой миграции

```sql
-- Проверить что колонки добавились
select column_name
from information_schema.columns
where table_name = 'track_requests'
and column_name in ('language', 'lyrics', 'title', 'audio_url', 'suno_task_id', 'error_message')
order by ordinal_position;
```

Должны вернуться все перечисленные колонки.

---

## ДЕПЛОЙ И ТЕСТ

### Шаг 5: Обновить код воркера

Код воркера уже использует поля `lyrics`, `title`, `audio_url`, `suno_task_id`, `error_message`, `status`. После миграции достаточно задеплоить текущую версию.

### Шаг 6: Перезапустить бэкенд на Render

Render Dashboard → твой сервис → Manual Deploy (при необходимости Clear build cache & deploy).

### Шаг 7: Отправить тестовую заявку

Из Mini App отправить заявку и убедиться, что бот отвечает и воркер обрабатывает.

### Шаг 8: Проверить что данные сохраняются в новые колонки

В Supabase → Table Editor → `track_requests`: у новой заявки должны заполняться `lyrics`, `title`, `audio_url` после генерации.

---

## ДОПОЛНИТЕЛЬНЫЕ МИГРАЦИИ (опционально)

После успешной проверки базового сценария можно применить:

**Файл:** **`bot/supabase-migration-generation-status.sql`**

- `generation_status` — детальный этап: pending, astro_calculated, lyrics_generated, suno_processing, completed, failed.
- `deepseek_response` — полный ответ DeepSeek для отладки.
- `request_type` — тип запроса: general, relationships, career, health, spiritual, custom.
- Индексы по `generation_status`, `telegram_user_id`, `created_at`.

Выполни в Supabase → SQL Editor. Затем можно обновить код воркера, чтобы выставлять `generation_status` на каждом этапе и при желании сохранять `deepseek_response`.

---

## ПОЛНЫЙ ЧЕК-ЛИСТ

- [ ] **ШАГ 0:** Создать резервную копию БД (обязательно!)
- [ ] **ШАГ 1:** Выполнить базовую миграцию (`supabase-migration-astro-and-columns.sql`)
- [ ] **ШАГ 2:** Проверить что колонки добавились (запрос выше)
- [ ] **ШАГ 3:** Обновить/задеплоить код воркера (если нужно)
- [ ] **ШАГ 4:** Перезапустить бэкенд на Render
- [ ] **ШАГ 5:** Отправить тестовую заявку
- [ ] **ШАГ 6:** Проверить что данные сохраняются в новые колонки
- [ ] **ШАГ 7:** При необходимости выполнить дополнительные миграции (`supabase-migration-generation-status.sql`)
- [ ] **ШАГ 8:** При необходимости обновить код для работы со статусами `generation_status` и полем `request_type`
