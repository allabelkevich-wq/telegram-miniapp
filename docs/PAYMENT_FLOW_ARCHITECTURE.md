# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–∫–Ω–∞ –æ–ø–ª–∞—Ç—ã YupSoul

## –ü—Ä–∏–Ω—Ü–∏–ø –º–∏–Ω–∏–º–∞–ª–∏–∑–º–∞

**–ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ:** –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ —Ä–µ–∞–ª—å–Ω–æ –Ω—É–∂–Ω–∞ –æ–ø–ª–∞—Ç–∞. –í–æ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö ‚Äî —Å—Ä–∞–∑—É –Ω–∞ —ç–∫—Ä–∞–Ω "–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞".

---

## –°—Ü–µ–Ω–∞—Ä–∏–∏ (–æ—Ç –ø—Ä–æ—Å—Ç–æ–≥–æ –∫ —Å–ª–æ–∂–Ω–æ–º—É)

### 1Ô∏è‚É£ –ü–µ—Ä–≤—ã–π —Ä–∞–∑ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ (trial)

**–£—Å–ª–æ–≤–∏–µ:** `freeTrialAvailable === true` (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â—ë –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `first_song_gift`)

**–ü–æ—Ç–æ–∫:**
```
–§–æ—Ä–º–∞ ‚Üí –ö–Ω–æ–ø–∫–∞ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" ‚Üí POST /api/submit-request
  ‚Üì
–ë—ç–∫–µ–Ω–¥: resolveAccessForRequest() ‚Üí { allowed: true, source: "trial" }
  ‚Üì
–ë—ç–∫–µ–Ω–¥: consumeTrial("first_song_gift") ‚Üí ok: true
  ‚Üì
–ë—ç–∫–µ–Ω–¥: payment_provider = "gift", payment_status = "gift_used"
  ‚Üì
–ë—ç–∫–µ–Ω–¥: –∑–∞–ø—É—Å–∫ generateSoundKey() –≤ —Ñ–æ–Ω–µ
  ‚Üì
–§—Ä–æ–Ω—Ç: response.ok && !response.payment_required
  ‚Üì
–§—Ä–æ–Ω—Ç: goToPage('loadingPage') ‚Üí "‚ú® –ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞! –ü–µ—Å–Ω—è –ø—Ä–∏–¥—ë—Ç –≤ –±–æ—Ç"
  ‚Üì
4 —Å–µ–∫—É–Ω–¥—ã ‚Üí goToPage('successPage')
```

**–ß—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:**
- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ —Å —Ç–µ–∫—Å—Ç–æ–º: "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ–∑–¥–∞—é —É–Ω–∏–∫–∞–ª—å–Ω—É—é –ø–µ—Å–Ω—é. üéµ –ì–æ—Ç–æ–≤—ã–π –∫–ª—é—á –ø—Ä–∏–¥—ë—Ç –≤ –±–æ—Ç ‚Äî –º—ã —Å–∞–º–∏ –Ω–∞–ø–∏—à–µ–º. –ú–æ–∂–µ—à—å –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ."
- –ß–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã ‚Üí —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—Ö–∞

**–û–∫–Ω–æ –æ–ø–ª–∞—Ç—ã:** –ù–ï –ü–û–ö–ê–ó–´–í–ê–ï–¢–°–Ø

---

### 2Ô∏è‚É£ –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ 100% —Å–∫–∏–¥–∫—É (–±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è)

**–£—Å–ª–æ–≤–∏–µ:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª –ø—Ä–æ–º–æ–∫–æ–¥ —Ç–∏–ø–∞ `free_generation` –∏–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥ –¥–∞—ë—Ç `amount_after = 0`

**–ü–æ—Ç–æ–∫:**
```
–§–æ—Ä–º–∞ ‚Üí –ö–Ω–æ–ø–∫–∞ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" ‚Üí POST /api/submit-request
  ‚Üì
–ë—ç–∫–µ–Ω–¥: resolveAccessForRequest() ‚Üí { allowed: false, source: "payment_required" }
  ‚Üì
–ë—ç–∫–µ–Ω–¥: payment_status = "requires_payment", generation_status = "pending_payment"
  ‚Üì
–§—Ä–æ–Ω—Ç: response.status === 402 && response.payment_required
  ‚Üì
–§—Ä–æ–Ω—Ç: showPaymentOverlay() ‚Äî –û–¢–ö–†–´–í–ê–ï–¢–°–Ø –û–ö–ù–û –û–ü–õ–ê–¢–´
  ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ø—Ä–æ–º–æ–∫–æ–¥ ‚Üí –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"
  ‚Üì
POST /api/promos/validate ‚Üí { valid: true, amount_after: 0 }
  ‚Üì
–§—Ä–æ–Ω—Ç: activePromo = { code, amount_after: 0 }
  ‚Üì
–ö–Ω–æ–ø–∫–∞ "–û–ø–ª–∞—Ç–∏—Ç—å" –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ "üéÅ –ü–æ–ª—É—á–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ" (–∑–µ–ª—ë–Ω–∞—è)
  ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "üéÅ –ü–æ–ª—É—á–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ"
  ‚Üì
POST /api/payments/hot/create —Å promo_code
  ‚Üì
–ë—ç–∫–µ–Ω–¥: finalAmount = 0 ‚Üí grantPurchaseBySku(), redeemPromoUsage()
  ‚Üì
–ë—ç–∫–µ–Ω–¥: payment_provider = "promo", payment_status = "paid", payment_amount = 0
  ‚Üì
–ë—ç–∫–µ–Ω–¥: –∑–∞–ø—É—Å–∫ generateSoundKey() –≤ —Ñ–æ–Ω–µ
  ‚Üì
–ë—ç–∫–µ–Ω–¥: return { success: true, free_applied: true, provider: "promo", amount: 0 }
  ‚Üì
–§—Ä–æ–Ω—Ç: if (hotJson.free_applied || (hotJson.provider === 'promo' && amount === 0))
  ‚Üì
–§—Ä–æ–Ω—Ç: hidePaymentOverlay() ‚Üí goToPage('loadingPage')
  ‚Üì
–≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ —Å —Ç–µ–∫—Å—Ç–æ–º: "–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω! üéÅ –¢–≤–æ—è –ø–µ—Å–Ω—è —Å–æ–∑–¥–∞—ë—Ç—Å—è –∏ —Å–∫–æ—Ä–æ –ø—Ä–∏–¥—ë—Ç –≤ –±–æ—Ç."
  ‚Üì
4 —Å–µ–∫—É–Ω–¥—ã ‚Üí goToPage('successPage')
```

**–ß—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:**
- –û–∫–Ω–æ –æ–ø–ª–∞—Ç—ã (—Ç.–∫. trial —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω)
- –í–≤–æ–¥–∏—Ç –ø—Ä–æ–º–æ–∫–æ–¥ ‚Üí –∫–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∑–µ–ª—ë–Ω–æ–π "üéÅ –ü–æ–ª—É—á–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ"
- –ù–∞–∂–∏–º–∞–µ—Ç ‚Üí –æ–∫–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è ‚Üí —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –ø—Ä–æ–º–æ–∫–æ–¥–∞
- –ß–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã ‚Üí —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—Ö–∞

**–û–∫–Ω–æ –æ–ø–ª–∞—Ç—ã:** –ü–û–ö–ê–ó–´–í–ê–ï–¢–°–Ø, –Ω–æ —Å—Ä–∞–∑—É –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞

---

### 3Ô∏è‚É£ –í—Ç–æ—Ä–æ–π —Ä–∞–∑ –ë–ï–ó –ø—Ä–æ–º–æ–∫–æ–¥–∞ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞)

**–£—Å–ª–æ–≤–∏–µ:** `freeTrialAvailable === false`, –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –≤–≤–µ–¥—ë–Ω –∏–ª–∏ –Ω–µ –¥–∞—ë—Ç 100% —Å–∫–∏–¥–∫—É

**–ü–æ—Ç–æ–∫:**
```
–§–æ—Ä–º–∞ ‚Üí –ö–Ω–æ–ø–∫–∞ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" ‚Üí POST /api/submit-request
  ‚Üì
–ë—ç–∫–µ–Ω–¥: resolveAccessForRequest() ‚Üí { allowed: false, source: "payment_required" }
  ‚Üì
–ë—ç–∫–µ–Ω–¥: payment_status = "requires_payment", generation_status = "pending_payment"
  ‚Üì
–§—Ä–æ–Ω—Ç: response.status === 402 && response.payment_required
  ‚Üì
–§—Ä–æ–Ω—Ç: showPaymentOverlay() ‚Äî –û–¢–ö–†–´–í–ê–ï–¢–°–Ø –û–ö–ù–û –û–ü–õ–ê–¢–´
  ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ HOT Pay"
  ‚Üì
POST /api/payments/hot/create (–±–µ–∑ promo_code)
  ‚Üì
–ë—ç–∫–µ–Ω–¥: finalAmount = price.price (–Ω–∞–ø—Ä–∏–º–µ—Ä 5.99 USDT)
  ‚Üì
–ë—ç–∫–µ–Ω–¥: buildHotCheckoutUrl() ‚Üí checkout_url
  ‚Üì
–ë—ç–∫–µ–Ω–¥: return { success: true, checkout_url, order_id, amount }
  ‚Üì
–§—Ä–æ–Ω—Ç: if (hotJson.checkout_url) ‚Üí tg.openLink(checkout_url)
  ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ HOT Pay ‚Üí –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
  ‚Üì
HOT webhook ‚Üí POST /api/payments/hot/webhook
  ‚Üì
–ë—ç–∫–µ–Ω–¥: payment_status = "paid", generation_status = "pending"
  ‚Üì
–ë—ç–∫–µ–Ω–¥: –∑–∞–ø—É—Å–∫ generateSoundKey() –≤ —Ñ–æ–Ω–µ
  ‚Üì
–ë—ç–∫–µ–Ω–¥: bot.api.sendMessage() ‚Üí —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ Mini App ‚Üí –Ω–∞–∂–∏–º–∞–µ—Ç "‚úÖ –Ø —É–∂–µ –æ–ø–ª–∞—Ç–∏–ª"
  ‚Üì
GET /api/payments/hot/status (5 –ø–æ–ø—ã—Ç–æ–∫ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 1.5 —Å–µ–∫)
  ‚Üì
–ï—Å–ª–∏ payment_status === "paid":
  ‚Üì
POST /api/payments/hot/confirm
  ‚Üì
–§—Ä–æ–Ω—Ç: hidePaymentOverlay() ‚Üí goToPage('loadingPage')
  ‚Üì
–≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏: "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ..."
  ‚Üì
1.8 —Å–µ–∫—É–Ω–¥—ã ‚Üí goToPage('successPage')
```

**–ß—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:**
- –û–∫–Ω–æ –æ–ø–ª–∞—Ç—ã —Å —Ü–µ–Ω–æ–π (5.99 USDT)
- –ù–∞–∂–∏–º–∞–µ—Ç "–û–ø–ª–∞—Ç–∏—Ç—å" ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –≤ HOT Pay
- –û–ø–ª–∞—á–∏–≤–∞–µ—Ç ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è ‚Üí –Ω–∞–∂–∏–º–∞–µ—Ç "–Ø —É–∂–µ –æ–ø–ª–∞—Ç–∏–ª"
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ ‚Üí —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ ‚Üí —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—Ö–∞

**–û–∫–Ω–æ –æ–ø–ª–∞—Ç—ã:** –ü–û–ö–ê–ó–´–í–ê–ï–¢–°–Ø –∏ –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã

---

### 4Ô∏è‚É£ –í—Ç–æ—Ä–æ–π —Ä–∞–∑ –° –ø—Ä–æ–º–æ–∫–æ–¥–æ–º (—á–∞—Å—Ç–∏—á–Ω–∞—è —Å–∫–∏–¥–∫–∞)

**–£—Å–ª–æ–≤–∏–µ:** –ü—Ä–æ–º–æ–∫–æ–¥ –¥–∞—ë—Ç —Å–∫–∏–¥–∫—É, –Ω–æ `amount_after > 0` (–Ω–∞–ø—Ä–∏–º–µ—Ä, 20% —Å–∫–∏–¥–∫–∞: 5.99 ‚Üí 4.79)

**–ü–æ—Ç–æ–∫:**
```
–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å—Ü–µ–Ω–∞—Ä–∏—é 3Ô∏è‚É£, –Ω–æ:
  ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ø—Ä–æ–º–æ–∫–æ–¥ ‚Üí –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"
  ‚Üì
POST /api/promos/validate ‚Üí { valid: true, amount_after: 4.79 }
  ‚Üì
–§—Ä–æ–Ω—Ç: activePromo = { code, amount_after: 4.79, discount_amount: 1.20 }
  ‚Üì
–¶–µ–Ω–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è: "5.99 USDT" ‚Üí "4.79 USDT" + –ø–æ–¥—Å–∫–∞–∑–∫–∞ "–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω: —Å–∫–∏–¥–∫–∞ 1.20 USDT"
  ‚Üì
–ö–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–π "üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ HOT Pay"
  ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç ‚Üí POST /api/payments/hot/create —Å promo_code
  ‚Üì
–ë—ç–∫–µ–Ω–¥: finalAmount = 4.79 ‚Üí buildHotCheckoutUrl(amount: 4.79)
  ‚Üì
–î–∞–ª–µ–µ –∫–∞–∫ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏ 3Ô∏è‚É£
```

**–ß—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:**
- –û–∫–Ω–æ –æ–ø–ª–∞—Ç—ã —Å —Ü–µ–Ω–æ–π 5.99 USDT
- –í–≤–æ–¥–∏—Ç –ø—Ä–æ–º–æ–∫–æ–¥ ‚Üí —Ü–µ–Ω–∞ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ 4.79 USDT —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π –æ —Å–∫–∏–¥–∫–µ
- –ù–∞–∂–∏–º–∞–µ—Ç "–û–ø–ª–∞—Ç–∏—Ç—å" ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –≤ HOT Pay —Å –Ω–æ–≤–æ–π —Ü–µ–Ω–æ–π
- –û–ø–ª–∞—á–∏–≤–∞–µ—Ç ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç ‚Üí —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ ‚Üí —É—Å–ø–µ—Ö

**–û–∫–Ω–æ –æ–ø–ª–∞—Ç—ã:** –ü–û–ö–ê–ó–´–í–ê–ï–¢–°–Ø –∏ –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã

---

## –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –ë—ç–∫–µ–Ω–¥ (`bot/index.js`)

#### 1. `resolveAccessForRequest({ telegramUserId, mode })`
–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω–∞ –ª–∏ –æ–ø–ª–∞—Ç–∞:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `isTrialAvailable("first_song_gift")` ‚Üí –µ—Å–ª–∏ `true`, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{ allowed: true, source: "trial" }`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É ‚Üí –µ—Å–ª–∏ –µ—Å—Ç—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{ allowed: true, source: "subscription" }`
- –ò–Ω–∞—á–µ ‚Üí `{ allowed: false, source: "payment_required", sku }`

#### 2. `consumeTrial(telegramUserId, "first_song_gift")`
–ü–æ–º–µ—á–∞–µ—Ç trial –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π:
- –í—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ `user_trials` (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π —á–µ—Ä–µ–∑ unique constraint)
- –ï—Å–ª–∏ duplicate key ‚Üí `{ ok: false, reason: "already_consumed" }`
- –ï—Å–ª–∏ —É—Å–ø–µ—Ö ‚Üí `{ ok: true }`

#### 3. `POST /api/submit-request`
–ì–ª–∞–≤–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –ø—Ä–∏—ë–º–∞ –∑–∞—è–≤–æ–∫:
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞—è–≤–∫—É ‚Üí `saveRequest()`
- –í—ã–∑—ã–≤–∞–µ—Ç `resolveAccessForRequest()`
- –ï—Å–ª–∏ `allowed === false` ‚Üí —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `generation_status = "pending_payment"`, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `402 Payment Required`
- –ï—Å–ª–∏ `allowed === true` –∏ `source === "trial"` ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `consumeTrial()`
  - –ï—Å–ª–∏ `consumeTrial` –≤–µ—Ä–Ω—É–ª `ok: false` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `402 Payment Required`
  - –ï—Å–ª–∏ `ok: true` ‚Üí —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `payment_provider = "gift"`, –∑–∞–ø—É—Å–∫–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `200 OK`

#### 4. `POST /api/payments/hot/create`
–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –∏–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞:
- –ï—Å–ª–∏ `promoCode` –∏ `finalAmount === 0` ‚Üí `grantPurchaseBySku()`, `redeemPromoUsage()`, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `payment_status = "paid"`, –∑–∞–ø—É—Å–∫–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{ success: true, free_applied: true }`
- –ò–Ω–∞—á–µ ‚Üí `buildHotCheckoutUrl()`, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{ success: true, checkout_url }`

#### 5. `POST /api/payments/hot/webhook`
–û–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç HOT Pay:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å `X-HOT-Signature`
- –ï—Å–ª–∏ `payment_status === "paid"` ‚Üí `grantPurchaseBySku()`, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `payment_status = "paid"`, –∑–∞–ø—É—Å–∫–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–æ—Ç

### –§—Ä–æ–Ω—Ç–µ–Ω–¥ (`public/index.html`)

#### –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
```javascript
var freeTrialAvailable = true;        // –î–æ—Å—Ç—É–ø–µ–Ω –ª–∏ trial (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∏–∑ /api/pricing/catalog)
var activePromo = null;               // –¢–µ–∫—É—â–∏–π –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ { code, amount_after, discount_amount }
var pendingPaymentRequestId = null;   // UUID –∑–∞—è–≤–∫–∏, –æ–∂–∏–¥–∞—é—â–µ–π –æ–ø–ª–∞—Ç—ã
var pendingPaymentSku = null;         // SKU –¥–ª—è –æ–ø–ª–∞—Ç—ã (single_song, couple_song, transit_energy_song)
```

#### –§—É–Ω–∫—Ü–∏–∏

**`showPaymentOverlay()`**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç `#paymentOverlay` (`position: fixed; z-index: 9999`)
- –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∏ –ø–æ–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤, –µ—Å–ª–∏ `freeTrialAvailable === true`

**`hidePaymentOverlay()`**
- –°–∫—Ä—ã–≤–∞–µ—Ç `#paymentOverlay`
- –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç `activePromo = null`, –æ—á–∏—â–∞–µ—Ç –ø–æ–ª–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–û–ø–ª–∞—Ç–∏—Ç—å" –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**`updatePaymentUiFromCatalog()`**
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Ü–µ–Ω—É –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤ –æ–∫–Ω–µ –æ–ø–ª–∞—Ç—ã
- –ï—Å–ª–∏ `activePromo && amount_after === 0` ‚Üí –∫–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∑–µ–ª—ë–Ω–æ–π "üéÅ –ü–æ–ª—É—á–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ"
- –ò–Ω–∞—á–µ ‚Üí —Ñ–∏–æ–ª–µ—Ç–æ–≤–∞—è "üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ HOT Pay"

**`applyPromoCode()`** (–∫–Ω–æ–ø–∫–∞ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥")
- `POST /api/promos/validate` —Å `{ code, sku, initData }`
- –ï—Å–ª–∏ `valid: true` ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `activePromo`, –≤—ã–∑—ã–≤–∞–µ—Ç `updatePaymentUiFromCatalog()`
- –ï—Å–ª–∏ `valid: false` ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É —á–µ—Ä–µ–∑ `setPaymentStatus()`

**–ö–Ω–æ–ø–∫–∞ "–û–ø–ª–∞—Ç–∏—Ç—å" / "üéÅ –ü–æ–ª—É—á–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ"**
```javascript
payBtn.addEventListener('click', async function() {
  // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ pendingPaymentRequestId
  // 2. POST /api/payments/hot/create —Å { request_id, sku, promo_code }
  // 3. –ï—Å–ª–∏ free_applied || (provider === 'promo' && amount === 0):
  //      hidePaymentOverlay() ‚Üí goToPage('loadingPage') ‚Üí successPage
  // 4. –ò–Ω–∞—á–µ –µ—Å–ª–∏ checkout_url:
  //      tg.openLink(checkout_url) ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É "–Ø —É–∂–µ –æ–ø–ª–∞—Ç–∏–ª"
});
```

**–ö–Ω–æ–ø–∫–∞ "‚úÖ –Ø —É–∂–µ –æ–ø–ª–∞—Ç–∏–ª"**
- –î–µ–ª–∞–µ—Ç 5 –ø–æ–ø—ã—Ç–æ–∫ `GET /api/payments/hot/status` —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 1.5 —Å–µ–∫
- –ï—Å–ª–∏ `payment_status === "paid"` ‚Üí `POST /api/payments/hot/confirm` ‚Üí `hidePaymentOverlay()` ‚Üí `loadingPage` ‚Üí `successPage`

---

## –ß–∞—Å—Ç—ã–µ –±–∞–≥–∏ –∏ –∫–∞–∫ –∏—Ö –∏–∑–±–µ–∂–∞—Ç—å

### ‚ùå –ë–∞–≥ 1: "–ü—É—Å—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ—Å–ª–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –Ω–∞ 100% —Å–∫–∏–¥–∫—É"
**–ü—Ä–∏—á–∏–Ω–∞:** –§—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª `hotJson.provider === 'promo' && amount === 0`, —Ç–æ–ª—å–∫–æ `free_applied`

**–†–µ—à–µ–Ω–∏–µ:**
```javascript
if (hotJson.free_applied || (hotJson.success && hotJson.provider === 'promo' && Number(hotJson.amount) === 0)) {
  hidePaymentOverlay();
  goToPage('loadingPage');
  // ...
}
```

### ‚ùå –ë–∞–≥ 2: "–ü–µ—Ä–≤—ã–π —Ä–∞–∑ —Ç—Ä–µ–±—É–µ—Ç –æ–ø–ª–∞—Ç—É (trial –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)"
**–ü—Ä–∏—á–∏–Ω–∞:** `consumeTrial` –≤—ã–∑—ã–≤–∞–ª—Å—è –¥–≤–∞–∂–¥—ã (–≤ `resolveAccessForRequest` –∏ –≤ `submit-request`), —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ race condition

**–†–µ—à–µ–Ω–∏–µ:** `consumeTrial` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –≤ `POST /api/submit-request` –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ `resolveAccessForRequest`

### ‚ùå –ë–∞–≥ 3: "–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω, –Ω–æ –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è"
**–ü—Ä–∏—á–∏–Ω–∞:** –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∂–¥–∞–ª —Ç–æ–ª—å–∫–æ `free_applied`, –Ω–æ –±—ç–∫–µ–Ω–¥ –≤–æ–∑–≤—Ä–∞—â–∞–ª `{ success: true, provider: "promo", amount: 0 }`

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–æ–∏—Ö —É—Å–ª–æ–≤–∏–π (—Å–º. –ë–∞–≥ 1)

### ‚ùå –ë–∞–≥ 4: "–ù–µ–ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏"
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Ç —á—ë—Ç–∫–æ–≥–æ feedback –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ

**–†–µ—à–µ–Ω–∏–µ:**
- Trial ‚Üí —Å—Ä–∞–∑—É `loadingPage` —Å —Ç–µ–∫—Å—Ç–æ–º "–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞, –ø–µ—Å–Ω—è –ø—Ä–∏–¥—ë—Ç –≤ –±–æ—Ç"
- –ü—Ä–æ–º–æ–∫–æ–¥ 100% ‚Üí `loadingPage` —Å —Ç–µ–∫—Å—Ç–æ–º "–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω! üéÅ"
- –û–ø–ª–∞—Ç–∞ ‚Üí –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã —Å —á—ë—Ç–∫–∏–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ –∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–µ—Ä–≤—ã–π —Ä–∞–∑ (trial)
1. –û—á–∏—Å—Ç–∏—Ç—å `user_trials` –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –û—Ç–∫—Ä—ã—Ç—å Mini App
3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É ‚Üí "–û—Ç–ø—Ä–∞–≤–∏—Ç—å"
4. **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –°—Ä–∞–∑—É `loadingPage` ‚Üí `successPage` (–±–µ–∑ –æ–∫–Ω–∞ –æ–ø–ª–∞—Ç—ã)
5. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î:** `user_trials` —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø–∏—Å—å —Å `trial_key = "first_song_gift"`

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ 100% —Å–∫–∏–¥–∫—É
1. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ trial —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω
2. –û—Ç–∫—Ä—ã—Ç—å Mini App
3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É ‚Üí "–û—Ç–ø—Ä–∞–≤–∏—Ç—å"
4. **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –û–∫–Ω–æ –æ–ø–ª–∞—Ç—ã
5. –í–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä `FREE100`) ‚Üí "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"
6. **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –ö–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∑–µ–ª—ë–Ω–æ–π "üéÅ –ü–æ–ª—É—á–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ"
7. –ù–∞–∂–∞—Ç—å ‚Üí **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –û–∫–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è ‚Üí `loadingPage` —Å —Ç–µ–∫—Å—Ç–æ–º –ø—Ä–æ –ø—Ä–æ–º–æ–∫–æ–¥ ‚Üí `successPage`
8. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î:** `track_requests.payment_provider = "promo"`, `payment_status = "paid"`, `payment_amount = 0`

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –û–ø–ª–∞—Ç–∞ HOT Pay
1. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ trial –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω, –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –≤–≤–µ–¥—ë–Ω
2. –û—Ç–∫—Ä—ã—Ç—å Mini App
3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É ‚Üí "–û—Ç–ø—Ä–∞–≤–∏—Ç—å"
4. **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –û–∫–Ω–æ –æ–ø–ª–∞—Ç—ã —Å —Ü–µ–Ω–æ–π (5.99 USDT)
5. –ù–∞–∂–∞—Ç—å "–û–ø–ª–∞—Ç–∏—Ç—å" ‚Üí **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –ü–µ—Ä–µ—Ö–æ–¥ –≤ HOT Pay
6. –û–ø–ª–∞—Ç–∏—Ç—å ‚Üí –í–µ—Ä–Ω—É—Ç—å—Å—è ‚Üí "–Ø —É–∂–µ –æ–ø–ª–∞—Ç–∏–ª"
7. **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ ‚Üí `loadingPage` ‚Üí `successPage`
8. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î:** `track_requests.payment_provider = "hot"`, `payment_status = "paid"`, `payment_amount = 5.99`

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ —á–∞—Å—Ç–∏—á–Ω—É—é —Å–∫–∏–¥–∫—É
1. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ trial –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω
2. –û—Ç–∫—Ä—ã—Ç—å Mini App
3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É ‚Üí "–û—Ç–ø—Ä–∞–≤–∏—Ç—å"
4. **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –û–∫–Ω–æ –æ–ø–ª–∞—Ç—ã —Å —Ü–µ–Ω–æ–π (5.99 USDT)
5. –í–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä `DISCOUNT20`) ‚Üí "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"
6. **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –¶–µ–Ω–∞ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ 4.79 USDT, –ø–æ–¥—Å–∫–∞–∑–∫–∞ "–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω: —Å–∫–∏–¥–∫–∞ 1.20 USDT"
7. –ù–∞–∂–∞—Ç—å "–û–ø–ª–∞—Ç–∏—Ç—å" ‚Üí **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –ü–µ—Ä–µ—Ö–æ–¥ –≤ HOT Pay —Å —Ü–µ–Ω–æ–π 4.79 USDT
8. –û–ø–ª–∞—Ç–∏—Ç—å ‚Üí –í–µ—Ä–Ω—É—Ç—å—Å—è ‚Üí "–Ø —É–∂–µ –æ–ø–ª–∞—Ç–∏–ª"
9. **–û–∂–∏–¥–∞–µ—Ç—Å—è:** `loadingPage` ‚Üí `successPage`
10. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î:** `track_requests.promo_code = "DISCOUNT20"`, `payment_amount = 4.79`, `promo_discount_amount = 1.20`

---

## –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ö–µ–º–∞ (–º–∏–Ω–∏–º–∞–ª–∏–∑–º)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É –∏ –Ω–∞–∂–∏–º–∞–µ—Ç "–û—Ç–ø—Ä–∞–≤–∏—Ç—å"        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ POST /api/submit-request‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ resolveAccessForRequest()      ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                  ‚îÇ
        ‚ñº                  ‚ñº
  allowed: true      allowed: false
  source: "trial"    source: "payment_required"
        ‚îÇ                  ‚îÇ
        ‚ñº                  ‚ñº
  consumeTrial()     402 Payment Required
        ‚îÇ                  ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚ñº
   ‚îÇ          ‚îÇ      showPaymentOverlay()
   ‚ñº          ‚ñº            ‚îÇ
ok: true   ok: false       ‚îÇ
   ‚îÇ          ‚îÇ            ‚îÇ
   ‚îÇ          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
   ‚îÇ                       ‚îÇ
   ‚ñº                       ‚ñº
payment_provider="gift"  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã
payment_status="gift_used"‚îÇ
   ‚îÇ                       ‚îÇ
   ‚ñº                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
generateSoundKey()    ‚îÇ          ‚îÇ
   ‚îÇ             –ü—Ä–æ–º–æ–∫–æ–¥?   –ù–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥–∞
   ‚ñº                  ‚îÇ          ‚îÇ
200 OK                ‚ñº          ‚ñº
   ‚îÇ           applyPromoCode() "–û–ø–ª–∞—Ç–∏—Ç—å"
   ‚îÇ                  ‚îÇ          ‚îÇ
   ‚ñº             ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚ñº
goToPage('loadingPage')     POST /api/payments/hot/create
   ‚îÇ           amount_after?     ‚îÇ
   ‚îÇ           ‚îÇ         ‚îÇ       ‚îÇ
   ‚ñº           ‚ñº         ‚ñº       ‚ñº
4 —Å–µ–∫      = 0        > 0    checkout_url
   ‚îÇ           ‚îÇ         ‚îÇ       ‚îÇ
   ‚ñº           ‚ñº         ‚îÇ       ‚ñº
successPage  free_applied‚îÇ  tg.openLink()
                ‚îÇ         ‚îÇ       ‚îÇ
                ‚ñº         ‚îÇ       ‚ñº
          hidePaymentOverlay() "–Ø —É–∂–µ –æ–ø–ª–∞—Ç–∏–ª"
                ‚îÇ         ‚îÇ       ‚îÇ
                ‚ñº         ‚îÇ       ‚ñº
          loadingPage     ‚îÇ  GET /api/payments/hot/status
                ‚îÇ         ‚îÇ       ‚îÇ
                ‚ñº         ‚îÇ       ‚ñº
            successPage   ‚îÇ  if paid: POST /confirm
                          ‚îÇ       ‚îÇ
                          ‚ñº       ‚ñº
                    tg.openLink() hidePaymentOverlay()
                          ‚îÇ       ‚îÇ
                          ‚ñº       ‚ñº
                    "–Ø —É–∂–µ –æ–ø–ª–∞—Ç–∏–ª" loadingPage
                          ‚îÇ       ‚îÇ
                          ‚ñº       ‚ñº
                    (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ)  successPage
```

---

## –í—ã–≤–æ–¥—ã

1. **–ú–∏–Ω–∏–º–∞–ª–∏–∑–º:** –û–∫–Ω–æ –æ–ø–ª–∞—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ —Ä–µ–∞–ª—å–Ω–æ –Ω—É–∂–Ω–∞ –æ–ø–ª–∞—Ç–∞
2. **–ü—Ä–æ–º–æ–∫–æ–¥—ã –Ω–∞ 100%:** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è ‚Üí —Å—Ä–∞–∑—É `loadingPage`
3. **Trial:** –ü–µ—Ä–≤—ã–π —Ä–∞–∑ ‚Üí —Å—Ä–∞–∑—É `loadingPage` –±–µ–∑ –æ–∫–Ω–∞ –æ–ø–ª–∞—Ç—ã
4. **–ß—ë—Ç–∫–∏–π feedback:** –ù–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø–æ–Ω—è—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å
5. **–ó–∞—â–∏—Ç–∞ –æ—Ç –±–∞–≥–æ–≤:** `consumeTrial` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑, –ø—Ä–æ–≤–µ—Ä–∫–∞ `free_applied` –∏ `amount === 0`

---

**–î–∞—Ç–∞:** 2026-02-18  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–ê–≤—Ç–æ—Ä:** AI Assistant + User feedback
