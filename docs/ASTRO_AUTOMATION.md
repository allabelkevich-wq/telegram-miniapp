# Требования к расчёту натальных карт и план автоматизации

Документ описывает **входные данные**, **систему расчётов** и **автоматизацию пайплайна** от заявки до отправки аудио пользователю.

---

## 1. Требования к системе расчётов

### 1.1 Входные данные (уже есть в заявке)

| Поле | Источник | Обязательность |
|------|----------|----------------|
| Дата рождения | `track_requests.birthdate` | да |
| Время рождения | `track_requests.birthtime` или «не знаю» | опционально |
| Место рождения | `track_requests.birthplace` (текст: «Город, страна») | да |
| Имя | `track_requests.name` | для персонализации |
| Запрос пользователя | `track_requests.request` | для фокуса песни |

Для расчёта карты нужны:
- **Дата и время в UTC** (или локальное время + часовой пояс места рождения).
- **Широта и долгота** места рождения (геокодирование из текста «Город, страна»).

Если время неизвестно — используют **солнечную карту** (полдень по местному времени, 12:00) или условное время; в промпте для нейросети можно явно указать «время рождения неизвестно, интерпретация по знакам и домам с осторожностью».

### 1.2 Системы (из чек-листа)

- **Зодиак:** сидерический (Lahiri ayanamsa).
- **Дома:** Placidus.
- **Эфемериды:** точные (например, Swiss Ephemeris — стандарт для натальной астрологии).

### 1.3 Выход — AstroSnapshot (что должно попадать в промпты)

Структурированное описание карты для подстановки в промпты DeepSeek и в шаблоны:

- **Позиции планет:** знак, градус, дом (Солнце в Овне, 15°, 10-й дом; Луна в Раке, 7-й дом; и т.д.).
- **Куспиды домов:** знак и градус (1-й дом, 2-й дом, … 12-й дом).
- **Аспекты:** основные (соединение, оппозиция, трин, квадрат, секстиль) между планетами.
- **Ретроградности:** какие планеты ретроградны на момент рождения.

Формат может быть текстовым (одна длинная строка или абзац) или JSON; главное — единый формат для подстановки в `prompt_templates` как переменная `{{astro_snapshot}}`.

---

## 2. Выбор библиотеки для расчёта

| Вариант | Плюсы | Минусы |
|---------|--------|--------|
| **Swiss Ephemeris (swisseph)** | Точность, поддержка сидерики (Lahiri), Placidus, аспекты, ретроградность. Стандарт индустрии. | Нужна сборка нативного модуля; при деплое — бинарники под ОС. |
| **astrologyjs** | Чистый JS, проще деплой. | Нужно проверить наличие сидерики и Placidus в коде. |
| **Внешний API** (AstroSeek, AstroAPI и т.п.) | Не нужна своя математика. | Зависимость от сервиса, лимиты, стоимость, приватность данных. |

**Рекомендация:** использовать **swisseph** (npm: `swisseph`) в отдельном модуле `astroLib`:

- Расчёт позиций планет в сидерическом зодиаке (Lahiri).
- Расчёт домов Placidus.
- Вычисление основных аспектов.
- Обёртка: `getAstroSnapshot({ date, time, latitude, longitude, sidereal: true })` → объект/текст AstroSnapshot.

Геокодирование (место рождения → lat, lon, timezone) — отдельный шаг: бесплатный API (Nominatim / OpenStreetMap) или сервис вроде Google Geocoding (платно). При отсутствии времени рождения — подставлять 12:00 в локальном времени места или явно помечать в снапшоте «время неизвестно».

---

## 3. Автоматизация пайплайна

Цепочка от заявки до выдачи аудио:

```
Заявка (track_requests) 
  → геокодинг места рождения 
  → расчёт AstroSnapshot (astroLib) 
  → сохранение в astro_snapshots + привязка к track_request_id
  → загрузка промптов из БД (prompt_templates)
  → DeepSeek: архетип (AstroSnapshot + запрос) 
  → DeepSeek: текст песни (архетип + запрос + имя)
  → DeepSeek: название трека
  → Suno: генерация аудио (lyrics + style + голос)
  → поллинг/webhook: получение URL аудио
  → обновление track_requests (audio_url, status=completed)
  → уведомление пользователя в Telegram (ссылкой или файлом)
```

### 3.1 Компоненты

1. **Воркер (отдельный процесс или cron)**  
   Читает заявки со статусом `pending` (или из очереди `track_jobs`). Обрабатывает по одной; при ошибке — retry с лимитом и запись шага в `track_jobs.step` / `attempt`.

2. **Модуль astroLib**  
   Вход: дата, время (или 12:00), широта, долгота, флаг сидерики.  
   Выход: AstroSnapshot (текст или JSON) для подстановки в промпты.

3. **Геокодинг**  
   Функция `birthplace` (строка) → `{ lat, lon, timezone }`. Обработка «не знаю времени»: использовать полдень по `timezone` или явно передавать в снапшот «время неизвестно».

4. **Промпты в БД**  
   Таблица `prompt_templates` (name, body, variables, is_active). Модуль подстановки переменных: `{{astro_snapshot}}`, `{{name}}`, `{{request}}`, `{{archetype}}` и т.д.

5. **DeepSeek**  
   Три вызова (или один комбинированный): архетип, текст песни, название. Результаты писать в `user_archetypes` / поля `track_requests` (lyrics, title, archetype_json).

6. **Suno**  
   По готовым lyrics + стилю из промпта/конфига — запрос к API, сохранение `suno_request_id`, поллинг или webhook для статуса, выбор одного трека и сохранение `audio_url` в `track_requests`.

7. **Уведомление**  
   Бот по `telegram_user_id` из заявки отправляет сообщение со ссылкой на аудио или файлом (например, `ctx.api.sendAudio`).

### 3.2 Порядок внедрения

| Шаг | Что сделать |
|-----|-------------|
| 1 | Геокодинг: функция «место рождения» → lat, lon, timezone (Nominatim или аналог). |
| 2 | Модуль astroLib на базе swisseph: расчёт сидерической карты + Placidus, вывод AstroSnapshot. |
| 3 | Таблица `astro_snapshots` и привязка к `track_requests`; воркер после геокодинга вызывает astroLib и сохраняет снапшот. |
| 4 | Таблица `prompt_templates`, загрузка по name/is_active, подстановка переменных. |
| 5 | Интеграция DeepSeek: архетип → lyrics → title, сохранение в заявку. |
| 6 | Интеграция Suno: генерация, поллинг, сохранение audio_url. |
| 7 | Финальное уведомление пользователю из бота по готовности трека. |

---

## 4. Схема данных (расширение)

- **astro_snapshots**  
  `id`, `track_request_id`, `snapshot_text` (или JSON), `created_at`.  
  Один снапшот на заявку.

- **track_requests** (доп. поля)  
  `astro_snapshot_id`, `archetype_json`, `lyrics`, `title`, `suno_request_id`, `audio_url`, `status` (pending → processing → completed / failed), при необходимости `step`, `attempt` для отладки воркера.

- **track_jobs** (очередь задач)  
  При использовании — `track_request_id`, `step` (astro | archetype | lyrics | title | suno | finalize), `attempt`, `status`, `error_message`.

- **prompt_templates**  
  `name`, `body` (текст с плейсхолдерами `{{var}}`), `variables` (список имён переменных), `is_active`.

---

## 5. Итог

- **Требования к расчётам:** дата, время (или 12:00/«неизвестно»), место рождения → геокодинг → сидерическая карта (Lahiri) + дома Placidus (Swiss Ephemeris) → AstroSnapshot.
- **Автоматизация:** один воркер проходит цепочку геокодинг → astroLib → промпты → DeepSeek (архетип, lyrics, title) → Suno → сохранение URL → уведомление в боте. Промпты и конфиг стилей хранить в БД для гибкости без деплоя.

Дальнейший шаг по коду — реализация модуля геокодинга и обёртки astroLib (swisseph) с выводом AstroSnapshot в формате, согласованным с `prompt_templates`.
