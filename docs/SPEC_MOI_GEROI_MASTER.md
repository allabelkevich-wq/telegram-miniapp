# ТЗ: Модуль «Мои герои» для тарифа «Мастер»

**Заголовок проекта:** Добавление системы управления клиентами («Мои герои») для пользователей с тарифом «Мастер».

**Цель:** Пользователи с тарифом «Мастер» получают картотеку клиентов: хранение данных, натальных карт и истории генераций. Это устраняет путаницу при работе «для себя» и «для клиента» в одном профиле.

---

## 1. Контекст и проблема (как сейчас)

- В системе есть пользователи (идентификация по Telegram).
- У всех один общий профиль: данные (дата рождения и т.д.) вводятся в форме и используются для генерации песен.
- Если мастер (астролог) создаёт песню для клиента, он вынужден подставлять данные клиента вместо своих → путаница и ошибки.
- Нет истории работы по клиентам: все запросы в одной ленте.

---

## 2. Требуемая архитектура и сущности

```
User (Пользователь)
│   ├── id
│   ├── telegram_user_id (или email при веб-авторизации)
│   ├── tariff ('basic' | 'master')
│   └── timestamps
│
└── has_many → Client (Герой / клиент мастера)
        ├── id
        ├── user_id (FK → User)
        ├── name (обязательное)
        ├── birth_date
        ├── birth_time
        ├── birth_place
        ├── birthtime_unknown
        ├── gender
        ├── notes (досье мастера)
        └── timestamps

Track_request / Generation (заявка на песню)
    ├── id
    ├── telegram_user_id (кто создал заявку — мастер)
    ├── client_id (FK → Client, nullable)  ← КРИТИЧЕСКИ ВАЖНО
    ├── name, birthdate, birthtime, birthplace, gender, request, status, ...
    └── timestamps
```

**Логика:** Если `client_id` задан — заявка «для героя», данные для генерации берутся из карточки Client (или подставляются в заявку при создании). Если `client_id` пустой — заявка «для себя», данные из формы/профиля пользователя.

---

## 3. Функциональные требования (FR)

### FR-1: Доступность

- Раздел **«Мои герои»** (или «Мои клиенты», «Картотека») в навигации показывается **только** при `user.tariff === 'master'`.
- При тарифе `basic` раздел не отображается.

### FR-2: Создание и управление героями

- Кнопка **«Добавить героя»**.
- Форма: **Имя** (обяз.), Дата рождения, Время, Место, Пол, **Заметки («Досье»)**.
- Список героев: карточки или таблица (Имя, Дата рождения, Дата добавления).
- **Поиск по именам.**
- Редактирование и удаление карточки (удаление — с подтверждением).

### FR-3: Интерфейс генерации

- На шаге создания песни — **выпадающий список «Для кого создаём?»**:
  - «Для себя»
  - «Для: [Имя Героя 1]», «Для: [Имя Героя 2]», …
- При выборе «Для себя» — используются данные из основного профиля / формы пользователя.
- При выборе героя — подставляются данные из карточки Client (дата, время, место, пол и т.д.) в запрос к API генерации.

### FR-4: История и привязка контента (на будущее)

- В карточке героя — вкладка/секция **«История генераций»**.
- Показать все заявки/песни, где `track_request.client_id = этот_герой.id`.
- Цель: вся история работы с клиентом в одном месте.  
*Реализация — в следующих итерациях.*

---

## 4. Технические указания для реализации

### 4.1 База данных (Supabase)

- Таблица **app_users**: идентификация пользователя (например, `telegram_user_id`), поле **tariff** (`'basic'` | `'master'`).
- Таблица **clients**: `user_id`, `name`, `birth_date`, `birth_time`, `birth_place`, `birthtime_unknown`, `gender`, `notes`, `created_at`, `updated_at`.
- В **track_requests**: добавить **client_id** (nullable, FK → clients). При создании заявки «для героя» заполнять `client_id` и подставлять в заявку данные из выбранного Client.

### 4.2 Текущий стек

- **Mini App:** один `index.html`, Telegram Web App.
- **Бот:** Node (grammY), Supabase.
- Тариф пользователя можно хранить в `app_users` и отдавать в Mini App при инициализации (через бота или отдельный API).

### 4.3 Где реализовать UI

- **Вариант A:** Новые экраны в текущем Mini App: страница «Мои герои» (список, добавление, редактирование), на странице формы — селект «Для кого создаём?». Видимость раздела и селекта — по флагу тарифа из API.
- **Вариант B:** После появления веб-сайта (Этап 3) — раздел «Мои герои» и выбор «для себя / для героя» на веб-интерфейсе.

### 4.4 API (реализовано в боте)

- **POST /api/me** — тело `{ initData }` или заголовок `X-Telegram-Init`. Валидация initData, возврат `{ tariff, app_user_id }`. Создаёт запись в `app_users` при первом обращении (tariff = 'basic').
- **GET /api/heroes?initData=...** — список клиентов текущего пользователя. Опционально `?search=имя`. Возврат `{ tariff, clients }`.
- **POST /api/heroes** — тело `{ initData, name, birth_date, birth_time, birth_place, birthtime_unknown, gender, notes }`. Создание героя.
- **PATCH /api/heroes/:id** — обновление героя (тело с полями + initData).
- **DELETE /api/heroes/:id** — удаление героя (initData в теле, query или заголовке).

В Mini App в начале страницы задаётся `window.HEROES_API_BASE = 'https://твой-домен-бота'` (URL, где запущен бот с этим API). Раздел «Мои герои» и селект «Для кого создаём?» отображаются только при `tariff === 'master'`. Тариф вручную выставить в Supabase: `update app_users set tariff = 'master' where telegram_user_id = ТВОЙ_TG_ID;`.

---

## 5. Чек-лист для разработчика

- [ ] Миграция БД: `app_users`, `clients`, `track_requests.client_id`.
- [ ] Определить способ задания тарифа (админка, бот-команда, платёж).
- [ ] API или бот: возврат тарифа; CRUD клиентов (привязка к user по telegram_user_id).
- [ ] FR-1: В навигации Mini App (или веб) показывать «Мои герои» только при tariff === 'master'.
- [ ] FR-2: Экран «Мои герои»: список, поиск, добавление, редактирование, удаление с подтверждением.
- [ ] FR-3: На экране создания песни — селект «Для кого создаём?» («Для себя» + список героев); подстановка данных из выбранного героя.
- [ ] FR-4: История генераций по герою — позже.

---

*Документ подготовлен как промпт/ТЗ для AI-разработчика (Cursor, ChatGPT, Devin и т.п.).*
