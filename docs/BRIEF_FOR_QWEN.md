# Бриф для пересборки/доработки в Qwen 3 Max

Скопируй этот блок в чат с Qwen, чтобы контекст был полным и не сломать то, что уже работает.

---

## Проект: YupSoul

**Telegram Mini App + бот.** Пользователь заполняет форму (имя, дата/место/время рождения, пол, запрос), переходит на страницу донатов, нажимает «Отправить заявку» — данные уходят в бота через `Telegram.WebApp.sendData`. Админ видит заявки по команде `/admin` в боте. В будущем — генерация звукового ключа (астродвижок, DeepSeek, Suno), пока только приём и хранение заявок.

**Терминология (не менять):** «световой узор души», «звуковой ключ», «Твоя жизнь — игра». Слова «натальная карта» в интерфейсе не использовать.

---

## Что уже сделано и должно сохраниться

### Mini App (один `index.html` на GitHub Pages)
- URL приложения: `https://allabelkevich-wq.github.io/telegram-miniapp/`
- Страницы: главная → форма (имя, дата, место, время, «не знаю время», пол, запрос) → страница донатов → отправка заявки.
- **Дата и место:** под полем даты показывается «Выбрано: 15 марта 1990 г.»; место рождения выбирается из подсказок (обязательно выбрать из списка для перехода дальше).
- **Донаты:** не фиксированная цена, а блок «Поддержать проект» + реквизиты карт (Приорбанк, Альфа-банк) для перевода по желанию. Кнопка: «Отправить заявку».
- В Telegram: по нажатию «Отправить заявку» показывается MainButton «Отправить заявку во Вселенную», по клику — `sendData(JSON.stringify(payload))` с полями формы, приложение закрывается.
- В браузере (без Telegram): превью с панелью переключения страниц, кнопка ведёт на заглушку (loading → success).
- Код без `?.` и со стрелочными функциями, заменёнными на `function()`, для совместимости со старым WebView Telegram. Инициализация Telegram в try/catch.

### Бот (папка `bot/`, Node.js, grammY)
- Команды: `/start` (приветствие + кнопка «Открыть приложение»), `/admin` (только для ID из `ADMIN_TELEGRAM_IDS` в `.env`).
- Приём заявок: `message:web_app_data` → парсинг JSON → сохранение в Supabase (таблица `track_requests`) и в память. Ответ пользователю: «Заявка принята!».
- Supabase: переменные `SUPABASE_URL`, `SUPABASE_SERVICE_KEY` в `bot/.env`. Таблица создаётся скриптом `bot/supabase-schema.sql`. Новый формат ключей (`sb_secret_...`) поддерживается.
- При старте бот выставляет Menu Button на Mini App (`setChatMenuButton`), чтобы ссылка не слетала.
- Секреты только в `.env`, не коммитить.

### Документация и файлы
- `ССЫЛКА_ДЛЯ_КНОПКИ_БОТА.txt` — ссылка для BotFather (Menu Button), если слетела.
- `docs/ПОЛНАЯ_ИНСТРУКЦИЯ_ДЛЯ_ЗАПУСКА.md` — запуск бота, админ, подключение Supabase.
- `bot/НАСТРОЙКА_АДМИНА.md` — как прописать свой Telegram ID для /admin.
- `docs/ASTRO_AUTOMATION.md` — требования к расчёту натальных карт и план автоматизации (астродвижок, DeepSeek, Suno).

---

## Известные проблемы (что можно улучшить при пересборке)

1. **Кнопка меню в Telegram иногда слетает** — бот при старте вызывает `setChatMenuButton`; если всё равно сбрасывается, пользователь вручную вставляет ссылку из `ССЫЛКА_ДЛЯ_КНОПКИ_БОТА.txt` в BotFather.
2. **/admin:** у части пользователей сообщение «грузит» и не приходит — добавлен немедленный ответ «Проверяю заявки…» и try/catch; при ошибке Supabase админу показывается подсказка. Нужно убедиться, что таблица `track_requests` создана и ключи в `.env` верные.
3. **Превью в браузере** — в корне проекта есть `npm run preview`: поднимает локальный сервер с автообновлением (live-server на порту 8080). Сохранил `index.html` — страница в браузере перезагружается сама. Удобно проверять правки без пуша на GitHub.

---

## Стек (оставить при пересборке)

- **Mini App:** один HTML/CSS/JS, без сборки; хостинг GitHub Pages.
- **Бот:** Node.js, grammY, dotenv, @supabase/supabase-js.
- **БД:** Supabase (таблица `track_requests`).

---

## Задача для Qwen

Пересобрать или отрефакторить Mini App (и при необходимости бота), сохранив поведение выше: форма с подтверждением даты/места, донаты и реквизиты карт, отправка заявки через `sendData`, работа /admin и Supabase. Устранить известные ошибки, улучшить стабильность открытия в Telegram. Локальный превью уже есть: в корне `npm run preview` (live-server, автообновление при сохранении файлов).
