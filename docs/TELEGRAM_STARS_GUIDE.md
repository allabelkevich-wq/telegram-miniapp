# Telegram Stars: пошаговый разбор

Куда приходят Stars, как проверить подключение и где смотреть баланс.

---

## Шаг 1. Как устроены Stars у тебя в боте

- Пользователь нажимает «Оплатить звёздами» в мини-приложении.
- Бот создаёт инвойс через Telegram API (`createInvoiceLink`, валюта **XTR** = Stars).
- Пользователь платит Stars в интерфейсе Telegram.
- Telegram отправляет боту событие **successful_payment**.
- Бот обрабатывает его в `bot/index.js` (обновляет заявку, запускает генерацию и т.д.).

**Stars зачисляются на баланс бота** — то есть тебе как владельцу бота. Отдельного «кошелька» в приложении для Stars бота нет: всё идёт в экосистему Telegram/Fragment.

---

## Шаг 2. Проверка, что оплата Stars реально приходит

### 2.1. Уведомление в Telegram (после доработки)

В коде добавлено: при каждой успешной оплате Stars **первому админу** (из `ADMIN_TELEGRAM_IDS`) приходит сообщение в личку с ботом:

- сумма в Stars (XTR);
- товар (sku);
- ID пользователя;
- charge ID.

**Что сделать:** задеплой обновлённый бот, сделай тестовую оплату Stars (минимальную). Если сообщение в личку от бота пришло — оплата Stars до бота доходит, подключение работает.

### 2.2. Логи на Render

В логах сервиса бота (Render → твой сервис → Logs) при оплате Stars должна появиться строка вида:

```text
[Stars] successful_payment: sku=..., requestId=..., userId=..., charge=..., total_amount=... Stars
```

Если такая строка есть после тестовой оплаты — бот получил платёж от Telegram.

### 2.3. Тестовая оплата

1. Открой мини-приложение (например, оформление одной песни или подписки).
2. Выбери «Оплатить звёздами».
3. Оплати минимальную сумму в интерфейсе Telegram.
4. Проверь: пришло ли сообщение админу в бота (п. 2.1) и есть ли запись в логах (п. 2.2).

---

## Шаг 3. Где посмотреть баланс Stars

В Telegram не у всех и не везде есть пункт «Баланс» в карточке бота. Поэтому ориентируйся на два варианта.

### 3.1. Fragment (основной способ для вывода и баланса)

- Сайт: **https://fragment.com**
- Вход — через Telegram (логин тем же аккаунтом, с которого создан бот).
- После привязки и верификации там отображаются заработанные Stars и возможность вывода.

Если раздела со Stars пока нет — возможно, нужно пройти верификацию (KYC) или дождаться, пока Telegram/Fragment откроют вывод для твоего региона/аккаунта.

### 3.2. Профиль/настройки в Telegram

- В некоторых версиях Telegram баланс Stars виден в **Настройки** → раздел, связанный с платежами или Stars (название может отличаться).
- На **iOS/Android** иногда показывают баланс при нажатии на имя бота в чате → «Изм.» → «Баланс» (если пункт есть).

Если у тебя таких опций нет — это нормально; полагайся на Fragment и на уведомления от бота (шаг 2).

---

## Шаг 4. Вывод Stars (кратко)

- Вывод идёт через **Fragment** (конвертация Stars → TON и далее по твоему выбору).
- Обычно есть **минимальный порог** (например, 1000 Stars) и задержка после зачисления (например, до 21 дня).
- На Fragment может потребоваться **KYC** и привязка кошелька для приёма TON.

Актуальные условия и комиссии смотри на fragment.com и в официальных объявлениях Telegram.

---

## Шаг 5. Чек-лист

| Шаг | Действие | Как проверить |
|-----|----------|----------------|
| 1 | Задеплой бота с уведомлением админу при оплате Stars | Код в `bot/index.js`, обработчик `:successful_payment` |
| 2 | Убедись, что в Render задан `ADMIN_TELEGRAM_IDS` (твой ID) | В личку от бота приходят уведомления |
| 3 | Сделай тестовую оплату Stars в боте | В личку пришло сообщение «Оплата Stars получена» и в логах есть `[Stars] successful_payment` |
| 4 | Зайди на Fragment, привяжи аккаунт | В разделе Stars (если доступен) со временем появится баланс |
| 5 | При необходимости пройди KYC на Fragment | Чтобы потом выводить Stars по правилам платформы |

---

## Итог

- **Подключение:** если после тестовой оплаты приходит уведомление админу и запись в логах — Stars к боту подключены и оплаты доходят.
- **Баланс:** смотри в первую очередь на **Fragment**; в Telegram опция «Баланс» может отсутствовать — это не значит, что Stars не зачисляются.
- **Вывод:** только через Fragment (Stars → TON → дальше по твоему выбору), с учётом лимитов и KYC на сайте.
