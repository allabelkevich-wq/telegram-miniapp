# Пошаговый деплой бота на Render

Чтобы бот работал 24/7 без твоего компьютера, разверни его на Render.

---

## Что нужно заранее

1. Код проекта залит в **GitHub** (репозиторий telegram-miniapp или как у тебя называется).
2. Под рукой все значения из файла **`bot/.env`** (их нужно будет ввести в Render вручную; сам файл в репозиторий не заливай).

---

## Шаг 1. Регистрация и новый сервис

1. Открой в браузере **https://render.com** и войди (или зарегистрируйся через GitHub).
2. Нажми **Dashboard** → **New** → **Web Service**.
3. Подключи репозиторий: если его ещё нет в списке — **Connect account** (GitHub) и выбери репозиторий с проектом.
4. Выбери **нужный репозиторий** и нажми **Connect**.

---

## Шаг 2. Настройки сервиса

Заполни поля так:

| Поле | Значение |
|------|----------|
| **Name** | `yupsoul-bot` (или любое имя). |
| **Region** | Выбери ближайший (например Frankfurt). |
| **Root Directory** | **`bot`** — обязательно, без этого Render не найдёт `package.json` и `index.js`. |
| **Runtime** | **Node**. |
| **Build Command** | `npm install` (можно оставить по умолчанию). |
| **Start Command** | `npm start` (или оставить пустым — по умолчанию будет `npm start`). |

---

## Шаг 3. Переменные окружения (Environment Variables)

**Если сервис уже создан:** новый проект создавать не нужно. В **Dashboard** (https://dashboard.render.com) кликни по **названию своего сервиса** (того, где крутится бот — например `yupsoul-bot`). В левой колонке выбери **Environment** → под блоком "Environment Variables" нажми **+ Add Environment Variable** (или "Add Environment Variable"). Введи Key и Value → сохрани (при желании выбери "Save and deploy", чтобы перезапустить бота с новой переменной).

**Если создаёшь сервис впервые:** в том же экране создания найди блок **Environment Variables** и добавь переменные по одной (кнопка **Add Environment Variable**). Имена и значения возьми из своего **`bot/.env`**:

| Key | Откуда взять значение |
|-----|------------------------|
| `BOT_TOKEN` | Из `.env` (токен от @BotFather). |
| `SUPABASE_URL` | Из `.env`. |
| `SUPABASE_SERVICE_KEY` | Из `.env`. |
| `ADMIN_TELEGRAM_IDS` | Из `.env` (твой Telegram ID). |
| `MINI_APP_URL` | Из `.env` (ссылка на Mini App, например Render: `https://telegram-miniapp-ar09.onrender.com/app`). |
| `DEEPSEEK_API_KEY` | Из `.env` (для воркера). |
| `SUNO_API_KEY` | Из `.env` (для воркера). |

При желании можно добавить:

- `HEROES_API_PORT` — не обязательно: на Render порт задаётся автоматически через `PORT`.

Каждую переменную: введи **Key**, вставь **Value** → **Save**.

---

## Шаг 4. План и деплой

1. Внизу выбери план **Free** (если достаточно бесплатного).
2. Нажми **Create Web Service**.
3. Render начнёт сборку: установит зависимости и запустит `npm start`. В логе должно появиться что-то вроде «Бот запущен» и «Heroes API: http://...».
4. Статус станет **Live** — бот в сети.

---

## Важно

- **Root Directory** обязательно **`bot`**, иначе старт не найдёт код.
- Файл **`.env`** в репозиторий не добавляй — только переменные в настройках Render.
- На бесплатном плане сервис может «засыпать» после неактивности; при первом обращении к боту он проснётся (задержка несколько десятков секунд). Для постоянной работы без задержки нужен платный план.

---

## Воркер (обработка заявок)

Воркер (`npm run worker`) на Render можно поднять отдельным **Background Worker**:

1. **New** → **Background Worker**.
2. Тот же репозиторий, **Root Directory**: `bot`.
3. **Build Command**: `npm install`.
4. **Start Command**: `npm run worker`.
5. Те же **Environment Variables**, что и у Web Service.
6. Для периодического запуска (раз в N минут) на бесплатном плане удобнее запускать воркер по крону у себя или на другом сервисе; на Render Background Worker будет крутиться постоянно (на платном плане).

После деплоя бот будет работать в сети без твоего компьютера.

---

## Возврат на Render после локальной отладки

Когда всё проверено локально и нужно снова работать через Render:

1. **Останови бота и воркер у себя** (все терминалы с `npm start` и `worker-loop.js`), чтобы с одним токеном работал только один процесс. Иначе обновления (в т.ч. заявки из Mini App) будут уходить то на Render, то локально.

2. **Закоммить и запушить** последние правки в `main`, чтобы на Render задеплоилась актуальная версия.

3. **Render Dashboard** → сервис **yupsoul-bot** (и при необходимости воркер) → убедись, что сервис **не suspended**. Если был остановлен — **Resume** / **Deploy**.

4. **Переменные окружения** на Render должны совпадать с рабочими: `BOT_TOKEN`, `SUPABASE_*`, `ADMIN_TELEGRAM_IDS`, `MINI_APP_URL` (Render), при необходимости `DEEPSEEK_API_KEY`, `SUNO_API_KEY`.

5. **Отладка:** логи смотри в Render: **Logs** у Web Service (бот) и у Background Worker (воркер). При отправке заявки из приложения в логах бота должны появляться строки `[Заявка] Получены web_app_data` и `[Заявка]` с ID; уведомления админу — `[Уведомление] Доставлено админу`.
