# Чеклист: деплой и дальнейшие шаги

Соответствует запросам по проекту. Выполняй по порядку, когда будет время.

**Сначала тест на компьютере, потом перенос на сервер:** пошагово описано в **docs/ЛОКАЛЬНО_ПОТОМ_СЕРВЕР.md**.

---

## 1. Запуск без заглушек

- [ ] **Заполнить `bot/.env`** — BOT_TOKEN, SUPABASE_URL, SUPABASE_SERVICE_KEY, DEEPSEEK_API_KEY, SUNO_API_KEY (и при желании ADMIN_TELEGRAM_IDS, MINI_APP_URL, BACKEND_URL).  
  Пошагово: **docs/ПОШАГОВАЯ_НАСТРОЙКА.md**.
- [ ] **Миграции в Supabase** — выполнить в SQL Editor по очереди содержимое файлов:  
  `supabase-schema.sql` → `supabase-migration-astro-and-columns.sql` → `supabase-migration-detailed-analysis.sql` → `supabase-migration-prompt-templates.sql`.  
  Либо задать DATABASE_URL в .env и выполнить: `npm run migrate:all`.
- [ ] **Загрузить промпт:** `cd bot && npm run seed-ideally-tuned`.
- [ ] **Проверка:** `cd bot && npm run check-env`.

---

## 2. Деплой на Render

- [ ] **Залить код** в репозиторий (git push), чтобы Render подхватил обновлённый `render.yaml`.
- [ ] **Включить сервис yupsoul-worker** в Render Dashboard (Background Worker).
- [ ] **Задать переменные окружения** для воркера: те же, что у веб-сервиса (BOT_TOKEN, SUPABASE_*, DEEPSEEK_API_KEY, SUNO_API_KEY).
- [ ] При желании задать **BACKEND_URL** (URL твоего бэкенда на Render), чтобы Suno callback вызывал твой домен (эндпоинт POST /suno-callback уже есть в боте).

---

## 3. Проверка потока

- [ ] Открыть бота в Telegram → кнопка меню → Mini App.
- [ ] Заполнить форму, перейти к оплате, нажать «Отправить заявку во Вселенную» → нажать фиолетовую кнопку внизу.
- [ ] Убедиться, что в чате приходит «Получил заявку…» и «Заявка принята!».
- [ ] Дождаться обработки воркером (или запустить локально `npm run worker:full`) — в чат должно прийти аудио.
- [ ] По команде `/get_analysis` — ответ бота (расшифровка только при analysis_paid).

---

## 4. Опционально (позже)

- [ ] **Оплата расшифровки** — интеграция платёжки и проставление `analysis_paid = true` в БД после оплаты.
- [ ] **Ретрай DeepSeek** — уже сделано: при 500/503 до 3 попыток с паузой 5 сек.
- **Callback Suno** — эндпоинт POST /suno-callback добавлен; при заданном BACKEND_URL Suno может слать уведомления, результат по-прежнему забирается поллингом в воркере.

---

## Ссылки по проекту

| Документ | Назначение |
|---------|------------|
| **docs/ПОШАГОВАЯ_НАСТРОЙКА.md** | Куда зайти, что скопировать, куда вставить (.env, Supabase, ключи); в конце — блок «Частые ошибки» |
| **docs/ALGORITHM.md** | Канонический алгоритм бота (карта → промпт → DeepSeek → 4 части → Suno → аудио; расшифровка после оплаты) |
| **docs/ЗАПУСК_БЕЗ_ЗАГЛУШЕК.md** | Переменные, миграции, запуск бота и воркера |
| **docs/RASSHIRENIE_PROEKTA.md** | Куда добавлять новый LLM, другой генератор, шаги пайплайна |
| **docs/CHECKUP_ALGORITHM.md** | Краткий чек-ап алгоритма и точек входа |
| **docs/ЛОКАЛЬНО_ПОТОМ_СЕРВЕР.md** | Тест на компьютере → перенос того же кода на сервер |
