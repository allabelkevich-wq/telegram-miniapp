# Как выполнить миграцию (вручную в Supabase)

Если `npm run setup:db` не срабатывает (например, ошибка подключения к БД), выполни SQL вручную в Supabase.

---

## Где файлы и как копировать

Файлы лежат **внутри папки bot** твоего проекта (рядом с папкой docs и index.html).

**Как найти папку bot в Cursor:**

1. Слева открона **боковая панель** (Explorer). Если её не видно — нажми иконку «файлы» в самом левом вертикальном меню или **Cmd+Shift+E** (Mac) / **Ctrl+Shift+E** (Windows).
2. Вверху списка должна быть **корневая папка проекта** (например `telegram-miniapp` или просто имя папки).
3. Под ней кликни по папке **bot** (стрелочка раскроет её, если нужно).
4. Внутри **bot** будут файлы с названиями `supabase-schema.sql`, `supabase-migration-astro-and-columns.sql` и т.д.

**Если папки bot не видно:** вверху боковой панели проверь, что открыт именно этот проект (папка `telegram-miniapp` или та, где лежат `index.html`, `render.yaml`, папка `docs`). Если открыта другая папка — File → Open Folder и выбери папку с проектом telegram-miniapp.

**Быстро открыть файл:** нажми **Cmd+P** (Mac) или **Ctrl+P** (Windows), введи `supabase-schema` и выбери `supabase-schema.sql` — файл откроется, оттуда можно копировать.

**Файлы по порядку миграции:**

- `bot/supabase-schema.sql`
- `bot/supabase-migration-astro-and-columns.sql`
- `bot/supabase-migration-detailed-analysis.sql`
- `bot/supabase-migration-prompt-templates.sql`

**Как скопировать:** открой файл в Cursor → выдели всё (**Cmd+A** / **Ctrl+A**) → скопируй (**Cmd+C** / **Ctrl+C**). В Supabase вставь (**Cmd+V** / **Ctrl+V**) в поле запроса.

---

## Шаги

1. Открой **https://supabase.com** → свой проект → слева **SQL Editor** → **New query**.

2. Выполни **по очереди** четыре запроса (каждый — в новом запросе или по одному, не смешивая):
   - Открой в Cursor нужный файл из списка выше → скопируй **весь текст** (Cmd+A → Cmd+C).
   - Вставь в поле запроса в SQL Editor → нажми **Run**.
   - Дождись «Success», затем переходи к следующему файлу.

| № | Файл | Что делает |
|---|------|------------|
| 1 | `bot/supabase-schema.sql` | Таблицы `track_requests`, `astro_snapshots`, базовые колонки |
| 2 | `bot/supabase-migration-astro-and-columns.sql` | Доп. колонки для астро и генерации |
| 3 | `bot/supabase-migration-detailed-analysis.sql` | Колонки `detailed_analysis`, `analysis_paid` |
| 4 | `bot/supabase-migration-prompt-templates.sql` | Таблица `prompt_templates` и начальные шаблоны |

3. После выполнения всех четырёх — загрузи «идеально отлаженный» промпт с компьютера (это не SQL, а скрипт через Supabase API):

   ```bash
   cd bot && npm run seed-ideally-tuned
   ```

Готово. После этого можно запускать бота и воркер.
