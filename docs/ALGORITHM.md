# Алгоритм бота: от даты рождения до песни и расшифровки

Это каноническое описание целевого алгоритма. Реализация должна ему соответствовать.

## 1. Ввод данных клиентом

- Клиент оставляет **дату рождения** (и при необходимости место и время) в форме Mini App.
- Окно формы **сразу передаёт точные данные в калькулятор** — либо само является астрологическим калькулятором с нужными параметрами (дата, место, время → координаты по картам мира).
- **Карты мира подключены**: место рождения геокодируется (Nominatim/OpenStreetMap) в координаты; по ним считается натальная карта (Swiss Ephemeris). В интерфейсе должно быть понятно, что место используется для точного расчёта карты.

## 2. Расчёт карты и промпт в DeepSeek

- По заявке считается **натальная карта** (сидерическая, Lahiri, дома Whole Sign) по дате, времени и координатам места рождения.
- В **DeepSeek** отправляются **полные данные натальной карты** (текст снапшота) вместе с **«идеально отлаженным промптом»** (шаблон из БД: `ideally_tuned_system_v1`). Системный промпт содержит инструкции по этапам 1–3; в него подставляются имя, дата/место/время рождения, язык, запрос клиента и сам текст карты.

## 3. DeepSeek: один ответ — четыре части

DeepSeek по промпту делает расчёт и **сразу генерирует песню** (текст). Ответ структурируется в **четыре части**:

1. **Подробный анализ карты** — детальная расшифровка натальной карты (Этап 1 и при необходимости Этап 2 из промпта). Это то, что пользователь получает **только после оплаты** детальной расшифровки.
2. **Два стиля музыки** — для музыкального промпта (в Suno).
3. **Текст песни** — лирика с разметкой [verse], [chorus] и т.д.
4. **Название песни** — в кавычках «».

Части **2, 3, 4** идут в **Suno** (окно настраиваемой генерации): стили + лирика + название.

## 4. Suno и отправка аудио

- В Suno отправляются: **название**, **лирика**, **стили** (музыкальный промпт).
- Сгенерированное **аудио** отправляется пользователю в чат с ботом (бесплатно / по текущей логике).

## 5. Расшифровка только после оплаты

- **Текст подробного анализа карты** (часть 1) приходит в бот и сохраняется в БД.
- Пользователь получает этот текст в чате **только после оплаты** детальной расшифровки (логика оплаты — отдельный шаг; до этого анализ просто не отправляется в чат).

## 6. Автономный вариант

Один пайплайн без ручных шагов:

1. Заявка (дата, место, время, запрос) → сохранение в БД.
2. **Калькулятор**: геокодинг места → расчёт натальной карты → сохранение снапшота.
3. **DeepSeek**: «идеально отлаженный промпт» + полная натальная карта + запрос → ответ с 4 частями → парсинг (анализ, 2 стиля, лирика, название).
4. Сохранение **подробного анализа** в БД (не отправлять пользователю до оплаты).
5. **Suno**: стили + лирика + название → генерация аудио.
6. Отправка **аудио** пользователю в Telegram.
7. По запросу/оплате — отправка **расшифровки** (часть 1) в чат.

Всё это может выполняться одним воркером (или двумя по шагам) по крону или при появлении новой заявки.
