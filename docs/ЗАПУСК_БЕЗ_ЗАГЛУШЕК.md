# Запуск без заглушек

Чтобы всё работало на реальных сервисах (без fallback в память и без URL example.com).

## 1. Переменные окружения

В папке `bot` создай `.env` (скопируй из `.env.example`) и заполни:

| Переменная | Обязательно | Описание |
|------------|-------------|----------|
| `BOT_TOKEN` | да | Токен от @BotFather |
| `SUPABASE_URL` | да | Supabase → Project Settings → API → Project URL |
| `SUPABASE_SERVICE_KEY` | да | Тот же раздел → service_role key |
| `ADMIN_TELEGRAM_IDS` | нет | ID админов через запятую |
| `MINI_APP_URL` | нет | URL Mini App (для кнопки меню) |
| `DEEPSEEK_API_KEY` | для воркера | https://platform.deepseek.com/api_keys |
| `SUNO_API_KEY` | для воркера | https://sunoapi.org/api-key |
| `BACKEND_URL` | для без заглушек | Реальный URL бэкенда, например `https://your-app.onrender.com` — подставится в Suno callback вместо example.com |

Проверка:

```bash
cd bot && node check-env.js
```

Выход с кодом 0 — обязательные переменные заданы.

## 2. База данных

**Вариант А — одной командой (нужен DATABASE_URL):**

1. В Supabase: Settings → Database → Connection string → URI. Подставь пароль БД.
2. В `bot/.env` добавь: `DATABASE_URL=postgresql://postgres:ПАРОЛЬ@db.XXX.supabase.co:5432/postgres`
3. Выполни миграции и загрузку промпта:
```bash
cd bot && npm run migrate:all && npm run seed-ideally-tuned
```

**Вариант Б — вручную в Supabase SQL Editor:**

1. Открой Supabase → SQL Editor → New query.
2. По очереди выполни содержимое файлов (копируй и Run):
   - `bot/supabase-schema.sql`
   - `bot/supabase-migration-astro-and-columns.sql`
   - `bot/supabase-migration-detailed-analysis.sql`
   - `bot/supabase-migration-prompt-templates.sql`
3. Загрузи промпт:
```bash
cd bot && npm run seed-ideally-tuned
```

## 3. Запуск

**Бот** (приём заявок, ответы, админка):

```bash
cd bot && npm start
```

**Воркер** (одна заявка за раз: астро → DeepSeek → Suno → отправка аудио):

```bash
cd bot && npm run worker:full
```

Запускай воркер по крону каждые 2–5 минут или вручную после каждой заявки.

### Воркер на Render

В `render.yaml` добавлен сервис **Background Worker** `yupsoul-worker`: он запускает `node worker-loop.js` и раз в 5 минут обрабатывает одну заявку.

**Что сделать на Render:**

1. Если деплой идёт через **Blueprint** (репозиторий подключён к Render и используется render.yaml): после пуша с обновлённым `render.yaml` в дашборде появится второй сервис **yupsoul-worker**. Включи его и задай для него те же переменные окружения, что и у веб-сервиса: `BOT_TOKEN`, `SUPABASE_URL`, `SUPABASE_SERVICE_KEY`, `DEEPSEEK_API_KEY`, `SUNO_API_KEY` (и при желании `BACKEND_URL`).
2. Если сервисы созданы вручную (без Blueprint): создай новый сервис типа **Background Worker**, Root Directory: `bot`, Build: `npm install`, Start: `node worker-loop.js`, и пропиши те же env vars. Интервал по умолчанию 5 мин; можно задать `WORKER_INTERVAL_MS` (в миллисекундах).

## 4. Что было «заглушкой»

- **Suno `callBackUrl`**: раньше жёстко `https://example.com/suno-callback`. Теперь берётся из `SUNO_CALLBACK_URL` или из `BACKEND_URL` + `/suno-callback`. Результат по-прежнему забирается поллингом; callback нужен только если захочешь обрабатывать уведомления от Suno.
- **Заявки в памяти**: если не заданы `SUPABASE_URL` и `SUPABASE_SERVICE_KEY`, заявки пишутся только в память процесса. Для запуска без заглушек задай Supabase — все заявки будут в БД.
