# Пошаговая настройка: куда зайти, что вставить

## Шаг 1. Токен бота (BOT_TOKEN)

1. **Зайти:** Telegram → найти [@BotFather](https://t.me/BotFather).
2. **Написать:** `/newbot` (если бота ещё нет) или `/mybots` → выбрать бота → API Token.
3. **Скопировать:** строку вида `123456789:ABCdefGHI...`.
4. **Вставить:** в файл **`bot/.env`** (открыть в редакторе), строка:
   ```env
   BOT_TOKEN=сюда_вставь_скопированный_токен
   ```
   Если файла `bot/.env` нет — создать в папке `bot` файл с именем `.env` и первой строкой `BOT_TOKEN=...`.

---

## Шаг 2. Supabase: URL и ключ (SUPABASE_URL, SUPABASE_SERVICE_KEY)

1. **Зайти:** [supabase.com](https://supabase.com) → войти → Dashboard → **свой проект** (или создать новый).
2. **Зайти:** слева **Settings** (шестерёнка) → **API**.
3. **Найти блок "Project URL".**  
   **Скопировать** значение (например `https://xxxxx.supabase.co`).  
   **Вставить** в `bot/.env`:
   ```env
   SUPABASE_URL=сюда_вставь_Project_URL
   ```
4. **Найти блок "Project API keys".**  
   Найти ключ **`service_role`** (не anon). Нажать **Reveal** → **скопировать**.  
   **Вставить** в `bot/.env`:
   ```env
   SUPABASE_SERVICE_KEY=сюда_вставь_service_role_ключ
   ```

---

## Шаг 3. Supabase: миграции (создание таблиц)

Важно: копируешь **не название файла**, а **весь текст внутри файла** (весь SQL с первой до последней строки). Этот текст и вставляешь в Supabase.

1. **Зайти:** тот же проект Supabase → слева **SQL Editor** → **New query**.
2. **Открыть файл** `bot/supabase-schema.sql` в редакторе (Cursor/VS Code).  
   Выделить всё содержимое (Ctrl+A) → скопировать (Ctrl+C).  
   **Вставить** скопированный текст в большое окно запроса в SQL Editor.  
   Нажать **Run**. Должно быть зелёное "Success".
3. **Снова New query.**  
   Открыть файл `bot/supabase-migration-astro-and-columns.sql` → выделить всё (Ctrl+A) → скопировать → вставить **этот текст** в SQL Editor → **Run**.
4. **Снова New query.**  
   Открыть `bot/supabase-migration-detailed-analysis.sql` → выделить всё → скопировать → вставить в SQL Editor → **Run**.
5. **Снова New query.**  
   Открыть `bot/supabase-migration-prompt-templates.sql` → выделить всё → скопировать → вставить в SQL Editor → **Run**.

После этого таблицы `track_requests`, `astro_snapshots`, `prompt_templates` и нужные колонки созданы.

---

## Шаг 4. Загрузка промпта в БД (seed)

1. **Зайти:** в терминале в папку проекта (например `cd ~/telegram-miniapp` или путь к репозиторию).
2. **Выполнить:**
   ```bash
   cd bot && npm run seed-ideally-tuned
   ```
3. Должно вывести: «Промпт … обновлён» или «… добавлен в prompt_templates».  
   Если ошибка «table … not found» — вернуться к шагу 3 и выполнить все четыре SQL-файла по порядку.

---

## Шаг 5. Ключи для воркера (DEEPSEEK_API_KEY, SUNO_API_KEY)

**DeepSeek:**

1. **Зайти:** [platform.deepseek.com](https://platform.deepseek.com) → войти/зарегистрироваться → **API Keys** (или API ключи).
2. Создать ключ → **скопировать** (вид `sk-...`).
3. **Вставить** в `bot/.env`:
   ```env
   DEEPSEEK_API_KEY=сюда_вставь_ключ_DeepSeek
   ```

**Suno:**

1. **Зайти:** [sunoapi.org](https://sunoapi.org) → войти → **API Key** (или страница управления ключами).
2. Создать/скопировать API ключ.
3. **Вставить** в `bot/.env`:
   ```env
   SUNO_API_KEY=сюда_вставь_ключ_Suno
   ```

---

## Шаг 6. (По желанию) Админ и URL приложения

1. **Узнать свой Telegram ID:** написать в Telegram боту [@userinfobot](https://t.me/userinfobot) — он пришлёт число (твой ID).
2. **Вставить** в `bot/.env`:
   ```env
   ADMIN_TELEGRAM_IDS=твой_числовой_ID
   ```
   Несколько админов: через запятую, например `123456,789012`.

3. **URL Mini App** — если приложение открывается с GitHub Pages, в `bot/.env` должна быть строка:
   ```env
   MINI_APP_URL=https://твой-логин.github.io/telegram-miniapp/
   ```
   Подставить свой репозиторий/логин.

---

## Шаг 7. Проверка

В терминале из папки `bot` выполнить:

```bash
cd bot && npm run check-env
```

Должно быть: «OK: обязательные переменные заданы».  
Дальше: запуск бота (`npm start`) и воркера (на Render или локально `npm run worker:full` / `npm run worker:loop`).

---

## Итоговый пример `bot/.env`

Файл должен быть в папке **bot**, имя файла **ровно** `.env`. Пример содержимого (значения заменить на свои):

```env
BOT_TOKEN=123456789:ABCdef...
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_SERVICE_KEY=eyJhbGci...
ADMIN_TELEGRAM_IDS=123456789
MINI_APP_URL=https://allabelkevich-wq.github.io/telegram-miniapp/

DEEPSEEK_API_KEY=sk-...
SUNO_API_KEY=твой_ключ_suno
```

Строки можно в любом порядке; пустые строки и комментарии с `#` допускаются.

---

## Частые ошибки

| Что видишь | Что сделать |
|------------|-------------|
| «Could not find the table 'prompt_templates'» при seed | Выполни все 4 миграции в Supabase (шаг 3). Копируй **весь текст** каждого файла в SQL Editor и Run. |
| «DEEPSEEK_API_KEY не задан» в воркере | Добавь в `bot/.env` строку `DEEPSEEK_API_KEY=sk-...` (ключ с platform.deepseek.com). |
| «SUNO_API_KEY не задан» | Добавь в `bot/.env` строку `SUNO_API_KEY=...` (ключ с sunoapi.org). |
| «Authentication Fails» (401) от DeepSeek | Проверь, что в .env ключ скопирован целиком, без пробелов. Создай новый ключ в кабинете DeepSeek при сомнениях. |
| «Insufficient Balance» (402) от DeepSeek | Пополни баланс на platform.deepseek.com. |
| Воркер пишет «Нет заявок pending» | Это нормально, если очередь пуста. Отправь заявку из Mini App — при следующем запуске воркера она подхватится. |
| 404 на корневой URL (render.com/...) | После деплоя корень отдаёт страницу «YupSoul Bot работает». Если 404 — подожди минуту (холодный старт) или проверь, что задеплоен последний код. |
