# Аудит платёжной системы: Telegram Stars и HOT Pay

## 1. Краткое резюме

**Сильные стороны:**
- **Серверная валидация:** Цены и SKU берутся из каталога на бэкенде (`getSkuPrice`, `getPricingCatalog`); клиент не задаёт сумму для HOT. Stars: сумма задаётся только при создании инвойса на сервере (`stars_price` из каталога).
- **Верификация webhook HOT:** Подпись проверяется через `verifyHotWebhookSignature` (HMAC-SHA256 по `HOT_WEBHOOK_SECRET`). Используется `express.raw({ type: "*/*" })` для сохранения тела запроса.
- **Идемпотентность:** HOT webhook обновляет заявку только при `.or("payment_status.is.null,payment_status.neq.paid")`; повторный вызов возвращает "Already processed". Дубликат по `payment_tx_id` отсекается. Stars: обновление по `requestId` с условием по статусу; при уже `paid` — выход без повторного grant.
- **Проверка владельца:** Все эндпоинты (create, status, confirm) проверяют `validateInitData` и соответствие `telegram_user_id` заявке.
- **Fallback при задержке webhook:** Поллинг статуса на странице благодарности, вызов `/api/payments/hot/confirm` и для подписок — `/api/subscription/claim` и `ensureSubscriptionFromPaidRequests` при чтении `/api/subscription/status`.

**Слабые стороны и риски:**
- В HOT create клиент может передать `sku` в body — сервер использует его вместо только `resolveSkuByMode(requestRow.mode)`, что создаёт риск несоответствия заявки и оплаченного товара.
- При пустом `HOT_WEBHOOK_SECRET` или отсутствии заголовка подписи верификация пропускается (return true) — в проде это недопустимо.
- Страница благодарности показывается при любом `?payment=success` в URL; при отсутствии `request_id` показывается общий текст без проверки факта оплаты.
- Нет явной проверки суммы Stars в `successful_payment` против каталога (аудит-трейл).
- Нет централизованной обработки «пользователь закрыл окно оплаты» — только повторная проверка статуса и кнопка «Я уже оплатил».

---

## 2. Детальный список проблем и рекомендаций

### 2.1 Интеграция с платёжными системами

| Проблема | Место в коде | Риск | Рекомендация |
|----------|--------------|------|--------------|
| **Stars: сумма не сверяется с каталогом при successful_payment** | [bot/index.js](bot/index.js) ~1098–1165 | Низкий: сумму задаёт Telegram по нашему createInvoiceLink. Но при сбое/подмене payload нет аудит-проверки. | После парсинга payload получить продукт из каталога и проверить `Number(sp.total_amount) === product.stars_price`. При несовпадении логировать и не выполнять grant (или выполнять с флагом audit). |
| **HOT create: доверие к client-provided sku** | [bot/index.js](bot/index.js) ~4039: `const sku = String(req.body?.sku \|\| resolveSkuByMode(requestRow.mode)).trim();` | Средний: злоумышленник может отправить другой `sku` (например, подписку вместо песни) и получить checkout на другую цену; заявка в БД остаётся с mode=single — после оплаты webhook обновит заявку и вызовет grant по SKU из webhook/fallback. Для разовой заявки webhook возьмёт sku из body или resolveSkuByMode(row.mode). Итог: возможна путаница (оплатили подписку, а в заявке — single). | Для существующей заявки (`track_requests`) **не принимать** `req.body.sku` — использовать только `resolveSkuByMode(requestRow.mode)`. Отдельный поток для «покупки подписки без заявки» оставить с явным созданием заявки с mode sub_* и без переопределения sku клиентом. |
| **HOT create: client-provided item_id** | [bot/index.js](bot/index.js) ~4055: `const itemId = String(req.body?.item_id \|\| pickHotItemId(sku)).trim();` | Средний: подмена `item_id` может перенаправить оплату на другой товар в кабинете HOT (другая цена/продукт). | Не принимать `req.body.item_id` от клиента; использовать только `pickHotItemId(sku)` из env. |

### 2.2 Безопасность транзакций

| Проблема | Место в коде | Риск | Рекомендация |
|----------|--------------|------|--------------|
| **HOT webhook: проверка подписи пропускается при пустом секрете или заголовке** | [bot/index.js](bot/index.js) ~442–455: при `!HOT_WEBHOOK_SECRET` или `!signatureHeader` возвращается `true`. | Высокий в проде: без секрета любой может слать поддельные webhook и помечать заявки как оплаченные. | В production требовать наличие `HOT_WEBHOOK_SECRET` и заголовка подписи; при отсутствии возвращать 401 и не обрабатывать webhook. |
| **Секреты только в env** | BOT_TOKEN, HOT_WEBHOOK_SECRET, HOT_API_JWT задаются из process.env. | Ок. | Убедиться, что в коде и в public/index.html нет ключей; в клиенте только initData. |
| **HTTPS** | Запросы к Telegram API и HOT идут по HTTPS. | Ок. | Сохранять использование HTTPS для всех платёжных запросов. |

### 2.3 Обработка жизненного цикла платежа

| Проблема | Место в коде | Риск | Рекомендация |
|----------|--------------|------|--------------|
| **HOT webhook: статусы** | [bot/index.js](bot/index.js) ~2722–2725: `normalizedPaid = ["paid", "success", "completed", "confirmed"]`. | Ок. | Документировать в коде полный список статусов, которые HOT может присылать. |
| **Stars: повторный successful_payment** | [bot/index.js](bot/index.js) ~1140–1165: проверка `ps === "paid"` и `.or("payment_status.is.null,...")` при update. | Ок: идемпотентность обеспечена. | При желании добавить проверку по `telegram_payment_charge_id` в БД (если сохраняем), чтобы явно отсекать дубли по charge_id. |
| **Таймаут webhook / поллинг** | [public/index.html](public/index.html) ~5368–5380: поллинг status до 5 (или 20 для подписок) попыток с задержкой. | Ок. | Уже реализовано; при необходимости увеличить число попыток для подписок. |
| **Отмена платежа (пользователь закрыл окно)** | Клиент после openLink/openInvoice не получает отдельного события «отмена». | Низкий: пользователь может нажать «Я уже оплатил» или обновить страницу. | На странице оплаты показывать короткую подсказку: «Закрыл окно оплаты? Нажми «Я уже оплатил — проверить» или открой оплату снова.» |

### 2.4 Пользовательский опыт (UX)

| Проблема | Место в коде | Риск | Рекомендация |
|----------|--------------|------|--------------|
| **Страница благодарности без request_id** | [public/index.html](public/index.html) ~5269–5318: при `?payment=success` без `thanksRequestId` показывается общий текст «Спасибо за оплату» / «заявка принята». | Низкий: пользователь мог подставить URL вручную; финансово ничего не меняется, но возможна путаница. | Не переходить на paymentThanksPage при отсутствии `request_id` в URL; показывать главную или форму с тостом «Если ты только что оплатил — статус обновится автоматически». |
| **Прямой доступ к paymentThanksPage** | Переход по `goToPage('paymentThanksPage')` возможен из кода при других сценариях. | Низкий. | Оставить как есть; при отсутствии контекста (нет request_id и нет недавнего pending_payment_type) не показывать «успех оплаты», а нейтральный текст. |
| **Индикация загрузки при создании платежа** | [public/index.html](public/index.html): кнопка оплаты отключается, текст меняется на «Открываю HOT Checkout...». | Ок. | Убедиться, что при ошибке создания платежа кнопка снова включается и показывается сообщение об ошибке (уже есть setPaymentStatus с ошибкой). |
| **Сообщения об ошибках Stars** | [public/index.html](public/index.html) ~6376–6390: при `!data.success` показывается `data.error || 'Не удалось создать инвойс'`. | Ок. | Проверить, что все ответы API с ошибкой (400, 401, 500) содержат поле `error` с понятным текстом. |
| **Звёзды: «Продукт недоступен для оплаты звёздами»** | [bot/index.js](bot/index.js) ~2623: если у продукта нет `stars_price` или он < 1. | Ок. | В каталоге (БД или DEFAULT_PRICING_CATALOG) у всех платных SKU должны быть заданы `stars_price`; иначе кнопка «Оплатить звёздами» ведёт к ошибке — проверять при отображении кнопки (каталог с бэкенда). |

### 2.5 Состояние и целостность данных

| Проблема | Место в коде | Риск | Рекомендация |
|----------|--------------|------|--------------|
| **Грант после оплаты** | HOT webhook и Stars successful_payment вызывают `grantPurchaseBySku` после обновления заявки. | Ок. | Подписки и soul_chat_1day грантятся; разовые песни — через generateSoundKey(requestId). Логика согласована. |
| **Двойное списание** | HOT: идемпотентность по order_id и tx_id; Stars: по request_id и статусу paid. | Ок. | Сохранять текущую логику. |
| **confirm вызывается с клиента** | [public/index.html](public/index.html): после поллинга payStatus === 'paid' вызывается POST confirm. | Ок: confirm проверяет владельца и статус paid в БД; повторный вызов идемпотентен (подписка already_active, генерация уже запущена). | Без изменений. |

### 2.6 Связанные страницы и компоненты

| Компонент | Оценка | Рекомендация |
|-----------|--------|--------------|
| **Страница выбора тарифа / оверлей оплаты** | Цены приходят с API `/api/pricing/catalog`; кнопки Stars отображаются при наличии `stars_price`. | Убедиться, что при отсутствии `stars_price` кнопка «Оплатить звёздами» скрыта или неактивна, с подсказкой. |
| **Форма оплаты / кнопка HOT** | request_id и контекст берутся из состояния (pendingPaymentRequestId и т.д.), не из произвольного ввода. | Ок. |
| **Страница успеха (paymentThanksPage)** | Зависит от query и localStorage; при отсутствии request_id — универсальный текст. | См. выше: не показывать «успех оплаты» без request_id. |
| **Webhook HOT** | Логирование есть; при ошибке БД возвращается 500; retry для grantPurchaseBySku. | Добавить таймаут на весь обработчик (например, 30 с), чтобы HOT не ждал бесконечно при сбое БД. |

---

## 3. Приоритетные рекомендации

**Критично / сделать в первую очередь:**
1. **HOT create: не доверять client-provided `sku` и `item_id`** для существующей заявки — использовать только `resolveSkuByMode(requestRow.mode)` и `pickHotItemId(sku)` из env.
2. **HOT webhook: в production не пропускать проверку подписи** — если `HOT_WEBHOOK_SECRET` не задан или заголовок подписи отсутствует, возвращать 401 и не обновлять заявки.

**Важно для надёжности и аудита:**
3. **Stars successful_payment:** опционально проверять `sp.total_amount` против `product.stars_price` по sku из payload; при несовпадении логировать и решить (не грантить или грантить с пометкой).
4. **paymentThanksPage:** при открытии с `?payment=success` но без `request_id` не показывать страницу благодарности как «успех оплаты» — показывать главную/форму с нейтральным сообщением.

**Улучшение UX:**
5. Подсказка на экране оплаты: «Закрыл окно оплаты? Нажми «Я уже оплатил — проверить».»
6. Скрывать или дизейблить кнопку «Оплатить звёздами», если у выбранного продукта нет `stars_price` в каталоге.

---

## 4. Чек-лист для тестирования перед продакшеном

- [ ] **HOT Pay: разовая песня** — создать заявку → оплатить → вернуться в Mini App → проверка: заявка paid, генерация запущена, сообщение в боте.
- [ ] **HOT Pay: подписка** — оформить подписку → оплатить → вернуться → проверка: в профиле тариф обновился, Soul Chat доступен (если по тарифу).
- [ ] **HOT Pay: промокод 100%** — ввести промокод на бесплатную генерацию → «Подтвердить» → проверка: без перехода на HOT заявка помечена paid, генерация запущена.
- [ ] **HOT Pay: «Я уже оплатил»** — после оплаты закрыть окно HOT и в Mini App нажать «Я уже оплатил — проверить» → проверка: статус обновился, показано подтверждение.
- [ ] **Stars: разовая песня / подписка / soul_chat_1day** — нажать «Оплатить звёздами» → оплатить в Telegram → проверка: заявка/подписка/доступ обновлены, уведомление админу пришло.
- [ ] **Stars: продукт без stars_price** — убедиться, что такой продукт не показывает кнопку Stars или показывает ошибку при нажатии (и что в каталоге все нужные SKU имеют stars_price).
- [ ] **Отмена оплаты** — открыть HOT/Stars и закрыть окно без оплаты → проверка: в Mini App можно снова нажать «Оплатить» или «Я уже оплатил» без зависания.
- [ ] **Повторный webhook HOT** — симулировать повторную отправку того же webhook (или повторный запрос) → проверка: второй раз возвращается «Already processed», grant не дублируется.
- [ ] **Доступ к paymentThanksPage** — открыть приложение с `?payment=success` без request_id → проверка: не показывается вводящее в заблуждение «Спасибо за оплату» как за успешный платёж (лучше главная/форма с нейтральным текстом).
- [ ] **Проверка владельца** — запрос status/confirm с initData другого пользователя для чужого request_id → проверка: 403.
- [ ] **Webhook HOT без подписи** — при заданном HOT_WEBHOOK_SECRET отправить webhook без заголовка подписи → проверка: 401, заявка не обновляется.

После внедрения приоритетных исправлений повторно пройти чек-лист и при необходимости обновить этот документ.
