# Контроль каждого этапа генерации песни

Чтобы понять, на каком этапе песня «редактируется» или не доделывается (DeepSeek или Suno), в коде и в БД добавлен полный аудит.

## Админ-платформа (удобная проверка)

**URL админки:** [https://telegram-miniapp-ar09.onrender.com/admin](https://telegram-miniapp-ar09.onrender.com/admin)

Если открываешь админку и видишь только белый экран или пару строк — значит страница загрузилась, но доступ ещё не пройден. Ниже два способа входа.

### Как открыть админку из браузера (Render, пошагово)

1. Зайди в **Render**: [dashboard.render.com](https://dashboard.render.com) → выбери сервис с ботом (например `telegram-miniapp-ar09`).
2. Слева открой **Environment** (Переменные окружения).
3. Нажми **Add Environment Variable**. Имя: `ADMIN_SECRET`, значение: любая строка-пароль (например `мой_админ_2025`). Сохрани.
4. Дождись перезапуска сервиса (или нажми **Manual Deploy** → **Deploy latest commit**).
5. В браузере открой ссылку (подставь свой токен из шага 3):
   ```
   https://telegram-miniapp-ar09.onrender.com/admin?token=мой_админ_2025
   ```
6. Должна появиться таблица заявок. Если видишь «Доступ запрещён» — проверь, что `ADMIN_SECRET` в Render совпадает со словом после `?token=` в ссылке.

**Вариант без ссылки:** открой просто `https://...onrender.com/admin`, на странице в поле «Токен» вставь тот же `ADMIN_SECRET` и нажми «Войти».

### Вход из Telegram

Открой ту же ссылку `/admin` из Telegram (или из браузера, будучи залогиненным в Telegram). Если твой Telegram ID указан в `ADMIN_TELEGRAM_IDS` в Render, доступ откроется без токена.

**Что есть в админке:**
- Таблица заявок: дата, имя, режим, статус, **обрезка LLM** (да/нет), ссылка на аудио.
- Клик по строке → детали одной заявки во вкладках:
  - **Сырой ответ DeepSeek** — полный текст до парсинга (если обрезан — видно по концу).
  - **Лирика в Suno** — точный текст, отправленный в Suno (сравни с тем, что слышишь в треке).
  - **Style в Suno** — строка стиля.
  - **Название**, **Анализ**, **Аудио** (ссылка).

## Что сохраняется в БД (таблица `track_requests`)

| Поле | Что это | Как проверять |
|------|---------|----------------|
| **deepseek_response** | Полный сырой ответ DeepSeek (до парсинга) | Если в конце обрыв на полуслове или нет блока с лирикой — проблема на этапе DeepSeek |
| **llm_truncated** | `true`, если ответ обрезан по лимиту токенов | Если `true` — песня могла остаться недоделанной в DeepSeek (нужно увеличить `max_tokens` или сократить системный промпт) |
| **lyrics** | Точный текст лирики, отправленный в Suno | Сравни с тем, что слышишь в треке: если в аудио другие слова — меняет уже Suno |
| **title** | Название, отправленное в Suno | Аналогично |
| **suno_style_sent** | Точная строка `style`, отправленная в Suno | Для сверки настроек звучания |
| **detailed_analysis** | Итоговый полный ответ (анализ + лирика в одном тексте) | То же, что в логах; можно сверять с `deepseek_response` |

## Логи воркера (по шагам)

- **ЭТАП 1 — DeepSeek:** длина ответа, `finish_reason`, предупреждение при обрезке (`finish_reason=length`).
- **ЭТАП 2 — Парсинг:** длина лирики, число строк, title, длина style.
- **ЭТАП 3 — Suno:** длина лирики и первые 120 символов style, затем ссылка на готовый аудио.

## Как проверить «где потерялось»

1. **Песня недоделана (обрыв, нет припева и т.п.):**
   - В Supabase открой заявку → посмотри **llm_truncated**. Если `true` — причина в лимите DeepSeek.
   - Открой **deepseek_response** — посмотри, заканчивается ли текст полной лирикой или обрывается. Если обрыв — увеличить `max_tokens` в воркере или сократить системный промпт.

2. **В песне другие слова, чем в лирике:**
   - Сравни поле **lyrics** в БД с тем, что поётся в треке. Если в БД одно, в аудио другое — меняет Suno (мы отправляем ровно то, что в **lyrics**).

3. **Стиль/звучание не то:**
   - Посмотри **suno_style_sent** — именно эта строка уходит в Suno. Если нужно править — править промпт (чтобы в ответе LLM был нужный `[style:]` / `[vocal:]` / `[mood:]`).

## Миграция БД

Если колонок ещё нет, выполни в Supabase SQL Editor блок из `bot/RUN_IN_SUPABASE.sql` (раздел «6. Аудит генерации»):

```sql
alter table track_requests add column if not exists llm_truncated boolean default false;
alter table track_requests add column if not exists suno_style_sent text;
comment on column track_requests.deepseek_response is 'Полный сырой ответ DeepSeek (до парсинга)';
comment on column track_requests.llm_truncated is 'true если ответ обрезан по max_tokens';
comment on column track_requests.suno_style_sent is 'Точная строка style, отправленная в Suno';
```

После этого по каждой заявке можно однозначно проверить: что вернул DeepSeek, что ушло в Suno и обрезался ли ответ.
