# Tasklist YupSoul

Чеклист задач разбит по этапам: Telegram‑бот (MVP), пайплайн генерации, веб‑сайт, админка и реферальная система.  
Задачи отмечены в формате GitHub‑чекбоксов.

---

## Текущий этап (что делать сейчас)

1. **Запушить коммиты на GitHub** — локально есть 2 коммита (backend + vercel.json), нужно выполнить `git push origin main`.
2. **Деплой бэкенда на Vercel** — в [Vercel](https://vercel.com): Import репо → Root Directory: `backend` → Deploy. В проекте задать **BOT_TOKEN** (Settings → Environment Variables) и сделать Redeploy.
3. **Подключить фронт к бэкенду** — в `index.html` в начале страницы задать URL бэкенда: `window.HEROES_API_BASE = 'https://твой-проект.vercel.app';` (см. TELEGRAM_SETUP.md).
4. **Проверка** — открыть Mini App из бота, отправить заявку → в чате с ботом должна прийти песня.

Дальше по плану — Этап 2 (реальный пайплайн генерации) или этапы 3–5 (сайт, админка, рефералка).

---

## Приоритет: основная идея (уже в работе)

**Цель:** пользователь отправляет заявку из Mini App → по API получает песню в боте как можно скорее.

- [x] Mini App: форма (имя, дата/время/место рождения, пол, запрос) и кнопка «Оплатить».
- [x] Бэкенд: приём POST /api/order с initData, валидация подписи, мок-генерация песни.
- [x] Бэкенд: отправка сообщения пользователю в Telegram (название, текст, ссылка на трек).
- [x] Фронт: вызов API при нажатии «Оплатить» (Authorization: tma + initData, тело — данные формы).
- [ ] Развернуть бэкенд и прописать API_BASE в index.html для продакшена.
- [ ] Подключить реальный пайплайн генерации (Этап 2) вместо мока.

---

## Фронт (Mini App + будущий сайт) — план для полноценного приложения

Ниже этапы 1–5 задают полный объём работ; приоритет по срокам — сначала «песня в боте по заявке», затем остальное.

---

## Этап 1 — Telegram‑бот (MVP без реальных интеграций)

- [x] Подготовка инфраструктуры
  - [x] Настроить проект в Supabase (БД, Auth, Storage, RLS по умолчанию).
  - [x] Создать таблицы telegram_accounts, profiles, track_requests, track_jobs, payments, products.
  - [x] Завести продукты (products) для базовых пакетов: single_track, track_pack.

- [x] Базовый Telegram‑бот
  - [x] Создать бота в BotFather, получить токен.
  - [x] Инициализировать Node/TS‑проект для бота.
  - [x] Подключить Telegram‑SDK (например, grammY/telegraf) и запустить простое /start.

- [x] Онбординг пользователя
  - [x] Реализовать команду/меню /start с объяснением сути сервиса.
  - [x] Добавить диалог по сбору:
    - [x] даты рождения,
    - [x] времени рождения (с поддержкой «не знаю»),
    - [x] места рождения,
    - [x] пола,
    - [x] любимого стиля музыки.
  - [x] Сохранять/обновлять данные в telegram_accounts и profiles.

- [x] Создание запроса на трек (без реальной генерации)
  - [x] Реализовать команду/кнопку «Создать трек».
  - [x] Добавить выбор типа промпта: стандартный / кастомный текст.
  - [x] Сохранять запрос в track_requests в статусе pending (пока без привязки к оплате).

- [x] Подписки и энергия (MVP, Telegram Stars)
  - [x] Добавить учет энергии: energy_accounts, energy_transactions.
  - [x] Обновить subscriptions для Telegram‑аккаунтов.
  - [x] Настроить продукты: подписки + пакеты энергии.
  - [x] Реализовать оплату Stars и начисление энергии/подписки.
  - [x] Резерв энергии при создании трека.
  - [x] Списание энергии только при успешной генерации.
  - [x] Команда клейма дневной энергии.

- [x] UX подписки и оплаты (MVP)
  - [x] Кнопка пополнения энергии в главном меню.
  - [x] Показ фич тарифа в разделе «Подписка».
  - [x] Улучшенные тексты оплаты и клейма.

- [x] Мок‑воркер генерации
  - [x] Поднять отдельный процесс воркера (Node + TS).
  - [x] Реализовать чтение track_jobs со статусом pending.
  - [x] Для MVP вместо реальных API:
    - [x] «Фейковый» расчёт натальной карты (заглушка).
    - [x] «Фейковый» текст песни и название.
    - [x] «Фейковый» URL трека.
  - [x] Обновлять статусы track_requests и track_jobs и отправлять уведомление в ТГ.

- [x] Команда «Мои треки»
  - [x] Реализовать вывод последних track_requests с их статусами.
  - [x] Для готовых треков выводить ссылку на прослушивание (пока можно использовать фиктивные).

- [x] Навигация и админка в боте (MVP)
  - [x] Кнопки: «Мои песни», «Настройки профиля», «Подписка», «Рефералка».
  - [x] Команды: /menu, /profile_settings, /subscription, /referrals, /my_songs.
  - [x] Базовое админ‑меню и разделы (статистика/пользователи/треки/очередь).

---

## Этап 2 — Реальный пайплайн генерации треков (реализован в bot/)

- [x] Астрологический движок
  - [x] Модуль astroLib (bot/astroLib.js), расчёт по данным рождения.
  - [x] workerAstro: геокодинг → AstroSnapshot → astro_snapshots, привязка к track_requests.

- [x] Система управления промптами
  - [x] prompt_templates в Supabase, загрузка по name (bot/promptTemplates.js).
  - [x] Подстановка переменных в шаблоны.

- [x] Интеграция с DeepSeek
  - [x] bot/deepseek.js, генерация текста/названия/стиля по промпту.
  - [x] Сохранение в track_requests (lyrics, title, detailed_analysis).

- [x] Интеграция с SUNO
  - [x] bot/suno.js: старт генерации, поллинг результата.
  - [x] Сохранение audio_url в track_requests, отправка пользователю (sendAudio).

- [x] Очередь и воркер
  - [x] bot/runFullPipeline.js → workerGenerate.runOnceWithAstro (астро → DeepSeek → Suno → отправка).
  - [ ] Ретраи, step/attempt, метрики — по необходимости.

- [x] Уведомления пользователю
  - [x] Финальное уведомление в Telegram (аудио) — bot отправляет по готовности.
  - [ ] Настроить базовые email‑уведомления (через Supabase или внешний сервис), если нужно.

---

## Этап 3 — Веб‑сайт на Vercel

- [ ] Инициализация проекта
  - [ ] Создать Next.js (TypeScript, App Router) проект для сайта.
  - [ ] Подключить Supabase client и Supabase Auth.

- [ ] Авторизация и профиль
  - [ ] Настроить вход через Google.
  - [ ] Привязать users/profiles к входящим пользователям.
  - [ ] Создать страницу профиля:
    - [ ] редактирование даты/времени/места рождения,
    - [ ] выбор пола и любимого стиля,
    - [ ] переключатель «Разрешить показывать мои треки в "Звуках Души"».

- [ ] Создание трека с сайта
  - [ ] Добавить страницу/секцию «Создать трек».
  - [ ] Дать выбор стандартного/кастомного промпта.
  - [ ] Реализовать создание track_requests через безопасный backend‑маршрут.
  - [ ] Подключить платежи (Lava + Hot‑Pay) на сайте.

- [ ] История треков
  - [ ] Страница «Мои треки»:
    - [ ] список track_requests текущего пользователя,
    - [ ] статусы и ссылки на прослушивание.

- [ ] Страница «Звуки Души»
  - [ ] Создать публичную страницу галереи.
  - [ ] Подключить данные из public_tracks (только одобренные треки).
  - [ ] Добавить плеер (HTML5 audio) и краткие описания.
  - [ ] Добавить CTA‑кнопки: «Создать свой трек», «Перейти в Telegram‑бота».

---

## Этап 4 — Админка

- [ ] Базовый доступ
  - [ ] Ввести роль admin/moderator (через Supabase и/или claims).
  - [ ] Закрыть админку RLS‑политиками и проверками на уровне приложения.

- [ ] Раздел "Пользователи"
  - [ ] Список пользователей с поиском по email, Telegram ID, имени.
  - [ ] Просмотр профиля и связанных треков.
  - [ ] Возможность пометить пользователя (tags/flags).

- [ ] Раздел "Треки"
  - [ ] Список track_requests с фильтрами (статус, дата, канал).
  - [ ] Просмотр деталей: архетип, текст песни, ссылка на трек.
  - [ ] Ручное изменение статуса (для отладки и поддержки).

- [ ] Модерация "Звуков Души"
  - [ ] Интерфейс для просмотра кандидатов в public_tracks.
  - [ ] Кнопки «Одобрить» / «Скрыть».
  - [ ] Теги для классификации (настроение, стиль, архетип).

- [ ] Управление промптами
  - [ ] Раздел «Промпты» в админке:
    - [ ] список всех шаблонов с версиями,
    - [ ] просмотр и редактирование шаблонов,
    - [ ] создание новой версии (копирование + редактирование),
    - [ ] переключение активности (is_active),
    - [ ] валидация переменных перед сохранением.

- [ ] Аналитика
  - [ ] Базовая панель:
    - [ ] количество пользователей,
    - [ ] количество треков (созданных/готовых),
    - [ ] конверсия в оплату и т.п.

---

## Этап 5 — Реферальная система

- [ ] Простая одноуровневая рефералка
  - [ ] Добавить таблицу referrals (уже описана в vision).
  - [ ] Для каждого пользователя сгенерировать реферальный код/ссылку.
  - [ ] В ТГ и на сайте:
    - [ ] показывать персональный реферальный код,
    - [ ] принимать реферал‑код при регистрации/первом онбординге.
  - [ ] Привязывать новых пользователей/оплаты к referrals.
  - [ ] Начислять бонусы (скидка/бесплатный трек) за успешные оплаты приглашённых.

- [ ] Интеграция с основным UX
  - [ ] Показать пользователю, сколько людей он привёл и какие бонусы получил.
  - [ ] Добавить отдельный раздел/команду «Рефералы» (в ТГ и на сайте).

---

## Meta‑задачи для развития

- [ ] Настроить мониторинг и логирование (логи воркера, ошибки интеграций).
- [ ] Добавить трейсинг ключевых шагов пайплайна (идентификатор запроса/трек‑ID).
- [ ] Продумать миграции данных и версионирование схемы БД.
- [ ] Подготовить базовый набор документации для разработчиков (README, диаграммы, примеры запросов).
