<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>YupSoul</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>window.HEROES_API_BASE = '';</script>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Comfortaa',sans-serif}
    body{background:linear-gradient(135deg,#f9f7ff 0%,#fefeff 100%);min-height:100vh;display:flex;flex-direction:column;padding:20px 15px;position:relative;overflow-x:hidden;color:#2d2d2d}
    body::before{content:"";position:fixed;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle at 30% 30%,rgba(167,139,250,.08) 0%,transparent 25%),radial-gradient(circle at 70% 70%,rgba(249,168,212,.08) 0%,transparent 25%);z-index:-1;opacity:.3}
    .container{max-width:600px;margin:0 auto;width:100%}
    .page{display:none;min-height:100vh;padding-top:20px}
    .page.active{display:block}
    header{text-align:center;margin:25px 0 20px}
    h1{font-size:2.4rem;background:linear-gradient(90deg,#a78bfa,#f9a8d4,#5eead4);-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:800;letter-spacing:-1px;line-height:1.1}
    .subtitle{color:#6b7280;font-size:1.15rem;margin-top:8px;font-weight:400}
    .tagline{color:#a78bfa;font-size:1.35rem;font-weight:700;margin:15px 0;letter-spacing:-0.5px}
    .section{background:#fefeff;border-radius:24px;padding:30px 25px;box-shadow:0 8px 30px rgba(167,139,250,.15);border:1px solid #e5e7eb;position:relative;overflow:hidden;margin-bottom:25px}
    .section::before{content:"";position:absolute;top:0;left:0;width:4px;height:100%;background:linear-gradient(to bottom,#a78bfa,#f9a8d4)}
    .field{margin-bottom:22px;text-align:left}
    label{display:block;margin-bottom:10px;color:#2d2d2d;font-weight:600;font-size:1.05rem;display:flex;align-items:center;gap:10px}
    label::before{content:attr(data-icon);font-size:1.25rem}
    input,textarea,select{width:100%;padding:15px;border-radius:16px;border:1px solid #e5e7eb;background:white;color:#2d2d2d;font-size:16px;transition:all .3s ease;font-family:'Comfortaa',sans-serif}
    input:focus,textarea:focus,select:focus{outline:none;border-color:#a78bfa;box-shadow:0 0 0 3px rgba(167,139,250,.15)}
    input.valid,textarea.valid{border-color:#4ade80}
    .time-group{display:flex;flex-direction:column;gap:14px}
    .checkbox{display:flex;align-items:center;gap:12px;margin-top:-6px}
    .checkbox input{width:auto;height:20px;accent-color:#a78bfa}
    .checkbox label{margin-bottom:0;font-weight:500;color:#2d2d2d;font-size:1rem;display:flex;align-items:center;gap:8px}
    .checkbox label::before{content:"‚ùì";font-size:1.3rem}
    select{appearance:none;background:url("image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23a78bfa' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E") no-repeat right 16px center;background-size:20px;padding-right:48px}
    textarea{min-height:140px;line-height:1.6;resize:vertical}
    .request-label{font-size:1.3rem;text-align:center;margin-bottom:15px;color:#a78bfa;font-weight:700;letter-spacing:-0.5px}
    button{background:linear-gradient(90deg,#a78bfa,#f9a8d4);color:white;border:none;padding:18px 30px;font-size:1.25rem;border-radius:20px;width:100%;font-weight:700;cursor:pointer;transition:all .3s ease;box-shadow:0 6px 20px rgba(167,139,250,.25);margin-top:10px;letter-spacing:1px;text-transform:uppercase;min-height:64px;position:relative;overflow:hidden}
    button::after{content:"";position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.4),transparent);transform:rotate(30deg);transition:all .8s}
    button:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(167,139,250,.35)}
    button:hover::after{left:100%}
    button:active{transform:translateY(1px)}
    button:disabled{background:#d1d5db;cursor:not-allowed;transform:none;box-shadow:none;opacity:.85}
    button.secondary{background:white;color:#a78bfa;border:2px solid #a78bfa;box-shadow:none;text-transform:none;letter-spacing:-0.5px;font-weight:600;min-height:56px}
    button.secondary:hover{background:#a78bfa;color:white;box-shadow:0 6px 20px rgba(167,139,250,.25)}
    .btn-group{display:flex;gap:15px;margin-top:25px}
    .btn-group button{flex:1}
    .price-tag{background:linear-gradient(90deg,#f9a8d4,#a78bfa);color:white;padding:12px 20px;border-radius:16px;font-size:1.4rem;font-weight:700;text-align:center;margin:20px 0;box-shadow:0 4px 15px rgba(249,168,212,.3);letter-spacing:1px}
    .payment-info{background:rgba(167,139,250,.05);border-left:4px solid #a78bfa;padding:15px;border-radius:0 12px 12px 0;margin:15px 0;font-size:.95rem;line-height:1.6}
    .payment-info::before{content:"üíé ";font-size:1.3rem}
    .success-icon{font-size:5rem;text-align:center;margin:20px 0;background:linear-gradient(90deg,#5eead4,#a78bfa);-webkit-background-clip:text;background-clip:text;color:transparent}
    .keys-composition{display:flex;align-items:center;justify-content:center;gap:20px;margin:25px 0;flex-wrap:wrap}
    .keys-composition svg{filter:drop-shadow(0 4px 12px rgba(167,139,250,.25));transition:transform .3s ease}
    .keys-composition .key-music{transform:rotate(-10deg);width:56px;height:80px}
    .keys-composition .key-door{transform:rotate(8deg);width:52px;height:80px}
    .keys-composition .key-music:hover,.keys-composition .key-door:hover{transform:rotate(0) scale(1.05)}
    .keys-composition-small{display:flex;align-items:center;justify-content:center;gap:12px;margin:15px 0}
    .keys-composition-small .key-music{width:36px;height:50px;transform:rotate(-8deg);opacity:.9}
    .keys-composition-small .key-door{width:34px;height:50px;transform:rotate(6deg);opacity:.9}
    .app-logo{display:block;margin:0 auto;max-width:200px;width:100%;height:auto;border-radius:24px;box-shadow:0 8px 30px rgba(167,139,250,.2)}
    .app-logo.success{max-width:180px;margin-bottom:15px}
    .success-title{font-size:2.2rem;color:#a78bfa;font-weight:800;text-align:center;margin:20px 0;background:linear-gradient(90deg,#a78bfa,#f9a8d4);-webkit-background-clip:text;background-clip:text;color:transparent}
    .success-text{font-size:1.15rem;line-height:1.7;margin:20px 0;text-align:center;padding:0 10px}
    .loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px 40px;text-align:center;min-height:70vh}
    .spinner{width:60px;height:60px;border:5px solid rgba(167,139,250,.2);border-top-color:#a78bfa;border-radius:50%;margin:0 auto 25px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-text{font-size:1.5rem;color:#a78bfa;font-weight:700;margin-bottom:15px}
    .song-preview{background:white;border-radius:16px;padding:20px;margin:20px 0;text-align:left;border:2px solid #a78bfa}
    .song-preview h3{color:#a78bfa;font-size:1.4rem;margin-bottom:10px;text-align:center}
    .song-preview p{font-size:1.05rem;line-height:1.7;color:#2d2d2d}
    footer{text-align:center;padding:30px 0 20px;color:#6b7280;font-size:.95rem;margin-top:auto}
    .birthplace-wrap{position:relative}
    .birthplace-suggestions{position:absolute;left:0;right:0;top:100%;margin-top:4px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.12);max-height:220px;overflow-y:auto;z-index:50;list-style:none;padding:6px 0}
    .birthplace-suggestions li{padding:12px 16px;cursor:pointer;font-size:1rem;color:#2d2d2d;border-bottom:1px solid #f3f4f6;transition:background .15s}
    .birthplace-suggestions li:last-child{border-bottom:none}
    .birthplace-suggestions li:hover,.birthplace-suggestions li.selected{background:rgba(167,139,250,.12);color:#6d28d9}
    .birthplace-suggestions .place-type{font-size:.85rem;color:#6b7280;margin-top:2px}
    .birthplace-summary .place-name{font-weight:700;color:#5b21b6}
    .place-coords{font-family:ui-monospace,monospace;letter-spacing:.02em}
    
    /* –ü–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–≤—å—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ */
    .preview-nav{background:white;border-radius:16px;padding:12px;margin-bottom:25px;box-shadow:0 4px 20px rgba(167,139,250,.15);text-align:center;border:1px solid #e5e7eb;display:none}
    .preview-nav.show{display:block}
    .preview-nav-buttons{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:10px}
    .preview-nav button{background:white;color:#a78bfa;border:2px solid #a78bfa;padding:6px 14px;margin:0 4px;border-radius:20px;cursor:pointer;font-weight:600;transition:all .2s;font-size:.9rem;min-width:90px}
    .preview-nav button:hover{background:#a78bfa;color:white;transform:translateY(-2px)}
    .preview-nav button.active{background:linear-gradient(90deg,#a78bfa,#f9a8d4);color:white;border-color:transparent;box-shadow:0 4px 15px rgba(167,139,250,.3)}
    
    @media (max-width:480px){.container{padding:0 12px}h1{font-size:2.1rem}.subtitle{font-size:1.05rem}.tagline{font-size:1.2rem}.section{padding:25px 20px}.btn-group{flex-direction:column}.btn-group button{width:100%}button{font-size:1.15rem;padding:16px;min-height:60px}.price-tag{font-size:1.25rem;padding:10px 15px}.success-icon{font-size:4rem}.success-title{font-size:1.9rem}.success-text{font-size:1.05rem}.preview-nav-buttons{flex-direction:column;align-items:center}.preview-nav button{width:100%;max-width:200px}}
  </style>
</head>
<body>
  <!-- –ü–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–≤—å—é (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ) -->
  <div class="container">
    <div class="preview-nav" id="previewNav">
      <div style="font-weight:600;color:#a78bfa;margin-bottom:8px">üé® –†–µ–∂–∏–º –ø—Ä–µ–≤—å—é</div>
      <div class="preview-nav-buttons">
        <button class="active" data-page="home">–ì–ª–∞–≤–Ω–∞—è</button>
        <button data-page="form">–§–æ—Ä–º–∞</button>
        <button data-page="payment">–û–ø–ª–∞—Ç–∞</button>
        <button data-page="loading">–ó–∞–≥—Ä—É–∑–∫–∞</button>
        <button data-page="success">–£—Å–ø–µ—Ö</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
    <div class="page active" id="homePage">
      <header>
        <h1>YupSoul</h1>
        <div class="subtitle">—Ç–≤–æ—è –∂–∏–∑–Ω—å ‚Äî –∏–≥—Ä–∞</div>
        <div class="tagline">–û—Ç–ø—Ä–∞–≤—å –∑–∞–ø—Ä–æ—Å –≤–æ –í—Å–µ–ª–µ–Ω–Ω—É—é</div>
      </header>
      
      <div class="section">
        <img src="https://telegram-miniapp-six-teal.vercel.app/logo.png" alt="YupSoul" class="app-logo" width="200" height="200">
        <p style="text-align:center;font-size:1.15rem;line-height:1.7;margin-bottom:25px">
          –°–æ–∑–¥–∞–π —Å–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∑–≤—É–∫–æ–≤–æ–π –∫–ª—é—á ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—É—é –∞—É–¥–∏–æ–∫–æ–º–ø–æ–∑–∏—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–∫—Ä–æ–µ—Ç —Ç–µ–±–µ –¥–≤–µ—Ä—å –∫ –∂–µ–ª–∞–µ–º–æ–º—É.
        </p>
        <button id="startBtn">‚ú® –ù–∞—á–∞—Ç—å</button>
        <div id="masterNav" style="display:none; margin-top:20px">
          <button class="secondary" id="goHeroesBtn">üë• –ú–æ–∏ –≥–µ—Ä–æ–∏</button>
        </div>
      </div>
      
      <footer>
        <p>YupSoul ‚Ä¢ 2026</p>
      </footer>
    </div>
    
    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´–ú–æ–∏ –≥–µ—Ä–æ–∏¬ª (—Ç–∞—Ä–∏—Ñ –ú–∞—Å—Ç–µ—Ä) -->
    <div class="page" id="heroesPage">
      <header>
        <h1>–ú–æ–∏ –≥–µ—Ä–æ–∏</h1>
        <div class="subtitle">–ö–∞—Ä—Ç–æ—Ç–µ–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
      </header>
      <div class="section">
        <div class="field">
          <label>–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏</label>
          <input type="text" id="heroesSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è...">
        </div>
        <button class="secondary" id="heroesSearchBtn" style="margin-bottom:15px">–ò—Å–∫–∞—Ç—å</button>
        <div id="heroesList"></div>
        <button id="addHeroBtn" style="margin-top:15px">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥–µ—Ä–æ—è</button>
        <div id="heroFormWrap" style="display:none; margin-top:25px; padding-top:20px; border-top:1px solid #e5e7eb">
          <div class="field"><label for="heroName">–ò–º—è *</label><input type="text" id="heroName" placeholder="–ò–º—è –≥–µ—Ä–æ—è" required></div>
          <div class="field"><label for="heroBirthdate">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label><input type="date" id="heroBirthdate"></div>
          <div class="field"><label for="heroBirthtime">–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è</label><input type="time" id="heroBirthtime"></div>
          <div class="field"><label for="heroBirthplace">–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è</label><input type="text" id="heroBirthplace" placeholder="–ì–æ—Ä–æ–¥, —Å—Ç—Ä–∞–Ω–∞"></div>
          <div class="checkbox" style="margin-bottom:15px"><input type="checkbox" id="heroBirthtimeUnknown"><label for="heroBirthtimeUnknown">–ù–µ –∑–Ω–∞—é —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è</label></div>
          <div class="field"><label for="heroGender">–ü–æ–ª</label><select id="heroGender"><option value="">–í—ã–±–µ—Ä–∏</option><option value="male">–ú—É–∂—Å–∫–æ–π</option><option value="female">–ñ–µ–Ω—Å–∫–∏–π</option><option value="other">–î—Ä—É–≥–æ–π</option></select></div>
          <div class="field"><label for="heroNotes">–î–æ—Å—å–µ / –∑–∞–º–µ—Ç–∫–∏</label><textarea id="heroNotes" placeholder="–ó–∞–º–µ—Ç–∫–∏ –æ –∫–ª–∏–µ–Ω—Ç–µ" rows="3"></textarea></div>
          <div class="btn-group">
            <button class="secondary" id="heroFormCancel">–û—Ç–º–µ–Ω–∞</button>
            <button id="heroFormSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </div>
      </div>
      <div class="btn-group" style="margin-top:20px">
        <button class="secondary" id="heroesBackBtn">‚Üê –ù–∞–∑–∞–¥</button>
      </div>
      <footer><p>YupSoul ‚Ä¢ 2026</p></footer>
    </div>
    
    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ñ–æ—Ä–º—ã -->
    <div class="page" id="formPage">
      <header>
        <h1>YupSoul</h1>
        <div class="subtitle">—Ç–≤–æ—è –∂–∏–∑–Ω—å ‚Äî –∏–≥—Ä–∞</div>
      </header>
      
      <div class="section">
        <div class="field" id="forWhoWrap" style="display:none">
          <label for="forWho" data-icon="üë§">–î–ª—è –∫–æ–≥–æ —Å–æ–∑–¥–∞—ë–º?</label>
          <select id="forWho">
            <option value="">–î–ª—è —Å–µ–±—è</option>
          </select>
        </div>
        <div class="field">
          <label for="name" data-icon="‚ú®">–ò–º—è</label>
          <input type="text" id="name" placeholder="–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?" required>
        </div>
        
        <div class="field">
          <label for="birthdate" data-icon="üìÖ">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
          <input type="date" id="birthdate" required>
          <div id="birthdateSummary" class="field-summary" style="display:none; margin-top:8px; padding:10px; background:rgba(167,139,250,.08); border-radius:12px; font-size:.95rem;"></div>
        </div>
        
        <div class="field">
          <label for="birthplace" data-icon="üåç">–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
          <p class="field-hint" style="margin:0 0 8px 0; font-size:.9rem; color:#6b7280;">–ü–æ –∫–∞—Ä—Ç–∞–º –º–∏—Ä–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã ‚Äî —Ç–∞–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ç–≤–æ—è –Ω–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞. –í—ã–±–µ—Ä–∏ –º–µ—Å—Ç–æ –∏–∑ —Å–ø–∏—Å–∫–∞.</p>
          <div class="birthplace-wrap">
            <input type="text" id="birthplace" placeholder="–ù–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å –≥–æ—Ä–æ–¥ –∏–ª–∏ —Å—Ç—Ä–∞–Ω—É ‚Äî –≤—ã–±–µ—Ä–∏ –∏–∑ —Å–ø–∏—Å–∫–∞" required autocomplete="off">
            <ul id="birthplaceSuggestions" class="birthplace-suggestions" aria-hidden="true"></ul>
          </div>
          <div id="birthplaceSummary" class="field-summary birthplace-summary" style="display:none; margin-top:8px; padding:12px 14px; background:rgba(167,139,250,.08); border-radius:12px; font-size:.95rem;"></div>
          <div id="placeCoords" class="place-coords" style="display:none; margin-top:6px; padding:10px 14px; background:rgba(94,234,212,.1); border-radius:10px; font-size:.9rem; color:#0d9488;"></div>
        </div>
        
        <div class="field">
          <label for="birthtime" data-icon="‚è∞">–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è</label>
          <div class="time-group">
            <input type="time" id="birthtime" required>
            <div class="checkbox">
              <input type="checkbox" id="unknown">
              <label for="unknown">–ù–µ –∑–Ω–∞—é —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è</label>
            </div>
          </div>
        </div>
        
        <div class="field">
          <label for="gender" data-icon="‚ößÔ∏è">–ü–æ–ª</label>
          <select id="gender" required>
            <option value="">–í—ã–±–µ—Ä–∏</option>
            <option value="male">–ú—É–∂—Å–∫–æ–π</option>
            <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
            <option value="other">–î—Ä—É–≥–æ–π</option>
          </select>
        </div>
        
        <div class="field">
          <label for="language" data-icon="üåê">–Ø–∑—ã–∫ –ø–µ—Å–Ω–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏—è</label>
          <select id="language" required>
            <option value="">–í—ã–±–µ—Ä–∏ —è–∑—ã–∫</option>
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="en">English</option>
            <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
          </select>
        </div>
        
        <div class="field">
          <div class="request-label">–û—Ç–ø—Ä–∞–≤—å –∑–∞–ø—Ä–æ—Å –≤–æ –í—Å–µ–ª–µ–Ω–Ω—É—é</div>
          <textarea id="request" placeholder="–ß—Ç–æ —Ç—ã —Ö–æ—á–µ—à—å –∏–∑–º–µ–Ω–∏—Ç—å –≤ —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏? –û —á—ë–º –ø—Ä–æ—Å–∏—à—å –í—Å–µ–ª–µ–Ω–Ω—É—é?"></textarea>
        </div>
        
        <div class="btn-group">
          <button class="secondary" id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
          <button id="nextBtn">–î–∞–ª–µ–µ ‚Üí</button>
        </div>
      </div>
      
      <footer>
        <p>YupSoul ‚Ä¢ 2026</p>
      </footer>
    </div>
    
    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–Ω–∞—Ç–æ–≤ / —Ä–µ–∫–≤–∏–∑–∏—Ç—ã -->
    <div class="page" id="paymentPage">
      <header>
        <h1>YupSoul</h1>
        <div class="subtitle">–¢–≤–æ–π –∑–≤—É–∫–æ–≤–æ–π –∫–ª—é—á</div>
      </header>
      
      <div class="section">
        <div class="tagline" style="margin-bottom:15px">–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</div>
        <p style="text-align:center;font-size:1.05rem;line-height:1.7;margin-bottom:20px">
          –Ø —Å–æ–∑–¥–∞–º –¥–ª—è —Ç–µ–±—è —É–Ω–∏–∫–∞–ª—å–Ω—É—é –∞—É–¥–∏–æ–∫–æ–º–ø–æ–∑–∏—Ü–∏—é –ø–æ —Ç–≤–æ–∏–º –¥–∞–Ω–Ω—ã–º –∏ –∑–∞–ø—Ä–æ—Å—É ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∑–≤—É–∫–æ–≤–æ–π –∫–ª—é—á. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç, –º–æ–∂–µ—à—å –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –ª—é–±—É—é —Å—É–º–º—É –ø–æ –∂–µ–ª–∞–Ω–∏—é –Ω–∞ –∫–∞—Ä—Ç—É –Ω–∏–∂–µ.
        </p>
        
        <div style="background:rgba(167,139,250,.12);border-radius:16px;padding:20px;margin:20px 0;border:1px solid rgba(167,139,250,.25);text-align:center">
          <div style="font-weight:700;color:#6d28d9;margin-bottom:10px;font-size:1.05rem">üí≥ –ö–∞—Ä—Ç–∞ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ –∂–µ–ª–∞–Ω–∏—é</div>
          <div id="donationCardDetails" style="font-size:1.05rem;font-family:monospace;letter-spacing:1px;word-break:break-all;color:#2d2d2d;line-height:1.8">
            –ü—Ä–∏–æ—Ä–±–∞–Ω–∫: 4916 9896 3237 0697<br>
            –ê–ª—å—Ñ–∞-–±–∞–Ω–∫: 4585 2200 0626 0623
          </div>
          <p style="font-size:.9rem;color:#6b7280;margin-top:12px">–õ—é–±–∞—è —Å—É–º–º–∞ –æ—Ç —Ç–µ–±—è ‚Äî —Ü–µ–Ω–Ω–∞</p>
        </div>
        
        <div style="background:rgba(249,168,212,.1);border-radius:12px;padding:15px;margin:20px 0;font-size:.95rem">
          <strong>–ß—Ç–æ —Ç—ã –ø–æ–ª—É—á–∏—à—å:</strong>
          <ul style="margin-left:20px;margin-top:10px;line-height:1.7">
            <li>–£–Ω–∏–∫–∞–ª—å–Ω—É—é –º—É–∑—ã–∫—É –ø–æ–¥ —Ç–≤–æ–π —Å–≤–µ—Ç–æ–≤–æ–π —É–∑–æ—Ä</li>
            <li>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∞—Ñ—Ñ–∏—Ä–º–∞—Ü–∏–∏ —Å —Ç–≤–æ–∏–º –∏–º–µ–Ω–µ–º</li>
            <li>–ê—É–¥–∏–æ—Ñ–∞–π–ª –≤ –≤—ã—Å–æ–∫–æ–º –∫–∞—á–µ—Å—Ç–≤–µ ‚Äî –ø—Ä–∏–¥—ë—Ç –≤ –±–æ—Ç–∞</li>
          </ul>
        </div>
        
        <div class="btn-group">
          <button class="secondary" id="backFromPaymentBtn">‚Üê –ù–∞–∑–∞–¥</button>
          <button id="payBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
        </div>
      </div>
      
      <footer>
        <p>YupSoul ‚Ä¢ 2026</p>
      </footer>
    </div>
    
    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="page" id="loadingPage">
      <div class="loading">
        <div class="spinner"></div>
        <div class="loading-text">–°–æ–∑–¥–∞—é —Ç–≤–æ–π –∫–ª—é—á...</div>
        <div style="color:#6b7280;font-size:1.1rem;text-align:center;max-width:400px">
          –ú–∞–≥–∏—è —Ç–≤–æ—Ä–∏—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏. –¢–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∑–≤—É–∫–æ–≤–æ–π –∫–ª—é—á —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–≤–æ–∏—Ö —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
        </div>
      </div>
    </div>
    
    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—Ö–∞ -->
    <div class="page" id="successPage">
      <header>
        <h1>YupSoul</h1>
        <div class="subtitle">–ö–ª—é—á –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!</div>
      </header>
      
      <div class="section">
        <img src="https://telegram-miniapp-six-teal.vercel.app/logo.png" alt="YupSoul" class="app-logo success" width="180" height="180">
        <h2 class="success-title">–ì–æ—Ç–æ–≤–æ!</h2>
        <p class="success-text">
          –¢–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∑–≤—É–∫–æ–≤–æ–π –∫–ª—é—á —Å–æ–∑–¥–∞–Ω! –≠—Ç–æ —Ç–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —Å–∏–ª—ã –¥–ª—è –∏–≥—Ä—ã –∂–∏–∑–Ω–∏.
        </p>
        
        <div class="song-preview">
          <h3>üéµ –¢–≤–æ—è –ø–µ—Å–Ω—è</h3>
          <p id="songPreviewText">
            –¢–≤–æ—è —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –∞—É–¥–∏–æ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è —É–∂–µ –∂–¥—ë—Ç —Ç–µ–±—è –≤ –±–æ—Ç–µ. –°–ª—É—à–∞–π –µ—ë –∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å—Å—è –Ω–∞ –≤–æ–ª–Ω—É —É—Å–ø–µ—Ö–∞.
          </p>
        </div>
        
        <div style="background:rgba(167,139,250,.08);border-radius:12px;padding:15px;margin:20px 0;text-align:center;font-size:1.05rem;line-height:1.7">
          <strong>–ß—Ç–æ –¥–∞–ª—å—à–µ:</strong><br>
          –û—Ç–∫—Ä–æ–π –±–æ—Ç–∞ <a href="https://t.me/Yup_Soul_bot" style="color:#a78bfa;text-decoration:underline">@Yup_Soul_bot</a> –≤ Telegram ‚Äî —Ç–∞–º —Ç–µ–±—è –∂–¥—ë—Ç —Ç–≤–æ–π –∑–≤—É–∫–æ–≤–æ–π –∫–ª—é—á.
        </div>
        
        <button class="secondary" id="newKeyBtn" style="margin-top:25px">‚ú® –°–æ–∑–¥–∞—Ç—å –µ—â—ë –æ–¥–∏–Ω –∫–ª—é—á</button>
      </div>
      
      <footer>
        <p>YupSoul ‚Ä¢ 2026</p>
      </footer>
    </div>
    
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var tg = null;
      function initApp() {
        try {
          if (window.Telegram && window.Telegram.WebApp) {
            tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            if (tg.enableClosingConfirmation) tg.enableClosingConfirmation();
            if (tg.themeParams) {
              document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#f9f7ff');
              document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#2d2d2d');
            }
            return true;
          }
        } catch (e) { console.warn('Telegram init:', e); }
        return false;
      }
      if (!initApp()) {
        var attempts = 0;
        var t = setInterval(function() {
          attempts++;
          if (initApp() || attempts >= 50) {
            clearInterval(t);
            if (!tg) showNotFromTelegramBanner();
          }
        }, 100);
      }
      function showNotFromTelegramBanner() {
        var banner = document.createElement('div');
        banner.id = 'not-telegram-banner';
        banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:9999;background:#fef3c7;color:#92400e;padding:12px 16px;text-align:center;font-size:0.95rem;border-bottom:1px solid #f59e0b;';
        banner.textContent = '–û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ —á–∞—Ç–∞ —Å –±–æ—Ç–æ–º –≤ Telegram (–∫–Ω–æ–ø–∫–∞ –º–µ–Ω—é) ‚Äî –∏–Ω–∞—á–µ –∑–∞—è–≤–∫–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è.';
        document.body.insertBefore(banner, document.body.firstChild);
      }
      var userTariff = 'basic';
      var heroesCache = [];
      var editingHeroId = null;
      function heroesApi(path, opts) {
        var base = (window.HEROES_API_BASE || '').replace(/\/$/, '');
        if (!base) return Promise.reject(new Error('API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'));
        var initData = (tg && tg.initData) ? tg.initData : '';
        var url = base + '/api' + path;
        var sep = path.indexOf('?') >= 0 ? '&' : '?';
        if (initData && (!opts || opts.method === 'GET')) url += sep + 'initData=' + encodeURIComponent(initData);
        if (opts && opts.query) url += (url.indexOf('?') >= 0 ? '&' : '?') + opts.query;
        var options = { headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData } };
        if (opts && opts.method) options.method = opts.method;
        if (opts && opts.body) options.body = JSON.stringify(opts.body);
        return fetch(url, options).then(function(r) {
          if (r.status === 204) return null;
          return r.json().then(function(j) { if (!r.ok) throw new Error(j.error || r.statusText); return j; });
        });
      }
      function loadMe() {
        if (!(window.HEROES_API_BASE || '').replace(/\/$/, '')) return;
        heroesApi('/me', { method: 'POST', body: { initData: (tg && tg.initData) || '' } }).then(function(d) {
          userTariff = (d && d.tariff) || 'basic';
          var masterNav = document.getElementById('masterNav');
          if (masterNav && userTariff === 'master') masterNav.style.display = 'block';
        }).catch(function() {});
      }
      if (tg) loadMe();

      setTimeout(function() {
        try {
        if (!tg) {
          var p = document.getElementById('previewNav');
          if (p) p.classList.add('show');
        }
        var birthdateEl = document.getElementById('birthdate');
        if (birthdateEl) {
          var today = new Date();
          birthdateEl.max = today.toISOString().split('T')[0];
          var minDate = new Date();
          minDate.setFullYear(minDate.getFullYear() - 100);
          birthdateEl.min = minDate.toISOString().split('T')[0];
        }
        var unknown = document.getElementById('unknown');
        var birthtime = document.getElementById('birthtime');
        if (unknown && birthtime) unknown.addEventListener('change', function() {
          birthtime.required = !unknown.checked;
        });
        var birthdateSummary = document.getElementById('birthdateSummary');
        var birthdateInput = document.getElementById('birthdate');
        var birthplaceSummary = document.getElementById('birthplaceSummary');
        var birthplaceInput = document.getElementById('birthplace');
        var monthsRu = ['—è–Ω–≤–∞—Ä—è','—Ñ–µ–≤—Ä–∞–ª—è','–º–∞—Ä—Ç–∞','–∞–ø—Ä–µ–ª—è','–º–∞—è','–∏—é–Ω—è','–∏—é–ª—è','–∞–≤–≥—É—Å—Ç–∞','—Å–µ–Ω—Ç—è–±—Ä—è','–æ–∫—Ç—è–±—Ä—è','–Ω–æ—è–±—Ä—è','–¥–µ–∫–∞–±—Ä—è'];
        function formatDateRu(dateStr) {
          if (!dateStr) return '';
          var d = new Date(dateStr + 'T12:00:00');
          if (isNaN(d.getTime())) return dateStr;
          return d.getDate() + ' ' + monthsRu[d.getMonth()] + ' ' + d.getFullYear() + ' –≥.';
        }
        if (birthdateInput && birthdateSummary) {
          birthdateInput.addEventListener('change', function() {
            var v = birthdateInput.value;
            if (v) {
              birthdateSummary.textContent = '–í—ã–±—Ä–∞–Ω–æ: ' + formatDateRu(v);
              birthdateSummary.style.display = 'block';
            } else {
              birthdateSummary.style.display = 'none';
            }
          });
          if (birthdateInput.value) {
            birthdateSummary.textContent = '–í—ã–±—Ä–∞–Ω–æ: ' + formatDateRu(birthdateInput.value);
            birthdateSummary.style.display = 'block';
          }
        }
        if (birthplaceInput && birthplaceSummary) {
          var suggestionsEl = document.getElementById('birthplaceSuggestions');
          var placeCoordsEl = document.getElementById('placeCoords');
          var debounceTimer = null;
          var lastSearch = '';
          function hideSuggestions() {
            if (suggestionsEl) { suggestionsEl.innerHTML = ''; suggestionsEl.setAttribute('aria-hidden', 'true'); suggestionsEl.style.display = 'none'; }
          }
          function escapeHtml(s) {
            if (!s) return '';
            var d = document.createElement('div'); d.textContent = s; return d.innerHTML;
          }
          function formatLatLon(lat, lon) {
            var la = parseFloat(lat); var lo = parseFloat(lon);
            if (isNaN(la) || isNaN(lo)) return '';
            var latStr = Math.abs(la).toFixed(2) + '¬∞ ' + (la >= 0 ? 'N' : 'S');
            var lonStr = Math.abs(lo).toFixed(2) + '¬∞ ' + (lo >= 0 ? 'E' : 'W');
            return latStr + ', ' + lonStr;
          }
          function showPlaceConfirm(displayName) {}
          function selectPlace(displayName, lat, lon) {
            birthplaceInput.value = displayName || '';
            birthplaceInput.setAttribute('data-place-selected', '1');
            if (lat != null && lon != null) {
              birthplaceInput.setAttribute('data-lat', String(lat));
              birthplaceInput.setAttribute('data-lon', String(lon));
            }
            birthplaceSummary.innerHTML = '<span class="place-name">–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è:</span> ' + escapeHtml(displayName || '');
            birthplaceSummary.style.display = 'block';
            if (placeCoordsEl && lat != null && lon != null) {
              placeCoordsEl.textContent = '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ' + formatLatLon(lat, lon);
              placeCoordsEl.style.display = 'block';
            } else if (placeCoordsEl) {
              placeCoordsEl.style.display = 'none';
            }
            showPlaceConfirm(displayName);
            hideSuggestions();
          }
          function clearPlaceSelection() {
            birthplaceInput.removeAttribute('data-place-selected');
            birthplaceInput.removeAttribute('data-lat');
            birthplaceInput.removeAttribute('data-lon');
            if (placeCoordsEl) placeCoordsEl.style.display = 'none';
          }
          function fetchPlaces(q) {
            if (!q || q.length < 2) { hideSuggestions(); return; }
            var url = 'https://nominatim.openstreetmap.org/search?q=' + encodeURIComponent(q) + '&format=json&limit=8&addressdetails=1';
            fetch(url, { headers: { 'Accept': 'application/json', 'Accept-Language': 'ru', 'User-Agent': 'YupSoulMiniApp/1.0 (contact@yupsoul.com)' } })
              .then(function(r) { return r.json(); })
              .then(function(list) {
                if (lastSearch !== q) return;
                if (!suggestionsEl) return;
                suggestionsEl.innerHTML = '';
                (list || []).forEach(function(item) {
                  var li = document.createElement('li');
                  var main = item.display_name || (item.address && (item.address.city || item.address.town || item.address.village || item.address.state || item.address.country));
                  var sub = item.address && item.address.country ? (item.address.country + (item.address.country_code ? ' (' + item.address.country_code.toUpperCase() + ')' : '')) : '';
                  li.textContent = main;
                  if (sub) { var sp = document.createElement('div'); sp.className = 'place-type'; sp.textContent = sub; li.appendChild(sp); }
                  var lat = item.lat; var lon = item.lon;
                  li.addEventListener('click', function() { selectPlace(item.display_name || main, lat, lon); });
                  suggestionsEl.appendChild(li);
                });
                suggestionsEl.style.display = (list && list.length) ? 'block' : 'none';
                suggestionsEl.setAttribute('aria-hidden', list && list.length ? 'false' : 'true');
              })
              .catch(function() { hideSuggestions(); });
          }
          birthplaceInput.addEventListener('input', function() {
            var v = birthplaceInput.value.trim();
            clearPlaceSelection();
            if (v) {
              lastSearch = v;
              clearTimeout(debounceTimer);
              debounceTimer = setTimeout(function() { fetchPlaces(v); }, 320);
              if (!suggestionsEl || suggestionsEl.style.display !== 'block') {
                birthplaceSummary.innerHTML = '–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ –∏–∑ —Å–ø–∏—Å–∫–∞ ‚Äî —Ç–∞–∫ –¥–µ–ª–∞—é—Ç –≤—Å–µ —Å–µ—Ä—å—ë–∑–Ω—ã–µ –∞—Å—Ç—Ä–æ—Å–µ—Ä–≤–∏—Å—ã.';
                birthplaceSummary.style.display = 'block';
                showPlaceConfirm(v);
              }
            } else {
              hideSuggestions();
              birthplaceSummary.style.display = 'none';
            }
          });
          birthplaceInput.addEventListener('focus', function() {
            var v = birthplaceInput.value.trim();
            if (v && v.length >= 2) { lastSearch = v; fetchPlaces(v); }
          });
          birthplaceInput.addEventListener('blur', function() {
            setTimeout(hideSuggestions, 200);
            var v = birthplaceInput.value.trim();
            if (v) {
              if (birthplaceInput.getAttribute('data-place-selected')) {
                birthplaceSummary.innerHTML = '<span class="place-name">–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è:</span> ' + escapeHtml(v);
                if (placeCoordsEl && birthplaceInput.getAttribute('data-lat')) {
                  placeCoordsEl.textContent = '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ' + formatLatLon(birthplaceInput.getAttribute('data-lat'), birthplaceInput.getAttribute('data-lon'));
                  placeCoordsEl.style.display = 'block';
                }
              } else {
                birthplaceSummary.innerHTML = '–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ –∏–∑ —Å–ø–∏—Å–∫–∞.';
                if (placeCoordsEl) placeCoordsEl.style.display = 'none';
              }
              birthplaceSummary.style.display = 'block';
              showPlaceConfirm(v);
            }
          });
          if (birthplaceInput.value.trim()) {
            if (birthplaceInput.getAttribute('data-place-selected')) {
              birthplaceSummary.innerHTML = '<span class="place-name">–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è:</span> ' + escapeHtml(birthplaceInput.value.trim());
              if (placeCoordsEl && birthplaceInput.getAttribute('data-lat')) {
                placeCoordsEl.textContent = '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ' + formatLatLon(birthplaceInput.getAttribute('data-lat'), birthplaceInput.getAttribute('data-lon'));
                placeCoordsEl.style.display = 'block';
              }
            } else {
              birthplaceSummary.innerHTML = '–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ –∏–∑ —Å–ø–∏—Å–∫–∞.';
            }
            birthplaceSummary.style.display = 'block';
            showPlaceConfirm(birthplaceInput.value.trim());
          }
        }
        var formPage = document.getElementById('formPage');
        if (formPage && userTariff === 'master') loadForWhoSelect();
      
      // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
      function goToPage(pageId) {
        if (tg && tg.MainButton && tg.MainButton.hide) tg.MainButton.hide();
        if (pageId !== 'paymentPage') {
          var payBtnReset = document.getElementById('payBtn');
          if (payBtnReset) { payBtnReset.disabled = false; payBtnReset.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É'; }
        }
        document.querySelectorAll('.page').forEach(function(page) {
          page.classList.remove('active');
        });
        var target = document.getElementById(pageId);
        if (target) target.classList.add('active');
        if (pageId === 'formPage' && userTariff === 'master') loadForWhoSelect();
        if (document.getElementById('previewNav') && document.getElementById('previewNav').classList.contains('show')) {
          document.querySelectorAll('.preview-nav button').forEach(function(btn) {
            btn.classList.remove('active');
          });
          var pageMap = { 'homePage': 'home', 'formPage': 'form', 'paymentPage': 'payment', 'loadingPage': 'loading', 'successPage': 'success', 'heroesPage': 'heroes' };
          var activeBtn = document.querySelector('.preview-nav button[data-page="' + (pageMap[pageId] || '') + '"]');
          if (activeBtn) activeBtn.classList.add('active');
        }
      }
      
      // –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
      var startBtn = document.getElementById('startBtn');
      var backBtn = document.getElementById('backBtn');
      var nextBtn = document.getElementById('nextBtn');
      if (startBtn) startBtn.addEventListener('click', function() { goToPage('formPage'); });
      if (backBtn) backBtn.addEventListener('click', function() { goToPage('homePage'); });
      if (nextBtn) nextBtn.addEventListener('click', function() {
        var name = document.getElementById('name').value.trim();
        var birthdate = document.getElementById('birthdate').value;
        var birthplace = document.getElementById('birthplace').value.trim();
        var birthtimeVal = (unknown && unknown.checked) ? 'ok' : (document.getElementById('birthtime') ? document.getElementById('birthtime').value : '');
        var gender = document.getElementById('gender').value;
        var request = document.getElementById('request').value.trim();
        
        if (name.length < 2) {
          alert('–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞');
          return;
        }
        if (!birthdate) {
          alert('–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è');
          return;
        }
        if (birthplace.length < 3) {
          alert('–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞');
          return;
        }
        var birthplaceField = document.getElementById('birthplace');
        if (!(birthplaceField && birthplaceField.getAttribute('data-place-selected'))) {
          alert('–ö–∞–∫ –≤ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∞—Å—Ç—Ä–æ—Å–µ—Ä–≤–∏—Å–∞—Ö: –≤—ã–±–µ—Ä–∏ –º–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫ (–Ω–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å –≥–æ—Ä–æ–¥ –∏ –Ω–∞–∂–º–∏ –Ω–∞ –Ω—É–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç). –¢–∞–∫ –º—ã –∏–∑–±–µ–≥–∞–µ–º –æ—à–∏–±–æ–∫ –≤ —Ä–∞—Å—á—ë—Ç–µ –∫–∞—Ä—Ç—ã.');
          return;
        }
        var btVal = document.getElementById('birthtime');
        if (!birthtimeVal || (!(unknown && unknown.checked) && (!btVal || !btVal.value))) {
          alert('–£–∫–∞–∂–∏ –≤—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è –∏–ª–∏ –æ—Ç–º–µ—Ç—å "–ù–µ –∑–Ω–∞—é"');
          return;
        }
        if (!gender) {
          alert('–í—ã–±–µ—Ä–∏ –ø–æ–ª');
          return;
        }
        var language = document.getElementById('language') && document.getElementById('language').value;
        if (!language) {
          alert('–í—ã–±–µ—Ä–∏ —è–∑—ã–∫, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –ø–µ—Å–Ω—è –∏ –æ–ø–∏—Å–∞–Ω–∏–µ');
          return;
        }
        if (request.length < 10) {
          alert('–ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤');
          return;
        }
        
        goToPage('paymentPage');
      });
      
      var backFromPaymentBtn = document.getElementById('backFromPaymentBtn');
      if (backFromPaymentBtn) backFromPaymentBtn.addEventListener('click', function() {
        if (tg && tg.MainButton && tg.MainButton.hide) tg.MainButton.hide();
        var payBtnEl = document.getElementById('payBtn');
        if (payBtnEl) { payBtnEl.disabled = false; payBtnEl.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É'; }
        goToPage('formPage');
      });
      var payBtn = document.getElementById('payBtn');
      if (payBtn) payBtn.addEventListener('click', function() {
        if (payBtn.disabled) return;
        
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
        var forWho = document.getElementById('forWho');
        var clientId = (forWho && forWho.value && userTariff === 'master') ? forWho.value : null;
        var birthplaceField = document.getElementById('birthplace');
        var birthplaceLat = birthplaceField && birthplaceField.getAttribute('data-lat') ? parseFloat(birthplaceField.getAttribute('data-lat')) : null;
        var birthplaceLon = birthplaceField && birthplaceField.getAttribute('data-lon') ? parseFloat(birthplaceField.getAttribute('data-lon')) : null;
        
        var payload = {
          name: document.getElementById('name').value.trim(),
          birthdate: document.getElementById('birthdate').value,
          birthplace: document.getElementById('birthplace').value.trim(),
          birthtime: document.getElementById('birthtime').value,
          birthtimeUnknown: document.getElementById('unknown').checked,
          gender: document.getElementById('gender').value,
          language: (document.getElementById('language') && document.getElementById('language').value) || 'ru',
          request: document.getElementById('request').value.trim(),
          initData: (tg && tg.initData) || ''
        };
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º–µ—Å—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å
        if (birthplaceLat != null && birthplaceLon != null) {
          payload.birthplaceLat = birthplaceLat;
          payload.birthplaceLon = birthplaceLon;
        }
        
        if (clientId) payload.clientId = clientId;
        
        console.log('[YupSoul] –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏:', { name: payload.name, birthplace: payload.birthplace, hasCoords: (birthplaceLat != null && birthplaceLon != null) });
        
        // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ Telegram sendData
        console.log('[YupSoul] –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram API:', { 
          tg: !!tg, 
          MainButton: !!(tg && tg.MainButton), 
          sendData: !!(tg && tg.sendData),
          initData: !!(tg && tg.initData)
        });
        if (tg && tg.MainButton && tg.sendData) {
          console.log('[YupSoul] ‚úÖ Telegram WebApp API –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º MainButton');
          try {
            // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –±—ã–ª
            if (tg.MainButton.offClick) {
              try { tg.MainButton.offClick(); } catch (e) { console.warn('[YupSoul] offClick error:', e); }
            }
            
            tg.MainButton.setText('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –≤–æ –í—Å–µ–ª–µ–Ω–Ω—É—é');
            tg.MainButton.show();
            console.log('[YupSoul] MainButton –ø–æ–∫–∞–∑–∞–Ω–∞, –∂–¥—ë–º –Ω–∞–∂–∞—Ç–∏—è');
            
            var sent = false;
            var sendAttempted = false;
            
            tg.MainButton.onClick(function() {
              if (sent) {
                console.log('[YupSoul] MainButton onClick: —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º');
                return;
              }
              
              sendAttempted = true;
              console.log('[YupSoul] MainButton onClick: –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏ —á–µ—Ä–µ–∑ sendData');
              
              try {
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                if (tg.MainButton && tg.MainButton.hide) {
                  tg.MainButton.hide();
                }
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                var payloadStr = JSON.stringify(payload);
                console.log('[YupSoul] sendData –≤—ã–∑–≤–∞–Ω, –¥–ª–∏–Ω–∞ –¥–∞–Ω–Ω—ã—Ö:', payloadStr.length);
                
                try {
                  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –°–†–ê–ó–£ - sendData –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                  console.log('[YupSoul] ‚ö†Ô∏è –í–´–ó–´–í–ê–Æ sendData, payload:', JSON.stringify(payload).substring(0, 200));
                  tg.sendData(payloadStr);
                  console.log('[YupSoul] ‚úÖ sendData –≤—ã–∑–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ, –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Telegram, –¥–ª–∏–Ω–∞:', payloadStr.length);
                  
                  // sendData –≤ Telegram WebApp API –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
                  // –ù–æ –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ –æ—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –∑–∞–∫—Ä—ã—Ç–∏–∏ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                  // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Ç–æ—á–Ω–æ —É—Å–ø–µ–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è
                  setTimeout(function() {
                    try {
                      if (tg && tg.disableClosingConfirmation) {
                        tg.disableClosingConfirmation();
                        console.log('[YupSoul] –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –∑–∞–∫—Ä—ã—Ç–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω–æ - –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å');
                      }
                    } catch (e) {
                      console.warn('[YupSoul] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:', e);
                    }
                  }, 300); // 300–º—Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ sendData
                  
                } catch (sendErr) {
                  console.error('[YupSoul] –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ sendData:', sendErr);
                  // –ï—Å–ª–∏ sendData –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º fallback
                  sendViaFallback(payload);
                  return; // –í—ã—Ö–æ–¥–∏–º, —á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—Å–ø–µ—Ö–∞
                }
                
                sent = true;
                console.log('[YupSoul] sendData –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—Å–ø–µ—Ö–∞
                var msg = '‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!\n\n–ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Äî –¥–∞–Ω–Ω—ã–µ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.';
                var sp = document.getElementById('songPreviewText');
                if (sp) sp.textContent = msg + '\n\n–ö–æ–≥–¥–∞ –ø–µ—Å–Ω—è –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞ ‚Äî –ø—Ä–∏–¥—ë—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º.';
                goToPage('successPage');
                
                // –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - –ø—É—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –∑–∞–∫—Ä–æ–µ—Ç –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ —É–≤–∏–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
                // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Ç–æ—á–Ω–æ –æ—Ç–ø—Ä–∞–≤—è—Ç—Å—è
                // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –º–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –Ω–∏–∂–µ —Å –±–æ–ª—å—à–µ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
                /*
                setTimeout(function() {
                  try {
                    if (tg && tg.close) {
                      console.log('[YupSoul] –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
                      tg.close();
                    }
                  } catch (e) {
                    console.warn('[YupSoul] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏:', e);
                  }
                }, 5000); // –£–≤–µ–ª–∏—á–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–æ 5 —Å–µ–∫—É–Ω–¥
                */
                
              } catch (sendError) {
                console.error('[YupSoul] –û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ MainButton:', sendError);
                // –ï—Å–ª–∏ sendData –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±
                sendViaFallback(payload);
              }
            });
            
            payBtn.disabled = true;
            payBtn.textContent = '–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞ ‚Üí';
            
            // –¢–∞–π–º–∞—É—Ç –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–∂–º—ë—Ç –∫–Ω–æ–ø–∫—É
            setTimeout(function() {
              if (!sendAttempted && !sent) {
                console.warn('[YupSoul] –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è MainButton, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback');
                if (tg.MainButton && tg.MainButton.hide) {
                  try { tg.MainButton.hide(); } catch (e) {}
                }
                sendViaFallback(payload);
              }
            }, 30000); // 30 —Å–µ–∫—É–Ω–¥
            
          } catch (e) {
            console.error('[YupSoul] –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ MainButton:', e);
            sendViaFallback(payload);
          }
        } else {
          console.warn('[YupSoul] Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback');
          sendViaFallback(payload);
        }
        
        // –§—É–Ω–∫—Ü–∏—è fallback –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏ (–µ—Å–ª–∏ sendData –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
        function sendViaFallback(payloadData) {
          console.log('[YupSoul] –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback –º–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏');
          goToPage('loadingPage');
          
          // –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ POST API, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
          var backendUrl = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
          if (backendUrl) {
            var apiUrl = backendUrl + '/api/submit-request';
            console.log('[YupSoul] –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ API:', apiUrl);
            
            fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payloadData)
            })
            .then(function(response) {
              if (!response.ok) throw new Error('HTTP ' + response.status);
              return response.json();
            })
            .then(function(data) {
              console.log('[YupSoul] –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ API:', data);
              
              // –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ API
              if (tg && tg.disableClosingConfirmation) {
                setTimeout(function() {
                  try {
                    tg.disableClosingConfirmation();
                    console.log('[YupSoul] –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –∑–∞–∫—Ä—ã—Ç–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω–æ (API)');
                  } catch (e) {
                    console.warn('[YupSoul] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (API):', e);
                  }
                }, 300);
              }
              
              var sp = document.getElementById('songPreviewText');
              if (sp) sp.textContent = '‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!\n\n–ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Äî –¥–∞–Ω–Ω—ã–µ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.\n\n–ö–æ–≥–¥–∞ –ø–µ—Å–Ω—è –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞ ‚Äî –ø—Ä–∏–¥—ë—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º.';
              goToPage('successPage');
            })
            .catch(function(error) {
              console.error('[YupSoul] –û—à–∏–±–∫–∞ API:', error);
              var sp = document.getElementById('songPreviewText');
              if (sp) sp.textContent = '–ó–∞—è–≤–∫–∞ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞. –û–∂–∏–¥–∞–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ —á–∞—Ç–µ —Å –±–æ—Ç–æ–º.';
              goToPage('successPage');
            });
          } else {
            // –ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            setTimeout(function() {
              var nameEl = document.getElementById('name');
              var reqEl = document.getElementById('request');
              var name = nameEl ? nameEl.value.trim() : '';
              var request = reqEl ? reqEl.value.trim() : '';
              if (!name) name = '–î—Ä—É–≥';
              if (!request) request = '—Ç–≤–æ–∏ —Ü–µ–ª–∏';
              var songText = '‚ú® ' + name + ', —Ç–≤–æ—è –ø–µ—Å–Ω—è —Å–æ–∑–¥–∞–Ω–∞!\n\n–ù–∞ –æ—Å–Ω–æ–≤–µ —Ç–≤–æ–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ \"' + request.substring(0, 30) + '...\" —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –∞—É–¥–∏–æ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è.\n\n–≠—Ç–æ —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∑–≤—É–∫–æ–≤–æ–π –∫–ª—é—á ‚Äî –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —Å–∏–ª—ã –¥–ª—è –∏–≥—Ä—ã –∂–∏–∑–Ω–∏.';
              var sp = document.getElementById('songPreviewText');
              if (sp) sp.textContent = songText;
              goToPage('successPage');
            }, 1500);
          }
        }
      });
      
      var goHeroesBtn = document.getElementById('goHeroesBtn');
      if (goHeroesBtn) goHeroesBtn.addEventListener('click', function() { goToPage('heroesPage'); loadHeroesList(); });

      function loadHeroesList() {
        var listEl = document.getElementById('heroesList');
        if (!listEl) return;
        listEl.innerHTML = '<p style="color:#6b7280">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
        var search = (document.getElementById('heroesSearch') || {}).value;
        var q = search ? '?search=' + encodeURIComponent(search) : '';
        heroesApi('/heroes' + q, { method: 'GET' }).then(function(d) {
          heroesCache = (d && d.clients) || [];
          if (!heroesCache.length) { listEl.innerHTML = '<p style="color:#6b7280">–ü–æ–∫–∞ –Ω–µ—Ç –≥–µ—Ä–æ–µ–≤. –ù–∞–∂–º–∏ ¬´–î–æ–±–∞–≤–∏—Ç—å –≥–µ—Ä–æ—è¬ª.</p>'; return; }
          listEl.innerHTML = heroesCache.map(function(h) {
            var dateStr = h.birth_date || '‚Äî';
            var addStr = h.created_at ? new Date(h.created_at).toLocaleDateString('ru-RU') : '';
            return '<div class="section" style="margin-bottom:12px" data-hero-id="' + (h.id || '') + '">' +
              '<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">' +
              '<strong>' + (h.name || '‚Äî') + '</strong>' +
              '<span style="font-size:.9rem;color:#6b7280">' + dateStr + (addStr ? ' ¬∑ ' + addStr : '') + '</span>' +
              '</div>' +
              (h.birth_place ? '<div style="font-size:.95rem;color:#6b7280;margin-top:6px">' + h.birth_place + '</div>' : '') +
              '<div style="margin-top:10px;display:flex;gap:8px">' +
              '<button type="button" class="secondary hero-edit-btn" style="padding:8px 14px;font-size:.9rem" data-id="' + (h.id || '') + '">–ò–∑–º–µ–Ω–∏—Ç—å</button>' +
              '<button type="button" class="secondary hero-delete-btn" style="padding:8px 14px;font-size:.9rem;color:#dc2626" data-id="' + (h.id || '') + '" data-name="' + (h.name || '').replace(/"/g, '&quot;') + '">–£–¥–∞–ª–∏—Ç—å</button>' +
              '</div></div>';
          }).join('');
          listEl.querySelectorAll('.hero-edit-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              var id = btn.getAttribute('data-id');
              var h = heroesCache.find(function(c) { return c.id === id; });
              if (!h) return;
              editingHeroId = id;
              document.getElementById('heroName').value = h.name || '';
              document.getElementById('heroBirthdate').value = h.birth_date || '';
              document.getElementById('heroBirthtime').value = (h.birth_time || '').substring(0, 5);
              document.getElementById('heroBirthplace').value = h.birth_place || '';
              document.getElementById('heroBirthtimeUnknown').checked = !!h.birthtime_unknown;
              document.getElementById('heroGender').value = h.gender || '';
              document.getElementById('heroNotes').value = h.notes || '';
              document.getElementById('heroFormWrap').style.display = 'block';
            });
          });
          listEl.querySelectorAll('.hero-delete-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              var id = btn.getAttribute('data-id');
              var name = btn.getAttribute('data-name') || '—ç—Ç–æ–≥–æ –≥–µ—Ä–æ—è';
              if (!confirm('–£–¥–∞–ª–∏—Ç—å ¬´' + name + '¬ª? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
              heroesApi('/heroes/' + id, { method: 'DELETE' }).then(function() { loadHeroesList(); }).catch(function(e) { alert('–û—à–∏–±–∫–∞: ' + (e.message || e)); });
            });
          });
        }).catch(function(e) {
          listEl.innerHTML = '<p style="color:#dc2626">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É API.</p>';
        });
      }
      var addHeroBtn = document.getElementById('addHeroBtn');
      var heroFormWrap = document.getElementById('heroFormWrap');
      var heroFormCancel = document.getElementById('heroFormCancel');
      if (addHeroBtn) addHeroBtn.addEventListener('click', function() {
        editingHeroId = null;
        document.getElementById('heroName').value = '';
        document.getElementById('heroBirthdate').value = '';
        document.getElementById('heroBirthtime').value = '';
        document.getElementById('heroBirthplace').value = '';
        document.getElementById('heroBirthtimeUnknown').checked = false;
        document.getElementById('heroGender').value = '';
        document.getElementById('heroNotes').value = '';
        heroFormWrap.style.display = 'block';
      });
      if (heroFormCancel) heroFormCancel.addEventListener('click', function() { heroFormWrap.style.display = 'none'; editingHeroId = null; });
      var heroFormSave = document.getElementById('heroFormSave');
      if (heroFormSave) heroFormSave.addEventListener('click', function() {
        var name = (document.getElementById('heroName') || {}).value.trim();
        if (!name) { alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è'); return; }
        var payload = {
          initData: (tg && tg.initData) || '',
          name: name,
          birth_date: (document.getElementById('heroBirthdate') || {}).value || null,
          birth_time: (document.getElementById('heroBirthtime') || {}).value || null,
          birth_place: (document.getElementById('heroBirthplace') || {}).value.trim() || null,
          birthtime_unknown: (document.getElementById('heroBirthtimeUnknown') || {}).checked,
          gender: (document.getElementById('heroGender') || {}).value || null,
          notes: (document.getElementById('heroNotes') || {}).value.trim() || null
        };
        if (editingHeroId) {
          heroesApi('/heroes/' + editingHeroId, { method: 'PATCH', body: payload }).then(function() {
            heroFormWrap.style.display = 'none';
            editingHeroId = null;
            loadHeroesList();
          }).catch(function(e) { alert('–û—à–∏–±–∫–∞: ' + (e.message || e)); });
        } else {
          heroesApi('/heroes', { method: 'POST', body: payload }).then(function() {
            heroFormWrap.style.display = 'none';
            loadHeroesList();
          }).catch(function(e) { alert('–û—à–∏–±–∫–∞: ' + (e.message || e)); });
        }
      });
      var heroesSearchBtn = document.getElementById('heroesSearchBtn');
      if (heroesSearchBtn) heroesSearchBtn.addEventListener('click', loadHeroesList);
      var heroesBackBtn = document.getElementById('heroesBackBtn');
      if (heroesBackBtn) heroesBackBtn.addEventListener('click', function() { goToPage('homePage'); });
      var todayHero = new Date();
      var heroBirthdateEl = document.getElementById('heroBirthdate');
      if (heroBirthdateEl) {
        heroBirthdateEl.max = todayHero.toISOString().split('T')[0];
        var minH = new Date(); minH.setFullYear(minH.getFullYear() - 100);
        heroBirthdateEl.min = minH.toISOString().split('T')[0];
      }

      function fillFormFromHero(hero) {
        if (!hero) return;
        var nameEl = document.getElementById('name');
        var bd = document.getElementById('birthdate');
        var bt = document.getElementById('birthtime');
        var bp = document.getElementById('birthplace');
        var unk = document.getElementById('unknown');
        var g = document.getElementById('gender');
        if (nameEl) nameEl.value = hero.name || '';
        if (bd) bd.value = hero.birth_date || '';
        if (bt) bt.value = (hero.birth_time || '').substring(0, 5);
        if (bp) bp.value = hero.birth_place || '';
        if (unk) unk.checked = !!hero.birthtime_unknown;
        if (g) g.value = hero.gender || '';
        var langEl = document.getElementById('language');
        if (langEl && hero.language) langEl.value = hero.language;
        if (birthdateSummary) { birthdateSummary.textContent = hero.birth_date ? '–í—ã–±—Ä–∞–Ω–æ: ' + formatDateRu(hero.birth_date) : ''; birthdateSummary.style.display = hero.birth_date ? 'block' : 'none'; }
        if (birthplaceSummary) { birthplaceSummary.textContent = hero.birth_place ? '–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è: ' + hero.birth_place : ''; birthplaceSummary.style.display = hero.birth_place ? 'block' : 'none'; }
      }
      function loadForWhoSelect() {
        var wrap = document.getElementById('forWhoWrap');
        var sel = document.getElementById('forWho');
        if (!wrap || !sel) return;
        if (userTariff !== 'master') { wrap.style.display = 'none'; return; }
        wrap.style.display = 'block';
        heroesApi('/heroes', { method: 'GET' }).then(function(d) {
          heroesCache = (d && d.clients) || [];
          sel.innerHTML = '<option value="">–î–ª—è —Å–µ–±—è</option>' + heroesCache.map(function(h) { return '<option value="' + (h.id || '') + '">–î–ª—è: ' + (h.name || '‚Äî') + '</option>'; }).join('');
          sel.addEventListener('change', function() {
            var id = sel.value;
            if (!id) { fillFormFromHero(null); return; }
            var hero = heroesCache.find(function(c) { return c.id === id; });
            if (hero) fillFormFromHero(hero);
          });
        }).catch(function() { wrap.style.display = 'none'; });
      }

      var newKeyBtn = document.getElementById('newKeyBtn');
      if (newKeyBtn) newKeyBtn.addEventListener('click', function() {
        var n = document.getElementById('name');
        var bd = document.getElementById('birthdate');
        var bp = document.getElementById('birthplace');
        var bt = document.getElementById('birthtime');
        var g = document.getElementById('gender');
        var langEl = document.getElementById('language');
        var r = document.getElementById('request');
        if (n) n.value = '';
        if (bd) bd.value = '';
        if (bp) bp.value = '';
        if (bt) bt.value = '';
        if (unknown) unknown.checked = false;
        if (g) g.value = '';
        if (langEl) langEl.value = '';
        if (r) r.value = '';
        if (birthdateSummary) birthdateSummary.style.display = 'none';
        if (birthplaceSummary) birthplaceSummary.style.display = 'none';
        goToPage('formPage');
      });
      
      document.querySelectorAll('.preview-nav button').forEach(function(button) {
        button.addEventListener('click', function() {
          var pageMap = { 'home': 'homePage', 'form': 'formPage', 'payment': 'paymentPage', 'loading': 'loadingPage', 'success': 'successPage', 'heroes': 'heroesPage' };
          document.querySelectorAll('.preview-nav button').forEach(function(btn) { btn.classList.remove('active'); });
          this.classList.add('active');
          goToPage(pageMap[button.getAttribute('data-page')] || 'homePage');
        });
      });
        } catch (e) {
          console.warn('App init error:', e);
        }
      }, 50);
    });
  </script>
</body>
</html>
