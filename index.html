<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>YupSoul</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- URL –±–æ—Ç–∞ —Å API –∑–∞—è–≤–æ–∫ (Render). –ó–∞—è–≤–∫–∏ –∏–¥—É—Ç —á–µ—Ä–µ–∑ POST /api/submit-request. -->
  <script>window.HEROES_API_BASE = 'https://telegram-miniapp-ar09.onrender.com'; window.BACKEND_URL = window.HEROES_API_BASE;</script>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* –ê–î–ê–ü–¢–ò–í–ù–´–ï –°–¢–ò–õ–ò –° –ü–û–î–î–ï–†–ñ–ö–û–ô –¢–ï–ú–´ –¢–ï–õ–ï–ì–†–ê–ú */
    :root {
      --primary-color: #d4af37;
      --secondary-color: #ec4899;
      --success-color: #10b981;
      /* –±–∞–∑–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–º—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (dark premium) */
      --tg-theme-bg-color: #0A0A1A;
      --tg-theme-secondary-bg-color: rgba(255,255,255,0.08);
      --tg-theme-text-color: #ffffff;
      --tg-theme-hint-color: rgba(224, 224, 240, 0.7);
      --tg-theme-border-color: rgba(212, 175, 55, 0.3);
      --tg-theme-button-color: #d4af37;
      --tg-theme-button-text-color: #0A0A1A;
    }
    .theme-light {
      --tg-theme-bg-color: #f5f3ff;
      --tg-theme-secondary-bg-color: rgba(255,255,255,0.92);
      --tg-theme-text-color: #1f2937;
      --tg-theme-hint-color: rgba(31, 41, 55, 0.6);
      --tg-theme-border-color: rgba(212,175,55,0.35);
      --tg-theme-button-color: #d4af37;
      --tg-theme-button-text-color: #1f2937;
    }
    .theme-dark {
      --tg-theme-bg-color: #0A0A1A;
      --tg-theme-secondary-bg-color: rgba(255,255,255,0.08);
      --tg-theme-text-color: #ffffff;
      --tg-theme-hint-color: rgba(224,224,240,0.7);
      --tg-theme-border-color: rgba(212,175,55,0.3);
      --tg-theme-button-color: #d4af37;
      --tg-theme-button-text-color: #0A0A1A;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    body {
      background: var(--tg-theme-bg-color) url('assets/bg-yupsoul.png') center/cover no-repeat fixed !important;
      color: var(--tg-theme-text-color) !important;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px 15px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content:"";position:fixed;inset:0;z-index:0;
      background:
        radial-gradient(circle at 20% 30%, rgba(212,175,55,0.08), transparent 55%),
        radial-gradient(circle at 80% 70%, rgba(236,72,153,0.06), transparent 60%),
        linear-gradient(135deg, rgba(212,175,55,0.08), rgba(0,0,0,0.2));
      pointer-events:none;
    }
    body::after {
      content:"";position:fixed;inset:0;z-index:0;background:
        radial-gradient(1px 1px at 20% 20%, rgba(255,255,255,0.7), transparent 40px),
        radial-gradient(1px 1px at 40% 60%, rgba(255,255,255,0.5), transparent 40px),
        radial-gradient(1px 1px at 70% 30%, rgba(255,255,255,0.8), transparent 40px),
        radial-gradient(1px 1px at 85% 80%, rgba(255,255,255,0.4), transparent 40px);
      opacity:0.4;
      animation: stars 5s linear infinite;
      pointer-events:none;
    }
    @keyframes stars { 0%{opacity:0.3;} 50%{opacity:0.8;} 100%{opacity:0.3;} }
    .content-wrapper { max-width: 600px; margin: 0 auto; padding: 20px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; color: var(--tg-theme-text-color, #fff); font-size: 14px; margin-bottom: 8px; font-weight: 500; }
    input::placeholder, textarea::placeholder { color: var(--tg-theme-hint-color, rgba(255,255,255,.45)); opacity: .85; }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 12px 16px; background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.05));
      border: 1px solid var(--tg-theme-border-color, rgba(255, 255, 255, 0.1)); border-radius: 8px;
      color: var(--tg-theme-text-color, #fff); font-size: 14px; box-sizing: border-box;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none; border-color: var(--tg-theme-button-color, #8b5cf6); box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
    }
    .checkbox-group { display: flex; align-items: center; margin-top: 8px; }
    .checkbox-group input[type="checkbox"] { width: 18px; height: 18px; margin-right: 8px; cursor: pointer; }
    .checkbox-group label { margin: 0; font-size: 13px; color: var(--tg-theme-text-color, #fff); opacity: 0.9; }
    small { color: var(--tg-theme-hint-color, rgba(255, 255, 255, 0.6)); font-size: 12px; }
    h3 { color: var(--tg-theme-text-color, #fff); font-size: 18px; margin: 0 0 15px 0; font-weight: 600; }
    #payBtn {
      width: 100%; padding: 16px; background: linear-gradient(135deg, var(--tg-theme-button-color, #8b5cf6), #ec4899);
      border: none; border-radius: 10px; color: var(--tg-theme-button-text-color, #fff); font-size: 16px; font-weight: 600;
      cursor: pointer; transition: all 0.3s; margin-top: 20px; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
    }
    #payBtn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4); }
    #payBtn:active { transform: translateY(0); }
    .form-section {
      background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.05)); border-radius: 12px; padding: 20px; margin-bottom: 20px;
      border: 1px solid var(--tg-theme-border-color, rgba(255, 255, 255, 0.1));
    }
    .request-examples {
      margin: 20px 0; padding: 15px; background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.05));
      border-radius: 12px; border: 1px solid var(--tg-theme-border-color, rgba(255, 255, 255, 0.1));
    }
    .request-examples h3 { font-size: 16px; color: var(--tg-theme-text-color, #fff); margin: 0 0 12px 0; font-weight: 500; }
    .examples-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; }
    .example-btn {
      background: var(--tg-theme-button-color, #8b5cf6); border: 1px solid var(--tg-theme-button-color, #8b5cf6);
      color: var(--tg-theme-button-text-color, #fff); padding: 10px 12px; border-radius: 8px; font-size: 12px;
      cursor: pointer; text-align: left; transition: all 0.2s; width: 100%;
    }
    .example-btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .example-btn.special { background: var(--tg-theme-button-color, #8b5cf6); border-color: var(--tg-theme-button-color, #8b5cf6); }
    .mode-selector {
      margin: 20px 0; padding: 15px; background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.05));
      border-radius: 12px; border: 1px solid var(--tg-theme-border-color, rgba(255, 255, 255, 0.1));
    }
    .mode-selector h3 { font-size: 16px; color: var(--tg-theme-text-color, #fff); margin: 0 0 15px 0; font-weight: 500; text-align: center; }
    .mode-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .mode-btn {
      background: var(--tg-theme-bg-color, #1a1a1a); border: 2px solid var(--tg-theme-border-color, rgba(255, 255, 255, 0.1));
      color: var(--tg-theme-text-color, #fff); padding: 16px 12px; border-radius: 10px; cursor: pointer; transition: all 0.3s;
      text-align: center; font-size: 14px; line-height: 1.4;
    }
    .mode-btn:hover {
      background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.1)); border-color: var(--tg-theme-button-color, #8b5cf6);
      transform: translateY(-2px);
    }
    .mode-btn.active {
      background: linear-gradient(135deg, var(--tg-theme-button-color, #8b5cf6), #ec4899);
      border-color: var(--tg-theme-button-color, #8b5cf6); color: var(--tg-theme-button-text-color, #fff);
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
    }
    .mode-icon { font-size: 28px; display: block; margin: 0 auto 8px; }
    .mode-label { font-weight: 600; font-size: 14px; display: block; margin: 0 0 4px; }
    .mode-desc { font-size: 11px; opacity: 0.8; display: block; margin-top: 4px; }
    .location-input-wrapper { position: relative; }
    .location-input {
      width: 100%; padding: 12px 16px; background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.05));
      border: 1px solid var(--tg-theme-border-color, rgba(255, 255, 255, 0.1)); border-radius: 8px;
      color: var(--tg-theme-text-color, #fff); font-size: 14px; box-sizing: border-box;
    }
    .location-input:focus {
      outline: none; border-color: var(--tg-theme-button-color, #8b5cf6); box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
    }
    .location-suggestions {
      position: absolute; z-index: 1000; background: var(--tg-theme-bg-color, #1a1a1a);
      border: 1px solid var(--tg-theme-border-color, rgba(255, 255, 255, 0.1)); border-radius: 8px;
      max-height: 200px; overflow-y: auto; width: 100%; margin-top: 4px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      display: none;
    }
    .location-suggestion {
      padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--tg-theme-border-color, rgba(255, 255, 255, 0.1));
      color: var(--tg-theme-text-color, #fff); font-size: 14px; transition: background 0.2s;
    }
    .location-suggestion:hover { background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.1)); }
    .location-suggestion:last-child { border-bottom: none; }
    .stepper {
      display: flex; gap: 8px; align-items: center; margin-bottom: 16px; position: relative;
    }
    .step-line {
      position: absolute; left: 12px; right: 12px; height: 2px; background: var(--tg-theme-border-color); top: 18px; z-index: 0;
    }
    .step-indicator {
      position: relative; z-index: 1; padding: 8px 12px; border-radius: 10px; border: 1px solid var(--tg-theme-border-color);
      background: var(--tg-theme-secondary-bg-color); color: var(--tg-theme-text-color); font-weight: 600; font-size: 13px;
      flex: 1; text-align: center;
    }
    .step-indicator.active {
      border-color: var(--tg-theme-button-color); background: linear-gradient(135deg, var(--tg-theme-button-color), #ec4899);
      color: var(--tg-theme-button-text-color); box-shadow: 0 6px 18px rgba(139,92,246,0.25);
    }
    .step-panel { margin-top: 4px; }
    .step-nav { display: flex; gap: 12px; margin-top: 16px; }
    .step-nav button { flex: 1; text-transform: none; letter-spacing: 0; }
    @media (max-width: 480px) {
      .mode-buttons { grid-template-columns: 1fr; }
      .examples-grid { grid-template-columns: 1fr; }
      .mode-btn { padding: 14px 10px; }
      .mode-icon { font-size: 24px; }
      .content-wrapper { padding: 15px; }
      #payBtn { padding: 14px; font-size: 15px; }
    }
    @media (min-width: 481px) and (max-width: 768px) {
      .mode-buttons { grid-template-columns: repeat(2, 1fr); }
      .examples-grid { grid-template-columns: repeat(2, 1fr); }
    }
    /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Comfortaa',sans-serif}
    body::before{content:"";position:fixed;inset:0;background:linear-gradient(180deg,rgba(1,6,26,.62) 0%,rgba(8,10,38,.78) 100%);z-index:0}
    .container{max-width:600px;margin:0 auto;width:100%;position:relative;z-index:1}
    .page{display:none;min-height:100vh;padding-top:20px}
    .page.active{display:block}
    header{text-align:center;margin:25px 0 20px}
    h1{font-size:2.4rem;background:linear-gradient(135deg,#d4af37,#ec4899,#d4af37);background-size:300% 300%;animation:gradientShift 4s ease infinite;-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:800;letter-spacing:-1px;line-height:1.1}
    .subtitle{color:var(--tg-theme-hint-color);font-size:1.05rem;margin-top:8px;font-weight:400}
    .tagline{color:#d4af37;font-size:1.2rem;font-weight:700;margin:15px 0;letter-spacing:-0.2px}
    .section{background:var(--tg-theme-secondary-bg-color);backdrop-filter:blur(20px);border-radius:24px;padding:30px 25px;box-shadow:0 15px 45px rgba(212,175,55,0.28);border:1px solid var(--tg-theme-border-color);position:relative;overflow:hidden;margin-bottom:25px}
    .section::before{display:none}
    .field{margin-bottom:22px;text-align:left}
    label{display:block;margin-bottom:10px;color:var(--tg-theme-text-color,#2d2d2d);font-weight:600;font-size:1.05rem;display:flex;align-items:center;gap:10px}
    label::before{content:attr(data-icon);font-size:1.25rem}
    input,textarea,select{width:100%;padding:15px;border-radius:16px;border:1px solid var(--tg-theme-border-color,#e5e7eb);background:var(--tg-theme-secondary-bg-color,#fff);color:var(--tg-theme-text-color,#2d2d2d);font-size:16px;transition:all .3s ease;font-family:'Comfortaa',sans-serif}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--tg-theme-button-color,#a78bfa);box-shadow:0 0 0 3px rgba(167,139,250,.15)}
    input.valid,textarea.valid{border-color:#4ade80}
    .time-group{display:flex;flex-direction:column;gap:14px}
    .checkbox{display:flex;align-items:center;gap:12px;margin-top:-6px}
    .checkbox input{width:auto;height:20px;accent-color:#a78bfa}
    .checkbox label{margin-bottom:0;font-weight:500;color:var(--tg-theme-text-color,#2d2d2d);font-size:1rem;display:flex;align-items:center;gap:8px}
    .checkbox label::before{content:"‚ùì";font-size:1.3rem}
    select{appearance:none;background:url("image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23a78bfa' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E") no-repeat right 16px center;background-size:20px;padding-right:48px}
    textarea{min-height:140px;line-height:1.6;resize:vertical}
    .request-label{font-size:1.3rem;text-align:center;margin-bottom:15px;color:#a78bfa;font-weight:700;letter-spacing:-0.5px}
    .request-help-row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .request-help-row .request-label{margin-bottom:0;text-align:left;font-size:1.08rem;letter-spacing:-0.2px;line-height:1.2;max-width:68%}
    .request-help-toggle{width:auto;min-height:auto;margin:0;padding:10px 12px;border-radius:14px;background:rgba(167,139,250,.14);color:#7c3aed;border:1px solid rgba(167,139,250,.45);box-shadow:none;text-transform:none;letter-spacing:0;font-size:.88rem;font-weight:700;flex:0 0 auto;white-space:nowrap}
    @media (max-width: 430px){
      .request-help-row{align-items:flex-start}
      .request-help-row .request-label{max-width:62%}
      .request-help-toggle{padding:9px 10px;font-size:.82rem}
    }
    .request-help-toggle::after{display:none}
    .request-help-toggle:hover{transform:none;background:rgba(167,139,250,.2);box-shadow:none}
    .request-examples{display:none;margin:10px 0 0 0;padding:10px;background:rgba(167,139,250,.06);border:1px solid rgba(167,139,250,.22);border-radius:14px}
    .request-examples.open{display:block}
    .request-examples h3{font-size:.95rem;margin:0 0 8px 0;color:#7c3aed}
    .examples-grid{display:flex;flex-wrap:nowrap;gap:8px;overflow-x:auto;overflow-y:hidden;padding-bottom:2px;-webkit-overflow-scrolling:touch;scrollbar-width:thin}
    .examples-grid::-webkit-scrollbar{height:6px}
    .examples-grid::-webkit-scrollbar-thumb{background:rgba(167,139,250,.35);border-radius:8px}
    .example-btn{width:auto;min-width:260px;max-width:320px;flex-shrink:0;white-space:normal;text-transform:none;letter-spacing:0;font-size:.9rem;font-weight:600;padding:12px 14px;margin:0;min-height:auto;border-radius:12px;box-shadow:none}
    .example-btn::after{display:none}
    .example-btn:hover{transform:none;box-shadow:none}
    button{background:linear-gradient(135deg, #d4af37, #ec4899, #d4af37);background-size:300% 300%;animation:gradientShift 4s ease infinite;color:var(--tg-theme-button-text-color);border:none;padding:18px 30px;font-size:1.05rem;border-radius:18px;width:100%;font-weight:700;cursor:pointer;transition:all .3s ease;box-shadow:0 12px 35px rgba(212,175,55,0.6);margin-top:10px;letter-spacing:0;text-transform:none;min-height:58px;position:relative;overflow:hidden}
    button::after{display:none}
    button:hover{transform:translateY(-2px);box-shadow:0 14px 38px rgba(212,175,55,0.65)}
    button:active{transform:translateY(1px)}
    button:disabled{background:rgba(255,255,255,0.2);cursor:not-allowed;transform:none;box-shadow:none;opacity:.7}
    button.secondary{background:rgba(255,255,255,0.12);color:var(--tg-theme-text-color);border:1px solid var(--tg-theme-border-color);box-shadow:none;text-transform:none;letter-spacing:0;font-weight:600;min-height:56px}
    button.secondary:hover{background:rgba(255,255,255,0.18);box-shadow:0 6px 20px rgba(212,175,55,0.35)}
    .btn-group{display:flex;gap:15px;margin-top:25px}
    .btn-group button{flex:1}
    .price-tag{background:linear-gradient(90deg,#f9a8d4,#a78bfa);color:white;padding:12px 20px;border-radius:16px;font-size:1.4rem;font-weight:700;text-align:center;margin:20px 0;box-shadow:0 4px 15px rgba(249,168,212,.3);letter-spacing:1px}
    .payment-info{background:rgba(167,139,250,.05);border-left:4px solid #a78bfa;padding:15px;border-radius:0 12px 12px 0;margin:15px 0;font-size:.95rem;line-height:1.6}
    .payment-info::before{content:"üíé ";font-size:1.3rem}
    .success-icon{font-size:5rem;text-align:center;margin:20px 0;background:linear-gradient(90deg,#5eead4,#a78bfa);-webkit-background-clip:text;background-clip:text;color:transparent}
    .keys-composition{display:flex;align-items:center;justify-content:center;gap:20px;margin:25px 0;flex-wrap:wrap}
    .keys-composition svg{filter:drop-shadow(0 4px 12px rgba(167,139,250,.25));transition:transform .3s ease}
    .keys-composition .key-music{transform:rotate(-10deg);width:56px;height:80px}
    .keys-composition .key-door{transform:rotate(8deg);width:52px;height:80px}
    .keys-composition .key-music:hover,.keys-composition .key-door:hover{transform:rotate(0) scale(1.05)}
    .keys-composition-small{display:flex;align-items:center;justify-content:center;gap:12px;margin:15px 0}
    .keys-composition-small .key-music{width:36px;height:50px;transform:rotate(-8deg);opacity:.9}
    .keys-composition-small .key-door{width:34px;height:50px;transform:rotate(6deg);opacity:.9}
    .app-logo{display:block;margin:0 auto;max-width:220px;width:100%;height:auto;border-radius:0;box-shadow:0 10px 28px rgba(214,172,83,.22)}
    .app-logo.success{max-width:180px;margin-bottom:15px}
    .success-title{font-size:2.2rem;color:#a78bfa;font-weight:800;text-align:center;margin:20px 0;background:linear-gradient(90deg,#a78bfa,#f9a8d4);-webkit-background-clip:text;background-clip:text;color:transparent}
    .success-text{font-size:1.15rem;line-height:1.7;margin:20px 0;text-align:center;padding:0 10px}
    .loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px 40px;text-align:center;min-height:70vh}
    .spinner{width:60px;height:60px;border:5px solid rgba(167,139,250,.2);border-top-color:#a78bfa;border-radius:50%;margin:0 auto 25px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-text{font-size:1.5rem;color:#a78bfa;font-weight:700;margin-bottom:15px}
    .song-preview{background:white;border-radius:16px;padding:20px;margin:20px 0;text-align:left;border:2px solid #a78bfa}
    .song-preview h3{color:#a78bfa;font-size:1.4rem;margin-bottom:10px;text-align:center}
    .song-preview p{font-size:1.05rem;line-height:1.7;color:var(--tg-theme-text-color,#2d2d2d)}
    footer{text-align:center;padding:30px 0 20px;color:#6b7280;font-size:.95rem;margin-top:auto}
    .birthplace-wrap{position:relative}
    .birthplace-suggestions{position:absolute;left:0;right:0;top:100%;margin-top:4px;background:var(--tg-theme-bg-color,#fff);border:1px solid var(--tg-theme-border-color,#e5e7eb);border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.12);max-height:220px;overflow-y:auto;z-index:50;list-style:none;padding:6px 0}
    .birthplace-suggestions li{padding:12px 16px;cursor:pointer;font-size:1rem;color:var(--tg-theme-text-color,#2d2d2d);border-bottom:1px solid var(--tg-theme-border-color,#f3f4f6);transition:background .15s}
    .birthplace-suggestions li:last-child{border-bottom:none}
    .birthplace-suggestions li:hover,.birthplace-suggestions li.selected{background:rgba(167,139,250,.12);color:#6d28d9}
    .birthplace-suggestions .place-type{font-size:.85rem;color:#6b7280;margin-top:2px}
    .birthplace-summary .place-name{font-weight:700;color:#5b21b6}
    .place-coords{font-family:ui-monospace,monospace;letter-spacing:.02em}
    
    #transitForm{display:none;margin-top:30px;padding:20px;background:var(--tg-theme-secondary-bg-color,rgba(255,255,255,0.05));border-radius:12px;border:1px solid var(--tg-theme-border-color,rgba(255,255,255,0.1))}
    #transitForm h3{color:var(--tg-theme-text-color,#fff);margin:0 0 15px 0;font-size:18px}
    #secondPersonForm{display:none;margin-top:30px;padding:20px;background:var(--tg-theme-secondary-bg-color,rgba(255,255,255,0.05));border-radius:12px;border:1px solid var(--tg-theme-border-color,rgba(255,255,255,0.1))}
    #secondPersonForm h3{color:var(--tg-theme-text-color,#fff);margin:0 0 15px 0;font-size:18px}
    
    /* –ü–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–≤—å—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ */
    .preview-nav{background:white;border-radius:16px;padding:12px;margin-bottom:25px;box-shadow:0 4px 20px rgba(167,139,250,.15);text-align:center;border:1px solid #e5e7eb;display:none}
    .preview-nav.show{display:block}
    .preview-nav-buttons{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:10px}
    .preview-nav button{background:white;color:#a78bfa;border:2px solid #a78bfa;padding:6px 14px;margin:0 4px;border-radius:20px;cursor:pointer;font-weight:600;transition:all .2s;font-size:.9rem;min-width:90px}
    .preview-nav button:hover{background:#a78bfa;color:white;transform:translateY(-2px)}
    .preview-nav button.active{background:linear-gradient(90deg,#a78bfa,#f9a8d4);color:white;border-color:transparent;box-shadow:0 4px 15px rgba(167,139,250,.3)}
    
    @media (max-width:480px){.container{padding:0 12px}h1{font-size:2.1rem}.subtitle{font-size:1.05rem}.tagline{font-size:1.2rem}.section{padding:25px 20px}.btn-group{flex-direction:column}.btn-group button{width:100%}button{font-size:1.15rem;padding:16px;min-height:60px}.price-tag{font-size:1.25rem;padding:10px 15px}.success-icon{font-size:4rem}.success-title{font-size:1.9rem}.success-text{font-size:1.05rem}.preview-nav-buttons{flex-direction:column;align-items:center}.preview-nav button{width:100%;max-width:200px}}
  </style>
</head>
<body>
  <!-- –ü–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–≤—å—é (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ) -->
  <div class="container">
    <div class="preview-nav" id="previewNav">
      <div style="font-weight:600;color:#a78bfa;margin-bottom:8px">üé® –†–µ–∂–∏–º –ø—Ä–µ–≤—å—é</div>
      <div class="preview-nav-buttons">
        <button class="active" data-page="home">–ì–ª–∞–≤–Ω–∞—è</button>
        <button data-page="form">–§–æ—Ä–º–∞</button>
        <button data-page="payment">–û–ø–ª–∞—Ç–∞</button>
        <button data-page="loading">–ó–∞–≥—Ä—É–∑–∫–∞</button>
        <button data-page="success">–£—Å–ø–µ—Ö</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
    <div class="page active" id="homePage">
      <header>
        <h1>YupSoul</h1>
        <div class="subtitle">—Ç–≤–æ—è –∂–∏–∑–Ω—å ‚Äî –∏–≥—Ä–∞</div>
        <div class="tagline">–û—Ç–ø—Ä–∞–≤—å –∑–∞–ø—Ä–æ—Å –≤–æ –í—Å–µ–ª–µ–Ω–Ω—É—é</div>
      </header>
      
      <div class="section">
        <img src="assets/logo-yupsoul.png" alt="YupSoul" class="app-logo" width="220" height="220">
        <button id="startBtn">‚ú® –ù–∞—á–∞—Ç—å</button>
        <div id="masterNav" style="display:none; margin-top:20px">
          <button class="secondary" id="goHeroesBtn">üë• –ú–æ–∏ –≥–µ—Ä–æ–∏</button>
        </div>
        <div id="adminLinkWrap" style="display:none; margin-top:16px; text-align:center">
          <a href="#" id="adminLinkBtn" class="secondary" style="display:inline-block;padding:10px 20px;text-decoration:none;color:inherit;border-radius:8px;border:2px solid var(--tg-theme-button-color,#8b5cf6);color:var(--tg-theme-button-color,#8b5cf6)">üëë –ê–¥–º–∏–Ω–∫–∞</a>
        </div>
      </div>
      
      <footer>
        <p>YupSoul ‚Ä¢ 2026</p>
      </footer>
    </div>
    
    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´–ú–æ–∏ –≥–µ—Ä–æ–∏¬ª (—Ç–∞—Ä–∏—Ñ –ú–∞—Å—Ç–µ—Ä) -->
    <div class="page" id="heroesPage">
      <header>
        <h1>–ú–æ–∏ –≥–µ—Ä–æ–∏</h1>
        <div class="subtitle">–ö–∞—Ä—Ç–æ—Ç–µ–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
      </header>
      <div class="section">
        <div class="field">
          <label>–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏</label>
          <input type="text" id="heroesSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è...">
        </div>
        <button class="secondary" id="heroesSearchBtn" style="margin-bottom:15px">–ò—Å–∫–∞—Ç—å</button>
        <div id="heroesList"></div>
        <button id="addHeroBtn" style="margin-top:15px">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥–µ—Ä–æ—è</button>
        <div id="heroFormWrap" style="display:none; margin-top:25px; padding-top:20px; border-top:1px solid #e5e7eb">
          <div class="field"><label for="heroName">–ò–º—è *</label><input type="text" id="heroName" placeholder="–ò–º—è –≥–µ—Ä–æ—è" required></div>
          <div class="field"><label for="heroBirthdate">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label><input type="date" id="heroBirthdate"></div>
          <div class="field"><label for="heroBirthtime">–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è</label><input type="time" id="heroBirthtime"></div>
          <div class="field"><label for="heroBirthplace">–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è</label><input type="text" id="heroBirthplace" placeholder="–ì–æ—Ä–æ–¥, —Å—Ç—Ä–∞–Ω–∞"></div>
          <div class="checkbox" style="margin-bottom:15px"><input type="checkbox" id="heroBirthtimeUnknown"><label for="heroBirthtimeUnknown">–ù–µ –∑–Ω–∞—é —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è</label></div>
          <div class="field"><label for="heroGender">–ü–æ–ª</label><select id="heroGender"><option value="">–í—ã–±–µ—Ä–∏</option><option value="male">–ú—É–∂—Å–∫–æ–π</option><option value="female">–ñ–µ–Ω—Å–∫–∏–π</option><option value="other">–î—Ä—É–≥–æ–π</option></select></div>
          <div class="field"><label for="heroNotes">–î–æ—Å—å–µ / –∑–∞–º–µ—Ç–∫–∏</label><textarea id="heroNotes" placeholder="–ó–∞–º–µ—Ç–∫–∏ –æ –∫–ª–∏–µ–Ω—Ç–µ" rows="3"></textarea></div>
          <div class="btn-group">
            <button class="secondary" id="heroFormCancel">–û—Ç–º–µ–Ω–∞</button>
            <button id="heroFormSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </div>
      </div>
      <div class="btn-group" style="margin-top:20px">
        <button class="secondary" id="heroesBackBtn">‚Üê –ù–∞–∑–∞–¥</button>
      </div>
      <footer><p>YupSoul ‚Ä¢ 2026</p></footer>
    </div>
    
    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ñ–æ—Ä–º—ã -->
    <div class="page" id="formPage">
      <header>
        <h1>YupSoul</h1>
        <div class="subtitle">—Ç–≤–æ—è –∂–∏–∑–Ω—å ‚Äî –∏–≥—Ä–∞</div>
      </header>
      
      <div class="section">
        <div class="stepper">
          <div class="step-indicator active" data-step="1">–†–µ–∂–∏–º</div>
          <div class="step-indicator" data-step="2">–î–∞–Ω–Ω—ã–µ</div>
          <div class="step-indicator" data-step="3">–ó–∞–ø—Ä–æ—Å</div>
          <div class="step-line"></div>
        </div>

        <div class="step-panel" data-step="1">
          <div class="mode-selector">
            <h3>–í—ã–±–µ—Ä–∏ —Ç–∏–ø –∑–≤—É–∫–æ–≤–æ–≥–æ –∫–ª—é—á–∞</h3>
            <div class="mode-buttons">
              <button type="button" class="mode-btn active" data-mode="single">
                <span class="mode-label">–î–ª—è —Å–µ–±—è</span>
                <span class="mode-desc">–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑</span>
              </button>
              <button type="button" class="mode-btn" data-mode="couple">
                <span class="mode-label">–î–ª—è –¥–≤–æ–∏—Ö</span>
                <span class="mode-desc">–î—É—ç—Ç/–ø–∞—Ä–∞</span>
              </button>
              <button type="button" class="mode-btn" data-mode="transit">
                <span class="mode-label">–≠–Ω–µ—Ä–≥–∏—è –¥–Ω—è</span>
                <span class="mode-desc">–≠–Ω–µ—Ä–≥–∏—è –º–æ–º–µ–Ω—Ç–∞</span>
              </button>
            </div>
          </div>
        </div>

        <div class="step-panel" data-step="2" style="display:none">
          <div class="field">
            <input type="text" id="name" placeholder="–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?" required aria-label="–ò–º—è">
          </div>
          
          <div class="field">
            <input type="date" id="birthdate" required aria-label="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è">
            <div id="birthdateSummary" class="field-summary" style="display:none; margin-top:8px; padding:10px; background:rgba(167,139,250,.08); border-radius:12px; font-size:.95rem;"></div>
          </div>
          
          <div class="field">
            <div class="birthplace-wrap">
              <input type="text" id="birthplace" placeholder="–ì–æ—Ä–æ–¥ –∏–ª–∏ —Å—Ç—Ä–∞–Ω–∞ ‚Äî –≤—ã–±–µ—Ä–∏ –∏–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫" required autocomplete="off" aria-label="–õ–æ–∫–∞—Ü–∏—è —Ä–æ–∂–¥–µ–Ω–∏—è">
              <ul id="birthplaceSuggestions" class="birthplace-suggestions" aria-hidden="true"></ul>
            </div>
            <div id="birthplaceSummary" class="field-summary birthplace-summary" style="display:none; margin-top:8px; padding:12px 14px; background:rgba(167,139,250,.08); border-radius:12px; font-size:.95rem;"></div>
            <div id="placeCoords" class="place-coords" style="display:none; margin-top:6px; padding:10px 14px; background:rgba(94,234,212,.1); border-radius:10px; font-size:.9rem; color:#0d9488;"></div>
          </div>
          
          <div class="field">
            <div class="time-group">
              <input type="time" id="birthtime" required aria-label="–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è">
              <div class="checkbox">
                <input type="checkbox" id="unknown">
                <label for="unknown">–ù–µ –∑–Ω–∞—é —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è</label>
              </div>
            </div>
          </div>
          
          <div class="field">
            <select id="gender" required>
              <option value="">–ü–æ–ª</option>
              <option value="male">–ú—É–∂—Å–∫–æ–π</option>
              <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
            </select>
          </div>
          
          <div class="field">
            <select id="language" required aria-label="–Ø–∑—ã–∫ –ø–µ—Å–Ω–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏—è">
              <option value="">–Ø–∑—ã–∫ –ø–µ—Å–Ω–∏</option>
              <option value="ru">–†—É—Å—Å–∫–∏–π</option>
              <option value="en">English</option>
              <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
            </select>
          </div>
          
          <div id="secondPersonForm" style="display:none">
            <h3 style="margin-bottom:12px;">–î–ª—è –¥–≤–æ–∏—Ö</h3>
            <div class="field">
              <input type="text" id="name2" placeholder="–ò–º—è –≤—Ç–æ—Ä–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞" maxlength="50">
            </div>
            <div class="field">
              <input type="date" id="birthdate2" max="2010-12-31" placeholder="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è">
            </div>
            <div class="field form-group location-input-wrapper">
              <input type="text" id="birthplace2" class="location-input" placeholder="–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è –≤—Ç–æ—Ä–æ–≥–æ" maxlength="100" autocomplete="off">
              <div id="birthplaceSuggestions2" class="location-suggestions"></div>
            </div>
            <div class="field">
              <div class="time-group">
                <input type="time" id="birthtime2" style="flex:1" placeholder="–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è">
                <div class="checkbox" style="margin:0 0 0 15px">
                  <input type="checkbox" id="unknown2">
                  <label for="unknown2">–ù–µ –∑–Ω–∞—é</label>
                </div>
              </div>
            </div>
            <div class="field">
              <select id="gender2">
                <option value="">–ü–æ–ª</option>
                <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                <option value="male">–ú—É–∂—Å–∫–æ–π</option>
              </select>
            </div>
          </div>
          
          <div id="transitForm" style="display:none">
            <h3 style="margin-bottom:12px;">–≠–Ω–µ—Ä–≥–∏—è –º–æ–º–µ–Ω—Ç–∞</h3>
            <div class="field">
              <input type="date" id="transitDate" min="2024-01-01" max="2030-12-31" placeholder="–î–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è">
            </div>
            <div class="field">
              <input type="time" id="transitTime" placeholder="–í—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è">
            </div>
            <div class="field form-group location-input-wrapper">
              <input type="text" id="transitLocation" class="location-input" placeholder="–ì–æ—Ä–æ–¥ –¥–ª—è —ç–Ω–µ—Ä–≥–∏–∏ –º–æ–º–µ–Ω—Ç–∞" maxlength="100" autocomplete="off">
              <div id="transitLocationSuggestions" class="location-suggestions"></div>
              <div class="checkbox-group" style="margin-top: 10px;">
                <input type="checkbox" id="transitLocationConfirmed">
                <label for="transitLocationConfirmed">–õ–æ–∫–∞—Ü–∏—è —É–∫–∞–∑–∞–Ω–∞ –≤–µ—Ä–Ω–æ</label>
              </div>
            </div>
            <div class="field">
              <textarea id="transitIntent" placeholder="–ù–∞–º–µ—Ä–µ–Ω–∏–µ –º–æ–º–µ–Ω—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" rows="2" maxlength="200" style="min-height:60px"></textarea>
            </div>
          </div>
        </div>

        <div class="step-panel" data-step="3" style="display:none">
          <div class="field">
            <div class="request-help-row">
              <div class="request-label">–û—Ç–ø—Ä–∞–≤—å –∑–∞–ø—Ä–æ—Å</div>
              <button type="button" id="quickRequestsToggle" class="request-help-toggle" aria-expanded="false">–ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã</button>
            </div>
            <textarea id="request" placeholder="–ö–∞–∫—É—é –≥—Ä–∞–Ω—å –±—É–¥–µ–º –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è?" aria-label="–ó–∞–ø—Ä–æ—Å" rows="4"></textarea>
            <div class="request-examples" id="quickRequestsPanel">
              <div class="quick-list" id="quickRequestsList" style="display:flex;flex-direction:column;gap:8px;">
                <button type="button" class="example-btn" data-text="–ì–∞—Ä–º–æ–Ω–∏—è –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –∏ –ª—é–±–æ–≤—å –∫ —Å–µ–±–µ">–ì–∞—Ä–º–æ–Ω–∏—è –∏ –ª—é–±–æ–≤—å –∫ —Å–µ–±–µ</button>
                <button type="button" class="example-btn" data-text="–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏ –æ–ø–æ—Ä–∞ –Ω–∞ —Å–µ–±—è">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ</button>
                <button type="button" class="example-btn" data-text="–†–∞—Å–∫—Ä—ã—Ç—å —Ç–≤–æ—Ä—á–µ—Å–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –±–µ–∑ —Å—Ç—Ä–∞—Ö–∞">–¢–≤–æ—Ä—á–µ—Å–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª</button>
                <button type="button" class="example-btn" data-text="–û—Ç–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—à–ª–æ–µ –∏ –æ—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏">–û—Ç–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—à–ª–æ–µ</button>
                <button type="button" class="example-btn" data-text="–ë–∞–ª–∞–Ω—Å —Ä–∞–±–æ—Ç—ã –∏ –ª–∏—á–Ω–æ–π –∂–∏–∑–Ω–∏">–ë–∞–ª–∞–Ω—Å –∂–∏–∑–Ω–∏</button>
                <button type="button" class="example-btn" data-text="–î–æ–≤–µ—Ä—è—Ç—å –∂–∏–∑–Ω–∏ –∏ –æ—Ç–ø—É—Å–∫–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å">–î–æ–≤–µ—Ä–∏–µ –∏ –ø—Ä–∏–Ω—è—Ç–∏–µ</button>
                <button type="button" class="example-btn" data-text="–ò—Å—Ü–µ–ª–∏—Ç—å –¥–µ—Ç—Å–∫–∏–µ —Ç—Ä–∞–≤–º—ã –∏ –æ–±—Ä–µ—Å—Ç–∏ —Å–≤–æ–±–æ–¥—É">–ò—Å—Ü–µ–ª–µ–Ω–∏–µ –∏ —Å–≤–æ–±–æ–¥–∞</button>
                <button type="button" class="example-btn" data-text="–ù–∞–π—Ç–∏ —Å–≤–æ–π –ø—É—Ç—å –∫ —Å—á–∞—Å—Ç—å—é –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—é">–ü—É—Ç—å –∫ —Å—á–∞—Å—Ç—å—é</button>
                <button type="button" class="example-btn" data-text="–ú–æ—â–Ω–∞—è –ø–µ—Å–Ω—è –æ –º–æ–µ–π —Å–∏–ª–µ –∏ –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–∏">–°–∏–ª–∞ –∏ –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ</button>
                <button type="button" class="example-btn" data-text="–ú–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω–∞—è –ø–µ—Å–Ω—è –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏ –∏—Å—Ü–µ–ª–µ–Ω–∏—è">–ì–ª—É–±–∏–Ω–∞ –∏ —Ç–∏—à–∏–Ω–∞</button>
                <button type="button" class="example-btn" data-text="–¢—ë–ø–ª–∞—è –ø–µ—Å–Ω—è –æ –∑–∞–±–æ—Ç–µ –∏ –Ω–µ–∂–Ω–æ—Å—Ç–∏">–ù–µ–∂–Ω–æ—Å—Ç—å –∏ –∑–∞–±–æ—Ç–∞</button>
                <button type="button" class="example-btn" data-text="–í–µ—Å—ë–ª–∞—è –ø–µ—Å–Ω—è —Å —Å–∞–º–æ–∏—Ä–æ–Ω–∏–µ–π –ø—Ä–æ –º–æ–∏ —Å–ª–∞–±–æ—Å—Ç–∏">–Æ–º–æ—Ä –∏ –ª—ë–≥–∫–æ—Å—Ç—å</button>
              </div>
            </div>
          </div>
        </div>

        <div class="step-nav">
          <button class="secondary" id="stepPrev" disabled>–ù–∞–∑–∞–¥</button>
          <button id="stepNext">–î–∞–ª–µ–µ</button>
        </div>
      </div>
      
      <footer>
        <p>YupSoul ‚Ä¢ 2026</p>
      </footer>
    </div>
    
    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–Ω–∞—Ç–æ–≤ / —Ä–µ–∫–≤–∏–∑–∏—Ç—ã -->
    <div class="page" id="paymentPage">
      <header>
        <h1>YupSoul</h1>
        <div class="subtitle">–¢–≤–æ–π –∑–≤—É–∫–æ–≤–æ–π –∫–ª—é—á</div>
      </header>
      
      <div class="section">
        <div class="tagline" style="margin-bottom:15px">–û–ø–ª–∞—Ç–∞ –∏ –¥–æ—Å—Ç—É–ø</div>
        <p style="text-align:center;font-size:1.05rem;line-height:1.7;margin-bottom:16px">
          –ü–µ—Ä–≤–∞—è –ø–µ—Å–Ω—è  ‚Äî –≤ –ø–æ–¥–∞—Ä–æ–∫. –î–∞–ª—å—à–µ –º–æ–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏–ª–∏ –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø.
        </p>
        <div id="pricingNotice" style="background:rgba(94,234,212,.12);border:1px solid rgba(94,234,212,.35);border-radius:12px;padding:12px 14px;margin-bottom:14px;font-size:.92rem;color:#99f6e4;">
          –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞—Ä–∏—Ñ–æ–≤...
        </div>
        <div id="priceSummary" style="background:rgba(167,139,250,.12);border-radius:16px;padding:20px;margin:16px 0;border:1px solid rgba(167,139,250,.25);">
          <div style="font-size:.95rem;color:#e9ddba;">–¢–µ–∫—É—â–∏–π —ç–ª–µ–º–µ–Ω—Ç</div>
          <div id="priceLabel" style="font-size:1.15rem;font-weight:700;color:#fff;margin-top:6px;">‚Äî</div>
          <div id="priceValue" style="font-size:1.8rem;font-weight:800;color:#f5e9c9;margin-top:6px;">‚Äî</div>
          <div id="priceHint" style="font-size:.88rem;color:#c4b5fd;margin-top:6px;"></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <input id="promoCodeInput" type="text" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥" style="flex:1;min-width:180px;padding:10px 12px;border-radius:10px;border:1px solid rgba(167,139,250,.45);background:rgba(26,26,46,.95);color:#fff;text-transform:uppercase;">
          <button id="promoApplyBtn" type="button" class="secondary" style="min-width:140px;margin-top:0;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div id="paymentStatus" style="display:none;background:rgba(249,168,212,.1);border:1px solid rgba(249,168,212,.35);border-radius:12px;padding:12px 14px;margin:14px 0;font-size:.92rem;"></div>
        <div class="btn-group">
          <button class="secondary" id="backFromPaymentBtn">‚Üê –ù–∞–∑–∞–¥</button>
          <button id="payBtn">–û—Ñ–æ—Ä–º–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
      </div>
      
      <footer>
        <p>YupSoul ‚Ä¢ 2026</p>
      </footer>
    </div>
    
    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="page" id="loadingPage">
      <div class="loading">
        <div class="spinner"></div>
        <div class="loading-text">–°–æ–∑–¥–∞—é —Ç–≤–æ–π –∫–ª—é—á...</div>
        <div style="color:#6b7280;font-size:1.1rem;text-align:center;max-width:400px">
          –ú–∞–≥–∏—è —Ç–≤–æ—Ä–∏—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏. –¢–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∑–≤—É–∫–æ–≤–æ–π –∫–ª—é—á —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–≤–æ–∏—Ö —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
        </div>
      </div>
    </div>
    
    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—Ö–∞ -->
    <div class="page" id="successPage">
      <header>
        <h1>YupSoul</h1>
        <div class="subtitle">–ö–ª—é—á –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!</div>
      </header>
      
      <div class="section">
        <img src="assets/logo-yupsoul.png" alt="YupSoul" class="app-logo success" width="180" height="180">
        <h2 class="success-title">–ì–æ—Ç–æ–≤–æ!</h2>
        <p class="success-text">
          –¢–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∑–≤—É–∫–æ–≤–æ–π –∫–ª—é—á —Å–æ–∑–¥–∞–Ω! –≠—Ç–æ —Ç–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —Å–∏–ª—ã –¥–ª—è –∏–≥—Ä—ã –∂–∏–∑–Ω–∏.
        </p>
        
        <div class="song-preview">
          <h3>üéµ –¢–≤–æ—è –ø–µ—Å–Ω—è</h3>
          <p id="songPreviewText">
            –¢–≤–æ—è —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –∞—É–¥–∏–æ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è —É–∂–µ –∂–¥—ë—Ç —Ç–µ–±—è –≤ –±–æ—Ç–µ. –°–ª—É—à–∞–π –µ—ë –∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å—Å—è –Ω–∞ –≤–æ–ª–Ω—É —É—Å–ø–µ—Ö–∞.
          </p>
        </div>
        
        <div style="background:rgba(167,139,250,.08);border-radius:12px;padding:15px;margin:20px 0;text-align:center;font-size:1.05rem;line-height:1.7">
          <strong>–ß—Ç–æ –¥–∞–ª—å—à–µ:</strong><br>
          –û—Ç–∫—Ä–æ–π –±–æ—Ç–∞ <a href="https://t.me/Yup_Soul_bot" style="color:#a78bfa;text-decoration:underline">@Yup_Soul_bot</a> –≤ Telegram ‚Äî —Ç–∞–º —Ç–µ–±—è –∂–¥—ë—Ç —Ç–≤–æ–π –∑–≤—É–∫–æ–≤–æ–π –∫–ª—é—á.
        </div>
        
        <button class="secondary" id="newKeyBtn" style="margin-top:25px">‚ú® –°–æ–∑–¥–∞—Ç—å –µ—â—ë –æ–¥–∏–Ω –∫–ª—é—á</button>
      </div>
      
      <footer>
        <p>YupSoul ‚Ä¢ 2026</p>
      </footer>
    </div>
    
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var tg = null;
      function logColorSnapshot(stage, pageId) {
        try {
          var rootStyles = getComputedStyle(document.documentElement);
          var bodyStyles = getComputedStyle(document.body);
          var formPage = document.getElementById('formPage');
          var scope = formPage || document;
          var labelEl = scope.querySelector('label');
          var fieldEl = scope.querySelector('input,select,textarea');
          var requestLabelEl = scope.querySelector('.request-label');
          var tgParams = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.themeParams) ? window.Telegram.WebApp.themeParams : {};
          fetch('http://127.0.0.1:7242/ingest/bc4e8ff4-db81-496d-b979-bb86841a5db1',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:theme:colorSnapshot',message:'runtime color snapshot',data:{stage:String(stage||''),pageId:String(pageId||''),activePage:(document.querySelector('.page.active')||{}).id||null,tgTextColor:tgParams.text_color||null,tgBgColor:tgParams.bg_color||null,cssVarTextColor:(rootStyles.getPropertyValue('--tg-theme-text-color')||'').trim()||null,cssVarBgColor:(rootStyles.getPropertyValue('--tg-theme-bg-color')||'').trim()||null,bodyColor:bodyStyles.color||null,bodyBgColor:bodyStyles.backgroundColor||null,labelColor:labelEl?getComputedStyle(labelEl).color:null,fieldColor:fieldEl?getComputedStyle(fieldEl).color:null,fieldBgColor:fieldEl?getComputedStyle(fieldEl).backgroundColor:null,requestLabelColor:requestLabelEl?getComputedStyle(requestLabelEl).color:null,locationHref:window.location.href||null},timestamp:Date.now(),runId:'color-drift-debug',hypothesisId:'H1,H2,H3,H4'})}).catch(()=>{});
        } catch (e) {
          fetch('http://127.0.0.1:7242/ingest/bc4e8ff4-db81-496d-b979-bb86841a5db1',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:theme:colorSnapshot',message:'runtime color snapshot failed',data:{stage:String(stage||''),pageId:String(pageId||''),errorMessage:e&&e.message?String(e.message):String(e)},timestamp:Date.now(),runId:'color-drift-debug',hypothesisId:'H4'})}).catch(()=>{});
        }
      }
      function initApp() {
        try {
      if (window.Telegram && window.Telegram.WebApp) {
            tg = window.Telegram.WebApp;
        tg.ready();
            tg.expand();
            if (tg.enableClosingConfirmation) tg.enableClosingConfirmation();
            logColorSnapshot('init-app', 'homePage');
            return true;
          }
        } catch (e) { console.warn('Telegram init:', e); }
        return false;
      }
      if (!initApp()) {
        var attempts = 0;
        var t = setInterval(function() {
          attempts++;
          if (initApp() || attempts >= 50) {
            clearInterval(t);
            if (!tg) showNotFromTelegramBanner();
            logColorSnapshot('init-retry-finished', 'homePage');
          }
        }, 100);
      }
      function showNotFromTelegramBanner() {
        var banner = document.createElement('div');
        banner.id = 'not-telegram-banner';
        banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:9999;background:#fef3c7;color:#92400e;padding:12px 16px;text-align:center;font-size:0.95rem;border-bottom:1px solid #f59e0b;';
        banner.textContent = '–û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ —á–∞—Ç–∞ —Å –±–æ—Ç–æ–º –≤ Telegram (–∫–Ω–æ–ø–∫–∞ –º–µ–Ω—é) ‚Äî –∏–Ω–∞—á–µ –∑–∞—è–≤–∫–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è.';
        document.body.insertBefore(banner, document.body.firstChild);
      }
      async function showLocationSuggestions(inputElement, suggestionsContainerId, confirmCheckboxId) {
        var value = inputElement.value.trim();
        var suggestionsContainer = document.getElementById(suggestionsContainerId);
        if (value.length < 2) {
          if (suggestionsContainer) suggestionsContainer.style.display = 'none';
          return;
        }
        try {
          var response = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(value) + '&addressdetails=1&limit=5', { headers: { 'Accept': 'application/json', 'User-Agent': 'YupSoulMiniApp/1.0' } });
          var locations = await response.json();
          if (locations.length === 0) {
            if (suggestionsContainer) {
              suggestionsContainer.innerHTML = '<div style="padding: 10px; color: var(--tg-theme-hint-color, rgba(255,255,255,0.6)); text-align: center;">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
              suggestionsContainer.style.display = 'block';
            }
            return;
          }
          if (suggestionsContainer) {
            suggestionsContainer.innerHTML = locations.map(function(loc) {
              var display = (loc.display_name || '')
                .replace(', –†–æ—Å—Å–∏—è', '').replace(', –ë–µ–ª–∞—Ä—É—Å—å', '').replace(', –†–æ—Å—Å–∏–π—Å–∫–∞—è –§–µ–¥–µ—Ä–∞—Ü–∏—è', '').replace(', Republic of Belarus', '');
              return '<div class="location-suggestion" data-value="' + (display.replace(/"/g, '&quot;')) + '">' + (display.replace(/</g, '&lt;')) + '</div>';
            }).join('');
            suggestionsContainer.style.display = 'block';
            suggestionsContainer.querySelectorAll('.location-suggestion').forEach(function(item) {
              item.addEventListener('click', function() {
                inputElement.value = item.getAttribute('data-value');
                suggestionsContainer.style.display = 'none';
                if (confirmCheckboxId) {
                  var checkbox = document.getElementById(confirmCheckboxId);
                  if (checkbox) checkbox.checked = true;
                }
              });
            });
          }
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è:', err);
          if (suggestionsContainer) {
            suggestionsContainer.innerHTML = '<div style="padding: 10px; color: #ef4444; text-align: center;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
            suggestionsContainer.style.display = 'block';
          }
        }
      }
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.location-input-wrapper')) {
          document.querySelectorAll('.location-suggestions').forEach(function(el) { el.style.display = 'none'; });
        }
      });
      var userTariff = 'basic';
      var heroesCache = [];
      var editingHeroId = null;
      var pricingCatalog = [];
      var freeTrialAvailable = true;
      var activePromo = null;

      function getCurrentSku() {
        var modeSku = selectedMode || 'single';
        if (modeSku === 'couple') return 'couple_song';
        if (modeSku === 'transit') return 'transit_energy_song';
        return 'single_song';
      }
      function setPaymentStatus(text, tone) {
        var el = document.getElementById('paymentStatus');
        if (!el) return;
        if (!text) { el.style.display = 'none'; return; }
        el.style.display = 'block';
        el.textContent = text;
        if (tone === 'ok') { el.style.borderColor = 'rgba(74,222,128,.45)'; el.style.background = 'rgba(74,222,128,.1)'; el.style.color = '#bbf7d0'; return; }
        if (tone === 'warn') { el.style.borderColor = 'rgba(250,204,21,.45)'; el.style.background = 'rgba(250,204,21,.1)'; el.style.color = '#fde68a'; return; }
        if (tone === 'error') { el.style.borderColor = 'rgba(248,113,113,.45)'; el.style.background = 'rgba(248,113,113,.1)'; el.style.color = '#fecaca'; return; }
        el.style.borderColor = 'rgba(249,168,212,.35)';
        el.style.background = 'rgba(249,168,212,.1)';
        el.style.color = '#f5d0fe';
      }
      function updatePaymentUiFromCatalog() {
        var sku = getCurrentSku();
        var item = pricingCatalog.find(function(x) { return x && x.sku === sku; }) || null;
        var priceLabel = document.getElementById('priceLabel');
        var priceValue = document.getElementById('priceValue');
        var priceHint = document.getElementById('priceHint');
        var notice = document.getElementById('pricingNotice');
        if (priceLabel) priceLabel.textContent = item ? (item.title || sku) : sku;
        if (priceValue) {
          if (item && activePromo && activePromo.sku === sku) {
            priceValue.textContent = String(activePromo.amount_after) + ' ' + (activePromo.currency || item.currency || 'USDT');
          } else {
            priceValue.textContent = item ? (String(item.price) + ' ' + (item.currency || 'USDT')) : '‚Äî';
          }
        }
        if (priceHint) {
          if (item && activePromo && activePromo.sku === sku) {
            priceHint.textContent = '–ü—Ä–æ–º–æ–∫–æ–¥ ' + activePromo.code + ': -' + activePromo.discount_amount + ' ' + (activePromo.currency || item.currency || 'USDT');
          } else {
            priceHint.textContent = '';
          }
        }
        if (notice) {
          if (freeTrialAvailable) {
            notice.textContent = 'üéÅ –ü–µ—Ä–≤—ã–π –∑–≤—É–∫–æ–≤–æ–π –∫–ª—é—á –¥–æ—Å—Ç—É–ø–µ–Ω –±–µ—Å–ø–ª–∞—Ç–Ω–æ.';
            notice.style.borderColor = 'rgba(74,222,128,.45)';
            notice.style.background = 'rgba(74,222,128,.1)';
            notice.style.color = '#bbf7d0';
          } else {
            notice.textContent = '–û–ø–ª–∞—Ç–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫.';
            notice.style.borderColor = 'rgba(167,139,250,.35)';
            notice.style.background = 'rgba(167,139,250,.12)';
            notice.style.color = '#ddd6fe';
          }
        }
      }
      async function loadPricingCatalog() {
        var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        var initData = (tg && tg.initData) ? tg.initData : '';
        if (!apiBase) return;
        try {
          var url = apiBase + '/api/pricing/catalog';
          var sep = url.indexOf('?') >= 0 ? '&' : '?';
          if (initData) url += sep + 'initData=' + encodeURIComponent(initData);
          var resp = await fetch(url, { headers: { 'X-Telegram-Init': initData } });
          var json = await resp.json().catch(function() { return {}; });
          if (resp.ok && json.success) {
            pricingCatalog = Array.isArray(json.catalog) ? json.catalog : [];
            freeTrialAvailable = !!(json.free_trial && json.free_trial.available);
            updatePaymentUiFromCatalog();
          }
        } catch (_) {}
      }
      async function applyPromoCode() {
        var input = document.getElementById('promoCodeInput');
        if (!input) return;
        var code = String(input.value || '').trim().toUpperCase();
        if (!code) {
          activePromo = null;
          updatePaymentUiFromCatalog();
          setPaymentStatus('–ü—Ä–æ–º–æ–∫–æ–¥ –æ—á–∏—â–µ–Ω.', 'warn');
          return;
        }
        var sku = getCurrentSku();
        var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        var initData = (tg && tg.initData) ? tg.initData : '';
        try {
          var resp = await fetch(apiBase + '/api/promos/validate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
            body: JSON.stringify({ promo_code: code, sku: sku, initData: initData })
          });
          var json = await resp.json().catch(function() { return {}; });
          if (!resp.ok || !json.success || !json.valid) {
            activePromo = null;
            updatePaymentUiFromCatalog();
            throw new Error(json.error || '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –ø—Ä–∏–Ω—è—Ç');
          }
          activePromo = {
            code: code,
            sku: sku,
            amount_before: json.amount_before,
            discount_amount: json.discount_amount,
            amount_after: json.amount_after,
            currency: json.currency || 'USDT'
          };
          updatePaymentUiFromCatalog();
          setPaymentStatus('–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω: –∏—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ ' + json.amount_after + ' ' + (json.currency || 'USDT'), 'ok');
        } catch (e) {
          setPaymentStatus((e && e.message) ? e.message : '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥', 'error');
        }
      }
      function heroesApi(path, opts) {
        var base = (window.HEROES_API_BASE || '').replace(/\/$/, '');
        if (!base) return Promise.reject(new Error('API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'));
        var initData = (tg && tg.initData) ? tg.initData : '';
        var url = base + '/api' + path;
        var sep = path.indexOf('?') >= 0 ? '&' : '?';
        if (initData && (!opts || opts.method === 'GET')) url += sep + 'initData=' + encodeURIComponent(initData);
        if (opts && opts.query) url += (url.indexOf('?') >= 0 ? '&' : '?') + opts.query;
        var options = { headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData } };
        if (opts && opts.method) options.method = opts.method;
        if (opts && opts.body) options.body = JSON.stringify(opts.body);
        return fetch(url, options).then(function(r) {
          if (r.status === 204) return null;
          return r.json().then(function(j) { if (!r.ok) throw new Error(j.error || r.statusText); return j; });
        });
      }
      function loadMe() {
        if (!(window.HEROES_API_BASE || '').replace(/\/$/, '')) return;
        heroesApi('/me', { method: 'POST', body: { initData: (tg && tg.initData) || '' } }).then(function(d) {
          userTariff = (d && d.tariff) || 'basic';
          var masterNav = document.getElementById('masterNav');
          if (masterNav && userTariff === 'master') masterNav.style.display = 'block';
        }).catch(function() {});
      }
      if (tg) loadMe();

      setTimeout(function() {
        try {
        if (!tg) {
          var p = document.getElementById('previewNav');
          if (p) p.classList.add('show');
        }
        var birthdateEl = document.getElementById('birthdate');
        if (birthdateEl) {
          var today = new Date();
          birthdateEl.max = today.toISOString().split('T')[0];
          var minDate = new Date();
      minDate.setFullYear(minDate.getFullYear() - 100);
          birthdateEl.min = minDate.toISOString().split('T')[0];
        }
        var unknown = document.getElementById('unknown');
        var birthtime = document.getElementById('birthtime');
        if (unknown && birthtime) unknown.addEventListener('change', function() {
        birthtime.required = !unknown.checked;
        });
        var birthdateSummary = document.getElementById('birthdateSummary');
        var birthdateInput = document.getElementById('birthdate');
        var birthplaceSummary = document.getElementById('birthplaceSummary');
        var birthplaceInput = document.getElementById('birthplace');
        var monthsRu = ['—è–Ω–≤–∞—Ä—è','—Ñ–µ–≤—Ä–∞–ª—è','–º–∞—Ä—Ç–∞','–∞–ø—Ä–µ–ª—è','–º–∞—è','–∏—é–Ω—è','–∏—é–ª—è','–∞–≤–≥—É—Å—Ç–∞','—Å–µ–Ω—Ç—è–±—Ä—è','–æ–∫—Ç—è–±—Ä—è','–Ω–æ—è–±—Ä—è','–¥–µ–∫–∞–±—Ä—è'];
        function formatDateRu(dateStr) {
          if (!dateStr) return '';
          var d = new Date(dateStr + 'T12:00:00');
          if (isNaN(d.getTime())) return dateStr;
          return d.getDate() + ' ' + monthsRu[d.getMonth()] + ' ' + d.getFullYear() + ' –≥.';
        }
        if (birthdateInput && birthdateSummary) {
          birthdateInput.addEventListener('change', function() {
            var v = birthdateInput.value;
            if (v) {
              birthdateSummary.textContent = '–í—ã–±—Ä–∞–Ω–æ: ' + formatDateRu(v);
              birthdateSummary.style.display = 'block';
            } else {
              birthdateSummary.style.display = 'none';
            }
          });
          if (birthdateInput.value) {
            birthdateSummary.textContent = '–í—ã–±—Ä–∞–Ω–æ: ' + formatDateRu(birthdateInput.value);
            birthdateSummary.style.display = 'block';
          }
        }
        if (birthplaceInput && birthplaceSummary) {
          var suggestionsEl = document.getElementById('birthplaceSuggestions');
          var placeCoordsEl = document.getElementById('placeCoords');
          var debounceTimer = null;
          var lastSearch = '';
          function hideSuggestions() {
            if (suggestionsEl) { suggestionsEl.innerHTML = ''; suggestionsEl.setAttribute('aria-hidden', 'true'); suggestionsEl.style.display = 'none'; }
          }
          function escapeHtml(s) {
            if (!s) return '';
            var d = document.createElement('div'); d.textContent = s; return d.innerHTML;
          }
          function formatLatLon(lat, lon) {
            var la = parseFloat(lat); var lo = parseFloat(lon);
            if (isNaN(la) || isNaN(lo)) return '';
            var latStr = Math.abs(la).toFixed(2) + '¬∞ ' + (la >= 0 ? 'N' : 'S');
            var lonStr = Math.abs(lo).toFixed(2) + '¬∞ ' + (lo >= 0 ? 'E' : 'W');
            return latStr + ', ' + lonStr;
          }
          function showPlaceConfirm(displayName) {}
          function selectPlace(displayName, lat, lon) {
            birthplaceInput.value = displayName || '';
            birthplaceInput.setAttribute('data-place-selected', '1');
            if (lat != null && lon != null) {
              birthplaceInput.setAttribute('data-lat', String(lat));
              birthplaceInput.setAttribute('data-lon', String(lon));
            }
            birthplaceSummary.innerHTML = '<span class="place-name">–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è:</span> ' + escapeHtml(displayName || '');
            birthplaceSummary.style.display = 'block';
            if (placeCoordsEl && lat != null && lon != null) {
              placeCoordsEl.textContent = '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ' + formatLatLon(lat, lon);
              placeCoordsEl.style.display = 'block';
            } else if (placeCoordsEl) {
              placeCoordsEl.style.display = 'none';
            }
            showPlaceConfirm(displayName);
            hideSuggestions();
          }
          function clearPlaceSelection() {
            birthplaceInput.removeAttribute('data-place-selected');
            birthplaceInput.removeAttribute('data-lat');
            birthplaceInput.removeAttribute('data-lon');
            if (placeCoordsEl) placeCoordsEl.style.display = 'none';
          }
          function fetchPlaces(q) {
            if (!q || q.length < 2) { hideSuggestions(); return; }
            var url = 'https://nominatim.openstreetmap.org/search?q=' + encodeURIComponent(q) + '&format=json&limit=8&addressdetails=1';
            fetch(url, { headers: { 'Accept': 'application/json', 'Accept-Language': 'ru', 'User-Agent': 'YupSoulMiniApp/1.0 (contact@yupsoul.com)' } })
              .then(function(r) { return r.json(); })
              .then(function(list) {
                if (lastSearch !== q) return;
                if (!suggestionsEl) return;
                suggestionsEl.innerHTML = '';
                (list || []).forEach(function(item) {
                  var li = document.createElement('li');
                  var main = item.display_name || (item.address && (item.address.city || item.address.town || item.address.village || item.address.state || item.address.country));
                  var sub = item.address && item.address.country ? (item.address.country + (item.address.country_code ? ' (' + item.address.country_code.toUpperCase() + ')' : '')) : '';
                  li.textContent = main;
                  if (sub) { var sp = document.createElement('div'); sp.className = 'place-type'; sp.textContent = sub; li.appendChild(sp); }
                  var lat = item.lat; var lon = item.lon;
                  li.addEventListener('click', function() { selectPlace(item.display_name || main, lat, lon); });
                  suggestionsEl.appendChild(li);
                });
                suggestionsEl.style.display = (list && list.length) ? 'block' : 'none';
                suggestionsEl.setAttribute('aria-hidden', list && list.length ? 'false' : 'true');
              })
              .catch(function() { hideSuggestions(); });
          }
          birthplaceInput.addEventListener('input', function() {
            var v = birthplaceInput.value.trim();
            clearPlaceSelection();
            if (v) {
              lastSearch = v;
              clearTimeout(debounceTimer);
              debounceTimer = setTimeout(function() { fetchPlaces(v); }, 320);
              if (!suggestionsEl || suggestionsEl.style.display !== 'block') {
                birthplaceSummary.innerHTML = '–í—ã–±–µ—Ä–∏ –ª–æ–∫–∞—Ü–∏—é –∏–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫ ‚Äî –Ω—É–∂–Ω—ã —Ç–æ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞.';
                birthplaceSummary.style.display = 'block';
                showPlaceConfirm(v);
              }
            } else {
              hideSuggestions();
              birthplaceSummary.style.display = 'none';
            }
          });
          birthplaceInput.addEventListener('focus', function() {
            var v = birthplaceInput.value.trim();
            if (v && v.length >= 2) { lastSearch = v; fetchPlaces(v); }
          });
          birthplaceInput.addEventListener('blur', function() {
            setTimeout(hideSuggestions, 200);
            var v = birthplaceInput.value.trim();
            if (v) {
              if (birthplaceInput.getAttribute('data-place-selected')) {
                birthplaceSummary.innerHTML = '<span class="place-name">–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è:</span> ' + escapeHtml(v);
                if (placeCoordsEl && birthplaceInput.getAttribute('data-lat')) {
                  placeCoordsEl.textContent = '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ' + formatLatLon(birthplaceInput.getAttribute('data-lat'), birthplaceInput.getAttribute('data-lon'));
                  placeCoordsEl.style.display = 'block';
                }
              } else {
                birthplaceSummary.innerHTML = '–í—ã–±–µ—Ä–∏ –º–µ—Å—Ç–æ –∏–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫ (–∫–ª–∏–∫ –ø–æ –≤–∞—Ä–∏–∞–Ω—Ç—É –≤ —Å–ø–∏—Å–∫–µ).';
                if (placeCoordsEl) placeCoordsEl.style.display = 'none';
              }
              birthplaceSummary.style.display = 'block';
              showPlaceConfirm(v);
            }
          });
          if (birthplaceInput.value.trim()) {
            if (birthplaceInput.getAttribute('data-place-selected')) {
              birthplaceSummary.innerHTML = '<span class="place-name">–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è:</span> ' + escapeHtml(birthplaceInput.value.trim());
              if (placeCoordsEl && birthplaceInput.getAttribute('data-lat')) {
                placeCoordsEl.textContent = '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ' + formatLatLon(birthplaceInput.getAttribute('data-lat'), birthplaceInput.getAttribute('data-lon'));
                placeCoordsEl.style.display = 'block';
              }
            } else {
              birthplaceSummary.innerHTML = '–í—ã–±–µ—Ä–∏ –º–µ—Å—Ç–æ –∏–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫ (–∫–ª–∏–∫ –ø–æ –≤–∞—Ä–∏–∞–Ω—Ç—É –≤ —Å–ø–∏—Å–∫–µ).';
            }
            birthplaceSummary.style.display = 'block';
            showPlaceConfirm(birthplaceInput.value.trim());
          }
        }
        var birthplace2Input = document.getElementById('birthplace2');
        if (birthplace2Input) {
          var debounce2 = null;
          birthplace2Input.addEventListener('input', function() {
            var self = this;
            clearTimeout(debounce2);
            debounce2 = setTimeout(function() { showLocationSuggestions(self, 'birthplaceSuggestions2', null); }, 320);
          });
        }
        var transitLocationInput = document.getElementById('transitLocation');
        if (transitLocationInput) {
          var debounceTransit = null;
          transitLocationInput.addEventListener('input', function() {
            var self = this;
            clearTimeout(debounceTransit);
            debounceTransit = setTimeout(function() { showLocationSuggestions(self, 'transitLocationSuggestions', 'transitLocationConfirmed'); }, 320);
          });
        }
        var formPage = document.getElementById('formPage');
        if (formPage && userTariff === 'master') loadForWhoSelect();
      
      // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
      function goToPage(pageId) {
        if (tg && tg.MainButton && tg.MainButton.hide) tg.MainButton.hide();
        if (pageId !== 'paymentPage') {
          var payBtnReset = document.getElementById('payBtn');
          if (payBtnReset) { payBtnReset.disabled = false; payBtnReset.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É'; }
        }
        document.querySelectorAll('.page').forEach(function(page) {
          page.classList.remove('active');
        });
        var target = document.getElementById(pageId);
        if (target) target.classList.add('active');
        if (pageId === 'formPage' && userTariff === 'master') loadForWhoSelect();
        if (pageId === 'paymentPage') { loadPricingCatalog(); updatePaymentUiFromCatalog(); setPaymentStatus('',''); }
        if (pageId === 'homePage' || pageId === 'formPage' || pageId === 'paymentPage') {
          logColorSnapshot('go-to-page', pageId);
        }
        if (document.getElementById('previewNav') && document.getElementById('previewNav').classList.contains('show')) {
          document.querySelectorAll('.preview-nav button').forEach(function(btn) {
            btn.classList.remove('active');
          });
          var pageMap = { 'homePage': 'home', 'formPage': 'form', 'paymentPage': 'payment', 'loadingPage': 'loading', 'successPage': 'success', 'heroesPage': 'heroes' };
          var activeBtn = document.querySelector('.preview-nav button[data-page="' + (pageMap[pageId] || '') + '"]');
          if (activeBtn) activeBtn.classList.add('active');
        }
      }
      
      // –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
      var startBtn = document.getElementById('startBtn');
      if (startBtn) startBtn.addEventListener('click', function() { goToPage('formPage'); });

      var stepPanels = document.querySelectorAll('.step-panel');
      var stepIndicators = document.querySelectorAll('.step-indicator');
      var stepPrev = document.getElementById('stepPrev');
      var stepNext = document.getElementById('stepNext');
      var quickToggle = document.getElementById('quickRequestsToggle');
      var quickPanel = document.getElementById('quickRequestsPanel');
      var selectedMode = 'single';
      var currentStep = 1;
      var totalSteps = 3;

      function applyTheme() {
        var hour = new Date().getHours();
        var theme = (hour >= 7 && hour < 19) ? 'theme-light' : 'theme-dark';
        document.body.classList.remove('theme-light', 'theme-dark');
        document.body.classList.add(theme);
      }
      applyTheme();

      function toggleFormsByMode(mode) {
        var secondForm = document.getElementById('secondPersonForm');
        var transitForm = document.getElementById('transitForm');
        if (secondForm) secondForm.style.display = 'none';
        if (transitForm) transitForm.style.display = 'none';
        if (mode === 'couple' && secondForm) {
          secondForm.style.display = 'block';
        } else if (mode === 'transit' && transitForm) {
          transitForm.style.display = 'block';
        }
      }

      function updateStepUI() {
        stepPanels.forEach(function(panel) {
          var step = Number(panel.getAttribute('data-step'));
          panel.style.display = (step === currentStep) ? 'block' : 'none';
        });
        stepIndicators.forEach(function(ind) {
          var step = Number(ind.getAttribute('data-step'));
          ind.classList.toggle('active', step === currentStep);
        });
        if (stepPrev) stepPrev.disabled = currentStep === 1;
        if (stepNext) stepNext.textContent = currentStep === totalSteps ? '–ö –æ–ø–ª–∞—Ç–µ' : '–î–∞–ª–µ–µ';
        if (currentStep > 1) {
          document.querySelectorAll('.mode-btn').forEach(function(btn) {
            if (!btn.classList.contains('active')) btn.style.display = 'none';
          });
        } else {
          document.querySelectorAll('.mode-btn').forEach(function(btn) { btn.style.display = 'block'; });
        }
      }

      function setMode(mode) {
        selectedMode = mode || 'single';
        document.querySelectorAll('.mode-btn').forEach(function(btn) {
          btn.classList.toggle('active', btn.getAttribute('data-mode') === selectedMode);
        });
        toggleFormsByMode(selectedMode);
        updatePaymentUiFromCatalog();
      }

      function validateStep(step) {
        if (step === 1) return true;
        if (step === 2) {
          var name = document.getElementById('name').value.trim();
          var birthdate = document.getElementById('birthdate').value;
          var birthplace = document.getElementById('birthplace').value.trim();
          var birthtimeVal = (unknown && unknown.checked) ? 'ok' : (document.getElementById('birthtime') ? document.getElementById('birthtime').value : '');
          var gender = document.getElementById('gender').value;
          var language = document.getElementById('language').value;
          if (name.length < 2) { alert('–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞'); return false; }
          if (!birthdate) { alert('–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è'); return false; }
          if (birthplace.length < 3) { alert('–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞'); return false; }
          var birthplaceField = document.getElementById('birthplace');
          if (!(birthplaceField && birthplaceField.getAttribute('data-place-selected'))) {
            alert('–í—ã–±–µ—Ä–∏ –ª–æ–∫–∞—Ü–∏—é –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫ ‚Äî —Ç–∞–∫ –ø–æ–¥—Ç—è–Ω—É—Ç—Å—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞.');
            return false;
          }
          if (!birthtimeVal) { alert('–£–∫–∞–∂–∏ –≤—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è –∏–ª–∏ –æ—Ç–º–µ—Ç—å \"–ù–µ –∑–Ω–∞—é\"'); return false; }
          if (!gender) { alert('–£–∫–∞–∂–∏ –ø–æ–ª'); return false; }
          if (!language) { alert('–í—ã–±–µ—Ä–∏ —è–∑—ã–∫'); return false; }
          if (selectedMode === 'couple') {
            var name2 = (document.getElementById('name2').value || '').trim();
            var birthdate2 = document.getElementById('birthdate2').value;
            if (name2.length < 2) { alert('–ò–º—è –≤—Ç–æ—Ä–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ ‚Äî –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞'); return false; }
            if (!birthdate2) { alert('–£–∫–∞–∂–∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –≤—Ç–æ—Ä–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞'); return false; }
          }
          if (selectedMode === 'transit') {
            var tDate = document.getElementById('transitDate').value;
            var tLoc = document.getElementById('transitLocation').value.trim();
            if (!tDate) { alert('–£–∫–∞–∂–∏ –¥–∞—Ç—É —Å–æ–±—ã—Ç–∏—è'); return false; }
            if (!tLoc) { alert('–£–∫–∞–∂–∏ –ª–æ–∫–∞—Ü–∏—é —Å–æ–±—ã—Ç–∏—è'); return false; }
          }
          return true;
        }
        if (step === 3) {
          var request = document.getElementById('request').value.trim();
          if (request.length < 5) { alert('–î–æ–±–∞–≤—å –∑–∞–ø—Ä–æ—Å (5+ —Å–∏–º–≤–æ–ª–æ–≤)'); return false; }
          return true;
        }
        return true;
      }

      document.querySelectorAll('.mode-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          setMode(this.getAttribute('data-mode'));
        });
      });

      if (quickToggle && quickPanel) {
        quickToggle.addEventListener('click', function() {
          var isOpen = quickPanel.classList.toggle('open');
          this.setAttribute('aria-expanded', String(isOpen));
          this.textContent = isOpen ? '–°–∫—Ä—ã—Ç—å' : '–ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã';
        });
      }
      document.querySelectorAll('.example-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var requestField = document.getElementById('request');
          if (requestField) {
            requestField.value = this.getAttribute('data-text') || '';
            requestField.focus();
          }
          if (quickPanel) {
            quickPanel.classList.remove('open');
            if (quickToggle) {
              quickToggle.setAttribute('aria-expanded', 'false');
              quickToggle.textContent = '–ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã';
            }
          }
        });
      });

      if (stepNext) stepNext.addEventListener('click', function() {
        if (!validateStep(currentStep)) return;
        if (currentStep < totalSteps) {
          currentStep += 1;
          updateStepUI();
        } else {
          goToPage('paymentPage');
        }
      });
      if (stepPrev) stepPrev.addEventListener('click', function() {
        if (currentStep > 1) {
          currentStep -= 1;
          updateStepUI();
        }
      });
      setMode('single');
      updateStepUI();
      var promoApplyBtn = document.getElementById('promoApplyBtn');
      if (promoApplyBtn) promoApplyBtn.addEventListener('click', applyPromoCode);
      
      var backFromPaymentBtn = document.getElementById('backFromPaymentBtn');
      if (backFromPaymentBtn) backFromPaymentBtn.addEventListener('click', function() {
        if (tg && tg.MainButton && tg.MainButton.hide) tg.MainButton.hide();
        var payBtnEl = document.getElementById('payBtn');
        if (payBtnEl) { payBtnEl.disabled = false; payBtnEl.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É'; }
        goToPage('formPage');
      });
      var payBtn = document.getElementById('payBtn');
      if (payBtn) payBtn.addEventListener('click', async function() {
        if (payBtn.disabled) return;
        var mode = selectedMode || 'single';
        var name1 = document.getElementById('name').value.trim();
        var birthdate1 = document.getElementById('birthdate').value;
        var birthplace1 = document.getElementById('birthplace').value.trim();
        var birthtime1 = document.getElementById('birthtime').value;
        var birthtimeUnknown1 = document.getElementById('unknown').checked;
        var gender1 = document.getElementById('gender').value;
        var requestText = document.getElementById('request').value.trim();
        if (name1.length < 2) { alert('‚ú® –ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞'); return; }
        if (!birthdate1) { alert('‚ú® –í—ã–±–µ—Ä–∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è'); return; }
        if (birthplace1.length < 3) { alert('‚ú® –ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞'); return; }
        if (!birthtimeUnknown1 && !birthtime1) { alert('‚ú® –£–∫–∞–∂–∏ –≤—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è –∏–ª–∏ –æ—Ç–º–µ—Ç—å "–ù–µ –∑–Ω–∞—é"'); return; }
        if (!gender1) { alert('‚ú® –í—ã–±–µ—Ä–∏ —Å–≤–æ–π –ø—É—Ç—å'); return; }
        if (requestText.length < 15) { alert('‚ú® –†–∞—Å—Å–∫–∞–∂–∏ –í—Å–µ–ª–µ–Ω–Ω–æ–π –ø–æ–¥—Ä–æ–±–Ω–µ–µ (–º–∏–Ω–∏–º—É–º 15 —Å–∏–º–≤–æ–ª–æ–≤)'); return; }
        var payload = {
          mode: mode,
          person1: { name: name1, birthdate: birthdate1, birthplace: birthplace1, birthtime: birthtimeUnknown1 ? null : birthtime1, birthtimeUnknown: birthtimeUnknown1, gender: gender1 },
          request: requestText,
          language: (document.getElementById('language') && document.getElementById('language').value) || 'ru'
        };
        var birthplaceField = document.getElementById('birthplace');
        if (birthplaceField && birthplaceField.getAttribute('data-lat') && birthplaceField.getAttribute('data-lon')) {
          payload.person1.birthplaceLat = parseFloat(birthplaceField.getAttribute('data-lat'));
          payload.person1.birthplaceLon = parseFloat(birthplaceField.getAttribute('data-lon'));
        }
        var forWho = document.getElementById('forWho');
        if (forWho && forWho.value && userTariff === 'master') payload.clientId = forWho.value;
        if (mode === 'couple') {
          var name2 = document.getElementById('name2').value.trim();
          var birthdate2 = document.getElementById('birthdate2').value;
          var birthplace2 = document.getElementById('birthplace2').value.trim();
          var birthtime2 = document.getElementById('birthtime2').value;
          var birthtimeUnknown2 = document.getElementById('unknown2').checked;
          var gender2 = document.getElementById('gender2').value;
          if (name2.length < 2) { alert('‚ú® –ò–º—è –≤—Ç–æ—Ä–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞'); return; }
          if (!birthdate2) { alert('‚ú® –í—ã–±–µ—Ä–∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –≤—Ç–æ—Ä–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞'); return; }
          if (birthplace2.length < 3) { alert('‚ú® –ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è –≤—Ç–æ—Ä–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞'); return; }
          if (!birthtimeUnknown2 && !birthtime2) { alert('‚ú® –£–∫–∞–∂–∏ –≤—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è –≤—Ç–æ—Ä–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞'); return; }
          if (!gender2) { alert('‚ú® –í—ã–±–µ—Ä–∏ –ø–æ–ª –≤—Ç–æ—Ä–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞'); return; }
          payload.person2 = { name: name2, birthdate: birthdate2, birthplace: birthplace2, birthtime: birthtimeUnknown2 ? null : birthtime2, birthtimeUnknown: birthtimeUnknown2, gender: gender2 };
        }
        if (mode === 'transit') {
          var transitDate = document.getElementById('transitDate').value;
          var transitTime = document.getElementById('transitTime').value;
          var transitLocation = (document.getElementById('transitLocation') && document.getElementById('transitLocation').value) ? document.getElementById('transitLocation').value.trim() : '';
          var transitIntent = (document.getElementById('transitIntent') && document.getElementById('transitIntent').value) ? document.getElementById('transitIntent').value.trim() : null;
          if (!transitDate) { alert('‚ú® –í—ã–±–µ—Ä–∏ –¥–∞—Ç—É —Å–æ–±—ã—Ç–∏—è'); return; }
          if (!transitLocation) { alert('‚ú® –£–∫–∞–∂–∏ –ª–æ–∫–∞—Ü–∏—é —Å–æ–±—ã—Ç–∏—è'); return; }
          if (!(document.getElementById('transitLocationConfirmed') && document.getElementById('transitLocationConfirmed').checked)) { alert('‚ú® –ü–æ–¥—Ç–≤–µ—Ä–¥–∏, —á—Ç–æ –ª–æ–∫–∞—Ü–∏—è —É–∫–∞–∑–∞–Ω–∞ –≤–µ—Ä–Ω–æ'); return; }
          payload.transit = { date: transitDate, time: transitTime || null, location: transitLocation, intent: transitIntent || null };
        }
        var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        if (!apiBase) { alert('–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∞–¥—Ä–µ—Å API. –£–∫–∞–∂–∏ HEROES_API_BASE.'); return; }
        var initData = (tg && tg.initData) ? tg.initData : (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) || '';
        if (!initData) { alert('–û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ —á–∞—Ç–∞ —Å –±–æ—Ç–æ–º –≤ Telegram ‚Äî –∏–Ω–∞—á–µ –∑–∞—è–≤–∫—É –Ω–µ–ª—å–∑—è –ø—Ä–∏–Ω—è—Ç—å.'); return; }
        payload.initData = initData;
        try {
          var response = await fetch(apiBase + '/api/submit-request', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData }, body: JSON.stringify(payload) });
          var result = await response.json().catch(function() { return {}; });
          if (response.ok && result.ok && result.requestId) {
            goToPage('loadingPage');
            var sp = document.getElementById('songPreviewText');
            if (sp) {
              if (mode === 'single') sp.textContent = '‚ú® ' + name1 + ', –í—Å–µ–ª–µ–Ω–Ω–∞—è —É—Å–ª—ã—à–∞–ª–∞ —Ç–≤–æ–π –∑–∞–ø—Ä–æ—Å.\n\n–¢–≤–æ–π –∑–≤—É–∫–æ–≤–æ–π –∫–ª—é—á —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è. –ß–µ—Ä–µ–∑ 2-3 –º–∏–Ω—É—Ç—ã –æ–Ω –ø—Ä–∏–¥—ë—Ç –≤ —ç—Ç–æ—Ç —á–∞—Ç.';
              else if (mode === 'couple') sp.textContent = '‚ú® ' + name1 + ' –∏ ' + payload.person2.name + ', –í—Å–µ–ª–µ–Ω–Ω–∞—è —É—Å–ª—ã—à–∞–ª–∞ –≤–∞—à –∑–∞–ø—Ä–æ—Å.\n\n–í–∞—à –∑–≤—É–∫–æ–≤–æ–π –∫–ª—é—á —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è. –ß–µ—Ä–µ–∑ 2-3 –º–∏–Ω—É—Ç—ã –æ–Ω –ø—Ä–∏–¥—ë—Ç –≤ —ç—Ç–æ—Ç —á–∞—Ç.';
              else sp.textContent = '‚ú® ' + name1 + ', –í—Å–µ–ª–µ–Ω–Ω–∞—è —É—Å–ª—ã—à–∞–ª–∞ —Ç–≤–æ–π –∑–∞–ø—Ä–æ—Å.\n\n–ó–≤—É–∫–æ–≤–æ–π –∫–ª—é—á –≠–Ω–µ—Ä–≥–∏–∏ –î–Ω—è —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è. –ß–µ—Ä–µ–∑ 2-3 –º–∏–Ω—É—Ç—ã –æ–Ω –ø—Ä–∏–¥—ë—Ç –≤ —ç—Ç–æ—Ç —á–∞—Ç.';
            }
            if (tg && tg.disableClosingConfirmation) try { tg.disableClosingConfirmation(); } catch (e) {}
          goToPage('successPage');
            console.log('[MiniApp] –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞, requestId:', result.requestId);
          } else if (result && result.payment_required && result.requestId) {
            setPaymentStatus('–¢—Ä–µ–±—É–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞. –û—Ç–∫—Ä—ã–≤–∞—é HOT Checkout...', 'warn');
            var hotResp = await fetch(apiBase + '/api/payments/hot/create', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
              body: JSON.stringify({ request_id: result.requestId, sku: result.sku || getCurrentSku(), promo_code: activePromo ? activePromo.code : null, initData: initData })
            });
            var hotJson = await hotResp.json().catch(function() { return {}; });
            if (!hotResp.ok || !hotJson.success) {
              throw new Error(hotJson.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –æ–ø–ª–∞—Ç—É HOT');
            }
            if (hotJson.free_applied) {
              setPaymentStatus('–ü—Ä–æ–º–æ–∫–æ–¥ –¥–∞–ª –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é. –ó–∞–ø—É—Å–∫...', 'ok');
              goToPage('loadingPage');
              setTimeout(function() { goToPage('successPage'); }, 1800);
              return;
            }
            if (!hotJson.checkout_url) throw new Error('Checkout URL –Ω–µ –ø–æ–ª—É—á–µ–Ω');
            setPaymentStatus('–û—Ç–∫—Ä—ã—Ç HOT Checkout. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤–µ—Ä–Ω–∏—Å—å –≤ Mini App ‚Äî —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.', 'warn');
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.openLink) window.Telegram.WebApp.openLink(hotJson.checkout_url);
            else window.open(hotJson.checkout_url, '_blank');
            var maxAttempts = 60;
            var attempt = 0;
            var paid = false;
            while (attempt < maxAttempts) {
              attempt += 1;
              await new Promise(function(resolve) { setTimeout(resolve, 3000); });
              var statusResp = await fetch(apiBase + '/api/payments/hot/status?request_id=' + encodeURIComponent(result.requestId), {
                headers: { 'X-Telegram-Init': initData }
              });
              var statusJson = await statusResp.json().catch(function() { return {}; });
              var paymentStatus = statusJson && statusJson.data && statusJson.data.payment_status ? String(statusJson.data.payment_status).toLowerCase() : '';
              if (paymentStatus === 'paid') { paid = true; break; }
            }
            if (!paid) {
              setPaymentStatus('–û–ø–ª–∞—Ç–∞ –ø–æ–∫–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å –ø–æ–∑–∂–µ –∏–ª–∏ –æ—Ç–∫—Ä–æ–π –æ–ø–ª–∞—Ç—É –ø–æ–≤—Ç–æ—Ä–Ω–æ.', 'warn');
              return;
            }
            setPaymentStatus('–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞. –ó–∞–ø—É—Å–∫–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é...', 'ok');
            var restartResp = await fetch(apiBase + '/api/payments/hot/confirm', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-Telegram-Init': initData },
              body: JSON.stringify({ request_id: result.requestId, initData: initData })
            });
            if (!restartResp.ok) {
              setPaymentStatus('–û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞, –Ω–æ –∞–≤—Ç–æ‚Äë—Å—Ç–∞—Ä—Ç –Ω–µ —É–¥–∞–ª—Å—è. –ó–∞–ø—É—Å—Ç–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –≤ –∞–¥–º–∏–Ω–∫–µ –ø–æ request_id: ' + result.requestId, 'warn');
              return;
            }
            goToPage('loadingPage');
            setTimeout(function() { goToPage('successPage'); }, 1800);
          } else throw new Error(result.error || 'HTTP ' + response.status);
        } catch (error) {
          console.error('[MiniApp] –û—à–∏–±–∫–∞:', error);
          var msg = (error && error.message) ? String(error.message) : '';
          if (!msg || /^HTTP\s+\d+$/i.test(msg)) {
            msg = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É. –ü–æ–ø—Ä–æ–±—É–π –æ—Ç–∫—Ä—ã—Ç—å Mini App –∑–∞–Ω–æ–≤–æ –∏–∑ —á–∞—Ç–∞ —Å –±–æ—Ç–æ–º –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ—â—ë —Ä–∞–∑.';
          }
          setPaymentStatus(msg || '–û—à–∏–±–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–ø–ª–∞—Ç—ã/–∑–∞—è–≤–∫–∏', 'error');
          alert('‚ùå ' + msg);
        }
      });
      
      var goHeroesBtn = document.getElementById('goHeroesBtn');
      if (goHeroesBtn) goHeroesBtn.addEventListener('click', function() { goToPage('heroesPage'); loadHeroesList(); });

      function loadHeroesList() {
        var listEl = document.getElementById('heroesList');
        if (!listEl) return;
        listEl.innerHTML = '<p style="color:#6b7280">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
        var search = (document.getElementById('heroesSearch') || {}).value;
        var q = search ? '?search=' + encodeURIComponent(search) : '';
        heroesApi('/heroes' + q, { method: 'GET' }).then(function(d) {
          heroesCache = (d && d.clients) || [];
          if (!heroesCache.length) { listEl.innerHTML = '<p style="color:#6b7280">–ü–æ–∫–∞ –Ω–µ—Ç –≥–µ—Ä–æ–µ–≤. –ù–∞–∂–º–∏ ¬´–î–æ–±–∞–≤–∏—Ç—å –≥–µ—Ä–æ—è¬ª.</p>'; return; }
          listEl.innerHTML = heroesCache.map(function(h) {
            var dateStr = h.birth_date || '‚Äî';
            var addStr = h.created_at ? new Date(h.created_at).toLocaleDateString('ru-RU') : '';
            return '<div class="section" style="margin-bottom:12px" data-hero-id="' + (h.id || '') + '">' +
              '<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">' +
              '<strong>' + (h.name || '‚Äî') + '</strong>' +
              '<span style="font-size:.9rem;color:#6b7280">' + dateStr + (addStr ? ' ¬∑ ' + addStr : '') + '</span>' +
              '</div>' +
              (h.birth_place ? '<div style="font-size:.95rem;color:#6b7280;margin-top:6px">' + h.birth_place + '</div>' : '') +
              '<div style="margin-top:10px;display:flex;gap:8px">' +
              '<button type="button" class="secondary hero-edit-btn" style="padding:8px 14px;font-size:.9rem" data-id="' + (h.id || '') + '">–ò–∑–º–µ–Ω–∏—Ç—å</button>' +
              '<button type="button" class="secondary hero-delete-btn" style="padding:8px 14px;font-size:.9rem;color:#dc2626" data-id="' + (h.id || '') + '" data-name="' + (h.name || '').replace(/"/g, '&quot;') + '">–£–¥–∞–ª–∏—Ç—å</button>' +
              '</div></div>';
          }).join('');
          listEl.querySelectorAll('.hero-edit-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              var id = btn.getAttribute('data-id');
              var h = heroesCache.find(function(c) { return c.id === id; });
              if (!h) return;
              editingHeroId = id;
              document.getElementById('heroName').value = h.name || '';
              document.getElementById('heroBirthdate').value = h.birth_date || '';
              document.getElementById('heroBirthtime').value = (h.birth_time || '').substring(0, 5);
              document.getElementById('heroBirthplace').value = h.birth_place || '';
              document.getElementById('heroBirthtimeUnknown').checked = !!h.birthtime_unknown;
              document.getElementById('heroGender').value = h.gender || '';
              document.getElementById('heroNotes').value = h.notes || '';
              document.getElementById('heroFormWrap').style.display = 'block';
            });
          });
          listEl.querySelectorAll('.hero-delete-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              var id = btn.getAttribute('data-id');
              var name = btn.getAttribute('data-name') || '—ç—Ç–æ–≥–æ –≥–µ—Ä–æ—è';
              if (!confirm('–£–¥–∞–ª–∏—Ç—å ¬´' + name + '¬ª? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
              heroesApi('/heroes/' + id, { method: 'DELETE' }).then(function() { loadHeroesList(); }).catch(function(e) { alert('–û—à–∏–±–∫–∞: ' + (e.message || e)); });
            });
          });
        }).catch(function(e) {
          listEl.innerHTML = '<p style="color:#dc2626">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É API.</p>';
        });
      }
      var addHeroBtn = document.getElementById('addHeroBtn');
      var heroFormWrap = document.getElementById('heroFormWrap');
      var heroFormCancel = document.getElementById('heroFormCancel');
      if (addHeroBtn) addHeroBtn.addEventListener('click', function() {
        editingHeroId = null;
        document.getElementById('heroName').value = '';
        document.getElementById('heroBirthdate').value = '';
        document.getElementById('heroBirthtime').value = '';
        document.getElementById('heroBirthplace').value = '';
        document.getElementById('heroBirthtimeUnknown').checked = false;
        document.getElementById('heroGender').value = '';
        document.getElementById('heroNotes').value = '';
        heroFormWrap.style.display = 'block';
      });
      if (heroFormCancel) heroFormCancel.addEventListener('click', function() { heroFormWrap.style.display = 'none'; editingHeroId = null; });
      var heroFormSave = document.getElementById('heroFormSave');
      if (heroFormSave) heroFormSave.addEventListener('click', function() {
        var name = (document.getElementById('heroName') || {}).value.trim();
        if (!name) { alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è'); return; }
        var payload = {
          initData: (tg && tg.initData) || '',
          name: name,
          birth_date: (document.getElementById('heroBirthdate') || {}).value || null,
          birth_time: (document.getElementById('heroBirthtime') || {}).value || null,
          birth_place: (document.getElementById('heroBirthplace') || {}).value.trim() || null,
          birthtime_unknown: (document.getElementById('heroBirthtimeUnknown') || {}).checked,
          gender: (document.getElementById('heroGender') || {}).value || null,
          notes: (document.getElementById('heroNotes') || {}).value.trim() || null
        };
        if (editingHeroId) {
          heroesApi('/heroes/' + editingHeroId, { method: 'PATCH', body: payload }).then(function() {
            heroFormWrap.style.display = 'none';
            editingHeroId = null;
            loadHeroesList();
          }).catch(function(e) { alert('–û—à–∏–±–∫–∞: ' + (e.message || e)); });
        } else {
          heroesApi('/heroes', { method: 'POST', body: payload }).then(function() {
            heroFormWrap.style.display = 'none';
            loadHeroesList();
          }).catch(function(e) { alert('–û—à–∏–±–∫–∞: ' + (e.message || e)); });
        }
      });
      var heroesSearchBtn = document.getElementById('heroesSearchBtn');
      if (heroesSearchBtn) heroesSearchBtn.addEventListener('click', loadHeroesList);
      var heroesBackBtn = document.getElementById('heroesBackBtn');
      if (heroesBackBtn) heroesBackBtn.addEventListener('click', function() { goToPage('homePage'); });
      var todayHero = new Date();
      var heroBirthdateEl = document.getElementById('heroBirthdate');
      if (heroBirthdateEl) {
        heroBirthdateEl.max = todayHero.toISOString().split('T')[0];
        var minH = new Date(); minH.setFullYear(minH.getFullYear() - 100);
        heroBirthdateEl.min = minH.toISOString().split('T')[0];
      }

      function fillFormFromHero(hero) {
        if (!hero) return;
        var nameEl = document.getElementById('name');
        var bd = document.getElementById('birthdate');
        var bt = document.getElementById('birthtime');
        var bp = document.getElementById('birthplace');
        var unk = document.getElementById('unknown');
        var g = document.getElementById('gender');
        if (nameEl) nameEl.value = hero.name || '';
        if (bd) bd.value = hero.birth_date || '';
        if (bt) bt.value = (hero.birth_time || '').substring(0, 5);
        if (bp) bp.value = hero.birth_place || '';
        if (unk) unk.checked = !!hero.birthtime_unknown;
        if (g) g.value = hero.gender || '';
        var langEl = document.getElementById('language');
        if (langEl && hero.language) langEl.value = hero.language;
        if (birthdateSummary) { birthdateSummary.textContent = hero.birth_date ? '–í—ã–±—Ä–∞–Ω–æ: ' + formatDateRu(hero.birth_date) : ''; birthdateSummary.style.display = hero.birth_date ? 'block' : 'none'; }
        if (birthplaceSummary) { birthplaceSummary.textContent = hero.birth_place ? '–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è: ' + hero.birth_place : ''; birthplaceSummary.style.display = hero.birth_place ? 'block' : 'none'; }
      }
      function loadForWhoSelect() {
        var wrap = document.getElementById('forWhoWrap');
        var sel = document.getElementById('forWho');
        if (!wrap || !sel) return;
        if (userTariff !== 'master') { wrap.style.display = 'none'; return; }
        wrap.style.display = 'block';
        heroesApi('/heroes', { method: 'GET' }).then(function(d) {
          heroesCache = (d && d.clients) || [];
          sel.innerHTML = '<option value="">–î–ª—è —Å–µ–±—è</option>' + heroesCache.map(function(h) { return '<option value="' + (h.id || '') + '">–î–ª—è: ' + (h.name || '‚Äî') + '</option>'; }).join('');
          sel.addEventListener('change', function() {
            var id = sel.value;
            if (!id) { fillFormFromHero(null); return; }
            var hero = heroesCache.find(function(c) { return c.id === id; });
            if (hero) fillFormFromHero(hero);
          });
        }).catch(function() { wrap.style.display = 'none'; });
      }

      var newKeyBtn = document.getElementById('newKeyBtn');
      if (newKeyBtn) newKeyBtn.addEventListener('click', function() {
        var n = document.getElementById('name');
        var bd = document.getElementById('birthdate');
        var bp = document.getElementById('birthplace');
        var bt = document.getElementById('birthtime');
        var g = document.getElementById('gender');
        var langEl = document.getElementById('language');
        var r = document.getElementById('request');
        if (n) n.value = '';
        if (bd) bd.value = '';
        if (bp) bp.value = '';
        if (bt) bt.value = '';
        if (unknown) unknown.checked = false;
        if (g) g.value = '';
        if (langEl) langEl.value = '';
        if (r) r.value = '';
        if (birthdateSummary) birthdateSummary.style.display = 'none';
        if (birthplaceSummary) birthplaceSummary.style.display = 'none';
        goToPage('formPage');
      });
      
      document.querySelectorAll('.preview-nav button').forEach(function(button) {
        button.addEventListener('click', function() {
          var pageMap = { 'home': 'homePage', 'form': 'formPage', 'payment': 'paymentPage', 'loading': 'loadingPage', 'success': 'successPage', 'heroes': 'heroesPage' };
          document.querySelectorAll('.preview-nav button').forEach(function(btn) { btn.classList.remove('active'); });
          this.classList.add('active');
          goToPage(pageMap[button.getAttribute('data-page')] || 'homePage');
        });
      });
      
      (function checkAdminAndShowLink() {
        var apiBase = (window.BACKEND_URL || window.HEROES_API_BASE || '').replace(/\/$/, '');
        var initData = (tg && tg.initData) ? tg.initData : (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) || '';
        if (!apiBase || !initData) return;
        fetch(apiBase + '/api/admin/me', { headers: { 'X-Telegram-Init': initData } })
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (!data || !data.admin) return;
            var wrap = document.getElementById('adminLinkWrap');
            var btn = document.getElementById('adminLinkBtn');
            if (!wrap || !btn) return;
            wrap.style.display = 'block';
            btn.addEventListener('click', function(e) {
              e.preventDefault();
              var url = apiBase + '/admin';
              if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.openLink) window.Telegram.WebApp.openLink(url);
              else window.open(url, '_blank');
            });
          })
          .catch(function() {});
      })();
        } catch (e) {
          console.warn('App init error:', e);
        }
      }, 50);
    });
  </script>
</body>
</html>
