<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>–ê–¥–º–∏–Ω–∫–∞ YupSoul</title>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0f0f1b; color: #fff; font-family: 'Comfortaa', system-ui, sans-serif; padding: 12px 16px; line-height: 1.5; font-size: 14px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px 18px; border-radius: 10px; margin-bottom: 14px; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 10px; }
    .header-left { display: flex; align-items: baseline; gap: 12px; flex-wrap: wrap; }
    .header h1 { font-size: 18px; font-weight: 700; letter-spacing: 0.02em; }
    .header-sub { opacity: 0.9; font-size: 12px; color: rgba(255,255,255,0.85); }
    .header-meta { font-size: 10px; color: rgba(255,255,255,0.55); }
    .header-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    #url-info { font-size: 10px; color: rgba(255,255,255,0.5); max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    #loadingStatus { margin: 0; padding: 4px 10px; background: rgba(255,255,255,0.12); border-radius: 6px; font-size: 11px; display: inline-flex; align-items: center; gap: 6px; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; margin-bottom: 14px; }
    .stat-card { background: #1a1a2e; padding: 10px 12px; border-radius: 8px; text-align: center; border-left: 3px solid #667eea; cursor: pointer; transition: all 0.2s; user-select: none; }
    .stat-card:hover { background: #232340; box-shadow: 0 2px 10px rgba(102,126,234,0.15); }
    .stat-card.active-filter { box-shadow: 0 0 0 2px #667eea; background: #232350; }
    .stat-card.pending { border-left-color: #f39c12; }
    .stat-card.pending:hover, .stat-card.pending.active-filter { box-shadow: 0 0 0 2px #f39c12; }
    .stat-card.completed { border-left-color: #27ae60; }
    .stat-card.completed:hover, .stat-card.completed.active-filter { box-shadow: 0 0 0 2px #27ae60; }
    .stat-card.failed { border-left-color: #e74c3c; }
    .stat-card.failed:hover, .stat-card.failed.active-filter { box-shadow: 0 0 0 2px #e74c3c; }
    .stat-number { font-size: 26px; font-weight: bold; margin: 2px 0; line-height: 1.2; }
    .stat-label { font-size: 11px; opacity: 0.9; }
    .sort-bar { background: #1a1a2e; padding: 8px 12px; border-radius: 8px; margin-bottom: 10px; display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
    .sort-bar span { font-size: 13px; color: #94a3b8; margin-right: 4px; }
    .sort-btn { padding: 6px 14px; background: #2d3748; border: 1px solid #4a5568; color: #cbd5e1; border-radius: 6px; cursor: pointer; font-size: 13px; font-family: inherit; transition: all 0.15s; }
    .sort-btn:hover { background: #4a5568; }
    .sort-btn.active { background: linear-gradient(135deg,#667eea,#764ba2); border-color: #667eea; color: #fff; }
    .pay-badge { display:inline-block; padding: 2px 8px; border-radius: 5px; font-size: 11px; font-weight: 600; margin-left: 4px; }
    .pay-badge-gift { background: rgba(139,92,246,.25); color: #c4b5fd; }
    .pay-badge-promo { background: rgba(212,175,55,.2); color: #fde68a; }
    .pay-badge-hot { background: rgba(59,130,246,.2); color: #93c5fd; }
    .pay-badge-sub { background: rgba(16,185,129,.2); color: #6ee7b7; }
    .pay-badge-free { background: rgba(34,197,94,.2); color: #86efac; }
    .filters { background: #1a1a2e; padding: 10px 12px; border-radius: 8px; margin-bottom: 14px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
    .filter-btn { padding: 10px 20px; background: #2d3748; border: 2px solid #4a5568; color: #fff; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
    .filter-btn:hover { background: #4a5568; transform: translateY(-1px); }
    .filter-btn.active { background: linear-gradient(135deg, #667eea, #764ba2); border-color: #667eea; }
    .request-card { background: #1a1a2e; border-radius: 10px; padding: 16px 18px; margin-bottom: 14px; border: 1px solid #2d3748; transition: all 0.2s; }
    .request-card:hover { border-color: #667eea; }
    .request-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; padding-bottom: 10px; border-bottom: 1px solid #2d3748; }
    .request-name { font-size: 17px; font-weight: bold; }
    .request-id { font-size: 11px; color: #94a3b8; margin-top: 3px; font-family: monospace; }
    .request-status { padding: 8px 20px; border-radius: 20px; font-weight: bold; min-width: 140px; text-align: center; }
    .status-pending { background: #f39c12; color: #000; }
    .status-completed { background: #27ae60; color: #fff; }
    .status-delivery-failed { background: #e67e22; color: #fff; }
    .status-failed { background: #e74c3c; color: #fff; }
    .status-payment { background: #8b5cf6; color: #fff; }
    .status-cancelled { background: #475569; color: #fff; }
    .progress-container { background: rgba(102, 126, 234, 0.1); padding: 12px 14px; border-radius: 8px; margin: 14px 0; }
    .progress-title { text-align: center; font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #667eea; }
    .progress-steps { display: flex; justify-content: space-between; position: relative; margin-bottom: 30px; }
    .progress-steps::before { content: ''; position: absolute; top: 20px; left: 15px; right: 15px; height: 4px; background: #2d3748; z-index: 1; }
    .step { text-align: center; position: relative; z-index: 2; width: 80px; }
    .step-circle { width: 40px; height: 40px; border-radius: 50%; background: #2d3748; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold; border: 3px solid #2d3748; transition: all 0.3s; }
    .step-label { font-size: 12px; color: #94a3b8; font-weight: 500; }
    .step.done .step-circle { background: #27ae60; border-color: #27ae60; color: #fff; }
    .step.current .step-circle { background: #667eea; border-color: #667eea; color: #fff; transform: scale(1.1); }
    .step-label.ru { display: block; font-size: 13px; color: #fff; margin-top: 4px; }
    .step-label.en { display: block; font-size: 11px; color: #94a3b8; }
    .step-log { font-size: 11px; color: #64748b; margin-top: 4px; max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .step.done .step-log { color: #86efac; }
    .actions { display: flex; gap: 12px; margin-top: 25px; flex-wrap: wrap; }
    .btn { padding: 12px 25px; border: none; border-radius: 8px; color: #fff; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; min-width: 160px; justify-content: center; }
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); }
    .btn-success { background: linear-gradient(135deg, #27ae60, #2ecc71); }
    .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); color: #000; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.3); }
    .details-section { margin: 14px 0; padding: 12px 14px; background: rgba(255,255,255,0.03); border-radius: 8px; }
    .section-title { font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #667eea; display: flex; align-items: center; gap: 8px; }
    .content-text { font-size: 14px; line-height: 1.7; white-space: pre-wrap; max-height: 250px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; }
    .audio-player { width: 100%; margin: 15px 0; }
    .loading { text-align: center; padding: 50px; color: #94a3b8; }
    .spinner { width: 40px; height: 40px; border: 4px solid rgba(102,126,234,0.3); border-top-color: #667eea; border-radius: 50%; margin: 0 auto 15px; animation: spin 1s linear infinite; }
    .mono-panel { margin-bottom: 22px; padding: 16px; border-radius: 10px; border: 1px solid #334155; background: rgba(15, 23, 42, 0.5); }
    .mono-panel h3 { margin: 0 0 10px 0; color: #c4b5fd; font-size: 16px; }
    .mono-table-wrap { overflow-x: auto; border-radius: 8px; border: 1px solid #334155; }
    .mono-table { width: 100%; border-collapse: collapse; min-width: 860px; }
    .mono-table th, .mono-table td { border-bottom: 1px solid #334155; padding: 8px; font-size: 12px; vertical-align: middle; }
    .mono-table th { background: rgba(30, 41, 59, 0.7); color: #cbd5e1; text-align: left; }
    .mono-table td input, .mono-table td select { width: 100%; background: #0f172a; color: #fff; border: 1px solid #475569; border-radius: 6px; padding: 6px 8px; font-size: 12px; }
    .mono-table td input[type="checkbox"] { width: auto; transform: scale(1.05); }
    .mono-muted { color: #94a3b8; font-size: 12px; }
    .mono-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .mono-msg { margin-top: 8px; font-size: 12px; min-height: 18px; }
    /* –°–µ–∫—Ü–∏—è –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫ */
    .unpaid-section { background: rgba(139,92,246,0.08); border: 1px solid #8b5cf6; border-radius: 8px; padding: 12px 14px; margin-bottom: 14px; display: none; }
    .unpaid-section.has-items { display: block; }
    .unpaid-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .unpaid-section-title { font-size: 14px; font-weight: bold; color: #c4b5fd; display: flex; align-items: center; gap: 8px; }
    .unpaid-badge { background: #8b5cf6; color: #fff; border-radius: 10px; padding: 2px 8px; font-size: 11px; font-weight: bold; }
    .unpaid-card { background: #1a1a2e; border: 1px solid #4c1d95; border-radius: 8px; padding: 10px 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
    .unpaid-card:last-child { margin-bottom: 0; }
    .unpaid-info { flex: 1; }
    .unpaid-name { font-size: 16px; font-weight: bold; margin-bottom: 4px; }
    .unpaid-meta { font-size: 12px; color: #94a3b8; line-height: 1.6; }
    .unpaid-actions { display: flex; gap: 8px; flex-shrink: 0; flex-direction: column; }
    .btn-cancel { background: linear-gradient(135deg, #e74c3c, #c0392b); min-width: 120px; }
    .btn-restore { background: linear-gradient(135deg, #059669, #10b981); min-width: 120px; }
    .pay-filter-bar { background: #1a1a2e; padding: 10px 15px; border-radius: 10px; margin-bottom: 16px; display: flex; gap: 7px; flex-wrap: wrap; align-items: center; border: 1px solid rgba(212,175,55,0.15); }
    .pay-filter-bar span { font-size: 12px; color: #d4af37; margin-right: 4px; font-weight: 600; }
    .pay-filter-btn { padding: 5px 13px; background: #2d3748; border: 1px solid #4a5568; color: #cbd5e1; border-radius: 6px; cursor: pointer; font-size: 12px; font-family: inherit; transition: all 0.15s; }
    .pay-filter-btn:hover { background: #4a5568; }
    .pay-filter-btn.active { background: linear-gradient(135deg,#d4af37,#ec4899); border-color: #d4af37; color: #fff; font-weight: 700; }
    .bulk-actions-bar { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; padding: 8px 12px; margin-bottom: 10px; background: #1a1a2e; border-radius: 8px; border: 1px solid #334155; }
    .bulk-actions-bar label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #cbd5e1; user-select: none; }
    .bulk-actions-bar input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .bulk-actions-bar .btn { min-width: auto; padding: 10px 20px; }
    .request-card .req-select-wrap { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; }
    .request-card .req-select-wrap input[type="checkbox"] { margin-top: 4px; width: 18px; height: 18px; cursor: pointer; flex-shrink: 0; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* ‚îÄ‚îÄ Tab navigation ‚îÄ‚îÄ */
    .admin-tabs { display:flex; gap:3px; margin-bottom:12px; background:#0a0a16; padding:4px; border-radius:8px; border:1px solid #1e293b; flex-wrap:wrap; }
    .tab-btn { flex:1; min-width:90px; padding:6px 10px; background:transparent; border:none; color:#64748b; font-size:12px; font-weight:600; cursor:pointer; border-radius:6px; transition:all 0.18s; font-family:inherit; white-space:nowrap; text-align:center; }
    .tab-btn:hover { background:#1e293b; color:#cbd5e1; }
    .tab-btn.active { background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; box-shadow:0 2px 8px rgba(102,126,234,0.35); }
    .tab-pane { display:none; }
    .tab-pane.active { display:block; }
    /* ‚îÄ‚îÄ Unified filter bar ‚îÄ‚îÄ */
    .unified-filter { background:#1a1a2e; border-radius:8px; padding:8px 12px; margin-bottom:10px; border:1px solid #2d3748; }
    .uf-row { display:flex; gap:5px; flex-wrap:wrap; align-items:center; margin-bottom:5px; }
    .uf-row:last-child { margin-bottom:0; }
    .uf-label { font-size:10px; color:#64748b; font-weight:600; min-width:52px; }
    .uf-btn { padding:4px 11px; background:#2d3748; border:1px solid #374151; color:#94a3b8; border-radius:6px; cursor:pointer; font-size:11px; font-family:inherit; transition:all 0.12s; white-space:nowrap; }
    .uf-btn:hover { background:#374151; color:#e2e8f0; }
    .uf-btn.active { background:linear-gradient(135deg,#667eea,#764ba2); border-color:#667eea; color:#fff; font-weight:700; }
    .uf-btn.active-gold { background:linear-gradient(135deg,#d4af37,#ec4899); border-color:#d4af37; color:#fff; font-weight:700; }
    /* ‚îÄ‚îÄ Compact accordion request rows ‚îÄ‚îÄ */
    .req-row { background:#1a1a2e; border-radius:9px; margin-bottom:5px; border:1px solid #2d3748; overflow:hidden; transition:border-color 0.15s; }
    .req-row:hover .req-row-head { background:rgba(255,255,255,0.02); }
    .req-row.expanded { border-color:#667eea; }
    .req-row-head { display:flex; align-items:center; gap:10px; padding:10px 13px; cursor:pointer; user-select:none; }
    .req-row-main { flex:1; min-width:0; }
    .req-row-name { font-size:13px; font-weight:700; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px; }
    .req-row-meta { font-size:10px; color:#64748b; display:block; margin-top:1px; }
    .req-row-status { padding:3px 9px; border-radius:12px; font-size:10px; font-weight:700; white-space:nowrap; flex-shrink:0; }
    .req-row-btns { display:flex; gap:5px; flex-shrink:0; flex-wrap:wrap; }
    .rmb { padding:4px 9px; border-radius:5px; font-size:11px; font-weight:600; cursor:pointer; font-family:inherit; white-space:nowrap; border:1px solid transparent; transition:opacity 0.15s; line-height:1.4; }
    .rmb:hover { opacity:0.8; }
    .rmb-blue { background:rgba(102,126,234,0.2); color:#a5b4fc; border-color:rgba(102,126,234,0.3); }
    .rmb-green { background:rgba(39,174,96,0.2); color:#86efac; border-color:rgba(39,174,96,0.3); }
    .rmb-orange { background:rgba(243,156,18,0.2); color:#fcd34d; border-color:rgba(243,156,18,0.25); }
    .rmb-red { background:rgba(231,76,60,0.18); color:#fca5a5; border-color:rgba(231,76,60,0.25); }
    .rmb-purple { background:rgba(139,92,246,0.18); color:#c4b5fd; border-color:rgba(139,92,246,0.25); }
    .tg-id-badge { font-size:10px; color:#94a3b8; background:rgba(148,163,184,0.08); border:1px solid rgba(148,163,184,0.15); border-radius:5px; padding:2px 6px; white-space:nowrap; cursor:pointer; flex-shrink:0; transition:background 0.15s; }
    .tg-id-badge:hover { background:rgba(148,163,184,0.18); color:#cbd5e1; }
    .field-row { display:flex; align-items:flex-start; gap:8px; padding:3px 0; font-size:12px; }
    .field-label { color:#64748b; min-width:110px; flex-shrink:0; }
    .field-value { color:#e2e8f0; word-break:break-all; }
    .req-chevron { font-size:14px; color:#475569; transition:transform 0.18s; flex-shrink:0; width:16px; text-align:center; }
    .req-row.expanded .req-chevron { transform:rotate(90deg); color:#a5b4fc; }
    .req-row-body { display:none; border-top:1px solid #2d3748; padding:14px 14px 12px; }
    .req-row-body .progress-container { margin:0 0 14px 0; }
    .req-row-body .details-section { margin:10px 0 0 0; padding:12px; }
    .req-row-body .actions { margin-top:14px; }
    .detail-section-inline { background:rgba(255,255,255,0.025); border:1px solid #1e293b; border-radius:8px; overflow:hidden; }
    .dsi-title { font-size:11px; font-weight:700; color:#94a3b8; padding:7px 12px; background:rgba(0,0,0,0.2); border-bottom:1px solid #1e293b; letter-spacing:0.3px; text-transform:uppercase; }
    .dsi-body { padding:10px 12px; font-size:12px; }
    @media (max-width: 768px) {
      .header { flex-direction: column; align-items: flex-start; }
      .header h1 { font-size: 16px; }
      .stat-number { font-size: 22px; }
      .progress-steps { flex-wrap: wrap; }
      .step { width: 100%; margin-bottom: 20px; }
      .actions { flex-direction: column; }
      .btn { width: 100%; min-width: auto; }
      .req-row-name { max-width: 130px; }
      .req-row-btns { display:none; }
      .req-row.expanded .req-row-btns { display:flex; }
    }
  </style>
</head>
<body style="background:#0f0f1b;color:#fff;font-family:'Comfortaa',system-ui,sans-serif;">
  <div class="container">
    <div class="header">
      <div class="header-left">
        <h1>üëë –ê–¥–º–∏–Ω–∫–∞ YupSoul</h1>
        <span class="header-sub">–ö–æ–Ω—Ç—Ä–æ–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</span>
        <span class="header-meta" id="url-info"></span>
      </div>
      <div class="header-right">
        <div id="loadingStatus" style="display:none;">
          <span style="display:inline-block;width:10px;height:10px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.8s linear infinite;"></span>
          <span id="loadingStatusText">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</span>
        </div>
      </div>
    </div>
    <div class="stats">
      <div class="stat-card active-filter" data-filter="all" onclick="filterByCard(this)" title="–í—Å–µ –∑–∞—è–≤–∫–∏"><div class="stat-label">üìã –í—Å–µ</div><div class="stat-number" id="total">-</div></div>
      <div class="stat-card pending" data-filter="pending" onclick="filterByCard(this)" title="–í —Ä–∞–±–æ—Ç–µ"><div class="stat-label">‚è≥ –í —Ä–∞–±–æ—Ç–µ</div><div class="stat-number" id="pending">-</div></div>
      <div class="stat-card completed" data-filter="completed" onclick="filterByCard(this)" title="–ì–æ—Ç–æ–≤–æ"><div class="stat-label">‚úÖ –ì–æ—Ç–æ–≤–æ</div><div class="stat-number" id="completed">-</div></div>
      <div class="stat-card" style="border-left-color:#e67e22;" data-filter="delivery_failed" onclick="filterByCard(this)" title="–ù–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ"><div class="stat-label">üì≠ –ù–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</div><div class="stat-number" id="stat-delivery-failed">-</div></div>
      <div class="stat-card failed" data-filter="failed" onclick="filterByCard(this)" title="–û—à–∏–±–∫–∏"><div class="stat-label">‚ùå –û—à–∏–±–∫–∏</div><div class="stat-number" id="failed">-</div></div>
      <div class="stat-card" style="border-left-color:#8b5cf6;" data-filter="pending_payment" onclick="filterByCard(this)" title="–û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã"><div class="stat-label">üí≥ –û–ø–ª–∞—Ç–∞</div><div class="stat-number" id="stat-pending-payment">-</div></div>
      <div class="stat-card" style="border-left-color:#475569;" data-filter="cancelled" onclick="filterByCard(this)" title="–û—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ"><div class="stat-label">üö´ –û—Ç–º–µ–Ω.</div><div class="stat-number" id="stat-cancelled">-</div></div>
    </div>
    <!-- Tab navigation -->
    <div class="admin-tabs">
      <button class="tab-btn active" onclick="switchTab('requests', this)">üìã –ó–∞—è–≤–∫–∏</button>
      <button class="tab-btn" onclick="switchTab('monetization', this)">üí≥ –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è</button>
      <button class="tab-btn" onclick="switchTab('users', this)">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
      <button class="tab-btn" onclick="switchTab('languages', this)">üåç –Ø–∑—ã–∫–∏</button>
      <button class="tab-btn" onclick="switchTab('settings', this)">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button class="tab-btn" onclick="switchTab('referrals', this)">üîó –†–µ—Ñ–µ—Ä–∞–ª—ã</button>
      <button class="tab-btn" onclick="switchTab('analytics', this)">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    </div>

    <!-- Tab: –ó–∞—è–≤–∫–∏ -->
    <div class="tab-pane active" id="tab-requests">
      <!-- –ù–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ -->
      <div class="unpaid-section" id="unpaidSection">
        <div class="unpaid-section-header">
          <div class="unpaid-section-title">
            ‚ö†Ô∏è –ù–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
            <span class="unpaid-badge" id="unpaidBadge">0</span>
          </div>
          <button class="btn btn-primary" style="min-width:80px;padding:6px 10px;font-size:11px;" onclick="loadUnpaidRequests()">üîÑ</button>
        </div>
        <p style="font-size:11px;color:#94a3b8;margin-bottom:8px;">–ë–µ–∑ –æ–ø–ª–∞—Ç—ã/–ø—Ä–æ–º–æ–∫–æ–¥–∞. –ë–æ—Ç—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ.</p>
        <div id="unpaidList"><div class="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div></div>
      </div>

      <!-- –û—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ -->
      <div class="unpaid-section cancelled-section" id="cancelledSection" style="margin-top:10px;">
        <div class="unpaid-section-header">
          <div class="unpaid-section-title">
            üö´ –û—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ
            <span class="unpaid-badge" id="cancelledBadge">0</span>
          </div>
          <div style="display:flex;gap:6px;align-items:center;">
            <button class="btn btn-danger" id="deleteAllCancelledBtn" style="display:none;min-width:100px;padding:6px 10px;font-size:11px;" onclick="deleteAllCancelled()" title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ">üóë –í—Å–µ</button>
            <button class="btn btn-primary" style="min-width:80px;padding:6px 10px;font-size:11px;" onclick="loadCancelledRequests()">üîÑ</button>
          </div>
        </div>
        <p style="font-size:11px;color:#94a3b8;margin-bottom:8px;">–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö ‚Äî –∑–¥–µ—Å—å –∏–ª–∏ –≤ —Å–ø–∏—Å–∫–µ –Ω–∏–∂–µ.</p>
        <div id="cancelledList"><div class="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div></div>
      </div>

      <!-- –ï–¥–∏–Ω–∞—è –ø–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
      <div class="unified-filter">
        <div class="uf-row">
<span class="uf-label">–ü–æ–∏—Å–∫ –ø–æ ID:</span>
          <input type="text" id="searchRequestId" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä bb3688da" maxlength="36" style="width:180px;padding:8px 12px;border-radius:8px;border:1px solid #4a5568;background:#2d3748;color:#fff;font-size:14px;font-family:monospace;">
          <button type="button" class="uf-btn" id="searchRequestIdBtn" style="padding:8px 16px;">üîç –ù–∞–π—Ç–∏</button>
          <button type="button" class="uf-btn" id="clearSearchIdBtn" style="padding:8px 12px;display:none;">‚úï –°–±—Ä–æ—Å–∏—Ç—å</button>
          <span id="searchByIdMsg" style="font-size:11px;color:#64748b;margin-left:4px;"></span>
        </div>
        <div class="uf-row">
          <span class="uf-label">–°—Ç–∞—Ç—É—Å:</span>
          <button class="uf-btn filter-btn active" data-filter="all">üìã –í—Å–µ</button>
          <button class="uf-btn filter-btn" data-filter="pending">‚è≥ –í —Ä–∞–±–æ—Ç–µ</button>
          <button class="uf-btn filter-btn" data-filter="pending_payment">üí≥ –û–ø–ª–∞—Ç–∞</button>
          <button class="uf-btn filter-btn" data-filter="completed">‚úÖ –ì–æ—Ç–æ–≤–æ</button>
          <button class="uf-btn filter-btn" data-filter="delivery_failed">üì≠ –ù–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</button>
          <button class="uf-btn filter-btn" data-filter="failed">‚ùå –û—à–∏–±–∫–∏</button>
          <button class="uf-btn filter-btn" data-filter="cancelled">üö´ –û—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ</button>
        </div>
        <div class="uf-row">
          <span class="uf-label">–û–ø–ª–∞—Ç–∞:</span>
          <button class="uf-btn pay-filter-btn active" data-pay="all" onclick="setPayFilter(this)">–í—Å–µ</button>
          <button class="uf-btn pay-filter-btn" data-pay="gift" onclick="setPayFilter(this)">üéÅ –ü–æ–¥–∞—Ä–æ–∫</button>
          <button class="uf-btn pay-filter-btn" data-pay="promo" onclick="setPayFilter(this)">üè∑ –ü—Ä–æ–º–æ</button>
          <button class="uf-btn pay-filter-btn" data-pay="hot" onclick="setPayFilter(this)">üí≥ HOT</button>
          <button class="uf-btn pay-filter-btn" data-pay="subscription" onclick="setPayFilter(this)">üìã –ü–æ–¥–ø–∏—Å–∫–∞</button>
          <button class="uf-btn pay-filter-btn" data-pay="awaiting" onclick="setPayFilter(this)">‚è≥ –û–∂–∏–¥–∞–µ—Ç</button>
          <button class="uf-btn pay-filter-btn" data-pay="admin" onclick="setPayFilter(this)">üîß –†—É—á–Ω–∞—è</button>
        </div>
        <div class="uf-row">
          <span class="uf-label">–ü–æ—Ä—è–¥–æ–∫:</span>
          <button class="uf-btn sort-btn active" data-sort="date_desc" onclick="setSort(this)">üïê –ù–æ–≤—ã–µ</button>
          <button class="uf-btn sort-btn" data-sort="date_asc" onclick="setSort(this)">üïê –°—Ç–∞—Ä—ã–µ</button>
          <button class="uf-btn sort-btn" data-sort="name_asc" onclick="setSort(this)">üë§ –ê‚Äì–Ø</button>
          <button class="uf-btn sort-btn" data-sort="status" onclick="setSort(this)">üìä –°—Ç–∞—Ç—É—Å</button>
          <button class="uf-btn sort-btn" data-sort="payment" onclick="setSort(this)">üí≥ –û–ø–ª–∞—Ç–∞</button>
        </div>
      </div>

      <!-- Bulk actions -->
      <div class="bulk-actions-bar" id="bulkActionsBar" style="display:none;">
        <label><input type="checkbox" id="selectAllRequests" aria-label="–í—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ –∑–∞—è–≤–∫–∏"> –í—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ</label>
        <button type="button" class="btn btn-warning" id="deleteSelectedBtn" disabled>üóë –£–¥–∞–ª–∏—Ç—å (<span id="deleteSelectedCount">0</span>)</button>
      </div>

      <!-- –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ -->
      <div id="requests" class="loading">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </div>

    <!-- Tab: –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è -->
    <div class="tab-pane" id="tab-monetization">

      <!-- ‚ïê‚ïê‚ïê –†–£–ß–ù–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø –ü–û–î–ü–ò–°–ö–ò ‚ïê‚ïê‚ïê -->
      <div class="details-section" style="margin-bottom:20px;border:1.5px solid rgba(212,175,55,0.4);background:rgba(212,175,55,0.04);">
        <div class="section-title">üîë –†—É—á–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏</div>
        <p class="mono-muted">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—Ç–∏–ª, –Ω–æ –≤–µ–±—Ö—É–∫ –Ω–µ –ø—Ä–∏—à—ë–ª –∏ —Ç–∞—Ä–∏—Ñ –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è.</p>
        <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;">
          <input type="text" id="grantSubUserId" placeholder="telegram_user_id" style="padding:8px 12px;background:#1a1a2e;border:1px solid #334155;border-radius:8px;color:#e2e8f0;font-size:14px;width:180px;">
          <select id="grantSubPlan" style="padding:8px 12px;background:#1a1a2e;border:1px solid #334155;border-radius:8px;color:#e2e8f0;font-size:14px;">
            <option value="plan_basic">Basic ($14.99)</option>
            <option value="plan_plus">Plus ($24.99)</option>
            <option value="plan_master">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è ($39.99)</option>
          </select>
          <button type="button" id="grantSubCheckBtn" class="btn" style="background:#334155;color:#e2e8f0;">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
          <button type="button" id="grantSubBtn" class="btn btn-primary">‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
        </div>
        <div id="grantSubMsg" class="mono-msg"></div>
        <div id="grantSubInfo" style="font-size:13px;color:#94a3b8;margin-top:8px;"></div>
      </div>

      <!-- ‚ïê‚ïê‚ïê –°–ü–ò–°–û–ö –ê–ö–¢–ò–í–ù–´–• –ü–û–î–ü–ò–°–û–ö ‚ïê‚ïê‚ïê -->
      <div class="details-section" style="margin-bottom:20px;">
        <div class="section-title">üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px;">
          <select id="subListPlan" style="padding:8px 12px;background:#1a1a2e;border:1px solid #334155;border-radius:8px;color:#e2e8f0;font-size:13px;">
            <option value="">–í—Å–µ —Ç–∞—Ä–∏—Ñ—ã</option>
            <option value="soul_basic_sub">Basic</option>
            <option value="soul_plus_sub">Plus</option>
            <option value="master_monthly">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è</option>
          </select>
          <input type="text" id="subListSearch" placeholder="ID / –∏–º—è / @username" style="padding:8px 12px;background:#1a1a2e;border:1px solid #334155;border-radius:8px;color:#e2e8f0;font-size:13px;width:200px;">
          <button type="button" class="btn btn-primary" onclick="loadActiveSubs()">üîç –ü–æ–∫–∞–∑–∞—Ç—å</button>
        </div>
        <div class="mono-table-wrap">
          <table class="mono-table" id="activeSubsTable">
            <thead><tr><th>ID</th><th>–ò–º—è / @</th><th>–¢–∞—Ä–∏—Ñ</th><th>–ò—Å—Ç–µ–∫–∞–µ—Ç</th><th>–û—Å—Ç–∞–ª–æ—Å—å</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead>
            <tbody id="activeSubsBody"><tr><td colspan="6" class="mono-muted">–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–∫–∞–∑–∞—Ç—å¬ª</td></tr></tbody>
          </table>
        </div>
        <div id="activeSubsMsg" class="mono-msg"></div>
      </div>

      <div class="details-section" style="margin-bottom:20px;">
        <div class="section-title">üí≥ –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è HOT</div>
        <p class="mono-muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞–º–∏, –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏ –∏ –±—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–ø–ª–∞—Ç.</p>
        <div class="mono-actions">
          <button type="button" class="btn btn-primary" id="monetization-refresh-btn" style="min-width:180px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—é</button>
        </div>
        <div id="monetizationGlobalMsg" class="mono-msg"></div>
        <div class="mono-panel" style="margin-bottom:16px;">
          <h3 style="margin-bottom:10px;">–°–≤–æ–¥–∫–∞ –ø–æ –æ–ø–ª–∞—Ç–∞–º</h3>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
            <div style="background:#1e293b;border-radius:10px;padding:12px;text-align:center;border-left:3px solid #22c55e;">
              <div id="payStatPaid24" style="font-size:1.5rem;font-weight:700;color:#22c55e;">‚Äî</div>
              <div style="font-size:0.75rem;color:#64748b;margin-top:2px;">–û–ø–ª–∞—á–µ–Ω–æ –∑–∞ 24 —á</div>
            </div>
            <div style="background:#1e293b;border-radius:10px;padding:12px;text-align:center;border-left:3px solid #3b82f6;">
              <div id="payStatPaid7" style="font-size:1.5rem;font-weight:700;color:#3b82f6;">‚Äî</div>
              <div style="font-size:0.75rem;color:#64748b;margin-top:2px;">–û–ø–ª–∞—á–µ–Ω–æ –∑–∞ 7 –¥–Ω</div>
            </div>
            <div style="background:#1e293b;border-radius:10px;padding:12px;text-align:center;border-left:3px solid #f59e0b;">
              <div id="payStatPending" style="font-size:1.5rem;font-weight:700;color:#f59e0b;">‚Äî</div>
              <div style="font-size:0.75rem;color:#64748b;margin-top:2px;">–û–∂–∏–¥–∞—é—Ç (checkout –æ—Ç–∫—Ä—ã—Ç)</div>
            </div>
          </div>
          <p class="mono-muted" style="font-size:0.75rem;margin-top:8px;margin-bottom:0;">¬´–û–∂–∏–¥–∞—é—Ç¬ª ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª ¬´–û–ø–ª–∞—Ç–∏—Ç—å¬ª –∏ –ø–µ—Ä–µ—à—ë–ª –≤ checkout; –æ–ø–ª–∞—Ç–∞ –µ—â—ë –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –≤–µ–±—Ö—É–∫–æ–º. –ï—Å–ª–∏ –¥–æ–ª–≥–æ –≤–∏—Å—è—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –≤–µ–±—Ö—É–∫–∞ –∏–ª–∏ –æ—Ç–º–µ—Ç—å –≤—Ä—É—á–Ω—É—é –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∑–∞—è–≤–∫–∏.</p>
        </div>
        <div class="mono-panel">
          <h3>–¢–∞—Ä–∏—Ñ—ã (pricing_catalog)</h3>
          <div class="mono-table-wrap">
            <table class="mono-table" id="pricingTable">
              <thead><tr><th>SKU</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¶–µ–Ω–∞</th><th>–í–∞–ª—é—Ç–∞</th><th>–ê–∫—Ç–∏–≤–µ–Ω</th><th>–õ–∏–º–∏—Ç—ã JSON</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead>
              <tbody id="pricingTableBody"><tr><td colspan="7" class="mono-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr></tbody>
            </table>
          </div>
          <div id="pricingMsg" class="mono-msg"></div>
        </div>
        <div class="mono-panel">
          <h3>–ü—Ä–æ–º–æ–∫–æ–¥—ã (promo_codes)</h3>
          <details id="newPromoDetails" style="margin-bottom:18px;border:1px solid rgba(212,175,55,0.3);border-radius:10px;padding:12px 16px;background:rgba(212,175,55,0.05);">
            <summary style="cursor:pointer;font-weight:600;color:#d4af37;font-size:0.95rem;list-style:none;">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥</summary>
            <div style="margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div><label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">–ö–æ–¥ <span style="color:#ef4444">*</span></label><input id="newPromoCode" type="text" placeholder="WELCOME10" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;text-transform:uppercase;box-sizing:border-box;"></div>
              <div><label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">–¢–∏–ø <span style="color:#ef4444">*</span></label><select id="newPromoType" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;"><option value="discount_percent">% —Å–∫–∏–¥–∫–∞</option><option value="discount_amount">–°—É–º–º–∞ —Å–∫–∏–¥–∫–∏</option><option value="free_generation">–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è</option></select></div>
              <div><label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">–ó–Ω–∞—á–µ–Ω–∏–µ</label><input id="newPromoValue" type="number" step="0.01" min="0" placeholder="10" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;"></div>
              <div><label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">SKU (–ø—É—Å—Ç–æ = –≤—Å–µ)</label><input id="newPromoSku" type="text" placeholder="single_song" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;"></div>
              <div><label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">–ú–∞–∫—Å. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</label><input id="newPromoMaxUses" type="number" step="1" min="1" placeholder="100" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;"></div>
              <div><label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">–õ–∏–º–∏—Ç –Ω–∞ 1 —é–∑–µ—Ä–∞</label><input id="newPromoPerUser" type="number" step="1" min="1" value="1" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;"></div>
              <div><label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">–î–µ–π—Å—Ç–≤—É–µ—Ç —Å</label><input id="newPromoStartsAt" type="datetime-local" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;"></div>
              <div><label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ</label><input id="newPromoExpiresAt" type="datetime-local" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;"></div>
            </div>
            <div style="margin-top:12px;display:flex;align-items:center;gap:12px;">
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;color:#94a3b8;font-size:0.88rem;"><input id="newPromoActive" type="checkbox" checked style="width:16px;height:16px;"> –ê–∫—Ç–∏–≤–µ–Ω —Å—Ä–∞–∑—É</label>
              <button onclick="createPromoCode()" class="btn btn-primary" style="padding:9px 22px;font-size:0.9rem;">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
            </div>
          </details>
          <div class="mono-table-wrap">
            <table class="mono-table" id="promoTable">
              <thead><tr><th>–ö–æ–¥</th><th>–¢–∏–ø</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th><th>SKU</th><th>–ú–∞–∫—Å / –ù–∞ —é–∑–µ—Ä–∞</th><th>–ê–∫—Ç–∏–≤–µ–Ω</th><th>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ</th><th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
              <tbody id="promoTableBody"><tr><td colspan="9" class="mono-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr></tbody>
            </table>
          </div>
          <div id="promoMsg" class="mono-msg"></div>
        </div>
        <div class="mono-panel">
          <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–ª–∞—Ç—ã</h3>
          <div class="mono-table-wrap">
            <table class="mono-table" id="paymentsTable">
              <thead><tr><th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th><th>Request ID</th><th>User ID</th><th>–ò–º—è</th><th>SKU/Mode</th><th>–ü—Ä–æ–≤–∞–π–¥–µ—Ä</th><th>–°—Ç–∞—Ç—É—Å</th><th>–°—É–º–º–∞</th><th>Order</th><th>TX</th><th>–ü—Ä–æ–º–æ</th></tr></thead>
              <tbody id="paymentsTableBody"><tr><td colspan="11" class="mono-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr></tbody>
            </table>
          </div>
          <div id="paymentsMsg" class="mono-msg"></div>
        </div>
      </div>
    </div>

    <!-- Tab: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (Soul Chat, —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏, –∑–∞—è–≤–∫–∏) -->
    <div class="tab-pane" id="tab-analytics">
      <div class="details-section" style="margin-bottom:20px;">
        <div class="section-title">üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</div>
        <p class="mono-muted" style="margin-bottom:14px;">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–≤–æ–¥–∫–∞ –±–µ–∑ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏.</p>
        <div class="mono-actions" style="margin-bottom:14px;">
          <button class="btn btn-primary" onclick="loadAnalytics()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>

        <div class="section-title" style="font-size:0.85rem;margin-bottom:8px;color:#f472b6;">Soul Chat ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–π</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;">
          <div style="background:#1e293b;border-radius:10px;padding:12px;text-align:center;border-left:3px solid #f472b6;">
            <div id="ax-sc-24" style="font-size:1.75rem;font-weight:700;color:#f472b6;">‚Äî</div>
            <div style="font-size:0.7rem;color:#64748b;margin-top:2px;">24 —á</div>
          </div>
          <div style="background:#1e293b;border-radius:10px;padding:12px;text-align:center;border-left:3px solid #f472b6;">
            <div id="ax-sc-7" style="font-size:1.75rem;font-weight:700;color:#f472b6;">‚Äî</div>
            <div style="font-size:0.7rem;color:#64748b;margin-top:2px;">7 –¥–Ω</div>
          </div>
          <div style="background:#1e293b;border-radius:10px;padding:12px;text-align:center;border-left:3px solid #f472b6;">
            <div id="ax-sc-30" style="font-size:1.75rem;font-weight:700;color:#f472b6;">‚Äî</div>
            <div style="font-size:0.7rem;color:#64748b;margin-top:2px;">30 –¥–Ω</div>
          </div>
        </div>

        <div class="section-title" style="font-size:0.85rem;margin-bottom:8px;color:#a78bfa;">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;">
          <div style="background:#1e293b;border-radius:10px;padding:12px;text-align:center;border-left:3px solid #a78bfa;">
            <div id="ax-exp-total" style="font-size:1.75rem;font-weight:700;color:#a78bfa;">‚Äî</div>
            <div style="font-size:0.7rem;color:#64748b;margin-top:2px;">–í—Å–µ–≥–æ —Å —Ç–µ–∫—Å—Ç–æ–º</div>
          </div>
          <div style="background:#1e293b;border-radius:10px;padding:12px;text-align:center;border-left:3px solid #34d399;">
            <div id="ax-exp-paid" style="font-size:1.75rem;font-weight:700;color:#34d399;">‚Äî</div>
            <div style="font-size:0.7rem;color:#64748b;margin-top:2px;">–û–ø–ª–∞—á–µ–Ω–æ</div>
          </div>
          <div style="background:#1e293b;border-radius:10px;padding:12px;text-align:center;border-left:3px solid #fbbf24;">
            <div id="ax-exp-free" style="font-size:1.75rem;font-weight:700;color:#fbbf24;">‚Äî</div>
            <div style="font-size:0.7rem;color:#64748b;margin-top:2px;">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</div>
          </div>
        </div>

        <div class="section-title" style="font-size:0.85rem;margin-bottom:8px;color:#38bdf8;">–ó–∞—è–≤–∫–∏</div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:10px;">
          <div style="background:#1e293b;border-radius:10px;padding:12px;text-align:center;border-left:3px solid #38bdf8;">
            <div style="font-size:0.7rem;color:#64748b;margin-bottom:4px;">–°–æ–∑–¥–∞–Ω–æ</div>
            <div><span id="ax-req-c-24" style="font-weight:700;color:#38bdf8;">‚Äî</span> / <span id="ax-req-c-7" style="font-weight:700;color:#38bdf8;">‚Äî</span> / <span id="ax-req-c-30" style="font-weight:700;color:#38bdf8;">‚Äî</span></div>
            <div style="font-size:0.65rem;color:#64748b;">24—á ¬∑ 7–¥ ¬∑ 30–¥</div>
          </div>
          <div style="background:#1e293b;border-radius:10px;padding:12px;text-align:center;border-left:3px solid #34d399;">
            <div style="font-size:0.7rem;color:#64748b;margin-bottom:4px;">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
            <div><span id="ax-req-d-24" style="font-weight:700;color:#34d399;">‚Äî</span> / <span id="ax-req-d-7" style="font-weight:700;color:#34d399;">‚Äî</span> / <span id="ax-req-d-30" style="font-weight:700;color:#34d399;">‚Äî</span></div>
            <div style="font-size:0.65rem;color:#64748b;">24—á ¬∑ 7–¥ ¬∑ 30–¥</div>
          </div>
        </div>
        <div id="analyticsMsg" class="mono-msg"></div>
      </div>
    </div>

    <!-- Tab: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
    <div class="tab-pane" id="tab-users">
      <div class="details-section" style="margin-bottom:20px;">
        <div class="section-title">üë• –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        <div class="mono-actions" style="margin-bottom:16px;">
          <button class="btn btn-primary" onclick="loadUserStats()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
        </div>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∏: —é–∑–µ—Ä—ã -->
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-bottom:20px;">
          <div style="background:#1e293b;border-radius:10px;padding:14px;text-align:center;">
            <div id="us-total" style="font-size:2rem;font-weight:700;color:#a78bfa;">‚Äî</div>
            <div style="font-size:0.75rem;color:#64748b;margin-top:4px;">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
          </div>
          <div style="background:#1e293b;border-radius:10px;padding:14px;text-align:center;">
            <div id="us-today" style="font-size:2rem;font-weight:700;color:#38bdf8;">‚Äî</div>
            <div style="font-size:0.75rem;color:#64748b;margin-top:4px;">–°–µ–≥–æ–¥–Ω—è</div>
          </div>
          <div style="background:#1e293b;border-radius:10px;padding:14px;text-align:center;">
            <div id="us-week" style="font-size:2rem;font-weight:700;color:#34d399;">‚Äî</div>
            <div style="font-size:0.75rem;color:#64748b;margin-top:4px;">–ó–∞ 7 –¥–Ω–µ–π</div>
          </div>
          <div style="background:#1e293b;border-radius:10px;padding:14px;text-align:center;">
            <div id="us-month" style="font-size:2rem;font-weight:700;color:#fb923c;">‚Äî</div>
            <div style="font-size:0.75rem;color:#64748b;margin-top:4px;">–ó–∞ 30 –¥–Ω–µ–π</div>
          </div>
        </div>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∏: –ø–æ–¥–ø–∏—Å–∫–∏ -->
        <div class="section-title" style="font-size:0.9rem;margin-bottom:10px;">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-bottom:20px;">
          <div style="background:#1e293b;border-radius:10px;padding:14px;text-align:center;border:1px solid rgba(56,189,248,0.2);">
            <div id="us-basic" style="font-size:2rem;font-weight:700;color:#38bdf8;">‚Äî</div>
            <div style="font-size:0.75rem;color:#64748b;margin-top:4px;">Basic</div>
          </div>
          <div style="background:#1e293b;border-radius:10px;padding:14px;text-align:center;border:1px solid rgba(167,139,250,0.2);">
            <div id="us-plus" style="font-size:2rem;font-weight:700;color:#a78bfa;">‚Äî</div>
            <div style="font-size:0.75rem;color:#64748b;margin-top:4px;">Plus</div>
          </div>
          <div style="background:#1e293b;border-radius:10px;padding:14px;text-align:center;border:1px solid rgba(212,175,55,0.3);">
            <div id="us-master" style="font-size:2rem;font-weight:700;color:#d4af37;">‚Äî</div>
            <div style="font-size:0.75rem;color:#64748b;margin-top:4px;">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è</div>
          </div>
          <div style="background:#1e293b;border-radius:10px;padding:14px;text-align:center;">
            <div id="us-sc-week" style="font-size:2rem;font-weight:700;color:#f472b6;">‚Äî</div>
            <div style="font-size:0.75rem;color:#64748b;margin-top:4px;">Soul Chat (7–¥)</div>
          </div>
          <div style="background:#1e293b;border-radius:10px;padding:14px;text-align:center;">
            <div id="us-avg-rating" style="font-size:2rem;font-weight:700;color:#fbbf24;">‚Äî</div>
            <div style="font-size:0.75rem;color:#64748b;margin-top:4px;">–°—Ä. —Ä–µ–π—Ç–∏–Ω–≥ ‚≠ê</div>
          </div>
        </div>

        <!-- –¢–æ–ø-10 -->
        <div class="section-title" style="font-size:0.9rem;margin-bottom:10px;">–¢–æ–ø-10 –ø–æ –∑–∞–∫–∞–∑–∞–º</div>
        <div class="mono-table-wrap">
          <table class="mono-table" id="top10Table">
            <thead><tr><th>#</th><th>ID</th><th>–ò–º—è</th><th>–ó–∞–∫–∞–∑–æ–≤</th></tr></thead>
            <tbody id="top10Body"><tr><td colspan="4" class="mono-muted">–ù–∞–∂–º–∏—Ç–µ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª</td></tr></tbody>
          </table>
        </div>
        <div id="userStatsMsg" class="mono-msg"></div>
      </div>
    </div>

    <!-- Tab: –Ø–∑—ã–∫–∏ -->
    <div class="tab-pane" id="tab-languages">

      <!-- –í–∞—Ä–∏–∞–Ω—Ç 1: –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —è–∑—ã–∫–æ–º -->
      <div class="details-section" style="margin-bottom:20px;">
        <div class="section-title">üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —è–∑—ã–∫–æ–º</div>
        <p style="font-size:13px;color:#94a3b8;margin-bottom:14px;">
          –ù–∞–π—Ç–∏ –∑–∞—è–≤–∫–∏ –≥–¥–µ —è–∑—ã–∫ <b>ru</b>, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –¥—Ä—É–≥–æ–π —è–∑—ã–∫ ‚Äî –∏ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å –∑–∞–Ω–æ–≤–æ.
        </p>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px;">
          <label style="font-size:13px;color:#94a3b8;">–ù–∞–π—Ç–∏ –∑–∞—è–≤–∫–∏ —Å —è–∑—ã–∫–æ–º:</label>
          <select id="wlFromLang" style="padding:8px 12px;border-radius:8px;border:1px solid #4a5568;background:#2d3748;color:#fff;font-size:13px;">
            <option value="ru">ru ‚Üí –∏—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å uk</option>
          </select>
          <button class="btn btn-primary" style="padding:8px 16px;font-size:13px;" onclick="findWrongLang()">üîç –ù–∞–π—Ç–∏</button>
        </div>
        <div id="wrongLangResult" style="display:none;">
          <div id="wrongLangList" style="margin-bottom:12px;max-height:300px;overflow-y:auto;"></div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <label style="font-size:13px;color:#94a3b8;">–ò–∑–º–µ–Ω–∏—Ç—å —è–∑—ã–∫ –Ω–∞:</label>
            <select id="wlToLang" style="padding:8px 12px;border-radius:8px;border:1px solid #4a5568;background:#2d3748;color:#fff;font-size:13px;">
              <option value="uk">uk (–£–∫—Ä–∞–∏–Ω—Å–∫–∏–π)</option>
              <option value="en">en (English)</option>
              <option value="de">de (Deutsch)</option>
              <option value="fr">fr (Fran√ßais)</option>
            </select>
            <button class="btn" style="background:linear-gradient(135deg,#f59e0b,#d97706);padding:8px 16px;font-size:13px;" onclick="requeueWrongLang()">
              üîÑ –ü–æ—Å—Ç–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å
            </button>
          </div>
          <p id="wlStatus" style="font-size:12px;color:#64748b;margin-top:8px;"></p>
        </div>
      </div>

      <!-- –í–∞—Ä–∏–∞–Ω—Ç 2: —Ä–∞—Å—Å—ã–ª–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å delivery_failed -->
      <div class="details-section" style="margin-bottom:20px;">
        <div class="section-title">üì® –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –Ω–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –ø–µ—Å–Ω—è–º–∏</div>
        <p style="font-size:13px;color:#94a3b8;margin-bottom:14px;">
          –ù–∞–π—Ç–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —É –∫–æ–≥–æ —Å—Ç–∞—Ç—É—Å <b>delivery_failed</b> –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–æ—Ç ‚Äî –Ω–∞ –∏—Ö —è–∑—ã–∫–µ ‚Äî —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞.
        </p>
        <div style="background:#1a2332;border:1px solid #2d4a6e;border-radius:10px;padding:14px;margin-bottom:14px;">
          <div style="font-size:12px;color:#94a3b8;margin-bottom:6px;">–°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–ª—É—á–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–Ω–∞ –∏—Ö —è–∑—ã–∫–µ):</div>
          <div style="font-size:12px;color:#e2e8f0;white-space:pre-wrap;font-style:italic;">"–ò–º—è, –º—ã –∏—Å–ø—Ä–∞–≤–∏–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞ ‚Äî —Ç–µ–ø–µ—Ä—å —Ç–≤–æ—è –ø–µ—Å–Ω—è –±—É–¥–µ—Ç –Ω–∞ –Ω—É–∂–Ω–æ–º —è–∑—ã–∫–µ. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∑–∞–∫–∞–∑–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é ‚Äî –æ—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –ü–µ—Ä–≤–∞—è –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ."</div>
        </div>
        <button class="btn btn-primary" style="padding:10px 20px;font-size:13px;" onclick="notifyDeliveryFailed()">
          üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        </button>
        <p id="notifyStatus" style="font-size:12px;color:#64748b;margin-top:10px;"></p>
      </div>

    </div>

    <!-- Tab: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div class="tab-pane" id="tab-settings">
      <div class="details-section" style="margin-bottom:20px;">
        <div class="section-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
        <p style="font-size:14px;color:#94a3b8;margin-bottom:12px;">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã DeepSeek –¥–ª—è –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: .env –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ &gt; —ç—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.</p>
        <div style="display:flex;flex-direction:column;gap:14px;">
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <label style="display:flex;align-items:center;gap:8px;"><span style="min-width:100px;">–ú–æ–¥–µ–ª—å:</span>
              <select id="settings-model" style="min-width:220px;padding:10px;border-radius:8px;border:2px solid #4a5568;background:#1a1a2e;color:#fff;font-size:14px;">
                <option value="deepseek-reasoner">deepseek-reasoner (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</option>
                <option value="deepseek-chat">deepseek-chat</option>
                <option value="deepseek-coder">deepseek-coder</option>
                <option value="">‚Äî –∫–∞–∫ –≤ .env ‚Äî</option>
              </select>
            </label>
          </div>
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <label style="display:flex;align-items:center;gap:8px;"><span style="min-width:100px;">max_tokens:</span><input type="number" id="settings-max-tokens" min="4096" max="65536" value="8192" step="1" style="width:100px;padding:10px;border-radius:8px;border:2px solid #4a5568;background:#1a1a2e;color:#fff;font-size:16px;"></label>
            <label style="display:flex;align-items:center;gap:8px;"><span style="min-width:100px;">temperature:</span><input type="number" id="settings-temperature" min="0" max="2" step="0.1" value="1.5" style="width:80px;padding:10px;border-radius:8px;border:2px solid #4a5568;background:#1a1a2e;color:#fff;font-size:16px;"></label>
          </div>
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <button type="button" class="btn btn-primary" id="settings-save-btn" style="min-width:140px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <span id="settings-save-status" style="font-size:14px;color:#86efac;"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: –†–µ—Ñ–µ—Ä–∞–ª—ã -->
    <div class="tab-pane" id="tab-referrals">

      <!-- ‚ïê‚ïê‚ïê –ë–õ–û–ì–ï–†–°–ö–ò–ï –ö–ê–ú–ü–ê–ù–ò–ò ‚ïê‚ïê‚ïê -->
      <div class="details-section" style="margin-bottom:20px;border:1.5px solid rgba(212,175,55,0.3);">
        <div class="section-title">üì¢ –ë–ª–æ–≥–µ—Ä—Å–∫–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏</div>
        <p class="mono-muted">–°–æ–∑–¥–∞–π—Ç–µ –∫–∞–º–ø–∞–Ω–∏—é –∏ –¥–∞–π—Ç–µ –±–ª–æ–≥–µ—Ä—É —Å—Å—ã–ª–∫—É: <code style="color:#d4af37">https://t.me/–±–æ—Ç?start=camp_–ö–û–î</code></p>

        <details id="newCampDetails" style="margin-bottom:14px;border:1px solid rgba(212,175,55,0.3);border-radius:10px;padding:12px 16px;background:rgba(212,175,55,0.05);">
          <summary style="cursor:pointer;font-weight:600;color:#d4af37;font-size:0.95rem;list-style:none;">‚ûï –°–æ–∑–¥–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é</summary>
          <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div><label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">–ù–∞–∑–≤–∞–Ω–∏–µ <span style="color:#ef4444">*</span></label><input id="newCampName" type="text" placeholder="–ò–≤–∞–Ω–æ–≤ –±–ª–æ–≥" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;"></div>
            <div><label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">–ö–æ–¥ <span style="color:#ef4444">*</span></label><input id="newCampCode" type="text" placeholder="ivanov" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;"></div>
            <div style="grid-column:1/-1;"><label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">–ó–∞–º–µ—Ç–∫–∏</label><input id="newCampNotes" type="text" placeholder="@ivanov_blog, 50–∫ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;"></div>
          </div>
          <div style="margin-top:10px;">
            <button class="btn btn-primary" onclick="createCampaign()">–°–æ–∑–¥–∞—Ç—å</button>
          </div>
          <div id="newCampMsg" class="mono-msg"></div>
        </details>

        <div class="mono-actions" style="margin-bottom:10px;">
          <button class="btn" style="background:#334155;color:#e2e8f0;" onclick="loadCampaigns()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div class="mono-table-wrap">
          <table class="mono-table" id="campaignsTable">
            <thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ö–æ–¥</th><th>–°—Å—ã–ª–∫–∞</th><th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th><th>–û–ø–ª–∞—Ç—ã</th><th>–ó–∞–º–µ—Ç–∫–∏</th><th>–î–∞—Ç–∞</th><th></th></tr></thead>
            <tbody id="campaignsBody"><tr><td colspan="8" class="mono-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr></tbody>
          </table>
        </div>
        <div id="campaignsMsg" class="mono-msg"></div>
      </div>

      <div class="details-section" style="margin-bottom:20px;">
        <div class="section-title">üîó –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</div>
        <div style="display:flex;gap:16px;margin-bottom:16px;flex-wrap:wrap;">
          <div style="background:#1e293b;border-radius:10px;padding:14px 20px;text-align:center;min-width:140px;flex:1;">
            <div id="refTotalCount" style="font-size:2rem;font-weight:700;color:#a78bfa;">‚Äî</div>
            <div style="font-size:0.78rem;color:#64748b;margin-top:4px;">–í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
          </div>
          <div style="background:#1e293b;border-radius:10px;padding:14px 20px;text-align:center;min-width:140px;flex:1;">
            <div id="refRewardedCount" style="font-size:2rem;font-weight:700;color:#22c55e;">‚Äî</div>
            <div style="font-size:0.78rem;color:#64748b;margin-top:4px;">–ù–∞–≥—Ä–∞–¥—ã –≤—ã–¥–∞–Ω—ã</div>
          </div>
        </div>
        <div class="mono-table-wrap">
          <table class="mono-table" id="referralsTable">
            <thead><tr><th>–†–µ—Ñ–µ—Ä–µ—Ä ID</th><th>–†–µ—Ñ–µ—Ä–∞–ª ID</th><th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th><th>–î–∞—Ç–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</th><th>–ù–∞–≥—Ä–∞–¥–∞</th></tr></thead>
            <tbody id="referralsTableBody"><tr><td colspan="5" class="mono-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr></tbody>
          </table>
        </div>
        <div id="referralsMsg" class="mono-msg"></div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      var params = new URLSearchParams(window.location.search);
      var apiOrigin = params.get('api_origin');
      window.API_BASE = (apiOrigin && apiOrigin.startsWith('http')) ? apiOrigin.replace(/\/$/, '') : window.location.origin;
      var el = document.getElementById('url-info');
      if (el) el.textContent = '–°—Ç—Ä–∞–Ω–∏—Ü–∞: ' + window.location.origin + ' ¬∑ –ó–∞–ø—Ä–æ—Å—ã –∫ API: ' + window.API_BASE;
    })();
    let currentFilter = 'all';
    let currentSort = 'date_desc';
    let currentPayFilter = 'all';
    let currentSearchRequestId = '';
    let currentSearchUserId = '';

    function switchTab(tabId, btn) {
      document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      const pane = document.getElementById('tab-' + tabId);
      if (pane) pane.classList.add('active');
      if (btn) btn.classList.add('active');
      if (tabId === 'referrals') { loadReferralData(); loadCampaigns(); }
      if (tabId === 'users') { loadUserStats(); }
      if (tabId === 'analytics') { loadAnalytics(); }
    }

    function toggleRow(id) {
      const row = document.getElementById('req-row-' + id);
      const body = document.getElementById('req-body-' + id);
      if (!row || !body) return;
      const isOpen = row.classList.contains('expanded');
      if (isOpen) {
        row.classList.remove('expanded');
        body.style.display = 'none';
        return;
      }
      row.classList.add('expanded');
      body.style.display = 'block';
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–∞—Å–∫—Ä—ã—Ç–∏–∏
      if (row.getAttribute('data-loaded') === 'true') return;
      row.setAttribute('data-loaded', 'true');
      body.innerHTML = '<div style="padding:18px;color:#64748b;font-size:13px;display:flex;align-items:center;gap:10px;"><span style="display:inline-block;width:16px;height:16px;border:2px solid rgba(102,126,234,0.3);border-top-color:#667eea;border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0;"></span> –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π‚Ä¶</div>';
      loadFullDetail(id, body, row);
    }

    async function loadFullDetail(id, body, row) {
      let r;
      try {
        const result = await fetchJson(API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + authQueryFromPath(), { headers: authHeaders() }, 12000);
        if (!result.json?.success || !result.json?.data) throw new Error(result.json?.error || 'load error');
        r = result.json.data;
      } catch (e) {
        body.innerHTML = '<div style="padding:14px;color:#fca5a5;font-size:13px;">‚ùå ' + escapeHtml(String(e?.message || e)) + ' <button onclick="this.closest(\'[data-loaded]\').removeAttribute(\'data-loaded\');toggleRow(\'' + escapeHtml(id) + '\')" style="background:rgba(102,126,234,0.2);border:1px solid #667eea;color:#a5b4fc;border-radius:5px;padding:3px 10px;cursor:pointer;font-family:inherit;font-size:12px;margin-left:8px;">‚Üª –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button></div>';
        row.removeAttribute('data-loaded');
        return;
      }

      const gs = r.generation_status || r.status || 'pending';
      const steps = normalizeSteps(r.generation_steps);
      const order = getStatusOrder(gs);
      const safeId = id.replace(/\\/g, '\\\\').replace(/'/g, "\\'");

      // ‚îÄ‚îÄ –•–µ–ª–ø–µ—Ä—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function stepVal(key) {
        const v = steps[key]; return (v && String(v).trim()) ? String(v) : '';
      }
      function stepRow(label, key, col) {
        const v = stepVal(key);
        return `<div style="display:flex;gap:6px;align-items:flex-start;padding:3px 0;border-bottom:1px solid #1e293b;">
          <span style="color:${v ? (col || '#86efac') : '#334155'};flex-shrink:0;width:14px;font-size:11px;">${v ? '‚úì' : '¬∑'}</span>
          <span style="color:#94a3b8;font-size:11px;min-width:160px;flex-shrink:0;">${escapeHtml(label)}</span>
          <span style="font-size:11px;color:${v ? '#e2e8f0' : '#475569'};word-break:break-all;">${v ? escapeHtml(v.slice(0,120)) : '‚Äî'}</span>
        </div>`;
      }
      function field(label, value, hint) {
        if (!value && !hint) return '';
        return `<div style="display:flex;gap:8px;align-items:flex-start;margin-bottom:4px;">
          <span style="color:#64748b;font-size:11px;min-width:120px;flex-shrink:0;">${escapeHtml(label)}</span>
          <span style="font-size:12px;color:#e2e8f0;word-break:break-word;">${value ? escapeHtml(String(value)) : ('<span style="color:#475569;">' + (hint||'‚Äî') + '</span>')}</span>
        </div>`;
      }

      // ‚îÄ‚îÄ –ë–ª–æ–∫ ¬´–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è¬ª ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const userBlock = `<div class="detail-section-inline">
        <div class="dsi-title">üë§ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
        <div class="dsi-body">
          ${field('–ò–º—è', r.name)}
          ${r.telegram_user_id ? `<div class="field-row"><span class="field-label">Telegram ID</span><span class="field-value" style="display:flex;align-items:center;gap:8px;">${r.telegram_user_id}${r.tg_username ? ` <span style="color:#94a3b8;font-size:10px;">@${r.tg_username}</span>` : ''} <button class="rmb rmb-blue" style="padding:2px 10px;font-size:11px;" onclick="copyTgId(${r.telegram_user_id})" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button><button class="rmb rmb-green" style="padding:2px 10px;font-size:11px;" onclick="openTgUser(${r.telegram_user_id}, ${r.tg_username ? JSON.stringify(r.tg_username) : 'null'})" title="–û—Ç–∫—Ä—ã—Ç—å –≤ Telegram">‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å</button></span></div>` : field('Telegram ID', '‚Äî')}
          ${field('–ü–æ–ª', r.gender)}
          ${field('–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è', r.birthdate)}
          ${field('–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è', r.birthtime_unknown ? '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' : r.birthtime)}
          ${field('–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è', r.birthplace)}
          ${r.person2_name ? `<div style="border-top:1px solid #1e293b;margin:8px 0 6px;padding-top:6px;color:#d4af37;font-size:11px;font-weight:700;">–ü–∞—Ä—Ç–Ω—ë—Ä</div>
            ${field('–ò–º—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞', r.person2_name)}
            ${field('–ü–æ–ª –ø–∞—Ä—Ç–Ω—ë—Ä–∞', r.person2_gender)}
            ${field('–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è', r.person2_birthdate)}
            ${field('–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è', r.person2_birthtime_unknown ? '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' : r.person2_birthtime)}
            ${field('–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è', r.person2_birthplace)}` : ''}
          ${r.transit_date ? `<div style="border-top:1px solid #1e293b;margin:8px 0 6px;padding-top:6px;color:#f9a8d4;font-size:11px;font-weight:700;">–¢—Ä–∞–Ω–∑–∏—Ç</div>
            ${field('–î–∞—Ç–∞', r.transit_date)}
            ${field('–í—Ä–µ–º—è', r.transit_time)}
            ${field('–õ–æ–∫–∞—Ü–∏—è', r.transit_location)}
            ${field('–ù–∞–º–µ—Ä–µ–Ω–∏–µ', r.transit_intent)}` : ''}
        </div>
      </div>`;

      // ‚îÄ‚îÄ –ë–ª–æ–∫ ¬´–û–ø–ª–∞—Ç–∞¬ª ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const isPendingPay = ['pending','requires_payment'].includes(String((r.payment_status||'').toLowerCase()));
      const payBlock = `<div class="detail-section-inline">
        <div class="dsi-title">üí≥ –û–ø–ª–∞—Ç–∞</div>
        <div class="dsi-body">
          ${field('–°—Ç–∞—Ç—É—Å', r.payment_status)}
          ${field('–ü—Ä–æ–≤–∞–π–¥–µ—Ä', r.payment_provider)}
          ${field('–°—É–º–º–∞', r.payment_amount != null ? r.payment_amount + ' ' + (r.payment_currency||'USDT') : null)}
          ${field('–ü—Ä–æ–º–æ–∫–æ–¥', r.promo_code)}
          ${field('–°–∫–∏–¥–∫–∞', r.promo_discount_amount != null ? '-' + r.promo_discount_amount : null)}
          ${field('Order ID', r.payment_order_id)}
          ${field('–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã', r.paid_at ? new Date(r.paid_at).toLocaleString('ru-RU') : null)}
        </div>
        ${isPendingPay ? `<div style="margin-top:10px;"><button class="rmb rmb-green" style="padding:6px 14px;font-size:12px;" onclick="markPaid('${safeId}');loadFullDetail('${safeId}',document.getElementById('req-body-${escapeHtml(id)}'),document.getElementById('req-row-${escapeHtml(id)}'))">‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –æ–ø–ª–∞—á–µ–Ω–Ω—ã–º</button></div>` : ''}
      </div>`;

      // ‚îÄ‚îÄ –ë–ª–æ–∫ ¬´–ó–∞—è–≤–∫–∞¬ª ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const requestBlock = r.request ? `<div class="detail-section-inline">
        <div class="dsi-title">üí¨ –¢–µ–∫—Å—Ç –∑–∞—è–≤–∫–∏</div>
        <div class="dsi-body" style="white-space:pre-wrap;font-size:12px;line-height:1.65;color:#cbd5e1;max-height:180px;overflow-y:auto;">${escapeHtml(r.request)}</div>
      </div>` : '';

      // ‚îÄ‚îÄ –ë–ª–æ–∫ ¬´–ü—Ä–æ–≥—Ä–µ—Å—Å¬ª ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const progressBlock = `<div class="detail-section-inline">
        <div class="dsi-title">‚öôÔ∏è –¶–µ–ø–æ—á–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
        <div class="dsi-body">
          ${stepRow('–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞', 'request_loaded')}
          ${stepRow('–°—Ç–∞—Ä—Ç –∞—Å—Ç—Ä–æ–±–ª–æ–∫–∞', 'astro_start')}
          ${stepRow('–°–Ω–∞–ø—à–æ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'astro_snapshot_saved')}
          ${stepRow('D-–∫–∞—Ä—Ç—ã –∏ –î–∞—à–∏', 'astro_extensions')}
          ${stepRow('–ü—Ä–æ–º—Ç —Å–æ–±—Ä–∞–Ω', 'prompt_compiled')}
          ${stepRow('–ó–∞–ø—Ä–æ—Å –≤ DeepSeek', 'llm_request_start')}
          ${stepRow('–û—Ç–≤–µ—Ç DeepSeek', 'llm_response_ready')}
          ${stepRow('DeepSeek —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'llm_response_saved')}
          ${stepRow('–õ–∏—Ä–∏–∫–∞ –≥–æ—Ç–æ–≤–∞', 'lyrics_ready')}
          ${stepRow('–°—Ç–∞—Ä—Ç Suno', 'suno_start')}
          ${stepRow('Suno task', 'suno_task_created')}
          ${stepRow('–ê—É–¥–∏–æ –≥–æ—Ç–æ–≤–æ', 'audio_ready')}
          ${stepRow('–î–æ—Å—Ç–∞–≤–∫–∞', 'delivery_done')}
          ${stepRow('–§–∏–Ω–∞–ª', 'pipeline_done')}
          ${steps.error ? `<div style="margin-top:8px;padding:8px;background:rgba(231,76,60,0.1);border-radius:6px;color:#fca5a5;font-size:11px;">‚ùå ${escapeHtml(String(steps.error))}</div>` : ''}
        </div>
      </div>`;

      // ‚îÄ‚îÄ –ë–ª–æ–∫ ¬´DeepSeek¬ª ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const dsBlock = r.deepseek_response ? `<div class="detail-section-inline">
        <div class="dsi-title">ü§ñ –û—Ç–≤–µ—Ç DeepSeek ${r.llm_truncated ? '<span style="color:#f39c12;font-size:10px;">‚ö†Ô∏è –æ–±—Ä–µ–∑–∞–Ω</span>' : ''}</div>
        <div class="dsi-body" style="white-space:pre-wrap;font-size:11px;line-height:1.6;color:#cbd5e1;max-height:60vh;overflow-y:auto;">${escapeHtml(r.deepseek_response||'')}</div>
      </div>` : '';

      // ‚îÄ‚îÄ –ë–ª–æ–∫ ¬´–õ–∏—Ä–∏–∫–∞¬ª ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const lyricsBlock = r.lyrics ? `<div class="detail-section-inline">
        <div class="dsi-title">üéµ –¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏</div>
        <div class="dsi-body" style="white-space:pre-wrap;font-size:12px;line-height:1.65;color:#e2e8f0;max-height:220px;overflow-y:auto;">${escapeHtml(r.lyrics)}</div>
      </div>` : '';

      // ‚îÄ‚îÄ –ë–ª–æ–∫ ¬´–ê—É–¥–∏–æ¬ª ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const audioBlock = r.audio_url ? `<div class="detail-section-inline">
        <div class="dsi-title">üîä –ê—É–¥–∏–æ</div>
        <div class="dsi-body">
          <audio style="width:100%;margin-bottom:8px;" controls src="${escapeHtml(r.audio_url)}"></audio>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <a href="${escapeHtml(r.audio_url)}" download target="_blank"><button class="rmb rmb-green" style="padding:6px 14px;font-size:12px;">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å</button></a>
            <button class="rmb rmb-blue" style="padding:6px 14px;font-size:12px;" onclick="deliver('${safeId}',this)">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</button>
          </div>
        </div>
      </div>` : '';

      // ‚îÄ‚îÄ –ë–∞–Ω–Ω–µ—Ä –æ—à–∏–±–∫–∏ / –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const isDeliveryFailed = (r.generation_status || '') === 'delivery_failed' || (r.delivery_status || '') === 'failed';
      const isHardFailed = gs === 'failed';
      const isPending = ['pending','astro_calculated','lyrics_generated','suno_processing','processing'].includes(gs);
      let deliveryBanner = '';
      if (isDeliveryFailed) {
        deliveryBanner = `<div style="margin-bottom:14px;padding:12px 16px;background:rgba(230,126,34,0.15);border:1px solid rgba(230,126,34,0.4);border-radius:8px;color:#fcd34d;">
          <strong>üì≠ –ü–µ—Å–Ω—è –≥–æ—Ç–æ–≤–∞, –Ω–æ –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.</strong>${r.error_message ? ' <span style="opacity:.8;">'+escapeHtml(String(r.error_message).slice(0,200))+'</span>' : ''} –ù–∞–∂–º–∏ ¬´üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é¬ª –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏.
        </div>`;
      } else if (isHardFailed && r.error_message) {
        deliveryBanner = `<div style="margin-bottom:14px;padding:12px 16px;background:rgba(231,76,60,0.12);border:1px solid rgba(231,76,60,0.4);border-radius:8px;color:#fca5a5;">
          <strong>‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:</strong> ${escapeHtml(String(r.error_message).slice(0, 300))}
        </div>`;
      } else if (isPending && r.error_message) {
        deliveryBanner = `<div style="margin-bottom:14px;padding:12px 16px;background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.3);border-radius:8px;color:#fde68a;">
          <strong>‚ö†Ô∏è –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞ (–∑–∞—è–≤–∫–∞ –µ—â—ë –≤ —Ä–∞–±–æ—Ç–µ):</strong> ${escapeHtml(String(r.error_message).slice(0, 300))}
        </div>`;
      }

      // ‚îÄ‚îÄ –ë–ª–æ–∫ ¬´ID –∑–∞—è–≤–∫–∏¬ª ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const isDeliveredToChat = !!(r.delivered_at || r.delivery_status === 'sent');
      const deliveredStr = r.delivered_at ? new Date(r.delivered_at).toLocaleString('ru-RU') : (r.delivery_status === 'sent' ? '–¥–∞' : null);
      const idBlock = `<div style="font-size:10px;color:#334155;font-family:monospace;padding:8px 0 4px;word-break:break-all;">
        ID: ${escapeHtml(r.id||'')} ¬∑ –°–æ–∑–¥–∞–Ω–∞: ${r.created_at ? new Date(r.created_at).toLocaleString('ru-RU') : '‚Äî'} ¬∑ –†–µ–∂–∏–º: ${escapeHtml(r.mode||'single')}
        ${isDeliveredToChat ? '<br><span style="color:#86efac;">‚úì –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç: ' + escapeHtml(deliveredStr) + '</span>' : ''}${r.delivery_status === 'failed' || isDeliveryFailed ? ' ¬∑ üì≠ –ù–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ' : ''}
      </div>`;

      // ‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const actionsBlock = `<div style="display:flex;gap:8px;flex-wrap:wrap;padding:12px 0 4px;border-top:1px solid #1e293b;margin-top:8px;">
        <button class="rmb rmb-orange" style="padding:7px 14px;font-size:12px;" onclick="restart('${safeId}',this)">${gs === 'completed' ? 'üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å' : 'üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å'}</button>
        ${isPendingPay ? `<button class="rmb rmb-green" style="padding:7px 14px;font-size:12px;" onclick="markPaid('${safeId}')">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ</button>` : ''}
        ${gs === 'pending_payment' ? `<button class="rmb rmb-red" style="padding:7px 14px;font-size:12px;" onclick="cancelRequest('${safeId}',this)">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>` : ''}
        ${r.audio_url ? `<button class="rmb rmb-green" style="padding:7px 14px;font-size:12px;" onclick="deliver('${safeId}',this)">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>` : ''}
        <button class="rmb rmb-red" style="padding:7px 14px;font-size:12px;margin-left:auto;" onclick="if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É?')){deleteRequests(['${safeId}'])}"  title="–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É">üóë –£–¥–∞–ª–∏—Ç—å</button>
      </div>`;

      body.innerHTML = `
        <div style="padding:4px 0 10px;">
          ${deliveryBanner}
          ${idBlock}
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
            ${userBlock}
            ${payBlock}
          </div>
          ${requestBlock}
          ${progressBlock}
          ${dsBlock}
          ${lyricsBlock}
          ${audioBlock}
          ${actionsBlock}
        </div>`;
    }

    async function searchByRequestId() {
      const input = document.getElementById('searchRequestId');
      const msgEl = document.getElementById('searchByIdMsg');
      const id = (input && input.value ? input.value.trim() : '').replace(/\s/g, '');
      if (!id) {
        if (msgEl) { msgEl.textContent = '–í–≤–µ–¥–∏—Ç–µ UUID –∑–∞—è–≤–∫–∏'; msgEl.style.color = '#94a3b8'; }
        return;
      }
      if (msgEl) { msgEl.textContent = '–ü–æ–∏—Å–∫‚Ä¶'; msgEl.style.color = '#94a3b8'; }
      const tabBtn = document.querySelector('.tab-btn[onclick*="requests"]');
      if (tabBtn) switchTab('requests', tabBtn);
      try {
        const result = await fetchJson(API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + authQueryFromPath(), { headers: authHeaders() }, 10000);
        const json = result.json;
        if ((result.res && result.res.status === 404) || !json || !json.success) {
          if (msgEl) { msgEl.textContent = '–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'; msgEl.style.color = '#fca5a5'; }
          document.getElementById('requests').innerHTML = '<div style="text-align:center;padding:40px;color:#94a3b8">–ó–∞—è–≤–∫–∞ —Å ID ' + escapeHtml(id.slice(0, 8)) + '‚Ä¶ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–Ω—ã–π UUID.</div>';
          window._lastRequestsData = [];
          return;
        }
        const row = json.data;
        if (!row || !row.id) {
          if (msgEl) { msgEl.textContent = '–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'; msgEl.style.color = '#fca5a5'; }
          return;
        }
        window._lastRequestsData = [row];
        renderRequests([row]);
        if (msgEl) { msgEl.textContent = '–ù–∞–π–¥–µ–Ω–∞ 1 –∑–∞—è–≤–∫–∞'; msgEl.style.color = '#86efac'; }
        setTimeout(function() { if (msgEl) msgEl.textContent = ''; }, 3000);
      } catch (e) {
        if (msgEl) { msgEl.textContent = '–û—à–∏–±–∫–∞: ' + (e && e.message ? e.message : String(e)).slice(0, 40); msgEl.style.color = '#fca5a5'; }
        document.getElementById('requests').innerHTML = '<div style="text-align:center;padding:40px;color:#e74c3c">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ UUID –∏ —Ç–æ–∫–µ–Ω.</div>';
      }
    }

    function filterByCard(card) {
      const filter = card.getAttribute('data-filter') || 'all';
      document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active-filter'));
      card.classList.add('active-filter');
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(b => {
        b.classList.toggle('active', b.getAttribute('data-filter') === filter);
      });
      // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö/–æ—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–∞—Ö
      const showTopSections = filter === 'all' || filter === 'pending';
      const unpaid = document.getElementById('unpaidSection');
      const cancelled = document.getElementById('cancelledSection');
      if (unpaid) unpaid.style.display = showTopSections ? '' : 'none';
      if (cancelled) cancelled.style.display = showTopSections ? '' : 'none';
      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ó–∞—è–≤–∫–∏
      const tabBtn = document.querySelector('.tab-btn[onclick*="requests"]');
      if (tabBtn) switchTab('requests', tabBtn);
      loadAdminData();
    }

    function setSort(btn) {
      currentSort = btn.getAttribute('data-sort') || 'date_desc';
      document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      if (window._lastRequestsData) renderRequests(window._lastRequestsData);
    }

    function sortRequests(data) {
      const sorted = [...data];
      if (currentSort === 'date_desc') {
        sorted.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
      } else if (currentSort === 'date_asc') {
        sorted.sort((a, b) => new Date(a.created_at || 0) - new Date(b.created_at || 0));
      } else if (currentSort === 'name_asc') {
        sorted.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ru'));
      } else if (currentSort === 'status') {
        sorted.sort((a, b) => getStatusOrder(b.generation_status || '') - getStatusOrder(a.generation_status || ''));
      } else if (currentSort === 'payment') {
        const payOrder = { gift_used: 0, subscription_active: 1, paid: 2, requires_payment: 3, pending: 4 };
        sorted.sort((a, b) => (payOrder[a.payment_status] ?? 5) - (payOrder[b.payment_status] ?? 5));
      }
      return sorted;
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º ¬´—Ç–∏–ø –æ–ø–ª–∞—Ç—ã¬ª –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ø—Ä–æ–º–æ–∫–æ–¥/–±–µ—Å–ø–ª–∞—Ç–Ω–æ –ø–æ –¥–∞–Ω–Ω—ã–º, –Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É)
    function getPayType(r) {
      const provider = String(r.payment_provider || '').toLowerCase();
      const status   = String(r.payment_status  || '').toLowerCase();
      const promo    = r.promo_code ? String(r.promo_code).toUpperCase() : null;
      const amount   = r.payment_amount != null ? Number(r.payment_amount) : null;
      const gs       = String(r.generation_status || '').toLowerCase();
      if (gs === 'pending_payment' || status === 'requires_payment') return 'awaiting';
      if (status === 'gift_used') return 'gift';
      if (provider === 'subscription' || status === 'subscription_active') return 'subscription';
      if (provider === 'promo' || promo || (status === 'paid' && amount === 0)) return 'promo';
      if (provider === 'hot') return 'hot';
      if (provider === 'admin') return 'admin';
      if (provider === 'gift') return 'gift';
      return 'unknown';
    }

    function paymentMethodBadge(r) {
      const provider = String(r.payment_provider || '').toLowerCase();
      const status   = String(r.payment_status  || '').toLowerCase();
      const promo    = r.promo_code ? String(r.promo_code) : null;
      const gs       = String(r.generation_status || '').toLowerCase();
      const payType  = getPayType(r);

      if (gs === 'pending_payment' || status === 'requires_payment') {
        const amt = r.payment_amount != null ? (' ¬∑ ' + r.payment_amount + ' ' + (r.payment_currency || 'USDT')) : '';
        return '<span class="pay-badge" style="background:rgba(139,92,246,.25);color:#c4b5fd;">‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã' + escapeHtml(amt) + '</span>';
      }
      if (payType === 'gift') {
        return '<span class="pay-badge pay-badge-free">üéÅ –ü–µ—Ä–≤—ã–π –ø–æ–¥–∞—Ä–æ–∫</span>';
      }
      if (payType === 'promo') {
        const label = promo ? ('üè∑ ' + escapeHtml(promo)) : 'üè∑ –ü—Ä–æ–º–æ–∫–æ–¥';
        const disc = r.promo_discount_amount ? (' ‚àí' + r.promo_discount_amount) : '';
        return '<span class="pay-badge pay-badge-promo">' + label + escapeHtml(disc) + '</span>';
      }
      if (payType === 'hot') {
        if (status === 'paid') return '<span class="pay-badge pay-badge-hot">üí≥ HOT Pay ‚úì</span>';
        return '<span class="pay-badge pay-badge-hot" style="opacity:.75;">üí≥ HOT Pay‚Ä¶</span>';
      }
      if (payType === 'subscription') {
        return '<span class="pay-badge pay-badge-sub">üìã –ü–æ–¥–ø–∏—Å–∫–∞</span>';
      }
      if (payType === 'admin') {
        return '<span class="pay-badge pay-badge-free">üîß –†—É—á–Ω–∞—è</span>';
      }
      if (!provider && !status) return '';
      return '<span class="pay-badge" style="background:rgba(100,116,139,.2);color:#94a3b8;">' + escapeHtml(provider || status) + '</span>';
    }

    function setPayFilter(btn) {
      currentPayFilter = btn.getAttribute('data-pay') || 'all';
      document.querySelectorAll('.pay-filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      if (window._lastRequestsData) renderRequests(window._lastRequestsData);
    }

    function filterByPayment(data) {
      if (!currentPayFilter || currentPayFilter === 'all') return data;
      return data.filter(r => getPayType(r) === currentPayFilter);
    }

    function getToken() {
      const fromUrl = new URLSearchParams(window.location.search).get('token');
      if (fromUrl) {
        try { localStorage.setItem('adminToken', fromUrl); } catch (e) {}
        return fromUrl;
      }
      return localStorage.getItem('adminToken');
    }
    function authHeaders() {
      const t = getToken();
      return t ? { 'X-Admin-Token': t } : {};
    }
    function authQuery() {
      const t = getToken();
      return t ? '&token=' + encodeURIComponent(t) : '';
    }
    function authQueryFromPath() {
      const t = getToken();
      return t ? '?token=' + encodeURIComponent(t) : '';
    }

    function setMonoMsg(id, text, ok) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = text || '';
      el.style.color = ok === true ? '#86efac' : (ok === false ? '#fca5a5' : '#94a3b8');
    }

    async function fetchJson(url, opts, timeoutMs) {
      timeoutMs = timeoutMs || 15000;
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeoutMs);
      let res;
      try {
        res = await fetch(url, Object.assign({}, opts, { signal: controller.signal }));
      } catch (e) {
        clearTimeout(timer);
        if (e && e.name === 'AbortError') throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –∑–∞ ' + (timeoutMs/1000) + ' —Å–µ–∫. Render –º–æ–≥ —É—Å–Ω—É—Ç—å ‚Äî –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5) —á–µ—Ä–µ–∑ 30 —Å–µ–∫.');
        throw new Error('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: ' + (e && e.message));
      }
      clearTimeout(timer);
      const text = await res.text();
      if (text.trim().startsWith('<')) {
        if (res.status === 502 || res.status === 503) {
          throw new Error('–°–µ—Ä–≤–µ—Ä –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è (502/503). –ü–æ–¥–æ–∂–¥–∏—Ç–µ 30‚Äì60 —Å–µ–∫ –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5).');
        }
        throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª HTML –≤–º–µ—Å—Ç–æ –¥–∞–Ω–Ω—ã—Ö (–∫–æ–¥ ' + res.status + '). –û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ –±–æ—Ç–∞ (/admin).');
      }
      try {
        return { res, json: JSON.parse(text) };
      } catch (e) {
        throw new Error('–û—Ç–≤–µ—Ç –Ω–µ JSON (—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω–µ —Ç–æ—Ç –∞–¥—Ä–µ—Å). –û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ –±–æ—Ç–∞ (/admin).');
      }
    }

    function setLoadingStatus(visible, text) {
      const el = document.getElementById('loadingStatus');
      const textEl = document.getElementById('loadingStatusText');
      if (!el) return;
      el.style.display = visible ? 'flex' : 'none';
      if (textEl && text) textEl.textContent = text;
    }

    async function loadAdminData() {
      const token = getToken();
      if (!token) {
        const el = document.getElementById('requests');
        if (el) el.innerHTML = '<div style="text-align:center;padding:40px;color:#e0e0e0"><p style="margin-bottom:20px">üîë –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ / Enter admin token</p><form id="token-form" style="display:flex;flex-direction:column;align-items:center;gap:12px;max-width:320px;margin:0 auto"><input type="password" id="token-input" placeholder="–¢–æ–∫–µ–Ω" style="width:100%;padding:12px;border-radius:8px;border:2px solid #667eea;background:#1a1a2e;color:#fff;font-size:16px" autocomplete="off"><button type="submit" style="padding:12px 24px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer">–í–æ–π—Ç–∏ / Login</button></form></div>';
        const form = document.getElementById('token-form');
        const input = document.getElementById('token-input');
        if (form && input) form.addEventListener('submit', function(e) { e.preventDefault(); const v = (input.value || '').trim(); if (v) { localStorage.setItem('adminToken', v); window.location.search = '?token=' + encodeURIComponent(v); } });
        return;
      }
      setLoadingStatus(true, '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É‚Ä¶');
      try {
        const statsResult = await fetchJson(API_BASE + '/api/admin/stats?' + new URLSearchParams({ token }).toString(), { headers: authHeaders() }, 20000);
        // 403 ‚Äî –Ω–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤–≤–æ–¥–∞
        if (statsResult.res.status === 403) {
          setLoadingStatus(false);
          const el = document.getElementById('requests');
          if (el) el.innerHTML = '<div style="text-align:center;padding:40px;color:#fca5a5"><p style="font-size:18px;margin-bottom:12px">üîê –¢–æ–∫–µ–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–ª</p><p style="color:#94a3b8;margin-bottom:20px">–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –∑–∞–Ω–æ–≤–æ –∫–æ–º–∞–Ω–¥–æ–π <b>/admin</b> –≤ –±–æ—Ç–µ</p><button onclick="window.location.reload()" style="padding:10px 24px;background:#667eea;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:15px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button></div>';
          return;
        }
        // 502/503 ‚Äî —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è: –∞–≤—Ç–æ-—Ä–µ—Ç—Ä–∞–π —á–µ—Ä–µ–∑ 20 —Å–µ–∫
        if (statsResult.res.status === 502 || statsResult.res.status === 503) {
          setLoadingStatus(false);
          let sec = 20;
          const el = document.getElementById('requests');
          const tick = () => {
            if (!el) return;
            if (sec <= 0) { window.location.reload(); return; }
            el.innerHTML = '<div style="text-align:center;padding:40px;color:#f39c12">‚è≥ –°–µ—Ä–≤–µ—Ä –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è‚Ä¶ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ ' + sec + ' —Å–µ–∫<br><br><button onclick="window.location.reload()" style="margin-top:12px;padding:10px 24px;background:#667eea;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:15px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å</button></div>';
            sec--;
            setTimeout(tick, 1000);
          };
          tick();
          return;
        }
        const statsJson = statsResult.json;
        if (statsJson.success && statsJson.stats) {
          const s = statsJson.stats;
          document.getElementById('total').textContent = s.total;
          document.getElementById('pending').textContent = (s.pending || 0) + (s.processing || 0) + (s.astro_calculated || 0) + (s.lyrics_generated || 0) + (s.suno_processing || 0);
          document.getElementById('completed').textContent = s.completed || 0;
          const dfEl = document.getElementById('stat-delivery-failed');
          if (dfEl) dfEl.textContent = s.delivery_failed || 0;
          document.getElementById('failed').textContent = s.failed || 0;
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –æ–∂–∏–¥–∞—é—â–∏—Ö –æ–ø–ª–∞—Ç—ã
          const ppEl = document.getElementById('stat-pending-payment');
          if (ppEl) ppEl.textContent = s.pending_payment || 0;
          const cancelledEl = document.getElementById('stat-cancelled');
          if (cancelledEl) cancelledEl.textContent = s.cancelled || 0;
        }
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∫–∞—Ä—Ç–æ—á–µ–∫ —Å —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–æ–º
        document.querySelectorAll('.stat-card').forEach(c => {
          c.classList.toggle('active-filter', c.getAttribute('data-filter') === currentFilter);
        });
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∏ –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ —Å—Ä–∞–∑—É –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
        loadUnpaidRequests();
        loadCancelledRequests();
        setLoadingStatus(true, '–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫‚Ä¶');
        const listUrl = API_BASE + '/api/admin/requests?limit=' + (currentSearchRequestId || currentSearchUserId ? '200' : '50') + '&status=' + currentFilter + (currentSearchRequestId ? '&request_id=' + encodeURIComponent(currentSearchRequestId) : '') + (currentSearchUserId ? '&user_id=' + encodeURIComponent(currentSearchUserId) : '') + authQuery();
        const listResult = await fetchJson(listUrl, { headers: authHeaders() });
        const listJson = listResult.json;
        const listRes = listResult.res;
        if (listJson.success && Array.isArray(listJson.data)) renderRequests(listJson.data);
        else {
          const err = listJson.error || listRes.status || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
          document.getElementById('requests').innerHTML = '<div style="text-align:center;padding:40px;color:#e74c3c">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + escapeHtml(String(err)) + '<br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω / Check token</div>';
        }
        const settingsResult = await fetchJson(API_BASE + '/api/admin/settings' + authQueryFromPath(), { headers: authHeaders() });
        const settingsJson = settingsResult.json;
        if (settingsJson.success && settingsJson.settings) {
          const st = settingsJson.settings;
          const mt = st.deepseek_max_tokens;
          const inputEl = document.getElementById('settings-max-tokens');
          if (inputEl && (mt === 0 || mt > 0)) inputEl.value = Math.max(4096, Number(mt)) || 8192;
          const modelEl = document.getElementById('settings-model');
          if (modelEl && st.deepseek_model) {
            const opt = Array.from(modelEl.options).find(o => o.value === st.deepseek_model);
            if (opt) modelEl.value = st.deepseek_model;
            else { const o = new Option(st.deepseek_model, st.deepseek_model); modelEl.appendChild(o); modelEl.value = st.deepseek_model; }
          }
          const tempEl = document.getElementById('settings-temperature');
          if (tempEl && st.deepseek_temperature != null && Number.isFinite(Number(st.deepseek_temperature))) tempEl.value = Math.max(0, Math.min(2, Number(st.deepseek_temperature)));
        }
        setLoadingStatus(true, '–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏ –∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤‚Ä¶');
        await loadMonetizationData();
        loadReferralData();
        setLoadingStatus(false);
      } catch (e) {
        setLoadingStatus(false);
        const msg = (e && e.message) || String(e);
        const el = document.getElementById('requests');
        if (el) el.innerHTML = '<div style="text-align:center;padding:40px;color:#e74c3c">‚ùå ' + escapeHtml(msg) + '<br><br><button onclick="window.location.reload()" style="margin-top:12px;padding:10px 24px;background:#667eea;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:15px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button><br><br><span style="font-size:12px;color:#64748b">API: ' + escapeHtml(window.API_BASE || window.location.origin) + '</span></div>';
      }
    }

    // –õ—ë–≥–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏–π ‚Äî —Ç–æ–ª—å–∫–æ –∑–∞—è–≤–∫–∏ + —Å—á—ë—Ç—á–∏–∫–∏, –±–µ–∑ —Å–±—Ä–æ—Å–∞ –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    async function refreshAfterAction() {
      const token = getToken();
      if (!token) return;

      // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∏ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
      const savedScroll = window.scrollY;
      const expandedIds = [...document.querySelectorAll('.req-row.expanded')]
        .map(r => r.getAttribute('data-request-id')).filter(Boolean);
      const loadedIds = [...document.querySelectorAll('.req-row[data-loaded="true"]')]
        .map(r => r.getAttribute('data-request-id')).filter(Boolean);

      const el = document.getElementById('requests');
      if (el) el.style.opacity = '0.5';

      try {
        const [statsRes, listRes] = await Promise.all([
          fetchJson(API_BASE + '/api/admin/stats?' + new URLSearchParams({ token }).toString(), { headers: authHeaders() }, 10000),
          fetchJson(API_BASE + '/api/admin/requests?limit=' + (currentSearchRequestId ? '200' : '50') + '&status=' + currentFilter + (currentSearchRequestId ? '&request_id=' + encodeURIComponent(currentSearchRequestId) : '') + authQuery(), { headers: authHeaders() }, 10000),
        ]);

        if (statsRes.json && statsRes.json.success && statsRes.json.stats) {
          const s = statsRes.json.stats;
          document.getElementById('total').textContent = s.total;
          document.getElementById('pending').textContent = (s.pending || 0) + (s.processing || 0) + (s.astro_calculated || 0) + (s.lyrics_generated || 0) + (s.suno_processing || 0);
          document.getElementById('completed').textContent = s.completed || 0;
          const dfEl = document.getElementById('stat-delivery-failed');
          if (dfEl) dfEl.textContent = s.delivery_failed || 0;
          document.getElementById('failed').textContent = s.failed || 0;
          const ppEl = document.getElementById('stat-pending-payment');
          if (ppEl) ppEl.textContent = s.pending_payment || 0;
          const cancelledEl = document.getElementById('stat-cancelled');
          if (cancelledEl) cancelledEl.textContent = s.cancelled || 0;
        }

        if (listRes.json && listRes.json.success && Array.isArray(listRes.json.data)) {
          renderRequests(listRes.json.data);

          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–∫—Ä—ã—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π
          for (const id of expandedIds) {
            const row = document.getElementById('req-row-' + id);
            const body = document.getElementById('req-body-' + id);
            if (!row || !body) continue;
            row.classList.add('expanded');
            body.style.display = 'block';
            if (loadedIds.includes(id)) {
              row.setAttribute('data-loaded', 'true');
              // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç—ã—Ö —Å—Ç—Ä–æ–∫ —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
              loadFullDetail(id, body, row);
            }
          }
        }

        // –¢–∏—Ö–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∏ –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö ‚Äî –±–µ–∑ —Å–ø–∏–Ω–Ω–µ—Ä–∞
        loadUnpaidRequests(true);
        loadCancelledRequests(true);
      } catch(e) {
        // –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø—Ä–æ—Å—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å
      } finally {
        if (el) { el.style.opacity = '1'; }
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        window.scrollTo({ top: savedScroll, behavior: 'instant' });
      }
    }

    function getStatusOrder(status) {
      const order = { pending_payment: -1, pending: 1, astro_calculated: 2, lyrics_generated: 3, suno_processing: 4, completed: 5, delivery_failed: 4.5, failed: 0, cancelled: -2 };
      return order[status] !== undefined ? order[status] : 1;
    }
    function statusClass(gs) {
      if (gs === 'completed') return 'status-completed';
      if (gs === 'delivery_failed') return 'status-delivery-failed';
      if (gs === 'failed') return 'status-failed';
      if (gs === 'pending_payment') return 'status-payment';
      if (gs === 'cancelled') return 'status-cancelled';
      return 'status-pending';
    }
    function statusLabel(gs) {
      if (gs === 'completed') return '‚úÖ –ì–æ—Ç–æ–≤–æ';
      if (gs === 'delivery_failed') return 'üì≠ –ù–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ';
      if (gs === 'failed') return '‚ùå –û—à–∏–±–∫–∞';
      if (gs === 'pending_payment') return 'üí≥ –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã';
      if (gs === 'cancelled') return 'üö´ –û—Ç–º–µ–Ω–µ–Ω–∞';
      return '‚è≥ –í —Ä–∞–±–æ—Ç–µ';
    }
    function paymentLabel(ps) {
      if (!ps) return { text: '‚Äî', cls: 'mono-muted' };
      const s = String(ps).toLowerCase();
      if (['paid', 'gift_used', 'subscription_active'].includes(s)) return { text: '‚úÖ –û–ø–ª–∞—á–µ–Ω–æ', cls: '' };
      if (['requires_payment', 'pending'].includes(s)) return { text: '‚ö†Ô∏è –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ', cls: '' };
      return { text: String(ps), cls: '' };
    }

    function normalizeSteps(raw) {
      if (raw && typeof raw === 'object') return raw;
      if (typeof raw === 'string') {
        try { return JSON.parse(raw); } catch (e) { return {}; }
      }
      return {};
    }
    function renderRequests(data) {
      window._lastRequestsData = data;
      data = filterByPayment(data);
      data = sortRequests(data);
      const payLabel = currentPayFilter !== 'all' ? (' ¬∑ –û–ø–ª–∞—Ç–∞: ' + currentPayFilter) : '';
      if (!data.length) {
        const searchHint = currentSearchRequestId ? ' –ø–æ ID ¬´' + escapeHtml(currentSearchRequestId) + '¬ª' : '';
        document.getElementById('requests').innerHTML = '<div style="text-align:center;padding:60px;color:#94a3b8">üì≠ –ù–µ—Ç –∑–∞—è–≤–æ–∫' + searchHint + payLabel + '</div>';
        const bulkBarEmpty = document.getElementById('bulkActionsBar');
        if (bulkBarEmpty) bulkBarEmpty.style.display = 'none';
        return;
      }
      function stepMsg(steps, key) {
        if (!steps || typeof steps !== 'object') return '';
        const v = steps[key];
        return (v && String(v).trim()) ? escapeHtml(String(v).slice(0, 120)) : '';
      }
      function stepsDigest(steps) {
        const s = normalizeSteps(steps);
        const checks = [];
        if (s.astro_extensions) checks.push('–∞—Å—Ç—Ä–æ+: ' + escapeHtml(String(s.astro_extensions)));
        if (s.llm_response_saved) checks.push('deepseek: ' + escapeHtml(String(s.llm_response_saved)));
        if (s.cover_ready) checks.push('cover: ' + escapeHtml(String(s.cover_ready)));
        if (s.delivery_done) checks.push('delivery: ' + escapeHtml(String(s.delivery_done)));
        return checks.join(' ¬∑ ');
      }
      document.getElementById('requests').innerHTML = data.map(r => {
        const gs = r.generation_status || r.status || 'pending';
        const order = getStatusOrder(gs);
        const steps = normalizeSteps(r.generation_steps);
        const safeId = (r.id || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        const safeIdAttr = escapeAttr(r.id || '');
        const dateStr = r.created_at ? new Date(r.created_at).toLocaleDateString('ru-RU') + ' ' + new Date(r.created_at).toLocaleTimeString('ru-RU', {hour:'2-digit',minute:'2-digit'}) : '‚Äî';
        const isPendingPay = ['pending','requires_payment'].includes(String((r.payment_status || '').toLowerCase()));
        return `
        <div class="req-row" id="req-row-${safeIdAttr}" data-request-id="${safeIdAttr}">
          <div class="req-row-head" onclick="toggleRow('${safeId}')">
            <input type="checkbox" class="req-select-cb" data-request-id="${safeIdAttr}" aria-label="–í—ã–¥–µ–ª–∏—Ç—å –∑–∞—è–≤–∫—É" onclick="event.stopPropagation()" style="width:16px;height:16px;flex-shrink:0;cursor:pointer;">
            <div class="req-row-main">
              <span class="req-row-name">${escapeHtml(r.name || '‚Äî')}${r.person2_name ? ' & ' + escapeHtml(r.person2_name) : ''}</span>
              <span class="req-row-meta">${escapeHtml(r.mode || 'single')} ¬∑ ${dateStr}</span>
              ${r.error_message && gs !== 'completed' ? `<span style="font-size:10px;color:#fca5a5;display:block;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px;" title="${escapeAttr(r.error_message)}">‚ùå ${escapeHtml(String(r.error_message).slice(0, 80))}</span>` : ''}
            </div>
            <span class="req-row-status ${statusClass(gs)}" style="font-size:10px;padding:2px 8px;">${statusLabel(gs)}</span>
            ${(r.delivered_at || r.delivery_status === 'sent') ? '<span style="font-size:10px;color:#86efac;margin-left:4px;white-space:nowrap;" title="' + (r.delivered_at ? '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç ' + new Date(r.delivered_at).toLocaleString('ru-RU') : '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç') + '">‚úì –í —á–∞—Ç</span>' : ''}
            ${paymentMethodBadge(r)}
            ${r.telegram_user_id ? `<button class="tg-id-badge" onclick="event.stopPropagation();openTgUser(${r.telegram_user_id}, ${r.tg_username ? JSON.stringify(r.tg_username) : 'null'});" title="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç –≤ Telegram">‚úâÔ∏è ${r.tg_username ? '@' + r.tg_username : r.telegram_user_id}</button>` : ''}
            <div class="req-row-btns" onclick="event.stopPropagation()">
              <button class="rmb rmb-orange" onclick="restart('${safeId}',this)" title="${gs === 'completed' ? '–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å' : '–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å'}">‚Üª</button>
              ${isPendingPay ? `<button class="rmb rmb-green" onclick="markPaid('${safeId}')" title="–û—Ç–º–µ—Ç–∏—Ç—å –æ–ø–ª–∞—á–µ–Ω–Ω—ã–º">‚úì –û–ø–ª–∞—á–µ–Ω</button>` : ''}
              ${gs === 'pending_payment' ? `<button class="rmb rmb-red" onclick="cancelRequest('${safeId}', this)" title="–û—Ç–º–µ–Ω–∏—Ç—å">‚úï</button>` : ''}
              ${r.audio_url ? `<button class="rmb rmb-green" onclick="window.open('${r.audio_url.replace(/'/g,"\\'")}');event.stopPropagation();" title="–°–ª—É—à–∞—Ç—å –∞—É–¥–∏–æ">‚ñ∂</button>` : ''}
              ${r.audio_url ? `<button class="rmb rmb-blue" onclick="deliver('${safeId}',this);event.stopPropagation();" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é">üì§</button>` : ''}
            </div>
            <span class="req-chevron">‚Ä∫</span>
          </div>
          <div class="req-row-body" id="req-body-${safeIdAttr}">
          </div>
        </div>`;
      }).join('');
      const bulkBar = document.getElementById('bulkActionsBar');
      const selectAllCb = document.getElementById('selectAllRequests');
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      const countSpan = document.getElementById('deleteSelectedCount');
      if (bulkBar) bulkBar.style.display = data.length ? 'flex' : 'none';
      function updateBulkButton() {
        const checkboxes = document.querySelectorAll('#requests .req-select-cb');
        const checked = document.querySelectorAll('#requests .req-select-cb:checked');
        const n = checked.length;
        const total = checkboxes.length;
        if (countSpan) countSpan.textContent = n;
        if (deleteBtn) { deleteBtn.disabled = n === 0; }
        if (selectAllCb) { selectAllCb.checked = total > 0 && n === total; selectAllCb.indeterminate = n > 0 && n < total; }
      }
      function attachBulkListeners() {
        if (!data.length) return;
        if (selectAllCb) {
          selectAllCb.onchange = function() {
            document.querySelectorAll('#requests .req-select-cb').forEach(function(cb) { cb.checked = selectAllCb.checked; });
            updateBulkButton();
          };
        }
        document.querySelectorAll('#requests .req-select-cb').forEach(function(cb) {
          cb.onchange = updateBulkButton;
        });
        if (deleteBtn) {
          deleteBtn.onclick = async function() {
            const ids = Array.from(document.querySelectorAll('#requests .req-select-cb:checked')).map(function(cb) { return cb.getAttribute('data-request-id'); }).filter(Boolean);
            if (!ids.length) return;
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ ' + ids.length + ' –∑–∞—è–≤–æ–∫? –û–Ω–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –∏–∑ –±–∞–∑—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.')) return;
            deleteBtn.disabled = true;
            deleteBtn.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ‚Ä¶';
            try {
              const result = await fetchJson(API_BASE + '/api/admin/requests/delete' + authQueryFromPath(), { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify({ ids: ids }) });
              const json = result.json;
              if (json.success) { alert('–£–¥–∞–ª–µ–Ω–æ –∑–∞—è–≤–æ–∫: ' + (json.deleted || ids.length)); refreshAfterAction(); }
              else alert('–û—à–∏–±–∫–∞: ' + (json.error || 'unknown'));
            } catch (e) {
              alert('–û—à–∏–±–∫–∞: ' + (e && e.message ? e.message : e));
            } finally {
              deleteBtn.disabled = false;
              deleteBtn.innerHTML = 'üóë –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (<span id="deleteSelectedCount">0</span>)';
              var span = document.getElementById('deleteSelectedCount');
              if (span) span.textContent = '0';
            }
          };
        }
        updateBulkButton();
      }
      attachBulkListeners();
    }
    function copyTgId(id) {
      navigator.clipboard.writeText(String(id)).then(() => {
        const toast = document.createElement('div');
        toast.textContent = 'ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: ' + id;
        toast.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#1e293b;color:#a5b4fc;border:1px solid rgba(102,126,234,0.4);border-radius:8px;padding:8px 18px;font-size:13px;z-index:9999;pointer-events:none;';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
      }).catch(() => prompt('–°–∫–æ–ø–∏—Ä—É–π Telegram ID:', String(id)));
    }
    function openTgUser(id, username) {
      if (username) {
        window.open('https://t.me/' + username, '_blank');
        return;
      }
      // –ù–µ—Ç username ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏
      const existing = document.getElementById('tgUserModal');
      if (existing) existing.remove();
      const modal = document.createElement('div');
      modal.id = 'tgUserModal';
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;';
      modal.innerHTML = `
        <div style="background:#1e293b;border:1px solid #334155;border-radius:14px;padding:24px;max-width:360px;width:90%;color:#e2e8f0;text-align:center;">
          <div style="font-size:1.1rem;font-weight:600;margin-bottom:8px;">üìã Telegram ID: ${id}</div>
          <div style="font-size:0.82rem;color:#94a3b8;margin-bottom:18px;">–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç @username.<br>–û—Ç–∫—Ä–æ–π—Ç–µ Telegram –∏ –Ω–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—Ä—É—á–Ω—É—é.</div>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <button onclick="navigator.clipboard.writeText('${id}').then(()=>{this.textContent='‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';setTimeout(()=>this.textContent='üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID',1500)})" style="padding:10px;background:#3b82f6;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:0.9rem;">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID</button>
            <a href="tg://user?id=${id}" style="padding:10px;background:#22c55e;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:0.9rem;text-decoration:none;display:block;">üöÄ –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram Desktop</a>
            <button onclick="document.getElementById('tgUserModal').remove()" style="padding:8px;background:#475569;color:#e2e8f0;border:none;border-radius:8px;cursor:pointer;font-size:0.85rem;">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>`;
      modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
      document.body.appendChild(modal);
    }
    function escapeHtml(s) {
      if (s == null) return '';
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function escapeAttr(s) {
      return String(s == null ? '' : s).replace(/"/g, '&quot;');
    }


    // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ (pending_payment) –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å–µ–∫—Ü–∏—é –≤–≤–µ—Ä—Ö—É
    async function loadUnpaidRequests(silent) {
      const section = document.getElementById('unpaidSection');
      const list = document.getElementById('unpaidList');
      const badge = document.getElementById('unpaidBadge');
      if (!list) return;
      if (!silent) list.innerHTML = '<div class="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
      try {
        const result = await fetchJson(
          API_BASE + '/api/admin/requests?status=pending_payment&limit=50' + authQuery(),
          { headers: authHeaders() }
        );
        const items = (result.json && (result.json.data || result.json.requests)) || [];
        if (badge) badge.textContent = items.length;
        if (!items.length) {
          if (section) section.classList.remove('has-items');
          list.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">‚úÖ –ù–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫ –Ω–µ—Ç</div>';
          return;
        }
        if (section) section.classList.add('has-items');
        list.innerHTML = items.map(function(r) {
          const id = escapeHtml(r.id || '');
          const idShort = (r.id || '').substring(0, 8);
          const name = escapeHtml(r.name || '‚Äî');
          const date = r.created_at ? new Date(r.created_at).toLocaleString('ru-RU') : '‚Äî';
          const amount = r.payment_amount ? (r.payment_amount + ' ' + (r.payment_currency || 'USDT')) : '‚Äî';
          const safeId = (r.id || '').replace(/'/g, "\\'");
          return '<div class="unpaid-card">' +
            '<div class="unpaid-info">' +
              '<div class="unpaid-name">' + name + '</div>' +
              '<div class="unpaid-meta">' +
                'ID: <code>' + escapeHtml(idShort) + '</code> ¬∑ ' + date + '<br>' +
                '–°—É–º–º–∞: ' + escapeHtml(amount) + ' ¬∑ –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã: ' + escapeHtml(r.payment_status || '‚Äî') +
              '</div>' +
            '</div>' +
            '<div class="unpaid-actions">' +
              '<button class="btn btn-restore" style="min-width:120px;padding:8px 12px;font-size:13px;" onclick="restoreRequest(\'' + safeId + '\', this)" title="–ó–∞—Å—á–∏—Ç–∞—Ç—å –∫–∞–∫ –ø–æ–¥–∞—Ä–æ—á–Ω—ã–π –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é">üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>' +
              '<button class="btn btn-success" style="min-width:110px;padding:8px 12px;font-size:13px;" onclick="markPaid(\'' + safeId + '\')">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ</button>' +
              '<button class="btn btn-cancel" style="min-width:110px;padding:8px 12px;font-size:13px;" onclick="cancelRequest(\'' + safeId + '\', this)">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>' +
              '<button class="btn btn-danger" style="min-width:90px;padding:8px 12px;font-size:13px;background:#7f1d1d;border-color:#991b1b;color:#fca5a5;" onclick="deleteUnpaidRequest(\'' + safeId + '\', this)" title="–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É –∏–∑ –±–∞–∑—ã –Ω–∞–≤—Å–µ–≥–¥–∞">üóë –£–¥–∞–ª–∏—Ç—å</button>' +
            '</div>' +
          '</div>';
        }).join('');
      } catch (e) {
        if (section) section.classList.remove('has-items');
        list.innerHTML = '<div style="color:#e74c3c;padding:10px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + escapeHtml((e && e.message) || String(e)) + '</div>';
      }
    }

    // –û—Ç–º–µ–Ω–∞ –∑–∞—è–≤–∫–∏ –∏–∑ –∞–¥–º–∏–Ω–∫–∏
    async function cancelRequest(id, btn) {
      if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É ' + id.substring(0, 8) + '? –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç —Å—Ç–∞—Ç—É—Å ¬´–û—Ç–º–µ–Ω–µ–Ω–∞¬ª.')) return;
      if (btn) { btn.disabled = true; btn.textContent = '–û—Ç–º–µ–Ω–∞‚Ä¶'; }
      try {
        const result = await fetchJson(
          API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + '/cancel' + authQueryFromPath(),
          { method: 'POST', headers: authHeaders() }
        );
        if (result.json && result.json.success) {
          alert('‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞');
          await refreshAfterAction();
        } else {
          alert('–û—à–∏–±–∫–∞: ' + ((result.json && result.json.error) || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
          if (btn) { btn.disabled = false; btn.textContent = '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å'; }
        }
      } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + ((e && e.message) || String(e)));
        if (btn) { btn.disabled = false; btn.textContent = '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å'; }
      }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ –∏–∑ –±–∞–∑—ã –Ω–∞–≤—Å–µ–≥–¥–∞
    async function deleteUnpaidRequest(id, btn) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É ' + id.substring(0, 8) + ' –ù–ê–í–°–ï–ì–î–ê –∏–∑ –±–∞–∑—ã?\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
      if (btn) { btn.disabled = true; btn.textContent = '‚è≥'; }
      try {
        const result = await fetchJson(
          API_BASE + '/api/admin/requests/delete' + authQueryFromPath(),
          { method: 'POST', headers: { ...authHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ ids: [id] }) }
        );
        if (result.json && result.json.success) {
          // –£–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ–≥–æ —Å–ø–∏—Å–∫–∞
          const card = btn && btn.closest('.unpaid-card');
          if (card) {
            card.style.transition = 'opacity 0.3s';
            card.style.opacity = '0';
            setTimeout(function() {
              card.remove();
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫
              const remaining = document.querySelectorAll('#unpaidList .unpaid-card').length;
              const badge = document.getElementById('unpaidBadge');
              if (badge) badge.textContent = remaining;
              if (!remaining) {
                const section = document.getElementById('unpaidSection');
                if (section) section.classList.remove('has-items');
                const list = document.getElementById('unpaidList');
                if (list) list.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">‚úÖ –ù–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫ –Ω–µ—Ç</div>';
              }
            }, 300);
          }
        } else {
          alert('–û—à–∏–±–∫–∞: ' + ((result.json && result.json.error) || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
          if (btn) { btn.disabled = false; btn.textContent = 'üóë –£–¥–∞–ª–∏—Ç—å'; }
        }
      } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + ((e && e.message) || String(e)));
        if (btn) { btn.disabled = false; btn.textContent = 'üóë –£–¥–∞–ª–∏—Ç—å'; }
      }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –≤ –±–ª–æ–∫ ¬´–û—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ¬ª ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä—è–º–æ –∏–∑ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö
    async function loadCancelledRequests(silent) {
      const section = document.getElementById('cancelledSection');
      const list = document.getElementById('cancelledList');
      const badge = document.getElementById('cancelledBadge');
      const deleteAllBtn = document.getElementById('deleteAllCancelledBtn');
      if (!list) return;
      if (!silent) list.innerHTML = '<div class="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
      try {
        const result = await fetchJson(
          API_BASE + '/api/admin/requests?status=cancelled&limit=100' + authQuery(),
          { headers: authHeaders() }
        );
        const items = (result.json && (result.json.data || result.json.requests)) || [];
        if (badge) badge.textContent = items.length;
        if (deleteAllBtn) {
          deleteAllBtn.style.display = items.length ? 'inline-block' : 'none';
        }
        if (!items.length) {
          if (section) section.classList.remove('has-items');
          list.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">üö´ –û—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫ –Ω–µ—Ç</div>';
          return;
        }
        if (section) section.classList.add('has-items');
        list.innerHTML = items.map(function(r) {
          const id = escapeHtml(r.id || '');
          const idShort = (r.id || '').substring(0, 8);
          const name = escapeHtml(r.name || '‚Äî');
          const date = r.created_at ? new Date(r.created_at).toLocaleString('ru-RU') : '‚Äî';
          const safeId = (r.id || '').replace(/'/g, "\\'");
          return '<div class="unpaid-card cancelled-card">' +
            '<div class="unpaid-info">' +
              '<div class="unpaid-name">' + name + '</div>' +
              '<div class="unpaid-meta">ID: <code>' + escapeHtml(idShort) + '</code> ¬∑ ' + date + '</div>' +
            '</div>' +
            '<div class="unpaid-actions">' +
              '<button class="btn btn-danger" style="min-width:90px;padding:8px 12px;font-size:13px;background:#7f1d1d;border-color:#991b1b;color:#fca5a5;" onclick="deleteCancelledRequest(\'' + safeId + '\', this)" title="–£–¥–∞–ª–∏—Ç—å –∏–∑ –±–∞–∑—ã –Ω–∞–≤—Å–µ–≥–¥–∞">üóë –£–¥–∞–ª–∏—Ç—å</button>' +
            '</div>' +
          '</div>';
        }).join('');
      } catch (e) {
        if (section) section.classList.remove('has-items');
        list.innerHTML = '<div style="color:#e74c3c;padding:10px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + escapeHtml((e && e.message) || String(e)) + '</div>';
      }
    }

    async function deleteCancelledRequest(id, btn) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É ' + id.substring(0, 8) + ' –∏–∑ –±–∞–∑—ã –Ω–∞–≤—Å–µ–≥–¥–∞?')) return;
      if (btn) { btn.disabled = true; btn.textContent = '‚è≥'; }
      try {
        const result = await fetchJson(
          API_BASE + '/api/admin/requests/delete' + authQueryFromPath(),
          { method: 'POST', headers: { ...authHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ ids: [id] }) }
        );
        if (result.json && result.json.success) {
          const card = btn && btn.closest('.cancelled-card');
          if (card) {
            card.style.transition = 'opacity 0.3s';
            card.style.opacity = '0';
            setTimeout(function() {
              card.remove();
              const remaining = document.querySelectorAll('#cancelledList .cancelled-card').length;
              const badge = document.getElementById('cancelledBadge');
              if (badge) badge.textContent = remaining;
              const deleteAllBtn = document.getElementById('deleteAllCancelledBtn');
              if (deleteAllBtn) deleteAllBtn.style.display = remaining ? 'inline-block' : 'none';
              if (!remaining) {
                const list = document.getElementById('cancelledList');
                if (list) list.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">üö´ –û—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫ –Ω–µ—Ç</div>';
              }
            }, 300);
          }
        } else {
          alert('–û—à–∏–±–∫–∞: ' + ((result.json && result.json.error) || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
          if (btn) { btn.disabled = false; btn.textContent = 'üóë –£–¥–∞–ª–∏—Ç—å'; }
        }
      } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + ((e && e.message) || String(e)));
        if (btn) { btn.disabled = false; btn.textContent = 'üóë –£–¥–∞–ª–∏—Ç—å'; }
      }
    }

    async function deleteAllCancelled() {
      const cards = document.querySelectorAll('#cancelledList .cancelled-card');
      const ids = [...cards].map(c => {
        const btn = c.querySelector('button[onclick^="deleteCancelledRequest"]');
        if (!btn) return null;
        const m = btn.getAttribute('onclick').match(/deleteCancelledRequest\s*\(\s*['"]([^'"]+)['"]/);
        return m ? m[1] : null;
      }).filter(Boolean);
      if (!ids.length) return;
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑ –±–∞–∑—ã –≤—Å–µ ' + ids.length + ' –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫ –Ω–∞–≤—Å–µ–≥–¥–∞?\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
      try {
        const result = await fetchJson(
          API_BASE + '/api/admin/requests/delete' + authQueryFromPath(),
          { method: 'POST', headers: { ...authHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ ids: ids }) }
        );
        const json = result.json || {};
        if (json.success) {
          alert('–£–¥–∞–ª–µ–Ω–æ –∑–∞—è–≤–æ–∫: ' + (json.deleted || ids.length));
          loadCancelledRequests(true);
        } else {
          alert('–û—à–∏–±–∫–∞: ' + (json.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
        }
      } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + ((e && e.message) || String(e)));
      }
    }

    async function loadMonetizationData() {
      const pricingBody = document.getElementById('pricingTableBody');
      const promoBody = document.getElementById('promoTableBody');
      const paymentsBody = document.getElementById('paymentsTableBody');
      if (pricingBody) pricingBody.innerHTML = '<tr><td colspan="7" class="mono-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>';
      if (promoBody) promoBody.innerHTML = '<tr><td colspan="10" class="mono-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>';
      if (paymentsBody) paymentsBody.innerHTML = '<tr><td colspan="10" class="mono-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>';
      setMonoMsg('monetizationGlobalMsg', '–û–±–Ω–æ–≤–ª—è—é –¥–∞–Ω–Ω—ã–µ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏‚Ä¶', null);
      try {
        const [pricingResult, promoResult, paymentsResult, statsResult] = await Promise.all([
          fetchJson(API_BASE + '/api/admin/pricing' + authQueryFromPath(), { headers: authHeaders() }),
          fetchJson(API_BASE + '/api/admin/promos' + authQueryFromPath(), { headers: authHeaders() }),
          fetchJson(API_BASE + '/api/admin/payments?limit=100' + authQuery(), { headers: authHeaders() }),
          fetchJson(API_BASE + '/api/admin/payments/stats' + authQuery(), { headers: authHeaders() }),
        ]);
        renderPricingRows((pricingResult.json && pricingResult.json.catalog) || []);
        renderPromoRows((promoResult.json && promoResult.json.data) || []);
        renderPaymentsRows((paymentsResult.json && paymentsResult.json.data) || []);
        var st = (statsResult.json && statsResult.json.success) ? statsResult.json : {};
        var el24 = document.getElementById('payStatPaid24');
        var el7 = document.getElementById('payStatPaid7');
        var elP = document.getElementById('payStatPending');
        if (el24) el24.textContent = st.paid_24h != null ? st.paid_24h : '‚Äî';
        if (el7) el7.textContent = st.paid_7d != null ? st.paid_7d : '‚Äî';
        if (elP) elP.textContent = st.pending_count != null ? st.pending_count : '‚Äî';
        setMonoMsg('monetizationGlobalMsg', '–î–∞–Ω–Ω—ã–µ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.', true);
      } catch (e) {
        setMonoMsg('monetizationGlobalMsg', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—é: ' + ((e && e.message) || String(e)), false);
      }
    }

    async function loadReferralData() {
      const body = document.getElementById('referralsTableBody');
      if (body) body.innerHTML = '<tr><td colspan="5" class="mono-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>';
      try {
        const result = await fetchJson(API_BASE + '/api/admin/referrals' + authQueryFromPath(), { headers: authHeaders() });
        const json = result.json;
        if (json && json.success) {
          const totalEl = document.getElementById('refTotalCount');
          const rewEl = document.getElementById('refRewardedCount');
          if (totalEl) totalEl.textContent = json.total || 0;
          if (rewEl) rewEl.textContent = json.rewarded || 0;
          renderReferralRows(json.rows || []);
          setMonoMsg('referralsMsg', '–î–∞–Ω–Ω—ã–µ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.', true);
        } else {
          setMonoMsg('referralsMsg', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤: ' + ((json && json.error) || 'unknown'), false);
        }
      } catch (e) {
        setMonoMsg('referralsMsg', '–û—à–∏–±–∫–∞: ' + ((e && e.message) || String(e)), false);
      }
    }

    function renderReferralRows(rows) {
      const body = document.getElementById('referralsTableBody');
      if (!body) return;
      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="5" class="mono-muted">–†–µ—Ñ–µ—Ä–∞–ª–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</td></tr>';
        return;
      }
      body.innerHTML = rows.map(function(r) {
        const dateCreated = r.created_at ? new Date(r.created_at).toLocaleString('ru-RU') : '‚Äî';
        const dateActivated = r.activated_at ? new Date(r.activated_at).toLocaleString('ru-RU') : '‚Äî';
        const rewardBadge = r.reward_granted
          ? '<span style="color:#22c55e;font-weight:600;">‚úì –í—ã–¥–∞–Ω–∞</span>'
          : '<span style="color:#f59e0b;">‚è≥ –ñ–¥—ë—Ç</span>';
        return '<tr>' +
          '<td><code>' + escapeHtml(String(r.referrer_id || '‚Äî')) + '</code></td>' +
          '<td><code>' + escapeHtml(String(r.referee_id || '‚Äî')) + '</code></td>' +
          '<td class="mono-muted">' + escapeHtml(dateCreated) + '</td>' +
          '<td class="mono-muted">' + escapeHtml(dateActivated) + '</td>' +
          '<td>' + rewardBadge + '</td>' +
          '</tr>';
      }).join('');
    }

    // ‚îÄ‚îÄ‚îÄ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (Soul Chat, —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏, –∑–∞—è–≤–∫–∏) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadAnalytics() {
      const msgEl = document.getElementById('analyticsMsg');
      if (msgEl) msgEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶';
      try {
        const r = await fetchJson(API_BASE + '/api/admin/analytics' + authQueryFromPath(), { headers: authHeaders() });
        const d = r.json;
        if (!d || !d.success) { if (msgEl) msgEl.textContent = '–û—à–∏–±–∫–∞: ' + (d && d.error || 'unknown'); return; }
        const sc = d.soul_chat || {};
        const exp = d.expansion || {};
        const req = d.requests || {};
        function set(id, v) { const el = document.getElementById(id); if (el) el.textContent = v != null ? v : '‚Äî'; }
        set('ax-sc-24', sc.last_24h);
        set('ax-sc-7', sc.last_7d);
        set('ax-sc-30', sc.last_30d);
        set('ax-exp-total', exp.with_analysis);
        set('ax-exp-paid', exp.analysis_paid);
        set('ax-exp-free', exp.free_used);
        set('ax-req-c-24', req.created_24h);
        set('ax-req-c-7', req.created_7d);
        set('ax-req-c-30', req.created_30d);
        set('ax-req-d-24', req.completed_24h);
        set('ax-req-d-7', req.completed_7d);
        set('ax-req-d-30', req.completed_30d);
        if (msgEl) msgEl.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ ' + new Date().toLocaleTimeString('ru-RU');
      } catch (e) {
        if (msgEl) msgEl.textContent = '–û—à–∏–±–∫–∞: ' + (e && e.message || e);
      }
    }

    // ‚îÄ‚îÄ‚îÄ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadUserStats() {
      setMonoMsg('userStatsMsg', '–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶', true);
      try {
        const r = await fetchJson(API_BASE + '/api/admin/user-stats' + authQueryFromPath(), { headers: authHeaders() });
        const d = r.json;
        if (!d || !d.success) { setMonoMsg('userStatsMsg', '–û—à–∏–±–∫–∞: ' + (d && d.error || 'unknown'), false); return; }
        document.getElementById('us-total').textContent  = d.users.total  ?? '‚Äî';
        document.getElementById('us-today').textContent  = d.users.today  ?? '‚Äî';
        document.getElementById('us-week').textContent   = d.users.week   ?? '‚Äî';
        document.getElementById('us-month').textContent  = d.users.month  ?? '‚Äî';
        document.getElementById('us-basic').textContent  = d.subscriptions.basic  ?? '‚Äî';
        document.getElementById('us-plus').textContent   = d.subscriptions.plus   ?? '‚Äî';
        document.getElementById('us-master').textContent = d.subscriptions.master ?? '‚Äî';
        document.getElementById('us-sc-week').textContent   = d.soul_chat_week  ?? '‚Äî';
        document.getElementById('us-avg-rating').textContent = d.avg_rating ? (d.avg_rating + ' (' + d.ratings_count + ')') : '‚Äî';
        const tbody = document.getElementById('top10Body');
        if (tbody) {
          if (!d.top10 || !d.top10.length) { tbody.innerHTML = '<tr><td colspan="4" class="mono-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>'; }
          else {
            tbody.innerHTML = d.top10.map(function(u, i) {
              return '<tr><td>' + (i+1) + '</td><td><code>' + escapeHtml(String(u.telegram_user_id)) + '</code></td>' +
                '<td>' + escapeHtml(u.name || '‚Äî') + '</td><td><b>' + u.count + '</b></td></tr>';
            }).join('');
          }
        }
        setMonoMsg('userStatsMsg', '–û–±–Ω–æ–≤–ª–µ–Ω–æ ' + new Date().toLocaleTimeString('ru-RU'), true);
      } catch (e) {
        setMonoMsg('userStatsMsg', '–û—à–∏–±–∫–∞: ' + e.message, false);
      }
    }

    // ‚îÄ‚îÄ‚îÄ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadActiveSubs() {
      const plan   = document.getElementById('subListPlan')?.value   || '';
      const search = document.getElementById('subListSearch')?.value || '';
      const tbody  = document.getElementById('activeSubsBody');
      if (tbody) tbody.innerHTML = '<tr><td colspan="6" class="mono-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>';
      try {
        let url = API_BASE + '/api/admin/active-subscriptions' + authQueryFromPath();
        if (plan)   url += '&plan='   + encodeURIComponent(plan);
        if (search) url += '&search=' + encodeURIComponent(search);
        const r = await fetchJson(url, { headers: authHeaders() });
        const d = r.json;
        if (!d || !d.success) { setMonoMsg('activeSubsMsg', '–û—à–∏–±–∫–∞: ' + (d && d.error || 'unknown'), false); return; }
        const rows = d.rows || [];
        if (!rows.length) { if (tbody) tbody.innerHTML = '<tr><td colspan="6" class="mono-muted">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–µ—Ç.</td></tr>'; return; }
        const PLAN_NAMES = { soul_basic_sub: 'Basic', soul_plus_sub: 'Plus', master_monthly: '–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è' };
        if (tbody) tbody.innerHTML = rows.map(function(s) {
          const exp = s.renew_at ? new Date(s.renew_at).toLocaleDateString('ru-RU') : '‚Äî';
          const days = s.days_left != null ? s.days_left + ' –¥–Ω.' : '‚Äî';
          const daysColor = s.days_left <= 3 ? '#ef4444' : s.days_left <= 7 ? '#f59e0b' : '#22c55e';
          const prof = s.user_profiles || {};
          const name = escapeHtml(prof.name || '‚Äî');
          const uname = prof.tg_username ? '<a href="https://t.me/' + escapeHtml(prof.tg_username) + '" target="_blank" style="color:#38bdf8;">@' + escapeHtml(prof.tg_username) + '</a>' : '';
          return '<tr>' +
            '<td><code>' + escapeHtml(String(s.telegram_user_id)) + '</code></td>' +
            '<td>' + name + (uname ? ' ' + uname : '') + '</td>' +
            '<td>' + escapeHtml(PLAN_NAMES[s.plan_sku] || s.plan_sku) + '</td>' +
            '<td>' + escapeHtml(exp) + '</td>' +
            '<td style="color:' + daysColor + ';font-weight:600;">' + escapeHtml(days) + '</td>' +
            '<td><button class="btn" style="padding:4px 10px;font-size:12px;background:#7f1d1d;color:#fca5a5;" onclick="revokeSub(\'' + escapeHtml(s.id) + '\',\'' + escapeHtml(String(s.telegram_user_id)) + '\')">–û—Ç–æ–∑–≤–∞—Ç—å</button></td>' +
            '</tr>';
        }).join('');
        setMonoMsg('activeSubsMsg', '–ü–æ–∫–∞–∑–∞–Ω–æ ' + rows.length + ' –ø–æ–¥–ø–∏—Å–æ–∫', true);
      } catch (e) {
        setMonoMsg('activeSubsMsg', '–û—à–∏–±–∫–∞: ' + e.message, false);
      }
    }

    async function revokeSub(subId, userId) {
      if (!confirm('–û—Ç–æ–∑–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ' + userId + '? –≠—Ç–æ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç –¥–æ—Å—Ç—É–ø.')) return;
      try {
        const r = await fetchJson(API_BASE + '/api/admin/revoke-subscription' + authQueryFromPath(), {
          method: 'POST',
          headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
          body: JSON.stringify({ subscription_id: subId, telegram_user_id: Number(userId) }),
        });
        const d = r.json;
        if (d && d.success) { setMonoMsg('activeSubsMsg', '‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ç–æ–∑–≤–∞–Ω–∞', true); loadActiveSubs(); }
        else setMonoMsg('activeSubsMsg', '–û—à–∏–±–∫–∞: ' + (d && d.error || 'unknown'), false);
      } catch (e) {
        setMonoMsg('activeSubsMsg', '–û—à–∏–±–∫–∞: ' + e.message, false);
      }
    }

    // ‚îÄ‚îÄ‚îÄ –ë–ª–æ–≥–µ—Ä—Å–∫–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadCampaigns() {
      const tbody = document.getElementById('campaignsBody');
      if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="mono-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>';
      try {
        const r = await fetchJson(API_BASE + '/api/admin/campaigns' + authQueryFromPath(), { headers: authHeaders() });
        const d = r.json;
        if (!d || !d.success) { setMonoMsg('campaignsMsg', '–û—à–∏–±–∫–∞: ' + (d && d.error || 'unknown'), false); return; }
        const camps = d.campaigns || [];
        if (!camps.length) { if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="mono-muted">–ö–∞–º–ø–∞–Ω–∏–π –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é.</td></tr>'; return; }
        const botUser = (window.API_BASE || '').includes('localhost') ? 'yupsoul_bot' : 'yupsoul_bot';
        if (tbody) tbody.innerHTML = camps.map(function(c) {
          const link = 'https://t.me/' + botUser + '?start=camp_' + encodeURIComponent(c.code);
          const dt = c.created_at ? new Date(c.created_at).toLocaleDateString('ru-RU') : '‚Äî';
          return '<tr>' +
            '<td>' + escapeHtml(c.name) + '</td>' +
            '<td><code>' + escapeHtml(c.code) + '</code></td>' +
            '<td><a href="' + link + '" target="_blank" style="color:#38bdf8;font-size:11px;" onclick="navigator.clipboard&&navigator.clipboard.writeText(\'' + link + '\').then(()=>alert(\'–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!\'))">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</a></td>' +
            '<td style="text-align:center;font-weight:600;color:#a78bfa;">' + (c.registrations || 0) + '</td>' +
            '<td style="text-align:center;font-weight:600;color:#22c55e;">' + (c.paid_orders || 0) + '</td>' +
            '<td style="font-size:12px;color:#64748b;">' + escapeHtml(c.notes || '‚Äî') + '</td>' +
            '<td class="mono-muted">' + escapeHtml(dt) + '</td>' +
            '<td><button class="btn" style="padding:4px 8px;font-size:11px;background:#7f1d1d;color:#fca5a5;" onclick="deleteCampaign(\'' + escapeHtml(c.code) + '\')">‚úï</button></td>' +
            '</tr>';
        }).join('');
        setMonoMsg('campaignsMsg', '–ö–∞–º–ø–∞–Ω–∏–π: ' + camps.length, true);
      } catch (e) {
        setMonoMsg('campaignsMsg', '–û—à–∏–±–∫–∞: ' + e.message, false);
      }
    }

    async function createCampaign() {
      const name  = document.getElementById('newCampName')?.value.trim();
      const code  = document.getElementById('newCampCode')?.value.trim();
      const notes = document.getElementById('newCampNotes')?.value.trim();
      if (!name || !code) { setMonoMsg('newCampMsg', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–¥', false); return; }
      try {
        const r = await fetchJson(API_BASE + '/api/admin/campaigns' + authQueryFromPath(), {
          method: 'POST',
          headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
          body: JSON.stringify({ name, code, notes }),
        });
        const d = r.json;
        if (d && d.success) {
          setMonoMsg('newCampMsg', '‚úÖ –ö–∞–º–ø–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∞: camp_' + d.campaign.code, true);
          document.getElementById('newCampName').value = '';
          document.getElementById('newCampCode').value = '';
          document.getElementById('newCampNotes').value = '';
          loadCampaigns();
        } else {
          setMonoMsg('newCampMsg', '–û—à–∏–±–∫–∞: ' + (d && d.error || 'unknown'), false);
        }
      } catch (e) {
        setMonoMsg('newCampMsg', '–û—à–∏–±–∫–∞: ' + e.message, false);
      }
    }

    async function deleteCampaign(code) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é "' + code + '"? –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è.')) return;
      try {
        const r = await fetchJson(API_BASE + '/api/admin/campaigns/' + encodeURIComponent(code) + authQueryFromPath(), {
          method: 'DELETE', headers: authHeaders(),
        });
        const d = r.json;
        if (d && d.success) { setMonoMsg('campaignsMsg', '‚úÖ –£–¥–∞–ª–µ–Ω–æ', true); loadCampaigns(); }
        else setMonoMsg('campaignsMsg', '–û—à–∏–±–∫–∞: ' + (d && d.error || 'unknown'), false);
      } catch (e) {
        setMonoMsg('campaignsMsg', '–û—à–∏–±–∫–∞: ' + e.message, false);
      }
    }

    function renderPricingRows(rows) {
      const body = document.getElementById('pricingTableBody');
      if (!body) return;
      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="7" class="mono-muted">–¢–∞—Ä–∏—Ñ—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</td></tr>';
        return;
      }
      body.innerHTML = rows.map(function(item) {
        const sku = escapeHtml(item.sku || '');
        const limits = item.limits_json && typeof item.limits_json === 'object' ? JSON.stringify(item.limits_json) : (item.limits_json || '{}');
        return '<tr data-sku="' + sku + '">' +
          '<td><code>' + sku + '</code></td>' +
          '<td><input data-field="title" value="' + escapeAttr(item.title || '') + '"></td>' +
          '<td><input type="number" step="0.01" min="0" data-field="price" value="' + escapeAttr(item.price || 0) + '"></td>' +
          '<td><input data-field="currency" value="' + escapeAttr(item.currency || 'USDT') + '"></td>' +
          '<td style="text-align:center;"><input type="checkbox" data-field="active" ' + (item.active === false ? '' : 'checked') + '></td>' +
          '<td><input data-field="limits_json" value="' + escapeAttr(limits) + '"></td>' +
          '<td><button class="btn btn-primary" style="min-width:120px;padding:8px 12px;font-size:12px;" onclick="savePricingRow(\'' + escapeAttr(item.sku || '') + '\')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></td>' +
          '</tr>';
      }).join('');
    }

    function promoTypeLabel(type) {
      if (type === 'discount_percent') return '% —Å–∫–∏–¥–∫–∞';
      if (type === 'discount_amount') return '$ —Å–∫–∏–¥–∫–∞';
      if (type === 'free_generation') return 'üéÅ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ';
      return type || '‚Äî';
    }
    function renderPromoRows(rows) {
      const body = document.getElementById('promoTableBody');
      if (!body) return;
      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="9" class="mono-muted">–ü—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–µ—Ç. –°–æ–∑–¥–∞–π –ø–µ—Ä–≤—ã–π –≤—ã—à–µ ‚Üë</td></tr>';
        return;
      }
      body.innerHTML = rows.map(function(item) {
        const code = escapeHtml(item.code || '');
        const expiresLabel = item.expires_at ? new Date(item.expires_at).toLocaleString('ru-RU') : '‚àû';
        const usedOf = (item.used_count == null ? 0 : item.used_count) + ' / ' + (item.max_uses == null ? '‚àû' : item.max_uses);
        const valueLabel = item.type === 'free_generation' ? '‚Äî' : (item.value != null ? String(item.value) + (item.type === 'discount_percent' ? '%' : ' USDT') : '‚Äî');
        const activeLabel = item.active !== false
          ? '<span style="color:#22c55e;font-weight:600;">‚úì –î–∞</span>'
          : '<span style="color:#ef4444;">‚úó –ù–µ—Ç</span>';
        return '<tr data-code="' + code + '">' +
          '<td><code style="font-size:1rem;color:#d4af37;">' + code + '</code></td>' +
          '<td>' + escapeHtml(promoTypeLabel(item.type)) + '</td>' +
          '<td>' + escapeHtml(valueLabel) + '</td>' +
          '<td>' + escapeHtml(item.sku || '–≤—Å–µ') + '</td>' +
          '<td>' + escapeHtml(usedOf) + ' (–Ω–∞ 1 —é–∑–µ—Ä–∞: ' + (item.per_user_limit || 1) + ')</td>' +
          '<td>' + activeLabel + '</td>' +
          '<td class="mono-muted">' + escapeHtml(expiresLabel) + '</td>' +
          '<td style="font-weight:600;">' + escapeHtml(String(item.used_count == null ? 0 : item.used_count)) + '</td>' +
          '<td style="display:flex;gap:6px;flex-wrap:wrap;">' +
            '<button class="btn btn-primary" style="padding:6px 12px;font-size:12px;" onclick="togglePromoActive(\'' + escapeAttr(item.code || '') + '\',' + (item.active !== false) + ')">' +
              (item.active !== false ? '‚è∏ –î–µ–∞–∫—Ç.' : '‚ñ∂ –ê–∫—Ç–∏–≤.') +
            '</button>' +
            '<button class="btn" style="padding:6px 12px;font-size:12px;background:#ef4444;border-color:#ef4444;color:#fff;" onclick="deletePromo(\'' + escapeAttr(item.code || '') + '\')">üóë –£–¥–∞–ª–∏—Ç—å</button>' +
          '</td>' +
          '</tr>';
      }).join('');
    }

    function renderPaymentsRows(rows) {
      const body = document.getElementById('paymentsTableBody');
      if (!body) return;
      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="11" class="mono-muted">–û–ø–ª–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</td></tr>';
        return;
      }
      body.innerHTML = rows.map(function(item) {
        const paidAt = item.paid_at ? new Date(item.paid_at).toLocaleString('ru-RU') : (item.created_at ? new Date(item.created_at).toLocaleString('ru-RU') : '‚Äî');
        const reqId = String(item.id || '');
        const orderId = String(item.payment_order_id || '');
        const txId = String(item.payment_tx_id || '');
        const amount = item.payment_amount != null ? (String(item.payment_amount) + ' ' + (item.payment_currency || 'USDT')) : '‚Äî';
        const methodBadge = paymentMethodBadge(item);
        const ps = String(item.payment_status || '').toLowerCase();
        const statusColor = ['paid','gift_used','subscription_active'].includes(ps) ? '#22c55e' : (ps === 'requires_payment' ? '#f59e0b' : '#94a3b8');
        const statusHuman = ps === 'paid' ? '‚úì –û–ø–ª–∞—á–µ–Ω–æ' : ps === 'gift_used' ? 'üéÅ –ü–æ–¥–∞—Ä–æ–∫' : ps === 'subscription_active' ? 'üìã –ü–æ–¥–ø–∏—Å–∫–∞' : ps === 'requires_payment' ? '‚è≥ –û–∂–∏–¥–∞–µ—Ç' : escapeHtml(ps || '‚Äî');
        const promo = item.promo_code ? '<span style="color:#d4af37;font-weight:600;">' + escapeHtml(item.promo_code) + '</span>' + (item.promo_discount_amount ? ' <span style="color:#94a3b8;">(-' + escapeHtml(String(item.promo_discount_amount)) + ')</span>' : '') : '‚Äî';
        const userId = item.telegram_user_id != null ? String(item.telegram_user_id) : '‚Äî';
        return '<tr>' +
          '<td style="font-size:11px;">' + escapeHtml(paidAt) + '</td>' +
          '<td><code title="' + escapeAttr(reqId) + '">' + escapeHtml(reqId.slice(0, 8)) + '</code></td>' +
          '<td><code title="' + escapeAttr(userId) + '">' + escapeHtml(userId !== '‚Äî' ? userId.slice(0, 10) + (userId.length > 10 ? '‚Ä¶' : '') : '‚Äî') + '</code></td>' +
          '<td>' + escapeHtml(item.name || '‚Äî') + '</td>' +
          '<td>' + escapeHtml(item.mode || '‚Äî') + '</td>' +
          '<td>' + methodBadge + '</td>' +
          '<td style="color:' + statusColor + ';font-weight:600;font-size:12px;">' + statusHuman + '</td>' +
          '<td style="font-weight:600;">' + escapeHtml(amount) + '</td>' +
          '<td title="' + escapeAttr(orderId) + '" style="font-size:11px;">' + escapeHtml(orderId ? orderId.slice(0, 12) + '‚Ä¶' : '‚Äî') + '</td>' +
          '<td title="' + escapeAttr(txId) + '" style="font-size:11px;">' + escapeHtml(txId ? txId.slice(0, 12) + '‚Ä¶' : '‚Äî') + '</td>' +
          '<td>' + promo + '</td>' +
          '</tr>';
      }).join('');
    }

    async function savePricingRow(sku) {
      const row = Array.from(document.querySelectorAll('#pricingTableBody tr')).find(function(r) {
        return r.getAttribute('data-sku') === sku;
      });
      if (!row) return;
      const titleEl = row.querySelector('[data-field="title"]');
      const priceEl = row.querySelector('[data-field="price"]');
      const currencyEl = row.querySelector('[data-field="currency"]');
      const activeEl = row.querySelector('[data-field="active"]');
      const limitsEl = row.querySelector('[data-field="limits_json"]');
      let limitsJson = {};
      try {
        limitsJson = limitsEl && String(limitsEl.value || '').trim() ? JSON.parse(limitsEl.value) : {};
      } catch (_) {
        setMonoMsg('pricingMsg', '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –≤ limits_json –¥–ª—è SKU ' + sku, false);
        return;
      }
      const payload = {
        title: titleEl ? titleEl.value : sku,
        price: priceEl ? Number(priceEl.value || 0) : 0,
        currency: currencyEl ? String(currencyEl.value || 'USDT').toUpperCase() : 'USDT',
        active: !!(activeEl && activeEl.checked),
        limits_json: limitsJson,
      };
      setMonoMsg('pricingMsg', '–°–æ—Ö—Ä–∞–Ω—è—é —Ç–∞—Ä–∏—Ñ ' + sku + '‚Ä¶', null);
      try {
        const result = await fetchJson(API_BASE + '/api/admin/pricing/' + encodeURIComponent(sku) + authQueryFromPath(), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(payload),
        });
        if (result.json && result.json.success) {
          setMonoMsg('pricingMsg', '–¢–∞—Ä–∏—Ñ ' + sku + ' —Å–æ—Ö—Ä–∞–Ω—ë–Ω.', true);
          await loadMonetizationData();
        } else {
          setMonoMsg('pricingMsg', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞ ' + sku + ': ' + ((result.json && result.json.error) || 'unknown'), false);
        }
      } catch (e) {
        setMonoMsg('pricingMsg', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞ ' + sku + ': ' + ((e && e.message) || String(e)), false);
      }
    }

    async function savePromoRow(code) {
      const row = Array.from(document.querySelectorAll('#promoTableBody tr')).find(function(r) {
        return r.getAttribute('data-code') === code;
      });
      if (!row) return;
      const typeEl = row.querySelector('[data-field="type"]');
      const valueEl = row.querySelector('[data-field="value"]');
      const skuEl = row.querySelector('[data-field="sku"]');
      const maxUsesEl = row.querySelector('[data-field="max_uses"]');
      const perUserEl = row.querySelector('[data-field="per_user_limit"]');
      const activeEl = row.querySelector('[data-field="active"]');
      const payload = {
        type: typeEl ? typeEl.value : 'discount_percent',
        value: valueEl && String(valueEl.value).trim() ? Number(valueEl.value) : null,
        sku: skuEl && String(skuEl.value).trim() ? String(skuEl.value).trim() : null,
        max_uses: maxUsesEl && String(maxUsesEl.value).trim() ? Number(maxUsesEl.value) : null,
        per_user_limit: perUserEl && String(perUserEl.value).trim() ? Number(perUserEl.value) : 1,
        active: !!(activeEl && activeEl.checked),
      };
      setMonoMsg('promoMsg', '–°–æ—Ö—Ä–∞–Ω—è—é –ø—Ä–æ–º–æ–∫–æ–¥ ' + code + '‚Ä¶', null);
      try {
        const result = await fetchJson(API_BASE + '/api/admin/promos/' + encodeURIComponent(code) + authQueryFromPath(), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(payload),
        });
        if (result.json && result.json.success) {
          setMonoMsg('promoMsg', '–ü—Ä–æ–º–æ–∫–æ–¥ ' + code + ' —Å–æ—Ö—Ä–∞–Ω—ë–Ω.', true);
          await loadMonetizationData();
        } else {
          setMonoMsg('promoMsg', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ ' + code + ': ' + ((result.json && result.json.error) || 'unknown'), false);
        }
      } catch (e) {
        setMonoMsg('promoMsg', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ ' + code + ': ' + ((e && e.message) || String(e)), false);
      }
    }

    async function createPromoCode() {
      const code = (document.getElementById('newPromoCode').value || '').trim().toUpperCase();
      if (!code) { setMonoMsg('promoMsg', '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞', false); return; }
      const type = document.getElementById('newPromoType').value;
      const valueRaw = document.getElementById('newPromoValue').value.trim();
      const skuRaw = document.getElementById('newPromoSku').value.trim();
      const maxUsesRaw = document.getElementById('newPromoMaxUses').value.trim();
      const perUserRaw = document.getElementById('newPromoPerUser').value.trim();
      const startsAt = document.getElementById('newPromoStartsAt').value || null;
      const expiresAt = document.getElementById('newPromoExpiresAt').value || null;
      const active = document.getElementById('newPromoActive').checked;
      const payload = {
        type,
        value: valueRaw ? Number(valueRaw) : null,
        sku: skuRaw || null,
        max_uses: maxUsesRaw ? Number(maxUsesRaw) : null,
        per_user_limit: perUserRaw ? Number(perUserRaw) : 1,
        active,
        starts_at: startsAt ? new Date(startsAt).toISOString() : null,
        expires_at: expiresAt ? new Date(expiresAt).toISOString() : null,
      };
      setMonoMsg('promoMsg', '–°–æ–∑–¥–∞—é –ø—Ä–æ–º–æ–∫–æ–¥ ' + code + '‚Ä¶', null);
      try {
        const result = await fetchJson(API_BASE + '/api/admin/promos/' + encodeURIComponent(code) + authQueryFromPath(), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(payload),
        });
        if (result.json && result.json.success) {
          setMonoMsg('promoMsg', '‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ ' + code + ' —Å–æ–∑–¥–∞–Ω!', true);
          document.getElementById('newPromoCode').value = '';
          document.getElementById('newPromoValue').value = '';
          document.getElementById('newPromoSku').value = '';
          document.getElementById('newPromoMaxUses').value = '';
          document.getElementById('newPromoStartsAt').value = '';
          document.getElementById('newPromoExpiresAt').value = '';
          document.getElementById('newPromoDetails').removeAttribute('open');
          await loadMonetizationData();
        } else {
          setMonoMsg('promoMsg', '‚ùå –û—à–∏–±–∫–∞: ' + ((result.json && result.json.error) || 'unknown'), false);
        }
      } catch(e) {
        setMonoMsg('promoMsg', '‚ùå –û—à–∏–±–∫–∞: ' + (e && e.message || String(e)), false);
      }
    }

    async function togglePromoActive(code, currentlyActive) {
      setMonoMsg('promoMsg', (currentlyActive ? '–î–µ–∞–∫—Ç–∏–≤–∏—Ä—É—é' : '–ê–∫—Ç–∏–≤–∏—Ä—É—é') + ' –ø—Ä–æ–º–æ–∫–æ–¥ ' + code + '‚Ä¶', null);
      try {
        const result = await fetchJson(API_BASE + '/api/admin/promos/' + encodeURIComponent(code) + authQueryFromPath(), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({ active: !currentlyActive }),
        });
        if (result.json && result.json.success) {
          setMonoMsg('promoMsg', '‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ ' + code + (currentlyActive ? ' –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : ' –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'), true);
          await loadMonetizationData();
        } else {
          setMonoMsg('promoMsg', '‚ùå –û—à–∏–±–∫–∞: ' + ((result.json && result.json.error) || 'unknown'), false);
        }
      } catch(e) {
        setMonoMsg('promoMsg', '‚ùå –û—à–∏–±–∫–∞: ' + (e && e.message || String(e)), false);
      }
    }

    async function deletePromo(code) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ ' + code + '? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
      setMonoMsg('promoMsg', '–£–¥–∞–ª—è—é –ø—Ä–æ–º–æ–∫–æ–¥ ' + code + '‚Ä¶', null);
      try {
        const result = await fetchJson(API_BASE + '/api/admin/promos/' + encodeURIComponent(code) + authQueryFromPath(), {
          method: 'DELETE',
          headers: authHeaders(),
        });
        if (result.json && result.json.success) {
          setMonoMsg('promoMsg', '‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ ' + code + ' —É–¥–∞–ª—ë–Ω.', true);
          await loadMonetizationData();
        } else {
          setMonoMsg('promoMsg', '‚ùå –û—à–∏–±–∫–∞: ' + ((result.json && result.json.error) || 'unknown'), false);
        }
      } catch(e) {
        setMonoMsg('promoMsg', '‚ùå –û—à–∏–±–∫–∞: ' + (e && e.message || String(e)), false);
      }
    }

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞—Å—Ç—Ä—è–≤—à—É—é –∑–∞—è–≤–∫—É: –∑–∞—Å—á–∏—Ç–∞—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—É—é –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
    window.restoreRequest = async function restoreRequest(id, btn) {
      if (!confirm('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞—è–≤–∫—É ' + id.substring(0, 8) + '?\n\n–î–µ–π—Å—Ç–≤–∏–µ: –æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—É—é (–ø—Ä–æ–≤–∞–π–¥–µ—Ä: admin) –∏ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é.')) return;
      if (btn) { btn.disabled = true; btn.textContent = '‚è≥ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶'; }
      try {
        // 1. markPaid
        const paid = await fetchJson(API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + '/mark-paid' + authQueryFromPath(), {
          method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify({ provider: 'admin' })
        });
        if (!paid.json || !paid.json.success) {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –æ–ø–ª–∞—Ç—ã: ' + ((paid.json && paid.json.error) || 'unknown'));
          if (btn) { btn.disabled = false; btn.textContent = 'üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å'; }
          return;
        }
        // 2. restart
        const restarted = await fetchJson(API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + '/restart' + authQueryFromPath(), {
          method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() }
        });
        if (restarted.json && restarted.json.success) {
          alert('‚úÖ –ó–∞—è–≤–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞!');
          await refreshAfterAction();
        } else {
          alert('–û–ø–ª–∞—Ç–∞ –∑–∞—Å—á–∏—Ç–∞–Ω–∞, –Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –Ω–µ —É–¥–∞–ª—Å—è: ' + ((restarted.json && restarted.json.error) || 'unknown'));
          await refreshAfterAction();
        }
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ' + ((e && e.message) || String(e)));
        if (btn) { btn.disabled = false; btn.textContent = 'üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å'; }
      }
    };

    window.savePricingRow = savePricingRow;
    window.savePromoRow = savePromoRow;
    window.createPromoCode = createPromoCode;
    window.togglePromoActive = togglePromoActive;
    window.deletePromo = deletePromo;
    window.filterByCard = filterByCard;
    window.setSort = setSort;
    window.setPayFilter = setPayFilter;
    window.searchByRequestId = searchByRequestId;

    document.getElementById('searchRequestId')?.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') { e.preventDefault(); searchByRequestId(); }
    });

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        if (btn.id === 'searchRequestIdBtn') return;
        currentFilter = this.getAttribute('data-filter') || 'all';
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.stat-card').forEach(c => {
          c.classList.toggle('active-filter', c.getAttribute('data-filter') === currentFilter);
        });
        refreshAfterAction();
      });
    });

    (function initSearchByRequestId() {
      const input = document.getElementById('searchRequestId');
      const btn = document.getElementById('searchRequestIdBtn');
      const clearBtn = document.getElementById('clearSearchIdBtn');
      function doSearch() {
        const raw = (input && input.value) ? input.value.trim().toLowerCase().replace(/[^0-9a-f-]/g, '') : '';
        currentSearchRequestId = raw;
        if (clearBtn) clearBtn.style.display = currentSearchRequestId ? 'inline-block' : 'none';
        refreshAfterAction();
      }
      function clearSearch() {
        currentSearchRequestId = '';
        if (input) input.value = '';
        if (clearBtn) clearBtn.style.display = 'none';
        refreshAfterAction();
      }
      if (btn) btn.addEventListener('click', doSearch);
      if (clearBtn) clearBtn.addEventListener('click', clearSearch);
      if (input) {
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') { e.preventDefault(); doSearch(); }
        });
      }
    })();

    document.getElementById('settings-save-btn')?.addEventListener('click', async function() {
      const input = document.getElementById('settings-max-tokens');
      const modelEl = document.getElementById('settings-model');
      const tempEl = document.getElementById('settings-temperature');
      const statusEl = document.getElementById('settings-save-status');
      if (!input || !statusEl) return;
      const val = Math.min(65536, Math.max(4096, Number(input.value) || 8192));
      input.value = val;
      const modelVal = (modelEl && modelEl.value) ? modelEl.value.trim() : '';
      const tempVal = (tempEl && tempEl.value !== '') ? Math.max(0, Math.min(2, Number(tempEl.value))) : 1.5;
      if (tempEl) tempEl.value = tempVal;
      statusEl.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶';
      statusEl.style.color = '#94a3b8';
      try {
        const body = { deepseek_max_tokens: val, deepseek_temperature: tempVal };
        if (modelVal) body.deepseek_model = modelVal;
        const result = await fetchJson(API_BASE + '/api/admin/settings' + authQueryFromPath(), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(body)
        });
        const json = result.json;
        if (json.success) { statusEl.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'; statusEl.style.color = '#86efac'; setTimeout(() => { statusEl.textContent = ''; }, 3000); }
        else { statusEl.textContent = '‚ùå ' + (json.error || '–û—à–∏–±–∫–∞'); statusEl.style.color = '#e74c3c'; }
      } catch (e) {
        statusEl.textContent = '‚ùå ' + (e && e.message ? e.message : '–û—à–∏–±–∫–∞');
        statusEl.style.color = '#e74c3c';
      }
    });
    document.getElementById('monetization-refresh-btn')?.addEventListener('click', function() {
      loadMonetizationData();
    });

    window.showDetails = async function showDetails(id) {
      const url = API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + authQueryFromPath();
      let json, res;
      try {
        const result = await fetchJson(url, { headers: authHeaders() });
        res = result.res;
        json = result.json;
      } catch (e) {
        const msg = (e && e.message ? e.message : '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        const hint = msg === 'Failed to fetch'
          ? '–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª (—Å–µ—Ç—å –∏–ª–∏ —Ö–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç Render). –ü–æ–¥–æ–∂–¥–∏—Ç–µ 30 —Å–µ–∫ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥—Ä–æ–±–Ω–µ–µ¬ª —Å–Ω–æ–≤–∞.'
          : '–û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω–∫—É –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ –±–æ—Ç–∞ (/admin).';
        alert('‚ùå ' + msg + '\n\n' + hint);
        return;
      }
      if (!json.success || !json.data) {
        alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (json.error || res.status || 'Load error'));
        return;
      }
      const r = json.data;
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;overflow:auto;';
      const astroText = (r.astro_snapshot_text || '').trim();
      const astroJson = (r.astro_snapshot_json && typeof r.astro_snapshot_json === 'object') ? JSON.stringify(r.astro_snapshot_json, null, 2) : '';
      const astroBlock = astroText
        ? '<div class="details-section" style="margin-bottom:24px;"><div class="section-title" style="color:#67e8f9;">ü™ê –î–∞–Ω–Ω—ã–µ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞</div>' +
          '<div class="content-text" style="max-height:40vh;overflow-y:auto;white-space:pre-wrap;word-break:break-word;font-size:13px;line-height:1.5;background:#0f0f1b;padding:16px;border-radius:8px;border:1px solid #333;">' + escapeHtml(astroText) + '</div>' +
          (astroJson ? '<details style="margin-top:10px;"><summary style="cursor:pointer;color:#94a3b8;">–ü–æ–∫–∞–∑–∞—Ç—å JSON —Å–Ω–∞–ø—à–æ—Ç–∞</summary><div class="content-text" style="margin-top:8px;max-height:30vh;overflow-y:auto;white-space:pre-wrap;word-break:break-word;font-size:12px;line-height:1.4;background:#0f0f1b;padding:12px;border-radius:8px;border:1px solid #333;">' + escapeHtml(astroJson) + '</div></details>' : '') +
          '</div>'
        : '<div class="details-section"><div class="section-title" style="color:#67e8f9;">ü™ê –î–∞–Ω–Ω—ã–µ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞</div><div class="content-text" style="color:#94a3b8;">–°–Ω–∞–ø—à–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–æ–∑–º–æ–∂–Ω–æ, —Ä–∞—Å—á—ë—Ç –µ—â—ë –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω –∏–ª–∏ –≤ –ë–î –Ω–µ—Ç –∑–∞–ø–∏—Å–∏ –¥–ª—è —ç—Ç–æ–π –∑–∞—è–≤–∫–∏.</div></div>';
      const deepseekFull = (r.deepseek_response || '').trim();
      const genStatus = r.generation_status || r.status || 'pending';
      const genError = (r.error_message || '').trim();
      const dsReason = r.deepseek_missing_reason || '';
      const steps = normalizeSteps(r.generation_steps);
      const stepMap = [
        ['request_loaded', '–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞'],
        ['astro_start', '–°—Ç–∞—Ä—Ç –∞—Å—Ç—Ä–æ–±–ª–æ–∫–∞'],
        ['astro_snapshot_saved', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–Ω–∞–ø—à–æ—Ç–∞'],
        ['astro_extensions', 'D-–∫–∞—Ä—Ç—ã –∏ –î–∞—à–∏'],
        ['couple_second_snapshot', '–í—Ç–æ—Ä–æ–π —Å–Ω–∞–ø—à–æ—Ç (–ø–∞—Ä–∞)'],
        ['prompt_compiled', '–ü—Ä–æ–º—Ç —Å–æ–±—Ä–∞–Ω'],
        ['llm_request_start', '–ó–∞–ø—Ä–æ—Å –≤ DeepSeek'],
        ['llm_response_ready', '–û—Ç–≤–µ—Ç DeepSeek'],
        ['llm_response_saved', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ DeepSeek'],
        ['lyrics_ready', '–õ–∏—Ä–∏–∫–∞ –≥–æ—Ç–æ–≤–∞'],
        ['suno_start', '–°—Ç–∞—Ä—Ç Suno'],
        ['suno_task_created', 'Suno task'],
        ['audio_ready', '–ê—É–¥–∏–æ –≥–æ—Ç–æ–≤–æ'],
        ['cover_start', '–°—Ç–∞—Ä—Ç cover'],
        ['cover_ready', 'Cover —Å—Ç–∞—Ç—É—Å'],
        ['delivery_start', '–°—Ç–∞—Ä—Ç –¥–æ—Å—Ç–∞–≤–∫–∏'],
        ['delivery_done', '–î–æ—Å—Ç–∞–≤–∫–∞'],
        ['pipeline_done', '–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å'],
      ];
      const allStepsBlock = '<div class="details-section" style="margin-bottom:24px;"><div class="section-title" style="color:#fbbf24;">üß≠ –ö–æ–Ω—Ç—Ä–æ–ª—å –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ —Ä–∞—Å—á—ë—Ç–∞</div><div class="content-text" style="font-size:12px;line-height:1.7;">' +
        stepMap.map(function (pair) {
          var k = pair[0], label = pair[1];
          var v = steps[k];
          return '<b>' + escapeHtml(label) + '</b>: ' + (v ? escapeHtml(String(v)) : '<span style="color:#64748b;">‚Äî</span>');
        }).join('<br>') +
        (steps.error ? '<br><br><b style="color:#fca5a5;">–û—à–∏–±–∫–∞</b>: ' + escapeHtml(String(steps.error)) : '') +
        '</div></div>';
      const isTransitMode = r.mode === 'transit' || !!(r.transit_date || r.transit_location || r.transit_intent);
      const transitBlock = isTransitMode
        ? '<div class="details-section" style="margin-bottom:24px;"><div class="section-title" style="color:#f9a8d4;">üåô –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ —Ç—Ä–∞–Ω–∑–∏—Ç–æ–≤ (–≠–Ω–µ—Ä–≥–∏—è –¥–Ω—è)</div>' +
          '<div class="content-text" style="line-height:1.6;">' +
            '–†–µ–∂–∏–º: <b>transit / –≠–Ω–µ—Ä–≥–∏—è –¥–Ω—è</b><br>' +
            '–î–∞—Ç–∞ —Ç—Ä–∞–Ω–∑–∏—Ç–∞: ' + escapeHtml(r.transit_date || '‚Äî') + '<br>' +
            '–í—Ä–µ–º—è —Ç—Ä–∞–Ω–∑–∏—Ç–∞: ' + escapeHtml(r.transit_time || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ') + '<br>' +
            '–õ–æ–∫–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∏—Ç–∞: ' + escapeHtml(r.transit_location || '‚Äî') + '<br>' +
            '–ù–∞–º–µ—Ä–µ–Ω–∏–µ: ' + escapeHtml(r.transit_intent || '‚Äî') + '<br>' +
            '–°—Ç–∞—Ç—É—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + escapeHtml(genStatus || '‚Äî') + '<br>' +
            (steps && Object.keys(steps).length ? ('–õ–æ–≥–∏ —ç—Ç–∞–ø–æ–≤: ' + escapeHtml(JSON.stringify(steps))) : '–õ–æ–≥–∏ —ç—Ç–∞–ø–æ–≤: ‚Äî') +
          '</div></div>'
        : '';
      let deepseekBlock;
      if (deepseekFull) {
        deepseekBlock = '<div class="details-section" style="margin-bottom:24px;"><div class="section-title" style="color:#a78bfa;">ü§ñ –û—Ç–≤–µ—Ç DeepSeek</div>' +
          (r.llm_truncated ? '<div style="color:#f39c12;margin-bottom:8px;font-weight:bold">‚ö†Ô∏è –û—Ç–≤–µ—Ç –æ–±—Ä–µ–∑–∞–Ω –ø–æ –ª–∏–º–∏—Ç—É —Ç–æ–∫–µ–Ω–æ–≤</div>' : '') +
          '<div class="content-text" style="max-height:50vh;overflow-y:auto;white-space:pre-wrap;word-break:break-word;font-size:13px;line-height:1.5;background:#0f0f1b;padding:16px;border-radius:8px;border:1px solid #333;">' + escapeHtml(deepseekFull) + '</div></div>';
      } else if (genStatus === 'failed') {
        deepseekBlock = '<div class="details-section"><div class="section-title">ü§ñ –û—Ç–≤–µ—Ç DeepSeek</div><div class="content-text" style="color:#fca5a5;">–û—Ç–≤–µ—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω. –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + escapeHtml(genError || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div></div>';
      } else {
        const reasonHint = dsReason === 'column_missing_or_old_schema'
          ? '–ü—Ä–∏—á–∏–Ω–∞: –≤ –ë–î –Ω–µ—Ç –Ω—É–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ (–Ω—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è).'
          : (dsReason === 'generation_in_progress'
            ? '–ü—Ä–∏—á–∏–Ω–∞: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –µ—â—ë –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è.'
            : (dsReason === 'completed_without_deepseek_response'
              ? '–ü—Ä–∏—á–∏–Ω–∞: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –Ω–æ raw-–æ—Ç–≤–µ—Ç DeepSeek –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏.'
              : (dsReason === 'not_generated' ? '–ü—Ä–∏—á–∏–Ω–∞: —ç—Ç–∞–ø DeepSeek –µ—â—ë –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è.' : '')));
        deepseekBlock = '<div class="details-section"><div class="section-title">ü§ñ –û—Ç–≤–µ—Ç DeepSeek</div><div class="content-text" style="color:#94a3b8;">–û—Ç–≤–µ—Ç –µ—â—ë –Ω–µ –ø–æ–ª—É—á–µ–Ω. –°—Ç–∞—Ç—É—Å: ' + escapeHtml(genStatus) + '. ' + escapeHtml(reasonHint) + ' –ï—Å–ª–∏ –¥–æ–ª–≥–æ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è, –Ω–∞–∂–º–∏ ¬´–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é¬ª.</div></div>';
      }
      modal.innerHTML = `
        <div style="background:#1a1a2e;border-radius:15px;width:100%;max-width:900px;max-height:90vh;overflow-y:auto;padding:30px;position:relative;">
          <button onclick="this.closest('div').parentElement.remove()" style="position:absolute;top:15px;right:15px;background:#e74c3c;border:none;width:36px;height:36px;border-radius:50%;color:#fff;font-size:24px;cursor:pointer;line-height:1;">√ó</button>
          <h2 style="color:#fff;font-size:24px;margin-bottom:20px;">üìã –ó–∞—è–≤–∫–∞ #${(r.id || '').substring(0,8)}</h2>
          ${transitBlock}
          ${astroBlock}
          ${deepseekBlock}
          ${allStepsBlock}
          <div class="details-section">
            <div class="section-title">üë§ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>
            <div class="content-text">–ò–º—è: ${escapeHtml(r.name || '‚Äî')}<br>–ü–æ–ª: ${escapeHtml(r.gender || '‚Äî')}<br>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: ${escapeHtml(r.birthdate || '‚Äî')}<br>–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è: ${r.birthtime_unknown ? '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' : escapeHtml(r.birthtime || '‚Äî')}<br>–ú–µ—Å—Ç–æ: ${escapeHtml(r.birthplace || '‚Äî')}${r.person2_name ? ('<hr style="border:0;border-top:1px solid #334155;margin:10px 0;">–ü–∞—Ä—Ç–Ω—ë—Ä: ' + escapeHtml(r.person2_name) + '<br>–ü–æ–ª –ø–∞—Ä—Ç–Ω—ë—Ä–∞: ' + escapeHtml(r.person2_gender || '‚Äî') + '<br>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞: ' + escapeHtml(r.person2_birthdate || '‚Äî') + '<br>–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞: ' + (r.person2_birthtime_unknown ? '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' : escapeHtml(r.person2_birthtime || '‚Äî')) + '<br>–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞: ' + escapeHtml(r.person2_birthplace || '‚Äî')) : ''}</div>
          </div>
          ${r.lyrics ? '<div class="details-section"><div class="section-title">üéµ –¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏</div><div class="content-text" style="white-space:pre-wrap;">' + escapeHtml(r.lyrics) + '</div></div>' : ''}
          ${r.audio_url ? '<div class="details-section"><div class="section-title">üîä –ê—É–¥–∏–æ</div><audio class="audio-player" controls src="' + escapeHtml(r.audio_url) + '"></audio><br><a href="' + escapeHtml(r.audio_url) + '" download><button class="btn btn-success" style="width:auto;">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å</button></a></div>' : ''}
          <div class="actions" style="margin-top:30px;">
            <button class="btn btn-warning" onclick="restart(\'' + (r.id || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'") + '\'); this.closest(\'div\').parentElement.remove();">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é</button>
            ${r.audio_url ? '<button class="btn btn-success" onclick="deliver(\'' + (r.id || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'") + '\', this); this.closest(\'div\').parentElement.remove();">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</button>' : ''}
            <button class="btn btn-primary" onclick="this.closest('div').parentElement.remove()">‚úÖ –ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>`;
      document.body.appendChild(modal);
    }

    window.restart = async function restart(id, btnEl) {
      if (!confirm('–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é?')) return;
      if (btnEl) { btnEl.disabled = true; btnEl.textContent = '‚è≥'; }
      try {
        const result = await fetchJson(API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + '/restart' + authQueryFromPath(), { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() } });
        const json = result.json;
        const res = result.res;
        if (json.success) {
          // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä—è–º–æ –≤ —Å—Ç—Ä–æ–∫–µ –±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –≤—Å–µ–≥–æ —Å–ø–∏—Å–∫–∞
          const statusBadge = document.querySelector('#req-row-' + CSS.escape(id) + ' .req-status');
          if (statusBadge) { statusBadge.className = 'req-status status-pending'; statusBadge.textContent = '‚è≥ –í —Ä–∞–±–æ—Ç–µ'; }
          // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—á—ë—Ç—á–∏–∫–∏ –∏ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ
          await refreshAfterAction();
        } else {
          alert('–û—à–∏–±–∫–∞: ' + (json.error || res.status));
          if (btnEl) { btnEl.disabled = false; btnEl.textContent = 'üîÑ'; }
        }
      } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + (e && e.message ? e.message : e));
        if (btnEl) { btnEl.disabled = false; btnEl.textContent = 'üîÑ'; }
      }
    }

    window.markPaid = async function markPaid(id) {
      if (!confirm('–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞—è–≤–∫—É –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—É—é? –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å ¬´–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å¬ª.')) return;
      try {
        const result = await fetchJson(API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + '/mark-paid' + authQueryFromPath(), { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify({ provider: 'admin' }) });
        const json = result.json;
        if (result.res && result.res.ok && json.success) { alert('‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω–∞—è'); refreshAfterAction(); }
        else alert('–û—à–∏–±–∫–∞: ' + (json.error || result.res?.status || 'unknown'));
      } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + (e && e.message ? e.message : e));
      }
    }

    window.deliver = async function deliver(id, btnEl) {
      if (!btnEl) btnEl = document.activeElement;
      const origText = btnEl ? btnEl.textContent : '';
      if (btnEl) { btnEl.disabled = true; btnEl.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶'; }
      try {
        const result = await fetchJson(API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + '/deliver' + authQueryFromPath(), { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() } });
        const json = result.json;
        if (json.success) { alert('‚úÖ –ü–µ—Å–Ω—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é'); }
        else alert('–û—à–∏–±–∫–∞: ' + (json.error || 'unknown'));
      } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + (e && e.message ? e.message : e));
      } finally {
        if (btnEl) { btnEl.disabled = false; btnEl.textContent = origText; }
      }
    }

    window.deleteRequests = async function deleteRequests(ids) {
      if (!ids || !ids.length) return;
      try {
        const result = await fetchJson(
          API_BASE + '/api/admin/requests/delete' + authQueryFromPath(),
          { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify({ ids }) },
          10000
        );
        if (result.json?.success) {
          // –£–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –∏–∑ DOM
          ids.forEach(id => {
            const row = document.getElementById('req-row-' + id);
            if (row) row.remove();
          });
          await refreshAfterAction();
        } else {
          alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (result.json?.error || 'unknown'));
        }
      } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + (e?.message || e));
      }
    };

    // ===== –Ø–ó–´–ö–ò: –ø–æ–∏—Å–∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —è–∑—ã–∫–æ–≤ =====
    let wrongLangIds = [];
    async function findWrongLang() {
      const fromLang = document.getElementById('wlFromLang').value;
      const statusEl = document.getElementById('wlStatus');
      const resultEl = document.getElementById('wrongLangResult');
      const listEl = document.getElementById('wrongLangList');
      statusEl.textContent = '–ò—â—É‚Ä¶';
      resultEl.style.display = 'none';
      try {
        const result = await fetchJson(API_BASE + '/api/admin/wrong-language?from_lang=' + fromLang + '&to_lang=uk' + authQuery(), { headers: authHeaders() });
        const data = result.json;
        if (!data.success) { statusEl.textContent = '–û—à–∏–±–∫–∞: ' + (data.error || 'unknown'); return; }
        wrongLangIds = (data.rows || []).map(row => row.id);
        if (!data.count) {
          statusEl.textContent = '–ó–∞—è–≤–æ–∫ —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —è–∑—ã–∫–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.';
          resultEl.style.display = 'none';
          return;
        }
        listEl.innerHTML = (data.rows || []).map(row =>
          `<div style="padding:6px 10px;border-bottom:1px solid #2d3748;font-size:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <span style="color:#94a3b8;font-family:monospace">${escapeHtml(row.id.slice(0,8))}</span>
            <span style="color:#e2e8f0">${escapeHtml(row.name||'‚Äî')}</span>
            <span style="background:#e67e22;color:#fff;border-radius:4px;padding:1px 6px;font-size:11px;">${escapeHtml(row.language)}</span>
            <span style="color:#64748b;font-size:11px;">${escapeHtml(row.generation_status)}</span>
            <span style="color:#64748b;font-size:11px;">ID: ${escapeHtml(String(row.telegram_user_id))}</span>
          </div>`
        ).join('');
        resultEl.style.display = 'block';
        statusEl.textContent = `–ù–∞–π–¥–µ–Ω–æ: ${data.count} –∑–∞—è–≤–æ–∫`;
      } catch(e) { statusEl.textContent = '–û—à–∏–±–∫–∞: ' + (e.message || e); }
    }

    async function requeueWrongLang() {
      if (!wrongLangIds.length) { alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞–π—Ç–∏¬ª'); return; }
      const toLang = document.getElementById('wlToLang').value;
      const statusEl = document.getElementById('wlStatus');
      if (!confirm(`–ü–æ—Å—Ç–∞–≤–∏—Ç—å ${wrongLangIds.length} –∑–∞—è–≤–æ–∫ –≤ –æ—á–µ—Ä–µ–¥—å —Å —è–∑—ã–∫–æ–º ¬´${toLang}¬ª? –≠—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç –ø–æ–≤—Ç–æ—Ä–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é.`)) return;
      statusEl.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è—é‚Ä¶';
      try {
        const result = await fetchJson(API_BASE + '/api/admin/requeue-wrong-language' + authQueryFromPath(), {
          method: 'POST', headers: {'Content-Type':'application/json', ...authHeaders()},
          body: JSON.stringify({ ids: wrongLangIds, to_lang: toLang })
        });
        const data = result.json;
        if (!data.success) { statusEl.textContent = '–û—à–∏–±–∫–∞: ' + (data.error || 'unknown'); return; }
        statusEl.textContent = `‚úÖ –ü–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ –æ—á–µ—Ä–µ–¥—å: ${data.requeued} –∑–∞—è–≤–æ–∫ —Å —è–∑—ã–∫–æ–º ¬´${data.language}¬ª`;
        wrongLangIds = [];
        document.getElementById('wrongLangResult').style.display = 'none';
      } catch(e) { statusEl.textContent = '–û—à–∏–±–∫–∞: ' + (e.message || e); }
    }

    // ===== –Ø–ó–´–ö–ò: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ delivery_failed –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π =====
    async function notifyDeliveryFailed() {
      const statusEl = document.getElementById('notifyStatus');
      if (!confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å delivery_failed? –ö–∞–∂–¥—ã–π –ø–æ–ª—É—á–∏—Ç 1 —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Å–≤–æ—ë–º —è–∑—ã–∫–µ.')) return;
      statusEl.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è—é‚Ä¶';
      try {
        const result = await fetchJson(API_BASE + '/api/admin/notify-delivery-failed' + authQueryFromPath(), {
          method: 'POST', headers: {'Content-Type':'application/json', ...authHeaders()},
          body: JSON.stringify({})
        });
        const data = result.json;
        if (!data.success) { statusEl.textContent = '–û—à–∏–±–∫–∞: ' + (data.error || 'unknown'); return; }
        statusEl.textContent = `‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${data.users} ¬∑ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${data.sent} ¬∑ –û—à–∏–±–æ–∫: ${data.failed}`;
      } catch(e) { statusEl.textContent = '–û—à–∏–±–∫–∞: ' + (e.message || e); }
    }

    // ‚îÄ‚îÄ‚îÄ –†—É—á–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function grantSubCheck() {
      const userId = document.getElementById('grantSubUserId').value.trim();
      const msgEl = document.getElementById('grantSubMsg');
      const infoEl = document.getElementById('grantSubInfo');
      if (!userId) { msgEl.textContent = '‚ö†Ô∏è –í–≤–µ–¥–∏ telegram_user_id'; msgEl.style.color = '#f59e0b'; return; }
      msgEl.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é‚Ä¶'; msgEl.style.color = '#94a3b8';
      infoEl.innerHTML = '';
      try {
        const resp = await fetch(API_BASE + '/api/admin/user-subscription?telegram_user_id=' + encodeURIComponent(userId) + '&token=' + encodeURIComponent(getToken() || ''));
        const json = await resp.json();
        if (!json.success) { msgEl.textContent = '‚ùå ' + json.error; msgEl.style.color = '#ef4444'; return; }
        const sub = json.active_subscription;
        const reqs = json.recent_sub_requests || [];
        let html = '';
        if (sub) {
          html += '<div style="color:#22c55e;margin-bottom:6px;">‚úÖ –ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞: <strong>' + escapeHtml(sub.plan_sku) + '</strong> –¥–æ ' + new Date(sub.renew_at).toLocaleDateString('ru-RU') + '</div>';
        } else {
          html += '<div style="color:#f59e0b;margin-bottom:6px;">‚ö†Ô∏è –ê–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ—Ç</div>';
        }
        if (reqs.length) {
          html += '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
          html += '<tr style="color:#94a3b8"><td>–ó–∞—è–≤–∫–∞</td><td>–†–µ–∂–∏–º</td><td>–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã</td><td>–°–æ–∑–¥–∞–Ω–∞</td></tr>';
          reqs.forEach(function(r) {
            var color = r.payment_status === 'paid' ? '#22c55e' : '#f59e0b';
            html += '<tr><td style="color:#94a3b8">' + escapeHtml(r.id.slice(0,8)) + '‚Ä¶</td><td>' + escapeHtml(r.mode) + '</td><td style="color:' + color + '">' + escapeHtml(r.payment_status || '‚Äî') + '</td><td>' + new Date(r.created_at).toLocaleString('ru-RU') + '</td></tr>';
          });
          html += '</table>';
        } else {
          html += '<div>–ó–∞—è–≤–æ–∫ –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É –Ω–µ—Ç</div>';
        }
        infoEl.innerHTML = html;
        msgEl.textContent = ''; 
      } catch(e) { msgEl.textContent = '–û—à–∏–±–∫–∞: ' + e.message; msgEl.style.color = '#ef4444'; }
    }

    async function grantSubActivate() {
      const userId = document.getElementById('grantSubUserId').value.trim();
      const planKey = document.getElementById('grantSubPlan').value;
      const msgEl = document.getElementById('grantSubMsg');
      if (!userId) { msgEl.textContent = '‚ö†Ô∏è –í–≤–µ–¥–∏ telegram_user_id'; msgEl.style.color = '#f59e0b'; return; }
      if (!confirm('–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å ' + planKey + ' –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ' + userId + '?')) return;
      msgEl.textContent = '‚è≥ –ê–∫—Ç–∏–≤–∏—Ä—É—é‚Ä¶'; msgEl.style.color = '#94a3b8';
      try {
        const resp = await fetch(API_BASE + '/api/admin/grant-subscription', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-admin-token': getToken() || '' },
          body: JSON.stringify({ telegram_user_id: Number(userId), plan_key: planKey })
        });
        const json = await resp.json();
        if (json.success) {
          msgEl.textContent = json.already_active
            ? '‚úì –ü–æ–¥–ø–∏—Å–∫–∞ ' + json.sku + ' —É–∂–µ –±—ã–ª–∞ –∞–∫—Ç–∏–≤–Ω–∞'
            : 'üéâ –ü–æ–¥–ø–∏—Å–∫–∞ ' + json.sku + ' –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞! –î–æ ' + (json.renew_at ? new Date(json.renew_at).toLocaleDateString('ru-RU') : '?');
          msgEl.style.color = '#22c55e';
          grantSubCheck();
        } else {
          msgEl.textContent = '‚ùå ' + (json.error || '–û—à–∏–±–∫–∞'); msgEl.style.color = '#ef4444';
        }
      } catch(e) { msgEl.textContent = '–û—à–∏–±–∫–∞: ' + e.message; msgEl.style.color = '#ef4444'; }
    }

    document.addEventListener('DOMContentLoaded', function() {
      var checkBtn = document.getElementById('grantSubCheckBtn');
      var grantBtn = document.getElementById('grantSubBtn');
      if (checkBtn) checkBtn.addEventListener('click', grantSubCheck);
      if (grantBtn) grantBtn.addEventListener('click', grantSubActivate);

      loadAdminData().catch(function(e) {
        setLoadingStatus(false);
        const msg = (e && e.message) ? e.message : String(e);
        const isTimeout = msg && msg.includes('–Ω–µ –æ—Ç–≤–µ—Ç–∏–ª');
        const el = document.getElementById('requests');
        if (el) el.innerHTML = '<div style="text-align:center;padding:40px;color:#e74c3c">‚ùå ' + escapeHtml(msg) + (isTimeout ? '<br><span style="color:#94a3b8;font-size:13px">Render –º–æ–≥ —É—Å–Ω—É—Ç—å ‚Äî –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 30 —Å–µ–∫</span>' : '') + '<br><br><button onclick="window.location.reload()" style="margin-top:12px;padding:10px 24px;background:#667eea;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:15px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button><br><br><span style="font-size:12px;color:#64748b">API: ' + escapeHtml(window.API_BASE || window.location.origin) + '</span></div>';
      });
    });
  </script>
</body>
</html>
