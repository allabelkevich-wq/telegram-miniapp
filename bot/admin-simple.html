<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>ğŸ‘‘ ĞĞ´Ğ¼Ğ¸Ğ½ĞºĞ° Yup Soul â€” ĞšĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸</title>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0f0f1b; color: #fff; font-family: 'Comfortaa', system-ui, sans-serif; padding: 20px; line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; margin-bottom: 30px; text-align: center; }
    .header h1 { font-size: 32px; font-weight: bold; margin-bottom: 10px; }
    .header p { opacity: 0.9; font-size: 16px; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: #1a1a2e; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #667eea; cursor: pointer; transition: all 0.2s; user-select: none; }
    .stat-card:hover { background: #232340; transform: translateY(-2px); box-shadow: 0 6px 18px rgba(102,126,234,0.2); }
    .stat-card.active-filter { box-shadow: 0 0 0 2px #667eea; background: #232350; }
    .stat-card.pending { border-left-color: #f39c12; }
    .stat-card.pending:hover, .stat-card.pending.active-filter { box-shadow: 0 0 0 2px #f39c12; }
    .stat-card.completed { border-left-color: #27ae60; }
    .stat-card.completed:hover, .stat-card.completed.active-filter { box-shadow: 0 0 0 2px #27ae60; }
    .stat-card.failed { border-left-color: #e74c3c; }
    .stat-card.failed:hover, .stat-card.failed.active-filter { box-shadow: 0 0 0 2px #e74c3c; }
    .stat-number { font-size: 42px; font-weight: bold; margin: 10px 0; }
    .stat-label { font-size: 14px; opacity: 0.9; }
    .sort-bar { background: #1a1a2e; padding: 12px 15px; border-radius: 10px; margin-bottom: 16px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .sort-bar span { font-size: 13px; color: #94a3b8; margin-right: 4px; }
    .sort-btn { padding: 6px 14px; background: #2d3748; border: 1px solid #4a5568; color: #cbd5e1; border-radius: 6px; cursor: pointer; font-size: 13px; font-family: inherit; transition: all 0.15s; }
    .sort-btn:hover { background: #4a5568; }
    .sort-btn.active { background: linear-gradient(135deg,#667eea,#764ba2); border-color: #667eea; color: #fff; }
    .pay-badge { display:inline-block; padding: 2px 8px; border-radius: 5px; font-size: 11px; font-weight: 600; margin-left: 4px; }
    .pay-badge-gift { background: rgba(139,92,246,.25); color: #c4b5fd; }
    .pay-badge-promo { background: rgba(212,175,55,.2); color: #fde68a; }
    .pay-badge-hot { background: rgba(59,130,246,.2); color: #93c5fd; }
    .pay-badge-sub { background: rgba(16,185,129,.2); color: #6ee7b7; }
    .pay-badge-free { background: rgba(34,197,94,.2); color: #86efac; }
    .filters { background: #1a1a2e; padding: 15px; border-radius: 12px; margin-bottom: 30px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .filter-btn { padding: 10px 20px; background: #2d3748; border: 2px solid #4a5568; color: #fff; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
    .filter-btn:hover { background: #4a5568; transform: translateY(-1px); }
    .filter-btn.active { background: linear-gradient(135deg, #667eea, #764ba2); border-color: #667eea; }
    .request-card { background: #1a1a2e; border-radius: 12px; padding: 25px; margin-bottom: 25px; border: 2px solid #2d3748; transition: all 0.3s; }
    .request-card:hover { border-color: #667eea; transform: translateY(-2px); }
    .request-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #2d3748; }
    .request-name { font-size: 22px; font-weight: bold; }
    .request-id { font-size: 13px; color: #94a3b8; margin-top: 5px; font-family: monospace; }
    .request-status { padding: 8px 20px; border-radius: 20px; font-weight: bold; min-width: 140px; text-align: center; }
    .status-pending { background: #f39c12; color: #000; }
    .status-completed { background: #27ae60; color: #fff; }
    .status-failed { background: #e74c3c; color: #fff; }
    .status-payment { background: #8b5cf6; color: #fff; }
    .status-cancelled { background: #475569; color: #fff; }
    .progress-container { background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 10px; margin: 25px 0; }
    .progress-title { text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #667eea; }
    .progress-steps { display: flex; justify-content: space-between; position: relative; margin-bottom: 30px; }
    .progress-steps::before { content: ''; position: absolute; top: 20px; left: 15px; right: 15px; height: 4px; background: #2d3748; z-index: 1; }
    .step { text-align: center; position: relative; z-index: 2; width: 80px; }
    .step-circle { width: 40px; height: 40px; border-radius: 50%; background: #2d3748; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold; border: 3px solid #2d3748; transition: all 0.3s; }
    .step-label { font-size: 12px; color: #94a3b8; font-weight: 500; }
    .step.done .step-circle { background: #27ae60; border-color: #27ae60; color: #fff; }
    .step.current .step-circle { background: #667eea; border-color: #667eea; color: #fff; transform: scale(1.1); }
    .step-label.ru { display: block; font-size: 13px; color: #fff; margin-top: 4px; }
    .step-label.en { display: block; font-size: 11px; color: #94a3b8; }
    .step-log { font-size: 11px; color: #64748b; margin-top: 4px; max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .step.done .step-log { color: #86efac; }
    .actions { display: flex; gap: 12px; margin-top: 25px; flex-wrap: wrap; }
    .btn { padding: 12px 25px; border: none; border-radius: 8px; color: #fff; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; min-width: 160px; justify-content: center; }
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); }
    .btn-success { background: linear-gradient(135deg, #27ae60, #2ecc71); }
    .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); color: #000; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.3); }
    .details-section { margin: 25px 0; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 8px; }
    .section-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #667eea; display: flex; align-items: center; gap: 10px; }
    .content-text { font-size: 14px; line-height: 1.7; white-space: pre-wrap; max-height: 250px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; }
    .audio-player { width: 100%; margin: 15px 0; }
    .loading { text-align: center; padding: 50px; color: #94a3b8; }
    .spinner { width: 40px; height: 40px; border: 4px solid rgba(102,126,234,0.3); border-top-color: #667eea; border-radius: 50%; margin: 0 auto 15px; animation: spin 1s linear infinite; }
    .mono-panel { margin-bottom: 22px; padding: 16px; border-radius: 10px; border: 1px solid #334155; background: rgba(15, 23, 42, 0.5); }
    .mono-panel h3 { margin: 0 0 10px 0; color: #c4b5fd; font-size: 16px; }
    .mono-table-wrap { overflow-x: auto; border-radius: 8px; border: 1px solid #334155; }
    .mono-table { width: 100%; border-collapse: collapse; min-width: 860px; }
    .mono-table th, .mono-table td { border-bottom: 1px solid #334155; padding: 8px; font-size: 12px; vertical-align: middle; }
    .mono-table th { background: rgba(30, 41, 59, 0.7); color: #cbd5e1; text-align: left; }
    .mono-table td input, .mono-table td select { width: 100%; background: #0f172a; color: #fff; border: 1px solid #475569; border-radius: 6px; padding: 6px 8px; font-size: 12px; }
    .mono-table td input[type="checkbox"] { width: auto; transform: scale(1.05); }
    .mono-muted { color: #94a3b8; font-size: 12px; }
    .mono-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .mono-msg { margin-top: 8px; font-size: 12px; min-height: 18px; }
    /* Ğ¡ĞµĞºÑ†Ğ¸Ñ Ğ½ĞµĞ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ñ… Ğ·Ğ°ÑĞ²Ğ¾Ğº */
    .unpaid-section { background: rgba(139,92,246,0.08); border: 2px solid #8b5cf6; border-radius: 14px; padding: 20px 24px; margin-bottom: 28px; display: none; }
    .unpaid-section.has-items { display: block; }
    .unpaid-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .unpaid-section-title { font-size: 18px; font-weight: bold; color: #c4b5fd; display: flex; align-items: center; gap: 10px; }
    .unpaid-badge { background: #8b5cf6; color: #fff; border-radius: 20px; padding: 2px 12px; font-size: 14px; font-weight: bold; }
    .unpaid-card { background: #1a1a2e; border: 1px solid #4c1d95; border-radius: 10px; padding: 14px 18px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; }
    .unpaid-card:last-child { margin-bottom: 0; }
    .unpaid-info { flex: 1; }
    .unpaid-name { font-size: 16px; font-weight: bold; margin-bottom: 4px; }
    .unpaid-meta { font-size: 12px; color: #94a3b8; line-height: 1.6; }
    .unpaid-actions { display: flex; gap: 8px; flex-shrink: 0; flex-direction: column; }
    .btn-cancel { background: linear-gradient(135deg, #e74c3c, #c0392b); min-width: 120px; }
    .btn-restore { background: linear-gradient(135deg, #059669, #10b981); min-width: 120px; }
    .pay-filter-bar { background: #1a1a2e; padding: 10px 15px; border-radius: 10px; margin-bottom: 16px; display: flex; gap: 7px; flex-wrap: wrap; align-items: center; border: 1px solid rgba(212,175,55,0.15); }
    .pay-filter-bar span { font-size: 12px; color: #d4af37; margin-right: 4px; font-weight: 600; }
    .pay-filter-btn { padding: 5px 13px; background: #2d3748; border: 1px solid #4a5568; color: #cbd5e1; border-radius: 6px; cursor: pointer; font-size: 12px; font-family: inherit; transition: all 0.15s; }
    .pay-filter-btn:hover { background: #4a5568; }
    .pay-filter-btn.active { background: linear-gradient(135deg,#d4af37,#ec4899); border-color: #d4af37; color: #fff; font-weight: 700; }
    .bulk-actions-bar { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; padding: 12px 16px; margin-bottom: 16px; background: #1a1a2e; border-radius: 10px; border: 1px solid #334155; }
    .bulk-actions-bar label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #cbd5e1; user-select: none; }
    .bulk-actions-bar input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .bulk-actions-bar .btn { min-width: auto; padding: 10px 20px; }
    .request-card .req-select-wrap { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; }
    .request-card .req-select-wrap input[type="checkbox"] { margin-top: 4px; width: 18px; height: 18px; cursor: pointer; flex-shrink: 0; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* â”€â”€ Tab navigation â”€â”€ */
    .admin-tabs { display:flex; gap:4px; margin-bottom:18px; background:#0a0a16; padding:5px; border-radius:12px; border:1px solid #1e293b; flex-wrap:wrap; }
    .tab-btn { flex:1; min-width:110px; padding:9px 14px; background:transparent; border:none; color:#64748b; font-size:13px; font-weight:600; cursor:pointer; border-radius:8px; transition:all 0.18s; font-family:inherit; white-space:nowrap; text-align:center; }
    .tab-btn:hover { background:#1e293b; color:#cbd5e1; }
    .tab-btn.active { background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; box-shadow:0 2px 8px rgba(102,126,234,0.35); }
    .tab-pane { display:none; }
    .tab-pane.active { display:block; }
    /* â”€â”€ Unified filter bar â”€â”€ */
    .unified-filter { background:#1a1a2e; border-radius:10px; padding:10px 14px; margin-bottom:12px; border:1px solid #2d3748; }
    .uf-row { display:flex; gap:6px; flex-wrap:wrap; align-items:center; margin-bottom:6px; }
    .uf-row:last-child { margin-bottom:0; }
    .uf-label { font-size:11px; color:#64748b; font-weight:600; min-width:60px; }
    .uf-btn { padding:4px 11px; background:#2d3748; border:1px solid #374151; color:#94a3b8; border-radius:6px; cursor:pointer; font-size:11px; font-family:inherit; transition:all 0.12s; white-space:nowrap; }
    .uf-btn:hover { background:#374151; color:#e2e8f0; }
    .uf-btn.active { background:linear-gradient(135deg,#667eea,#764ba2); border-color:#667eea; color:#fff; font-weight:700; }
    .uf-btn.active-gold { background:linear-gradient(135deg,#d4af37,#ec4899); border-color:#d4af37; color:#fff; font-weight:700; }
    /* â”€â”€ Compact accordion request rows â”€â”€ */
    .req-row { background:#1a1a2e; border-radius:9px; margin-bottom:5px; border:1px solid #2d3748; overflow:hidden; transition:border-color 0.15s; }
    .req-row:hover .req-row-head { background:rgba(255,255,255,0.02); }
    .req-row.expanded { border-color:#667eea; }
    .req-row-head { display:flex; align-items:center; gap:10px; padding:10px 13px; cursor:pointer; user-select:none; }
    .req-row-main { flex:1; min-width:0; }
    .req-row-name { font-size:13px; font-weight:700; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px; }
    .req-row-meta { font-size:10px; color:#64748b; display:block; margin-top:1px; }
    .req-row-status { padding:3px 9px; border-radius:12px; font-size:10px; font-weight:700; white-space:nowrap; flex-shrink:0; }
    .req-row-btns { display:flex; gap:5px; flex-shrink:0; flex-wrap:wrap; }
    .rmb { padding:4px 9px; border-radius:5px; font-size:11px; font-weight:600; cursor:pointer; font-family:inherit; white-space:nowrap; border:1px solid transparent; transition:opacity 0.15s; line-height:1.4; }
    .rmb:hover { opacity:0.8; }
    .rmb-blue { background:rgba(102,126,234,0.2); color:#a5b4fc; border-color:rgba(102,126,234,0.3); }
    .rmb-green { background:rgba(39,174,96,0.2); color:#86efac; border-color:rgba(39,174,96,0.3); }
    .rmb-orange { background:rgba(243,156,18,0.2); color:#fcd34d; border-color:rgba(243,156,18,0.25); }
    .rmb-red { background:rgba(231,76,60,0.18); color:#fca5a5; border-color:rgba(231,76,60,0.25); }
    .rmb-purple { background:rgba(139,92,246,0.18); color:#c4b5fd; border-color:rgba(139,92,246,0.25); }
    .req-chevron { font-size:14px; color:#475569; transition:transform 0.18s; flex-shrink:0; width:16px; text-align:center; }
    .req-row.expanded .req-chevron { transform:rotate(90deg); color:#a5b4fc; }
    .req-row-body { display:none; border-top:1px solid #2d3748; padding:14px 14px 12px; }
    .req-row-body .progress-container { margin:0 0 14px 0; }
    .req-row-body .details-section { margin:10px 0 0 0; padding:12px; }
    .req-row-body .actions { margin-top:14px; }
    .detail-section-inline { background:rgba(255,255,255,0.025); border:1px solid #1e293b; border-radius:8px; overflow:hidden; }
    .dsi-title { font-size:11px; font-weight:700; color:#94a3b8; padding:7px 12px; background:rgba(0,0,0,0.2); border-bottom:1px solid #1e293b; letter-spacing:0.3px; text-transform:uppercase; }
    .dsi-body { padding:10px 12px; font-size:12px; }
    @media (max-width: 768px) {
      .header h1 { font-size: 26px; }
      .stat-number { font-size: 36px; }
      .progress-steps { flex-wrap: wrap; }
      .step { width: 100%; margin-bottom: 20px; }
      .actions { flex-direction: column; }
      .btn { width: 100%; min-width: auto; }
      .req-row-name { max-width: 130px; }
      .req-row-btns { display:none; }
      .req-row.expanded .req-row-btns { display:flex; }
    }
  </style>
</head>
<body style="background:#0f0f1b;color:#fff;font-family:'Comfortaa',system-ui,sans-serif;">
  <div class="container">
    <div class="header">
      <h1>ğŸ‘‘ ĞĞ”ĞœĞ˜ĞĞšĞ YUP SOUL</h1>
      <p>ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ·Ğ²ÑƒĞºĞ¾Ğ²Ñ‹Ñ… ĞºĞ»ÑÑ‡ĞµĞ¹ / Full control of sound key generation</p>
      <p style="font-size:11px;color:#475569;margin-top:4px;">build: 20260219-2</p>
      <p id="url-info" style="font-size:12px;color:#64748b;margin-top:8px;word-break:break-all;"></p>
      <div id="loadingStatus" style="display:none;margin-top:10px;padding:8px 14px;background:rgba(102,126,234,0.12);border:1px solid rgba(102,126,234,0.3);border-radius:8px;font-size:13px;color:#a5b4fc;align-items:center;gap:8px;">
        <span style="display:inline-block;width:14px;height:14px;border:2px solid rgba(102,126,234,0.3);border-top-color:#667eea;border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0;"></span>
        <span id="loadingStatusText">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…â€¦</span>
      </div>
    </div>
    <div class="stats">
      <div class="stat-card active-filter" data-filter="all" onclick="filterByCard(this)" title="ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ğ·Ğ°ÑĞ²ĞºĞ¸">
        <div class="stat-label">ğŸ“‹ Ğ’ÑĞµĞ³Ğ¾ / Total</div>
        <div class="stat-number" id="total">-</div>
        <div style="font-size:11px;color:#64748b;margin-top:4px;">Ğ½Ğ°Ğ¶Ğ¼Ğ¸ â†’ ÑĞ¿Ğ¸ÑĞ¾Ğº</div>
      </div>
      <div class="stat-card pending" data-filter="pending" onclick="filterByCard(this)" title="ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ·Ğ°ÑĞ²ĞºĞ¸ Ğ² Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ">
        <div class="stat-label">â³ Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ</div>
        <div class="stat-number" id="pending">-</div>
        <div style="font-size:11px;color:#64748b;margin-top:4px;">Ğ½Ğ°Ğ¶Ğ¼Ğ¸ â†’ ÑĞ¿Ğ¸ÑĞ¾Ğº</div>
      </div>
      <div class="stat-card completed" data-filter="completed" onclick="filterByCard(this)" title="ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ğµ">
        <div class="stat-label">âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾</div>
        <div class="stat-number" id="completed">-</div>
        <div style="font-size:11px;color:#64748b;margin-top:4px;">Ğ½Ğ°Ğ¶Ğ¼Ğ¸ â†’ ÑĞ¿Ğ¸ÑĞ¾Ğº</div>
      </div>
      <div class="stat-card failed" data-filter="failed" onclick="filterByCard(this)" title="ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ğ¼Ğ¸">
        <div class="stat-label">âŒ ĞÑˆĞ¸Ğ±ĞºĞ¸</div>
        <div class="stat-number" id="failed">-</div>
        <div style="font-size:11px;color:#64748b;margin-top:4px;">Ğ½Ğ°Ğ¶Ğ¼Ğ¸ â†’ ÑĞ¿Ğ¸ÑĞ¾Ğº</div>
      </div>
      <div class="stat-card" style="border-left-color:#8b5cf6;" data-filter="pending_payment" onclick="filterByCard(this)" title="ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¾Ğ¶Ğ¸Ğ´Ğ°ÑÑ‰Ğ¸Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹">
        <div class="stat-label">ğŸ’³ ĞĞ¶Ğ¸Ğ´Ğ°ÑÑ‚ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹</div>
        <div class="stat-number" id="stat-pending-payment">-</div>
        <div style="font-size:11px;color:#64748b;margin-top:4px;">Ğ½Ğ°Ğ¶Ğ¼Ğ¸ â†’ ÑĞ¿Ğ¸ÑĞ¾Ğº</div>
      </div>
      <div class="stat-card" style="border-left-color:#475569;" data-filter="cancelled" onclick="filterByCard(this)" title="ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‘Ğ½Ğ½Ñ‹Ğµ">
        <div class="stat-label">ğŸš« ĞÑ‚Ğ¼ĞµĞ½Ñ‘Ğ½Ğ½Ñ‹Ğµ</div>
        <div class="stat-number" id="stat-cancelled">-</div>
        <div style="font-size:11px;color:#64748b;margin-top:4px;">Ğ½Ğ°Ğ¶Ğ¼Ğ¸ â†’ ÑĞ¿Ğ¸ÑĞ¾Ğº</div>
      </div>
    </div>
    <!-- Tab navigation -->
    <div class="admin-tabs">
      <button class="tab-btn active" onclick="switchTab('requests', this)">ğŸ“‹ Ğ—Ğ°ÑĞ²ĞºĞ¸</button>
      <button class="tab-btn" onclick="switchTab('monetization', this)">ğŸ’³ ĞœĞ¾Ğ½ĞµÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ</button>
      <button class="tab-btn" onclick="switchTab('settings', this)">âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</button>
      <button class="tab-btn" onclick="switchTab('referrals', this)">ğŸ”— Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹</button>
    </div>

    <!-- Tab: Ğ—Ğ°ÑĞ²ĞºĞ¸ -->
    <div class="tab-pane active" id="tab-requests">
      <!-- ĞĞµĞ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°ÑĞ²ĞºĞ¸ -->
      <div class="unpaid-section" id="unpaidSection">
        <div class="unpaid-section-header">
          <div class="unpaid-section-title">
            âš ï¸ ĞĞµĞ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°ÑĞ²ĞºĞ¸
            <span class="unpaid-badge" id="unpaidBadge">0</span>
          </div>
          <button class="btn btn-primary" style="min-width:120px;padding:8px 14px;font-size:12px;" onclick="loadUnpaidRequests()">ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ</button>
        </div>
        <p style="font-size:12px;color:#94a3b8;margin-bottom:10px;">Ğ‘ĞµĞ· Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹, Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ğ¸Ğ»Ğ¸ Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°. Ğ‘Ğ¾Ñ‚Ñƒ ÑƒĞ¶Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ.</p>
        <div id="unpaidList"><div class="loading"><div class="spinner"></div>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦</div></div>
      </div>

      <!-- Ğ•Ğ´Ğ¸Ğ½Ğ°Ñ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ² -->
      <div class="unified-filter">
        <div class="uf-row">
          <span class="uf-label">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:</span>
          <button class="uf-btn filter-btn active" data-filter="all">ğŸ“‹ Ğ’ÑĞµ</button>
          <button class="uf-btn filter-btn" data-filter="pending">â³ Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ</button>
          <button class="uf-btn filter-btn" data-filter="pending_payment">ğŸ’³ ĞĞ¿Ğ»Ğ°Ñ‚Ğ°</button>
          <button class="uf-btn filter-btn" data-filter="completed">âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾</button>
          <button class="uf-btn filter-btn" data-filter="failed">âŒ ĞÑˆĞ¸Ğ±ĞºĞ¸</button>
          <button class="uf-btn filter-btn" data-filter="cancelled">ğŸš« ĞÑ‚Ğ¼ĞµĞ½Ñ‘Ğ½Ğ½Ñ‹Ğµ</button>
        </div>
        <div class="uf-row">
          <span class="uf-label">ĞĞ¿Ğ»Ğ°Ñ‚Ğ°:</span>
          <button class="uf-btn pay-filter-btn active" data-pay="all" onclick="setPayFilter(this)">Ğ’ÑĞµ</button>
          <button class="uf-btn pay-filter-btn" data-pay="gift" onclick="setPayFilter(this)">ğŸ ĞŸĞ¾Ğ´Ğ°Ñ€Ğ¾Ğº</button>
          <button class="uf-btn pay-filter-btn" data-pay="promo" onclick="setPayFilter(this)">ğŸ· ĞŸÑ€Ğ¾Ğ¼Ğ¾</button>
          <button class="uf-btn pay-filter-btn" data-pay="hot" onclick="setPayFilter(this)">ğŸ’³ HOT</button>
          <button class="uf-btn pay-filter-btn" data-pay="subscription" onclick="setPayFilter(this)">ğŸ“‹ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°</button>
          <button class="uf-btn pay-filter-btn" data-pay="awaiting" onclick="setPayFilter(this)">â³ ĞĞ¶Ğ¸Ğ´Ğ°ĞµÑ‚</button>
          <button class="uf-btn pay-filter-btn" data-pay="admin" onclick="setPayFilter(this)">ğŸ”§ Ğ ÑƒÑ‡Ğ½Ğ°Ñ</button>
        </div>
        <div class="uf-row">
          <span class="uf-label">ĞŸĞ¾Ñ€ÑĞ´Ğ¾Ğº:</span>
          <button class="uf-btn sort-btn active" data-sort="date_desc" onclick="setSort(this)">ğŸ• ĞĞ¾Ğ²Ñ‹Ğµ</button>
          <button class="uf-btn sort-btn" data-sort="date_asc" onclick="setSort(this)">ğŸ• Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğµ</button>
          <button class="uf-btn sort-btn" data-sort="name_asc" onclick="setSort(this)">ğŸ‘¤ Ğâ€“Ğ¯</button>
          <button class="uf-btn sort-btn" data-sort="status" onclick="setSort(this)">ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</button>
          <button class="uf-btn sort-btn" data-sort="payment" onclick="setSort(this)">ğŸ’³ ĞĞ¿Ğ»Ğ°Ñ‚Ğ°</button>
        </div>
      </div>

      <!-- Bulk actions -->
      <div class="bulk-actions-bar" id="bulkActionsBar" style="display:none;">
        <label><input type="checkbox" id="selectAllRequests" aria-label="Ğ’Ñ‹Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ·Ğ°ÑĞ²ĞºĞ¸"> Ğ’Ñ‹Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ</label>
        <button type="button" class="btn btn-warning" id="deleteSelectedBtn" disabled>ğŸ—‘ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ (<span id="deleteSelectedCount">0</span>)</button>
      </div>

      <!-- Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°ÑĞ²Ğ¾Ğº -->
      <div id="requests" class="loading">
        <div class="spinner"></div>
        <div>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
      </div>
    </div>

    <!-- Tab: ĞœĞ¾Ğ½ĞµÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ -->
    <div class="tab-pane" id="tab-monetization">
      <div class="details-section" style="margin-bottom:20px;">
        <div class="section-title">ğŸ’³ ĞœĞ¾Ğ½ĞµÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ HOT</div>
        <p class="mono-muted">Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ°Ğ¼Ğ¸, Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°Ğ¼Ğ¸ Ğ¸ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ² Ğ¾Ğ¿Ğ»Ğ°Ñ‚.</p>
        <div class="mono-actions">
          <button type="button" class="btn btn-primary" id="monetization-refresh-btn" style="min-width:180px;">ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¼Ğ¾Ğ½ĞµÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ</button>
        </div>
        <div id="monetizationGlobalMsg" class="mono-msg"></div>
        <div class="mono-panel">
          <h3>Ğ¢Ğ°Ñ€Ğ¸Ñ„Ñ‹ (pricing_catalog)</h3>
          <div class="mono-table-wrap">
            <table class="mono-table" id="pricingTable">
              <thead><tr><th>SKU</th><th>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</th><th>Ğ¦ĞµĞ½Ğ°</th><th>Ğ’Ğ°Ğ»ÑÑ‚Ğ°</th><th>ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½</th><th>Ğ›Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹ JSON</th><th>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ</th></tr></thead>
              <tbody id="pricingTableBody"><tr><td colspan="7" class="mono-muted">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦</td></tr></tbody>
            </table>
          </div>
          <div id="pricingMsg" class="mono-msg"></div>
        </div>
        <div class="mono-panel">
          <h3>ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ (promo_codes)</h3>
          <details id="newPromoDetails" style="margin-bottom:18px;border:1px solid rgba(212,175,55,0.3);border-radius:10px;padding:12px 16px;background:rgba(212,175,55,0.05);">
            <summary style="cursor:pointer;font-weight:600;color:#d4af37;font-size:0.95rem;list-style:none;">â• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´</summary>
            <div style="margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div><label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">ĞšĞ¾Ğ´ <span style="color:#ef4444">*</span></label><input id="newPromoCode" type="text" placeholder="WELCOME10" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;text-transform:uppercase;box-sizing:border-box;"></div>
              <div><label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">Ğ¢Ğ¸Ğ¿ <span style="color:#ef4444">*</span></label><select id="newPromoType" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;"><option value="discount_percent">% ÑĞºĞ¸Ğ´ĞºĞ°</option><option value="discount_amount">Ğ¡ÑƒĞ¼Ğ¼Ğ° ÑĞºĞ¸Ğ´ĞºĞ¸</option><option value="free_generation">Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ°Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ</option></select></div>
              <div><label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ</label><input id="newPromoValue" type="number" step="0.01" min="0" placeholder="10" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;"></div>
              <div><label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">SKU (Ğ¿ÑƒÑÑ‚Ğ¾ = Ğ²ÑĞµ)</label><input id="newPromoSku" type="text" placeholder="single_song" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;"></div>
              <div><label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">ĞœĞ°ĞºÑ. Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹</label><input id="newPromoMaxUses" type="number" step="1" min="1" placeholder="100" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;"></div>
              <div><label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ½Ğ° 1 ÑĞ·ĞµÑ€Ğ°</label><input id="newPromoPerUser" type="number" step="1" min="1" value="1" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;"></div>
              <div><label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">Ğ”ĞµĞ¹ÑÑ‚Ğ²ÑƒĞµÑ‚ Ñ</label><input id="newPromoStartsAt" type="datetime-local" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;"></div>
              <div><label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">Ğ”ĞµĞ¹ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ´Ğ¾</label><input id="newPromoExpiresAt" type="datetime-local" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;"></div>
            </div>
            <div style="margin-top:12px;display:flex;align-items:center;gap:12px;">
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;color:#94a3b8;font-size:0.88rem;"><input id="newPromoActive" type="checkbox" checked style="width:16px;height:16px;"> ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½ ÑÑ€Ğ°Ğ·Ñƒ</label>
              <button onclick="createPromoCode()" class="btn btn-primary" style="padding:9px 22px;font-size:0.9rem;">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´</button>
            </div>
          </details>
          <div class="mono-table-wrap">
            <table class="mono-table" id="promoTable">
              <thead><tr><th>ĞšĞ¾Ğ´</th><th>Ğ¢Ğ¸Ğ¿</th><th>Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ</th><th>SKU</th><th>ĞœĞ°ĞºÑ / ĞĞ° ÑĞ·ĞµÑ€Ğ°</th><th>ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½</th><th>Ğ”ĞµĞ¹ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ´Ğ¾</th><th>Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½</th><th>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</th></tr></thead>
              <tbody id="promoTableBody"><tr><td colspan="9" class="mono-muted">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦</td></tr></tbody>
            </table>
          </div>
          <div id="promoMsg" class="mono-msg"></div>
        </div>
        <div class="mono-panel">
          <h3>ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹</h3>
          <div class="mono-table-wrap">
            <table class="mono-table" id="paymentsTable">
              <thead><tr><th>Ğ”Ğ°Ñ‚Ğ°</th><th>Request ID</th><th>Ğ˜Ğ¼Ñ</th><th>SKU/Mode</th><th>ĞŸÑ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€</th><th>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</th><th>Ğ¡ÑƒĞ¼Ğ¼Ğ°</th><th>Order</th><th>TX</th><th>ĞŸÑ€Ğ¾Ğ¼Ğ¾</th></tr></thead>
              <tbody id="paymentsTableBody"><tr><td colspan="10" class="mono-muted">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦</td></tr></tbody>
            </table>
          </div>
          <div id="paymentsMsg" class="mono-msg"></div>
        </div>
      </div>
    </div>

    <!-- Tab: ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ -->
    <div class="tab-pane" id="tab-settings">
      <div class="details-section" style="margin-bottom:20px;">
        <div class="section-title">âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸</div>
        <p style="font-size:14px;color:#94a3b8;margin-bottom:12px;">ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ DeepSeek Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ·Ğ°ÑĞ²Ğ¾Ğº. ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚: .env Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ &gt; ÑÑ‚Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸.</p>
        <div style="display:flex;flex-direction:column;gap:14px;">
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <label style="display:flex;align-items:center;gap:8px;"><span style="min-width:100px;">ĞœĞ¾Ğ´ĞµĞ»ÑŒ:</span>
              <select id="settings-model" style="min-width:220px;padding:10px;border-radius:8px;border:2px solid #4a5568;background:#1a1a2e;color:#fff;font-size:14px;">
                <option value="deepseek-reasoner">deepseek-reasoner (Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ)</option>
                <option value="deepseek-chat">deepseek-chat</option>
                <option value="deepseek-coder">deepseek-coder</option>
                <option value="">â€” ĞºĞ°Ğº Ğ² .env â€”</option>
              </select>
            </label>
          </div>
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <label style="display:flex;align-items:center;gap:8px;"><span style="min-width:100px;">max_tokens:</span><input type="number" id="settings-max-tokens" min="4096" max="65536" value="8192" step="1" style="width:100px;padding:10px;border-radius:8px;border:2px solid #4a5568;background:#1a1a2e;color:#fff;font-size:16px;"></label>
            <label style="display:flex;align-items:center;gap:8px;"><span style="min-width:100px;">temperature:</span><input type="number" id="settings-temperature" min="0" max="2" step="0.1" value="1.5" style="width:80px;padding:10px;border-radius:8px;border:2px solid #4a5568;background:#1a1a2e;color:#fff;font-size:16px;"></label>
          </div>
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <button type="button" class="btn btn-primary" id="settings-save-btn" style="min-width:140px;">ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
            <span id="settings-save-status" style="font-size:14px;color:#86efac;"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹ -->
    <div class="tab-pane" id="tab-referrals">
      <div class="details-section" style="margin-bottom:20px;">
        <div class="section-title">ğŸ”— Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°</div>
        <div style="display:flex;gap:16px;margin-bottom:16px;flex-wrap:wrap;">
          <div style="background:#1e293b;border-radius:10px;padding:14px 20px;text-align:center;min-width:140px;flex:1;">
            <div id="refTotalCount" style="font-size:2rem;font-weight:700;color:#a78bfa;">â€”</div>
            <div style="font-size:0.78rem;color:#64748b;margin-top:4px;">Ğ’ÑĞµĞ³Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²</div>
          </div>
          <div style="background:#1e293b;border-radius:10px;padding:14px 20px;text-align:center;min-width:140px;flex:1;">
            <div id="refRewardedCount" style="font-size:2rem;font-weight:700;color:#22c55e;">â€”</div>
            <div style="font-size:0.78rem;color:#64748b;margin-top:4px;">ĞĞ°Ğ³Ñ€Ğ°Ğ´Ñ‹ Ğ²Ñ‹Ğ´Ğ°Ğ½Ñ‹</div>
          </div>
        </div>
        <div class="mono-table-wrap">
          <table class="mono-table" id="referralsTable">
            <thead><tr><th>Ğ ĞµÑ„ĞµÑ€ĞµÑ€ ID</th><th>Ğ ĞµÑ„ĞµÑ€Ğ°Ğ» ID</th><th>Ğ”Ğ°Ñ‚Ğ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸</th><th>Ğ”Ğ°Ñ‚Ğ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸</th><th>ĞĞ°Ğ³Ñ€Ğ°Ğ´Ğ°</th></tr></thead>
            <tbody id="referralsTableBody"><tr><td colspan="5" class="mono-muted">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦</td></tr></tbody>
          </table>
        </div>
        <div id="referralsMsg" class="mono-msg"></div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      var params = new URLSearchParams(window.location.search);
      var apiOrigin = params.get('api_origin');
      window.API_BASE = (apiOrigin && apiOrigin.startsWith('http')) ? apiOrigin.replace(/\/$/, '') : window.location.origin;
      var el = document.getElementById('url-info');
      if (el) el.textContent = 'Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°: ' + window.location.origin + ' Â· Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğº API: ' + window.API_BASE;
    })();
    let currentFilter = 'all';
    let currentSort = 'date_desc';
    let currentPayFilter = 'all';

    function switchTab(tabId, btn) {
      document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      const pane = document.getElementById('tab-' + tabId);
      if (pane) pane.classList.add('active');
      if (btn) btn.classList.add('active');
    }

    function toggleRow(id) {
      const row = document.getElementById('req-row-' + id);
      const body = document.getElementById('req-body-' + id);
      if (!row || !body) return;
      const isOpen = row.classList.contains('expanded');
      if (isOpen) {
        row.classList.remove('expanded');
        body.style.display = 'none';
        return;
      }
      row.classList.add('expanded');
      body.style.display = 'block';
      // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğµ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ñ€Ğ°ÑĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸
      if (row.getAttribute('data-loaded') === 'true') return;
      row.setAttribute('data-loaded', 'true');
      body.innerHTML = '<div style="padding:18px;color:#64748b;font-size:13px;display:flex;align-items:center;gap:10px;"><span style="display:inline-block;width:16px;height:16px;border:2px solid rgba(102,126,234,0.3);border-top-color:#667eea;border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0;"></span> Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹â€¦</div>';
      loadFullDetail(id, body, row);
    }

    async function loadFullDetail(id, body, row) {
      let r;
      try {
        const result = await fetchJson(API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + authQueryFromPath(), { headers: authHeaders() }, 12000);
        if (!result.json?.success || !result.json?.data) throw new Error(result.json?.error || 'load error');
        r = result.json.data;
      } catch (e) {
        body.innerHTML = '<div style="padding:14px;color:#fca5a5;font-size:13px;">âŒ ' + escapeHtml(String(e?.message || e)) + ' <button onclick="this.closest(\'[data-loaded]\').removeAttribute(\'data-loaded\');toggleRow(\'' + escapeHtml(id) + '\')" style="background:rgba(102,126,234,0.2);border:1px solid #667eea;color:#a5b4fc;border-radius:5px;padding:3px 10px;cursor:pointer;font-family:inherit;font-size:12px;margin-left:8px;">â†» ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ</button></div>';
        row.removeAttribute('data-loaded');
        return;
      }

      const gs = r.generation_status || r.status || 'pending';
      const steps = normalizeSteps(r.generation_steps);
      const order = getStatusOrder(gs);
      const safeId = id.replace(/\\/g, '\\\\').replace(/'/g, "\\'");

      // â”€â”€ Ğ¥ĞµĞ»Ğ¿ĞµÑ€Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function stepVal(key) {
        const v = steps[key]; return (v && String(v).trim()) ? String(v) : '';
      }
      function stepRow(label, key, col) {
        const v = stepVal(key);
        return `<div style="display:flex;gap:6px;align-items:flex-start;padding:3px 0;border-bottom:1px solid #1e293b;">
          <span style="color:${v ? (col || '#86efac') : '#334155'};flex-shrink:0;width:14px;font-size:11px;">${v ? 'âœ“' : 'Â·'}</span>
          <span style="color:#94a3b8;font-size:11px;min-width:160px;flex-shrink:0;">${escapeHtml(label)}</span>
          <span style="font-size:11px;color:${v ? '#e2e8f0' : '#475569'};word-break:break-all;">${v ? escapeHtml(v.slice(0,120)) : 'â€”'}</span>
        </div>`;
      }
      function field(label, value, hint) {
        if (!value && !hint) return '';
        return `<div style="display:flex;gap:8px;align-items:flex-start;margin-bottom:4px;">
          <span style="color:#64748b;font-size:11px;min-width:120px;flex-shrink:0;">${escapeHtml(label)}</span>
          <span style="font-size:12px;color:#e2e8f0;word-break:break-word;">${value ? escapeHtml(String(value)) : ('<span style="color:#475569;">' + (hint||'â€”') + '</span>')}</span>
        </div>`;
      }

      // â”€â”€ Ğ‘Ğ»Ğ¾Ğº Â«Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑÂ» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const userBlock = `<div class="detail-section-inline">
        <div class="dsi-title">ğŸ‘¤ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ</div>
        <div class="dsi-body">
          ${field('Ğ˜Ğ¼Ñ', r.name)}
          ${field('Telegram ID', r.telegram_user_id)}
          ${field('ĞŸĞ¾Ğ»', r.gender)}
          ${field('Ğ”Ğ°Ñ‚Ğ° Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ', r.birthdate)}
          ${field('Ğ’Ñ€ĞµĞ¼Ñ Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ', r.birthtime_unknown ? 'Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾' : r.birthtime)}
          ${field('ĞœĞµÑÑ‚Ğ¾ Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ', r.birthplace)}
          ${r.person2_name ? `<div style="border-top:1px solid #1e293b;margin:8px 0 6px;padding-top:6px;color:#d4af37;font-size:11px;font-weight:700;">ĞŸĞ°Ñ€Ñ‚Ğ½Ñ‘Ñ€</div>
            ${field('Ğ˜Ğ¼Ñ Ğ¿Ğ°Ñ€Ñ‚Ğ½Ñ‘Ñ€Ğ°', r.person2_name)}
            ${field('ĞŸĞ¾Ğ» Ğ¿Ğ°Ñ€Ñ‚Ğ½Ñ‘Ñ€Ğ°', r.person2_gender)}
            ${field('Ğ”Ğ°Ñ‚Ğ° Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ', r.person2_birthdate)}
            ${field('Ğ’Ñ€ĞµĞ¼Ñ Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ', r.person2_birthtime_unknown ? 'Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾' : r.person2_birthtime)}
            ${field('ĞœĞµÑÑ‚Ğ¾ Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ', r.person2_birthplace)}` : ''}
          ${r.transit_date ? `<div style="border-top:1px solid #1e293b;margin:8px 0 6px;padding-top:6px;color:#f9a8d4;font-size:11px;font-weight:700;">Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ¸Ñ‚</div>
            ${field('Ğ”Ğ°Ñ‚Ğ°', r.transit_date)}
            ${field('Ğ’Ñ€ĞµĞ¼Ñ', r.transit_time)}
            ${field('Ğ›Ğ¾ĞºĞ°Ñ†Ğ¸Ñ', r.transit_location)}
            ${field('ĞĞ°Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ğµ', r.transit_intent)}` : ''}
        </div>
      </div>`;

      // â”€â”€ Ğ‘Ğ»Ğ¾Ğº Â«ĞĞ¿Ğ»Ğ°Ñ‚Ğ°Â» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const isPendingPay = ['pending','requires_payment'].includes(String((r.payment_status||'').toLowerCase()));
      const payBlock = `<div class="detail-section-inline">
        <div class="dsi-title">ğŸ’³ ĞĞ¿Ğ»Ğ°Ñ‚Ğ°</div>
        <div class="dsi-body">
          ${field('Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ', r.payment_status)}
          ${field('ĞŸÑ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€', r.payment_provider)}
          ${field('Ğ¡ÑƒĞ¼Ğ¼Ğ°', r.payment_amount != null ? r.payment_amount + ' ' + (r.payment_currency||'USDT') : null)}
          ${field('ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´', r.promo_code)}
          ${field('Ğ¡ĞºĞ¸Ğ´ĞºĞ°', r.promo_discount_amount != null ? '-' + r.promo_discount_amount : null)}
          ${field('Order ID', r.payment_order_id)}
          ${field('Ğ”Ğ°Ñ‚Ğ° Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹', r.paid_at ? new Date(r.paid_at).toLocaleString('ru-RU') : null)}
        </div>
        ${isPendingPay ? `<div style="margin-top:10px;"><button class="rmb rmb-green" style="padding:6px 14px;font-size:12px;" onclick="markPaid('${safeId}');loadFullDetail('${safeId}',document.getElementById('req-body-${escapeHtml(id)}'),document.getElementById('req-row-${escapeHtml(id)}'))">âœ… ĞÑ‚Ğ¼ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ¾Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¼</button></div>` : ''}
      </div>`;

      // â”€â”€ Ğ‘Ğ»Ğ¾Ğº Â«Ğ—Ğ°ÑĞ²ĞºĞ°Â» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const requestBlock = r.request ? `<div class="detail-section-inline">
        <div class="dsi-title">ğŸ’¬ Ğ¢ĞµĞºÑÑ‚ Ğ·Ğ°ÑĞ²ĞºĞ¸</div>
        <div class="dsi-body" style="white-space:pre-wrap;font-size:12px;line-height:1.65;color:#cbd5e1;max-height:180px;overflow-y:auto;">${escapeHtml(r.request)}</div>
      </div>` : '';

      // â”€â”€ Ğ‘Ğ»Ğ¾Ğº Â«ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑÂ» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const progressBlock = `<div class="detail-section-inline">
        <div class="dsi-title">âš™ï¸ Ğ¦ĞµĞ¿Ğ¾Ñ‡ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸</div>
        <div class="dsi-body">
          ${stepRow('Ğ—Ğ°ÑĞ²ĞºĞ° Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ğ°', 'request_loaded')}
          ${stepRow('Ğ¡Ñ‚Ğ°Ñ€Ñ‚ Ğ°ÑÑ‚Ñ€Ğ¾Ğ±Ğ»Ğ¾ĞºĞ°', 'astro_start')}
          ${stepRow('Ğ¡Ğ½Ğ°Ğ¿ÑˆĞ¾Ñ‚ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½', 'astro_snapshot_saved')}
          ${stepRow('D-ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ¸ Ğ”Ğ°ÑˆĞ¸', 'astro_extensions')}
          ${stepRow('ĞŸÑ€Ğ¾Ğ¼Ñ‚ ÑĞ¾Ğ±Ñ€Ğ°Ğ½', 'prompt_compiled')}
          ${stepRow('Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ² DeepSeek', 'llm_request_start')}
          ${stepRow('ĞÑ‚Ğ²ĞµÑ‚ DeepSeek', 'llm_response_ready')}
          ${stepRow('DeepSeek ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½', 'llm_response_saved')}
          ${stepRow('Ğ›Ğ¸Ñ€Ğ¸ĞºĞ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ°', 'lyrics_ready')}
          ${stepRow('Ğ¡Ñ‚Ğ°Ñ€Ñ‚ Suno', 'suno_start')}
          ${stepRow('Suno task', 'suno_task_created')}
          ${stepRow('ĞÑƒĞ´Ğ¸Ğ¾ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾', 'audio_ready')}
          ${stepRow('Ğ”Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ°', 'delivery_done')}
          ${stepRow('Ğ¤Ğ¸Ğ½Ğ°Ğ»', 'pipeline_done')}
          ${steps.error ? `<div style="margin-top:8px;padding:8px;background:rgba(231,76,60,0.1);border-radius:6px;color:#fca5a5;font-size:11px;">âŒ ${escapeHtml(String(steps.error))}</div>` : ''}
        </div>
      </div>`;

      // â”€â”€ Ğ‘Ğ»Ğ¾Ğº Â«DeepSeekÂ» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const dsBlock = r.deepseek_response ? `<div class="detail-section-inline">
        <div class="dsi-title">ğŸ¤– ĞÑ‚Ğ²ĞµÑ‚ DeepSeek ${r.llm_truncated ? '<span style="color:#f39c12;font-size:10px;">âš ï¸ Ğ¾Ğ±Ñ€ĞµĞ·Ğ°Ğ½</span>' : ''}</div>
        <div class="dsi-body" style="white-space:pre-wrap;font-size:11px;line-height:1.6;color:#cbd5e1;max-height:220px;overflow-y:auto;">${escapeHtml((r.deepseek_response||'').slice(0,3000))}${(r.deepseek_response||'').length>3000?'\nâ€¦[Ğ¾Ğ±Ñ€ĞµĞ·Ğ°Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ]':''}</div>
      </div>` : '';

      // â”€â”€ Ğ‘Ğ»Ğ¾Ğº Â«Ğ›Ğ¸Ñ€Ğ¸ĞºĞ°Â» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const lyricsBlock = r.lyrics ? `<div class="detail-section-inline">
        <div class="dsi-title">ğŸµ Ğ¢ĞµĞºÑÑ‚ Ğ¿ĞµÑĞ½Ğ¸</div>
        <div class="dsi-body" style="white-space:pre-wrap;font-size:12px;line-height:1.65;color:#e2e8f0;max-height:220px;overflow-y:auto;">${escapeHtml(r.lyrics)}</div>
      </div>` : '';

      // â”€â”€ Ğ‘Ğ»Ğ¾Ğº Â«ĞÑƒĞ´Ğ¸Ğ¾Â» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const audioBlock = r.audio_url ? `<div class="detail-section-inline">
        <div class="dsi-title">ğŸ”Š ĞÑƒĞ´Ğ¸Ğ¾</div>
        <div class="dsi-body">
          <audio style="width:100%;margin-bottom:8px;" controls src="${escapeHtml(r.audio_url)}"></audio>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <a href="${escapeHtml(r.audio_url)}" download target="_blank"><button class="rmb rmb-green" style="padding:6px 14px;font-size:12px;">â¬‡ï¸ Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ</button></a>
            <button class="rmb rmb-blue" style="padding:6px 14px;font-size:12px;" onclick="deliver('${safeId}',this)">ğŸ“¤ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ</button>
          </div>
        </div>
      </div>` : '';

      // â”€â”€ Ğ‘Ğ»Ğ¾Ğº Â«ID Ğ·Ğ°ÑĞ²ĞºĞ¸Â» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const idBlock = `<div style="font-size:10px;color:#334155;font-family:monospace;padding:8px 0 4px;word-break:break-all;">
        ID: ${escapeHtml(r.id||'')} Â· Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ°: ${r.created_at ? new Date(r.created_at).toLocaleString('ru-RU') : 'â€”'} Â· Ğ ĞµĞ¶Ğ¸Ğ¼: ${escapeHtml(r.mode||'single')}
      </div>`;

      // â”€â”€ ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const actionsBlock = `<div style="display:flex;gap:8px;flex-wrap:wrap;padding:12px 0 4px;border-top:1px solid #1e293b;margin-top:8px;">
        <button class="rmb rmb-orange" style="padding:7px 14px;font-size:12px;" onclick="restart('${safeId}',this)">${gs === 'completed' ? 'ğŸ”„ ĞŸĞµÑ€ĞµĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ' : 'ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ'}</button>
        ${isPendingPay ? `<button class="rmb rmb-green" style="padding:7px 14px;font-size:12px;" onclick="markPaid('${safeId}')">âœ… ĞĞ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾</button>` : ''}
        ${gs === 'pending_payment' ? `<button class="rmb rmb-red" style="padding:7px 14px;font-size:12px;" onclick="cancelRequest('${safeId}',this)">âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ</button>` : ''}
        ${r.audio_url ? `<button class="rmb rmb-green" style="padding:7px 14px;font-size:12px;" onclick="deliver('${safeId}',this)">ğŸ“¤ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>` : ''}
        <button class="rmb rmb-red" style="padding:7px 14px;font-size:12px;margin-left:auto;" onclick="if(confirm('Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°ÑĞ²ĞºÑƒ?')){deleteRequests(['${safeId}'])}"  title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°ÑĞ²ĞºÑƒ">ğŸ—‘ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ</button>
      </div>`;

      body.innerHTML = `
        <div style="padding:4px 0 10px;">
          ${idBlock}
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
            ${userBlock}
            ${payBlock}
          </div>
          ${requestBlock}
          ${progressBlock}
          ${dsBlock}
          ${lyricsBlock}
          ${audioBlock}
          ${actionsBlock}
        </div>`;
    }

    function filterByCard(card) {
      const filter = card.getAttribute('data-filter') || 'all';
      document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active-filter'));
      card.classList.add('active-filter');
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(b => {
        b.classList.toggle('active', b.getAttribute('data-filter') === filter);
      });
      // ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ÑÑ Ğ½Ğ° Ğ²ĞºĞ»Ğ°Ğ´ĞºÑƒ Ğ—Ğ°ÑĞ²ĞºĞ¸
      const tabBtn = document.querySelector('.tab-btn[onclick*="requests"]');
      if (tabBtn) switchTab('requests', tabBtn);
      loadAdminData();
    }

    function setSort(btn) {
      currentSort = btn.getAttribute('data-sort') || 'date_desc';
      document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      if (window._lastRequestsData) renderRequests(window._lastRequestsData);
    }

    function sortRequests(data) {
      const sorted = [...data];
      if (currentSort === 'date_desc') {
        sorted.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
      } else if (currentSort === 'date_asc') {
        sorted.sort((a, b) => new Date(a.created_at || 0) - new Date(b.created_at || 0));
      } else if (currentSort === 'name_asc') {
        sorted.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ru'));
      } else if (currentSort === 'status') {
        sorted.sort((a, b) => getStatusOrder(b.generation_status || '') - getStatusOrder(a.generation_status || ''));
      } else if (currentSort === 'payment') {
        const payOrder = { gift_used: 0, subscription_active: 1, paid: 2, requires_payment: 3, pending: 4 };
        sorted.sort((a, b) => (payOrder[a.payment_status] ?? 5) - (payOrder[b.payment_status] ?? 5));
      }
      return sorted;
    }

    // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Â«Ñ‚Ğ¸Ğ¿ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹Â» Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸
    function getPayType(r) {
      const provider = String(r.payment_provider || '').toLowerCase();
      const status   = String(r.payment_status  || '').toLowerCase();
      const promo    = r.promo_code ? String(r.promo_code).toUpperCase() : null;
      const gs       = String(r.generation_status || '').toLowerCase();
      if (gs === 'pending_payment' || status === 'requires_payment') return 'awaiting';
      if (status === 'gift_used') return 'gift';
      if (provider === 'subscription' || status === 'subscription_active') return 'subscription';
      if (provider === 'promo' || (promo && provider !== 'hot')) return 'promo';
      if (provider === 'hot') return 'hot';
      if (provider === 'admin') return 'admin';
      if (provider === 'gift') return 'gift';
      return 'unknown';
    }

    function paymentMethodBadge(r) {
      const provider = String(r.payment_provider || '').toLowerCase();
      const status   = String(r.payment_status  || '').toLowerCase();
      const promo    = r.promo_code ? String(r.promo_code) : null;
      const gs       = String(r.generation_status || '').toLowerCase();
      const payType  = getPayType(r);

      if (gs === 'pending_payment' || status === 'requires_payment') {
        const amt = r.payment_amount != null ? (' Â· ' + r.payment_amount + ' ' + (r.payment_currency || 'USDT')) : '';
        return '<span class="pay-badge" style="background:rgba(139,92,246,.25);color:#c4b5fd;">â³ ĞĞ¶Ğ¸Ğ´Ğ°ĞµÑ‚ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹' + escapeHtml(amt) + '</span>';
      }
      if (payType === 'gift') {
        return '<span class="pay-badge pay-badge-free">ğŸ ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¾Ğº</span>';
      }
      if (payType === 'promo') {
        const label = promo ? ('ğŸ· ' + escapeHtml(promo)) : 'ğŸ· ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´';
        const disc = r.promo_discount_amount ? (' âˆ’' + r.promo_discount_amount) : '';
        return '<span class="pay-badge pay-badge-promo">' + label + escapeHtml(disc) + '</span>';
      }
      if (payType === 'hot') {
        if (status === 'paid') return '<span class="pay-badge pay-badge-hot">ğŸ’³ HOT Pay âœ“</span>';
        return '<span class="pay-badge pay-badge-hot" style="opacity:.75;">ğŸ’³ HOT Payâ€¦</span>';
      }
      if (payType === 'subscription') {
        return '<span class="pay-badge pay-badge-sub">ğŸ“‹ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°</span>';
      }
      if (payType === 'admin') {
        return '<span class="pay-badge pay-badge-free">ğŸ”§ Ğ ÑƒÑ‡Ğ½Ğ°Ñ</span>';
      }
      if (!provider && !status) return '';
      return '<span class="pay-badge" style="background:rgba(100,116,139,.2);color:#94a3b8;">' + escapeHtml(provider || status) + '</span>';
    }

    function setPayFilter(btn) {
      currentPayFilter = btn.getAttribute('data-pay') || 'all';
      document.querySelectorAll('.pay-filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      if (window._lastRequestsData) renderRequests(window._lastRequestsData);
    }

    function filterByPayment(data) {
      if (!currentPayFilter || currentPayFilter === 'all') return data;
      return data.filter(r => getPayType(r) === currentPayFilter);
    }

    function getToken() {
      const fromUrl = new URLSearchParams(window.location.search).get('token');
      if (fromUrl) {
        try { localStorage.setItem('adminToken', fromUrl); } catch (e) {}
        return fromUrl;
      }
      return localStorage.getItem('adminToken');
    }
    function authHeaders() {
      const t = getToken();
      return t ? { 'X-Admin-Token': t } : {};
    }
    function authQuery() {
      const t = getToken();
      return t ? '&token=' + encodeURIComponent(t) : '';
    }
    function authQueryFromPath() {
      const t = getToken();
      return t ? '?token=' + encodeURIComponent(t) : '';
    }

    function setMonoMsg(id, text, ok) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = text || '';
      el.style.color = ok === true ? '#86efac' : (ok === false ? '#fca5a5' : '#94a3b8');
    }

    async function fetchJson(url, opts, timeoutMs) {
      timeoutMs = timeoutMs || 15000;
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeoutMs);
      let res;
      try {
        res = await fetch(url, Object.assign({}, opts, { signal: controller.signal }));
      } catch (e) {
        clearTimeout(timer);
        if (e && e.name === 'AbortError') throw new Error('Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ½Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¸Ğ» Ğ·Ğ° ' + (timeoutMs/1000) + ' ÑĞµĞº. Render Ğ¼Ğ¾Ğ³ ÑƒÑĞ½ÑƒÑ‚ÑŒ â€” Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ (F5) Ñ‡ĞµÑ€ĞµĞ· 30 ÑĞµĞº.');
        throw new Error('Ğ¡ĞµÑ‚ÑŒ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°: ' + (e && e.message));
      }
      clearTimeout(timer);
      const text = await res.text();
      if (text.trim().startsWith('<')) {
        if (res.status === 502 || res.status === 503) {
          throw new Error('Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ¿Ñ€Ğ¾ÑÑ‹Ğ¿Ğ°ĞµÑ‚ÑÑ (502/503). ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ 30â€“60 ÑĞµĞº Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ (F5).');
        }
        throw new Error('Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ²ĞµÑ€Ğ½ÑƒĞ» HTML Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (ĞºĞ¾Ğ´ ' + res.status + '). ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ¿Ğ¾ ÑÑÑ‹Ğ»ĞºĞµ Ğ¸Ğ· Ğ±Ğ¾Ñ‚Ğ° (/admin).');
      }
      try {
        return { res, json: JSON.parse(text) };
      } catch (e) {
        throw new Error('ĞÑ‚Ğ²ĞµÑ‚ Ğ½Ğµ JSON (ÑĞµÑ€Ğ²ĞµÑ€ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ¸Ğ»Ğ¸ Ğ½Ğµ Ñ‚Ğ¾Ñ‚ Ğ°Ğ´Ñ€ĞµÑ). ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ¿Ğ¾ ÑÑÑ‹Ğ»ĞºĞµ Ğ¸Ğ· Ğ±Ğ¾Ñ‚Ğ° (/admin).');
      }
    }

    function setLoadingStatus(visible, text) {
      const el = document.getElementById('loadingStatus');
      const textEl = document.getElementById('loadingStatusText');
      if (!el) return;
      el.style.display = visible ? 'flex' : 'none';
      if (textEl && text) textEl.textContent = text;
    }

    async function loadAdminData() {
      const token = getToken();
      if (!token) {
        const el = document.getElementById('requests');
        if (el) el.innerHTML = '<div style="text-align:center;padding:40px;color:#e0e0e0"><p style="margin-bottom:20px">ğŸ”‘ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‚Ğ¾ĞºĞµĞ½ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° / Enter admin token</p><form id="token-form" style="display:flex;flex-direction:column;align-items:center;gap:12px;max-width:320px;margin:0 auto"><input type="password" id="token-input" placeholder="Ğ¢Ğ¾ĞºĞµĞ½" style="width:100%;padding:12px;border-radius:8px;border:2px solid #667eea;background:#1a1a2e;color:#fff;font-size:16px" autocomplete="off"><button type="submit" style="padding:12px 24px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ / Login</button></form></div>';
        const form = document.getElementById('token-form');
        const input = document.getElementById('token-input');
        if (form && input) form.addEventListener('submit', function(e) { e.preventDefault(); const v = (input.value || '').trim(); if (v) { localStorage.setItem('adminToken', v); window.location.search = '?token=' + encodeURIComponent(v); } });
        return;
      }
      setLoadingStatus(true, 'ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº ÑĞµÑ€Ğ²ĞµÑ€Ñƒâ€¦');
      try {
        const statsResult = await fetchJson(API_BASE + '/api/admin/stats?' + new URLSearchParams({ token }).toString(), { headers: authHeaders() }, 20000);
        // 403 â€” Ğ½ĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½: Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ğ²Ğ²Ğ¾Ğ´Ğ°
        if (statsResult.res.status === 403) {
          setLoadingStatus(false);
          const el = document.getElementById('requests');
          if (el) el.innerHTML = '<div style="text-align:center;padding:40px;color:#fca5a5"><p style="font-size:18px;margin-bottom:12px">ğŸ” Ğ¢Ğ¾ĞºĞµĞ½ Ğ½ĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ¸Ğ»Ğ¸ ÑƒÑÑ‚Ğ°Ñ€ĞµĞ»</p><p style="color:#94a3b8;margin-bottom:20px">ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ ÑÑÑ‹Ğ»ĞºÑƒ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ¹ <b>/admin</b> Ğ² Ğ±Ğ¾Ñ‚Ğµ</p><button onclick="window.location.reload()" style="padding:10px 24px;background:#667eea;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:15px;">ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ</button></div>';
          return;
        }
        // 502/503 â€” ÑĞµÑ€Ğ²ĞµÑ€ Ğ¿Ñ€Ğ¾ÑÑ‹Ğ¿Ğ°ĞµÑ‚ÑÑ: Ğ°Ğ²Ñ‚Ğ¾-Ñ€ĞµÑ‚Ñ€Ğ°Ğ¹ Ñ‡ĞµÑ€ĞµĞ· 20 ÑĞµĞº
        if (statsResult.res.status === 502 || statsResult.res.status === 503) {
          setLoadingStatus(false);
          let sec = 20;
          const el = document.getElementById('requests');
          const tick = () => {
            if (!el) return;
            if (sec <= 0) { window.location.reload(); return; }
            el.innerHTML = '<div style="text-align:center;padding:40px;color:#f39c12">â³ Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ¿Ñ€Ğ¾ÑÑ‹Ğ¿Ğ°ĞµÑ‚ÑÑâ€¦ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ‡ĞµÑ€ĞµĞ· ' + sec + ' ÑĞµĞº<br><br><button onclick="window.location.reload()" style="margin-top:12px;padding:10px 24px;background:#667eea;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:15px;">ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞµĞ¹Ñ‡Ğ°Ñ</button></div>';
            sec--;
            setTimeout(tick, 1000);
          };
          tick();
          return;
        }
        const statsJson = statsResult.json;
        if (statsJson.success && statsJson.stats) {
          const s = statsJson.stats;
          document.getElementById('total').textContent = s.total;
          document.getElementById('pending').textContent = (s.pending || 0) + (s.astro_calculated || 0) + (s.lyrics_generated || 0) + (s.suno_processing || 0);
          document.getElementById('completed').textContent = s.completed || 0;
          document.getElementById('failed').textContent = s.failed || 0;
          // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº Ğ¾Ğ¶Ğ¸Ğ´Ğ°ÑÑ‰Ğ¸Ñ… Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹
          const ppEl = document.getElementById('stat-pending-payment');
          if (ppEl) ppEl.textContent = s.pending_payment || 0;
          const cancelledEl = document.getElementById('stat-cancelled');
          if (cancelledEl) cancelledEl.textContent = s.cancelled || 0;
        }
        // Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºÑƒ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº Ñ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ¼
        document.querySelectorAll('.stat-card').forEach(c => {
          c.classList.toggle('active-filter', c.getAttribute('data-filter') === currentFilter);
        });
        // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ½ĞµĞ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°ÑĞ²ĞºĞ¸ (pending_payment) ÑÑ€Ğ°Ğ·Ñƒ Ğ¿Ñ€Ğ¸ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸
        loadUnpaidRequests();
        setLoadingStatus(true, 'Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ·Ğ°ÑĞ²Ğ¾Ğºâ€¦');
        const listResult = await fetchJson(API_BASE + '/api/admin/requests?limit=50&status=' + currentFilter + authQuery(), { headers: authHeaders() });
        const listJson = listResult.json;
        const listRes = listResult.res;
        if (listJson.success && Array.isArray(listJson.data)) renderRequests(listJson.data);
        else {
          const err = listJson.error || listRes.status || 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸';
          document.getElementById('requests').innerHTML = '<div style="text-align:center;padding:40px;color:#e74c3c">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸: ' + escapeHtml(String(err)) + '<br>ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ñ‚Ğ¾ĞºĞµĞ½ / Check token</div>';
        }
        const settingsResult = await fetchJson(API_BASE + '/api/admin/settings' + authQueryFromPath(), { headers: authHeaders() });
        const settingsJson = settingsResult.json;
        if (settingsJson.success && settingsJson.settings) {
          const st = settingsJson.settings;
          const mt = st.deepseek_max_tokens;
          const inputEl = document.getElementById('settings-max-tokens');
          if (inputEl && (mt === 0 || mt > 0)) inputEl.value = Math.max(4096, Number(mt)) || 8192;
          const modelEl = document.getElementById('settings-model');
          if (modelEl && st.deepseek_model) {
            const opt = Array.from(modelEl.options).find(o => o.value === st.deepseek_model);
            if (opt) modelEl.value = st.deepseek_model;
            else { const o = new Option(st.deepseek_model, st.deepseek_model); modelEl.appendChild(o); modelEl.value = st.deepseek_model; }
          }
          const tempEl = document.getElementById('settings-temperature');
          if (tempEl && st.deepseek_temperature != null && Number.isFinite(Number(st.deepseek_temperature))) tempEl.value = Math.max(0, Math.min(2, Number(st.deepseek_temperature)));
        }
        setLoadingStatus(true, 'Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¼Ğ¾Ğ½ĞµÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²â€¦');
        await loadMonetizationData();
        loadReferralData();
        setLoadingStatus(false);
      } catch (e) {
        setLoadingStatus(false);
        const msg = (e && e.message) || String(e);
        const el = document.getElementById('requests');
        if (el) el.innerHTML = '<div style="text-align:center;padding:40px;color:#e74c3c">âŒ ' + escapeHtml(msg) + '<br><br><button onclick="window.location.reload()" style="margin-top:12px;padding:10px 24px;background:#667eea;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:15px;">ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ</button><br><br><span style="font-size:12px;color:#64748b">API: ' + escapeHtml(window.API_BASE || window.location.origin) + '</span></div>';
      }
    }

    // Ğ›Ñ‘Ğ³ĞºĞ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ÑĞ»Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°ÑĞ²ĞºĞ¸ + ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸ĞºĞ¸, Ğ±ĞµĞ· ÑĞ±Ñ€Ğ¾ÑĞ° Ğ²ÑĞµĞ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
    async function refreshAfterAction() {
      const token = getToken();
      if (!token) return;

      // Ğ—Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ¿ĞµÑ€ĞµĞ´ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸ĞµĞ¼
      const savedScroll = window.scrollY;
      const expandedIds = [...document.querySelectorAll('.req-row.expanded')]
        .map(r => r.getAttribute('data-request-id')).filter(Boolean);
      const loadedIds = [...document.querySelectorAll('.req-row[data-loaded="true"]')]
        .map(r => r.getAttribute('data-request-id')).filter(Boolean);

      const el = document.getElementById('requests');
      if (el) el.style.opacity = '0.5';

      try {
        const [statsRes, listRes] = await Promise.all([
          fetchJson(API_BASE + '/api/admin/stats?' + new URLSearchParams({ token }).toString(), { headers: authHeaders() }, 10000),
          fetchJson(API_BASE + '/api/admin/requests?limit=50&status=' + currentFilter + authQuery(), { headers: authHeaders() }, 10000),
        ]);

        if (statsRes.json && statsRes.json.success && statsRes.json.stats) {
          const s = statsRes.json.stats;
          document.getElementById('total').textContent = s.total;
          document.getElementById('pending').textContent = (s.pending || 0) + (s.astro_calculated || 0) + (s.lyrics_generated || 0) + (s.suno_processing || 0);
          document.getElementById('completed').textContent = s.completed || 0;
          document.getElementById('failed').textContent = s.failed || 0;
          const ppEl = document.getElementById('stat-pending-payment');
          if (ppEl) ppEl.textContent = s.pending_payment || 0;
          const cancelledEl = document.getElementById('stat-cancelled');
          if (cancelledEl) cancelledEl.textContent = s.cancelled || 0;
        }

        if (listRes.json && listRes.json.success && Array.isArray(listRes.json.data)) {
          renderRequests(listRes.json.data);

          // Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ€Ğ°ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹
          for (const id of expandedIds) {
            const row = document.getElementById('req-row-' + id);
            const body = document.getElementById('req-body-' + id);
            if (!row || !body) continue;
            row.classList.add('expanded');
            body.style.display = 'block';
            if (loadedIds.includes(id)) {
              row.setAttribute('data-loaded', 'true');
              // ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ´Ğ»Ñ Ñ€Ğ°ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ñ… ÑÑ‚Ñ€Ğ¾Ğº Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ
              loadFullDetail(id, body, row);
            }
          }
        }

        // Ğ¢Ğ¸Ñ…Ğ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½ĞµĞ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ñ… Ğ·Ğ°ÑĞ²Ğ¾Ğº â€” Ğ±ĞµĞ· ÑĞ¿Ğ¸Ğ½Ğ½ĞµÑ€Ğ°
        loadUnpaidRequests(true);
      } catch(e) {
        // ĞŸÑ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ
      } finally {
        if (el) { el.style.opacity = '1'; }
        // Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞºÑ€ÑƒÑ‚ĞºĞ¸
        window.scrollTo({ top: savedScroll, behavior: 'instant' });
      }
    }

    function getStatusOrder(status) {
      const order = { pending_payment: -1, pending: 1, astro_calculated: 2, lyrics_generated: 3, suno_processing: 4, completed: 5, failed: 0, cancelled: -2 };
      return order[status] !== undefined ? order[status] : 1;
    }
    function statusClass(gs) {
      if (gs === 'completed') return 'status-completed';
      if (gs === 'failed') return 'status-failed';
      if (gs === 'pending_payment') return 'status-payment';
      if (gs === 'cancelled') return 'status-cancelled';
      return 'status-pending';
    }
    function statusLabel(gs) {
      if (gs === 'completed') return 'âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾';
      if (gs === 'failed') return 'âŒ ĞÑˆĞ¸Ğ±ĞºĞ°';
      if (gs === 'pending_payment') return 'ğŸ’³ ĞĞ¶Ğ¸Ğ´Ğ°ĞµÑ‚ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹';
      if (gs === 'cancelled') return 'ğŸš« ĞÑ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°';
      return 'â³ Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ';
    }
    function paymentLabel(ps) {
      if (!ps) return { text: 'â€”', cls: 'mono-muted' };
      const s = String(ps).toLowerCase();
      if (['paid', 'gift_used', 'subscription_active'].includes(s)) return { text: 'âœ… ĞĞ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾', cls: '' };
      if (['requires_payment', 'pending'].includes(s)) return { text: 'âš ï¸ ĞĞµ Ğ¾Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾', cls: '' };
      return { text: String(ps), cls: '' };
    }

    function normalizeSteps(raw) {
      if (raw && typeof raw === 'object') return raw;
      if (typeof raw === 'string') {
        try { return JSON.parse(raw); } catch (e) { return {}; }
      }
      return {};
    }
    function renderRequests(data) {
      window._lastRequestsData = data;
      data = filterByPayment(data);
      data = sortRequests(data);
      const payLabel = currentPayFilter !== 'all' ? (' Â· ĞĞ¿Ğ»Ğ°Ñ‚Ğ°: ' + currentPayFilter) : '';
      if (!data.length) {
        document.getElementById('requests').innerHTML = '<div style="text-align:center;padding:60px;color:#94a3b8">ğŸ“­ ĞĞµÑ‚ Ğ·Ğ°ÑĞ²Ğ¾Ğº' + escapeHtml(payLabel) + '</div>';
        const bulkBarEmpty = document.getElementById('bulkActionsBar');
        if (bulkBarEmpty) bulkBarEmpty.style.display = 'none';
        return;
      }
      function stepMsg(steps, key) {
        if (!steps || typeof steps !== 'object') return '';
        const v = steps[key];
        return (v && String(v).trim()) ? escapeHtml(String(v).slice(0, 120)) : '';
      }
      function stepsDigest(steps) {
        const s = normalizeSteps(steps);
        const checks = [];
        if (s.astro_extensions) checks.push('Ğ°ÑÑ‚Ñ€Ğ¾+: ' + escapeHtml(String(s.astro_extensions)));
        if (s.llm_response_saved) checks.push('deepseek: ' + escapeHtml(String(s.llm_response_saved)));
        if (s.cover_ready) checks.push('cover: ' + escapeHtml(String(s.cover_ready)));
        if (s.delivery_done) checks.push('delivery: ' + escapeHtml(String(s.delivery_done)));
        return checks.join(' Â· ');
      }
      document.getElementById('requests').innerHTML = data.map(r => {
        const gs = r.generation_status || r.status || 'pending';
        const order = getStatusOrder(gs);
        const steps = normalizeSteps(r.generation_steps);
        const safeId = (r.id || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        const safeIdAttr = escapeAttr(r.id || '');
        const dateStr = r.created_at ? new Date(r.created_at).toLocaleDateString('ru-RU') + ' ' + new Date(r.created_at).toLocaleTimeString('ru-RU', {hour:'2-digit',minute:'2-digit'}) : 'â€”';
        const isPendingPay = ['pending','requires_payment'].includes(String((r.payment_status || '').toLowerCase()));
        return `
        <div class="req-row" id="req-row-${safeIdAttr}" data-request-id="${safeIdAttr}">
          <div class="req-row-head" onclick="toggleRow('${safeId}')">
            <input type="checkbox" class="req-select-cb" data-request-id="${safeIdAttr}" aria-label="Ğ’Ñ‹Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°ÑĞ²ĞºÑƒ" onclick="event.stopPropagation()" style="width:16px;height:16px;flex-shrink:0;cursor:pointer;">
            <div class="req-row-main">
              <span class="req-row-name">${escapeHtml(r.name || 'â€”')}${r.person2_name ? ' & ' + escapeHtml(r.person2_name) : ''}</span>
              <span class="req-row-meta">${escapeHtml(r.mode || 'single')} Â· ${dateStr}</span>
            </div>
            <span class="req-row-status ${statusClass(gs)}" style="font-size:10px;padding:2px 8px;">${statusLabel(gs)}</span>
            ${paymentMethodBadge(r)}
            <div class="req-row-btns" onclick="event.stopPropagation()">
              <button class="rmb rmb-orange" onclick="restart('${safeId}',this)" title="${gs === 'completed' ? 'ĞŸĞµÑ€ĞµĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ' : 'ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ'}">â†»</button>
              ${isPendingPay ? `<button class="rmb rmb-green" onclick="markPaid('${safeId}')" title="ĞÑ‚Ğ¼ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ¾Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¼">âœ“ ĞĞ¿Ğ»Ğ°Ñ‡ĞµĞ½</button>` : ''}
              ${gs === 'pending_payment' ? `<button class="rmb rmb-red" onclick="cancelRequest('${safeId}', this)" title="ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ">âœ•</button>` : ''}
              ${r.audio_url ? `<button class="rmb rmb-green" onclick="window.open('${r.audio_url.replace(/'/g,"\\'")}');event.stopPropagation();" title="Ğ¡Ğ»ÑƒÑˆĞ°Ñ‚ÑŒ Ğ°ÑƒĞ´Ğ¸Ğ¾">â–¶</button>` : ''}
              ${r.audio_url ? `<button class="rmb rmb-blue" onclick="deliver('${safeId}',this);event.stopPropagation();" title="ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ">ğŸ“¤</button>` : ''}
            </div>
            <span class="req-chevron">â€º</span>
          </div>
          <div class="req-row-body" id="req-body-${safeIdAttr}">
          </div>
        </div>`;
      }).join('');
      const bulkBar = document.getElementById('bulkActionsBar');
      const selectAllCb = document.getElementById('selectAllRequests');
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      const countSpan = document.getElementById('deleteSelectedCount');
      if (bulkBar) bulkBar.style.display = data.length ? 'flex' : 'none';
      function updateBulkButton() {
        const checkboxes = document.querySelectorAll('#requests .req-select-cb');
        const checked = document.querySelectorAll('#requests .req-select-cb:checked');
        const n = checked.length;
        const total = checkboxes.length;
        if (countSpan) countSpan.textContent = n;
        if (deleteBtn) { deleteBtn.disabled = n === 0; }
        if (selectAllCb) { selectAllCb.checked = total > 0 && n === total; selectAllCb.indeterminate = n > 0 && n < total; }
      }
      function attachBulkListeners() {
        if (!data.length) return;
        if (selectAllCb) {
          selectAllCb.onchange = function() {
            document.querySelectorAll('#requests .req-select-cb').forEach(function(cb) { cb.checked = selectAllCb.checked; });
            updateBulkButton();
          };
        }
        document.querySelectorAll('#requests .req-select-cb').forEach(function(cb) {
          cb.onchange = updateBulkButton;
        });
        if (deleteBtn) {
          deleteBtn.onclick = async function() {
            const ids = Array.from(document.querySelectorAll('#requests .req-select-cb:checked')).map(function(cb) { return cb.getAttribute('data-request-id'); }).filter(Boolean);
            if (!ids.length) return;
            if (!confirm('Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸Ğ· ÑĞ¿Ğ¸ÑĞºĞ° ' + ids.length + ' Ğ·Ğ°ÑĞ²Ğ¾Ğº? ĞĞ½Ğ¸ Ğ±ÑƒĞ´ÑƒÑ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ Ğ±ĞµĞ·Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ½Ğ¾.')) return;
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµâ€¦';
            try {
              const result = await fetchJson(API_BASE + '/api/admin/requests/delete' + authQueryFromPath(), { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify({ ids: ids }) });
              const json = result.json;
              if (json.success) { alert('Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ Ğ·Ğ°ÑĞ²Ğ¾Ğº: ' + (json.deleted || ids.length)); refreshAfterAction(); }
              else alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + (json.error || 'unknown'));
            } catch (e) {
              alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + (e && e.message ? e.message : e));
            } finally {
              deleteBtn.disabled = false;
              deleteBtn.innerHTML = 'ğŸ—‘ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ (<span id="deleteSelectedCount">0</span>)';
              var span = document.getElementById('deleteSelectedCount');
              if (span) span.textContent = '0';
            }
          };
        }
        updateBulkButton();
      }
      attachBulkListeners();
    }
    function escapeHtml(s) {
      if (s == null) return '';
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function escapeAttr(s) {
      return String(s == null ? '' : s).replace(/"/g, '&quot;');
    }

    // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ Ğ½ĞµĞ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°ÑĞ²ĞºĞ¸ (pending_payment) Ğ² Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½ÑƒÑ ÑĞµĞºÑ†Ğ¸Ñ Ğ²Ğ²ĞµÑ€Ñ…Ñƒ
    async function loadUnpaidRequests(silent) {
      const section = document.getElementById('unpaidSection');
      const list = document.getElementById('unpaidList');
      const badge = document.getElementById('unpaidBadge');
      if (!list) return;
      if (!silent) list.innerHTML = '<div class="loading"><div class="spinner"></div>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦</div>';
      try {
        const result = await fetchJson(
          API_BASE + '/api/admin/requests?status=pending_payment&limit=50' + authQuery(),
          { headers: authHeaders() }
        );
        const items = (result.json && (result.json.data || result.json.requests)) || [];
        if (badge) badge.textContent = items.length;
        if (!items.length) {
          if (section) section.classList.remove('has-items');
          list.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">âœ… ĞĞµĞ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ñ… Ğ·Ğ°ÑĞ²Ğ¾Ğº Ğ½ĞµÑ‚</div>';
          return;
        }
        if (section) section.classList.add('has-items');
        list.innerHTML = items.map(function(r) {
          const id = escapeHtml(r.id || '');
          const idShort = (r.id || '').substring(0, 8);
          const name = escapeHtml(r.name || 'â€”');
          const date = r.created_at ? new Date(r.created_at).toLocaleString('ru-RU') : 'â€”';
          const amount = r.payment_amount ? (r.payment_amount + ' ' + (r.payment_currency || 'USDT')) : 'â€”';
          const safeId = (r.id || '').replace(/'/g, "\\'");
          return '<div class="unpaid-card">' +
            '<div class="unpaid-info">' +
              '<div class="unpaid-name">' + name + '</div>' +
              '<div class="unpaid-meta">' +
                'ID: <code>' + escapeHtml(idShort) + '</code> Â· ' + date + '<br>' +
                'Ğ¡ÑƒĞ¼Ğ¼Ğ°: ' + escapeHtml(amount) + ' Â· Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹: ' + escapeHtml(r.payment_status || 'â€”') +
              '</div>' +
            '</div>' +
            '<div class="unpaid-actions">' +
              '<button class="btn btn-restore" style="min-width:120px;padding:8px 12px;font-size:13px;" onclick="restoreRequest(\'' + safeId + '\', this)" title="Ğ—Ğ°ÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ ĞºĞ°Ğº Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ">ğŸ”„ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ</button>' +
              '<button class="btn btn-success" style="min-width:110px;padding:8px 12px;font-size:13px;" onclick="markPaid(\'' + safeId + '\')">âœ… ĞĞ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾</button>' +
              '<button class="btn btn-cancel" style="min-width:110px;padding:8px 12px;font-size:13px;" onclick="cancelRequest(\'' + safeId + '\', this)">âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ</button>' +
              '<button class="btn btn-danger" style="min-width:90px;padding:8px 12px;font-size:13px;background:#7f1d1d;border-color:#991b1b;color:#fca5a5;" onclick="deleteUnpaidRequest(\'' + safeId + '\', this)" title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°ÑĞ²ĞºÑƒ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°">ğŸ—‘ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ</button>' +
            '</div>' +
          '</div>';
        }).join('');
      } catch (e) {
        if (section) section.classList.remove('has-items');
        list.innerHTML = '<div style="color:#e74c3c;padding:10px;">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸: ' + escapeHtml((e && e.message) || String(e)) + '</div>';
      }
    }

    // ĞÑ‚Ğ¼ĞµĞ½Ğ° Ğ·Ğ°ÑĞ²ĞºĞ¸ Ğ¸Ğ· Ğ°Ğ´Ğ¼Ğ¸Ğ½ĞºĞ¸
    async function cancelRequest(id, btn) {
      if (!confirm('ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ·Ğ°ÑĞ²ĞºÑƒ ' + id.substring(0, 8) + '? ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑƒĞ²Ğ¸Ğ´Ğ¸Ñ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑ Â«ĞÑ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°Â».')) return;
      if (btn) { btn.disabled = true; btn.textContent = 'ĞÑ‚Ğ¼ĞµĞ½Ğ°â€¦'; }
      try {
        const result = await fetchJson(
          API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + '/cancel' + authQueryFromPath(),
          { method: 'POST', headers: authHeaders() }
        );
        if (result.json && result.json.success) {
          alert('âœ… Ğ—Ğ°ÑĞ²ĞºĞ° Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°');
          await refreshAfterAction();
        } else {
          alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + ((result.json && result.json.error) || 'Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾'));
          if (btn) { btn.disabled = false; btn.textContent = 'âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ'; }
        }
      } catch (e) {
        alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + ((e && e.message) || String(e)));
        if (btn) { btn.disabled = false; btn.textContent = 'âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ'; }
      }
    }

    // Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°ÑĞ²ĞºĞ¸ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°
    async function deleteUnpaidRequest(id, btn) {
      if (!confirm('Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°ÑĞ²ĞºÑƒ ' + id.substring(0, 8) + ' ĞĞĞ’Ğ¡Ğ•Ğ“Ğ”Ğ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹?\nĞ­Ñ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ.')) return;
      if (btn) { btn.disabled = true; btn.textContent = 'â³'; }
      try {
        const result = await fetchJson(
          API_BASE + '/api/admin/requests/delete' + authQueryFromPath(),
          { method: 'POST', headers: { ...authHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ ids: [id] }) }
        );
        if (result.json && result.json.success) {
          // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºÑƒ Ğ±ĞµĞ· Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ²ÑĞµĞ³Ğ¾ ÑĞ¿Ğ¸ÑĞºĞ°
          const card = btn && btn.closest('.unpaid-card');
          if (card) {
            card.style.transition = 'opacity 0.3s';
            card.style.opacity = '0';
            setTimeout(function() {
              card.remove();
              // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº
              const remaining = document.querySelectorAll('#unpaidList .unpaid-card').length;
              const badge = document.getElementById('unpaidBadge');
              if (badge) badge.textContent = remaining;
              if (!remaining) {
                const section = document.getElementById('unpaidSection');
                if (section) section.classList.remove('has-items');
                const list = document.getElementById('unpaidList');
                if (list) list.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">âœ… ĞĞµĞ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ñ… Ğ·Ğ°ÑĞ²Ğ¾Ğº Ğ½ĞµÑ‚</div>';
              }
            }, 300);
          }
        } else {
          alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + ((result.json && result.json.error) || 'Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾'));
          if (btn) { btn.disabled = false; btn.textContent = 'ğŸ—‘ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ'; }
        }
      } catch (e) {
        alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + ((e && e.message) || String(e)));
        if (btn) { btn.disabled = false; btn.textContent = 'ğŸ—‘ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ'; }
      }
    }

    async function loadMonetizationData() {
      const pricingBody = document.getElementById('pricingTableBody');
      const promoBody = document.getElementById('promoTableBody');
      const paymentsBody = document.getElementById('paymentsTableBody');
      if (pricingBody) pricingBody.innerHTML = '<tr><td colspan="7" class="mono-muted">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦</td></tr>';
      if (promoBody) promoBody.innerHTML = '<tr><td colspan="10" class="mono-muted">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦</td></tr>';
      if (paymentsBody) paymentsBody.innerHTML = '<tr><td colspan="10" class="mono-muted">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦</td></tr>';
      setMonoMsg('monetizationGlobalMsg', 'ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑÑ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ½ĞµÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸â€¦', null);
      try {
        const [pricingResult, promoResult, paymentsResult] = await Promise.all([
          fetchJson(API_BASE + '/api/admin/pricing' + authQueryFromPath(), { headers: authHeaders() }),
          fetchJson(API_BASE + '/api/admin/promos' + authQueryFromPath(), { headers: authHeaders() }),
          fetchJson(API_BASE + '/api/admin/payments?limit=100' + authQuery(), { headers: authHeaders() }),
        ]);
        renderPricingRows((pricingResult.json && pricingResult.json.catalog) || []);
        renderPromoRows((promoResult.json && promoResult.json.data) || []);
        renderPaymentsRows((paymentsResult.json && paymentsResult.json.data) || []);
        setMonoMsg('monetizationGlobalMsg', 'Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ½ĞµÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹.', true);
      } catch (e) {
        setMonoMsg('monetizationGlobalMsg', 'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¼Ğ¾Ğ½ĞµÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ: ' + ((e && e.message) || String(e)), false);
      }
    }

    async function loadReferralData() {
      const body = document.getElementById('referralsTableBody');
      if (body) body.innerHTML = '<tr><td colspan="5" class="mono-muted">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦</td></tr>';
      try {
        const result = await fetchJson(API_BASE + '/api/admin/referrals' + authQueryFromPath(), { headers: authHeaders() });
        const json = result.json;
        if (json && json.success) {
          const totalEl = document.getElementById('refTotalCount');
          const rewEl = document.getElementById('refRewardedCount');
          if (totalEl) totalEl.textContent = json.total || 0;
          if (rewEl) rewEl.textContent = json.rewarded || 0;
          renderReferralRows(json.rows || []);
          setMonoMsg('referralsMsg', 'Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹.', true);
        } else {
          setMonoMsg('referralsMsg', 'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²: ' + ((json && json.error) || 'unknown'), false);
        }
      } catch (e) {
        setMonoMsg('referralsMsg', 'ĞÑˆĞ¸Ğ±ĞºĞ°: ' + ((e && e.message) || String(e)), false);
      }
    }

    function renderReferralRows(rows) {
      const body = document.getElementById('referralsTableBody');
      if (!body) return;
      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="5" class="mono-muted">Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚.</td></tr>';
        return;
      }
      body.innerHTML = rows.map(function(r) {
        const dateCreated = r.created_at ? new Date(r.created_at).toLocaleString('ru-RU') : 'â€”';
        const dateActivated = r.activated_at ? new Date(r.activated_at).toLocaleString('ru-RU') : 'â€”';
        const rewardBadge = r.reward_granted
          ? '<span style="color:#22c55e;font-weight:600;">âœ“ Ğ’Ñ‹Ğ´Ğ°Ğ½Ğ°</span>'
          : '<span style="color:#f59e0b;">â³ Ğ–Ğ´Ñ‘Ñ‚</span>';
        return '<tr>' +
          '<td><code>' + escapeHtml(String(r.referrer_id || 'â€”')) + '</code></td>' +
          '<td><code>' + escapeHtml(String(r.referee_id || 'â€”')) + '</code></td>' +
          '<td class="mono-muted">' + escapeHtml(dateCreated) + '</td>' +
          '<td class="mono-muted">' + escapeHtml(dateActivated) + '</td>' +
          '<td>' + rewardBadge + '</td>' +
          '</tr>';
      }).join('');
    }

    function renderPricingRows(rows) {
      const body = document.getElementById('pricingTableBody');
      if (!body) return;
      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="7" class="mono-muted">Ğ¢Ğ°Ñ€Ğ¸Ñ„Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.</td></tr>';
        return;
      }
      body.innerHTML = rows.map(function(item) {
        const sku = escapeHtml(item.sku || '');
        const limits = item.limits_json && typeof item.limits_json === 'object' ? JSON.stringify(item.limits_json) : (item.limits_json || '{}');
        return '<tr data-sku="' + sku + '">' +
          '<td><code>' + sku + '</code></td>' +
          '<td><input data-field="title" value="' + escapeAttr(item.title || '') + '"></td>' +
          '<td><input type="number" step="0.01" min="0" data-field="price" value="' + escapeAttr(item.price || 0) + '"></td>' +
          '<td><input data-field="currency" value="' + escapeAttr(item.currency || 'USDT') + '"></td>' +
          '<td style="text-align:center;"><input type="checkbox" data-field="active" ' + (item.active === false ? '' : 'checked') + '></td>' +
          '<td><input data-field="limits_json" value="' + escapeAttr(limits) + '"></td>' +
          '<td><button class="btn btn-primary" style="min-width:120px;padding:8px 12px;font-size:12px;" onclick="savePricingRow(\'' + escapeAttr(item.sku || '') + '\')">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button></td>' +
          '</tr>';
      }).join('');
    }

    function promoTypeLabel(type) {
      if (type === 'discount_percent') return '% ÑĞºĞ¸Ğ´ĞºĞ°';
      if (type === 'discount_amount') return '$ ÑĞºĞ¸Ğ´ĞºĞ°';
      if (type === 'free_generation') return 'ğŸ Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾';
      return type || 'â€”';
    }
    function renderPromoRows(rows) {
      const body = document.getElementById('promoTableBody');
      if (!body) return;
      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="9" class="mono-muted">ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ½ĞµÑ‚. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ²Ñ‹ÑˆĞµ â†‘</td></tr>';
        return;
      }
      body.innerHTML = rows.map(function(item) {
        const code = escapeHtml(item.code || '');
        const expiresLabel = item.expires_at ? new Date(item.expires_at).toLocaleString('ru-RU') : 'âˆ';
        const usedOf = (item.used_count == null ? 0 : item.used_count) + ' / ' + (item.max_uses == null ? 'âˆ' : item.max_uses);
        const valueLabel = item.type === 'free_generation' ? 'â€”' : (item.value != null ? String(item.value) + (item.type === 'discount_percent' ? '%' : ' USDT') : 'â€”');
        const activeLabel = item.active !== false
          ? '<span style="color:#22c55e;font-weight:600;">âœ“ Ğ”Ğ°</span>'
          : '<span style="color:#ef4444;">âœ— ĞĞµÑ‚</span>';
        return '<tr data-code="' + code + '">' +
          '<td><code style="font-size:1rem;color:#d4af37;">' + code + '</code></td>' +
          '<td>' + escapeHtml(promoTypeLabel(item.type)) + '</td>' +
          '<td>' + escapeHtml(valueLabel) + '</td>' +
          '<td>' + escapeHtml(item.sku || 'Ğ²ÑĞµ') + '</td>' +
          '<td>' + escapeHtml(usedOf) + ' (Ğ½Ğ° 1 ÑĞ·ĞµÑ€Ğ°: ' + (item.per_user_limit || 1) + ')</td>' +
          '<td>' + activeLabel + '</td>' +
          '<td class="mono-muted">' + escapeHtml(expiresLabel) + '</td>' +
          '<td style="font-weight:600;">' + escapeHtml(String(item.used_count == null ? 0 : item.used_count)) + '</td>' +
          '<td style="display:flex;gap:6px;flex-wrap:wrap;">' +
            '<button class="btn btn-primary" style="padding:6px 12px;font-size:12px;" onclick="togglePromoActive(\'' + escapeAttr(item.code || '') + '\',' + (item.active !== false) + ')">' +
              (item.active !== false ? 'â¸ Ğ”ĞµĞ°ĞºÑ‚.' : 'â–¶ ĞĞºÑ‚Ğ¸Ğ².') +
            '</button>' +
            '<button class="btn" style="padding:6px 12px;font-size:12px;background:#ef4444;border-color:#ef4444;color:#fff;" onclick="deletePromo(\'' + escapeAttr(item.code || '') + '\')">ğŸ—‘ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ</button>' +
          '</td>' +
          '</tr>';
      }).join('');
    }

    function renderPaymentsRows(rows) {
      const body = document.getElementById('paymentsTableBody');
      if (!body) return;
      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="10" class="mono-muted">ĞĞ¿Ğ»Ğ°Ñ‚Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.</td></tr>';
        return;
      }
      body.innerHTML = rows.map(function(item) {
        const created = item.created_at ? new Date(item.created_at).toLocaleString('ru-RU') : 'â€”';
        const reqId = String(item.id || '');
        const orderId = String(item.payment_order_id || '');
        const txId = String(item.payment_tx_id || '');
        const amount = item.payment_amount != null ? (String(item.payment_amount) + ' ' + (item.payment_currency || 'USDT')) : 'â€”';
        // Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ± Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ â€” Ğ¿Ğ¾Ğ½ÑÑ‚Ğ½Ñ‹Ğ¹ Ğ±ĞµĞ¹Ğ´Ğ¶
        const methodBadge = paymentMethodBadge(item);
        // Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ â€” Ğ¿Ğ¾Ğ½ÑÑ‚Ğ½Ñ‹Ğ¹
        const ps = String(item.payment_status || '').toLowerCase();
        const statusColor = ['paid','gift_used','subscription_active'].includes(ps) ? '#22c55e' : (ps === 'requires_payment' ? '#f59e0b' : '#94a3b8');
        const statusHuman = ps === 'paid' ? 'âœ“ ĞĞ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾' : ps === 'gift_used' ? 'ğŸ ĞŸĞ¾Ğ´Ğ°Ñ€Ğ¾Ğº' : ps === 'subscription_active' ? 'ğŸ“‹ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°' : ps === 'requires_payment' ? 'â³ ĞĞ¶Ğ¸Ğ´Ğ°ĞµÑ‚' : escapeHtml(ps || 'â€”');
        const promo = item.promo_code ? '<span style="color:#d4af37;font-weight:600;">' + escapeHtml(item.promo_code) + '</span>' + (item.promo_discount_amount ? ' <span style="color:#94a3b8;">(-' + escapeHtml(String(item.promo_discount_amount)) + ')</span>' : '') : 'â€”';
        return '<tr>' +
          '<td style="font-size:11px;">' + escapeHtml(created) + '</td>' +
          '<td><code title="' + escapeAttr(reqId) + '">' + escapeHtml(reqId.slice(0, 8)) + '</code></td>' +
          '<td>' + escapeHtml(item.name || 'â€”') + '</td>' +
          '<td>' + escapeHtml(item.mode || 'â€”') + '</td>' +
          '<td>' + methodBadge + '</td>' +
          '<td style="color:' + statusColor + ';font-weight:600;font-size:12px;">' + statusHuman + '</td>' +
          '<td style="font-weight:600;">' + escapeHtml(amount) + '</td>' +
          '<td title="' + escapeAttr(orderId) + '" style="font-size:11px;">' + escapeHtml(orderId ? orderId.slice(0, 12) + 'â€¦' : 'â€”') + '</td>' +
          '<td title="' + escapeAttr(txId) + '" style="font-size:11px;">' + escapeHtml(txId ? txId.slice(0, 12) + 'â€¦' : 'â€”') + '</td>' +
          '<td>' + promo + '</td>' +
          '</tr>';
      }).join('');
    }

    async function savePricingRow(sku) {
      const row = Array.from(document.querySelectorAll('#pricingTableBody tr')).find(function(r) {
        return r.getAttribute('data-sku') === sku;
      });
      if (!row) return;
      const titleEl = row.querySelector('[data-field="title"]');
      const priceEl = row.querySelector('[data-field="price"]');
      const currencyEl = row.querySelector('[data-field="currency"]');
      const activeEl = row.querySelector('[data-field="active"]');
      const limitsEl = row.querySelector('[data-field="limits_json"]');
      let limitsJson = {};
      try {
        limitsJson = limitsEl && String(limitsEl.value || '').trim() ? JSON.parse(limitsEl.value) : {};
      } catch (_) {
        setMonoMsg('pricingMsg', 'ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ JSON Ğ² limits_json Ğ´Ğ»Ñ SKU ' + sku, false);
        return;
      }
      const payload = {
        title: titleEl ? titleEl.value : sku,
        price: priceEl ? Number(priceEl.value || 0) : 0,
        currency: currencyEl ? String(currencyEl.value || 'USDT').toUpperCase() : 'USDT',
        active: !!(activeEl && activeEl.checked),
        limits_json: limitsJson,
      };
      setMonoMsg('pricingMsg', 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑÑ Ñ‚Ğ°Ñ€Ğ¸Ñ„ ' + sku + 'â€¦', null);
      try {
        const result = await fetchJson(API_BASE + '/api/admin/pricing/' + encodeURIComponent(sku) + authQueryFromPath(), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(payload),
        });
        if (result.json && result.json.success) {
          setMonoMsg('pricingMsg', 'Ğ¢Ğ°Ñ€Ğ¸Ñ„ ' + sku + ' ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½.', true);
          await loadMonetizationData();
        } else {
          setMonoMsg('pricingMsg', 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ° ' + sku + ': ' + ((result.json && result.json.error) || 'unknown'), false);
        }
      } catch (e) {
        setMonoMsg('pricingMsg', 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ° ' + sku + ': ' + ((e && e.message) || String(e)), false);
      }
    }

    async function savePromoRow(code) {
      const row = Array.from(document.querySelectorAll('#promoTableBody tr')).find(function(r) {
        return r.getAttribute('data-code') === code;
      });
      if (!row) return;
      const typeEl = row.querySelector('[data-field="type"]');
      const valueEl = row.querySelector('[data-field="value"]');
      const skuEl = row.querySelector('[data-field="sku"]');
      const maxUsesEl = row.querySelector('[data-field="max_uses"]');
      const perUserEl = row.querySelector('[data-field="per_user_limit"]');
      const activeEl = row.querySelector('[data-field="active"]');
      const payload = {
        type: typeEl ? typeEl.value : 'discount_percent',
        value: valueEl && String(valueEl.value).trim() ? Number(valueEl.value) : null,
        sku: skuEl && String(skuEl.value).trim() ? String(skuEl.value).trim() : null,
        max_uses: maxUsesEl && String(maxUsesEl.value).trim() ? Number(maxUsesEl.value) : null,
        per_user_limit: perUserEl && String(perUserEl.value).trim() ? Number(perUserEl.value) : 1,
        active: !!(activeEl && activeEl.checked),
      };
      setMonoMsg('promoMsg', 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑÑ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ' + code + 'â€¦', null);
      try {
        const result = await fetchJson(API_BASE + '/api/admin/promos/' + encodeURIComponent(code) + authQueryFromPath(), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(payload),
        });
        if (result.json && result.json.success) {
          setMonoMsg('promoMsg', 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ' + code + ' ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½.', true);
          await loadMonetizationData();
        } else {
          setMonoMsg('promoMsg', 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° ' + code + ': ' + ((result.json && result.json.error) || 'unknown'), false);
        }
      } catch (e) {
        setMonoMsg('promoMsg', 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° ' + code + ': ' + ((e && e.message) || String(e)), false);
      }
    }

    async function createPromoCode() {
      const code = (document.getElementById('newPromoCode').value || '').trim().toUpperCase();
      if (!code) { setMonoMsg('promoMsg', 'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ´ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°', false); return; }
      const type = document.getElementById('newPromoType').value;
      const valueRaw = document.getElementById('newPromoValue').value.trim();
      const skuRaw = document.getElementById('newPromoSku').value.trim();
      const maxUsesRaw = document.getElementById('newPromoMaxUses').value.trim();
      const perUserRaw = document.getElementById('newPromoPerUser').value.trim();
      const startsAt = document.getElementById('newPromoStartsAt').value || null;
      const expiresAt = document.getElementById('newPromoExpiresAt').value || null;
      const active = document.getElementById('newPromoActive').checked;
      const payload = {
        type,
        value: valueRaw ? Number(valueRaw) : null,
        sku: skuRaw || null,
        max_uses: maxUsesRaw ? Number(maxUsesRaw) : null,
        per_user_limit: perUserRaw ? Number(perUserRaw) : 1,
        active,
        starts_at: startsAt ? new Date(startsAt).toISOString() : null,
        expires_at: expiresAt ? new Date(expiresAt).toISOString() : null,
      };
      setMonoMsg('promoMsg', 'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ' + code + 'â€¦', null);
      try {
        const result = await fetchJson(API_BASE + '/api/admin/promos/' + encodeURIComponent(code) + authQueryFromPath(), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(payload),
        });
        if (result.json && result.json.success) {
          setMonoMsg('promoMsg', 'âœ… ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ' + code + ' ÑĞ¾Ğ·Ğ´Ğ°Ğ½!', true);
          document.getElementById('newPromoCode').value = '';
          document.getElementById('newPromoValue').value = '';
          document.getElementById('newPromoSku').value = '';
          document.getElementById('newPromoMaxUses').value = '';
          document.getElementById('newPromoStartsAt').value = '';
          document.getElementById('newPromoExpiresAt').value = '';
          document.getElementById('newPromoDetails').removeAttribute('open');
          await loadMonetizationData();
        } else {
          setMonoMsg('promoMsg', 'âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ' + ((result.json && result.json.error) || 'unknown'), false);
        }
      } catch(e) {
        setMonoMsg('promoMsg', 'âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ' + (e && e.message || String(e)), false);
      }
    }

    async function togglePromoActive(code, currentlyActive) {
      setMonoMsg('promoMsg', (currentlyActive ? 'Ğ”ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒÑ' : 'ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒÑ') + ' Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ' + code + 'â€¦', null);
      try {
        const result = await fetchJson(API_BASE + '/api/admin/promos/' + encodeURIComponent(code) + authQueryFromPath(), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({ active: !currentlyActive }),
        });
        if (result.json && result.json.success) {
          setMonoMsg('promoMsg', 'âœ… ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ' + code + (currentlyActive ? ' Ğ´ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½' : ' Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½'), true);
          await loadMonetizationData();
        } else {
          setMonoMsg('promoMsg', 'âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ' + ((result.json && result.json.error) || 'unknown'), false);
        }
      } catch(e) {
        setMonoMsg('promoMsg', 'âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ' + (e && e.message || String(e)), false);
      }
    }

    async function deletePromo(code) {
      if (!confirm('Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ' + code + '? Ğ­Ñ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ.')) return;
      setMonoMsg('promoMsg', 'Ğ£Ğ´Ğ°Ğ»ÑÑ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ' + code + 'â€¦', null);
      try {
        const result = await fetchJson(API_BASE + '/api/admin/promos/' + encodeURIComponent(code) + authQueryFromPath(), {
          method: 'DELETE',
          headers: authHeaders(),
        });
        if (result.json && result.json.success) {
          setMonoMsg('promoMsg', 'âœ… ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ' + code + ' ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½.', true);
          await loadMonetizationData();
        } else {
          setMonoMsg('promoMsg', 'âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ' + ((result.json && result.json.error) || 'unknown'), false);
        }
      } catch(e) {
        setMonoMsg('promoMsg', 'âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ' + (e && e.message || String(e)), false);
      }
    }

    // Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°ÑÑ‚Ñ€ÑĞ²ÑˆÑƒÑ Ğ·Ğ°ÑĞ²ĞºÑƒ: Ğ·Ğ°ÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ ĞºĞ°Ğº Ğ¾Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ½ÑƒÑ Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ
    window.restoreRequest = async function restoreRequest(id, btn) {
      if (!confirm('Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°ÑĞ²ĞºÑƒ ' + id.substring(0, 8) + '?\n\nĞ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ: Ğ¾Ñ‚Ğ¼ĞµÑ‚Ğ¸Ñ‚ÑŒ ĞºĞ°Ğº Ğ¾Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ½ÑƒÑ (Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€: admin) Ğ¸ Ğ½ĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ.')) return;
      if (btn) { btn.disabled = true; btn.textContent = 'â³ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµâ€¦'; }
      try {
        // 1. markPaid
        const paid = await fetchJson(API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + '/mark-paid' + authQueryFromPath(), {
          method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify({ provider: 'admin' })
        });
        if (!paid.json || !paid.json.success) {
          alert('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¼ĞµÑ‚ĞºĞµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹: ' + ((paid.json && paid.json.error) || 'unknown'));
          if (btn) { btn.disabled = false; btn.textContent = 'ğŸ”„ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ'; }
          return;
        }
        // 2. restart
        const restarted = await fetchJson(API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + '/restart' + authQueryFromPath(), {
          method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() }
        });
        if (restarted.json && restarted.json.success) {
          alert('âœ… Ğ—Ğ°ÑĞ²ĞºĞ° Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ğ¸ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ°!');
          await refreshAfterAction();
        } else {
          alert('ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ·Ğ°ÑÑ‡Ğ¸Ñ‚Ğ°Ğ½Ğ°, Ğ½Ğ¾ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº Ğ½Ğµ ÑƒĞ´Ğ°Ğ»ÑÑ: ' + ((restarted.json && restarted.json.error) || 'unknown'));
          await refreshAfterAction();
        }
      } catch (e) {
        alert('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ: ' + ((e && e.message) || String(e)));
        if (btn) { btn.disabled = false; btn.textContent = 'ğŸ”„ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ'; }
      }
    };

    window.savePricingRow = savePricingRow;
    window.savePromoRow = savePromoRow;
    window.createPromoCode = createPromoCode;
    window.togglePromoActive = togglePromoActive;
    window.deletePromo = deletePromo;
    window.filterByCard = filterByCard;
    window.setSort = setSort;
    window.setPayFilter = setPayFilter;

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        currentFilter = this.getAttribute('data-filter') || 'all';
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        // Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºÑƒ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº
        document.querySelectorAll('.stat-card').forEach(c => {
          c.classList.toggle('active-filter', c.getAttribute('data-filter') === currentFilter);
        });
        refreshAfterAction();
      });
    });

    document.getElementById('settings-save-btn')?.addEventListener('click', async function() {
      const input = document.getElementById('settings-max-tokens');
      const modelEl = document.getElementById('settings-model');
      const tempEl = document.getElementById('settings-temperature');
      const statusEl = document.getElementById('settings-save-status');
      if (!input || !statusEl) return;
      const val = Math.min(65536, Math.max(4096, Number(input.value) || 8192));
      input.value = val;
      const modelVal = (modelEl && modelEl.value) ? modelEl.value.trim() : '';
      const tempVal = (tempEl && tempEl.value !== '') ? Math.max(0, Math.min(2, Number(tempEl.value))) : 1.5;
      if (tempEl) tempEl.value = tempVal;
      statusEl.textContent = 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµâ€¦';
      statusEl.style.color = '#94a3b8';
      try {
        const body = { deepseek_max_tokens: val, deepseek_temperature: tempVal };
        if (modelVal) body.deepseek_model = modelVal;
        const result = await fetchJson(API_BASE + '/api/admin/settings' + authQueryFromPath(), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(body)
        });
        const json = result.json;
        if (json.success) { statusEl.textContent = 'âœ… Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾'; statusEl.style.color = '#86efac'; setTimeout(() => { statusEl.textContent = ''; }, 3000); }
        else { statusEl.textContent = 'âŒ ' + (json.error || 'ĞÑˆĞ¸Ğ±ĞºĞ°'); statusEl.style.color = '#e74c3c'; }
      } catch (e) {
        statusEl.textContent = 'âŒ ' + (e && e.message ? e.message : 'ĞÑˆĞ¸Ğ±ĞºĞ°');
        statusEl.style.color = '#e74c3c';
      }
    });
    document.getElementById('monetization-refresh-btn')?.addEventListener('click', function() {
      loadMonetizationData();
    });

    window.showDetails = async function showDetails(id) {
      const url = API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + authQueryFromPath();
      let json, res;
      try {
        const result = await fetchJson(url, { headers: authHeaders() });
        res = result.res;
        json = result.json;
      } catch (e) {
        const msg = (e && e.message ? e.message : 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸');
        const hint = msg === 'Failed to fetch'
          ? 'Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ½Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¸Ğ» (ÑĞµÑ‚ÑŒ Ğ¸Ğ»Ğ¸ Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ½Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ€Ñ‚ Render). ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ 30 ÑĞµĞº Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Â«ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½ĞµĞµÂ» ÑĞ½Ğ¾Ğ²Ğ°.'
          : 'ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½ĞºÑƒ Ğ¿Ğ¾ ÑÑÑ‹Ğ»ĞºĞµ Ğ¸Ğ· Ğ±Ğ¾Ñ‚Ğ° (/admin).';
        alert('âŒ ' + msg + '\n\n' + hint);
        return;
      }
      if (!json.success || !json.data) {
        alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸: ' + (json.error || res.status || 'Load error'));
        return;
      }
      const r = json.data;
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;overflow:auto;';
      const astroText = (r.astro_snapshot_text || '').trim();
      const astroJson = (r.astro_snapshot_json && typeof r.astro_snapshot_json === 'object') ? JSON.stringify(r.astro_snapshot_json, null, 2) : '';
      const astroBlock = astroText
        ? '<div class="details-section" style="margin-bottom:24px;"><div class="section-title" style="color:#67e8f9;">ğŸª Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ°ÑÑ‚Ñ€Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€Ğ°</div>' +
          '<div class="content-text" style="max-height:40vh;overflow-y:auto;white-space:pre-wrap;word-break:break-word;font-size:13px;line-height:1.5;background:#0f0f1b;padding:16px;border-radius:8px;border:1px solid #333;">' + escapeHtml(astroText) + '</div>' +
          (astroJson ? '<details style="margin-top:10px;"><summary style="cursor:pointer;color:#94a3b8;">ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ JSON ÑĞ½Ğ°Ğ¿ÑˆĞ¾Ñ‚Ğ°</summary><div class="content-text" style="margin-top:8px;max-height:30vh;overflow-y:auto;white-space:pre-wrap;word-break:break-word;font-size:12px;line-height:1.4;background:#0f0f1b;padding:12px;border-radius:8px;border:1px solid #333;">' + escapeHtml(astroJson) + '</div></details>' : '') +
          '</div>'
        : '<div class="details-section"><div class="section-title" style="color:#67e8f9;">ğŸª Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ°ÑÑ‚Ñ€Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€Ğ°</div><div class="content-text" style="color:#94a3b8;">Ğ¡Ğ½Ğ°Ğ¿ÑˆĞ¾Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚ ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½ Ğ¸Ğ»Ğ¸ Ğ² Ğ‘Ğ” Ğ½ĞµÑ‚ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ¹ Ğ·Ğ°ÑĞ²ĞºĞ¸.</div></div>';
      const deepseekFull = (r.deepseek_response || '').trim();
      const genStatus = r.generation_status || r.status || 'pending';
      const genError = (r.error_message || '').trim();
      const dsReason = r.deepseek_missing_reason || '';
      const steps = normalizeSteps(r.generation_steps);
      const stepMap = [
        ['request_loaded', 'Ğ—Ğ°ÑĞ²ĞºĞ° Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ğ°'],
        ['astro_start', 'Ğ¡Ñ‚Ğ°Ñ€Ñ‚ Ğ°ÑÑ‚Ñ€Ğ¾Ğ±Ğ»Ğ¾ĞºĞ°'],
        ['astro_snapshot_saved', 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ÑĞ½Ğ°Ğ¿ÑˆĞ¾Ñ‚Ğ°'],
        ['astro_extensions', 'D-ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ¸ Ğ”Ğ°ÑˆĞ¸'],
        ['couple_second_snapshot', 'Ğ’Ñ‚Ğ¾Ñ€Ğ¾Ğ¹ ÑĞ½Ğ°Ğ¿ÑˆĞ¾Ñ‚ (Ğ¿Ğ°Ñ€Ğ°)'],
        ['prompt_compiled', 'ĞŸÑ€Ğ¾Ğ¼Ñ‚ ÑĞ¾Ğ±Ñ€Ğ°Ğ½'],
        ['llm_request_start', 'Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ² DeepSeek'],
        ['llm_response_ready', 'ĞÑ‚Ğ²ĞµÑ‚ DeepSeek'],
        ['llm_response_saved', 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ DeepSeek'],
        ['lyrics_ready', 'Ğ›Ğ¸Ñ€Ğ¸ĞºĞ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ°'],
        ['suno_start', 'Ğ¡Ñ‚Ğ°Ñ€Ñ‚ Suno'],
        ['suno_task_created', 'Suno task'],
        ['audio_ready', 'ĞÑƒĞ´Ğ¸Ğ¾ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾'],
        ['cover_start', 'Ğ¡Ñ‚Ğ°Ñ€Ñ‚ cover'],
        ['cover_ready', 'Cover ÑÑ‚Ğ°Ñ‚ÑƒÑ'],
        ['delivery_start', 'Ğ¡Ñ‚Ğ°Ñ€Ñ‚ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸'],
        ['delivery_done', 'Ğ”Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ°'],
        ['pipeline_done', 'Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ'],
      ];
      const allStepsBlock = '<div class="details-section" style="margin-bottom:24px;"><div class="section-title" style="color:#fbbf24;">ğŸ§­ ĞšĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ Ğ²ÑĞµÑ… ÑÑ‚Ğ°Ğ¿Ğ¾Ğ² Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ°</div><div class="content-text" style="font-size:12px;line-height:1.7;">' +
        stepMap.map(function (pair) {
          var k = pair[0], label = pair[1];
          var v = steps[k];
          return '<b>' + escapeHtml(label) + '</b>: ' + (v ? escapeHtml(String(v)) : '<span style="color:#64748b;">â€”</span>');
        }).join('<br>') +
        (steps.error ? '<br><br><b style="color:#fca5a5;">ĞÑˆĞ¸Ğ±ĞºĞ°</b>: ' + escapeHtml(String(steps.error)) : '') +
        '</div></div>';
      const isTransitMode = r.mode === 'transit' || !!(r.transit_date || r.transit_location || r.transit_intent);
      const transitBlock = isTransitMode
        ? '<div class="details-section" style="margin-bottom:24px;"><div class="section-title" style="color:#f9a8d4;">ğŸŒ™ ĞšĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€Ğ° Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ¸Ñ‚Ğ¾Ğ² (Ğ­Ğ½ĞµÑ€Ğ³Ğ¸Ñ Ğ´Ğ½Ñ)</div>' +
          '<div class="content-text" style="line-height:1.6;">' +
            'Ğ ĞµĞ¶Ğ¸Ğ¼: <b>transit / Ğ­Ğ½ĞµÑ€Ğ³Ğ¸Ñ Ğ´Ğ½Ñ</b><br>' +
            'Ğ”Ğ°Ñ‚Ğ° Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ¸Ñ‚Ğ°: ' + escapeHtml(r.transit_date || 'â€”') + '<br>' +
            'Ğ’Ñ€ĞµĞ¼Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ¸Ñ‚Ğ°: ' + escapeHtml(r.transit_time || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾') + '<br>' +
            'Ğ›Ğ¾ĞºĞ°Ñ†Ğ¸Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ¸Ñ‚Ğ°: ' + escapeHtml(r.transit_location || 'â€”') + '<br>' +
            'ĞĞ°Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ğµ: ' + escapeHtml(r.transit_intent || 'â€”') + '<br>' +
            'Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸: ' + escapeHtml(genStatus || 'â€”') + '<br>' +
            (steps && Object.keys(steps).length ? ('Ğ›Ğ¾Ğ³Ğ¸ ÑÑ‚Ğ°Ğ¿Ğ¾Ğ²: ' + escapeHtml(JSON.stringify(steps))) : 'Ğ›Ğ¾Ğ³Ğ¸ ÑÑ‚Ğ°Ğ¿Ğ¾Ğ²: â€”') +
          '</div></div>'
        : '';
      let deepseekBlock;
      if (deepseekFull) {
        deepseekBlock = '<div class="details-section" style="margin-bottom:24px;"><div class="section-title" style="color:#a78bfa;">ğŸ¤– ĞÑ‚Ğ²ĞµÑ‚ DeepSeek</div>' +
          (r.llm_truncated ? '<div style="color:#f39c12;margin-bottom:8px;font-weight:bold">âš ï¸ ĞÑ‚Ğ²ĞµÑ‚ Ğ¾Ğ±Ñ€ĞµĞ·Ğ°Ğ½ Ğ¿Ğ¾ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ñƒ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²</div>' : '') +
          '<div class="content-text" style="max-height:50vh;overflow-y:auto;white-space:pre-wrap;word-break:break-word;font-size:13px;line-height:1.5;background:#0f0f1b;padding:16px;border-radius:8px;border:1px solid #333;">' + escapeHtml(deepseekFull) + '</div></div>';
      } else if (genStatus === 'failed') {
        deepseekBlock = '<div class="details-section"><div class="section-title">ğŸ¤– ĞÑ‚Ğ²ĞµÑ‚ DeepSeek</div><div class="content-text" style="color:#fca5a5;">ĞÑ‚Ğ²ĞµÑ‚ Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½. ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸: ' + escapeHtml(genError || 'Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°') + '</div></div>';
      } else {
        const reasonHint = dsReason === 'column_missing_or_old_schema'
          ? 'ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: Ğ² Ğ‘Ğ” Ğ½ĞµÑ‚ Ğ½ÑƒĞ¶Ğ½Ñ‹Ñ… ĞºĞ¾Ğ»Ğ¾Ğ½Ğ¾Ğº (Ğ½ÑƒĞ¶Ğ½Ğ° Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ).'
          : (dsReason === 'generation_in_progress'
            ? 'ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞµÑ‰Ñ‘ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ.'
            : (dsReason === 'completed_without_deepseek_response'
              ? 'ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°, Ğ½Ğ¾ raw-Ğ¾Ñ‚Ğ²ĞµÑ‚ DeepSeek Ğ½Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½ Ğ² ÑÑ‚Ğ¾Ğ¹ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸.'
              : (dsReason === 'not_generated' ? 'ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: ÑÑ‚Ğ°Ğ¿ DeepSeek ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ğ»ÑÑ.' : '')));
        deepseekBlock = '<div class="details-section"><div class="section-title">ğŸ¤– ĞÑ‚Ğ²ĞµÑ‚ DeepSeek</div><div class="content-text" style="color:#94a3b8;">ĞÑ‚Ğ²ĞµÑ‚ ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½. Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: ' + escapeHtml(genStatus) + '. ' + escapeHtml(reasonHint) + ' Ğ•ÑĞ»Ğ¸ Ğ´Ğ¾Ğ»Ğ³Ğ¾ Ğ½Ğµ Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ, Ğ½Ğ°Ğ¶Ğ¼Ğ¸ Â«ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸ÑÂ».</div></div>';
      }
      modal.innerHTML = `
        <div style="background:#1a1a2e;border-radius:15px;width:100%;max-width:900px;max-height:90vh;overflow-y:auto;padding:30px;position:relative;">
          <button onclick="this.closest('div').parentElement.remove()" style="position:absolute;top:15px;right:15px;background:#e74c3c;border:none;width:36px;height:36px;border-radius:50%;color:#fff;font-size:24px;cursor:pointer;line-height:1;">Ã—</button>
          <h2 style="color:#fff;font-size:24px;margin-bottom:20px;">ğŸ“‹ Ğ—Ğ°ÑĞ²ĞºĞ° #${(r.id || '').substring(0,8)}</h2>
          ${transitBlock}
          ${astroBlock}
          ${deepseekBlock}
          ${allStepsBlock}
          <div class="details-section">
            <div class="section-title">ğŸ‘¤ ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ</div>
            <div class="content-text">Ğ˜Ğ¼Ñ: ${escapeHtml(r.name || 'â€”')}<br>ĞŸĞ¾Ğ»: ${escapeHtml(r.gender || 'â€”')}<br>Ğ”Ğ°Ñ‚Ğ° Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ: ${escapeHtml(r.birthdate || 'â€”')}<br>Ğ’Ñ€ĞµĞ¼Ñ Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ: ${r.birthtime_unknown ? 'Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾' : escapeHtml(r.birthtime || 'â€”')}<br>ĞœĞµÑÑ‚Ğ¾: ${escapeHtml(r.birthplace || 'â€”')}${r.person2_name ? ('<hr style="border:0;border-top:1px solid #334155;margin:10px 0;">ĞŸĞ°Ñ€Ñ‚Ğ½Ñ‘Ñ€: ' + escapeHtml(r.person2_name) + '<br>ĞŸĞ¾Ğ» Ğ¿Ğ°Ñ€Ñ‚Ğ½Ñ‘Ñ€Ğ°: ' + escapeHtml(r.person2_gender || 'â€”') + '<br>Ğ”Ğ°Ñ‚Ğ° Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¿Ğ°Ñ€Ñ‚Ğ½Ñ‘Ñ€Ğ°: ' + escapeHtml(r.person2_birthdate || 'â€”') + '<br>Ğ’Ñ€ĞµĞ¼Ñ Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¿Ğ°Ñ€Ñ‚Ğ½Ñ‘Ñ€Ğ°: ' + (r.person2_birthtime_unknown ? 'Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾' : escapeHtml(r.person2_birthtime || 'â€”')) + '<br>ĞœĞµÑÑ‚Ğ¾ Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¿Ğ°Ñ€Ñ‚Ğ½Ñ‘Ñ€Ğ°: ' + escapeHtml(r.person2_birthplace || 'â€”')) : ''}</div>
          </div>
          ${r.lyrics ? '<div class="details-section"><div class="section-title">ğŸµ Ğ¢ĞµĞºÑÑ‚ Ğ¿ĞµÑĞ½Ğ¸</div><div class="content-text" style="white-space:pre-wrap;">' + escapeHtml(r.lyrics) + '</div></div>' : ''}
          ${r.audio_url ? '<div class="details-section"><div class="section-title">ğŸ”Š ĞÑƒĞ´Ğ¸Ğ¾</div><audio class="audio-player" controls src="' + escapeHtml(r.audio_url) + '"></audio><br><a href="' + escapeHtml(r.audio_url) + '" download><button class="btn btn-success" style="width:auto;">â¬‡ï¸ Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ</button></a></div>' : ''}
          <div class="actions" style="margin-top:30px;">
            <button class="btn btn-warning" onclick="restart(\'' + (r.id || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'") + '\'); this.closest(\'div\').parentElement.remove();">ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ</button>
            ${r.audio_url ? '<button class="btn btn-success" onclick="deliver(\'' + (r.id || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'") + '\', this); this.closest(\'div\').parentElement.remove();">ğŸ“¤ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ</button>' : ''}
            <button class="btn btn-primary" onclick="this.closest('div').parentElement.remove()">âœ… Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
          </div>
        </div>`;
      document.body.appendChild(modal);
    }

    window.restart = async function restart(id, btnEl) {
      if (!confirm('ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ?')) return;
      if (btnEl) { btnEl.disabled = true; btnEl.textContent = 'â³'; }
      try {
        const result = await fetchJson(API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + '/restart' + authQueryFromPath(), { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() } });
        const json = result.json;
        const res = result.res;
        if (json.success) {
          // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ±ĞµĞ¹Ğ´Ğ¶ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¿Ñ€ÑĞ¼Ğ¾ Ğ² ÑÑ‚Ñ€Ğ¾ĞºĞµ Ğ±ĞµĞ· Ğ¿ĞµÑ€ĞµÑ€Ğ¸ÑĞ¾Ğ²ĞºĞ¸ Ğ²ÑĞµĞ³Ğ¾ ÑĞ¿Ğ¸ÑĞºĞ°
          const statusBadge = document.querySelector('#req-row-' + CSS.escape(id) + ' .req-status');
          if (statusBadge) { statusBadge.className = 'req-status status-pending'; statusBadge.textContent = 'â³ Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ'; }
          // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸ĞºĞ¸ Ğ¸ Ğ½ĞµĞ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ğµ
          await refreshAfterAction();
        } else {
          alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + (json.error || res.status));
          if (btnEl) { btnEl.disabled = false; btnEl.textContent = 'ğŸ”„'; }
        }
      } catch (e) {
        alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + (e && e.message ? e.message : e));
        if (btnEl) { btnEl.disabled = false; btnEl.textContent = 'ğŸ”„'; }
      }
    }

    window.markPaid = async function markPaid(id) {
      if (!confirm('ĞÑ‚Ğ¼ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ·Ğ°ÑĞ²ĞºÑƒ ĞºĞ°Ğº Ğ¾Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ½ÑƒÑ? ĞŸĞ¾ÑĞ»Ğµ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ½Ğ°Ğ¶Ğ°Ñ‚ÑŒ Â«ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒÂ».')) return;
      try {
        const result = await fetchJson(API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + '/mark-paid' + authQueryFromPath(), { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify({ provider: 'admin' }) });
        const json = result.json;
        if (result.res && result.res.ok && json.success) { alert('âœ… Ğ—Ğ°ÑĞ²ĞºĞ° Ğ¾Ñ‚Ğ¼ĞµÑ‡ĞµĞ½Ğ° ĞºĞ°Ğº Ğ¾Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ½Ğ°Ñ'); refreshAfterAction(); }
        else alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + (json.error || result.res?.status || 'unknown'));
      } catch (e) {
        alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + (e && e.message ? e.message : e));
      }
    }

    window.deliver = async function deliver(id, btnEl) {
      if (!btnEl) btnEl = document.activeElement;
      const origText = btnEl ? btnEl.textContent : '';
      if (btnEl) { btnEl.disabled = true; btnEl.textContent = 'ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ°â€¦'; }
      try {
        const result = await fetchJson(API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + '/deliver' + authQueryFromPath(), { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() } });
        const json = result.json;
        if (json.success) { alert('âœ… ĞŸĞµÑĞ½Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ'); }
        else alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + (json.error || 'unknown'));
      } catch (e) {
        alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + (e && e.message ? e.message : e));
      } finally {
        if (btnEl) { btnEl.disabled = false; btnEl.textContent = origText; }
      }
    }

    window.deleteRequests = async function deleteRequests(ids) {
      if (!ids || !ids.length) return;
      try {
        const result = await fetchJson(
          API_BASE + '/api/admin/requests/bulk-delete' + authQueryFromPath(),
          { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify({ ids }) },
          10000
        );
        if (result.json?.success) {
          // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ¸Ğ· DOM
          ids.forEach(id => {
            const row = document.getElementById('req-row-' + id);
            if (row) row.remove();
          });
          await refreshAfterAction();
        } else {
          alert('ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ: ' + (result.json?.error || 'unknown'));
        }
      } catch (e) {
        alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + (e?.message || e));
      }
    };

    document.addEventListener('DOMContentLoaded', function() {
      loadAdminData().catch(function(e) {
        setLoadingStatus(false);
        const msg = (e && e.message) ? e.message : String(e);
        const isTimeout = msg && msg.includes('Ğ½Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¸Ğ»');
        const el = document.getElementById('requests');
        if (el) el.innerHTML = '<div style="text-align:center;padding:40px;color:#e74c3c">âŒ ' + escapeHtml(msg) + (isTimeout ? '<br><span style="color:#94a3b8;font-size:13px">Render Ğ¼Ğ¾Ğ³ ÑƒÑĞ½ÑƒÑ‚ÑŒ â€” Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ñ‡ĞµÑ€ĞµĞ· 30 ÑĞµĞº</span>' : '') + '<br><br><button onclick="window.location.reload()" style="margin-top:12px;padding:10px 24px;background:#667eea;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:15px;">ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ</button><br><br><span style="font-size:12px;color:#64748b">API: ' + escapeHtml(window.API_BASE || window.location.origin) + '</span></div>';
      });
    });
  </script>
</body>
</html>
