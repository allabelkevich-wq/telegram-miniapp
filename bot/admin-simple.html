<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üëë –ê–¥–º–∏–Ω–∫–∞ Yup Soul ‚Äî –ö–æ–Ω—Ç—Ä–æ–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0f0f1b; color: #fff; font-family: 'Segoe UI', sans-serif; padding: 20px; line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; margin-bottom: 30px; text-align: center; }
    .header h1 { font-size: 32px; font-weight: bold; margin-bottom: 10px; }
    .header p { opacity: 0.9; font-size: 16px; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: #1a1a2e; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #667eea; }
    .stat-card.pending { border-left-color: #f39c12; }
    .stat-card.completed { border-left-color: #27ae60; }
    .stat-card.failed { border-left-color: #e74c3c; }
    .stat-number { font-size: 42px; font-weight: bold; margin: 10px 0; }
    .stat-label { font-size: 14px; opacity: 0.9; }
    .filters { background: #1a1a2e; padding: 15px; border-radius: 12px; margin-bottom: 30px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .filter-btn { padding: 10px 20px; background: #2d3748; border: 2px solid #4a5568; color: #fff; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
    .filter-btn:hover { background: #4a5568; transform: translateY(-1px); }
    .filter-btn.active { background: linear-gradient(135deg, #667eea, #764ba2); border-color: #667eea; }
    .request-card { background: #1a1a2e; border-radius: 12px; padding: 25px; margin-bottom: 25px; border: 2px solid #2d3748; transition: all 0.3s; }
    .request-card:hover { border-color: #667eea; transform: translateY(-2px); }
    .request-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #2d3748; }
    .request-name { font-size: 22px; font-weight: bold; }
    .request-id { font-size: 13px; color: #94a3b8; margin-top: 5px; font-family: monospace; }
    .request-status { padding: 8px 20px; border-radius: 20px; font-weight: bold; min-width: 140px; text-align: center; }
    .status-pending { background: #f39c12; color: #000; }
    .status-completed { background: #27ae60; color: #fff; }
    .status-failed { background: #e74c3c; color: #fff; }
    .progress-container { background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 10px; margin: 25px 0; }
    .progress-title { text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #667eea; }
    .progress-steps { display: flex; justify-content: space-between; position: relative; margin-bottom: 30px; }
    .progress-steps::before { content: ''; position: absolute; top: 20px; left: 15px; right: 15px; height: 4px; background: #2d3748; z-index: 1; }
    .step { text-align: center; position: relative; z-index: 2; width: 80px; }
    .step-circle { width: 40px; height: 40px; border-radius: 50%; background: #2d3748; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold; border: 3px solid #2d3748; transition: all 0.3s; }
    .step-label { font-size: 12px; color: #94a3b8; font-weight: 500; }
    .step.done .step-circle { background: #27ae60; border-color: #27ae60; color: #fff; }
    .step.current .step-circle { background: #667eea; border-color: #667eea; color: #fff; transform: scale(1.1); }
    .step-label.ru { display: block; font-size: 13px; color: #fff; margin-top: 4px; }
    .step-label.en { display: block; font-size: 11px; color: #94a3b8; }
    .step-log { font-size: 11px; color: #64748b; margin-top: 4px; max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .step.done .step-log { color: #86efac; }
    .actions { display: flex; gap: 12px; margin-top: 25px; flex-wrap: wrap; }
    .btn { padding: 12px 25px; border: none; border-radius: 8px; color: #fff; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; min-width: 160px; justify-content: center; }
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); }
    .btn-success { background: linear-gradient(135deg, #27ae60, #2ecc71); }
    .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); color: #000; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.3); }
    .details-section { margin: 25px 0; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 8px; }
    .section-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #667eea; display: flex; align-items: center; gap: 10px; }
    .content-text { font-size: 14px; line-height: 1.7; white-space: pre-wrap; max-height: 250px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; }
    .audio-player { width: 100%; margin: 15px 0; }
    .loading { text-align: center; padding: 50px; color: #94a3b8; }
    .spinner { width: 40px; height: 40px; border: 4px solid rgba(102,126,234,0.3); border-top-color: #667eea; border-radius: 50%; margin: 0 auto 15px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 768px) {
      .header h1 { font-size: 26px; }
      .stat-number { font-size: 36px; }
      .progress-steps { flex-wrap: wrap; }
      .step { width: 100%; margin-bottom: 20px; }
      .actions { flex-direction: column; }
      .btn { width: 100%; min-width: auto; }
    }
  </style>
</head>
<body style="background:#0f0f1b;color:#fff;">
  <div class="container">
    <div class="header">
      <h1>üëë –ê–î–ú–ò–ù–ö–ê YUP SOUL</h1>
      <p>–ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–≤—É–∫–æ–≤—ã—Ö –∫–ª—é—á–µ–π / Full control of sound key generation</p>
      <p id="url-info" style="font-size:12px;color:#64748b;margin-top:8px;word-break:break-all;"></p>
    </div>
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">–í—Å–µ–≥–æ / Total</div>
        <div class="stat-number" id="total">-</div>
      </div>
      <div class="stat-card pending">
        <div class="stat-label">–í —Ä–∞–±–æ—Ç–µ / In Progress</div>
        <div class="stat-number" id="pending">-</div>
      </div>
      <div class="stat-card completed">
        <div class="stat-label">–ì–æ—Ç–æ–≤–æ / Completed</div>
        <div class="stat-number" id="completed">-</div>
      </div>
      <div class="stat-card failed">
        <div class="stat-label">–û—à–∏–±–∫–∏ / Failed</div>
        <div class="stat-number" id="failed">-</div>
      </div>
    </div>
    <div class="filters">
      <button class="filter-btn active" data-filter="all">üìã –í—Å–µ / All</button>
      <button class="filter-btn" data-filter="pending">‚è≥ –í —Ä–∞–±–æ—Ç–µ / In Progress</button>
      <button class="filter-btn" data-filter="completed">‚úÖ –ì–æ—Ç–æ–≤–æ / Completed</button>
      <button class="filter-btn" data-filter="failed">‚ùå –û—à–∏–±–∫–∏ / Failed</button>
    </div>
    <div class="details-section" style="margin-bottom:20px;">
      <div class="section-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
      <p style="font-size:14px;color:#94a3b8;margin-bottom:12px;">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã DeepSeek –¥–ª—è –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: .env –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ &gt; —ç—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.</p>
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
          <label style="display:flex;align-items:center;gap:8px;">
            <span style="min-width:100px;">–ú–æ–¥–µ–ª—å:</span>
            <select id="settings-model" style="min-width:220px;padding:10px;border-radius:8px;border:2px solid #4a5568;background:#1a1a2e;color:#fff;font-size:14px;">
              <option value="deepseek-reasoner">deepseek-reasoner (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: 128K, thinking)</option>
              <option value="deepseek-chat">deepseek-chat</option>
              <option value="deepseek-coder">deepseek-coder</option>
              <option value="">‚Äî –∫–∞–∫ –≤ .env ‚Äî</option>
            </select>
          </label>
        </div>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
          <label style="display:flex;align-items:center;gap:8px;">
            <span style="min-width:100px;">max_tokens:</span>
            <input type="number" id="settings-max-tokens" min="4096" max="65536" value="8192" step="1" title="–õ–∏–º–∏—Ç DeepSeek API: 1..65536" style="width:100px;padding:10px;border-radius:8px;border:2px solid #4a5568;background:#1a1a2e;color:#fff;font-size:16px;">
          </label>
          <label style="display:flex;align-items:center;gap:8px;">
            <span style="min-width:100px;">temperature:</span>
            <input type="number" id="settings-temperature" min="0" max="2" step="0.1" value="1.5" style="width:80px;padding:10px;border-radius:8px;border:2px solid #4a5568;background:#1a1a2e;color:#fff;font-size:16px;" title="0 = –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ, 1.5 = –∫—Ä–µ–∞—Ç–∏–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)">
          </label>
        </div>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
          <button type="button" class="btn btn-primary" id="settings-save-btn" style="min-width:140px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <span id="settings-save-status" style="font-size:14px;color:#86efac;"></span>
        </div>
      </div>
    </div>
    <div id="requests" class="loading">
      <div class="spinner"></div>
      <div>–ó–∞–≥—Ä—É–∑–∫–∞... / Loading...</div>
    </div>
  </div>

  <script>
    (function() {
      var params = new URLSearchParams(window.location.search);
      var apiOrigin = params.get('api_origin');
      window.API_BASE = (apiOrigin && apiOrigin.startsWith('http')) ? apiOrigin.replace(/\/$/, '') : window.location.origin;
      var el = document.getElementById('url-info');
      if (el) el.textContent = '–°—Ç—Ä–∞–Ω–∏—Ü–∞: ' + window.location.origin + ' ¬∑ –ó–∞–ø—Ä–æ—Å—ã –∫ API: ' + window.API_BASE;
    })();
    let currentFilter = 'all';

    function getToken() {
      const fromUrl = new URLSearchParams(window.location.search).get('token');
      if (fromUrl) {
        try { localStorage.setItem('adminToken', fromUrl); } catch (e) {}
        return fromUrl;
      }
      return localStorage.getItem('adminToken');
    }
    function authHeaders() {
      const t = getToken();
      return t ? { 'X-Admin-Token': t } : {};
    }
    function authQuery() {
      const t = getToken();
      return t ? '&token=' + encodeURIComponent(t) : '';
    }
    function authQueryFromPath() {
      const t = getToken();
      return t ? '?token=' + encodeURIComponent(t) : '';
    }

    async function fetchJson(url, opts) {
      const res = await fetch(url, opts);
      const text = await res.text();
      if (text.trim().startsWith('<')) {
        if (res.status === 502 || res.status === 503) {
          throw new Error('–°–µ—Ä–≤–µ—Ä –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è (502/503). –ü–æ–¥–æ–∂–¥–∏—Ç–µ 30‚Äì60 —Å–µ–∫ –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5).');
        }
        throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª HTML –≤–º–µ—Å—Ç–æ –¥–∞–Ω–Ω—ã—Ö. –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞: ' + res.status + '. –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ –±–æ—Ç–∞: –≤ Render —Å–µ—Ä–≤–∏—Å ¬´' + window.location.host + '¬ª –º–æ–∂–µ—Ç –±—ã—Ç—å Static Site, –∞ API –æ—Ç–¥–∞—ë—Ç Web Service —Å –±–æ—Ç–æ–º. –ó–∞–¥–∞–π—Ç–µ BOT_PUBLIC_URL = URL –∏–º–µ–Ω–Ω–æ Web Service —Å –±–æ—Ç–æ–º (Dashboard ‚Üí Web Service ‚Üí URL), –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É –∏–∑ /admin. –°–µ–π—á–∞—Å –æ—Ç–∫—Ä—ã—Ç–æ: ' + window.location.origin);
      }
      try {
        return { res, json: JSON.parse(text) };
      } catch (e) {
        throw new Error('–û—Ç–≤–µ—Ç –Ω–µ JSON (—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω–µ —Ç–æ—Ç –∞–¥—Ä–µ—Å). –û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ –±–æ—Ç–∞ (/admin).');
      }
    }

    async function loadAdminData() {
      const token = getToken();
      if (!token) {
        const el = document.getElementById('requests');
        if (el) el.innerHTML = '<div style="text-align:center;padding:40px;color:#e0e0e0"><p style="margin-bottom:20px">üîë –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ / Enter admin token</p><form id="token-form" style="display:flex;flex-direction:column;align-items:center;gap:12px;max-width:320px;margin:0 auto"><input type="password" id="token-input" placeholder="–¢–æ–∫–µ–Ω" style="width:100%;padding:12px;border-radius:8px;border:2px solid #667eea;background:#1a1a2e;color:#fff;font-size:16px" autocomplete="off"><button type="submit" style="padding:12px 24px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer">–í–æ–π—Ç–∏ / Login</button></form></div>';
        const form = document.getElementById('token-form');
        const input = document.getElementById('token-input');
        if (form && input) form.addEventListener('submit', function(e) { e.preventDefault(); const v = (input.value || '').trim(); if (v) { localStorage.setItem('adminToken', v); window.location.search = '?token=' + encodeURIComponent(v); } });
        return;
      }
      try {
        const statsResult = await fetchJson(API_BASE + '/api/admin/stats?' + new URLSearchParams({ token }).toString(), { headers: authHeaders() });
        if (statsResult.res.status === 503) {
          const msg = (statsResult.json && statsResult.json.error) || '–°–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è';
          document.getElementById('requests').innerHTML = '<div style="text-align:center;padding:40px;color:#f39c12">‚è≥ ' + escapeHtml(msg) + '<br><br>–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 20‚Äì30 —Å–µ–∫ (F5).</div>';
          return;
        }
        const statsJson = statsResult.json;
        if (statsJson.success && statsJson.stats) {
          const s = statsJson.stats;
          document.getElementById('total').textContent = s.total;
          document.getElementById('pending').textContent = (s.pending || 0) + (s.astro_calculated || 0) + (s.lyrics_generated || 0) + (s.suno_processing || 0);
          document.getElementById('completed').textContent = s.completed || 0;
          document.getElementById('failed').textContent = s.failed || 0;
        }
        const listResult = await fetchJson(API_BASE + '/api/admin/requests?limit=50&status=' + currentFilter + authQuery(), { headers: authHeaders() });
        const listJson = listResult.json;
        const listRes = listResult.res;
        if (listJson.success && Array.isArray(listJson.data)) renderRequests(listJson.data);
        else {
          const err = listJson.error || listRes.status || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
          document.getElementById('requests').innerHTML = '<div style="text-align:center;padding:40px;color:#e74c3c">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + escapeHtml(String(err)) + '<br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω / Check token</div>';
        }
        const settingsResult = await fetchJson(API_BASE + '/api/admin/settings' + authQueryFromPath(), { headers: authHeaders() });
        const settingsJson = settingsResult.json;
        if (settingsJson.success && settingsJson.settings) {
          const st = settingsJson.settings;
          const mt = st.deepseek_max_tokens;
          const inputEl = document.getElementById('settings-max-tokens');
          if (inputEl && (mt === 0 || mt > 0)) inputEl.value = Math.max(4096, Number(mt)) || 8192;
          const modelEl = document.getElementById('settings-model');
          if (modelEl && st.deepseek_model) {
            const opt = Array.from(modelEl.options).find(o => o.value === st.deepseek_model);
            if (opt) modelEl.value = st.deepseek_model;
            else { const o = new Option(st.deepseek_model, st.deepseek_model); modelEl.appendChild(o); modelEl.value = st.deepseek_model; }
          }
          const tempEl = document.getElementById('settings-temperature');
          if (tempEl && st.deepseek_temperature != null && Number.isFinite(Number(st.deepseek_temperature))) tempEl.value = Math.max(0, Math.min(2, Number(st.deepseek_temperature)));
        }
      } catch (e) {
        const msg = (e && e.message) || String(e);
        const el = document.getElementById('requests');
        if (el) el.innerHTML = '<div style="text-align:center;padding:40px;color:#e74c3c">‚ùå ' + escapeHtml(msg) + '<br><br>–û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω–∫—É –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ –±–æ—Ç–∞ (–Ω–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É /admin).</div>';
      }
    }

    function getStatusOrder(status) {
      const order = { pending: 1, astro_calculated: 2, lyrics_generated: 3, suno_processing: 4, completed: 5, failed: 0 };
      return order[status] || 1;
    }
    function statusClass(gs) {
      if (gs === 'completed') return 'status-completed';
      if (gs === 'failed') return 'status-failed';
      return 'status-pending';
    }
    function statusLabel(gs) {
      if (gs === 'completed') return '‚úÖ –ì–æ—Ç–æ–≤–æ / Completed';
      if (gs === 'failed') return '‚ùå –û—à–∏–±–∫–∞ / Failed';
      return '‚è≥ –í —Ä–∞–±–æ—Ç–µ / In Progress';
    }

    function renderRequests(data) {
      if (!data.length) {
        document.getElementById('requests').innerHTML = '<div style="text-align:center;padding:60px;color:#94a3b8">üì≠ –ù–µ—Ç –∑–∞—è–≤–æ–∫ / No requests</div>';
        return;
      }
      function stepMsg(steps, key) {
        if (!steps || typeof steps !== 'object') return '';
        const v = steps[key];
        return (v && String(v).trim()) ? escapeHtml(String(v).slice(0, 120)) : '';
      }
      document.getElementById('requests').innerHTML = data.map(r => {
        const gs = r.generation_status || r.status || 'pending';
        const order = getStatusOrder(gs);
        const steps = r.generation_steps && typeof r.generation_steps === 'object' ? r.generation_steps : (typeof r.generation_steps === 'string' ? (() => { try { return JSON.parse(r.generation_steps); } catch (e) { return {}; } })() : {});
        return `
        <div class="request-card">
          <div class="request-header">
            <div>
              <div class="request-name">${escapeHtml(r.name || '')}${r.person2_name ? ' & ' + escapeHtml(r.person2_name) : ''}</div>
              <div class="request-id" title="–ü–æ–ª–Ω—ã–π UUID: ${escapeHtml((r.id || ''))}">ID: ${(r.id || '').substring(0,8)} ‚Ä¢ ${r.created_at ? new Date(r.created_at).toLocaleDateString('ru-RU') : '‚Äî'}</div>
            </div>
            <div class="request-status ${statusClass(gs)}">${statusLabel(gs)}</div>
          </div>
          <div class="progress-container">
            <div class="progress-title">–¶–µ–ø–æ—á–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ / Generation chain</div>
            <div class="progress-steps">
              <div class="step ${order >= 1 ? 'done' : ''} ${order === 1 ? 'current' : ''}">
                <div class="step-circle">${order >= 1 ? '‚úì' : '1'}</div>
                <div class="step-label ru">–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã</div>
                <div class="step-label en">Data received</div>
                ${stepMsg(steps, '1') ? '<div class="step-log" title="' + stepMsg(steps, '1') + '">' + stepMsg(steps, '1') + '</div>' : ''}
              </div>
              <div class="step ${order >= 2 ? 'done' : ''} ${order === 2 ? 'current' : ''}">
                <div class="step-circle">${order >= 2 ? '‚úì' : '2'}</div>
                <div class="step-label ru">–ê–Ω–∞–ª–∏–∑ –ò–ò</div>
                <div class="step-label en">AI analysis</div>
                ${stepMsg(steps, '2') ? '<div class="step-log" title="' + stepMsg(steps, '2') + '">' + stepMsg(steps, '2') + '</div>' : ''}
              </div>
              <div class="step ${order >= 3 ? 'done' : ''} ${order === 3 ? 'current' : ''}">
                <div class="step-circle">${order >= 3 ? '‚úì' : '3'}</div>
                <div class="step-label ru">–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏</div>
                <div class="step-label en">Song lyrics</div>
                ${stepMsg(steps, '3') ? '<div class="step-log" title="' + stepMsg(steps, '3') + '">' + stepMsg(steps, '3') + '</div>' : ''}
              </div>
              <div class="step ${order >= 4 ? 'done' : ''} ${order === 4 ? 'current' : ''}">
                <div class="step-circle">${order >= 4 ? '‚úì' : '4'}</div>
                <div class="step-label ru">–ê—É–¥–∏–æ</div>
                <div class="step-label en">Audio</div>
                ${stepMsg(steps, '4') ? '<div class="step-log" title="' + stepMsg(steps, '4') + '">' + stepMsg(steps, '4') + '</div>' : ''}
              </div>
            </div>
            ${steps.error ? '<div class="details-section" style="margin-top:12px;"><div class="section-title" style="color:#e74c3c;">‚ùå –û—à–∏–±–∫–∞ —ç—Ç–∞–ø–∞</div><div class="content-text" style="font-size:12px;">' + stepMsg(steps, 'error') + '</div></div>' : ''}
          </div>
          <div class="details-section">
            <div class="section-title">üí¨ –ó–∞–ø—Ä–æ—Å / Request</div>
            <div class="content-text">${escapeHtml((r.request || '‚Äî').substring(0, 500))}${(r.request || '').length > 500 ? '‚Ä¶' : ''}</div>
          </div>
          <div class="actions">
            <button class="btn btn-primary" onclick="showDetails('${(r.id || '').replace(/'/g, "\\'")}')">üìã –ü–æ–¥—Ä–æ–±–Ω–µ–µ / Details</button>
            ${gs !== 'completed' ? '<button class="btn btn-warning" onclick="restart(\'' + (r.id || '').replace(/'/g, "\\'") + '\')">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å / Restart</button>' : ''}
            ${r.audio_url ? '<button class="btn btn-success" onclick="window.open(\'' + r.audio_url.replace(/'/g, "\\'") + '\')">‚ñ∂Ô∏è –°–ª—É—à–∞—Ç—å / Listen</button>' : ''}
          </div>
        </div>`;
      }).join('');
    }
    function escapeHtml(s) {
      if (s == null) return '';
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        currentFilter = this.getAttribute('data-filter') || 'all';
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        loadAdminData();
      });
    });

    document.getElementById('settings-save-btn')?.addEventListener('click', async function() {
      const input = document.getElementById('settings-max-tokens');
      const modelEl = document.getElementById('settings-model');
      const tempEl = document.getElementById('settings-temperature');
      const statusEl = document.getElementById('settings-save-status');
      if (!input || !statusEl) return;
      const val = Math.min(65536, Math.max(4096, Number(input.value) || 8192));
      input.value = val;
      const modelVal = (modelEl && modelEl.value) ? modelEl.value.trim() : '';
      const tempVal = (tempEl && tempEl.value !== '') ? Math.max(0, Math.min(2, Number(tempEl.value))) : 1.5;
      if (tempEl) tempEl.value = tempVal;
      statusEl.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶';
      statusEl.style.color = '#94a3b8';
      try {
        const body = { deepseek_max_tokens: val, deepseek_temperature: tempVal };
        if (modelVal) body.deepseek_model = modelVal;
        const result = await fetchJson(API_BASE + '/api/admin/settings' + authQueryFromPath(), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(body)
        });
        const json = result.json;
        if (json.success) { statusEl.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'; statusEl.style.color = '#86efac'; setTimeout(() => { statusEl.textContent = ''; }, 3000); }
        else { statusEl.textContent = '‚ùå ' + (json.error || '–û—à–∏–±–∫–∞'); statusEl.style.color = '#e74c3c'; }
      } catch (e) {
        statusEl.textContent = '‚ùå ' + (e && e.message ? e.message : '–û—à–∏–±–∫–∞');
        statusEl.style.color = '#e74c3c';
      }
    });

    async function showDetails(id) {
      const url = API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + authQueryFromPath();
      let json, res;
      try {
        const result = await fetchJson(url, { headers: authHeaders() });
        res = result.res;
        json = result.json;
      } catch (e) {
        const msg = (e && e.message ? e.message : '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        const hint = msg === 'Failed to fetch'
          ? '–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª (—Å–µ—Ç—å –∏–ª–∏ —Ö–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç Render). –ü–æ–¥–æ–∂–¥–∏—Ç–µ 30 —Å–µ–∫ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥—Ä–æ–±–Ω–µ–µ¬ª —Å–Ω–æ–≤–∞.'
          : '–û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω–∫—É –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ –±–æ—Ç–∞ (/admin).';
        alert('‚ùå ' + msg + '\n\n' + hint);
        return;
      }
      if (!json.success || !json.data) {
        alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (json.error || res.status || 'Load error'));
        return;
      }
      const r = json.data;
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;overflow:auto;';
      const astroText = (r.astro_snapshot_text || '').trim();
      const astroJson = (r.astro_snapshot_json && typeof r.astro_snapshot_json === 'object') ? JSON.stringify(r.astro_snapshot_json, null, 2) : '';
      const astroBlock = astroText
        ? '<div class="details-section" style="margin-bottom:24px;"><div class="section-title" style="color:#67e8f9;">ü™ê –î–∞–Ω–Ω—ã–µ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞</div>' +
          '<div class="content-text" style="max-height:40vh;overflow-y:auto;white-space:pre-wrap;word-break:break-word;font-size:13px;line-height:1.5;background:#0f0f1b;padding:16px;border-radius:8px;border:1px solid #333;">' + escapeHtml(astroText) + '</div>' +
          (astroJson ? '<details style="margin-top:10px;"><summary style="cursor:pointer;color:#94a3b8;">–ü–æ–∫–∞–∑–∞—Ç—å JSON —Å–Ω–∞–ø—à–æ—Ç–∞</summary><div class="content-text" style="margin-top:8px;max-height:30vh;overflow-y:auto;white-space:pre-wrap;word-break:break-word;font-size:12px;line-height:1.4;background:#0f0f1b;padding:12px;border-radius:8px;border:1px solid #333;">' + escapeHtml(astroJson) + '</div></details>' : '') +
          '</div>'
        : '<div class="details-section"><div class="section-title" style="color:#67e8f9;">ü™ê –î–∞–Ω–Ω—ã–µ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞</div><div class="content-text" style="color:#94a3b8;">–°–Ω–∞–ø—à–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–æ–∑–º–æ–∂–Ω–æ, —Ä–∞—Å—á—ë—Ç –µ—â—ë –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω –∏–ª–∏ –≤ –ë–î –Ω–µ—Ç –∑–∞–ø–∏—Å–∏ –¥–ª—è —ç—Ç–æ–π –∑–∞—è–≤–∫–∏.</div></div>';
      const deepseekFull = (r.deepseek_response || '').trim();
      const genStatus = r.generation_status || r.status || 'pending';
      const genError = (r.error_message || '').trim();
      const dsReason = r.deepseek_missing_reason || '';
      let deepseekBlock;
      if (deepseekFull) {
        deepseekBlock = '<div class="details-section" style="margin-bottom:24px;"><div class="section-title" style="color:#a78bfa;">ü§ñ –û—Ç–≤–µ—Ç DeepSeek</div>' +
          (r.llm_truncated ? '<div style="color:#f39c12;margin-bottom:8px;font-weight:bold">‚ö†Ô∏è –û—Ç–≤–µ—Ç –æ–±—Ä–µ–∑–∞–Ω –ø–æ –ª–∏–º–∏—Ç—É —Ç–æ–∫–µ–Ω–æ–≤</div>' : '') +
          '<div class="content-text" style="max-height:50vh;overflow-y:auto;white-space:pre-wrap;word-break:break-word;font-size:13px;line-height:1.5;background:#0f0f1b;padding:16px;border-radius:8px;border:1px solid #333;">' + escapeHtml(deepseekFull) + '</div></div>';
      } else if (genStatus === 'failed') {
        deepseekBlock = '<div class="details-section"><div class="section-title">ü§ñ –û—Ç–≤–µ—Ç DeepSeek</div><div class="content-text" style="color:#fca5a5;">–û—Ç–≤–µ—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω. –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + escapeHtml(genError || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div></div>';
      } else {
        const reasonHint = dsReason === 'column_missing_or_old_schema'
          ? '–ü—Ä–∏—á–∏–Ω–∞: –≤ –ë–î –Ω–µ—Ç –Ω—É–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ (–Ω—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è).'
          : (dsReason === 'generation_in_progress'
            ? '–ü—Ä–∏—á–∏–Ω–∞: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –µ—â—ë –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è.'
            : (dsReason === 'completed_without_deepseek_response'
              ? '–ü—Ä–∏—á–∏–Ω–∞: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –Ω–æ raw-–æ—Ç–≤–µ—Ç DeepSeek –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏.'
              : (dsReason === 'not_generated' ? '–ü—Ä–∏—á–∏–Ω–∞: —ç—Ç–∞–ø DeepSeek –µ—â—ë –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è.' : '')));
        deepseekBlock = '<div class="details-section"><div class="section-title">ü§ñ –û—Ç–≤–µ—Ç DeepSeek</div><div class="content-text" style="color:#94a3b8;">–û—Ç–≤–µ—Ç –µ—â—ë –Ω–µ –ø–æ–ª—É—á–µ–Ω. –°—Ç–∞—Ç—É—Å: ' + escapeHtml(genStatus) + '. ' + escapeHtml(reasonHint) + ' –ï—Å–ª–∏ –¥–æ–ª–≥–æ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è, –Ω–∞–∂–º–∏ ¬´–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é¬ª.</div></div>';
      }
      modal.innerHTML = `
        <div style="background:#1a1a2e;border-radius:15px;width:100%;max-width:900px;max-height:90vh;overflow-y:auto;padding:30px;position:relative;">
          <button onclick="this.closest('div').parentElement.remove()" style="position:absolute;top:15px;right:15px;background:#e74c3c;border:none;width:36px;height:36px;border-radius:50%;color:#fff;font-size:24px;cursor:pointer;line-height:1;">√ó</button>
          <h2 style="color:#fff;font-size:24px;margin-bottom:20px;">üìã –ó–∞—è–≤–∫–∞ #${(r.id || '').substring(0,8)}</h2>
          ${astroBlock}
          ${deepseekBlock}
          <div class="details-section">
            <div class="section-title">üë§ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>
            <div class="content-text">–ò–º—è: ${escapeHtml(r.name || '‚Äî')}<br>${r.person2_name ? '–ü–∞—Ä—Ç–Ω—ë—Ä: ' + escapeHtml(r.person2_name) + '<br>' : ''}–ü–æ–ª: ${r.gender || '‚Äî'}<br>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: ${r.birthdate || '‚Äî'}<br>–ú–µ—Å—Ç–æ: ${escapeHtml(r.birthplace || '‚Äî')}</div>
          </div>
          ${r.lyrics ? '<div class="details-section"><div class="section-title">üéµ –¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏</div><div class="content-text" style="white-space:pre-wrap;">' + escapeHtml(r.lyrics) + '</div></div>' : ''}
          ${r.audio_url ? '<div class="details-section"><div class="section-title">üîä –ê—É–¥–∏–æ</div><audio class="audio-player" controls src="' + escapeHtml(r.audio_url) + '"></audio><br><a href="' + escapeHtml(r.audio_url) + '" download><button class="btn btn-success" style="width:auto;">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å</button></a></div>' : ''}
          <div class="actions" style="margin-top:30px;">
            <button class="btn btn-warning" onclick="restart(\'' + (r.id || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'") + '\'); this.closest(\'div\').parentElement.remove();">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é</button>
            <button class="btn btn-primary" onclick="this.closest('div').parentElement.remove()">‚úÖ –ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>`;
      document.body.appendChild(modal);
    }

    async function restart(id) {
      if (!confirm('–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é? / Restart generation?')) return;
      try {
        const result = await fetchJson(API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + '/restart' + authQueryFromPath(), { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() } });
        const json = result.json;
        const res = result.res;
        if (json.success) { alert('‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞ / Generation restarted'); loadAdminData(); }
        else alert('–û—à–∏–±–∫–∞: ' + (json.error || res.status));
      } catch (e) { alert('–û—à–∏–±–∫–∞: ' + (e && e.message ? e.message : e)); }
    }

    document.addEventListener('DOMContentLoaded', function() {
      try { loadAdminData(); }
      catch (e) {
        const el = document.getElementById('requests');
        if (el) el.innerHTML = '<div style="text-align:center;padding:40px;color:#e74c3c">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (e && e.message ? e.message : String(e)) + '</div>';
      }
    });
  </script>
</body>
</html>
