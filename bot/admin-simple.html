<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üëë –ê–¥–º–∏–Ω–∫–∞ Yup Soul ‚Äî –ö–æ–Ω—Ç—Ä–æ–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</title>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0f0f1b; color: #fff; font-family: 'Comfortaa', system-ui, sans-serif; padding: 20px; line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; margin-bottom: 30px; text-align: center; }
    .header h1 { font-size: 32px; font-weight: bold; margin-bottom: 10px; }
    .header p { opacity: 0.9; font-size: 16px; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: #1a1a2e; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #667eea; cursor: pointer; transition: all 0.2s; user-select: none; }
    .stat-card:hover { background: #232340; transform: translateY(-2px); box-shadow: 0 6px 18px rgba(102,126,234,0.2); }
    .stat-card.active-filter { box-shadow: 0 0 0 2px #667eea; background: #232350; }
    .stat-card.pending { border-left-color: #f39c12; }
    .stat-card.pending:hover, .stat-card.pending.active-filter { box-shadow: 0 0 0 2px #f39c12; }
    .stat-card.completed { border-left-color: #27ae60; }
    .stat-card.completed:hover, .stat-card.completed.active-filter { box-shadow: 0 0 0 2px #27ae60; }
    .stat-card.failed { border-left-color: #e74c3c; }
    .stat-card.failed:hover, .stat-card.failed.active-filter { box-shadow: 0 0 0 2px #e74c3c; }
    .stat-number { font-size: 42px; font-weight: bold; margin: 10px 0; }
    .stat-label { font-size: 14px; opacity: 0.9; }
    .sort-bar { background: #1a1a2e; padding: 12px 15px; border-radius: 10px; margin-bottom: 16px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .sort-bar span { font-size: 13px; color: #94a3b8; margin-right: 4px; }
    .sort-btn { padding: 6px 14px; background: #2d3748; border: 1px solid #4a5568; color: #cbd5e1; border-radius: 6px; cursor: pointer; font-size: 13px; font-family: inherit; transition: all 0.15s; }
    .sort-btn:hover { background: #4a5568; }
    .sort-btn.active { background: linear-gradient(135deg,#667eea,#764ba2); border-color: #667eea; color: #fff; }
    .pay-badge { display:inline-block; padding: 2px 8px; border-radius: 5px; font-size: 11px; font-weight: 600; margin-left: 4px; }
    .pay-badge-gift { background: rgba(139,92,246,.25); color: #c4b5fd; }
    .pay-badge-promo { background: rgba(212,175,55,.2); color: #fde68a; }
    .pay-badge-hot { background: rgba(59,130,246,.2); color: #93c5fd; }
    .pay-badge-sub { background: rgba(16,185,129,.2); color: #6ee7b7; }
    .pay-badge-free { background: rgba(34,197,94,.2); color: #86efac; }
    .filters { background: #1a1a2e; padding: 15px; border-radius: 12px; margin-bottom: 30px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .filter-btn { padding: 10px 20px; background: #2d3748; border: 2px solid #4a5568; color: #fff; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
    .filter-btn:hover { background: #4a5568; transform: translateY(-1px); }
    .filter-btn.active { background: linear-gradient(135deg, #667eea, #764ba2); border-color: #667eea; }
    .request-card { background: #1a1a2e; border-radius: 12px; padding: 25px; margin-bottom: 25px; border: 2px solid #2d3748; transition: all 0.3s; }
    .request-card:hover { border-color: #667eea; transform: translateY(-2px); }
    .request-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #2d3748; }
    .request-name { font-size: 22px; font-weight: bold; }
    .request-id { font-size: 13px; color: #94a3b8; margin-top: 5px; font-family: monospace; }
    .request-status { padding: 8px 20px; border-radius: 20px; font-weight: bold; min-width: 140px; text-align: center; }
    .status-pending { background: #f39c12; color: #000; }
    .status-completed { background: #27ae60; color: #fff; }
    .status-failed { background: #e74c3c; color: #fff; }
    .status-payment { background: #8b5cf6; color: #fff; }
    .status-cancelled { background: #475569; color: #fff; }
    .progress-container { background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 10px; margin: 25px 0; }
    .progress-title { text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #667eea; }
    .progress-steps { display: flex; justify-content: space-between; position: relative; margin-bottom: 30px; }
    .progress-steps::before { content: ''; position: absolute; top: 20px; left: 15px; right: 15px; height: 4px; background: #2d3748; z-index: 1; }
    .step { text-align: center; position: relative; z-index: 2; width: 80px; }
    .step-circle { width: 40px; height: 40px; border-radius: 50%; background: #2d3748; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold; border: 3px solid #2d3748; transition: all 0.3s; }
    .step-label { font-size: 12px; color: #94a3b8; font-weight: 500; }
    .step.done .step-circle { background: #27ae60; border-color: #27ae60; color: #fff; }
    .step.current .step-circle { background: #667eea; border-color: #667eea; color: #fff; transform: scale(1.1); }
    .step-label.ru { display: block; font-size: 13px; color: #fff; margin-top: 4px; }
    .step-label.en { display: block; font-size: 11px; color: #94a3b8; }
    .step-log { font-size: 11px; color: #64748b; margin-top: 4px; max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .step.done .step-log { color: #86efac; }
    .actions { display: flex; gap: 12px; margin-top: 25px; flex-wrap: wrap; }
    .btn { padding: 12px 25px; border: none; border-radius: 8px; color: #fff; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; min-width: 160px; justify-content: center; }
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); }
    .btn-success { background: linear-gradient(135deg, #27ae60, #2ecc71); }
    .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); color: #000; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.3); }
    .details-section { margin: 25px 0; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 8px; }
    .section-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #667eea; display: flex; align-items: center; gap: 10px; }
    .content-text { font-size: 14px; line-height: 1.7; white-space: pre-wrap; max-height: 250px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; }
    .audio-player { width: 100%; margin: 15px 0; }
    .loading { text-align: center; padding: 50px; color: #94a3b8; }
    .spinner { width: 40px; height: 40px; border: 4px solid rgba(102,126,234,0.3); border-top-color: #667eea; border-radius: 50%; margin: 0 auto 15px; animation: spin 1s linear infinite; }
    .mono-panel { margin-bottom: 22px; padding: 16px; border-radius: 10px; border: 1px solid #334155; background: rgba(15, 23, 42, 0.5); }
    .mono-panel h3 { margin: 0 0 10px 0; color: #c4b5fd; font-size: 16px; }
    .mono-table-wrap { overflow-x: auto; border-radius: 8px; border: 1px solid #334155; }
    .mono-table { width: 100%; border-collapse: collapse; min-width: 860px; }
    .mono-table th, .mono-table td { border-bottom: 1px solid #334155; padding: 8px; font-size: 12px; vertical-align: middle; }
    .mono-table th { background: rgba(30, 41, 59, 0.7); color: #cbd5e1; text-align: left; }
    .mono-table td input, .mono-table td select { width: 100%; background: #0f172a; color: #fff; border: 1px solid #475569; border-radius: 6px; padding: 6px 8px; font-size: 12px; }
    .mono-table td input[type="checkbox"] { width: auto; transform: scale(1.05); }
    .mono-muted { color: #94a3b8; font-size: 12px; }
    .mono-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .mono-msg { margin-top: 8px; font-size: 12px; min-height: 18px; }
    /* –°–µ–∫—Ü–∏—è –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫ */
    .unpaid-section { background: rgba(139,92,246,0.08); border: 2px solid #8b5cf6; border-radius: 14px; padding: 20px 24px; margin-bottom: 28px; display: none; }
    .unpaid-section.has-items { display: block; }
    .unpaid-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .unpaid-section-title { font-size: 18px; font-weight: bold; color: #c4b5fd; display: flex; align-items: center; gap: 10px; }
    .unpaid-badge { background: #8b5cf6; color: #fff; border-radius: 20px; padding: 2px 12px; font-size: 14px; font-weight: bold; }
    .unpaid-card { background: #1a1a2e; border: 1px solid #4c1d95; border-radius: 10px; padding: 14px 18px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; }
    .unpaid-card:last-child { margin-bottom: 0; }
    .unpaid-info { flex: 1; }
    .unpaid-name { font-size: 16px; font-weight: bold; margin-bottom: 4px; }
    .unpaid-meta { font-size: 12px; color: #94a3b8; line-height: 1.6; }
    .unpaid-actions { display: flex; gap: 8px; flex-shrink: 0; flex-direction: column; }
    .btn-cancel { background: linear-gradient(135deg, #e74c3c, #c0392b); min-width: 120px; }
    .btn-restore { background: linear-gradient(135deg, #059669, #10b981); min-width: 120px; }
    .pay-filter-bar { background: #1a1a2e; padding: 10px 15px; border-radius: 10px; margin-bottom: 16px; display: flex; gap: 7px; flex-wrap: wrap; align-items: center; border: 1px solid rgba(212,175,55,0.15); }
    .pay-filter-bar span { font-size: 12px; color: #d4af37; margin-right: 4px; font-weight: 600; }
    .pay-filter-btn { padding: 5px 13px; background: #2d3748; border: 1px solid #4a5568; color: #cbd5e1; border-radius: 6px; cursor: pointer; font-size: 12px; font-family: inherit; transition: all 0.15s; }
    .pay-filter-btn:hover { background: #4a5568; }
    .pay-filter-btn.active { background: linear-gradient(135deg,#d4af37,#ec4899); border-color: #d4af37; color: #fff; font-weight: 700; }
    .bulk-actions-bar { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; padding: 12px 16px; margin-bottom: 16px; background: #1a1a2e; border-radius: 10px; border: 1px solid #334155; }
    .bulk-actions-bar label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #cbd5e1; user-select: none; }
    .bulk-actions-bar input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .bulk-actions-bar .btn { min-width: auto; padding: 10px 20px; }
    .request-card .req-select-wrap { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; }
    .request-card .req-select-wrap input[type="checkbox"] { margin-top: 4px; width: 18px; height: 18px; cursor: pointer; flex-shrink: 0; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 768px) {
      .header h1 { font-size: 26px; }
      .stat-number { font-size: 36px; }
      .progress-steps { flex-wrap: wrap; }
      .step { width: 100%; margin-bottom: 20px; }
      .actions { flex-direction: column; }
      .btn { width: 100%; min-width: auto; }
    }
  </style>
</head>
<body style="background:#0f0f1b;color:#fff;font-family:'Comfortaa',system-ui,sans-serif;">
  <div class="container">
    <div class="header">
      <h1>üëë –ê–î–ú–ò–ù–ö–ê YUP SOUL</h1>
      <p>–ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–≤—É–∫–æ–≤—ã—Ö –∫–ª—é—á–µ–π / Full control of sound key generation</p>
      <p id="url-info" style="font-size:12px;color:#64748b;margin-top:8px;word-break:break-all;"></p>
      <div id="loadingStatus" style="display:none;margin-top:10px;padding:8px 14px;background:rgba(102,126,234,0.12);border:1px solid rgba(102,126,234,0.3);border-radius:8px;font-size:13px;color:#a5b4fc;display:flex;align-items:center;gap:8px;">
        <span style="display:inline-block;width:14px;height:14px;border:2px solid rgba(102,126,234,0.3);border-top-color:#667eea;border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0;"></span>
        <span id="loadingStatusText">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶</span>
      </div>
    </div>
    <div class="stats">
      <div class="stat-card active-filter" data-filter="all" onclick="filterByCard(this)" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞—è–≤–∫–∏">
        <div class="stat-label">üìã –í—Å–µ–≥–æ / Total</div>
        <div class="stat-number" id="total">-</div>
        <div style="font-size:11px;color:#64748b;margin-top:4px;">–Ω–∞–∂–º–∏ ‚Üí —Å–ø–∏—Å–æ–∫</div>
      </div>
      <div class="stat-card pending" data-filter="pending" onclick="filterByCard(this)" title="–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞—è–≤–∫–∏ –≤ —Ä–∞–±–æ—Ç–µ">
        <div class="stat-label">‚è≥ –í —Ä–∞–±–æ—Ç–µ</div>
        <div class="stat-number" id="pending">-</div>
        <div style="font-size:11px;color:#64748b;margin-top:4px;">–Ω–∞–∂–º–∏ ‚Üí —Å–ø–∏—Å–æ–∫</div>
      </div>
      <div class="stat-card completed" data-filter="completed" onclick="filterByCard(this)" title="–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ">
        <div class="stat-label">‚úÖ –ì–æ—Ç–æ–≤–æ</div>
        <div class="stat-number" id="completed">-</div>
        <div style="font-size:11px;color:#64748b;margin-top:4px;">–Ω–∞–∂–º–∏ ‚Üí —Å–ø–∏—Å–æ–∫</div>
      </div>
      <div class="stat-card failed" data-filter="failed" onclick="filterByCard(this)" title="–ü–æ–∫–∞–∑–∞—Ç—å —Å –æ—à–∏–±–∫–∞–º–∏">
        <div class="stat-label">‚ùå –û—à–∏–±–∫–∏</div>
        <div class="stat-number" id="failed">-</div>
        <div style="font-size:11px;color:#64748b;margin-top:4px;">–Ω–∞–∂–º–∏ ‚Üí —Å–ø–∏—Å–æ–∫</div>
      </div>
      <div class="stat-card" style="border-left-color:#8b5cf6;" data-filter="pending_payment" onclick="filterByCard(this)" title="–ü–æ–∫–∞–∑–∞—Ç—å –æ–∂–∏–¥–∞—é—â–∏–µ –æ–ø–ª–∞—Ç—ã">
        <div class="stat-label">üí≥ –û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã</div>
        <div class="stat-number" id="stat-pending-payment">-</div>
        <div style="font-size:11px;color:#64748b;margin-top:4px;">–Ω–∞–∂–º–∏ ‚Üí —Å–ø–∏—Å–æ–∫</div>
      </div>
      <div class="stat-card" style="border-left-color:#475569;" data-filter="cancelled" onclick="filterByCard(this)" title="–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ">
        <div class="stat-label">üö´ –û—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ</div>
        <div class="stat-number" id="stat-cancelled">-</div>
        <div style="font-size:11px;color:#64748b;margin-top:4px;">–Ω–∞–∂–º–∏ ‚Üí —Å–ø–∏—Å–æ–∫</div>
      </div>
    </div>
    <!-- –°–µ–∫—Ü–∏—è –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫ (–æ–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã) -->
    <div class="unpaid-section" id="unpaidSection">
      <div class="unpaid-section-header">
        <div class="unpaid-section-title">
          ‚ö†Ô∏è –ù–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
          <span class="unpaid-badge" id="unpaidBadge">0</span>
        </div>
        <button class="btn btn-primary" style="min-width:140px;padding:10px 16px;font-size:13px;" onclick="loadUnpaidRequests()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <p style="font-size:13px;color:#94a3b8;margin-bottom:14px;">–ó–∞—è–≤–∫–∏ –±–µ–∑ –æ–ø–ª–∞—Ç—ã, –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–æ—Ç–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ ¬´–û–ø–ª–∞—Ç–∏—Ç—å¬ª / ¬´–û—Ç–º–µ–Ω–∏—Ç—å¬ª.</p>
      <div id="unpaidList"><div class="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div></div>
    </div>

    <div class="filters">
      <button class="filter-btn active" data-filter="all">üìã –í—Å–µ</button>
      <button class="filter-btn" data-filter="pending">‚è≥ –í —Ä–∞–±–æ—Ç–µ</button>
      <button class="filter-btn" data-filter="pending_payment">üí≥ –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã</button>
      <button class="filter-btn" data-filter="completed">‚úÖ –ì–æ—Ç–æ–≤–æ</button>
      <button class="filter-btn" data-filter="failed">‚ùå –û—à–∏–±–∫–∏</button>
      <button class="filter-btn" data-filter="cancelled">üö´ –û—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ</button>
    </div>
    <div class="sort-bar">
      <span>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</span>
      <button class="sort-btn active" data-sort="date_desc" onclick="setSort(this)">üïê –ù–æ–≤—ã–µ –ø–µ—Ä–≤—ã–µ</button>
      <button class="sort-btn" data-sort="date_asc" onclick="setSort(this)">üïê –°—Ç–∞—Ä—ã–µ –ø–µ—Ä–≤—ã–µ</button>
      <button class="sort-btn" data-sort="name_asc" onclick="setSort(this)">üë§ –ò–º—è –ê‚Äì–Ø</button>
      <button class="sort-btn" data-sort="status" onclick="setSort(this)">üìä –ü–æ —Å—Ç–∞—Ç—É—Å—É</button>
      <button class="sort-btn" data-sort="payment" onclick="setSort(this)">üí≥ –ü–æ –æ–ø–ª–∞—Ç–µ</button>
    </div>
    <div class="pay-filter-bar">
      <span>üí≥ –û–ø–ª–∞—Ç–∞:</span>
      <button class="pay-filter-btn active" data-pay="all" onclick="setPayFilter(this)">–í—Å–µ</button>
      <button class="pay-filter-btn" data-pay="gift" onclick="setPayFilter(this)">üéÅ –ü–µ—Ä–≤—ã–π –ø–æ–¥–∞—Ä–æ–∫</button>
      <button class="pay-filter-btn" data-pay="promo" onclick="setPayFilter(this)">üè∑ –ü—Ä–æ–º–æ–∫–æ–¥</button>
      <button class="pay-filter-btn" data-pay="hot" onclick="setPayFilter(this)">üí≥ HOT Pay</button>
      <button class="pay-filter-btn" data-pay="subscription" onclick="setPayFilter(this)">üìã –ü–æ–¥–ø–∏—Å–∫–∞</button>
      <button class="pay-filter-btn" data-pay="awaiting" onclick="setPayFilter(this)">‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã</button>
      <button class="pay-filter-btn" data-pay="admin" onclick="setPayFilter(this)">üîß –†—É—á–Ω–∞—è</button>
    </div>
    <div class="details-section" style="margin-bottom:20px;">
      <div class="section-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
      <p style="font-size:14px;color:#94a3b8;margin-bottom:12px;">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã DeepSeek –¥–ª—è –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: .env –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ &gt; —ç—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.</p>
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
          <label style="display:flex;align-items:center;gap:8px;">
            <span style="min-width:100px;">–ú–æ–¥–µ–ª—å:</span>
            <select id="settings-model" style="min-width:220px;padding:10px;border-radius:8px;border:2px solid #4a5568;background:#1a1a2e;color:#fff;font-size:14px;">
              <option value="deepseek-reasoner">deepseek-reasoner (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: 128K, thinking)</option>
              <option value="deepseek-chat">deepseek-chat</option>
              <option value="deepseek-coder">deepseek-coder</option>
              <option value="">‚Äî –∫–∞–∫ –≤ .env ‚Äî</option>
            </select>
          </label>
        </div>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
          <label style="display:flex;align-items:center;gap:8px;">
            <span style="min-width:100px;">max_tokens:</span>
            <input type="number" id="settings-max-tokens" min="4096" max="65536" value="8192" step="1" title="–õ–∏–º–∏—Ç DeepSeek API: 1..65536" style="width:100px;padding:10px;border-radius:8px;border:2px solid #4a5568;background:#1a1a2e;color:#fff;font-size:16px;">
          </label>
          <label style="display:flex;align-items:center;gap:8px;">
            <span style="min-width:100px;">temperature:</span>
            <input type="number" id="settings-temperature" min="0" max="2" step="0.1" value="1.5" style="width:80px;padding:10px;border-radius:8px;border:2px solid #4a5568;background:#1a1a2e;color:#fff;font-size:16px;" title="0 = –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ, 1.5 = –∫—Ä–µ–∞—Ç–∏–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)">
          </label>
        </div>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
          <button type="button" class="btn btn-primary" id="settings-save-btn" style="min-width:140px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <span id="settings-save-status" style="font-size:14px;color:#86efac;"></span>
        </div>
      </div>
    </div>
    <div class="details-section" style="margin-bottom:20px;">
      <div class="section-title">üí≥ –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è HOT</div>
      <p class="mono-muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞–º–∏, –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏ –∏ –±—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–ø–ª–∞—Ç.</p>
      <div class="mono-actions">
        <button type="button" class="btn btn-primary" id="monetization-refresh-btn" style="min-width:180px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—é</button>
      </div>
      <div id="monetizationGlobalMsg" class="mono-msg"></div>

      <div class="mono-panel">
        <h3>–¢–∞—Ä–∏—Ñ—ã (pricing_catalog)</h3>
        <div class="mono-table-wrap">
          <table class="mono-table" id="pricingTable">
            <thead>
              <tr>
                <th>SKU</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–¶–µ–Ω–∞</th>
                <th>–í–∞–ª—é—Ç–∞</th>
                <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
                <th>–õ–∏–º–∏—Ç—ã JSON</th>
                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
              </tr>
            </thead>
            <tbody id="pricingTableBody">
              <tr><td colspan="7" class="mono-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
        <div id="pricingMsg" class="mono-msg"></div>
      </div>

      <div class="mono-panel">
        <h3>–ü—Ä–æ–º–æ–∫–æ–¥—ã (promo_codes)</h3>

        <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞ -->
        <details id="newPromoDetails" style="margin-bottom:18px;border:1px solid rgba(212,175,55,0.3);border-radius:10px;padding:12px 16px;background:rgba(212,175,55,0.05);">
          <summary style="cursor:pointer;font-weight:600;color:#d4af37;font-size:0.95rem;list-style:none;">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥</summary>
          <div style="margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div>
              <label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">–ö–æ–¥ <span style="color:#ef4444">*</span></label>
              <input id="newPromoCode" type="text" placeholder="WELCOME10" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;text-transform:uppercase;box-sizing:border-box;">
            </div>
            <div>
              <label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">–¢–∏–ø <span style="color:#ef4444">*</span></label>
              <select id="newPromoType" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;">
                <option value="discount_percent">% —Å–∫–∏–¥–∫–∞ (discount_percent)</option>
                <option value="discount_amount">–°—É–º–º–∞ —Å–∫–∏–¥–∫–∏ (discount_amount)</option>
                <option value="free_generation">–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (free_generation)</option>
              </select>
            </div>
            <div>
              <label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">–ó–Ω–∞—á–µ–Ω–∏–µ (% –∏–ª–∏ —Å—É–º–º–∞)</label>
              <input id="newPromoValue" type="number" step="0.01" min="0" placeholder="10" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;">
            </div>
            <div>
              <label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">SKU (–ø—É—Å—Ç–æ = –¥–ª—è –≤—Å–µ—Ö)</label>
              <input id="newPromoSku" type="text" placeholder="single_song" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;">
            </div>
            <div>
              <label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">–ú–∞–∫—Å. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π (–ø—É—Å—Ç–æ = ‚àû)</label>
              <input id="newPromoMaxUses" type="number" step="1" min="1" placeholder="100" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;">
            </div>
            <div>
              <label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">–õ–∏–º–∏—Ç –Ω–∞ 1 —é–∑–µ—Ä–∞</label>
              <input id="newPromoPerUser" type="number" step="1" min="1" value="1" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;">
            </div>
            <div>
              <label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">–î–µ–π—Å—Ç–≤—É–µ—Ç —Å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
              <input id="newPromoStartsAt" type="datetime-local" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;">
            </div>
            <div>
              <label style="font-size:0.8rem;color:#94a3b8;display:block;margin-bottom:4px;">–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
              <input id="newPromoExpiresAt" type="datetime-local" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#fff;font-size:0.9rem;box-sizing:border-box;">
            </div>
          </div>
          <div style="margin-top:12px;display:flex;align-items:center;gap:12px;">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;color:#94a3b8;font-size:0.88rem;">
              <input id="newPromoActive" type="checkbox" checked style="width:16px;height:16px;"> –ê–∫—Ç–∏–≤–µ–Ω —Å—Ä–∞–∑—É
            </label>
            <button onclick="createPromoCode()" class="btn btn-primary" style="padding:9px 22px;font-size:0.9rem;">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
          </div>
        </details>

        <div class="mono-table-wrap">
          <table class="mono-table" id="promoTable">
            <thead>
              <tr>
                <th>–ö–æ–¥</th>
                <th>–¢–∏–ø</th>
                <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                <th>SKU</th>
                <th>–ú–∞–∫—Å / –ù–∞ —é–∑–µ—Ä–∞</th>
                <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
                <th>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ</th>
                <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody id="promoTableBody">
              <tr><td colspan="9" class="mono-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
        <div id="promoMsg" class="mono-msg"></div>
      </div>

      <div class="mono-panel">
        <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–ª–∞—Ç—ã</h3>
        <div class="mono-table-wrap">
          <table class="mono-table" id="paymentsTable">
            <thead>
              <tr>
                <th>–î–∞—Ç–∞</th>
                <th>Request ID</th>
                <th>–ò–º—è</th>
                <th>SKU/Mode</th>
                <th>–ü—Ä–æ–≤–∞–π–¥–µ—Ä</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–°—É–º–º–∞</th>
                <th>Order</th>
                <th>TX</th>
                <th>–ü—Ä–æ–º–æ</th>
              </tr>
            </thead>
            <tbody id="paymentsTableBody">
              <tr><td colspan="10" class="mono-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
        <div id="paymentsMsg" class="mono-msg"></div>
      </div>

      <div class="mono-panel">
        <h3>üîó –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h3>
        <div style="display:flex;gap:16px;margin-bottom:16px;flex-wrap:wrap;">
          <div style="background:#1e293b;border-radius:10px;padding:14px 20px;text-align:center;min-width:140px;flex:1;">
            <div id="refTotalCount" style="font-size:2rem;font-weight:700;color:#a78bfa;">‚Äî</div>
            <div style="font-size:0.78rem;color:#64748b;margin-top:4px;">–í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
          </div>
          <div style="background:#1e293b;border-radius:10px;padding:14px 20px;text-align:center;min-width:140px;flex:1;">
            <div id="refRewardedCount" style="font-size:2rem;font-weight:700;color:#22c55e;">‚Äî</div>
            <div style="font-size:0.78rem;color:#64748b;margin-top:4px;">–ù–∞–≥—Ä–∞–¥—ã –≤—ã–¥–∞–Ω—ã</div>
          </div>
        </div>
        <div class="mono-table-wrap">
          <table class="mono-table" id="referralsTable">
            <thead>
              <tr>
                <th>–†–µ—Ñ–µ—Ä–µ—Ä ID</th>
                <th>–†–µ—Ñ–µ—Ä–∞–ª ID</th>
                <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                <th>–î–∞—Ç–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</th>
                <th>–ù–∞–≥—Ä–∞–¥–∞</th>
              </tr>
            </thead>
            <tbody id="referralsTableBody">
              <tr><td colspan="5" class="mono-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
        <div id="referralsMsg" class="mono-msg"></div>
      </div>
    </div>
    <div class="bulk-actions-bar" id="bulkActionsBar" style="display:none;">
      <label><input type="checkbox" id="selectAllRequests" aria-label="–í—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ –∑–∞—è–≤–∫–∏"> –í—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ</label>
      <button type="button" class="btn btn-warning" id="deleteSelectedBtn" disabled title="–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–æ–≤—ã–µ)">üóë –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (<span id="deleteSelectedCount">0</span>)</button>
    </div>
    <div id="requests" class="loading">
      <div class="spinner"></div>
      <div>–ó–∞–≥—Ä—É–∑–∫–∞... / Loading...</div>
    </div>
  </div>

  <script>
    (function() {
      var params = new URLSearchParams(window.location.search);
      var apiOrigin = params.get('api_origin');
      window.API_BASE = (apiOrigin && apiOrigin.startsWith('http')) ? apiOrigin.replace(/\/$/, '') : window.location.origin;
      var el = document.getElementById('url-info');
      if (el) el.textContent = '–°—Ç—Ä–∞–Ω–∏—Ü–∞: ' + window.location.origin + ' ¬∑ –ó–∞–ø—Ä–æ—Å—ã –∫ API: ' + window.API_BASE;
    })();
    let currentFilter = 'all';
    let currentSort = 'date_desc';
    let currentPayFilter = 'all';

    function filterByCard(card) {
      const filter = card.getAttribute('data-filter') || 'all';
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
      document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active-filter'));
      card.classList.add('active-filter');
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏-—Ñ–∏–ª—å—Ç—Ä—ã
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(b => {
        b.classList.toggle('active', b.getAttribute('data-filter') === filter);
      });
      loadAdminData();
      // –°–∫—Ä–æ–ª–ª –∫ —Å–ø–∏—Å–∫—É
      setTimeout(() => document.getElementById('requests')?.scrollIntoView({ behavior: 'smooth', block: 'start' }), 200);
    }

    function setSort(btn) {
      currentSort = btn.getAttribute('data-sort') || 'date_desc';
      document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      // –ü–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä—É–µ–º —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ (–±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—Ä–æ—Å–∞)
      const cards = Array.from(document.querySelectorAll('#requests .request-card'));
      if (!cards.length) return;
      // –ë–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∞
      if (window._lastRequestsData) renderRequests(window._lastRequestsData);
    }

    function sortRequests(data) {
      const sorted = [...data];
      if (currentSort === 'date_desc') {
        sorted.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
      } else if (currentSort === 'date_asc') {
        sorted.sort((a, b) => new Date(a.created_at || 0) - new Date(b.created_at || 0));
      } else if (currentSort === 'name_asc') {
        sorted.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ru'));
      } else if (currentSort === 'status') {
        sorted.sort((a, b) => getStatusOrder(b.generation_status || '') - getStatusOrder(a.generation_status || ''));
      } else if (currentSort === 'payment') {
        const payOrder = { gift_used: 0, subscription_active: 1, paid: 2, requires_payment: 3, pending: 4 };
        sorted.sort((a, b) => (payOrder[a.payment_status] ?? 5) - (payOrder[b.payment_status] ?? 5));
      }
      return sorted;
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º ¬´—Ç–∏–ø –æ–ø–ª–∞—Ç—ã¬ª –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    function getPayType(r) {
      const provider = String(r.payment_provider || '').toLowerCase();
      const status   = String(r.payment_status  || '').toLowerCase();
      const promo    = r.promo_code ? String(r.promo_code).toUpperCase() : null;
      const gs       = String(r.generation_status || '').toLowerCase();
      if (gs === 'pending_payment' || status === 'requires_payment') return 'awaiting';
      if (status === 'gift_used') return 'gift';
      if (provider === 'subscription' || status === 'subscription_active') return 'subscription';
      if (provider === 'promo' || (promo && provider !== 'hot')) return 'promo';
      if (provider === 'hot') return 'hot';
      if (provider === 'admin') return 'admin';
      if (provider === 'gift') return 'gift';
      return 'unknown';
    }

    function paymentMethodBadge(r) {
      const provider = String(r.payment_provider || '').toLowerCase();
      const status   = String(r.payment_status  || '').toLowerCase();
      const promo    = r.promo_code ? String(r.promo_code) : null;
      const gs       = String(r.generation_status || '').toLowerCase();
      const payType  = getPayType(r);

      if (gs === 'pending_payment' || status === 'requires_payment') {
        const amt = r.payment_amount != null ? (' ¬∑ ' + r.payment_amount + ' ' + (r.payment_currency || 'USDT')) : '';
        return '<span class="pay-badge" style="background:rgba(139,92,246,.25);color:#c4b5fd;">‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã' + escapeHtml(amt) + '</span>';
      }
      if (payType === 'gift') {
        return '<span class="pay-badge pay-badge-free">üéÅ –ü–µ—Ä–≤—ã–π –ø–æ–¥–∞—Ä–æ–∫</span>';
      }
      if (payType === 'promo') {
        const label = promo ? ('üè∑ ' + escapeHtml(promo)) : 'üè∑ –ü—Ä–æ–º–æ–∫–æ–¥';
        const disc = r.promo_discount_amount ? (' ‚àí' + r.promo_discount_amount) : '';
        return '<span class="pay-badge pay-badge-promo">' + label + escapeHtml(disc) + '</span>';
      }
      if (payType === 'hot') {
        if (status === 'paid') return '<span class="pay-badge pay-badge-hot">üí≥ HOT Pay ‚úì</span>';
        return '<span class="pay-badge pay-badge-hot" style="opacity:.75;">üí≥ HOT Pay‚Ä¶</span>';
      }
      if (payType === 'subscription') {
        return '<span class="pay-badge pay-badge-sub">üìã –ü–æ–¥–ø–∏—Å–∫–∞</span>';
      }
      if (payType === 'admin') {
        return '<span class="pay-badge pay-badge-free">üîß –†—É—á–Ω–∞—è</span>';
      }
      if (!provider && !status) return '';
      return '<span class="pay-badge" style="background:rgba(100,116,139,.2);color:#94a3b8;">' + escapeHtml(provider || status) + '</span>';
    }

    function setPayFilter(btn) {
      currentPayFilter = btn.getAttribute('data-pay') || 'all';
      document.querySelectorAll('.pay-filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      if (window._lastRequestsData) renderRequests(window._lastRequestsData);
    }

    function filterByPayment(data) {
      if (!currentPayFilter || currentPayFilter === 'all') return data;
      return data.filter(r => getPayType(r) === currentPayFilter);
    }

    function getToken() {
      const fromUrl = new URLSearchParams(window.location.search).get('token');
      if (fromUrl) {
        try { localStorage.setItem('adminToken', fromUrl); } catch (e) {}
        return fromUrl;
      }
      return localStorage.getItem('adminToken');
    }
    function authHeaders() {
      const t = getToken();
      return t ? { 'X-Admin-Token': t } : {};
    }
    function authQuery() {
      const t = getToken();
      return t ? '&token=' + encodeURIComponent(t) : '';
    }
    function authQueryFromPath() {
      const t = getToken();
      return t ? '?token=' + encodeURIComponent(t) : '';
    }

    function setMonoMsg(id, text, ok) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = text || '';
      el.style.color = ok === true ? '#86efac' : (ok === false ? '#fca5a5' : '#94a3b8');
    }

    async function fetchJson(url, opts, timeoutMs) {
      timeoutMs = timeoutMs || 15000;
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeoutMs);
      let res;
      try {
        res = await fetch(url, Object.assign({}, opts, { signal: controller.signal }));
      } catch (e) {
        clearTimeout(timer);
        if (e && e.name === 'AbortError') throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –∑–∞ ' + (timeoutMs/1000) + ' —Å–µ–∫. Render –º–æ–≥ —É—Å–Ω—É—Ç—å ‚Äî –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5) —á–µ—Ä–µ–∑ 30 —Å–µ–∫.');
        throw new Error('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: ' + (e && e.message));
      }
      clearTimeout(timer);
      const text = await res.text();
      if (text.trim().startsWith('<')) {
        if (res.status === 502 || res.status === 503) {
          throw new Error('–°–µ—Ä–≤–µ—Ä –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è (502/503). –ü–æ–¥–æ–∂–¥–∏—Ç–µ 30‚Äì60 —Å–µ–∫ –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5).');
        }
        throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª HTML –≤–º–µ—Å—Ç–æ –¥–∞–Ω–Ω—ã—Ö (–∫–æ–¥ ' + res.status + '). –û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ –±–æ—Ç–∞ (/admin).');
      }
      try {
        return { res, json: JSON.parse(text) };
      } catch (e) {
        throw new Error('–û—Ç–≤–µ—Ç –Ω–µ JSON (—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω–µ —Ç–æ—Ç –∞–¥—Ä–µ—Å). –û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ –±–æ—Ç–∞ (/admin).');
      }
    }

    function setLoadingStatus(visible, text) {
      const el = document.getElementById('loadingStatus');
      const textEl = document.getElementById('loadingStatusText');
      if (!el) return;
      el.style.display = visible ? 'flex' : 'none';
      if (textEl && text) textEl.textContent = text;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞, –≤—ã–≤–æ–¥–∏—Ç —Å—Ç–∞—Ç—É—Å
    async function checkApiStatus() {
      const token = getToken();
      if (!token) return; // –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ ‚Äî –ø–æ–∫–∞–∂–µ—Ç —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
      const statusEl = document.getElementById('loadingStatus');
      const textEl = document.getElementById('loadingStatusText');
      if (statusEl) statusEl.style.display = 'flex';
      if (textEl) textEl.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API‚Ä¶';
      try {
        const r = await fetchJson(API_BASE + '/api/admin/me' + authQueryFromPath(), { headers: authHeaders() }, 8000);
        if (r.json && r.json.admin) {
          if (textEl) textEl.textContent = '‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω, —Ç–æ–∫–µ–Ω –≤–µ—Ä–Ω—ã–π ‚Äî –∑–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ‚Ä¶';
        } else {
          if (statusEl) statusEl.style.background = 'rgba(239,68,68,0.12)';
          if (statusEl) statusEl.style.borderColor = 'rgba(239,68,68,0.3)';
          if (textEl) { textEl.style.color = '#fca5a5'; textEl.textContent = '‚ùå –¢–æ–∫–µ–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π (403). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ADMIN_SECRET –≤ Render Dashboard.'; }
        }
      } catch (e) {
        if (statusEl) statusEl.style.background = 'rgba(239,68,68,0.12)';
        if (statusEl) statusEl.style.borderColor = 'rgba(239,68,68,0.3)';
        if (textEl) { textEl.style.color = '#fca5a5'; textEl.textContent = '‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ' + escapeHtml((e && e.message) || String(e)); }
        const el = document.getElementById('requests');
        if (el) el.innerHTML = '<div style="text-align:center;padding:40px;color:#e74c3c">‚ùå ' + escapeHtml((e && e.message) || String(e)) + '<br><br><button onclick="window.location.reload()" style="margin-top:12px;padding:10px 24px;background:#667eea;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:15px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button></div>';
        return false;
      }
      return true;
    }

    async function loadAdminData() {
      const token = getToken();
      if (!token) {
        const el = document.getElementById('requests');
        if (el) el.innerHTML = '<div style="text-align:center;padding:40px;color:#e0e0e0"><p style="margin-bottom:20px">üîë –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ / Enter admin token</p><form id="token-form" style="display:flex;flex-direction:column;align-items:center;gap:12px;max-width:320px;margin:0 auto"><input type="password" id="token-input" placeholder="–¢–æ–∫–µ–Ω" style="width:100%;padding:12px;border-radius:8px;border:2px solid #667eea;background:#1a1a2e;color:#fff;font-size:16px" autocomplete="off"><button type="submit" style="padding:12px 24px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer">–í–æ–π—Ç–∏ / Login</button></form></div>';
        const form = document.getElementById('token-form');
        const input = document.getElementById('token-input');
        if (form && input) form.addEventListener('submit', function(e) { e.preventDefault(); const v = (input.value || '').trim(); if (v) { localStorage.setItem('adminToken', v); window.location.search = '?token=' + encodeURIComponent(v); } });
        return;
      }
      setLoadingStatus(true, '–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏‚Ä¶');
      try {
        const statsResult = await fetchJson(API_BASE + '/api/admin/stats?' + new URLSearchParams({ token }).toString(), { headers: authHeaders() });
        if (statsResult.res.status === 503) {
          const msg = (statsResult.json && statsResult.json.error) || '–°–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è';
          document.getElementById('requests').innerHTML = '<div style="text-align:center;padding:40px;color:#f39c12">‚è≥ ' + escapeHtml(msg) + '<br><br>–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 20‚Äì30 —Å–µ–∫ (F5).</div>';
          return;
        }
        const statsJson = statsResult.json;
        if (statsJson.success && statsJson.stats) {
          const s = statsJson.stats;
          document.getElementById('total').textContent = s.total;
          document.getElementById('pending').textContent = (s.pending || 0) + (s.astro_calculated || 0) + (s.lyrics_generated || 0) + (s.suno_processing || 0);
          document.getElementById('completed').textContent = s.completed || 0;
          document.getElementById('failed').textContent = s.failed || 0;
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –æ–∂–∏–¥–∞—é—â–∏—Ö –æ–ø–ª–∞—Ç—ã
          const ppEl = document.getElementById('stat-pending-payment');
          if (ppEl) ppEl.textContent = s.pending_payment || 0;
          const cancelledEl = document.getElementById('stat-cancelled');
          if (cancelledEl) cancelledEl.textContent = s.cancelled || 0;
        }
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∫–∞—Ä—Ç–æ—á–µ–∫ —Å —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–æ–º
        document.querySelectorAll('.stat-card').forEach(c => {
          c.classList.toggle('active-filter', c.getAttribute('data-filter') === currentFilter);
        });
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ (pending_payment) —Å—Ä–∞–∑—É –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
        loadUnpaidRequests();
        setLoadingStatus(true, '–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫‚Ä¶');
        const listResult = await fetchJson(API_BASE + '/api/admin/requests?limit=50&status=' + currentFilter + authQuery(), { headers: authHeaders() });
        const listJson = listResult.json;
        const listRes = listResult.res;
        if (listJson.success && Array.isArray(listJson.data)) renderRequests(listJson.data);
        else {
          const err = listJson.error || listRes.status || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
          document.getElementById('requests').innerHTML = '<div style="text-align:center;padding:40px;color:#e74c3c">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + escapeHtml(String(err)) + '<br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω / Check token</div>';
        }
        const settingsResult = await fetchJson(API_BASE + '/api/admin/settings' + authQueryFromPath(), { headers: authHeaders() });
        const settingsJson = settingsResult.json;
        if (settingsJson.success && settingsJson.settings) {
          const st = settingsJson.settings;
          const mt = st.deepseek_max_tokens;
          const inputEl = document.getElementById('settings-max-tokens');
          if (inputEl && (mt === 0 || mt > 0)) inputEl.value = Math.max(4096, Number(mt)) || 8192;
          const modelEl = document.getElementById('settings-model');
          if (modelEl && st.deepseek_model) {
            const opt = Array.from(modelEl.options).find(o => o.value === st.deepseek_model);
            if (opt) modelEl.value = st.deepseek_model;
            else { const o = new Option(st.deepseek_model, st.deepseek_model); modelEl.appendChild(o); modelEl.value = st.deepseek_model; }
          }
          const tempEl = document.getElementById('settings-temperature');
          if (tempEl && st.deepseek_temperature != null && Number.isFinite(Number(st.deepseek_temperature))) tempEl.value = Math.max(0, Math.min(2, Number(st.deepseek_temperature)));
        }
        setLoadingStatus(true, '–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏ –∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤‚Ä¶');
        await loadMonetizationData();
        loadReferralData();
        setLoadingStatus(false);
      } catch (e) {
        setLoadingStatus(false);
        const msg = (e && e.message) || String(e);
        const el = document.getElementById('requests');
        if (el) el.innerHTML = '<div style="text-align:center;padding:40px;color:#e74c3c">‚ùå ' + escapeHtml(msg) + '<br><br><button onclick="window.location.reload()" style="margin-top:12px;padding:10px 24px;background:#667eea;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:15px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button><br><br><span style="font-size:12px;color:#64748b">API: ' + escapeHtml(window.API_BASE || window.location.origin) + '</span></div>';
      }
    }

    function getStatusOrder(status) {
      const order = { pending_payment: -1, pending: 1, astro_calculated: 2, lyrics_generated: 3, suno_processing: 4, completed: 5, failed: 0, cancelled: -2 };
      return order[status] !== undefined ? order[status] : 1;
    }
    function statusClass(gs) {
      if (gs === 'completed') return 'status-completed';
      if (gs === 'failed') return 'status-failed';
      if (gs === 'pending_payment') return 'status-payment';
      if (gs === 'cancelled') return 'status-cancelled';
      return 'status-pending';
    }
    function statusLabel(gs) {
      if (gs === 'completed') return '‚úÖ –ì–æ—Ç–æ–≤–æ';
      if (gs === 'failed') return '‚ùå –û—à–∏–±–∫–∞';
      if (gs === 'pending_payment') return 'üí≥ –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã';
      if (gs === 'cancelled') return 'üö´ –û—Ç–º–µ–Ω–µ–Ω–∞';
      return '‚è≥ –í —Ä–∞–±–æ—Ç–µ';
    }
    function paymentLabel(ps) {
      if (!ps) return { text: '‚Äî', cls: 'mono-muted' };
      const s = String(ps).toLowerCase();
      if (['paid', 'gift_used', 'subscription_active'].includes(s)) return { text: '‚úÖ –û–ø–ª–∞—á–µ–Ω–æ', cls: '' };
      if (['requires_payment', 'pending'].includes(s)) return { text: '‚ö†Ô∏è –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ', cls: '' };
      return { text: String(ps), cls: '' };
    }

    function normalizeSteps(raw) {
      if (raw && typeof raw === 'object') return raw;
      if (typeof raw === 'string') {
        try { return JSON.parse(raw); } catch (e) { return {}; }
      }
      return {};
    }
    function renderRequests(data) {
      window._lastRequestsData = data; // –∫—ç—à –¥–ª—è –ø–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞
      data = filterByPayment(data);
      data = sortRequests(data);
      const payLabel = currentPayFilter !== 'all' ? (' ¬∑ –û–ø–ª–∞—Ç–∞: ' + currentPayFilter) : '';
      if (!data.length) {
        document.getElementById('requests').innerHTML = '<div style="text-align:center;padding:60px;color:#94a3b8">üì≠ –ù–µ—Ç –∑–∞—è–≤–æ–∫' + escapeHtml(payLabel) + '</div>';
        var bulkBar = document.getElementById('bulkActionsBar');
        if (bulkBar) bulkBar.style.display = 'none';
        return;
      }
      function stepMsg(steps, key) {
        if (!steps || typeof steps !== 'object') return '';
        const v = steps[key];
        return (v && String(v).trim()) ? escapeHtml(String(v).slice(0, 120)) : '';
      }
      function stepsDigest(steps) {
        const s = normalizeSteps(steps);
        const checks = [];
        if (s.astro_extensions) checks.push('–∞—Å—Ç—Ä–æ+: ' + escapeHtml(String(s.astro_extensions)));
        if (s.llm_response_saved) checks.push('deepseek: ' + escapeHtml(String(s.llm_response_saved)));
        if (s.cover_ready) checks.push('cover: ' + escapeHtml(String(s.cover_ready)));
        if (s.delivery_done) checks.push('delivery: ' + escapeHtml(String(s.delivery_done)));
        return checks.join(' ¬∑ ');
      }
      document.getElementById('requests').innerHTML = data.map(r => {
        const gs = r.generation_status || r.status || 'pending';
        const order = getStatusOrder(gs);
        const steps = normalizeSteps(r.generation_steps);
        const safeId = (r.id || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        const safeIdAttr = escapeAttr(r.id || '');
        return `
        <div class="request-card" data-request-id="${safeIdAttr}">
          <div class="req-select-wrap"><input type="checkbox" class="req-select-cb" data-request-id="${safeIdAttr}" aria-label="–í—ã–¥–µ–ª–∏—Ç—å –∑–∞—è–≤–∫—É"><span style="color:#94a3b8;font-size:12px;">–í—ã–¥–µ–ª–∏—Ç—å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è</span></div>
          <div class="request-header">
            <div>
              <div class="request-name">${escapeHtml(r.name || '')}${r.person2_name ? ' & ' + escapeHtml(r.person2_name) : ''}</div>
              ${r.person2_name ? '<div style="font-size:12px;color:#94a3b8;margin-top:4px;">' +
                escapeHtml(r.gender || '‚Äî') + ' / ' + escapeHtml(r.person2_gender || '‚Äî') +
                (r.person2_birthdate ? (' ¬∑ ' + escapeHtml(r.person2_birthdate)) : '') +
                '</div>' : ''}
              <div class="request-id" title="–ü–æ–ª–Ω—ã–π UUID: ${escapeHtml((r.id || ''))}">ID: ${(r.id || '').substring(0,8)} ‚Ä¢ ${r.created_at ? new Date(r.created_at).toLocaleDateString('ru-RU') : '‚Äî'}</div>
              <div class="request-id">–†–µ–∂–∏–º: ${escapeHtml(r.mode || 'single')}${r.person2_name ? ' ¬∑ –ü–∞—Ä–∞: ' + escapeHtml((r.person2_gender || '‚Äî')) : ''}</div>
              <div class="request-id" style="margin-top:4px;">${paymentMethodBadge(r)}${r.payment_amount != null ? '<span style="color:#94a3b8;font-size:11px;margin-left:6px;">' + escapeHtml(String(r.payment_amount)) + ' ' + escapeHtml(r.payment_currency || 'USDT') + '</span>' : ''}</div>
            </div>
            <div class="request-status ${statusClass(gs)}">${statusLabel(gs)}</div>
          </div>
          <div class="progress-container">
            <div class="progress-title">–¶–µ–ø–æ—á–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ / Generation chain</div>
            <div class="progress-steps">
              <div class="step ${order >= 1 ? 'done' : ''} ${order === 1 ? 'current' : ''}">
                <div class="step-circle">${order >= 1 ? '‚úì' : '1'}</div>
                <div class="step-label ru">–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã</div>
                <div class="step-label en">Data received</div>
                ${stepMsg(steps, '1') ? '<div class="step-log" title="' + stepMsg(steps, '1') + '">' + stepMsg(steps, '1') + '</div>' : ''}
              </div>
              <div class="step ${order >= 2 ? 'done' : ''} ${order === 2 ? 'current' : ''}">
                <div class="step-circle">${order >= 2 ? '‚úì' : '2'}</div>
                <div class="step-label ru">–ê–Ω–∞–ª–∏–∑ –ò–ò</div>
                <div class="step-label en">AI analysis</div>
                ${stepMsg(steps, '2') ? '<div class="step-log" title="' + stepMsg(steps, '2') + '">' + stepMsg(steps, '2') + '</div>' : ''}
              </div>
              <div class="step ${order >= 3 ? 'done' : ''} ${order === 3 ? 'current' : ''}">
                <div class="step-circle">${order >= 3 ? '‚úì' : '3'}</div>
                <div class="step-label ru">–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏</div>
                <div class="step-label en">Song lyrics</div>
                ${stepMsg(steps, '3') ? '<div class="step-log" title="' + stepMsg(steps, '3') + '">' + stepMsg(steps, '3') + '</div>' : ''}
              </div>
              <div class="step ${order >= 4 ? 'done' : ''} ${order === 4 ? 'current' : ''}">
                <div class="step-circle">${order >= 4 ? '‚úì' : '4'}</div>
                <div class="step-label ru">–ê—É–¥–∏–æ</div>
                <div class="step-label en">Audio</div>
                ${stepMsg(steps, '4') ? '<div class="step-log" title="' + stepMsg(steps, '4') + '">' + stepMsg(steps, '4') + '</div>' : ''}
              </div>
            </div>
            ${steps.error ? '<div class="details-section" style="margin-top:12px;"><div class="section-title" style="color:#e74c3c;">‚ùå –û—à–∏–±–∫–∞ —ç—Ç–∞–ø–∞</div><div class="content-text" style="font-size:12px;">' + stepMsg(steps, 'error') + '</div></div>' : ''}
          </div>
          <div class="details-section">
            <div class="section-title">üí¨ –ó–∞–ø—Ä–æ—Å / Request</div>
            <div class="content-text">${escapeHtml((r.request || '‚Äî').substring(0, 500))}${(r.request || '').length > 500 ? '‚Ä¶' : ''}</div>
          </div>
          ${stepsDigest(steps) ? '<div class="details-section"><div class="section-title">üß≠ –ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–æ–≤—ã—Ö —ç—Ç–∞–ø–æ–≤</div><div class="content-text" style="font-size:12px;">' + stepsDigest(steps) + '</div></div>' : ''}
          <div class="actions">
            <button class="btn btn-primary" onclick="showDetails('${(r.id || '').replace(/'/g, "\\'")}')">üìã –ü–æ–¥—Ä–æ–±–Ω–µ–µ / Details</button>
            ${['pending','requires_payment'].includes(String((r.payment_status || '').toLowerCase())) ? '<button class="btn btn-success" onclick="markPaid(\'' + (r.id || '').replace(/'/g, "\\'") + '\')">‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –æ–ø–ª–∞—á–µ–Ω–Ω—ã–º</button>' : ''}
            ${gs === 'pending_payment' ? '<button class="btn btn-cancel" onclick="cancelRequest(\'' + (r.id || '').replace(/'/g, "\\'") + '\', this)">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</button>' : ''}
            <button class="btn btn-warning" onclick="restart('${(r.id || '').replace(/'/g, "\\'")}')">${gs === 'completed' ? 'üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å' : 'üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å / Restart'}</button>
            ${r.audio_url ? '<button class="btn btn-success" onclick="window.open(\'' + r.audio_url.replace(/'/g, "\\'") + '\')">‚ñ∂Ô∏è –°–ª—É—à–∞—Ç—å / Listen</button>' : ''}
            ${r.audio_url ? '<button class="btn btn-success" onclick="deliver(\'' + (r.id || '').replace(/'/g, "\\'") + '\', this)">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</button>' : ''}
          </div>
        </div>`;
      }).join('');
      const bulkBar = document.getElementById('bulkActionsBar');
      const selectAllCb = document.getElementById('selectAllRequests');
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      const countSpan = document.getElementById('deleteSelectedCount');
      if (bulkBar) bulkBar.style.display = data.length ? 'flex' : 'none';
      function updateBulkButton() {
        const checkboxes = document.querySelectorAll('#requests .req-select-cb');
        const checked = document.querySelectorAll('#requests .req-select-cb:checked');
        const n = checked.length;
        const total = checkboxes.length;
        if (countSpan) countSpan.textContent = n;
        if (deleteBtn) { deleteBtn.disabled = n === 0; }
        if (selectAllCb) { selectAllCb.checked = total > 0 && n === total; selectAllCb.indeterminate = n > 0 && n < total; }
      }
      function attachBulkListeners() {
        if (!data.length) return;
        if (selectAllCb) {
          selectAllCb.onchange = function() {
            document.querySelectorAll('#requests .req-select-cb').forEach(function(cb) { cb.checked = selectAllCb.checked; });
            updateBulkButton();
          };
        }
        document.querySelectorAll('#requests .req-select-cb').forEach(function(cb) {
          cb.onchange = updateBulkButton;
        });
        if (deleteBtn) {
          deleteBtn.onclick = async function() {
            const ids = Array.from(document.querySelectorAll('#requests .req-select-cb:checked')).map(function(cb) { return cb.getAttribute('data-request-id'); }).filter(Boolean);
            if (!ids.length) return;
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ ' + ids.length + ' –∑–∞—è–≤–æ–∫? –û–Ω–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –∏–∑ –±–∞–∑—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.')) return;
            deleteBtn.disabled = true;
            deleteBtn.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ‚Ä¶';
            try {
              const result = await fetchJson(API_BASE + '/api/admin/requests/delete' + authQueryFromPath(), { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify({ ids: ids }) });
              const json = result.json;
              if (json.success) { alert('–£–¥–∞–ª–µ–Ω–æ –∑–∞—è–≤–æ–∫: ' + (json.deleted || ids.length)); loadAdminData(); }
              else alert('–û—à–∏–±–∫–∞: ' + (json.error || 'unknown'));
            } catch (e) {
              alert('–û—à–∏–±–∫–∞: ' + (e && e.message ? e.message : e));
            } finally {
              deleteBtn.disabled = false;
              deleteBtn.innerHTML = 'üóë –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (<span id="deleteSelectedCount">0</span>)';
              var span = document.getElementById('deleteSelectedCount');
              if (span) span.textContent = '0';
            }
          };
        }
        updateBulkButton();
      }
      attachBulkListeners();
    }
    function escapeHtml(s) {
      if (s == null) return '';
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function escapeAttr(s) {
      return String(s == null ? '' : s).replace(/"/g, '&quot;');
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ (pending_payment) –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å–µ–∫—Ü–∏—é –≤–≤–µ—Ä—Ö—É
    async function loadUnpaidRequests() {
      const section = document.getElementById('unpaidSection');
      const list = document.getElementById('unpaidList');
      const badge = document.getElementById('unpaidBadge');
      if (!list) return;
      list.innerHTML = '<div class="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
      try {
        const result = await fetchJson(
          API_BASE + '/api/admin/requests?status=pending_payment&limit=50' + authQuery(),
          { headers: authHeaders() }
        );
        const items = (result.json && (result.json.data || result.json.requests)) || [];
        if (badge) badge.textContent = items.length;
        if (!items.length) {
          if (section) section.classList.remove('has-items');
          list.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">‚úÖ –ù–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫ –Ω–µ—Ç</div>';
          return;
        }
        if (section) section.classList.add('has-items');
        list.innerHTML = items.map(function(r) {
          const id = escapeHtml(r.id || '');
          const idShort = (r.id || '').substring(0, 8);
          const name = escapeHtml(r.name || '‚Äî');
          const date = r.created_at ? new Date(r.created_at).toLocaleString('ru-RU') : '‚Äî';
          const amount = r.payment_amount ? (r.payment_amount + ' ' + (r.payment_currency || 'USDT')) : '‚Äî';
          const safeId = (r.id || '').replace(/'/g, "\\'");
          return '<div class="unpaid-card">' +
            '<div class="unpaid-info">' +
              '<div class="unpaid-name">' + name + '</div>' +
              '<div class="unpaid-meta">' +
                'ID: <code>' + escapeHtml(idShort) + '</code> ¬∑ ' + date + '<br>' +
                '–°—É–º–º–∞: ' + escapeHtml(amount) + ' ¬∑ –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã: ' + escapeHtml(r.payment_status || '‚Äî') +
              '</div>' +
            '</div>' +
            '<div class="unpaid-actions">' +
              '<button class="btn btn-restore" style="min-width:120px;padding:8px 12px;font-size:13px;" onclick="restoreRequest(\'' + safeId + '\', this)" title="–ó–∞—Å—á–∏—Ç–∞—Ç—å –∫–∞–∫ –ø–æ–¥–∞—Ä–æ—á–Ω—ã–π –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é">üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>' +
              '<button class="btn btn-success" style="min-width:110px;padding:8px 12px;font-size:13px;" onclick="markPaid(\'' + safeId + '\')">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ</button>' +
              '<button class="btn btn-cancel" style="min-width:110px;padding:8px 12px;font-size:13px;" onclick="cancelRequest(\'' + safeId + '\', this)">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>' +
            '</div>' +
          '</div>';
        }).join('');
      } catch (e) {
        if (section) section.classList.remove('has-items');
        list.innerHTML = '<div style="color:#e74c3c;padding:10px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + escapeHtml((e && e.message) || String(e)) + '</div>';
      }
    }

    // –û—Ç–º–µ–Ω–∞ –∑–∞—è–≤–∫–∏ –∏–∑ –∞–¥–º–∏–Ω–∫–∏
    async function cancelRequest(id, btn) {
      if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É ' + id.substring(0, 8) + '? –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç —Å—Ç–∞—Ç—É—Å ¬´–û—Ç–º–µ–Ω–µ–Ω–∞¬ª.')) return;
      if (btn) { btn.disabled = true; btn.textContent = '–û—Ç–º–µ–Ω–∞‚Ä¶'; }
      try {
        const result = await fetchJson(
          API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + '/cancel' + authQueryFromPath(),
          { method: 'POST', headers: authHeaders() }
        );
        if (result.json && result.json.success) {
          alert('‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞');
          await loadAdminData();
        } else {
          alert('–û—à–∏–±–∫–∞: ' + ((result.json && result.json.error) || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
          if (btn) { btn.disabled = false; btn.textContent = '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å'; }
        }
      } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + ((e && e.message) || String(e)));
        if (btn) { btn.disabled = false; btn.textContent = '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å'; }
      }
    }

    async function loadMonetizationData() {
      const pricingBody = document.getElementById('pricingTableBody');
      const promoBody = document.getElementById('promoTableBody');
      const paymentsBody = document.getElementById('paymentsTableBody');
      if (pricingBody) pricingBody.innerHTML = '<tr><td colspan="7" class="mono-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>';
      if (promoBody) promoBody.innerHTML = '<tr><td colspan="10" class="mono-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>';
      if (paymentsBody) paymentsBody.innerHTML = '<tr><td colspan="10" class="mono-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>';
      setMonoMsg('monetizationGlobalMsg', '–û–±–Ω–æ–≤–ª—è—é –¥–∞–Ω–Ω—ã–µ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏‚Ä¶', null);
      try {
        const [pricingResult, promoResult, paymentsResult] = await Promise.all([
          fetchJson(API_BASE + '/api/admin/pricing' + authQueryFromPath(), { headers: authHeaders() }),
          fetchJson(API_BASE + '/api/admin/promos' + authQueryFromPath(), { headers: authHeaders() }),
          fetchJson(API_BASE + '/api/admin/payments?limit=100' + authQuery(), { headers: authHeaders() }),
        ]);
        renderPricingRows((pricingResult.json && pricingResult.json.catalog) || []);
        renderPromoRows((promoResult.json && promoResult.json.data) || []);
        renderPaymentsRows((paymentsResult.json && paymentsResult.json.data) || []);
        setMonoMsg('monetizationGlobalMsg', '–î–∞–Ω–Ω—ã–µ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.', true);
      } catch (e) {
        setMonoMsg('monetizationGlobalMsg', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—é: ' + ((e && e.message) || String(e)), false);
      }
    }

    async function loadReferralData() {
      const body = document.getElementById('referralsTableBody');
      if (body) body.innerHTML = '<tr><td colspan="5" class="mono-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>';
      try {
        const result = await fetchJson(API_BASE + '/api/admin/referrals' + authQueryFromPath(), { headers: authHeaders() });
        const json = result.json;
        if (json && json.success) {
          const totalEl = document.getElementById('refTotalCount');
          const rewEl = document.getElementById('refRewardedCount');
          if (totalEl) totalEl.textContent = json.total || 0;
          if (rewEl) rewEl.textContent = json.rewarded || 0;
          renderReferralRows(json.rows || []);
          setMonoMsg('referralsMsg', '–î–∞–Ω–Ω—ã–µ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.', true);
        } else {
          setMonoMsg('referralsMsg', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤: ' + ((json && json.error) || 'unknown'), false);
        }
      } catch (e) {
        setMonoMsg('referralsMsg', '–û—à–∏–±–∫–∞: ' + ((e && e.message) || String(e)), false);
      }
    }

    function renderReferralRows(rows) {
      const body = document.getElementById('referralsTableBody');
      if (!body) return;
      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="5" class="mono-muted">–†–µ—Ñ–µ—Ä–∞–ª–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</td></tr>';
        return;
      }
      body.innerHTML = rows.map(function(r) {
        const dateCreated = r.created_at ? new Date(r.created_at).toLocaleString('ru-RU') : '‚Äî';
        const dateActivated = r.activated_at ? new Date(r.activated_at).toLocaleString('ru-RU') : '‚Äî';
        const rewardBadge = r.reward_granted
          ? '<span style="color:#22c55e;font-weight:600;">‚úì –í—ã–¥–∞–Ω–∞</span>'
          : '<span style="color:#f59e0b;">‚è≥ –ñ–¥—ë—Ç</span>';
        return '<tr>' +
          '<td><code>' + escapeHtml(String(r.referrer_id || '‚Äî')) + '</code></td>' +
          '<td><code>' + escapeHtml(String(r.referee_id || '‚Äî')) + '</code></td>' +
          '<td class="mono-muted">' + escapeHtml(dateCreated) + '</td>' +
          '<td class="mono-muted">' + escapeHtml(dateActivated) + '</td>' +
          '<td>' + rewardBadge + '</td>' +
          '</tr>';
      }).join('');
    }

    function renderPricingRows(rows) {
      const body = document.getElementById('pricingTableBody');
      if (!body) return;
      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="7" class="mono-muted">–¢–∞—Ä–∏—Ñ—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</td></tr>';
        return;
      }
      body.innerHTML = rows.map(function(item) {
        const sku = escapeHtml(item.sku || '');
        const limits = item.limits_json && typeof item.limits_json === 'object' ? JSON.stringify(item.limits_json) : (item.limits_json || '{}');
        return '<tr data-sku="' + sku + '">' +
          '<td><code>' + sku + '</code></td>' +
          '<td><input data-field="title" value="' + escapeAttr(item.title || '') + '"></td>' +
          '<td><input type="number" step="0.01" min="0" data-field="price" value="' + escapeAttr(item.price || 0) + '"></td>' +
          '<td><input data-field="currency" value="' + escapeAttr(item.currency || 'USDT') + '"></td>' +
          '<td style="text-align:center;"><input type="checkbox" data-field="active" ' + (item.active === false ? '' : 'checked') + '></td>' +
          '<td><input data-field="limits_json" value="' + escapeAttr(limits) + '"></td>' +
          '<td><button class="btn btn-primary" style="min-width:120px;padding:8px 12px;font-size:12px;" onclick="savePricingRow(\'' + escapeAttr(item.sku || '') + '\')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></td>' +
          '</tr>';
      }).join('');
    }

    function promoTypeLabel(type) {
      if (type === 'discount_percent') return '% —Å–∫–∏–¥–∫–∞';
      if (type === 'discount_amount') return '$ —Å–∫–∏–¥–∫–∞';
      if (type === 'free_generation') return 'üéÅ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ';
      return type || '‚Äî';
    }
    function renderPromoRows(rows) {
      const body = document.getElementById('promoTableBody');
      if (!body) return;
      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="9" class="mono-muted">–ü—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–µ—Ç. –°–æ–∑–¥–∞–π –ø–µ—Ä–≤—ã–π –≤—ã—à–µ ‚Üë</td></tr>';
        return;
      }
      body.innerHTML = rows.map(function(item) {
        const code = escapeHtml(item.code || '');
        const expiresLabel = item.expires_at ? new Date(item.expires_at).toLocaleString('ru-RU') : '‚àû';
        const usedOf = (item.used_count == null ? 0 : item.used_count) + ' / ' + (item.max_uses == null ? '‚àû' : item.max_uses);
        const valueLabel = item.type === 'free_generation' ? '‚Äî' : (item.value != null ? String(item.value) + (item.type === 'discount_percent' ? '%' : ' USDT') : '‚Äî');
        const activeLabel = item.active !== false
          ? '<span style="color:#22c55e;font-weight:600;">‚úì –î–∞</span>'
          : '<span style="color:#ef4444;">‚úó –ù–µ—Ç</span>';
        return '<tr data-code="' + code + '">' +
          '<td><code style="font-size:1rem;color:#d4af37;">' + code + '</code></td>' +
          '<td>' + escapeHtml(promoTypeLabel(item.type)) + '</td>' +
          '<td>' + escapeHtml(valueLabel) + '</td>' +
          '<td>' + escapeHtml(item.sku || '–≤—Å–µ') + '</td>' +
          '<td>' + escapeHtml(usedOf) + ' (–Ω–∞ 1 —é–∑–µ—Ä–∞: ' + (item.per_user_limit || 1) + ')</td>' +
          '<td>' + activeLabel + '</td>' +
          '<td class="mono-muted">' + escapeHtml(expiresLabel) + '</td>' +
          '<td style="font-weight:600;">' + escapeHtml(String(item.used_count == null ? 0 : item.used_count)) + '</td>' +
          '<td style="display:flex;gap:6px;flex-wrap:wrap;">' +
            '<button class="btn btn-primary" style="padding:6px 12px;font-size:12px;" onclick="togglePromoActive(\'' + escapeAttr(item.code || '') + '\',' + (item.active !== false) + ')">' +
              (item.active !== false ? '‚è∏ –î–µ–∞–∫—Ç.' : '‚ñ∂ –ê–∫—Ç–∏–≤.') +
            '</button>' +
            '<button class="btn" style="padding:6px 12px;font-size:12px;background:#ef4444;border-color:#ef4444;color:#fff;" onclick="deletePromo(\'' + escapeAttr(item.code || '') + '\')">üóë –£–¥–∞–ª–∏—Ç—å</button>' +
          '</td>' +
          '</tr>';
      }).join('');
    }

    function renderPaymentsRows(rows) {
      const body = document.getElementById('paymentsTableBody');
      if (!body) return;
      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="10" class="mono-muted">–û–ø–ª–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</td></tr>';
        return;
      }
      body.innerHTML = rows.map(function(item) {
        const created = item.created_at ? new Date(item.created_at).toLocaleString('ru-RU') : '‚Äî';
        const reqId = String(item.id || '');
        const orderId = String(item.payment_order_id || '');
        const txId = String(item.payment_tx_id || '');
        const amount = item.payment_amount != null ? (String(item.payment_amount) + ' ' + (item.payment_currency || 'USDT')) : '‚Äî';
        // –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã ‚Äî –ø–æ–Ω—è—Ç–Ω—ã–π –±–µ–π–¥–∂
        const methodBadge = paymentMethodBadge(item);
        // –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã ‚Äî –ø–æ–Ω—è—Ç–Ω—ã–π
        const ps = String(item.payment_status || '').toLowerCase();
        const statusColor = ['paid','gift_used','subscription_active'].includes(ps) ? '#22c55e' : (ps === 'requires_payment' ? '#f59e0b' : '#94a3b8');
        const statusHuman = ps === 'paid' ? '‚úì –û–ø–ª–∞—á–µ–Ω–æ' : ps === 'gift_used' ? 'üéÅ –ü–æ–¥–∞—Ä–æ–∫' : ps === 'subscription_active' ? 'üìã –ü–æ–¥–ø–∏—Å–∫–∞' : ps === 'requires_payment' ? '‚è≥ –û–∂–∏–¥–∞–µ—Ç' : escapeHtml(ps || '‚Äî');
        const promo = item.promo_code ? '<span style="color:#d4af37;font-weight:600;">' + escapeHtml(item.promo_code) + '</span>' + (item.promo_discount_amount ? ' <span style="color:#94a3b8;">(-' + escapeHtml(String(item.promo_discount_amount)) + ')</span>' : '') : '‚Äî';
        return '<tr>' +
          '<td style="font-size:11px;">' + escapeHtml(created) + '</td>' +
          '<td><code title="' + escapeAttr(reqId) + '">' + escapeHtml(reqId.slice(0, 8)) + '</code></td>' +
          '<td>' + escapeHtml(item.name || '‚Äî') + '</td>' +
          '<td>' + escapeHtml(item.mode || '‚Äî') + '</td>' +
          '<td>' + methodBadge + '</td>' +
          '<td style="color:' + statusColor + ';font-weight:600;font-size:12px;">' + statusHuman + '</td>' +
          '<td style="font-weight:600;">' + escapeHtml(amount) + '</td>' +
          '<td title="' + escapeAttr(orderId) + '" style="font-size:11px;">' + escapeHtml(orderId ? orderId.slice(0, 12) + '‚Ä¶' : '‚Äî') + '</td>' +
          '<td title="' + escapeAttr(txId) + '" style="font-size:11px;">' + escapeHtml(txId ? txId.slice(0, 12) + '‚Ä¶' : '‚Äî') + '</td>' +
          '<td>' + promo + '</td>' +
          '</tr>';
      }).join('');
    }

    async function savePricingRow(sku) {
      const row = Array.from(document.querySelectorAll('#pricingTableBody tr')).find(function(r) {
        return r.getAttribute('data-sku') === sku;
      });
      if (!row) return;
      const titleEl = row.querySelector('[data-field="title"]');
      const priceEl = row.querySelector('[data-field="price"]');
      const currencyEl = row.querySelector('[data-field="currency"]');
      const activeEl = row.querySelector('[data-field="active"]');
      const limitsEl = row.querySelector('[data-field="limits_json"]');
      let limitsJson = {};
      try {
        limitsJson = limitsEl && String(limitsEl.value || '').trim() ? JSON.parse(limitsEl.value) : {};
      } catch (_) {
        setMonoMsg('pricingMsg', '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –≤ limits_json –¥–ª—è SKU ' + sku, false);
        return;
      }
      const payload = {
        title: titleEl ? titleEl.value : sku,
        price: priceEl ? Number(priceEl.value || 0) : 0,
        currency: currencyEl ? String(currencyEl.value || 'USDT').toUpperCase() : 'USDT',
        active: !!(activeEl && activeEl.checked),
        limits_json: limitsJson,
      };
      setMonoMsg('pricingMsg', '–°–æ—Ö—Ä–∞–Ω—è—é —Ç–∞—Ä–∏—Ñ ' + sku + '‚Ä¶', null);
      try {
        const result = await fetchJson(API_BASE + '/api/admin/pricing/' + encodeURIComponent(sku) + authQueryFromPath(), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(payload),
        });
        if (result.json && result.json.success) {
          setMonoMsg('pricingMsg', '–¢–∞—Ä–∏—Ñ ' + sku + ' —Å–æ—Ö—Ä–∞–Ω—ë–Ω.', true);
          await loadMonetizationData();
        } else {
          setMonoMsg('pricingMsg', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞ ' + sku + ': ' + ((result.json && result.json.error) || 'unknown'), false);
        }
      } catch (e) {
        setMonoMsg('pricingMsg', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞ ' + sku + ': ' + ((e && e.message) || String(e)), false);
      }
    }

    async function savePromoRow(code) {
      const row = Array.from(document.querySelectorAll('#promoTableBody tr')).find(function(r) {
        return r.getAttribute('data-code') === code;
      });
      if (!row) return;
      const typeEl = row.querySelector('[data-field="type"]');
      const valueEl = row.querySelector('[data-field="value"]');
      const skuEl = row.querySelector('[data-field="sku"]');
      const maxUsesEl = row.querySelector('[data-field="max_uses"]');
      const perUserEl = row.querySelector('[data-field="per_user_limit"]');
      const activeEl = row.querySelector('[data-field="active"]');
      const payload = {
        type: typeEl ? typeEl.value : 'discount_percent',
        value: valueEl && String(valueEl.value).trim() ? Number(valueEl.value) : null,
        sku: skuEl && String(skuEl.value).trim() ? String(skuEl.value).trim() : null,
        max_uses: maxUsesEl && String(maxUsesEl.value).trim() ? Number(maxUsesEl.value) : null,
        per_user_limit: perUserEl && String(perUserEl.value).trim() ? Number(perUserEl.value) : 1,
        active: !!(activeEl && activeEl.checked),
      };
      setMonoMsg('promoMsg', '–°–æ—Ö—Ä–∞–Ω—è—é –ø—Ä–æ–º–æ–∫–æ–¥ ' + code + '‚Ä¶', null);
      try {
        const result = await fetchJson(API_BASE + '/api/admin/promos/' + encodeURIComponent(code) + authQueryFromPath(), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(payload),
        });
        if (result.json && result.json.success) {
          setMonoMsg('promoMsg', '–ü—Ä–æ–º–æ–∫–æ–¥ ' + code + ' —Å–æ—Ö—Ä–∞–Ω—ë–Ω.', true);
          await loadMonetizationData();
        } else {
          setMonoMsg('promoMsg', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ ' + code + ': ' + ((result.json && result.json.error) || 'unknown'), false);
        }
      } catch (e) {
        setMonoMsg('promoMsg', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ ' + code + ': ' + ((e && e.message) || String(e)), false);
      }
    }

    async function createPromoCode() {
      const code = (document.getElementById('newPromoCode').value || '').trim().toUpperCase();
      if (!code) { setMonoMsg('promoMsg', '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞', false); return; }
      const type = document.getElementById('newPromoType').value;
      const valueRaw = document.getElementById('newPromoValue').value.trim();
      const skuRaw = document.getElementById('newPromoSku').value.trim();
      const maxUsesRaw = document.getElementById('newPromoMaxUses').value.trim();
      const perUserRaw = document.getElementById('newPromoPerUser').value.trim();
      const startsAt = document.getElementById('newPromoStartsAt').value || null;
      const expiresAt = document.getElementById('newPromoExpiresAt').value || null;
      const active = document.getElementById('newPromoActive').checked;
      const payload = {
        type,
        value: valueRaw ? Number(valueRaw) : null,
        sku: skuRaw || null,
        max_uses: maxUsesRaw ? Number(maxUsesRaw) : null,
        per_user_limit: perUserRaw ? Number(perUserRaw) : 1,
        active,
        starts_at: startsAt ? new Date(startsAt).toISOString() : null,
        expires_at: expiresAt ? new Date(expiresAt).toISOString() : null,
      };
      setMonoMsg('promoMsg', '–°–æ–∑–¥–∞—é –ø—Ä–æ–º–æ–∫–æ–¥ ' + code + '‚Ä¶', null);
      try {
        const result = await fetchJson(API_BASE + '/api/admin/promos/' + encodeURIComponent(code) + authQueryFromPath(), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(payload),
        });
        if (result.json && result.json.success) {
          setMonoMsg('promoMsg', '‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ ' + code + ' —Å–æ–∑–¥–∞–Ω!', true);
          document.getElementById('newPromoCode').value = '';
          document.getElementById('newPromoValue').value = '';
          document.getElementById('newPromoSku').value = '';
          document.getElementById('newPromoMaxUses').value = '';
          document.getElementById('newPromoStartsAt').value = '';
          document.getElementById('newPromoExpiresAt').value = '';
          document.getElementById('newPromoDetails').removeAttribute('open');
          await loadMonetizationData();
        } else {
          setMonoMsg('promoMsg', '‚ùå –û—à–∏–±–∫–∞: ' + ((result.json && result.json.error) || 'unknown'), false);
        }
      } catch(e) {
        setMonoMsg('promoMsg', '‚ùå –û—à–∏–±–∫–∞: ' + (e && e.message || String(e)), false);
      }
    }

    async function togglePromoActive(code, currentlyActive) {
      setMonoMsg('promoMsg', (currentlyActive ? '–î–µ–∞–∫—Ç–∏–≤–∏—Ä—É—é' : '–ê–∫—Ç–∏–≤–∏—Ä—É—é') + ' –ø—Ä–æ–º–æ–∫–æ–¥ ' + code + '‚Ä¶', null);
      try {
        const result = await fetchJson(API_BASE + '/api/admin/promos/' + encodeURIComponent(code) + authQueryFromPath(), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({ active: !currentlyActive }),
        });
        if (result.json && result.json.success) {
          setMonoMsg('promoMsg', '‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ ' + code + (currentlyActive ? ' –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : ' –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'), true);
          await loadMonetizationData();
        } else {
          setMonoMsg('promoMsg', '‚ùå –û—à–∏–±–∫–∞: ' + ((result.json && result.json.error) || 'unknown'), false);
        }
      } catch(e) {
        setMonoMsg('promoMsg', '‚ùå –û—à–∏–±–∫–∞: ' + (e && e.message || String(e)), false);
      }
    }

    async function deletePromo(code) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ ' + code + '? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
      setMonoMsg('promoMsg', '–£–¥–∞–ª—è—é –ø—Ä–æ–º–æ–∫–æ–¥ ' + code + '‚Ä¶', null);
      try {
        const result = await fetchJson(API_BASE + '/api/admin/promos/' + encodeURIComponent(code) + authQueryFromPath(), {
          method: 'DELETE',
          headers: authHeaders(),
        });
        if (result.json && result.json.success) {
          setMonoMsg('promoMsg', '‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ ' + code + ' —É–¥–∞–ª—ë–Ω.', true);
          await loadMonetizationData();
        } else {
          setMonoMsg('promoMsg', '‚ùå –û—à–∏–±–∫–∞: ' + ((result.json && result.json.error) || 'unknown'), false);
        }
      } catch(e) {
        setMonoMsg('promoMsg', '‚ùå –û—à–∏–±–∫–∞: ' + (e && e.message || String(e)), false);
      }
    }

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞—Å—Ç—Ä—è–≤—à—É—é –∑–∞—è–≤–∫—É: –∑–∞—Å—á–∏—Ç–∞—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—É—é –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
    window.restoreRequest = async function restoreRequest(id, btn) {
      if (!confirm('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞—è–≤–∫—É ' + id.substring(0, 8) + '?\n\n–î–µ–π—Å—Ç–≤–∏–µ: –æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—É—é (–ø—Ä–æ–≤–∞–π–¥–µ—Ä: admin) –∏ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é.')) return;
      if (btn) { btn.disabled = true; btn.textContent = '‚è≥ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶'; }
      try {
        // 1. markPaid
        const paid = await fetchJson(API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + '/mark-paid' + authQueryFromPath(), {
          method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify({ provider: 'admin' })
        });
        if (!paid.json || !paid.json.success) {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –æ–ø–ª–∞—Ç—ã: ' + ((paid.json && paid.json.error) || 'unknown'));
          if (btn) { btn.disabled = false; btn.textContent = 'üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å'; }
          return;
        }
        // 2. restart
        const restarted = await fetchJson(API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + '/restart' + authQueryFromPath(), {
          method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() }
        });
        if (restarted.json && restarted.json.success) {
          alert('‚úÖ –ó–∞—è–≤–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞!');
          await loadAdminData();
        } else {
          alert('–û–ø–ª–∞—Ç–∞ –∑–∞—Å—á–∏—Ç–∞–Ω–∞, –Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –Ω–µ —É–¥–∞–ª—Å—è: ' + ((restarted.json && restarted.json.error) || 'unknown'));
          await loadAdminData();
        }
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ' + ((e && e.message) || String(e)));
        if (btn) { btn.disabled = false; btn.textContent = 'üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å'; }
      }
    };

    window.savePricingRow = savePricingRow;
    window.savePromoRow = savePromoRow;
    window.createPromoCode = createPromoCode;
    window.togglePromoActive = togglePromoActive;
    window.deletePromo = deletePromo;
    window.filterByCard = filterByCard;
    window.setSort = setSort;
    window.setPayFilter = setPayFilter;

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        currentFilter = this.getAttribute('data-filter') || 'all';
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∫–∞—Ä—Ç–æ—á–µ–∫
        document.querySelectorAll('.stat-card').forEach(c => {
          c.classList.toggle('active-filter', c.getAttribute('data-filter') === currentFilter);
        });
        loadAdminData();
      });
    });

    document.getElementById('settings-save-btn')?.addEventListener('click', async function() {
      const input = document.getElementById('settings-max-tokens');
      const modelEl = document.getElementById('settings-model');
      const tempEl = document.getElementById('settings-temperature');
      const statusEl = document.getElementById('settings-save-status');
      if (!input || !statusEl) return;
      const val = Math.min(65536, Math.max(4096, Number(input.value) || 8192));
      input.value = val;
      const modelVal = (modelEl && modelEl.value) ? modelEl.value.trim() : '';
      const tempVal = (tempEl && tempEl.value !== '') ? Math.max(0, Math.min(2, Number(tempEl.value))) : 1.5;
      if (tempEl) tempEl.value = tempVal;
      statusEl.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶';
      statusEl.style.color = '#94a3b8';
      try {
        const body = { deepseek_max_tokens: val, deepseek_temperature: tempVal };
        if (modelVal) body.deepseek_model = modelVal;
        const result = await fetchJson(API_BASE + '/api/admin/settings' + authQueryFromPath(), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(body)
        });
        const json = result.json;
        if (json.success) { statusEl.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'; statusEl.style.color = '#86efac'; setTimeout(() => { statusEl.textContent = ''; }, 3000); }
        else { statusEl.textContent = '‚ùå ' + (json.error || '–û—à–∏–±–∫–∞'); statusEl.style.color = '#e74c3c'; }
      } catch (e) {
        statusEl.textContent = '‚ùå ' + (e && e.message ? e.message : '–û—à–∏–±–∫–∞');
        statusEl.style.color = '#e74c3c';
      }
    });
    document.getElementById('monetization-refresh-btn')?.addEventListener('click', function() {
      loadMonetizationData();
    });

    window.showDetails = async function showDetails(id) {
      const url = API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + authQueryFromPath();
      let json, res;
      try {
        const result = await fetchJson(url, { headers: authHeaders() });
        res = result.res;
        json = result.json;
      } catch (e) {
        const msg = (e && e.message ? e.message : '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        const hint = msg === 'Failed to fetch'
          ? '–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª (—Å–µ—Ç—å –∏–ª–∏ —Ö–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç Render). –ü–æ–¥–æ–∂–¥–∏—Ç–µ 30 —Å–µ–∫ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥—Ä–æ–±–Ω–µ–µ¬ª —Å–Ω–æ–≤–∞.'
          : '–û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω–∫—É –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ –±–æ—Ç–∞ (/admin).';
        alert('‚ùå ' + msg + '\n\n' + hint);
        return;
      }
      if (!json.success || !json.data) {
        alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (json.error || res.status || 'Load error'));
        return;
      }
      const r = json.data;
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;overflow:auto;';
      const astroText = (r.astro_snapshot_text || '').trim();
      const astroJson = (r.astro_snapshot_json && typeof r.astro_snapshot_json === 'object') ? JSON.stringify(r.astro_snapshot_json, null, 2) : '';
      const astroBlock = astroText
        ? '<div class="details-section" style="margin-bottom:24px;"><div class="section-title" style="color:#67e8f9;">ü™ê –î–∞–Ω–Ω—ã–µ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞</div>' +
          '<div class="content-text" style="max-height:40vh;overflow-y:auto;white-space:pre-wrap;word-break:break-word;font-size:13px;line-height:1.5;background:#0f0f1b;padding:16px;border-radius:8px;border:1px solid #333;">' + escapeHtml(astroText) + '</div>' +
          (astroJson ? '<details style="margin-top:10px;"><summary style="cursor:pointer;color:#94a3b8;">–ü–æ–∫–∞–∑–∞—Ç—å JSON —Å–Ω–∞–ø—à–æ—Ç–∞</summary><div class="content-text" style="margin-top:8px;max-height:30vh;overflow-y:auto;white-space:pre-wrap;word-break:break-word;font-size:12px;line-height:1.4;background:#0f0f1b;padding:12px;border-radius:8px;border:1px solid #333;">' + escapeHtml(astroJson) + '</div></details>' : '') +
          '</div>'
        : '<div class="details-section"><div class="section-title" style="color:#67e8f9;">ü™ê –î–∞–Ω–Ω—ã–µ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞</div><div class="content-text" style="color:#94a3b8;">–°–Ω–∞–ø—à–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–æ–∑–º–æ–∂–Ω–æ, —Ä–∞—Å—á—ë—Ç –µ—â—ë –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω –∏–ª–∏ –≤ –ë–î –Ω–µ—Ç –∑–∞–ø–∏—Å–∏ –¥–ª—è —ç—Ç–æ–π –∑–∞—è–≤–∫–∏.</div></div>';
      const deepseekFull = (r.deepseek_response || '').trim();
      const genStatus = r.generation_status || r.status || 'pending';
      const genError = (r.error_message || '').trim();
      const dsReason = r.deepseek_missing_reason || '';
      const steps = normalizeSteps(r.generation_steps);
      const stepMap = [
        ['request_loaded', '–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞'],
        ['astro_start', '–°—Ç–∞—Ä—Ç –∞—Å—Ç—Ä–æ–±–ª–æ–∫–∞'],
        ['astro_snapshot_saved', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–Ω–∞–ø—à–æ—Ç–∞'],
        ['astro_extensions', 'D-–∫–∞—Ä—Ç—ã –∏ –î–∞—à–∏'],
        ['couple_second_snapshot', '–í—Ç–æ—Ä–æ–π —Å–Ω–∞–ø—à–æ—Ç (–ø–∞—Ä–∞)'],
        ['prompt_compiled', '–ü—Ä–æ–º—Ç —Å–æ–±—Ä–∞–Ω'],
        ['llm_request_start', '–ó–∞–ø—Ä–æ—Å –≤ DeepSeek'],
        ['llm_response_ready', '–û—Ç–≤–µ—Ç DeepSeek'],
        ['llm_response_saved', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ DeepSeek'],
        ['lyrics_ready', '–õ–∏—Ä–∏–∫–∞ –≥–æ—Ç–æ–≤–∞'],
        ['suno_start', '–°—Ç–∞—Ä—Ç Suno'],
        ['suno_task_created', 'Suno task'],
        ['audio_ready', '–ê—É–¥–∏–æ –≥–æ—Ç–æ–≤–æ'],
        ['cover_start', '–°—Ç–∞—Ä—Ç cover'],
        ['cover_ready', 'Cover —Å—Ç–∞—Ç—É—Å'],
        ['delivery_start', '–°—Ç–∞—Ä—Ç –¥–æ—Å—Ç–∞–≤–∫–∏'],
        ['delivery_done', '–î–æ—Å—Ç–∞–≤–∫–∞'],
        ['pipeline_done', '–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å'],
      ];
      const allStepsBlock = '<div class="details-section" style="margin-bottom:24px;"><div class="section-title" style="color:#fbbf24;">üß≠ –ö–æ–Ω—Ç—Ä–æ–ª—å –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ —Ä–∞—Å—á—ë—Ç–∞</div><div class="content-text" style="font-size:12px;line-height:1.7;">' +
        stepMap.map(function (pair) {
          var k = pair[0], label = pair[1];
          var v = steps[k];
          return '<b>' + escapeHtml(label) + '</b>: ' + (v ? escapeHtml(String(v)) : '<span style="color:#64748b;">‚Äî</span>');
        }).join('<br>') +
        (steps.error ? '<br><br><b style="color:#fca5a5;">–û—à–∏–±–∫–∞</b>: ' + escapeHtml(String(steps.error)) : '') +
        '</div></div>';
      const isTransitMode = r.mode === 'transit' || !!(r.transit_date || r.transit_location || r.transit_intent);
      const transitBlock = isTransitMode
        ? '<div class="details-section" style="margin-bottom:24px;"><div class="section-title" style="color:#f9a8d4;">üåô –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ —Ç—Ä–∞–Ω–∑–∏—Ç–æ–≤ (–≠–Ω–µ—Ä–≥–∏—è –¥–Ω—è)</div>' +
          '<div class="content-text" style="line-height:1.6;">' +
            '–†–µ–∂–∏–º: <b>transit / –≠–Ω–µ—Ä–≥–∏—è –¥–Ω—è</b><br>' +
            '–î–∞—Ç–∞ —Ç—Ä–∞–Ω–∑–∏—Ç–∞: ' + escapeHtml(r.transit_date || '‚Äî') + '<br>' +
            '–í—Ä–µ–º—è —Ç—Ä–∞–Ω–∑–∏—Ç–∞: ' + escapeHtml(r.transit_time || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ') + '<br>' +
            '–õ–æ–∫–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∏—Ç–∞: ' + escapeHtml(r.transit_location || '‚Äî') + '<br>' +
            '–ù–∞–º–µ—Ä–µ–Ω–∏–µ: ' + escapeHtml(r.transit_intent || '‚Äî') + '<br>' +
            '–°—Ç–∞—Ç—É—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + escapeHtml(genStatus || '‚Äî') + '<br>' +
            (steps && Object.keys(steps).length ? ('–õ–æ–≥–∏ —ç—Ç–∞–ø–æ–≤: ' + escapeHtml(JSON.stringify(steps))) : '–õ–æ–≥–∏ —ç—Ç–∞–ø–æ–≤: ‚Äî') +
          '</div></div>'
        : '';
      let deepseekBlock;
      if (deepseekFull) {
        deepseekBlock = '<div class="details-section" style="margin-bottom:24px;"><div class="section-title" style="color:#a78bfa;">ü§ñ –û—Ç–≤–µ—Ç DeepSeek</div>' +
          (r.llm_truncated ? '<div style="color:#f39c12;margin-bottom:8px;font-weight:bold">‚ö†Ô∏è –û—Ç–≤–µ—Ç –æ–±—Ä–µ–∑–∞–Ω –ø–æ –ª–∏–º–∏—Ç—É —Ç–æ–∫–µ–Ω–æ–≤</div>' : '') +
          '<div class="content-text" style="max-height:50vh;overflow-y:auto;white-space:pre-wrap;word-break:break-word;font-size:13px;line-height:1.5;background:#0f0f1b;padding:16px;border-radius:8px;border:1px solid #333;">' + escapeHtml(deepseekFull) + '</div></div>';
      } else if (genStatus === 'failed') {
        deepseekBlock = '<div class="details-section"><div class="section-title">ü§ñ –û—Ç–≤–µ—Ç DeepSeek</div><div class="content-text" style="color:#fca5a5;">–û—Ç–≤–µ—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω. –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + escapeHtml(genError || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div></div>';
      } else {
        const reasonHint = dsReason === 'column_missing_or_old_schema'
          ? '–ü—Ä–∏—á–∏–Ω–∞: –≤ –ë–î –Ω–µ—Ç –Ω—É–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ (–Ω—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è).'
          : (dsReason === 'generation_in_progress'
            ? '–ü—Ä–∏—á–∏–Ω–∞: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –µ—â—ë –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è.'
            : (dsReason === 'completed_without_deepseek_response'
              ? '–ü—Ä–∏—á–∏–Ω–∞: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –Ω–æ raw-–æ—Ç–≤–µ—Ç DeepSeek –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏.'
              : (dsReason === 'not_generated' ? '–ü—Ä–∏—á–∏–Ω–∞: —ç—Ç–∞–ø DeepSeek –µ—â—ë –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è.' : '')));
        deepseekBlock = '<div class="details-section"><div class="section-title">ü§ñ –û—Ç–≤–µ—Ç DeepSeek</div><div class="content-text" style="color:#94a3b8;">–û—Ç–≤–µ—Ç –µ—â—ë –Ω–µ –ø–æ–ª—É—á–µ–Ω. –°—Ç–∞—Ç—É—Å: ' + escapeHtml(genStatus) + '. ' + escapeHtml(reasonHint) + ' –ï—Å–ª–∏ –¥–æ–ª–≥–æ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è, –Ω–∞–∂–º–∏ ¬´–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é¬ª.</div></div>';
      }
      modal.innerHTML = `
        <div style="background:#1a1a2e;border-radius:15px;width:100%;max-width:900px;max-height:90vh;overflow-y:auto;padding:30px;position:relative;">
          <button onclick="this.closest('div').parentElement.remove()" style="position:absolute;top:15px;right:15px;background:#e74c3c;border:none;width:36px;height:36px;border-radius:50%;color:#fff;font-size:24px;cursor:pointer;line-height:1;">√ó</button>
          <h2 style="color:#fff;font-size:24px;margin-bottom:20px;">üìã –ó–∞—è–≤–∫–∞ #${(r.id || '').substring(0,8)}</h2>
          ${transitBlock}
          ${astroBlock}
          ${deepseekBlock}
          ${allStepsBlock}
          <div class="details-section">
            <div class="section-title">üë§ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>
            <div class="content-text">–ò–º—è: ${escapeHtml(r.name || '‚Äî')}<br>–ü–æ–ª: ${escapeHtml(r.gender || '‚Äî')}<br>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: ${escapeHtml(r.birthdate || '‚Äî')}<br>–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è: ${r.birthtime_unknown ? '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' : escapeHtml(r.birthtime || '‚Äî')}<br>–ú–µ—Å—Ç–æ: ${escapeHtml(r.birthplace || '‚Äî')}${r.person2_name ? ('<hr style="border:0;border-top:1px solid #334155;margin:10px 0;">–ü–∞—Ä—Ç–Ω—ë—Ä: ' + escapeHtml(r.person2_name) + '<br>–ü–æ–ª –ø–∞—Ä—Ç–Ω—ë—Ä–∞: ' + escapeHtml(r.person2_gender || '‚Äî') + '<br>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞: ' + escapeHtml(r.person2_birthdate || '‚Äî') + '<br>–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞: ' + (r.person2_birthtime_unknown ? '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' : escapeHtml(r.person2_birthtime || '‚Äî')) + '<br>–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞: ' + escapeHtml(r.person2_birthplace || '‚Äî')) : ''}</div>
          </div>
          ${r.lyrics ? '<div class="details-section"><div class="section-title">üéµ –¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏</div><div class="content-text" style="white-space:pre-wrap;">' + escapeHtml(r.lyrics) + '</div></div>' : ''}
          ${r.audio_url ? '<div class="details-section"><div class="section-title">üîä –ê—É–¥–∏–æ</div><audio class="audio-player" controls src="' + escapeHtml(r.audio_url) + '"></audio><br><a href="' + escapeHtml(r.audio_url) + '" download><button class="btn btn-success" style="width:auto;">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å</button></a></div>' : ''}
          <div class="actions" style="margin-top:30px;">
            <button class="btn btn-warning" onclick="restart(\'' + (r.id || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'") + '\'); this.closest(\'div\').parentElement.remove();">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é</button>
            ${r.audio_url ? '<button class="btn btn-success" onclick="deliver(\'' + (r.id || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'") + '\', this); this.closest(\'div\').parentElement.remove();">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</button>' : ''}
            <button class="btn btn-primary" onclick="this.closest('div').parentElement.remove()">‚úÖ –ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>`;
      document.body.appendChild(modal);
    }

    window.restart = async function restart(id) {
      if (!confirm('–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é? / Restart generation?')) return;
      try {
        const result = await fetchJson(API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + '/restart' + authQueryFromPath(), { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() } });
        const json = result.json;
        const res = result.res;
        if (json.success) { alert('‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞'); loadAdminData(); }
        else alert('–û—à–∏–±–∫–∞: ' + (json.error || res.status));
      } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + (e && e.message ? e.message : e));
      }
    }

    window.markPaid = async function markPaid(id) {
      if (!confirm('–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞—è–≤–∫—É –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—É—é? –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å ¬´–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å¬ª.')) return;
      try {
        const result = await fetchJson(API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + '/mark-paid' + authQueryFromPath(), { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify({ provider: 'admin' }) });
        const json = result.json;
        if (result.res && result.res.ok && json.success) { alert('‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω–∞—è'); loadAdminData(); }
        else alert('–û—à–∏–±–∫–∞: ' + (json.error || result.res?.status || 'unknown'));
      } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + (e && e.message ? e.message : e));
      }
    }

    window.deliver = async function deliver(id, btnEl) {
      if (!btnEl) btnEl = document.activeElement;
      const origText = btnEl ? btnEl.textContent : '';
      if (btnEl) { btnEl.disabled = true; btnEl.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶'; }
      try {
        const result = await fetchJson(API_BASE + '/api/admin/requests/' + encodeURIComponent(id) + '/deliver' + authQueryFromPath(), { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() } });
        const json = result.json;
        if (json.success) { alert('‚úÖ –ü–µ—Å–Ω—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é'); }
        else alert('–û—à–∏–±–∫–∞: ' + (json.error || 'unknown'));
      } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + (e && e.message ? e.message : e));
      } finally {
        if (btnEl) { btnEl.disabled = false; btnEl.textContent = origText; }
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      checkApiStatus().then(function(ok) {
        if (ok !== false) {
          loadAdminData().catch(function(e) {
            const el = document.getElementById('requests');
            if (el) el.innerHTML = '<div style="text-align:center;padding:40px;color:#e74c3c">‚ùå ' + escapeHtml((e && e.message) ? e.message : String(e)) + '<br><br><button onclick="window.location.reload()" style="margin-top:12px;padding:10px 24px;background:#667eea;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:15px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button></div>';
          });
        }
      });
    });
  </script>
</body>
</html>
