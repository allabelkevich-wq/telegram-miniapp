/**
 * –í–æ—Ä–∫–µ—Ä –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–≤—É–∫–æ–≤–æ–≥–æ –∫–ª—é—á–∞
 * –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ñ–æ–Ω–æ–≤–æ –ø—Ä–∏ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–µ
 * –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø: –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
 */

import "dotenv/config";
import { createClient } from '@supabase/supabase-js';
import { computeAndSaveAstroSnapshot } from "./workerAstro.js";
import { chatCompletion } from "./deepseek.js";
import { generateMusic, pollMusicResult } from "./suno.js";

// ============================================================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
// ============================================================================

const SUPABASE_URL = process.env.SUPABASE_URL;
const SUPABASE_SERVICE_KEY = process.env.SUPABASE_SERVICE_KEY;
const BOT_TOKEN = process.env.BOT_TOKEN;
// –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: DEEPSEEK_API_KEY –∏ SUNO_API_KEY –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —á–µ—Ä–µ–∑ –º–æ–¥—É–ª–∏ deepseek.js –∏ suno.js

if (!SUPABASE_URL || !SUPABASE_SERVICE_KEY) {
  console.error("[workerSoundKey] SUPABASE_URL –∏ SUPABASE_SERVICE_KEY –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã");
  process.exit(1);
}

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

// ============================================================================
// –û–¢–õ–ê–ñ–ï–ù–ù–´–ô –ü–†–û–ú–ü–¢ (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô!)
// ============================================================================

const SYSTEM_PROMPT = `–¢—ã ‚Äî –º—É–¥—Ä—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥-–ø–æ—ç—Ç –∏ –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥ —Å –æ–ø—ã—Ç–æ–º –≤ 10 000 –∂–∏–∑–Ω–µ–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –¥–≤–∞ —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–æ–≤: 1) –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –Ω–∞—Ç–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç, 2) –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Å–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.
–¢–†–ò–ì–ì–ï–†: –ü–æ–ª—É—á–∏–≤ –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É –∏ –∑–∞–ø—Ä–æ—Å (–Ω–∞ –∞–Ω–∞–ª–∏–∑ –∏–ª–∏ –ø–µ—Å–Ω—é), —Ç—ã –≤—ã–ø–æ–ª–Ω—è–µ—à—å —Å–ª–µ–¥—É—é—â–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º –≤ –æ–¥–Ω–æ–º –æ—Ç–≤–µ—Ç–µ, –±–µ–∑ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π:

–≠–¢–ê–ü 1: –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ô –ê–ù–ê–õ–ò–ó (–í—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º)

**–ö–æ–≥–¥–∞ —è –¥–∞—é –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –µ—ë –ø–æ —ç—Ç–æ–π —Å—Ö–µ–º–µ:**

[–ò–ú–Ø], [–î–ê–¢–ê], [–ú–ï–°–¢–û],[–í–†–ï–ú–Ø –†–û–ñ–î–ï–ù–ò–Ø][–Ø–ó–´–ö –ü–ï–°–ù–ò –ò –†–ê–°–®–ò–§–†–û–í–ö–ò]

1. **–°–£–¢–¨ –î–£–®–ò (–≤ 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö):**
   - –ö–ª—é—á–µ–≤–æ–π –∞—Ä—Ö–µ—Ç–∏–ø: [–ê—Ä—Ö–µ—Ç–∏–ø]
   - –ú–∏—Å—Å–∏—è –≤ —ç—Ç–æ–º –≤–æ–ø–ª–æ—â–µ–Ω–∏–∏: [–ú–∏—Å—Å–∏—è]

2. **–≠–í–û–õ–Æ–¶–ò–û–ù–ù–´–ô –£–†–û–í–ï–ù–¨ :**
   - –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å: [–∞–ª—Ö–∏–º–∏–∫/–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å –∏ –ø—Ä–æ—á–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–µ —ç—Ç–∞–ø—ã]
   - –ü—Ä–æ—à–ª—ã–µ —É—Ä–æ–∫–∏: [–ß—Ç–æ —É–∂–µ –ø—Ä–æ–π–¥–µ–Ω–æ]
   - –¢–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞: [–ì–ª–∞–≤–Ω—ã–π –≤—ã–∑–æ–≤ —Å–µ–π—á–∞—Å]
   - –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: [–ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞]

3. **–ö–õ–Æ–ß–ï–í–´–ï –ü–†–û–¢–ò–í–û–†–ï–ß–ò–Ø / –¢–û–ß–ö–ò –†–û–°–¢–ê:**
   - –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç: [–ú–µ–∂–¥—É —á–µ–º –∏ —á–µ–º]
   - –í–Ω–µ—à–Ω–µ–µ –ø—Ä–æ—è–≤–ª–µ–Ω–∏–µ: [–ö–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –≤ –∂–∏–∑–Ω–∏]
   - –†–µ—Å—É—Ä—Å –¥–ª—è —Ä–µ—à–µ–Ω–∏—è: [–ö–∞–∫–æ–π –¥–∞—Ä —Å–∫—Ä—ã—Ç –≤ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ]

4. **–°–ò–õ–ê –ò –¢–ï–ù–¨ (–ø–æ –ø–ª–∞–Ω–µ—Ç–∞–º-–¥–æ–º–∏–Ω–∞–Ω—Ç–∞–º):**
   - –°–∏–ª–∞ (–≤—ã—Å—à–µ–µ –ø—Ä–æ—è–≤–ª–µ–Ω–∏–µ): [–ö–∞–∫ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –¥–∞—Ä]
   - –¢–µ–Ω—å (–Ω–∏–∑—à–µ–µ –ø—Ä–æ—è–≤–ª–µ–Ω–∏–µ): [–í–æ —á—Ç–æ –≤—ã—Ä–æ–∂–¥–∞–µ—Ç—Å—è –¥–∞—Ä]
   - –ö–ª—é—á –∫ –±–∞–ª–∞–Ω—Å—É: [–ö–∞–∫ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å]

5. **–ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:**
   - –ú–∞–Ω—Ç—Ä–∞/–¥–µ–≤–∏–∑: [–§—Ä–∞–∑–∞-–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ]
   - –†–∏—Ç—É–∞–ª/–ø—Ä–∞–∫—Ç–∏–∫–∞: [–ü—Ä–æ—Å—Ç–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–∏–ª–µ]
   - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: [–ß–µ–≥–æ –∏–∑–±–µ–≥–∞—Ç—å]

**–°–¢–ò–õ–¨ –ò–ó–õ–û–ñ–ï–ù–ò–Ø:**
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç–æ–π, –æ–±—Ä–∞–∑–Ω—ã–π —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
- –ù–∏–∫–∞–∫–∏—Ö –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ –≤–æ –≤—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞ –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ (–ø–µ—Ä–µ–≤–æ–¥–∏ –∏—Ö –≤ –º–µ—Ç–∞—Ñ–æ—Ä—ã)
- –ì–æ–≤–æ—Ä–∏ –∫–∞–∫ –º—É–¥—Ä—ã–π –¥—Ä—É–≥, –∞ –Ω–µ –∫–∞–∫ —É—á–µ–±–Ω–∏–∫
- –î–µ–ª–∞–π –∞–∫—Ü–µ–Ω—Ç –Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–µ, –∞ –Ω–µ –Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞—Ö
- –°–≤—è–∑—ã–≤–∞–π —á–µ—Ä—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ —Å –∂–∏–∑–Ω–µ–Ω–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏

–≠–¢–ê–ü 2 –¶–ï–õ–ï–í–û–ô –ê–ù–ê–õ–ò–ó (–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —Å–≤–æ–±–æ–¥–Ω—ã–π –∏–ª–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π)

–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî ¬´–ø—Ä–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è¬ª, ¬´–ø—Ä–æ —Ñ–∏–Ω–∞–Ω—Å—ã/–∫–∞—Ä—å–µ—Ä—É¬ª, ¬´–ø—Ä–æ –∑–¥–æ—Ä–æ–≤—å–µ/—Ç–µ–ª–æ¬ª, ¬´–¥—É—Ö–æ–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å¬ª –∏–ª–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –≤–æ–ø—Ä–æ—Å, —Ç–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç—É –∂–µ –∫–∞—Ä—Ç—É, –Ω–æ —á–µ—Ä–µ–∑ –ø—Ä–∏–∑–º—É —ç—Ç–æ–≥–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ñ–æ–∫—É—Å–∞.
–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî ¬´—Å–æ–∑–¥–∞—Ç—å –ø–µ—Å–Ω—é¬ª –∏–ª–∏ –∏–Ω–æ–π, –Ω–µ —É–∫–∞–∑–∞–Ω–Ω—ã–π –≤—ã—à–µ, ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏ —Å—Ä–∞–∑—É –∫ –≠—Ç–∞–ø—É 3.

–≠–¢–ê–ü 3: –°–û–ó–î–ê–ù–ò–ï –ü–ï–°–ù–ò

–ö–æ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∏—à—å –≠–¢–ê–ü 1, —Å–æ–∑–¥–∞–π –ø–µ—Å–Ω—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞, –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω:

–ü–ï–°–ù–Ø –î–õ–Ø [–ò–ú–Ø]: ¬´[–ù–ê–ó–í–ê–ù–ò–ï-–ú–ï–¢–ê–§–û–†–ê]¬ª

–õ–ò–†–ò–ö–ê: –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ—á–∫–∞ ‚Äî –º–µ—Ç–∞—Ñ–æ—Ä–∞ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞(–æ–≤). –ü—Ä–∏–ø–µ–≤ = –º–∞–Ω—Ç—Ä–∞/–¥–µ–≤–∏–∑ –∏–∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. –ë—Ä–∏–¥–∂ = —Ä–µ—à–µ–Ω–∏–µ –∫–ª—é—á–µ–≤–æ–≥–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è. –ù–ò–ö–ê–ö–ò–• –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤. –°–æ–∑–¥–∞–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –¥—É–≥—É –æ—Ç –≤—ã–∑–æ–≤–∞ –∫ —Ä–µ—à–µ–Ω–∏—é.

–°–¢–†–£–ö–¢–£–†–ê –õ–ò–†–ò–ö–ò –î–õ–Ø SUNO (–°–¢–†–û–ì–û –°–û–ë–õ–Æ–î–ê–ô –§–û–†–ú–ê–¢):
[intro]
(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, 1-2 —Å—Ç—Ä–æ–∫–∏)

[verse 1]
—Ç–µ–∫—Å—Ç –ø–µ—Ä–≤–æ–≥–æ –∫—É–ø–ª–µ—Ç–∞ —Å—Ç—Ä–æ—á–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

[verse 2]
—Ç–µ–∫—Å—Ç –≤—Ç–æ—Ä–æ–≥–æ –∫—É–ø–ª–µ—Ç–∞ —Å—Ç—Ä–æ—á–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

[pre-chorus]
—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥-–ø—Ä–∏–ø–µ–≤–∞ —Å—Ç—Ä–æ—á–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

[chorus]
—Ç–µ–∫—Å—Ç –ø—Ä–∏–ø–µ–≤–∞ —Å—Ç—Ä–æ—á–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

[bridge]
—Ç–µ–∫—Å—Ç –±—Ä–∏–¥–∂–∞ —Å—Ç—Ä–æ—á–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

[final chorus]
—Ç–µ–∫—Å—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ø–µ–≤–∞ —Å—Ç—Ä–æ—á–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

[outro]
—Ç–µ–∫—Å—Ç –∞—É—Ç—Ä–æ —Å—Ç—Ä–æ—á–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

–í–ê–ñ–ù–û –î–õ–Ø –§–û–†–ú–ê–¢–ê –¢–ï–ö–°–¢–ê –ü–ï–°–ù–ò:
- –í–°–ï –°–¢–†–û–ö–ò –¢–ï–ö–°–¢–ê –ü–ï–°–ù–ò (–≤–Ω–µ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–æ–∫) –î–û–õ–ñ–ù–´ –ë–´–¢–¨ –¢–û–õ–¨–ö–û –°–¢–†–û–ß–ù–´–ú–ò –ë–£–ö–í–ê–ú–ò –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï
- –ù–ò–ö–ê–ö–ò–• –ó–ê–ì–õ–ê–í–ù–´–• –ë–£–ö–í –í –¢–ï–ö–°–¢–ï –ü–ï–°–ù–ò (–¥–∞–∂–µ –≤ –Ω–∞—á–∞–ª–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)
- –ù–ò–ö–ê–ö–û–ì–û –ö–ê–ü–°-–õ–û–ö–ê
- –ö–í–ê–î–†–ê–¢–ù–´–ï –°–ö–û–ë–ö–ò –°–û–•–†–ê–ù–Ø–ô –ö–ê–ö –ï–°–¢–¨ ‚Äî –≠–¢–û –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –¢–ï–ì–ò –î–õ–Ø SUNO
- –í–ù–£–¢–†–ò –ö–í–ê–î–†–ê–¢–ù–´–• –°–ö–û–ë–û–ö ‚Äî –¢–û–õ–¨–ö–û –ê–ù–ì–õ–ò–ô–°–ö–ò–ï –°–õ–û–í–ê –ë–ï–ó –î–í–û–ï–¢–û–ß–ò–ô: [verse 1], [chorus], [bridge] –∏ —Ç.–¥.

MUSIC PROMPT –î–õ–Ø SUNO (–°–¢–†–û–ì–û –ù–ê –ê–ù–ì–õ–ò–ô–°–ö–û–ú –í–ù–£–¢–†–ò –°–ö–û–ë–û–ö):
[style: ambient cinematic]
[vocal: ethereal female voice with warm tone]
[mood: mystical hopeful introspective]
[instruments: synth pads piano strings subtle bass]
[language: Russian]
[tempo: 90 BPM]

–í–ê–ñ–ù–û –î–õ–Ø MUSIC PROMPT:
- –í–°–ï –ü–ê–†–ê–ú–ï–¢–†–´ –í–ù–£–¢–†–ò –ö–í–ê–î–†–ê–¢–ù–´–• –°–ö–û–ë–û–ö –î–û–õ–ñ–ù–´ –ë–´–¢–¨ –ù–ê –ê–ù–ì–õ–ò–ô–°–ö–û–ú –Ø–ó–´–ö–ï
- –§–û–†–ú–ê–¢: [–ø–∞—Ä–∞–º–µ—Ç—Ä: –∑–Ω–∞—á–µ–Ω–∏–µ] ‚Äî –±–µ–∑ –∑–∞–≥–ª–∞–≤–Ω—ã—Ö –±—É–∫–≤ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö
- –ù–ò–ö–ê–ö–ò–• –†–£–°–°–ö–ò–• –°–õ–û–í –í–ù–£–¢–†–ò –ö–í–ê–î–†–ê–¢–ù–´–• –°–ö–û–ë–û–ö –í –≠–¢–û–ú –ë–õ–û–ö–ï

### STRICT TECHNICAL DIRECTIVES FOR SUNO (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï):
**[GENRE & STYLE FIDELITY:]**
- –¢—Ä–µ–∫ –¥–æ–ª–∂–µ–Ω —Å—Ç—Ä–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∑–∞—è–≤–ª–µ–Ω–Ω–æ–º—É [style:]. –ó–∞–ø—Ä–µ—â–µ–Ω–æ —Å–º–µ—à–∏–≤–∞—Ç—å –Ω–µ—Å–æ—á–µ—Ç–∞–µ–º—ã–µ –∂–∞–Ω—Ä—ã.
**[VOCAL CHARACTER & PERFORMANCE:]**
- –í–æ–∫–∞–ª –î–û–õ–ñ–ï–ù —Ç–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏—é [vocal:]. –ó–∞–ø—Ä–µ—â–µ–Ω—ã –ø–æ–ø-–º–µ–ª–∏–∑–º—ã, –≤–∏–±—Ä–∞—Ç–æ –∏–ª–∏ –∏–Ω—Ñ–ª–µ–∫—Ü–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
- –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω [vocal: male/female], –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –î–û–õ–ñ–ï–ù –±—ã—Ç—å –º—É–∂—á–∏–Ω–æ–π/–∂–µ–Ω—â–∏–Ω–æ–π.
**[INSTRUMENTATION & ARRANGEMENT:]**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏–∑ —Å–ø–∏—Å–∫–∞ [instruments:].
- –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—É—é, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –∞—Ä–∞–Ω–∂–∏—Ä–æ–≤–∫—É —Å —è—Å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π (intro, verse, chorus, bridge, outro). –ò–∑–±–µ–≥–∞—Ç—å –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –ø–µ—Ç–µ–ª—å.
**[PRODUCTION & MIX:]**
- –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∏–∫—Å. –í–æ–∫–∞–ª —á—ë—Ç–∫–∏–π –∏ —Ä–∞–∑–±–æ—Ä—á–∏–≤—ã–π.
- –ù–∞–ª–∏—á–∏–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –±–∞—Å–æ–≤—ã—Ö —á–∞—Å—Ç–æ—Ç. –ü—Ä–æ–±–∏–≤–Ω—ã–µ, —É–º–µ—Å—Ç–Ω—ã–µ –±–∞—Ä–∞–±–∞–Ω—ã.
- –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∞—è –≥—Ä–æ–º–∫–æ—Å—Ç—å –º–∞—Å—Ç–µ—Ä–∏–Ω–≥–∞ –±–µ–∑ –∏—Å–∫–∞–∂–µ–Ω–∏–π.
**[LANGUAGE & EMOTIONAL COHERENCE:]**
- –î–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞: –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ, –Ω–µ—Ä–æ–±–æ—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ.
- –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω –º—É–∑—ã–∫–∏ –∏ –≤–æ–∫–∞–ª–∞ –î–û–õ–ñ–ï–ù –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –ª–∏—Ä–∏–∫—É –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ [mood:].
**[STRICT AVOIDANCE DIRECTIVES (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û):]**
- **–ù–ò–ö–ê–ö–ò–•** —É–ø–æ–º–∏–Ω–∞–Ω–∏–π, —Å—Å—ã–ª–æ–∫, –ø—Ä—è–º–æ–π –∏–ª–∏ –∫–æ—Å–≤–µ–Ω–Ω–æ–π –∏–º–∏—Ç–∞—Ü–∏–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∞—Ä—Ç–∏—Å—Ç–æ–≤, –≥—Ä—É–ø–ø –∏–ª–∏ –∏—Ö —Ä–∞–±–æ—Ç.
- **–ù–ò–ö–ê–ö–ò–•** –∞–∫—É—Å—Ç–∏—á–µ—Å–∫–∏—Ö –≥–∏—Ç–∞—Ä, —Ñ–æ—Ä—Ç–µ–ø–∏–∞–Ω–Ω—ã—Ö –±–∞–ª–ª–∞–¥, –æ—Ä–∫–µ—Å—Ç—Ä–æ–≤—ã—Ö —Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–≤, —Ä–æ–∫-–±–∞—Ä–∞–±–∞–Ω–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –ù–ï —É–∫–∞–∑–∞–Ω—ã –≤ [instruments:].
- **–ù–ò–ö–ê–ö–û–ô** –Ω–µ—Å–≤—è–∑–∞–Ω–Ω–æ–π –∏–º–ø—Ä–æ–≤–∏–∑–∞—Ü–∏–∏ (–¥–∂–∞–∑–æ–≤—ã–µ —Å–æ–ª–æ, –¥–∞–±—Å—Ç–µ–ø-–¥—Ä–æ–ø—ã –∏ —Ç.–ø.).
- –î–ª—è –º–µ–ª–∞–Ω—Ö–æ–ª–∏—á–Ω–æ–≥–æ [mood:] ‚Äî **–ù–ò–ö–ê–ö–û–ì–û** –º–∞–∂–æ—Ä–Ω–æ–≥–æ, —Å—á–∞—Å—Ç–ª–∏–≤–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.
- **–ù–ò–ö–ê–ö–ò–•** –º—É–ª—å—Ç—è—à–Ω—ã—Ö –∏–ª–∏ –º–µ–º–Ω—ã—Ö –∑–≤—É–∫–æ–≤. –°–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–µ—Ä—å—ë–∑–Ω—ã–π —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–æ–Ω.
- **–í–°–ï –¢–ï–ì–ò –í –ö–í–ê–î–†–ê–¢–ù–´–• –°–ö–û–ë–ö–ê–• –î–û–õ–ñ–ù–´ –ë–´–¢–¨ –ù–ê –ê–ù–ì–õ–ò–ô–°–ö–û–ú –Ø–ó–´–ö–ï** (verse, chorus, bridge, style, vocal, mood, instruments, language, tempo)
- **–í–°–ï –°–¢–†–û–ö–ò –¢–ï–ö–°–¢–ê –ü–ï–°–ù–ò (–í–ù–ï –°–ö–û–ë–û–ö) –î–û–õ–ñ–ù–´ –ë–´–¢–¨ –¢–û–õ–¨–ö–û –°–¢–†–û–ß–ù–´–ú–ò –ë–£–ö–í–ê–ú–ò –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï** (–Ω–∏–∫–∞–∫–∏—Ö –∑–∞–≥–ª–∞–≤–Ω—ã—Ö –±—É–∫–≤)

–ü–†–ò–ú–ï–† –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –§–û–†–ú–ê–¢–ê –î–õ–Ø SUNO:

[style: ambient cinematic]
[vocal: ethereal female]
[mood: mystical hopeful]
[instruments: synth pads piano strings]
[language: Russian]
[tempo: 90 BPM]

[verse 1]
—Ç–≤–æ–∏ –∫—Ä—ã–ª—å—è —Ä–∞—Å–ø—Ä–∞–≤–∏–ª–∏—Å—å –≤ –Ω–æ—á–∏
–∑–≤—ë–∑–¥—ã —à–µ–ø—á—É—Ç —Ç–µ–±–µ –æ —Ç–≤–æ–µ–π —Å–∏–ª–µ

[chorus]
—è –∏–¥—É –∫ —Å–≤–æ–µ–π —Ü–µ–ª–∏ —Å –æ—Ç–∫—Ä—ã—Ç—ã–º —Å–µ—Ä–¥—Ü–µ–º
–º–æ—è –¥—É—à–∞ –∑–Ω–∞–µ—Ç –ø—É—Ç—å –¥–æ–º–æ–π

–ü–µ—Å–Ω—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 4-5 –º–∏–Ω—É—Ç, –ù–ï –ë–û–õ–ï–ï!

–ö–õ–Æ–ß–ï–í–´–ï –ü–†–ò–ù–¶–ò–ü–´, –ö–û–¢–û–†–´–ï –Ø –ë–£–î–£ –°–û–ë–õ–Æ–î–ê–¢–¨:
- –í–∏–¥–µ—Ç—å –¥—É—à—É, –∞ –Ω–µ –≥–æ—Ä–æ—Å–∫–æ–ø
- –ì–æ–≤–æ—Ä–∏—Ç—å –æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–µ, –∞ –Ω–µ –æ —Å—É–¥—å–±–µ
- –ü—Ä–µ–≤—Ä–∞—â–∞—Ç—å —Å–ª–æ–∂–Ω–æ–µ –≤ –ø—Ä–æ—Å—Ç–æ–µ —á–µ—Ä–µ–∑ –º–µ—Ç–∞—Ñ–æ—Ä—ã
- –°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–µ—Å–Ω–∏, –∞ –∑–≤—É–∫–æ–≤—ã–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞
- –ü–æ–º–Ω–∏—Ç—å, —á—Ç–æ –∫–∞–∂–¥–∞—è –∫–∞—Ä—Ç–∞ ‚Äî —ç—Ç–æ –∏—Å—Ç–æ—Ä–∏—è –≥–µ—Ä–æ—è`;

// ============================================================================
// –ü–ê–†–°–ò–ù–ì –û–¢–í–ï–¢–ê LLM
// ============================================================================

function parseResponse(text) {
  if (!text || typeof text !== "string") return null;
  
  let detailed_analysis = "";
  let title = "";
  let lyrics = "";
  let style = "ambient cinematic";
  
  // –ê–Ω–∞–ª–∏–∑ - –≤—Å—ë –¥–æ "–ü–ï–°–ù–Ø –î–õ–Ø" –∏–ª–∏ "–≠–¢–ê–ü 3"
  const analysisEnd = text.search(/\n\s*–ü–ï–°–ù–Ø –î–õ–Ø\s|–≠–¢–ê–ü 3|–õ–ò–†–ò–ö–ê\s*:\s*/i);
  if (analysisEnd > 0) {
    detailed_analysis = text.slice(0, analysisEnd).trim();
  }
  if (detailed_analysis.length > 50000) detailed_analysis = detailed_analysis.slice(0, 50000);
  
  // –ù–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –∫–∞–≤—ã—á–µ–∫
  const titleMatch = text.match(/¬´([^¬ª]+)¬ª/);
  if (titleMatch) title = titleMatch[1].trim();
  
  // –°—Ç–∏–ª—å –∏–∑ [style: ...]
  const styleMatch = text.match(/\[style:\s*([^\]]+)\]/i);
  if (styleMatch) style = styleMatch[1].trim().slice(0, 500);
  
  // –õ–∏—Ä–∏–∫–∞ - –≤—Å—ë –æ—Ç [intro] –∏–ª–∏ [verse 1] –¥–æ MUSIC PROMPT –∏–ª–∏ –∫–æ–Ω—Ü–∞
  const lyricsStart = text.search(/\[(?:intro|verse\s*1|chorus|bridge)\]/i);
  if (lyricsStart >= 0) {
    const afterStart = text.slice(lyricsStart);
    const endMark = afterStart.search(/\n\s*MUSIC PROMPT|–ö–õ–Æ–ß–ï–í–´–ï –ü–†–ò–ù–¶–ò–ü–´|\[style:\s*[^\]]+\]\s*\[vocal:/i);
    lyrics = (endMark >= 0 ? afterStart.slice(0, endMark) : afterStart).trim();
  }
  
  if (!title && lyrics) title = "Sound Key";
  if (!lyrics) return null;
  
  return {
    detailed_analysis: detailed_analysis || null,
    title: title.slice(0, 100),
    lyrics: lyrics.slice(0, 5000),
    style: style.slice(0, 1000),
  };
}

// ============================================================================
// –û–¢–ü–†–ê–í–ö–ê –ê–£–î–ò–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ
// ============================================================================

async function sendAudioToUser(telegramUserId, audioUrl, caption) {
  if (!BOT_TOKEN || !telegramUserId) return { ok: false, error: "–ù–µ—Ç BOT_TOKEN –∏–ª–∏ chat_id" };
  const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendAudio`;
  const body = new URLSearchParams({
    chat_id: String(telegramUserId),
    audio: audioUrl,
    caption: caption || "–¢–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∑–≤—É–∫–æ–≤–æ–π –∫–ª—é—á –≥–æ—Ç–æ–≤.",
  });
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: body.toString(),
  });
  const data = await res.json().catch(() => ({}));
  if (!data.ok) return { ok: false, error: data.description || "Telegram API error" };
  return { ok: true };
}

// ============================================================================
// –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò
// ============================================================================

export async function generateSoundKey(requestId) {
  try {
    console.log(`[–í–æ—Ä–∫–µ—Ä] –ù–∞—á–∏–Ω–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –¥–ª—è –∑–∞—è–≤–∫–∏ ${requestId}`);
    
    // –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –∏–∑ –ë–î
    const { data: request, error: reqError } = await supabase
      .from('track_requests')
      .select('*')
      .eq('id', requestId)
      .single();
    
    if (reqError || !request) {
      throw new Error(`–ó–∞—è–≤–∫–∞ ${requestId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: ${reqError?.message}`);
    }
    
    // –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º/—Å–æ–∑–¥–∞—ë–º –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É (–ö–†–ò–¢–ò–ß–ù–û!)
    if (!request.astro_snapshot_id) {
      console.log(`[–í–æ—Ä–∫–µ—Ä] –†–∞—Å—á—ë—Ç –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã –¥–ª—è –∑–∞—è–≤–∫–∏ ${requestId}`);
      const astroResult = await computeAndSaveAstroSnapshot(supabase, requestId);
      if (!astroResult.ok) {
        throw new Error(`–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã: ${astroResult.error}`);
      }
      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞—è–≤–∫—É —Å astro_snapshot_id
      await supabase
        .from('track_requests')
        .update({ astro_snapshot_id: astroResult.astro_snapshot_id })
        .eq('id', requestId);
      
      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞—è–≤–∫—É
      const { data: updated } = await supabase
        .from('track_requests')
        .select('*')
        .eq('id', requestId)
        .single();
      if (updated) Object.assign(request, updated);
    }
    
    // –®–∞–≥ 3: –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É
    const { data: snapshotRow } = await supabase
      .from("astro_snapshots")
      .select("snapshot_text")
      .eq("id", request.astro_snapshot_id)
      .maybeSingle();
    
    const astroText = snapshotRow?.snapshot_text || "[–ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞]";
    
    // –®–∞–≥ 4: –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –¥–ª—è DeepSeek
    const langLabel = { ru: "Russian", en: "English", uk: "Ukrainian" }[request.language || "ru"] || "Russian";
    const userRequest = `–≠–¢–û ${request.name} –∏ –µ—ë/–µ–≥–æ –∑–∞–ø—Ä–æ—Å: "${request.request || '—Å–æ–∑–¥–∞—Ç—å –ø–µ—Å–Ω—é'}"
–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: ${request.birthdate}
–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è: ${request.birthplace}
–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è: ${request.birthtime_unknown ? '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' : request.birthtime}
–ü–æ–ª: ${request.gender}
–Ø–∑—ã–∫ –ø–µ—Å–Ω–∏ –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏: ${langLabel}

–ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞:
${astroText}`;
    
    // –®–∞–≥ 5: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ DeepSeek (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–æ–¥—É–ª—å)
    console.log(`[–í–æ—Ä–∫–µ—Ä] –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –≤ DeepSeek –¥–ª—è ${request.name}`);
    
    const llm = await chatCompletion(SYSTEM_PROMPT, userRequest, { 
      max_tokens: 8192,
      temperature: 0.85 
    });
    
    if (!llm.ok) {
      throw new Error(`DeepSeek –æ—à–∏–±–∫–∞: ${llm.error}`);
    }
    
    const fullResponse = llm.text;
    console.log(`[–í–æ—Ä–∫–µ—Ä] –ü–æ–ª—É—á–µ–Ω –∞–Ω–∞–ª–∏–∑ –æ—Ç DeepSeek (–¥–ª–∏–Ω–∞: ${fullResponse.length})`);
    
    // –®–∞–≥ 6: –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
    const parsed = parseResponse(fullResponse);
    if (!parsed || !parsed.lyrics) {
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –ª–∏—Ä–∏–∫—É –∏–∑ –æ—Ç–≤–µ—Ç–∞ LLM');
    }
    
    // –®–∞–≥ 7: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–Ω–∞–ª–∏–∑ –∏ –ª–∏—Ä–∏–∫—É
    await supabase
      .from('track_requests')
      .update({
        lyrics: parsed.lyrics,
        title: parsed.title,
        detailed_analysis: parsed.detailed_analysis,
        status: 'processing',
        updated_at: new Date().toISOString()
      })
      .eq('id', requestId);
    
    // –®–∞–≥ 8: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ SUNO (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–æ–¥—É–ª—å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º API)
    console.log(`[–í–æ—Ä–∫–µ—Ä] –û—Ç–ø—Ä–∞–≤–ª—è—é –≤ SUNO –¥–ª—è ${request.name}`);
    
    const sunoParams = {
      prompt: parsed.lyrics,
      title: parsed.title,
      style: parsed.style,
    };
    if (process.env.SUNO_MODEL) sunoParams.model = process.env.SUNO_MODEL;
    if (process.env.SUNO_VOCAL_GENDER === "m" || process.env.SUNO_VOCAL_GENDER === "f") {
      sunoParams.vocalGender = process.env.SUNO_VOCAL_GENDER;
    }
    
    const sunoStart = await generateMusic(sunoParams);
    if (!sunoStart.ok) {
      throw new Error(`Suno start –æ—à–∏–±–∫–∞: ${sunoStart.error}`);
    }
    
    console.log(`[–í–æ—Ä–∫–µ—Ä] –ó–∞–¥–∞—á–∞ –≤ SUNO —Å–æ–∑–¥–∞–Ω–∞, taskId: ${sunoStart.taskId}`);
    
    await supabase
      .from('track_requests')
      .update({ suno_task_id: sunoStart.taskId })
      .eq('id', requestId);
    
    // –®–∞–≥ 9: –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–æ–¥—É–ª—å)
    const sunoResult = await pollMusicResult(sunoStart.taskId);
    if (!sunoResult.ok) {
      throw new Error(`Suno poll –æ—à–∏–±–∫–∞: ${sunoResult.error}`);
    }
    
    const audioUrl = sunoResult.audioUrl;
    console.log(`[–í–æ—Ä–∫–µ—Ä] –ú—É–∑—ã–∫–∞ –≥–æ—Ç–æ–≤–∞: ${audioUrl}`);
    
    // –®–∞–≥ 10: –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏
    await supabase
      .from('track_requests')
      .update({
        audio_url: audioUrl,
        status: 'completed',
        error_message: null,
        updated_at: new Date().toISOString()
      })
      .eq('id', requestId);
    
    // –®–∞–≥ 11: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞—É–¥–∏–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    const caption = `üóùÔ∏è ${request.name}, —Ç–≤–æ–π –∑–≤—É–∫–æ–≤–æ–π –∫–ª—é—á –≥–æ—Ç–æ–≤!\n\n–≠—Ç–æ —Ç–≤–æ—ë –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –∑–≤—É–∫–æ–≤–æ–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–æ. –°–ª—É—à–∞–π –∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ –≤ —Ç–∏—à–∏–Ω–µ —Å –∑–∞–∫—Ä—ã—Ç—ã–º–∏ –≥–ª–∞–∑–∞–º–∏.\n\n–°–ª—É—à–∞–π —Å–µ—Ä–¥—Ü–µ–º ‚ù§Ô∏è\n‚Äî YupSoul`;
    const send = await sendAudioToUser(request.telegram_user_id, audioUrl, caption);
    
    if (!send.ok) {
      console.warn(`[–í–æ—Ä–∫–µ—Ä] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ: ${send.error}`);
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      try {
        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            chat_id: request.telegram_user_id,
            text: `üóùÔ∏è ${request.name}, —Ç–≤–æ–π –∑–≤—É–∫–æ–≤–æ–π –∫–ª—é—á –≥–æ—Ç–æ–≤!\n\n–ê—É–¥–∏–æ—Ñ–∞–π–ª –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏. –ù–∞–ø–∏—à–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É ‚Äî —è –ø—Ä–∏—à–ª—é –µ–≥–æ –≤—Ä—É—á–Ω—É—é –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞.\n\n–°–ø–∞—Å–∏–±–æ –∑–∞ —Ç–µ—Ä–ø–µ–Ω–∏–µ! ‚ù§Ô∏è`
          })
        });
      } catch (e) {
        console.error('[–í–æ—Ä–∫–µ—Ä] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', e.message);
      }
    } else {
      console.log(`[–í–æ—Ä–∫–µ—Ä] ‚úÖ –ó–∞—è–≤–∫–∞ ${requestId} –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –¥–ª—è ${request.name}`);
    }
    
    return { ok: true, audioUrl };
    
  } catch (error) {
    console.error(`[–í–æ—Ä–∫–µ—Ä] –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∑–∞—è–≤–∫–∏ ${requestId}:`, error.message);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ failed
    await supabase
      .from('track_requests')
      .update({
        status: 'failed',
        error_message: error.message?.slice(0, 500),
        updated_at: new Date().toISOString()
      })
      .eq('id', requestId)
      .catch(() => {});
    
    // –£–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∞ –æ–± –æ—à–∏–±–∫–µ
    if (process.env.ADMIN_TELEGRAM_IDS && BOT_TOKEN) {
      const adminIds = process.env.ADMIN_TELEGRAM_IDS.split(',').map(id => id.trim());
      for (const adminId of adminIds) {
        try {
          await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              chat_id: adminId,
              text: `‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∑–∞—è–≤–∫–∏ ${requestId}\n\n${error.message?.substring(0, 300)}`
            })
          });
        } catch (e) {
          console.error('[–í–æ—Ä–∫–µ—Ä] –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∞:', e.message);
        }
      }
    }
    
    return { ok: false, error: error.message };
  }
}

// ============================================================================
// –¢–†–ò–ì–ì–ï–† –ó–ê–ü–£–°–ö–ê (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
// ============================================================================

if (import.meta.url === `file://${process.argv[1]}` && process.argv[2]) {
  const requestId = process.argv[2];
  console.log(`–ó–∞–ø—É—Å–∫ –≤–æ—Ä–∫–µ—Ä–∞ –¥–ª—è –∑–∞—è–≤–∫–∏ ${requestId}`);
  generateSoundKey(requestId).then(result => {
    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç:', result);
    process.exit(result.ok ? 0 : 1);
  }).catch(err => {
    console.error('–û—à–∏–±–∫–∞:', err);
    process.exit(1);
  });
}
