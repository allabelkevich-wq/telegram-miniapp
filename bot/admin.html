<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>YupSoul — Админка: контроль этапов генерации</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 16px; background: #1a1a1a; color: #e4e4e4; }
    h1 { font-size: 1.35rem; margin: 0 0 16px; color: #a78bfa; }
    .auth-bar { display: flex; flex-wrap: wrap; align-items: center; gap: 10px 12px; margin-bottom: 20px; padding: 14px; background: #252525; border-radius: 8px; }
    .auth-bar input { flex: 1; max-width: 280px; padding: 8px 12px; border: 1px solid #444; border-radius: 6px; background: #333; color: #fff; }
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; background: #8b5cf6; color: #fff; }
    .btn:hover { background: #7c3aed; }
    .btn.secondary { background: #444; }
    .btn.secondary:hover { background: #555; }
    .denied { padding: 24px; max-width: 560px; color: #f87171; }
    .denied p { margin: 0 0 10px; }
    .denied code { background: #333; padding: 2px 8px; border-radius: 4px; font-size: 13px; }
    .list { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #333; }
    th { background: #252525; color: #a78bfa; }
    tr:hover { background: #252525; }
    tr[data-id] { cursor: pointer; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
    .badge.truncated { background: #f59e0b; color: #000; }
    .badge.completed { background: #10b981; color: #000; }
    .badge.pending { background: #6b7280; color: #fff; }
    .detail { margin-top: 24px; padding: 20px; background: #252525; border-radius: 12px; }
    .detail h2 { font-size: 1.1rem; margin: 0 0 16px; color: #a78bfa; }
    .tabs { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
    .tabs button { padding: 8px 14px; border: 1px solid #444; border-radius: 6px; background: #333; color: #e4e4e4; cursor: pointer; font-size: 13px; }
    .tabs button.active { background: #8b5cf6; border-color: #8b5cf6; }
    .block { display: none; margin-top: 12px; }
    .block.active { display: block; }
    .block pre { margin: 0; padding: 14px; background: #111; border-radius: 8px; overflow: auto; max-height: 400px; font-size: 12px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
    .block .meta { font-size: 12px; color: #9ca3af; margin-bottom: 8px; }
    a { color: #a78bfa; }
    .back { margin-bottom: 16px; }
    .intro { color: #9ca3af; margin: 0 0 20px; font-size: 14px; }
    .instructions { background: #252525; padding: 16px 20px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; line-height: 1.6; color: #d1d5db; border: 1px solid #444; }
    .instructions ol { margin: 8px 0 0 20px; padding: 0; }
    .instructions li { margin-bottom: 6px; }
    .instructions code { background: #111; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
    .auth-bar label { font-weight: 600; }
  </style>
</head>
<body>
  <h1 style="margin-bottom:8px">YupSoul — Админка</h1>
  <p class="intro">Проверка этапов генерации: сырой ответ DeepSeek, лирика и style в Suno, обрезка по токенам.</p>
  <p class="intro" style="margin-bottom:16px"><strong>Удобная версия:</strong> <a href="/admin-simple">/admin-simple</a> — карточки заявок, этапы, перезапуск. Рекомендуется открывать из бота (/admin) или из приложения (кнопка «Админка»).</p>

  <div class="instructions">
    <strong>Вход из браузера (Render):</strong>
    <ol>
      <li>В Render: Dashboard → твой сервис → <strong>Environment</strong> → добавь переменную <strong>ADMIN_SECRET</strong> (любая строка, например <code>мой_секрет_123</code>). Сохрани и дождись перезапуска.</li>
      <li>Ниже вставь этот же токен в поле и нажми «Войти» — или открой в браузере ссылку вида <code>https://твой-сервис.onrender.com/admin?token=мой_секрет_123</code>.</li>
    </ol>
    <strong>Из Telegram:</strong> открой эту страницу из бота или по ссылке — если твой ID в ADMIN_TELEGRAM_IDS, доступ откроется без токена.
  </div>

  <div class="auth-bar">
    <label for="tokenInput">Токен (для входа из браузера):</label>
    <input type="password" id="tokenInput" placeholder="вставь значение ADMIN_SECRET из Render">
    <button type="button" class="btn" id="authBtn">Войти</button>
  </div>
  <div id="root">
    <p id="statusText">Проверка доступа…</p>
    <p class="intro" style="margin-top:8px;font-size:13px">Если висит больше минуты — сервер на Render мог «уснуть». Подожди или обнови страницу (F5).</p>
  </div>

  <script>
    const API_BASE = window.location.origin;
    const FETCH_TIMEOUT_MS = 90000;

    function fetchWithTimeout(url, opts) {
      const ctrl = new AbortController();
      const to = setTimeout(() => ctrl.abort(), FETCH_TIMEOUT_MS);
      return fetch(url, { ...opts, signal: ctrl.signal }).finally(() => clearTimeout(to));
    }
    function getAuth() {
      const tg = window.Telegram?.WebApp?.initData;
      if (tg) return { type: 'init', value: tg };
      const token = document.getElementById('tokenInput').value.trim() || new URLSearchParams(location.search).get('token');
      if (token) return { type: 'token', value: token };
      return null;
    }
    function authHeaders() {
      const a = getAuth();
      if (!a) return {};
      if (a.type === 'init') return { 'X-Telegram-Init': a.value };
      return { 'Authorization': 'Bearer ' + a.value };
    }
    async function checkAdmin() {
      const r = await fetchWithTimeout(API_BASE + '/api/admin/me', { headers: authHeaders() });
      const j = await r.json().catch(() => ({}));
      return r.ok && j.admin === true;
    }
    async function loadList() {
      const r = await fetchWithTimeout(API_BASE + '/api/admin/requests?limit=50', { headers: authHeaders() });
      if (!r.ok) throw new Error('Ошибка загрузки списка');
      return r.json();
    }
    async function loadDetail(id) {
      const r = await fetchWithTimeout(API_BASE + '/api/admin/requests/' + id, { headers: authHeaders() });
      if (!r.ok) throw new Error('Ошибка загрузки заявки');
      return r.json();
    }
    function setStatus(msg) {
      const el = document.getElementById('statusText');
      if (el) el.textContent = msg;
    }

    function renderDenied() {
      document.getElementById('root').innerHTML = '<div class="denied"><p><strong>Доступ запрещён.</strong></p><p>Если заходишь из браузера: задай в Render переменную <strong>ADMIN_SECRET</strong> (Environment), сохрани, затем вставь тот же токен выше и нажми «Войти».</p><p>Или открой страницу с параметром: <code>/admin?token=ТВОЙ_СЕКРЕТ</code>.</p></div>';
    }
    function renderTimeout() {
      document.getElementById('root').innerHTML = '<div class="denied"><p><strong>Сервер не ответил за 1,5 минуты.</strong></p><p>На Render бесплатный сервис «засыпает» без трафика. Первый запрос его будит — это может занять до 1–2 минут.</p><p>Обнови страницу (F5) и подожди ещё раз, либо открой сначала главную <a href="/">главную</a>, подожди загрузки, затем снова открой /admin.</p></div>';
    }
    function renderList(requests) {
      const html = '<h1>Заявки — контроль этапов генерации</h1><div class="list"><table><thead><tr><th>Дата</th><th>Имя</th><th>Режим</th><th>Статус</th><th>Обрезка LLM</th><th>Аудио</th></tr></thead><tbody>' +
        requests.map(r => {
          const date = r.created_at ? new Date(r.created_at).toLocaleString('ru-RU') : '—';
          const badge = r.llm_truncated ? '<span class="badge truncated">обрезка</span>' : (r.status === 'completed' ? '<span class="badge completed">OK</span>' : '<span class="badge pending">' + (r.status || 'pending') + '</span>');
          const audio = r.audio_url ? '<a href="' + r.audio_url + '" target="_blank">слушать</a>' : '—';
          return '<tr data-id="' + r.id + '"><td>' + date + '</td><td>' + (r.name || '—') + '</td><td>' + (r.mode || 'single') + '</td><td>' + badge + '</td><td>' + (r.llm_truncated ? 'да' : 'нет') + '</td><td>' + audio + '</td></tr>';
        }).join('') +
        '</tbody></table></div><div id="detailWrap"></div>';
      document.getElementById('root').innerHTML = html;
      document.querySelectorAll('tr[data-id]').forEach(tr => {
        tr.addEventListener('click', () => openDetail(tr.getAttribute('data-id')));
      });
    }
    function openDetail(id) {
      const wrap = document.getElementById('detailWrap');
      if (!wrap) return;
      wrap.innerHTML = '<p>Загрузка…</p>';
      loadDetail(id).then(req => {
        const d = req;
        const tabs = [
          { id: 'raw', label: 'Сырой ответ DeepSeek', key: 'deepseek_response', note: 'Полный ответ до парсинга. Обрезка: ' + (d.llm_truncated ? 'да' : 'нет') },
          { id: 'lyrics', label: 'Лирика в Suno', key: 'lyrics', note: 'Точно это отправлено в Suno' },
          { id: 'style', label: 'Style в Suno', key: 'suno_style_sent', note: 'Строка style для Suno' },
          { id: 'title', label: 'Название', key: 'title' },
          { id: 'analysis', label: 'Анализ (detailed_analysis)', key: 'detailed_analysis' },
          { id: 'audio', label: 'Аудио', key: 'audio_url', isLink: true },
        ];
        let tabHtml = '<div class="back"><button type="button" class="btn secondary" id="backToList">← К списку</button></div>';
        tabHtml += '<div class="detail"><h2>' + (d.name || d.id) + ' · ' + (d.status || '') + (d.llm_truncated ? ' · <span class="badge truncated">ответ DeepSeek обрезан</span>' : '') + '</h2>';
        tabHtml += '<div class="tabs">' + tabs.map(t => '<button type="button" data-tab="' + t.id + '">' + t.label + '</button>').join('') + '</div>';
        tabs.forEach(t => {
          let val = d[t.key];
          if (val == null) val = '—';
          if (t.isLink && val && val !== '—') val = '<a href="' + val + '" target="_blank">Открыть аудио</a>';
          const note = t.note ? '<div class="meta">' + t.note + '</div>' : '';
          const content = t.isLink && typeof val === 'string' && val.startsWith('<a') ? val : '<pre>' + escapeHtml(String(val)) + '</pre>';
          tabHtml += '<div class="block" data-tab="' + t.id + '">' + note + content + '</div>';
        });
        tabHtml += '</div>';
        wrap.innerHTML = tabHtml;
        wrap.querySelector('.tabs [data-tab="raw"]')?.classList.add('active');
        wrap.querySelector('.block[data-tab="raw"]')?.classList.add('active');
        wrap.querySelectorAll('.tabs button').forEach(btn => {
          btn.addEventListener('click', () => {
            wrap.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
            wrap.querySelectorAll('.block').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            wrap.querySelector('.block[data-tab="' + btn.getAttribute('data-tab') + '"]')?.classList.add('active');
          });
        });
        document.getElementById('backToList')?.addEventListener('click', () => { wrap.innerHTML = ''; loadList().then(data => renderList(data.requests)); });
      }).catch(e => { wrap.innerHTML = '<p style="color:#f87171">' + e.message + '</p>'; });
    }
    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    document.getElementById('authBtn').addEventListener('click', async () => {
      const root = document.getElementById('root');
      root.innerHTML = '<p>Проверка доступа…</p>';
      try {
        const ok = await checkAdmin();
        if (ok) {
          root.innerHTML = '<p>Загрузка списка…</p>';
          const data = await loadList();
          renderList(data.requests);
        } else renderDenied();
      } catch (e) {
        if (e.name === 'AbortError') renderTimeout();
        else root.innerHTML = '<div class="denied"><p>Ошибка: ' + (e.message || e) + '</p></div>';
      }
    });
    (async () => {
      const urlToken = new URLSearchParams(location.search).get('token');
      if (urlToken) document.getElementById('tokenInput').value = urlToken;
      try {
        setStatus('Проверка доступа… (при первом открытии сервер может просыпаться до 1–2 мин)');
        const ok = await checkAdmin();
        if (ok) {
          setStatus('Загрузка списка заявок…');
          const data = await loadList();
          renderList(data.requests);
        } else renderDenied();
      } catch (e) {
        if (e.name === 'AbortError') renderTimeout();
        else document.getElementById('root').innerHTML = '<div class="denied"><p><strong>Ошибка:</strong> ' + (e.message || e) + '</p><p>Проверь интернет и обнови страницу.</p></div>';
      }
    })();
  </script>
</body>
</html>
